(function(e,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react-i18next"),require("@nocobase/plugin-workflow/client"),require("react/jsx-runtime"),require("@ant-design/icons"),require("antd"),require("react"),require("@nocobase/utils/client")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react-i18next","@nocobase/plugin-workflow/client","react/jsx-runtime","@ant-design/icons","antd","react","@nocobase/utils/client"],t):(e=typeof globalThis!="undefined"?globalThis:e||self,t(e["@ashley/plugin-workflow-page-load-event"]={},e["@nocobase/client"],e["react-i18next"],e["@nocobase/plugin-workflow"],e.jsxRuntime,e["@ant-design/icons"],e.antd,e.react,e["@nocobase/utils"]))})(this,function(e,t,a,m,h,C,y,c,u){"use strict";var W=Object.defineProperty,j=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var D=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var V=(e,t,a)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,P=(e,t)=>{for(var a in t||(t={}))D.call(t,a)&&V(e,a,t[a]);if(I)for(var a of I(t))O.call(t,a)&&V(e,a,t[a]);return e},E=(e,t)=>j(e,$(t));var i=(e,t,a)=>(V(e,typeof t!="symbol"?t+"":t,a),a);var T=(e,t,a)=>new Promise((m,h)=>{var C=u=>{try{c(a.next(u))}catch(s){h(s)}},y=u=>{try{c(a.throw(u))}catch(s){h(s)}},c=u=>u.done?m(u.value):Promise.resolve(u.value).then(C,y);c((a=a.apply(e,t)).next())});const s="@ashley/plugin-workflow-page-load-event";function l(n,o={}){const{t:r}=q(o);return r(n)}function q(n){return a.useTranslation(s,n)}class F extends m.Trigger{constructor(){super(...arguments);i(this,"sync",!0);i(this,"title",`{{t("Page load event", { ns: "${s}" })}}`);i(this,"description",`{{t('Triggered by page load such as displaying a count on the tab badge', { ns: "${s}" })}}`);i(this,"fieldset",{triggerType:{type:"string",required:!0,"x-decorator":"FormItem","x-component":"Select",title:`{{t("Type of page load event", { ns: "${s}" })}}`,enum:[{label:`{{t("Retrieve a single parameter to populate the text", { ns: "${s}" })}}`,value:k.SINGLE_PARAMETER}]}})}useVariables(r,g){var R;const p=t.useCompile(),{getCollectionFields:b}=t.useCollectionManager_deprecated(),x=l("Trigger data"),d=l("User submitted action"),f=l("Role of user submitted action"),w=[{collectionName:r.collection,name:"data",type:"hasOne",target:r.collection,uiSchema:{title:x}},{collectionName:"users",name:"user",type:"hasOne",target:"users",uiSchema:{title:d}},{name:"roleName",uiSchema:{title:f}}];return m.getCollectionFieldOptions(E(P({appends:["data","user",...((R=r.appends)==null?void 0:R.map(G=>`data.${G}`))||[]]},g),{fields:w,compile:p,getCollectionFields:b}))}}class L extends m.Instruction{constructor(){super(...arguments);i(this,"title",`{{t("Page load response", { ns: "${s}" })}}`);i(this,"type","page-load-response");i(this,"group","extended");i(this,"description",`{{t("Respond to the Page load request from the trigger and return the corresponding parameters", { ns: "${s}" })}}`);i(this,"icon",h.jsx(C.ProfileOutlined,{}));i(this,"fieldset",{loadResponse:{type:"string",required:!0,title:`{{t("Response parameter", { ns: "${s}" })}}`,"x-decorator":"FormItem","x-decorator-props":{},"x-component":"WorkflowVariableTextArea","x-component-props":{placeholder:""}}});i(this,"components",{WorkflowVariableTextArea:m.WorkflowVariableTextArea})}isAvailable({workflow:r}){return r.type===S}}function M(n){const o=t.useAPIClient(),[r,g]=c.useState({options:[],loading:!1});c.useEffect(()=>{n.onChange(n.defaultValue)},[n.defaultValue]),c.useEffect(()=>{T(this,null,function*(){try{const{data:f}=yield o.request({url:`/workflows:list?pageSize=200&filter={"type":["${n.actionType}"],"enabled":true,"config.triggerType":"${n.actionValue}"}`});g(w=>E(P({},w),{options:f.data.map(v=>({label:v.title,value:v.key}))}))}catch(f){u.captureException(f)}})},[r.loading]);function p(){g(d=>E(P({},d),{loading:!d.loading}))}function b(d){n.onChange(d)}const{options:x}=r;return h.jsx(y.Select,{defaultValue:n.defaultValue,showSearch:!0,optionFilterProp:"label",options:x,onFocus:p,onSelect:b})}function N(n){const[o,r]=c.useState(!1);c.useEffect(()=>{n.onChange(n.defaultValue),r(n.defaultValue)},[n.defaultValue]);function g(p){r(p),n.onChange(p)}return h.jsx(y.Switch,{checkedChildren:l("open"),unCheckedChildren:l("close"),checked:o,onChange:g})}const _={type:"modal",sort:2,useComponentProps(){var p,b,x,d;const{dn:n}=t.useDesignable(),{schema:o}=t.useSchemaToolbar(),r=(b=(p=o==null?void 0:o["x-badge-props"])==null?void 0:p.enabled)!=null?b:!1,g=(d=(x=o==null?void 0:o["x-badge-props"])==null?void 0:x.workflow)!=null?d:"";return{title:l("Badge"),schema:{type:"object",title:l("Badge"),properties:{alert:{"x-decorator":"div","x-decorator-props":{style:{margin:"24px 0"}},"x-component":y.Alert,"x-component-props":{type:"warning",message:l("Workflow will be triggered when the page loads")}},enabled:{title:l("Display a badge"),"x-decorator":"FormItem","x-component":N,"x-component-props":{defaultValue:r}},workflow:{type:"string",required:!0,"x-decorator":"FormItem","x-component":M,"x-component-props":{actionType:S,actionValue:k.SINGLE_PARAMETER,defaultValue:g},title:l("Workflow where the parameter is retrieved"),"x-reactions":[{dependencies:["enabled"],fulfill:{state:{visible:"{{!!$deps[0]}}"}}}]}}},onSubmit:f=>{var w;o["x-badge-props"]=(w=o==null?void 0:o["x-badge-props"])!=null?w:{},o["x-badge-props"].enabled=f.enabled,o["x-badge-props"].workflow=f.workflow,n.emit("patch",{schema:{"x-uid":o["x-uid"],"x-badge-props":o["x-badge-props"]}}),n.refresh()}}}},S="page-load-event";var k=(n=>(n.SINGLE_PARAMETER="singleParameter",n))(k||{});class A extends t.Plugin{afterAdd(){return T(this,null,function*(){})}beforeLoad(){return T(this,null,function*(){})}load(){return T(this,null,function*(){const o=this.app.pm.get("workflow");o.registerTrigger(S,F),o.registerInstruction("page-load-response",L),this.app.schemaSettingsManager.addItem("PageTabSettings","badge",_)})}}e.PageLoadEventType=k,e.PluginWorkflowPageLoadEventClient=A,e.TRIGGER_TYPE=S,e.default=A,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
