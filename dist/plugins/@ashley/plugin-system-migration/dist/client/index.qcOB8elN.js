(function(c,d){typeof exports=="object"&&typeof module!="undefined"?d(exports,require("@nocobase/client"),require("react-i18next"),require("react/jsx-runtime"),require("react"),require("antd"),require("@formily/reactive-react"),require("@ant-design/icons"),require("@formily/reactive"),require("@formily/core"),require("lodash"),require("@formily/antd-v5"),require("@formily/react"),require("dayjs")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react-i18next","react/jsx-runtime","react","antd","@formily/reactive-react","@ant-design/icons","@formily/reactive","@formily/core","lodash","@formily/antd-v5","@formily/react","dayjs"],d):(c=typeof globalThis!="undefined"?globalThis:c||self,d(c["@ashley/plugin-system-migration"]={},c["@nocobase/client"],c["react-i18next"],c.jsxRuntime,c.react,c.antd,c["@formily/reactive-react"],c["@ant-design/icons"],c["@formily/reactive"],c["@formily/core"],c.lodash,c["@formily/antd-v5"],c["@formily/react"],c.dayjs))})(this,function(c,d,m,e,C,i,O,M,x,q,z,P,T,$){"use strict";var re=Object.defineProperty,ne=Object.defineProperties;var ae=Object.getOwnPropertyDescriptors;var U=Object.getOwnPropertySymbols;var se=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var W=(c,d,m)=>d in c?re(c,d,{enumerable:!0,configurable:!0,writable:!0,value:m}):c[d]=m,D=(c,d)=>{for(var m in d||(d={}))se.call(d,m)&&W(c,m,d[m]);if(U)for(var m of U(d))ie.call(d,m)&&W(c,m,d[m]);return c},A=(c,d)=>ne(c,ae(d));var F=(c,d,m)=>new Promise((e,C)=>{var i=x=>{try{M(m.next(x))}catch(q){C(q)}},O=x=>{try{M(m.throw(x))}catch(q){C(q)}},M=x=>x.done?e(x.value):Promise.resolve(x.value).then(i,O);M((m=m.apply(c,d)).next())});const N="@ashley/plugin-system-migration";function I(n={}){return m.useTranslation(N,n)}const p=x.observable({menu:[],database:[],roles:[],workflows:[],currentMigrationData:null,dialogOpen:!1}),Y=n=>{var S;const{item:a,refreshListData:t}=n,{t:o}=I(),{modal:s}=i.App.useApp(),r=d.useAPIClient(),l=C.useRef(!1),u=a!=null&&a.upgrade?((S=a==null?void 0:a.upgrade)==null?void 0:S.isUpgrade)==1?"rgb(95 214 15)":"rgb(214 15 72)":"",g=()=>{p.currentMigrationData=a,p.dialogOpen=!0},h=()=>F(this,null,function*(){try{yield r.request({method:"post",url:"/systemMigration:destroy",params:{filterByTk:a.id}})}catch(y){}finally{t()}}),f=()=>F(this,null,function*(){if(!l.current){l.current=!0;try{const{data:y}=yield r.request({method:"post",url:"/systemMigration:downloadSystemMigration",data:{id:a.id}}),v=y==null?void 0:y.data,b=v.slice(v.lastIndexOf("/")+1),k=document.createElement("a");k.setAttribute("href",v),k.setAttribute("download",b),k.click(),k.remove()}catch(y){}finally{l.current=!1}}}),w=()=>F(this,null,function*(){if(l.current)return;l.current=!0;let y=!0;try{const{data:v}=yield r.request({method:"post",url:"/systemMigration:upgradeMigrationData",data:{id:a.id}})}catch(v){y=!1}finally{l.current=!1,y&&t()}});return e.jsx(i.Card,{hoverable:!0,cover:e.jsx(i.Image,{preview:!1,width:"100%",height:120,src:"/storage/uploads/mbg.jpg"}),style:{display:"flex",flexDirection:"column",justifyContent:"space-between",cursor:"default",width:240,height:240,overflow:"hidden"},bodyStyle:{padding:"10px 20px"},actions:[e.jsx(M.SettingOutlined,{onClick:g},"setting"),e.jsx(M.DeleteOutlined,{onClick:()=>{s.confirm({title:o("Confirm to delete?"),onOk:h})}},"delete"),e.jsx(i.Dropdown,{menu:{items:[{key:"export",label:e.jsx("div",{children:o("Export")}),onClick:f},{key:"multiAppExport",label:e.jsx("div",{children:o("Multi-App-Data Upgrade")}),onClick:w}]},children:e.jsx(M.EllipsisOutlined,{},"ellipsis")})],children:e.jsx(i.Card.Meta,{title:e.jsx(e.Fragment,{children:e.jsxs(i.Space,{align:"center",style:{justifyContent:"space-between",width:"100%"},children:[e.jsx("div",{style:{maxWidth:140},children:e.jsx(d.EllipsisWithTooltip,{ellipsis:!0,children:a.name})}),e.jsx(i.Tag,{color:u,children:a.version})]})}),description:e.jsx("div",{className:d.css`
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
              text-overflow: ellipsis;
            `,children:a.description})})})},G=()=>{const{token:n}=d.useToken(),{t:a}=I(),t=C.useCallback(()=>{p.dialogOpen=!0,p.currentMigrationData={name:"",code:"",version:"",description:"",menu:[],database:[],roles:[],workflows:[]}},[]);return e.jsx(i.Button,{type:"dashed",style:{width:240,height:240,borderRadius:n.borderRadiusLG,borderColor:"var(--colorSettings)",color:"var(--colorSettings)"},icon:e.jsx(M.PlusOutlined,{}),onClick:t,children:a("Create new migration")})},H=O.observer(n=>{const{value:a,onChange:t}=n,o=(s,r)=>{t(s)};return e.jsx("div",{children:e.jsx(i.Tree,{checkable:!0,checkedKeys:a,onCheck:o,treeData:p.menu})})}),L=()=>{const{t:n}=m.useTranslation(),[a,t]=C.useState(""),[o,s]=C.useState(""),r=C.useRef(null),l=(h,f,w)=>{f(),t(h[0]),s(w)},u=h=>{h(),t("")};return{getColumnSearchProps:h=>({filterDropdown:({setSelectedKeys:f,selectedKeys:w,confirm:S,clearFilters:y,close:v})=>e.jsxs("div",{style:{padding:8},onKeyDown:b=>b.stopPropagation(),children:[e.jsx(i.Input,{ref:r,placeholder:`Search ${h}`,value:w[0],onChange:b=>f(b.target.value?[b.target.value]:[]),onPressEnter:()=>l(w,S,h),style:{marginBottom:8,display:"block"}}),e.jsxs(i.Space,{children:[e.jsx(i.Button,{type:"primary",onClick:()=>l(w,S,h),icon:e.jsx(M.SearchOutlined,{}),size:"small",style:{width:90},children:n("Search")}),e.jsx(i.Button,{onClick:()=>y&&u(y),size:"small",style:{width:90},children:n("Reset")})]})]}),filterIcon:f=>e.jsx(M.SearchOutlined,{style:{color:f?"#fd5c29":void 0}}),onFilter:(f,w)=>w[h].toString().toLowerCase().includes(f.toLowerCase()),onFilterDropdownOpenChange:f=>{f&&setTimeout(()=>{var w;return(w=r.current)==null?void 0:w.select()},100)},render:f=>f})}},_=O.observer(n=>{const{value:a,onChange:t}=n,{getColumnSearchProps:o}=L(),{t:s}=I(),r=[D({title:s("Database name"),dataIndex:"title",width:"50%"},o("title")),D({title:"Key",dataIndex:"key"},o("key"))],u={selectedRowKeys:a,onChange:g=>{t(g)}};return e.jsx("div",{children:e.jsx(i.Table,{rowSelection:u,columns:r,dataSource:p.database,pagination:{pageSize:100}})})}),J=O.observer(n=>{const{value:a,onChange:t}=n,{t:o}=I(),{getColumnSearchProps:s}=L(),r=[D({title:o("Role name"),dataIndex:"title",width:"50%"},s("title")),D({title:"Key",dataIndex:"key"},s("key"))],u={selectedRowKeys:a,onChange:g=>{t(g)}};return e.jsx("div",{children:e.jsx(i.Table,{rowSelection:u,columns:r,dataSource:p.roles,pagination:{pageSize:100}})})}),Q=O.observer(n=>{const{value:a,onChange:t}=n,{t:o}=I(),{getColumnSearchProps:s}=L(),r=[D({title:o("Workflow name"),dataIndex:"title",width:"50%"},s("title")),D({title:"Key",dataIndex:"key"},s("key"))],u={selectedRowKeys:a,onChange:g=>{t(g)}};return e.jsx("div",{children:e.jsx(i.Table,{rowSelection:u,columns:r,dataSource:p.workflows,pagination:{pageSize:100}})})}),X=n=>{const{migrationId:a}=n,t=d.useAPIClient(),{t:o}=I(),{t:s}=m.useTranslation(),[r,l]=C.useState([]);C.useEffect(()=>{t.resource("systemMigrationLog").list({sort:"-createdAt",paginate:!1,appends:["createdBy"],filter:{systemMigrationId:a}}).then(g=>{const{data:h}=g.data;l(h)})},[]);const u=[{title:o("Migration Name"),dataIndex:"name"},{title:o("Migration Version"),dataIndex:"version"},{title:o("Migration Description"),dataIndex:"description"},{title:s("Created By"),dataIndex:"createdBy",render:g=>g.nickname},{title:s("Created At"),dataIndex:"createdAt",render:g=>$(g).format("YYYY-MM-DD HH:mm:ss")}];return e.jsx("div",{children:e.jsx(i.Table,{columns:u,rowKey:"id",dataSource:r})})},E=n=>z.omit(n,["children"]),Z=O.observer(n=>{var v;const{refreshListData:a}=n,{t}=I(),[o,s]=C.useState({menu:0,database:0,role:0,workflow:0}),r=(v=p.currentMigrationData)==null?void 0:v.id,l=!!r,u=C.useMemo(()=>{if(p.currentMigrationData){const{menu:b=[],database:k=[],roles:j=[],workflows:B=[]}=p.currentMigrationData;s({menu:b.length,database:k.length,role:j.length,workflow:B.length})}return q.createForm({initialValues:z.pick(p.currentMigrationData,["code","name","version","description","menu","roles","database","workflows"]),effects:()=>{q.onFormValuesChange(()=>{const{menu:b,database:k,roles:j,workflows:B}=u.values;s({menu:b.length,database:k.length,role:j.length,workflow:B.length})})}})},[p.currentMigrationData]),g=[{key:"menu",label:`${t("Menu")} ${o.menu>0?"("+o.menu+")":""}`,children:e.jsx(T.Field,{name:"menu",decorator:[P.FormItem],component:[H]})},{key:"database",label:`${t("Database")} ${o.database>0?"("+o.database+")":""}`,children:e.jsx(T.Field,{name:"database",decorator:[P.FormItem],component:[_]})},{key:"role",label:`${t("Role")} ${o.role>0?"("+o.role+")":""}`,children:e.jsx(T.Field,{name:"roles",decorator:[P.FormItem],component:[J]})},{key:"workflow",label:`${t("Workflow")} ${o.workflow>0?"("+o.workflow+")":""}`,children:e.jsx(T.Field,{name:"workflows",decorator:[P.FormItem],component:[Q]})},...l?[{key:"logs",label:t("Logs"),children:e.jsx(X,{migrationId:r})}]:[]],h=d.useAPIClient(),{loading:f,run:w}=d.useRequest({method:"post",url:"/systemMigration:getSystemMigrationConfigs",data:{id:l?r:0,menu:[]}},{onSuccess(b){const{data:k}=b;p.currentMigrationData=A(D({},p.currentMigrationData),{menu:k.selectMenu,roles:k.selectRoles,database:k.selectDatabase,workflows:k.selectWorkflows}),p.menu=k.menu,p.database=k.database.map(E),p.roles=k.roles.map(E),p.workflows=k.workflows.map(E)},manual:!0,refreshDeps:[l,r]});C.useEffect(()=>{p.dialogOpen&&w()},[r,p.dialogOpen]);const S=()=>F(this,null,function*(){yield u.submit();try{yield h.request({method:"post",url:"/systemMigration:saveSystemMigration",data:D({id:l?r:0},u.values)}),p.dialogOpen=!1,a()}catch(b){}}),y=()=>{p.dialogOpen=!1};return e.jsx(i.Modal,{title:t(l?"Edit Migration":"New Migration"),centered:!0,width:"100%",styles:{body:{padding:"20px 0 0 0",height:"80vh",overflow:"auto"}},open:p.dialogOpen,onCancel:y,onOk:S,children:f?e.jsx(i.Skeleton,{paragraph:{rows:4}}):e.jsxs(P.Form,{form:u,children:[e.jsx(T.Field,{name:"name",title:t("Migration Name"),required:!0,decorator:[P.FormItem],component:[i.Input,{placeholder:t("Please input migration name")}]}),e.jsx(T.Field,{name:"code",required:!0,title:t("Migration Code"),decorator:[P.FormItem],component:[i.Input,{placeholder:t("Please input migration code"),readOnly:l,disabled:l}]}),e.jsx(T.Field,{name:"version",required:!0,title:t("Migration Version"),decorator:[P.FormItem],component:[i.Input,{placeholder:t("Please input migration version")}]}),e.jsx(T.Field,{name:"description",title:t("Migration Description"),decorator:[P.FormItem],component:[i.Input,{placeholder:t("Please input migration description")}]}),e.jsx(i.Alert,{style:{marginBottom:24},message:"Tips:",description:t("Checking the menu and workflow will automatically mark the relevant forms involved"),type:"info"}),e.jsx(i.Tabs,{items:g})]})})}),{Dragger:V}=i.Upload;function R(n){const a=o=>{var s;(s=n.onChange)==null||s.call(n,o)},t=d.useAPIClient();return A(D({},n),{customRequest({action:o,data:s,file:r,filename:l,headers:u,onError:g,onProgress:h,onSuccess:f,withCredentials:w}){const S=new FormData;return s&&Object.keys(s).forEach(y=>{S.append(y,s[y])}),S.append(l,r),t.axios.post(o,S,{withCredentials:w,headers:u,onUploadProgress:({total:y,loaded:v})=>{h({percent:Math.round(v/y*100).toFixed(2)},r)}}).then(({data:y})=>{window.location.reload()}).catch(g).finally(()=>{}),{abort(){console.log("upload progress is aborted.")}}},onChange:a})}const ee=n=>{const{t:a}=I(),[t,o]=C.useState(!1),s={multiple:!1,accept:".zip",action:n.isMultiAppImport?"/systemMigration:importMigrationData":"/systemMigration:importSystemMigration",onChange(r){var u;r.fileList.length>1&&r.fileList.splice(0,r.fileList.length-1),o(!0);const{status:l}=r.file;l==="done"?(i.message.success(`${r.file.name} `+a("file uploaded successfully")),(u=n.handleImportSuccess)==null||u.call(n),o(!1),n.closeModal()):l==="error"&&(i.message.error(`${r.file.name} `+a("file upload failed")),o(!1))},onDrop(r){console.log("Dropped files",r.dataTransfer.files)},disabled:t};return e.jsxs(V,A(D({},R(s)),{children:[e.jsx("p",{className:"ant-upload-drag-icon",children:e.jsx(M.InboxOutlined,{})}),e.jsxs("p",{className:"ant-upload-text",children:[" ",a("Click or drag file to this area to upload")]})]}))},te=({ButtonComponent:n=i.Button,btnStyle:a,title:t,refreshListData:o,isMultiAppImport:s})=>{const{t:r}=I(),[l,u]=C.useState(!1),g=()=>{u(!0)},h=()=>{u(!1)},f=()=>{u(!1)},w=()=>{o==null||o()};return e.jsxs(e.Fragment,{children:[e.jsx(n,{type:"primary",onClick:g,style:a,children:t}),e.jsx(i.Modal,{title:r(s?"Multi-App Import":"Import"),width:800,footer:null,open:l,onOk:h,onCancel:f,children:e.jsx(ee,{isMultiAppImport:s,handleImportSuccess:w,closeModal:f})})]})},oe=O.observer(()=>{const{token:n}=d.useToken(),{t:a}=I(),[t,o]=C.useState(1),{data:s,loading:r,refresh:l}=d.useRequest({resource:"systemMigration",action:"list",params:{page:t,sort:"-id"}},{refreshDeps:[t]}),u=(s==null?void 0:s.data)||[],g=(s==null?void 0:s.meta.count)||0;return e.jsx("div",{children:r?e.jsx(i.Spin,{}):e.jsxs(e.Fragment,{children:[e.jsx(i.Row,{justify:"end",style:{position:"absolute",top:11,right:24,zIndex:1},children:e.jsx(te,{title:a("Import migration"),refreshListData:l})}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, 240px)",gridGap:n.marginLG,marginTop:24},children:[u.map(h=>e.jsx(Y,{item:h,refreshListData:l},h.id)),e.jsx(G,{})]}),e.jsx(i.Pagination,{className:d.css`
              margin-top: 20px;
              text-align: center;
            `,simple:!0,current:t,total:g,pageSize:20,onChange:o}),e.jsx(Z,{refreshListData:l})]})})});class K extends d.Plugin{afterAdd(){return F(this,null,function*(){})}beforeLoad(){return F(this,null,function*(){})}load(){return F(this,null,function*(){this.app.pluginSettingsManager.add("system-migration",{title:`{{t("System migration", {ns:"${N}"})}}`,icon:"DatabaseOutlined",Component:oe,aclSnippet:"pm.system-migration"})})}}c.PluginSystemMigrationClient=K,c.default=K,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
