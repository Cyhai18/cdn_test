(function(n,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@formily/react"),require("antd"),require("antd-style"),require("react-i18next"),require("@nocobase/utils/client"),require("react"),require("@ant-design/icons"),require("react-router-dom")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@formily/react","antd","antd-style","react-i18next","@nocobase/utils/client","react","@ant-design/icons","react-router-dom"],t):(n=typeof globalThis!="undefined"?globalThis:n||self,t(n["@ashley/plugin-block-workbench"]={},n["@nocobase/client"],n.jsxRuntime,n["@formily/react"],n.antd,n["antd-style"],n["react-i18next"],n["@nocobase/utils"],n.react,n["@ant-design/icons"],n["react-router-dom"]))})(this,function(n,t,e,h,I,q,w,y,r,v,j){"use strict";var ce=Object.defineProperty,re=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable;var O=(n,t,e)=>t in n?ce(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,x=(n,t)=>{for(var e in t||(t={}))Q.call(t,e)&&O(n,e,t[e]);if(M)for(var e of M(t))D.call(t,e)&&O(n,e,t[e]);return n},A=(n,t)=>re(n,se(t));var P=(n,t)=>{var e={};for(var h in n)Q.call(n,h)&&t.indexOf(h)<0&&(e[h]=n[h]);if(n!=null&&M)for(var h of M(n))t.indexOf(h)<0&&D.call(n,h)&&(e[h]=n[h]);return e};var S=(n,t,e)=>new Promise((h,I)=>{var q=r=>{try{y(e.next(r))}catch(v){I(v)}},w=r=>{try{y(e.throw(r))}catch(v){I(v)}},y=r=>r.done?h(r.value):Promise.resolve(r.value).then(q,w);y((e=e.apply(n,t)).next())});const E=q.createStyles(({token:o,css:i})=>({action:i`
    &.ant-btn-default:not(.ant-btn-icon-only) {
      height: auto;
      box-shadow: none;
      background: transparent;
      border: none;
    }

    &.ant-btn-default:not(:disabled):not(.ant-btn-disabled):hover {
      background: transparent;
      color: ${o.colorPrimary};
    }
  `,title:i`
    margin-top: ${o.marginSM}px;
  `}));function U(){var u,p,f,b;const o=h.useFieldSchema(),i=(u=o["x-component-props"])==null?void 0:u.icon,s=(p=o["x-component-props"])==null?void 0:p.iconColor,a=(b=(f=o["x-component-props"])==null?void 0:f.shape)!=null?b:"circle",{styles:l,cx:m}=E();return e.jsxs("div",{children:[e.jsx(I.Avatar,{style:{backgroundColor:s},size:64,shape:a,icon:e.jsx(t.Icon,{type:i,style:{color:"rgba(0, 0, 0, 1)"}})}),e.jsx("div",{className:m(l.title),children:o.title})]})}const _=t.withDynamicSchemaProps(o=>{const m=o,{className:i}=m,s=P(m,["className"]),{styles:a,cx:l}=E();return e.jsx(t.Action,A(x({className:l(i,a.action)},s),{icon:null,title:e.jsx(U,{})}))}),G=h.observer(()=>{const o=h.useFieldSchema(),{render:i}=t.useSchemaInitializerRender(o["x-initializer"]);return i()},{displayName:"WorkbenchConfigureActionsButton"}),K=()=>{const o=h.useFieldSchema(),{designable:i}=t.useDesignable();return e.jsx("div",{style:{marginBottom:i?"1rem":0},children:e.jsx(t.DndContext,{children:e.jsx(I.Space,{wrap:!0,children:o.mapProperties((s,a)=>e.jsx(h.RecursionField,{name:a,schema:s},a))})})})},F=t.withDynamicSchemaProps(o=>e.jsx("div",{children:e.jsx(t.SchemaComponentOptions,{components:{WorkbenchAction:_},children:o.children})}),{displayName:"WorkbenchBlock"});F.ActionBar=()=>e.jsxs(e.Fragment,{children:[e.jsx(K,{}),e.jsx(G,{})]});function Y(o){const b=o,{modalSchema:i={}}=b,s=P(b,["modalSchema"]),d=i,{properties:a}=d,l=P(d,["properties"]),[m,u]=r.useState(!1),{setVisible:p}=t.useSchemaInitializer(),f=r.useMemo(()=>A(x({name:y.uid(),"x-component":"Action.Modal","x-component-props":{width:"520px"},type:"void","x-decorator":"FormV2","x-decorator-props":{}},l),{properties:A(x({},a),{footer1:{"x-component":"Action.Modal.Footer",type:"void",properties:{close:{title:"Cancel","x-component":"Action","x-component-props":{type:"default"},"x-use-component-props":()=>({onClick(){var c;u(!1),(c=o==null?void 0:o.onCancel)==null||c.call(o)}})},submit:{title:"OK","x-component":"Action","x-component-props":{type:"primary"},"x-use-component-props":()=>{const c=h.useForm();return{onClick(){return S(this,null,function*(){var z;yield c.submit(),u(!1),(z=o==null?void 0:o.onSubmit)==null||z.call(o,c.values)})}}}}}}})}),[m]);return e.jsxs(e.Fragment,{children:[e.jsx(t.SchemaInitializerItem,A(x({},s),{onClick:c=>{var g;p(!1),u(!0),(g=o==null?void 0:o.onClick)==null||g.call(o,c)}})),e.jsx(t.ActionContextProvider,{value:{visible:m,setVisible:u},children:e.jsx(t.SchemaComponent,{components:{Action:t.Action},schema:f})})]})}const J=new t.SchemaSettings({name:"workbench:actionSettings:link",items:[{name:"editButton",Component:t.ButtonEditor,useComponentProps(){return{hasIconColor:!0,iconColor:"#eee"}}},{name:"editLink",Component:t.SchemaSettingsActionLinkItem},{sort:800,name:"d1",type:"divider"},{sort:900,type:"remove",name:"remove"}]});function X(o){const i=t.useSchemaInitializerItem(),{insert:s}=t.useSchemaInitializer(),{t:a}=w.useTranslation();return e.jsx(Y,{title:i.title,modalSchema:{title:a("Add link"),properties:{title:{title:a("Title"),required:!0,"x-component":"Input","x-decorator":"FormItem"},icon:{title:a("Icon"),required:!0,"x-component":"IconPicker","x-decorator":"FormItem"},iconColor:{title:a("Color"),required:!0,default:"#eee","x-component":"ColorPicker","x-decorator":"FormItem"}}},onSubmit:l=>{s({type:"void",title:l.title,"x-action":"customize:link","x-toolbar":"ActionSchemaToolbar","x-settings":"workbench:actionSettings:link","x-component":"WorkbenchAction","x-use-component-props":"useLinkActionProps","x-component-props":{icon:l.icon,iconColor:l.iconColor,shape:"square"}})}})}function Z({style:o={}}){const i={position:"absolute",backgroundColor:"rgb(255, 255, 255)"};return e.jsxs("div",{id:"qr-scan-box",style:x({boxSizing:"border-box",inset:"0px"},o),children:[e.jsx("div",{style:x({width:"40px",height:"5px",top:"-5px",left:"0px"},i)}),e.jsx("div",{style:x({width:"40px",height:"5px",top:"-5px",right:"0px"},i)}),e.jsx("div",{style:x({width:"40px",height:"5px",bottom:"-5px",left:"0px"},i)}),e.jsx("div",{style:x({width:"40px",height:"5px",bottom:"-5px",right:"0px"},i)}),e.jsx("div",{style:x({width:"5px",height:"45px",top:"-5px",left:"-5px"},i)}),e.jsx("div",{style:x({width:"5px",height:"45px",bottom:"-5px",left:"-5px"},i)}),e.jsx("div",{style:x({width:"5px",height:"45px",top:"-5px",right:"-5px"},i)}),e.jsx("div",{style:x({width:"5px",height:"45px",bottom:"-5px",right:"-5px"},i)})]})}function $({onScannerSizeChanged:o,elementId:i}){const[s,a]=r.useState(),l=j.useNavigate(),{t:m}=w.useTranslation("@ashley/plugin-block-workbench"),u=r.useMemo(()=>{const d=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),c=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0);return{width:d,height:c}},[]),p=r.useCallback(d=>S(this,null,function*(){return d.start({facingMode:"environment"},{fps:10,qrbox(c,g){return o({width:c,height:g}),{width:u.width,height:u.height}}},c=>{l(c)},void 0)}),[l,o,u]),f=r.useCallback(d=>S(this,null,function*(){const{Html5QrcodeScannerState:c}=yield y.loadPackage("html5-qrcode"),g=d.getState();if([c.SCANNING,c.PAUSED].includes(g))return d.stop()}),[]),b=r.useCallback(d=>S(this,null,function*(){yield f(s);try{const{decodedText:c}=yield s.scanFileV2(d,!1);l(c)}catch(c){alert(m("QR code recognition failed, please scan again")),p(s)}}),[s,f,p,m,l]);return r.useEffect(()=>(S(this,null,function*(){const{Html5Qrcode:c}=yield y.loadPackage("html5-qrcode"),g=new c(i);a(g),p(g)}),()=>{f(s)}),[i,p,f]),{startScanCamera:p,startScanFile:b}}const T="qrcode",R=o=>{const i=r.useRef(),s=r.useRef(),{t:a}=w.useTranslation("@ashley/plugin-block-workbench"),[l,m]=r.useState({width:0,height:0}),u=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),p=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),{startScanFile:f}=$({onScannerSizeChanged:m,elementId:T}),b=()=>{const k=Math.floor(Math.min(u,p)*.6);return{left:`${(u-k)/2}px`,top:`${(p-k)/2}px`,position:"fixed",width:`${k}px`,height:`${k}px`}},d=()=>{s.current&&s.current.click()},c=k=>{const C=k.target.files;if(C.length>0){const B=C[0];B.size<1e6?f(B):alert(a("The image size is too large. Please compress it to below 1MB before uploading"))}};r.useEffect(()=>(document.documentElement.style.overscrollBehavior="none",()=>{document.documentElement.style.overscrollBehavior="default"}),[]),r.useEffect(()=>{const{width:k,height:C}=l,B=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),W=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0);if(k>0&&C>0&&C<W){const ie=W/C,L=Math.floor(ie*k),V=document.getElementsByTagName("video")[0];V.style.height=`${W}px`,V.style.width=`${L}px`,i.current.style.left=`${(B-L)/2}px`,i.current.style.position="absolute"}},[l]);const g=()=>e.jsx("div",{style:{position:"absolute",bottom:"20px",left:"20px",padding:"10px 60px"},children:e.jsxs("div",{style:{color:"white",width:"40px",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(v.FileImageOutlined,{style:z,onClick:d}),a("Album"),e.jsx("input",{ref:s,type:"file",accept:"image/*",onChange:c,style:{visibility:"hidden"}})]})}),z={zIndex:"1003",fontSize:"1.8em",fontWeight:"bold"};return e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:i,id:T,style:{position:"absolute"}}),e.jsx(Z,{style:x({},b())}),e.jsx(g,{})]})},ee=o=>{const{visible:i,setVisible:s}=t.useActionContext(),[a,l]=r.useState(!1),{t:m}=w.useTranslation("@ashley/plugin-block-workbench");r.useEffect(()=>{i&&!a&&S(this,null,function*(){try{const{Html5Qrcode:d}=yield y.loadPackage("html5-qrcode");(yield d.getCameras()).length===0?alert(m("No camera device detected")):l(!0)}catch(d){const c={NotFoundError:m("No camera device detected"),NotAllowedError:m("You have not granted permission to use the camera")};console.log(d);const g=c[d.name];alert(g!=null?g:d),l(!1),s(!1)}})},[i,a,s,m]);const u={position:"fixed",width:"100%",height:"100%",background:"black",zIndex:"1001",top:0,left:0,overflow:"hidden"},p={position:"absolute",top:"22px",left:"20px",zIndex:"1003",color:"white",fontSize:"1.8em",fontWeight:"bold"},f={position:"absolute",color:"white",fontSize:"1.5em",left:0,right:0,top:"20px",zIndex:"1002",marginLeft:"auto",marginRight:"auto",textAlign:"center"};return i&&a?e.jsxs("div",{style:u,children:[e.jsx(R,{}),e.jsx(v.LeftOutlined,{style:p,onClick:()=>s(!1)}),e.jsx("div",{style:f,children:m("Scan QR code")})]}):null},te={type:"void","x-decorator":"CardItem","x-settings":"blockSettings:workbench","x-schema-toolbar":"BlockSchemaToolbar","x-component":"WorkbenchBlock",properties:{actions:{"x-component":"WorkbenchBlock.ActionBar","x-initializer":"workbench:configureActions"}}},N={type:"item",name:"workbenchBlock",icon:"FileImageOutlined",useComponentProps(){const{t:o}=w.useTranslation("@ashley/plugin-block-workbench"),{insert:i}=t.useSchemaInitializer();return{title:o("Workbench"),onClick:()=>{i(te)}}}},oe=new t.SchemaSettings({name:"blockSettings:workbench",items:[{type:"remove",name:"remove"}]}),ne=new t.SchemaInitializer({name:"workbench:configureActions",title:'{{t("Configure actions")}}',insertPosition:"beforeEnd",items:[{name:"link",title:'{{t("Link")}}',Component:X}]});class H extends t.Plugin{load(){return S(this,null,function*(){this.app.addComponents({WorkbenchBlock:F,QRCodeScanner:ee}),this.app.schemaSettingsManager.add(oe),this.app.schemaInitializerManager.add(ne),this.app.schemaInitializerManager.addItem("page:addBlock",`otherBlocks.${N.name}`,N),this.app.schemaSettingsManager.add(J)})}}n.PluginBlockWorkbenchClient=H,n.default=H,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
