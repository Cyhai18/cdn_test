(function(e,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@nocobase/plugin-workflow/client"),require("react-i18next"),require("antd")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@nocobase/plugin-workflow/client","react-i18next","antd"],t):(e=typeof globalThis!="undefined"?globalThis:e||self,t(e["@ashley/plugin-workflow-x-variable"]={},e["@nocobase/client"],e.jsxRuntime,e["@nocobase/plugin-workflow"],e["react-i18next"],e.antd))})(this,function(e,t,r,s,g,v){"use strict";var _=Object.defineProperty,S=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var h=(e,t,r)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,C=(e,t)=>{for(var r in t||(t={}))j.call(t,r)&&h(e,r,t[r]);if(V)for(var r of V(t))M.call(t,r)&&h(e,r,t[r]);return e},I=(e,t)=>S(e,W(t));var c=(e,t,r)=>(h(e,typeof t!="symbol"?t+"":t,r),r);var y=(e,t,r)=>new Promise((s,g)=>{var v=i=>{try{f(r.next(i))}catch(x){g(x)}},d=i=>{try{f(r.throw(i))}catch(x){g(x)}},f=i=>i.done?s(i.value):Promise.resolve(i.value).then(v,d);f((r=r.apply(e,t)).next())});const d="@ashley/plugin-workflow-x-variable";function f(a,l={}){return t.i18n.t(a,I(C({},l),{ns:d}))}function i(a,l,n){var b;if(!a||!l)return[];let o=l;const p=[];for(;o!==null;){if(o===l){o=(b=a.find(w=>w.id===o))==null?void 0:b.upstreamId;continue}const u=a.find(w=>w.id===o);if(!u)break;u.type===n&&p.push(u),o=u.upstreamId}return p}function x(a){const{style:l,value:n,onChange:o}=a,{nodes:p}=s.useFlowContext(),b=s.useNodeContext(),u=i(p,b.id,"x-variable"),w=p?u.length===0:!0,k=[{label:f("Declare a new variable"),value:"new_variable"},{label:f("Assign value to an existing variable"),value:"update_variable",disabled:w}];return r.jsx(v.Radio.Group,{value:n,options:k,onChange:o,style:l})}function A(a){const{style:l,value:n,onChange:o,allowClear:p}=a,{nodes:b}=s.useFlowContext(),u=s.useNodeContext(),k=i(b,u.id,"x-variable").filter(m=>m.type==="x-variable"&&m.config.model==="new_variable").map(m=>({value:m.key,label:m.title}));return r.jsx(v.Select,{showSearch:!0,allowClear:!0,value:n,style:l,onChange:o,options:k})}const q=t.css`
  display: inline-block;
  width: 1em;
  text-align: center;
  font-style: italic;
  font-family: 'New York', 'Times New Roman', Times, serif;
`;class T extends s.Instruction{constructor(){super(...arguments);c(this,"title",`{{t("Variable", { ns: "${d}" })}}`);c(this,"type","x-variable");c(this,"group","control");c(this,"description",`{{t("Assign value to a variable, for later use.", { ns: "${d}" })}}`);c(this,"icon",r.jsx("span",{className:q,children:"X"}));c(this,"fieldset",{model:{type:"string",required:!0,title:`{{t("Model", { ns: "${d}" })}}`,"x-decorator":"FormItem","x-component":"ModelRadioGroup","x-component-props":{style:{display:"flex",flexDirection:"column",gap:8}},default:"","x-reactions":[{dependencies:[".xNode"],when:"{{!$deps[0]}}",fulfill:{state:{value:"new_variable"}}}]},xNode:{type:"string","x-decorator":"FormItem","x-component":"UpstreamVariableNodeSelect",required:!0,"x-component-props":{allowClear:!0,style:{width:"20%"}},"x-reactions":[{dependencies:[".model"],when:'{{$deps[0] === "update_variable"}}',fulfill:{state:{visible:!0}},otherwise:{state:{visible:!1}}}]},xValue:{type:"string",required:!0,title:`{{t("Value", { ns: "${d}" })}}`,"x-decorator":"FormItem","x-component":"WorkflowVariableTextArea"}});c(this,"components",{WorkflowVariableInput:s.WorkflowVariableInput,WorkflowVariableTextArea:s.WorkflowVariableTextArea,ModelRadioGroup:x,UpstreamVariableNodeSelect:A})}useVariables(n){var o;return((o=n==null?void 0:n.config)==null?void 0:o.model)=="update_variable"?null:{value:n.key,label:n.title}}isAvailable({engine:n,workflow:o}){return!0}}class N extends t.Plugin{afterAdd(){return y(this,null,function*(){})}beforeLoad(){return y(this,null,function*(){})}load(){return y(this,null,function*(){this.app.pm.get("workflow").registerInstruction("x-variable",T)})}}e.PluginWorkflowXVariableClient=N,e.default=N,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
