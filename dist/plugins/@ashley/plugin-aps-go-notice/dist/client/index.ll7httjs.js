(function(t,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("@formily/shared"),require("react/jsx-runtime"),require("react"),require("@formily/core"),require("@emotion/css"),require("@formily/antd-v5"),require("@formily/react"),require("@ant-design/icons"),require("lodash"),require("@nocobase/plugin-workflow/client"),require("@ashley/plugin-workflow-audit/client")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","@formily/shared","react/jsx-runtime","react","@formily/core","@emotion/css","@formily/antd-v5","@formily/react","@ant-design/icons","lodash","@nocobase/plugin-workflow/client","@ashley/plugin-workflow-audit/client"],e):(t=typeof globalThis!="undefined"?globalThis:t||self,e(t["@ashley/plugin-aps-go-notice"]={},t["@nocobase/client"],t["@formily/shared"],t.jsxRuntime,t.react,t["@formily/core"],t["@emotion/css"],t["@formily/antd-v5"],t["@formily/react"],t["@ant-design/icons"],t.lodash,t["@nocobase/plugin-workflow"],t["@ashley/plugin-workflow-audit"]))})(this,function(t,e,r,i,S,A,v,m,c,x,b,k,N){"use strict";var H=Object.defineProperty,V=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable;var C=(t,e,r)=>e in t?H(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,f=(t,e)=>{for(var r in e||(e={}))Q.call(e,r)&&C(t,r,e[r]);if(O)for(var r of O(e))R.call(e,r)&&C(t,r,e[r]);return t},y=(t,e)=>V(t,K(e));var T=(t,e,r)=>(C(t,typeof e!="symbol"?e+"":e,r),r);var w=(t,e,r)=>new Promise((i,S)=>{var A=c=>{try{m(r.next(c))}catch(x){S(x)}},v=c=>{try{m(r.throw(c))}catch(x){S(x)}},m=c=>c.done?i(c.value):Promise.resolve(c.value).then(A,v);m((r=r.apply(t,e)).next())});const q=e.createStyles(({css:o,token:n})=>({attachmentsSelect:o`
      ul {
        padding: 0;
        margin: 0;

        li {
          display: flex;
          list-style: none;
          justify-content: space-between;

          &:not(:last-child) {
            margin-bottom: 10px;
          }

          .anticon-delete {
            margin-left: 10px;
            padding-left: 10px;
            font-size: 16px;
          }
        }
      }
    `}));var F=(o=>(o.apsWorkflow="aps_workflow",o.apsPriceChangeWorkflow="aps_price_change_workflow",o.apsSplitChangeWorkflow="aps_split_change_workflow",o.apsPriceSplitChangeWorkflow="aps_price_split_change_workflow",o))(F||{}),E=(o=>(o.sample="sample",o.priceChange="price_change",o.splitChange="split_change",o.priceSplitChange="price_split_change",o))(E||{});const I={aps_workflow:"sample",aps_price_change_workflow:"price_change",aps_split_change_workflow:"split_change",aps_price_split_change_workflow:"price_split_change"},G=o=>o.filter(n=>b.isObject(n)?n.type==="dwg"?n.options.length>0:!!n.link:!1),j=o=>{const{options:n}=o,p=n.find(a=>!!a.selected);return{defaultValue:p?p.link:void 0,options:n.map(a=>({id:a.id,label:a.name,value:a.link}))}},D=o=>{const{value:n,onChange:p,disabled:a}=o,{styles:u}=q(),l=G(n),h=s=>{if(["word","other","images"].includes(s.type))return i.jsx(e.EllipsisWithTooltip,{ellipsis:!0,popoverContent:s.name,children:i.jsx("a",{href:s.link,target:"_blank",children:s.name})});if(s.type==="dwg"){const d=j(s);return i.jsx(e.Select,y(f({},d),{allowClear:!1}))}return null},g=s=>{p(l.filter(d=>d!==s))};return i.jsxs("div",{className:u.attachmentsSelect,children:[i.jsx("ul",{children:l.map((s,d)=>i.jsxs("li",{children:[h(s),a?null:i.jsx(x.DeleteOutlined,{onClick:b.partial(g,s)})]},s.type==="dwg"?d:s.link))}),i.jsx(e.Upload.Attachment,{disabled:a,fileListVisible:!1,action:"attachments:create",accept:"*",onChange:s=>{if(s){const d=s.title+s.extname;p([...l,{id:s.id,type:"other",name:d,link:s.url}])}}})]})},L=o=>{const{disabled:n}=o,p=e.useSchemaComponentContext(),a=c.useFieldSchema(),u=e.useCompile(),l=e.useCollectionRecordData(),h=l&&l.id,g=a.hasOwnProperty("x-component-props")?a["x-component-props"].apsApplication:"",s=S.useRef(null),d=S.useMemo(()=>A.createForm({values:{title:"",sendTo:"",cc:"",body:"",attachments:[],mailListId:"",workflowId:""}}),[]);e.useRequest({resource:"aps",action:"getEmailByWorkflowId",params:{workflowId:h,applications:g}},{manual:!h,onSuccess({data:_}){var P;d.setInitialValues(f({},_)),(P=s.current)==null||P.clipboard.dangerouslyPasteHTML(_.body)}});const U=_=>{s.current=_};return i.jsxs("div",{className:v.css`
        height: 100%;
      `,children:[i.jsx(e.SchemaToolbar,{title:u('{{t("Block")}}'),initializer:!1,settings:"apsGoNoticeEmailBlockSettings"}),i.jsxs(m.Form,{form:d,layout:"vertical",children:[i.jsx(c.Field,{name:"sendTo",title:"To List",decorator:[m.FormItem],component:[e.Input.TextArea,{disabled:n}]}),i.jsx(c.Field,{name:"cc",title:"CC List",decorator:[m.FormItem],component:[e.Input.TextArea,{disabled:n}]}),i.jsx(c.Field,{name:"title",title:"Subject",decorator:[m.FormItem],component:[e.Input.TextArea,{disabled:n}]}),i.jsx(c.Field,{name:"body",title:"Content",decorator:[m.FormItem],component:[e.RichText,{onRef:U,disabled:n}]}),i.jsx(c.Field,{name:"attachments",title:"Attachment",decorator:[m.FormItem],component:[D,{disabled:n}]}),i.jsx(e.SchemaComponentOptions,y(f({},p),{children:i.jsx(c.RecursionField,{schema:a,onlyRenderProperties:!0})}))]})]})},M=Object.values(E).map(o=>({label:o,value:o})),W=new e.SchemaSettings({name:"apsGoNoticeEmailBlockSettings",items:[{name:"Aps applications",Component:e.SchemaSettingsSelectItem,useComponentProps(){var u;const o=c.useFieldSchema(),n=(u=o["x-component-props"])==null?void 0:u.apsApplication,{dn:p}=e.useDesignable(),a=e.useCollection();return{title:"Aps applications",value:n,options:M.map(l=>l.value!==I[a.getOptions().name]?y(f({},l),{disabled:!0}):l),onChange(l){o["x-component-props"]=f({},o["x-component-props"]),o["x-component-props"].apsApplication=l,p.emit("patch",{schema:{"x-uid":o["x-uid"],"x-component-props":o["x-component-props"]}}),p.refresh()}}}},{name:"remove",sort:100,Component:e.RemoveButton,useComponentProps(){const{removeButtonProps:o}=e.useSchemaToolbar();return o}}]});function z(){var g;const{run:o}=N.useSubmit(),n=c.useForm(),p=e.useAPIClient(),a=c.useFieldSchema(),u=a.parent.parent,l=((g=u==null?void 0:u["x-component-props"])==null?void 0:g.apsApplication)||"sample",h=a["x-decorator-props"].value;return{run(){return w(this,null,function*(){yield p.request({url:"aps:createEmailByWorkflowId",method:"post",data:y(f({},n.values),{applications:l,isPushEmail:h===k.JOB_STATUS.RESOLVED?1:0,isDelete:[k.JOB_STATUS.REJECTED,k.JOB_STATUS.ABORTED].includes(h)?1:0})}),yield o()})}}}const J=(o,{collection:n,dataPath:p,props:a})=>({type:"void",name:r.uid(),"x-designer":"SimpleDesigner","x-decorator":"DetailsBlockProvider","x-decorator-props":{collection:n,dataPath:p},"x-component":"CardItem","x-component-props":{title:o.title,className:a.cardItemClassName},properties:{apsGoNoticeForm:{type:"void","x-component":"ApsGoNoticeEmailFormBlock","x-component-props":{apsApplication:I[n]},properties:{actions:{type:"void","x-decorator":"ActionBarProvider","x-component":"ActionBar","x-component-props":{layout:"one-column",style:{marginTop:"1.5em",flexWrap:"wrap"}},"x-initializer":"AddActionButton_AuditCard","x-initializer-props":{actionProps:{useAction:"{{ useApsGoNoticeEmailFormSubmit }}"}},properties:{resolve:{type:"void",title:"Submit","x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:k.JOB_STATUS.RESOLVED},"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useApsGoNoticeEmailFormSubmit }}"},"x-designer":"ManualActionDesigner"}}}}}}});class B extends e.Plugin{constructor(){super(...arguments);T(this,"createApsGoNoticeEmailBlockSchema",J);T(this,"scopes",{useApsGoNoticeEmailFormSubmit:z})}isInitializerItemVisible(p){return Object.values(F).includes(p)}afterAdd(){return w(this,null,function*(){})}beforeLoad(){return w(this,null,function*(){})}load(){return w(this,null,function*(){this.app.addComponents({ApsGoNoticeEmailFormBlock:L}),this.app.schemaSettingsManager.add(W)})}}t.PluginApsGoNoticeClient=B,t.default=B,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
