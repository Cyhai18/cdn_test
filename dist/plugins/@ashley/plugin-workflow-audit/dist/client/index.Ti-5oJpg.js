(function(B,r){typeof exports=="object"&&typeof module!="undefined"?r(exports,require("@nocobase/client"),require("@formily/react"),require("react/jsx-runtime"),require("react"),require("@ant-design/icons"),require("react-i18next"),require("lodash"),require("@nocobase/plugin-workflow/client"),require("antd"),require("@formily/antd-v5"),require("@formily/core"),require("@nocobase/utils/client"),require("@formily/shared"),require("@emotion/css"),require("dayjs"),require("antd-style")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","@formily/react","react/jsx-runtime","react","@ant-design/icons","react-i18next","lodash","@nocobase/plugin-workflow/client","antd","@formily/antd-v5","@formily/core","@nocobase/utils/client","@formily/shared","@emotion/css","dayjs","antd-style"],r):(B=typeof globalThis!="undefined"?globalThis:B||self,r(B["@ashley/plugin-workflow-audit"]={},B["@nocobase/client"],B["@formily/react"],B.jsxRuntime,B.react,B["@ant-design/icons"],B["react-i18next"],B.lodash,B["@nocobase/plugin-workflow"],B.antd,B["@formily/antd-v5"],B["@formily/core"],B["@nocobase/utils"],B["@formily/shared"],B["@emotion/css"],B.dayjs,B["antd-style"]))})(this,function(B,r,C,s,y,ae,V,J,x,N,ue,_e,D,me,K,yn,ze){"use strict";var Ep=Object.defineProperty,jp=Object.defineProperties;var zp=Object.getOwnPropertyDescriptors;var ct=Object.getOwnPropertySymbols;var Cn=Object.prototype.hasOwnProperty,xn=Object.prototype.propertyIsEnumerable;var $t=(B,r,C)=>r in B?Ep(B,r,{enumerable:!0,configurable:!0,writable:!0,value:C}):B[r]=C,m=(B,r)=>{for(var C in r||(r={}))Cn.call(r,C)&&$t(B,C,r[C]);if(ct)for(var C of ct(r))xn.call(r,C)&&$t(B,C,r[C]);return B},w=(B,r)=>jp(B,zp(r));var ne=(B,r)=>{var C={};for(var s in B)Cn.call(B,s)&&r.indexOf(s)<0&&(C[s]=B[s]);if(B!=null&&ct)for(var s of ct(B))r.indexOf(s)<0&&xn.call(B,s)&&(C[s]=B[s]);return C};var le=(B,r,C)=>($t(B,typeof r!="symbol"?r+"":r,C),C);var G=(B,r,C)=>new Promise((s,y)=>{var ae=x=>{try{J(C.next(x))}catch(N){y(N)}},V=x=>{try{J(C.throw(x))}catch(N){y(N)}},J=x=>x.done?s(x.value):Promise.resolve(x.value).then(ae,V);J((C=C.apply(B,r)).next())});function bn(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const o in e)if(o!=="default"){const n=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,n.get?n:{enumerable:!0,get:()=>e[o]})}}return t.default=e,Object.freeze(t)}const Oe=bn(y);function Sn(e){return e.isForeignKey?e.target==="users":e.collectionName==="users"&&e.name==="id"}function Pt({multiple:e=!1,value:t=[],onChange:o}){const n=x.useWorkflowVariableOptions({types:[Sn]});return s.jsx(r.Variable.Input,{scope:n,value:t[0],onChange:a=>{o([a])},children:s.jsx(r.RemoteSelect,{multiple:e,fieldNames:{label:"nickname",value:"id"},service:{resource:"users"},manual:!1,value:t[0],onChange:a=>{o(a!=null?[a]:[])}})})}function vn({value:e,onChange:t}){const o=x.useNodeContext(),a=x.useAvailableUpstreams(o,i=>i.type==="audit").map(i=>({label:`#${i.id}_${i.title}`,value:i.id}));return s.jsx(N.Select,{role:"button",allowClear:!0,"data-testid":"select-time-unit",popupMatchSelectWidth:!1,onChange:t,className:"auto-width",options:a,value:e})}const S="@ashley/plugin-workflow-audit";function Ve(e,t={}){const{t:o}=Be(t);return o(e)}function Be(e){return V.useTranslation(S,e)}const Le={ENTER:"entry",APPROVE:"approve"},Ue=[{label:`{{t("Information Enter Only", { ns: "${S}" })}}`,value:Le.ENTER},{label:`{{t("Review Information and make Decision", { ns: "${S}" })}}`,value:Le.APPROVE}],Ge={OR:1,ADVANCED_OR:2},Mt="AuditTodo",Et={hidden:!0,type:"basic",title:`{{t("Node", { ns: "${S}" })}}`,name:"flow_nodes",fields:[{type:"string",name:"title",interface:"input",uiSchema:{type:"string",title:'{{t("Title")}}',"x-component":"Input"}}]},jt={hidden:!0,type:"basic",title:`{{t("Workflow", { ns: "${S}" })}}`,name:"workflows",fields:[{type:"string",name:"title",interface:"input",uiSchema:{title:'{{t("Name")}}',type:"string","x-component":"Input",required:!0}}]},zt={hidden:!0,type:"basic",title:`{{t("Node Job", { ns: "${S}" })}}`,name:"jobs",fields:[{type:"integer",name:"status",interface:"select",uiSchema:{type:"number",title:`{{t("Status", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}}]},wn={title:`{{t("Audit jobs", { ns: "${S}" })}}`,name:"audits_jobs",fields:[{type:"belongsTo",name:"user",target:"users",foreignKey:"userId",interface:"m2o",uiSchema:{type:"number",title:'{{t("User")}}',"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"nickname",value:"id"},service:{resource:"users"}}}},{type:"belongsTo",name:"node",target:"flow_nodes",foreignKey:"nodeId",interface:"m2o",isAssociation:!0,uiSchema:{type:"number",title:`{{t("Node", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"flow_nodes"}}}},{type:"belongsTo",name:"job",target:"jobs",foreignKey:"jobId",interface:"m2o",isAssociation:!0,uiSchema:{type:"number",title:`{{t("Node job", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}},{type:"belongsTo",name:"workflow",target:"workflows",foreignKey:"workflowId",interface:"m2o",uiSchema:{type:"number",title:`{{t("Workflow", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"workflows"}}}},{type:"integer",name:"status",interface:"select",uiSchema:{type:"number",title:`{{t("Status", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}},{type:"string",name:"nodeTag",interface:"select",uiSchema:{type:"string",title:`{{t("Node Tag", { ns: "${S}" })}}`,"x-component":"Select",required:!0,enum:Ue}},{name:"createdAt",type:"date",interface:"createdAt",uiSchema:{type:"datetime",title:'{{t("Created at")}}',"x-component":"DatePicker","x-component-props":{showTime:!0}}}]},Fn={title:`{{t("Audit jobs", { ns: "${S}" })}}`,name:"audits_jobs",hidden:!1,type:"basic",fields:[{type:"bigInt",name:"id",primaryKey:!0,autoIncrement:!0,interface:"number",uiSchema:{type:"number",title:"ID","x-component":"InputNumber","x-component-props":{fieldNames:{label:"title",value:"id"}}}},{type:"belongsTo",name:"user",target:"users",foreignKey:"userId",interface:"m2o",uiSchema:{type:"number",title:'{{t("User")}}',"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"nickname",value:"id"},service:{resource:"users"}}}},{type:"belongsTo",name:"job",target:"jobs",foreignKey:"jobId",interface:"m2o",isAssociation:!0,uiSchema:{type:"number",title:`{{t("Node job", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}},{type:"belongsTo",name:"workflow",target:"workflows",foreignKey:"workflowId",interface:"m2o",uiSchema:{type:"number",title:`{{t("Workflow", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"workflows"}}}},{type:"integer",name:"status",interface:"select",uiSchema:{type:"number",title:`{{t("Status", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}},{type:"string",name:"nodeTag",interface:"select",uiSchema:{type:"string",title:`{{t("Node Tag", { ns: "${S}" })}}`,"x-component":"Select",required:!0,enum:Ue}},{name:"createdAt",type:"date",interface:"createdAt",uiSchema:{type:"datetime",title:'{{t("Created at")}}',"x-component":"DatePicker","x-component-props":{showTime:!0}}}]},Vt="MessageInformation";function An({value:e,onChange:t}){const o=r.useCompile();return s.jsx(N.Select,{role:"button",allowClear:!0,"data-testid":"select-time-unit",popupMatchSelectWidth:!1,onChange:t,className:"auto-width",options:Ue.map(n=>w(m({},n),{label:o(n.label)})),value:e})}const Lt=(e,t)=>{for(;e;){if(e["x-uid"]===t)return!0;e=e.parent}return!1};function Q(e,t,o=!1){const n=[];return e?t(e)&&(!o||!e.properties)?(n.push(e),n):(e.properties&&Object.keys(e.properties).forEach(a=>{n.push(...Q(e.properties[a],t))}),n):n}function In(e){const t={};return Q(e,n=>n["x-component"]==="ApsGoNoticeEmailFormBlock").forEach(n=>{var i;const a=n.name;t[a]={type:"custom",title:((i=n["x-component-props"])==null?void 0:i.title)||a,actions:Q(n.properties.actions,c=>c["x-component"]==="Action").map(c=>{var l,p;return{status:c["x-decorator-props"].value,values:(p=(l=c["x-action-settings"])==null?void 0:l.assignedValues)==null?void 0:p.values,key:c.name}})}}),t}const Ut=e=>[x.EXECUTION_STATUS.QUEUEING,x.EXECUTION_STATUS.STARTED].includes(e),Tn=e=>({string:"Mock Value",text:"Mock Value",integer:null,bigInt:1,float:1,double:1,decimal:1,boolean:!0,date:null,time:null,uuid:"1",nanoid:"1",sort:1,array:[],json:{},set:[],enum:[]})[e]||null;function Ne(e){var Ce,$,P,E,j,X,ee;const t=x.useFlowContext(),{userJob:o,execution:n,workflow:a}=t,i=C.useFieldSchema(),c=C.useField(),l=y.useRef(null),p=e.dataSource||r.DEFAULT_DATA_SOURCE_KEY,{getCollectionFields:d}=r.useCollectionManager_deprecated(),{getAssociationAppends:u}=r.useAssociationNames(p),{appends:f,updateAssociationValues:h}=u(),[F]=Object.keys((Ce=i.toJSON().properties)!=null?Ce:{}),g=($=o==null?void 0:o.result)==null?void 0:$[F],[b,k]=y.useState(g||{}),{findComponent:_,designable:T}=r.useDesignable(),A=_((P=c.component)==null?void 0:P[0])||y.Fragment,v=()=>{const oe={};return Q(i,R=>f.includes(R.name)&&R["x-read-pretty"]).forEach(R=>{const z=d(R["x-collection-field"]);oe[R.name]={},z.forEach(re=>{const ie=Tn(re.type);ie&&(oe[R.name][re.name]=ie)})}),oe},I=y.useMemo(()=>_e.createForm({initialValues:T?v():b}),[]),O=y.useMemo(()=>m({appends:f},e.params),[f,e.params]),M=(E=e.useParams)==null?void 0:E.call(e),L=y.useMemo(()=>({loading:!1,data:{data:b}}),[b]),Z=r.useAPIClient(),q=r.useDataSourceHeaders(p),H=Z.resource(e.collection,void 0,q);y.useEffect(()=>{if(T)return;const oe=R=>{const z=m(m({},I.values),R);k(z),I.setValues(z)};G(this,null,function*(){var ie,ke,xe,mn,fn,hn,gn;if(e.action==="get"){try{const{data:ce}=yield H.get(m(m({},O),M));oe(ce.data)}catch(ce){D.captureException(ce)}return}const z=(mn=(xe=(ke=(ie=e.filter)==null?void 0:ie.$and)==null?void 0:ke[0])==null?void 0:xe.id)==null?void 0:mn.$eq;if(z&&e.formType==="update"){let ce;if(typeof z=="string"&&z.includes("$jobsMapByNodeKey")){const je=z.split(",")[1],{data:Mp}=yield Z.request({url:"/jobs:get",params:{filter:{node_key:je,execution_id:n.id}}});ce=Mp.data.result.id}else typeof z=="string"&&z.includes("$context.data.id")?ce=(hn=(fn=n==null?void 0:n.context)==null?void 0:fn.data)==null?void 0:hn.id:ce=z;if(!ce)return;try{const{data:je}=yield H.get({filterByTk:ce,appends:(gn=a==null?void 0:a.config)==null?void 0:gn.appends});oe(je.data)}catch(je){D.captureException(je)}}})},[T,(X=(j=n==null?void 0:n.context)==null?void 0:j.data)==null?void 0:X.id,(ee=a==null?void 0:a.config)==null?void 0:ee.appends]);const Y=r.useBlockRequestContext(),se=y.useMemo(()=>({type:e.formType,params:O,form:I,field:c,service:L,updateAssociationValues:h,formBlockRef:l,collectionName:e.collection}),[c,I,O,L,h,e.collection,e.formType]);return!(o!=null&&o.status)||b?s.jsx(r.CollectionManagerProvider,{dataSource:p,children:s.jsx(r.CollectionProvider_deprecated,{collection:e.collection,children:s.jsx(r.RecordProvider,{record:b,parent:null,children:s.jsx(r.FormActiveFieldsProvider,{name:"form",children:s.jsx(r.BlockRequestContext_deprecated.Provider,{value:{block:"form",props:e,field:c,service:L,resource:H,__parent:Y},children:s.jsx(r.FormBlockContext.Provider,{value:se,children:s.jsxs(A,w(m({},c.componentProps),{children:[s.jsx(r.FormV2.Templates,{style:{marginBottom:18},form:I}),s.jsx("div",{ref:l,children:s.jsx(C.RecursionField,{schema:i,onlyRenderProperties:!0})})]}))})})})})})}):null}const lt="AuditCardUpdateForm";function kn(){const{name:e,title:t}=r.useCollection_deprecated(),o=C.useFieldSchema(),{t:n}=V.useTranslation(),{dn:a}=r.useDesignable();return s.jsxs(r.GeneralSchemaDesigner,{title:t||e,children:[s.jsx(r.SchemaSettingsBlockTitleItem,{}),s.jsx(r.SchemaSettingsActionModalItem,{title:n("Filter settings",{ns:S}),schema:{name:"filter",type:"object",title:'{{t("Filter")}}',"x-component":"Filter","x-component-props":{useProps(){var c;return{options:r.useCollectionFilterOptions((c=o==null?void 0:o["x-decorator-props"])==null?void 0:c.collection)}},dynamicComponent:"FilterDynamicComponent"}},initialValues:o==null?void 0:o["x-decorator-props"],onSubmit:({filter:i})=>{o["x-decorator-props"].filter=i,a.emit("patch",{schema:{"x-decorator-props":o["x-decorator-props"]}}),a.refresh()}}),s.jsx(r.SchemaSettingsLinkageRules,{collectionName:e}),s.jsx(r.SchemaSettingsTemplate,{componentName:lt,collectionName:e,resourceName:e,schemaOnlyHasName:!0}),s.jsx(r.SchemaSettingsDivider,{}),s.jsx(r.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})}const _n={title:`{{t("Update record form", { ns: "${S}" })}}`,config:{useInitializer({allCollections:e,currentNode:t}){const o=y.useMemo(()=>e.map(({key:c,displayName:l,collections:p})=>({key:c,name:c,label:l,type:"subMenu",children:p.map(d=>({name:J.camelCase(`updateRecordForm-child-${d.name}`),type:"item",title:d.title||d.tableName,currentNode:t,schema:{collection:d.name,dataSource:c,formType:"update","x-designer":"UpdateFormDesigner"},Component:Gt}))})),[e,t]),[n,a]=y.useState([]),i=r.useMenuSearch({data:o,openKeys:n});return{name:"updateRecordForm",key:"updateRecordForm",type:"subMenu",title:`{{t("Update record form", { ns: "${S}" })}}`,componentProps:{onOpenChange(c){a(c)}},children:i}},initializers:{},components:{FilterDynamicComponent:x.FilterDynamicComponent,UpdateFormDesigner:kn},parseFormOptions(e){const t={};return Q(e,n=>n["x-decorator"]==="FormBlockProvider"&&n["x-decorator-props"].formType==="update").forEach(n=>{var l,p;const[a]=Object.keys(n.properties),i=n.properties[a],c=((l=Object.entries(i.properties).find(([d,u])=>u["x-component"]==="ActionBar"))==null?void 0:l[0])||"actions";t[a]=w(m({},n["x-decorator-props"]),{type:"update",title:((p=n["x-component-props"])==null?void 0:p.title)||a,actions:Q(i.properties[c],d=>d["x-component"]==="Action").map(d=>{var u,f;return{status:d["x-decorator-props"].value,values:(f=(u=d["x-action-settings"])==null?void 0:u.assignedValues)==null?void 0:f.values,key:d.name,title:d.title}})})}),t}},block:{scope:{},components:{}},validate({filter:e}){return!e||!D.isValidFilter(e)?"Please check one of your update record form, and add at least one filter condition in form settings.":null}},On=e=>{const k=e,{formItemInitializers:t="FormItemInitializers",actionInitializers:o="FormActionInitializers",collection:n,resource:a,dataSource:i,association:c,action:l,actions:p={},"x-designer":d="FormV2.Designer",title:u,settings:f,cardItemClassName:h}=k,F=ne(k,["formItemInitializers","actionInitializers","collection","resource","dataSource","association","action","actions","x-designer","title","settings","cardItemClassName"]),g=a||c||n;return w(m({type:"void","x-acl-action-props":{skipScopeCheck:!l},"x-acl-action":l?`${g}:update`:`${g}:create`,"x-decorator":"FormBlockProvider","x-decorator-props":w(m({},F),{action:l,dataSource:i,resource:g,collection:n,association:c}),"x-toolbar":"BlockSchemaToolbar"},f?{"x-settings":f}:{"x-designer":d}),{"x-component":"CardItem","x-component-props":{title:u,className:h},properties:{[me.uid()]:{type:"void","x-component":"FormV2","x-component-props":{useProps:"{{ useFormBlockProps }}"},properties:{grid:{type:"void","x-decorator":"AuditCardFormCollapse","x-component":"Grid","x-initializer":t,properties:{},"x-index":1},[me.uid()]:{type:"void","x-initializer":o,"x-component":"ActionBar","x-component-props":{layout:"one-column",style:{marginTop:24}},"x-index":2,properties:p}}}}})},Bn=(e,t=null,o=null,n=null)=>{const{t:a}=V.useTranslation(),i=r.useCollection_deprecated(),{getTemplatesByCollection:c}=r.useSchemaTemplateManager(),l=c(i.dataSource,o||i.name).filter(d=>e&&d.componentName===e).filter(d=>["FormItem","ReadPrettyFormItem",lt].includes(e)||d.resourceName===n);if(!l.length)return[];const p=0;return[{key:`${o||e}_table_blank`,type:"item",name:i.name,title:a("Blank block"),item:t},{type:"divider"},{key:`${o||e}_table_subMenu_${p}_copy`,type:"subMenu",name:"copy",title:a("Duplicate template"),children:l.map(d=>({type:"item",mode:"copy",name:i.name,template:d,item:t,title:(d==null?void 0:d.name)||a("Untitled")}))}]};function Nn(o){var n=o,{schema:e}=n,t=ne(n,["schema"]);var u;const{currentNode:a}=t,{getTemplateSchemaByMode:i}=r.useSchemaTemplateManager(),{insert:c}=r.useSchemaInitializer(),l=Bn(lt),p=!a||((u=a==null?void 0:a.config)==null?void 0:u.nodeTag)!=="entry";function d(h){return G(this,arguments,function*({item:f}){var _;const F=f.template?yield i(w(m({},f),{keepOriginSchemaSort:!0})):null;if(F){x.traverseSchema(F,T=>{T["x-uid"]&&delete T["x-uid"]}),c(F);return}const g=On(w(m({actionInitializers:"AddActionButton_AuditCard",actions:{resolve:{type:"void",title:p?`{{t("Approve", { ns: "${S}" })}}`:`{{t("Submit", { ns: "${S}" })}}`,"x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:x.JOB_STATUS.RESOLVED},"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useSubmit }}"},"x-designer":"ManualActionDesigner","x-designer-props":{isApproveNode:p}}}},e),{cardItemClassName:K.css`
        box-shadow: none !important;
        > .ant-card-body {
          padding: 24px;
        }
      `}));delete g["x-acl-action-props"],delete g["x-acl-action"];const[b]=Object.keys(g.properties),k=((_=Object.entries(g.properties[b].properties).find(([T,A])=>A["x-component"]==="ActionBar"))==null?void 0:_[0])||"actions";g.properties[b].properties.grid["x-index"]=1,g.properties[b].properties[k]["x-index"]=2,g.properties[b].properties[k]["x-decorator"]="ActionBarProvider",g.properties[b].properties[k]["x-component-props"].style={marginTop:"1.5em",flexWrap:"wrap"},x.traverseSchema(g,T=>{T["x-uid"]&&delete T["x-uid"]}),c(g)})}return s.jsx(r.SchemaInitializerItem,w(m({},J.omit(t,"currentNode")),{onClick:d,items:l}))}function Gt(){var t,o;const e=r.useSchemaInitializerItem();return s.jsx(r.CollectionProvider_deprecated,{dataSource:(t=e.schema)==null?void 0:t.dataSource,collection:(o=e.schema)==null?void 0:o.collection,children:s.jsx(Nn,m({},e))})}function Dn(){const{name:e,title:t}=r.useCollection_deprecated();return s.jsxs(r.GeneralSchemaDesigner,{title:t||e,children:[s.jsx(r.SchemaSettingsBlockTitleItem,{}),s.jsx(r.SchemaSettingsLinkageRules,{collectionName:e}),s.jsx(r.SchemaSettingsDataTemplates,{collectionName:e}),s.jsx(r.SchemaSettingsDivider,{}),s.jsx(r.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})}const $n={title:`{{t("Create record form", { ns: "${S}" })}}`,config:{useInitializer({allCollections:e}){const t=y.useMemo(()=>e.map(({key:i,displayName:c,collections:l})=>({key:i,name:i,label:c,type:"subMenu",children:l.map(p=>({name:J.camelCase(`createRecordForm-child-${p.name}`),type:"item",title:p.title||p.tableName,schema:{collection:p.name,dataSource:i,formType:"create","x-designer":"CreateFormDesigner"},Component:Gt}))})),[e]),[o,n]=y.useState([]),a=r.useMenuSearch({data:t,openKeys:o});return{name:"createRecordForm",key:"createRecordForm",type:"subMenu",title:`{{t("Create record form", { ns: "${S}" })}}`,componentProps:{onOpenChange(i){n(i)}},children:a}},initializers:{},components:{CreateFormDesigner:Dn},parseFormOptions(e){const t={};return Q(e,n=>n["x-decorator"]==="FormBlockProvider"&&n["x-decorator-props"].formType==="create").forEach(n=>{var l,p;const[a]=Object.keys(n.properties),i=n.properties[a],c=((l=Object.entries(i.properties).find(([d,u])=>u["x-component"]==="ActionBar"))==null?void 0:l[0])||"actions";t[a]={type:"create",title:((p=n["x-component-props"])==null?void 0:p.title)||a,actions:Q(i.properties[c],d=>d["x-component"]==="Action").map(d=>{var u,f;return{status:d["x-decorator-props"].value,values:(f=(u=d["x-action-settings"])==null?void 0:u.assignedValues)==null?void 0:f.values,key:d.name,title:d.title}}),collection:n["x-decorator-props"].collection}}),t}},block:{scope:{},components:{}}};function Ht(e){var d,u,f,h;const{userJob:t}=x.useFlowContext(),[o,n]=y.useState((u=(d=e.collection)==null?void 0:d.fields)!=null?u:[]),a=C.useField(),i=C.useFieldSchema(),[c]=Object.keys((f=i.toJSON().properties)!=null?f:{}),l=(h=t==null?void 0:t.result)==null?void 0:h[c],p=y.useMemo(()=>_e.createForm({initialValues:l}),[l]);return!(t!=null&&t.status)||l?s.jsx(r.CollectionProvider_deprecated,{collection:w(m({},e.collection),{fields:o}),children:s.jsx(r.RecordProvider,{record:l,parent:null,children:s.jsx(r.FormBlockContext.Provider,{value:{form:p,field:a,setCollectionFields:n},children:e.children})})}):null}function Pn(){const{insert:e}=r.useSchemaInitializer(),t=r.useSchemaInitializerItem();return s.jsx(r.SchemaInitializerItem,w(m({},t),{onClick:()=>{e({type:"void","x-decorator":"CustomFormBlockProvider","x-decorator-props":{collection:{name:D.uid(),fields:[]}},"x-component":"CardItem","x-component-props":{className:r.css`
              box-shadow: none !important;
              > .ant-card-body {
                padding: 24px;
              }
            `},"x-designer":"SimpleDesigner","x-designer-props":{type:"customForm"},properties:{[D.uid()]:{type:"void","x-component":"FormV2","x-component-props":{useProps:"{{ useFormBlockProps }}"},properties:{grid:{type:"void","x-component":"Grid","x-initializer":"AddCustomFormField_Audit"},actions:{type:"void","x-decorator":"ActionBarProvider","x-component":"ActionBar","x-component-props":{layout:"one-column",style:{marginTop:"1.5em",flexWrap:"wrap"}},"x-initializer":"AddActionButton_AuditCard",properties:{resolve:{type:"void",title:`{{t("Approve", { ns: "${S}" })}}`,"x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:x.JOB_STATUS.RESOLVED},"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useSubmit }}"},"x-designer":"ManualActionDesigner"}}}}}}})}}))}const Jt={basic:'{{t("Basic")}}',choices:'{{t("Choices")}}',media:'{{t("Media")}}',datetime:'{{t("Date & Time")}}',relation:'{{t("Relation")}}',advanced:'{{t("Advanced type")}}',systemInfo:'{{t("System info")}}',others:'{{t("Others")}}'};function Mn(e){const t={};return Object.keys(e).forEach(o=>{const n=e[o],{group:a="others"}=n;t[a]=t[a]||{},J.set(t,[a,o],n)}),Object.keys(Jt).filter(o=>["basic","choices","datetime","media"].includes(o)).map(o=>({title:Jt[o],children:Object.keys(t[o]||{}).map(n=>{const a=t[o][n];return m({value:n,title:a.title,name:n},t[o][n])}).sort((n,a)=>n.order-a.order)}))}function En(){const{interfaces:e}=r.useCollectionManager_deprecated();return Mn(e).map(o=>({name:o.title,type:"itemGroup",title:o.title,children:o.children.map(n=>({name:n.name,type:"item",title:n.title,Component:Vn,fieldInterface:n.name}))}))}const Kt=y.createContext({}),jn=e=>{const[t,o]=y.useState(null),[n,a]=y.useState(),i=En(),c=r.useCollection_deprecated(),{setCollectionFields:l}=y.useContext(r.FormBlockContext);return s.jsxs(Kt.Provider,{value:{onAddField(p){const F=J.cloneDeep(J.omit(p,["collectionFieldInterfaceManager"])),{properties:g}=F,b=g,{unique:d,type:u}=b,f=ne(b,["unique","type"]),h=ne(F,["properties"]);delete f.name["x-disabled"],o(w(m({},h),{properties:f}))},setCallback:a},children:[s.jsx(r.SchemaInitializerItems,w(m({},e),{items:i})),s.jsx(r.ActionContextProvider,{value:{visible:!!t},children:t?s.jsx(r.SchemaComponent,{schema:{type:"void",name:"drawer",title:'{{t("Configure field")}}',"x-decorator":"Form","x-component":"Action.Drawer",properties:w(m({},t.properties),{footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{type:"void",title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction(){const p=C.useForm();return{run(){return G(this,null,function*(){a(null),o(null),p.reset()})}}}}},submit:{type:"void",title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction(){const{values:p,query:d}=C.useForm(),u=[Ve("Field name existed in form")];return{run(){return G(this,null,function*(){var k,_,T,A;const{default:h}=t,F=D.uid();if(h.name=(k=p.name)!=null?k:F,h.uiSchema.title=(T=(_=p.uiSchema)==null?void 0:_.title)!=null?T:F,h.interface=t.name,(A=c.fields)==null?void 0:A.find(v=>v.name===h.name)){d("name").take().setFeedback({type:"error",messages:u});return}const b=D.merge(h,p);l([...c.fields,b]),n({name:h.name,type:h.uiSchema.type,"x-decorator":"FormItem","x-component":"CollectionField","x-component-props":{field:b},"x-collection-field":`${c.name}.${h.name}`,"x-toolbar":"FormItemSchemaToolbar","x-settings":"fieldSettings:FormItem"}),a(null),o(null)})}}}}}}}})},components:{ArrayTable:ue.ArrayTable}}):null})]})},zn=new r.SchemaInitializer({name:"AddCustomFormField_Audit",wrap:r.gridRowColWrap,insertPosition:"beforeEnd",title:"{{t('Configure fields')}}",ItemsComponent:jn});function Vn(){const e=r.useSchemaInitializerItem(),{insert:t,setVisible:o}=r.useSchemaInitializer(),{onAddField:n,setCallback:a}=y.useContext(Kt),{getInterface:i}=r.useCollectionManager_deprecated(),c=i(e.fieldInterface);return s.jsx(r.SchemaInitializerItem,m({onClick:()=>{a(()=>t),n(c),o(!1)}},e),e.fieldInterface)}const qt={title:`{{t("Custom form", { ns: "${S}" })}}`,config:{useInitializer(){return{name:"customForm",type:"item",title:`{{t("Custom form", { ns: "${S}" })}}`,Component:Pn}},initializers:{},components:{CustomFormBlockProvider:Ht},parseFormOptions(e){const t={};return Q(e,n=>n["x-decorator"]==="CustomFormBlockProvider").forEach(n=>{var p,d;const[a]=Object.keys(n.properties),i=n.properties[a],c=Q(i.properties.grid,u=>u["x-component"]==="CollectionField",!0);n["x-decorator-props"].collection.fields=c.map(u=>{var f,h;return(h=(f=u["x-component-props"])==null?void 0:f.field)!=null?h:u["x-interface-options"]});const l=((p=Object.entries(i.properties).find(([u,f])=>f["x-component"]==="ActionBar"))==null?void 0:p[0])||"actions";t[a]={type:"custom",title:((d=n["x-component-props"])==null?void 0:d.title)||a,actions:Q(i.properties[l],u=>u["x-component"]==="Action").map(u=>{var f,h;return{status:u["x-decorator-props"].value,values:(h=(f=u["x-action-settings"])==null?void 0:f.assignedValues)==null?void 0:h.values,key:u.name,title:u.title}}),collection:n["x-decorator-props"].collection}}),t}},block:{scope:{},components:{CustomFormBlockProvider:Ht}}},W=new D.Registry;W.register("custom",qt),W.register("create",$n),W.register("update",_n);var fe=(e=>(e.audit="Approve",e.message="Message",e))(fe||{});function Ln(){const{workflow:e}=x.useFlowContext(),t=x.useTrigger();return t.useInitializers?t.useInitializers(e.config):null}const Un={customForm:qt.title,record:`{{t("Data record", { ns: "${S}" })}}`};function Gn(){var n,a;const e=C.useFieldSchema(),t=(a=Un[(n=e["x-designer-props"])==null?void 0:n.type])!=null?a:'{{t("Block")}}',o=r.useCompile();return s.jsxs(r.GeneralSchemaDesigner,{title:o(t),children:[s.jsx(r.SchemaSettingsBlockTitleItem,{}),s.jsx(r.SchemaSettingsDivider,{}),s.jsx(r.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})}const Hn=new r.SchemaInitializer({name:"AddBlockButton_AuditCard",wrap:r.gridRowColWrap,title:'{{t("Add block")}}',style:{margin:"24px"},items:[{type:"itemGroup",name:"dataBlocks",title:'{{t("Data blocks")}}',hideIfNoChildren:!0,useChildren(){const e=r.usePlugin(x),t=x.useNodeContext(),o=x.useAvailableUpstreams(t),n=[Ln()].filter(Boolean),a=o.map(c=>{var p;const l=e.instructions.get(c.type);return(p=l==null?void 0:l.useInitializers)==null?void 0:p.call(l,c)}).filter(Boolean);return[...n,...a.length?[{name:"nodes",type:"subMenu",title:`{{t("Node result", { ns: "${S}" })}}`,children:a}]:[]].filter(Boolean)}},{type:"itemGroup",name:"form",title:'{{t("Form")}}',useChildren(){const e=r.useDataSourceManager(),t=x.useNodeContext(),o=e.getAllCollections();return Array.from(W.getValues()).map(n=>{const{useInitializer:a}=n.config;return a({allCollections:o,currentNode:t})})}},{type:"itemGroup",name:"otherBlocks",title:'{{t("Other blocks")}}',children:[{name:"markdown",title:'{{t("Markdown")}}',Component:"MarkdownBlockInitializer"}]}]});function Jn(){var k,_,T;const e=y.useContext(r.SchemaComponentContext),{t}=V.useTranslation(),o=C.useFieldSchema(),n=x.useWorkflowVariableOptions(),[a,i]=y.useState(!1),[c,l]=y.useState((T=(_=(k=o==null?void 0:o["x-action-settings"])==null?void 0:k.assignedValues)==null?void 0:_.schema)!=null?T:{type:"void","x-component":"Grid","x-initializer":"CustomFormItemInitializers",properties:{}}),[p,d]=y.useState(null),{components:u}=r.useSchemaOptionsContext();y.useEffect(()=>{d(new C.Schema({properties:{grid:c}}))},[c]);const f=y.useMemo(()=>{var v,I;const A=(I=(v=o==null?void 0:o["x-action-settings"])==null?void 0:v.assignedValues)==null?void 0:I.values;return _e.createForm({initialValues:D.lodash.cloneDeep(A),values:D.lodash.cloneDeep(A)})},[o]),h=r.useFormActiveFields(),F=t("Assign field values");function g(){i(!1)}function b(){o["x-action-settings"]||(o["x-action-settings"]={}),o["x-action-settings"].assignedValues||(o["x-action-settings"].assignedValues={}),o["x-action-settings"].assignedValues.schema=c,o["x-action-settings"].assignedValues.values=f.values,i(!1),setTimeout(()=>{var A;(A=e.refresh)==null||A.call(e)},300)}return s.jsxs(s.Fragment,{children:[s.jsx(r.SchemaSettingsItem,{title:F,onClick:()=>i(!0),children:F}),s.jsx(N.Modal,{width:"50%",title:F,open:a,onCancel:g,footer:s.jsxs(N.Space,{children:[s.jsx(N.Button,{onClick:g,children:t("Cancel")}),s.jsx(N.Button,{type:"primary",onClick:b,children:t("Submit")})]}),children:s.jsx(r.DefaultValueProvider,{isAllowToSetDefaultValue:()=>!1,children:s.jsx(r.VariableScopeProvider,{scope:n,children:s.jsx(r.FormActiveFieldsProvider,{name:"form",getActiveFieldsName:h==null?void 0:h.getActiveFieldsName,children:s.jsx(C.FormProvider,{form:f,children:s.jsxs(ue.FormLayout,{layout:"vertical",children:[s.jsx(N.Alert,{message:Ve("Values preset in this form will override user submitted ones when continue or reject.")}),s.jsx("br",{}),a&&p&&s.jsx(r.SchemaComponentContext.Provider,{value:w(m({},e),{refresh(){l(D.lodash.get(p.toJSON(),"properties.grid"))}}),children:s.jsx(r.SchemaComponent,{schema:p,components:u})})]})})})})})})]})}function Kn(e){const{name:t}=r.useCollection();return s.jsxs(r.GeneralSchemaDesigner,w(m({},e),{disableInitializer:!0,children:[s.jsx(r.Action.Designer.ButtonEditor,{}),s.jsx(r.WorkflowConfig,{}),s.jsx(Jn,{}),s.jsx(r.SchemaSettingsLinkageRules,{collectionName:t}),s.jsx(r.SecondConFirm,{}),s.jsx(r.AfterSuccess,{}),s.jsx(r.AfterFailure,{}),s.jsx(r.SchemaSettingsDivider,{}),s.jsx(r.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"ActionBar"}})]}))}const qn={item:r.SchemaInitializerItem,switch:r.InitializerWithSwitch},De=({type:e="item",designer:t="ManualActionDesigner"})=>{const o=qn[e];return()=>{const n=r.useSchemaInitializerItem(),h=n,{action:a,actionProps:i}=h,c=ne(h,["action","actionProps"]),l=C.useFieldSchema(),{actionProps:p}=l["x-initializer-props"]||{},{insert:d}=r.useSchemaInitializer(),u={type:"void",title:c.title,"x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:a},"x-component":"Action","x-component-props":m(m({},i),p),"x-designer":t,"x-action":`${a}`,"x-action-settings":{triggerWorkflows:[],assignedValues:{}}},f=e==="item"?{onClick(){d(u)}}:{schema:u};return s.jsx(o,m(w(m({},c),{item:n,type:"x-action"}),f))}},Zn=new r.SchemaInitializer({name:"AddActionButton_AuditCard",title:'{{t("Configure actions")}}',items:[{name:"jobStatusResolved",title:`{{t("Approve", { ns: "${S}" })}}`,Component:De({type:"item"}),action:x.JOB_STATUS.RESOLVED,actionProps:{type:"primary",useAction:"{{ useSubmit }}"}},{name:"jobStatusRejected",title:`{{t("Reject", { ns: "${S}" })}}`,Component:De({type:"switch"}),action:x.JOB_STATUS.REJECTED,actionProps:{useAction:"{{ useSubmit }}"}},{name:"jobStatusPending",title:`{{t("Save temporarily", { ns: "${S}" })}}`,Component:De({type:"switch"}),action:x.JOB_STATUS.PENDING,actionProps:{useAction:"{{ useSubmit }}"}},{name:"jobStatusAborted",title:`{{t("Archive", { ns: "${S}" })}}`,Component:De({type:"switch"}),action:x.JOB_STATUS.ABORTED,actionProps:{useAction:"{{ useSubmit }}"}},{name:"jobPullBack",title:`{{t("Pull Back", { ns: "${S}" })}}`,Component:De({type:"switch"}),action:x.JOB_STATUS.PULL_BACK,actionProps:{useAction:"{{ useSubmit }}"}}]});function Zt(){return{run(){}}}function Yt(e){const{value:t,onChange:o}=e,{token:n}=r.useToken(),a=r.usePlugin(x),i=y.useContext(r.SchemaComponentContext),c=x.useNodeContext(),l=(fe==null?void 0:fe[c.type])||"Approve",p=x.useAvailableUpstreams(c),d=C.useForm(),{workflow:u}=x.useFlowContext(),f={};p.forEach(k=>{const _=a.instructions.get(k.type);Object.assign(f,_.components)});const h=y.useMemo(()=>new C.Schema({properties:{drawer:{type:"void",title:`{{t("${l} Page", { ns: "${S}" })}}`,"x-decorator":"Form","x-component":"Action.Drawer","x-component-props":{className:r.css`
                .ant-drawer-body {
                  background: ${n.xwColorPageBg};
                }
              `},properties:{card:Object.keys(t||{}).length?t:{type:"void",title:u.title,"x-decorator":"Form","x-component":"AuditCard.Item","x-component-props":{title:u.title,subtitle:c.title},"x-designer":"AuditCard.Designer",properties:{grid:{type:"void","x-component":"Grid","x-initializer":"AddBlockButton_AuditCard"}}}}}}}),[]),F=y.useCallback(function(){const{card:_}=D.lodash.get(h.toJSON(),"properties.drawer.properties"),T=Array.from(W.getValues()).reduce((A,v)=>Object.assign(A,v.config.parseFormOptions(_)),{});Object.assign(T,In(_)),d.setValuesIn("forms",T),o(_)},[d,o,h]),g=w(m(m(m({},i.components),f),Array.from(W.getValues()).reduce((k,_)=>Object.assign(k,_.config.components),{})),{FormBlockProvider:Ne,DetailsBlockProvider:x.DetailsBlockProvider,ManualActionStatusProvider(k){return k.children},ActionBarProvider(k){return k.children},SimpleDesigner:Gn,ManualActionDesigner:Kn}),b=w(m({},i.scope),{useSubmit:Zt,useApsGoNoticeEmailFormSubmit:Zt,useDetailsProps:r.useFormBlockContext,useDetailsBlockProps:r.useFormBlockContext});return s.jsx(r.SchemaComponentContext.Provider,{value:w(m({},i),{designable:!u.executed,refresh:F,components:g,scope:b}),children:s.jsx(r.SchemaComponent,{schema:h,components:g,scope:b})})}function Yn(e={}){for(const t of Object.values(e)){const o=W.get(t.type);if(o&&typeof o.validate=="function"){const n=o.validate(t);if(n)return n}}}const Xn=e=>{const{values:t}=C.useForm(),{t:o}=Be();return y.useCallback(a=>{if(!a){const i=Yn(t.forms);if(i){N.message.error({title:o("Validation failed"),content:o(i)});return}}e(a)},[t.forms])};function Xt(e){const{workflow:t}=x.useFlowContext(),[o,n]=y.useState(!1),a=x.useNodeContext(),i=(fe==null?void 0:fe[a.type])||"Approve",c=Xn(n);return s.jsxs(s.Fragment,{children:[s.jsx(N.Button,{type:"primary",onClick:()=>n(!0),disabled:!1,children:Ve(t.executed?`View ${i} Page`:`Configure ${i} Page`)}),s.jsx(r.ActionContextProvider,{value:{visible:o,setVisible:c,formValueChanged:!1},children:e.children})]})}var dt=new Map,He=new WeakMap,Qt=0,Qn=void 0;function Wn(e){return e?(He.has(e)||(Qt+=1,He.set(e,Qt.toString())),He.get(e)):"0"}function Rn(e){return Object.keys(e).sort().filter(t=>e[t]!==void 0).map(t=>`${t}_${t==="root"?Wn(e.root):e[t]}`).toString()}function er(e){const t=Rn(e);let o=dt.get(t);if(!o){const n=new Map;let a;const i=new IntersectionObserver(c=>{c.forEach(l=>{var p;const d=l.isIntersecting&&a.some(u=>l.intersectionRatio>=u);e.trackVisibility&&typeof l.isVisible=="undefined"&&(l.isVisible=d),(p=n.get(l.target))==null||p.forEach(u=>{u(d,l)})})},e);a=i.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),o={id:t,observer:i,elements:n},dt.set(t,o)}return o}function tr(e,t,o={},n=Qn){if(typeof window.IntersectionObserver=="undefined"&&n!==void 0){const p=e.getBoundingClientRect();return t(n,{isIntersecting:n,target:e,intersectionRatio:typeof o.threshold=="number"?o.threshold:0,time:0,boundingClientRect:p,intersectionRect:p,rootBounds:p}),()=>{}}const{id:a,observer:i,elements:c}=er(o),l=c.get(e)||[];return c.has(e)||c.set(e,l),l.push(t),i.observe(e),function(){l.splice(l.indexOf(t),1),l.length===0&&(c.delete(e),i.unobserve(e)),c.size===0&&(i.disconnect(),dt.delete(a))}}function or({threshold:e,delay:t,trackVisibility:o,rootMargin:n,root:a,triggerOnce:i,skip:c,initialInView:l,fallbackInView:p,onChange:d}={}){var u;const[f,h]=Oe.useState(null),F=Oe.useRef(),[g,b]=Oe.useState({inView:!!l,entry:void 0});F.current=d,Oe.useEffect(()=>{if(c||!f)return;let A;return A=tr(f,(v,I)=>{b({inView:v,entry:I}),F.current&&F.current(v,I),I.isIntersecting&&i&&A&&(A(),A=void 0)},{root:a,rootMargin:n,threshold:e,trackVisibility:o,delay:t},p),()=>{A&&A()}},[Array.isArray(e)?e.toString():e,f,a,n,i,c,o,p,t]);const k=(u=g.entry)==null?void 0:u.target,_=Oe.useRef();!f&&k&&!i&&!c&&_.current!==k&&(_.current=k,b({inView:!!l,entry:void 0}));const T=[h,g.inView,g.entry];return T.ref=T[0],T.inView=T[1],T.entry=T[2],T}function nr(e,t){if(e==null)return{};var o=rr(e,t),n,a;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],!(t.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function rr(e,t){if(e==null)return{};var o={},n=Object.keys(e),a,i;for(i=0;i<n.length;i++)a=n[i],!(t.indexOf(a)>=0)&&(o[a]=e[a]);return o}function Je(){return Je=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},Je.apply(this,arguments)}function Wt(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable})),o.push.apply(o,n)}return o}function $e(e){for(var t=1;t<arguments.length;t++){var o=arguments[t]!=null?arguments[t]:{};t%2?Wt(Object(o),!0).forEach(function(n){sr(e,n,o[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):Wt(Object(o)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))})}return e}function sr(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const ar={breakpointCols:void 0,className:void 0,columnClassName:void 0,children:void 0,columnAttrs:void 0,column:void 0},pt=2;class Rt extends y.Component{constructor(t){super(t),this.reCalculateColumnCount=this.reCalculateColumnCount.bind(this),this.reCalculateColumnCountDebounce=this.reCalculateColumnCountDebounce.bind(this);let o;this.props.breakpointCols&&this.props.breakpointCols.default?o=this.props.breakpointCols.default:o=parseInt(this.props.breakpointCols)||pt,this.state={columnCount:o}}componentDidMount(){this.reCalculateColumnCount(),window&&window.addEventListener("resize",this.reCalculateColumnCountDebounce)}componentDidUpdate(){this.reCalculateColumnCount()}componentWillUnmount(){window&&window.removeEventListener("resize",this.reCalculateColumnCountDebounce)}reCalculateColumnCountDebounce(){if(!window||!window.requestAnimationFrame){this.reCalculateColumnCount();return}window.cancelAnimationFrame&&window.cancelAnimationFrame(this._lastRecalculateAnimationFrame),this._lastRecalculateAnimationFrame=window.requestAnimationFrame(()=>{this.reCalculateColumnCount()})}reCalculateColumnCount(){const t=window&&window.innerWidth||1/0;let o=this.props.breakpointCols;typeof o!="object"&&(o={default:parseInt(o)||pt});let n=1/0,a=o.default||pt;for(let i in o){const c=parseInt(i);c>0&&t<=c&&c<n&&(n=c,a=o[i])}a=Math.max(1,parseInt(a)||1),this.state.columnCount!==a&&this.setState({columnCount:a})}itemsInColumns(){const t=this.state.columnCount,o=new Array(t),n=y.Children.toArray(this.props.children);for(let a=0;a<n.length;a++){const i=a%t;o[i]||(o[i]=[]),o[i].push(n[a])}return o}renderColumns(){const{column:t,columnAttrs:o={},columnClassName:n}=this.props,a=this.itemsInColumns(),i=`${100/a.length}%`;let c=n;c&&typeof c!="string"&&(this.logDeprecated('The property "columnClassName" requires a string'),typeof c=="undefined"&&(c="my-masonry-grid_column"));const l=$e($e($e({},t),o),{},{style:$e($e({},o.style),{},{width:i}),className:c});return a.map((p,d)=>y.createElement("div",Je({},l,{key:d}),p))}logDeprecated(t){console.error("[Masonry]",t)}render(){const t=this.props,{children:o,breakpointCols:n,columnClassName:a,columnAttrs:i,column:c,className:l}=t,p=nr(t,["children","breakpointCols","columnClassName","columnAttrs","column","className"]);let d=l;return typeof l!="string"&&(this.logDeprecated('The property "className" requires a string'),typeof l=="undefined"&&(d="my-masonry-grid")),y.createElement("div",Je({},p,{className:d}),this.renderColumns())}}Rt.defaultProps=ar;const eo=[12,24,60,96,120],ir={default:4,1600:3,992:2,768:1};var Ke=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function ut(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var to={exports:{}};/*!
	Copyright (c) 2018 Jed Watson.
	Licensed under the MIT License (MIT), see
	http://jedwatson.github.io/classnames
*/(function(e){(function(){var t={}.hasOwnProperty;function o(){for(var n=[],a=0;a<arguments.length;a++){var i=arguments[a];if(i){var c=typeof i;if(c==="string"||c==="number")n.push(i);else if(Array.isArray(i)){if(i.length){var l=o.apply(null,i);l&&n.push(l)}}else if(c==="object"){if(i.toString!==Object.prototype.toString&&!i.toString.toString().includes("[native code]")){n.push(i.toString());continue}for(var p in i)t.call(i,p)&&i[p]&&n.push(p)}}}return n.join(" ")}e.exports?(o.default=o,e.exports=o):window.classNames=o})()})(to);var cr=to.exports;const lr=ut(cr),dr=()=>s.jsx("svg",{width:"23",height:"22",viewBox:"0 0 23 22",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{d:"M18.3458 4H4.64302C4.01682 4 3.50112 4.50472 3.50112 5.1176V12.388V12.9888V14.6112V17.315C3.50112 17.315 3.452 18 4.00454 18C4.53251 18 6.39884 16.57 7.55302 15.7288H18.3581C18.9843 15.7288 19.5 15.224 19.5 14.6112V5.1176C19.4877 4.50472 18.972 4 18.3458 4ZM14.8219 9.64807C14.8219 9.66009 14.8219 9.6721 14.8219 9.68412C14.8219 9.69614 14.8219 9.70815 14.8096 9.73219C14.5149 11.2704 13.1397 12.4361 11.4944 12.4361C9.8491 12.4361 8.46163 11.2704 8.17923 9.73219C8.17923 9.72017 8.16695 9.70815 8.16695 9.68412C8.16695 9.6721 8.16695 9.66009 8.16695 9.64807C8.16695 9.63605 8.16695 9.63605 8.16695 9.62403C8.16695 9.39571 8.35113 9.21545 8.58442 9.21545C8.81771 9.21545 9.00189 9.39571 9.00189 9.62403C9.00189 9.63605 9.00189 9.63605 9.00189 9.64807C9.24746 10.7777 10.2789 11.6189 11.5067 11.6189C12.7346 11.6189 13.7537 10.7777 14.0115 9.64807C14.0115 9.63605 14.0115 9.63605 14.0115 9.62403C14.0115 9.39571 14.1957 9.21545 14.429 9.21545C14.6623 9.21545 14.8465 9.39571 14.8465 9.62403C14.8219 9.62403 14.8219 9.63605 14.8219 9.64807Z",fill:"white"})}),pr=()=>s.jsx(r.Icon,{component:dr}),ur=K.css`
  display: flex;
  width: 100%;
  height: 100%;
  flex-direction: column;
  justify-content: space-between;
  gap: 8px;
  position: relative;
  z-index: 3;

  .ant-formily-item-label {
    color: var(--xwColorCardListFormItemLabel);
    font-weight: 400;
    font-size: 13px;
  }

  .ant-formily-item-control-content {
    color: #000;
    font-size: 15px;
    font-weight: 500;
  }
`,mr=K.css`
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  height: 52px;
  padding-left: 15px;
  padding-top: 6px;
  font-family: Inter;
  color: #fff;
`,fr=K.css`
  font-size: 14px;
  font-weight: 600;
`,hr=K.css`
  font-size: 12px;
  font-weight: 400;
`,gr=e=>{const t=r.useDesigner(),o=C.useFieldSchema(),{workflow:n}=x.useFlowContext(),a=x.useNodeContext(),{showWorkflowTitle:i=!0,showNodeTitle:c=!0}=o["x-component-props"]||{},{token:l}=r.useToken();return s.jsxs("div",{className:lr("nb-block-item","noco-card-item",K.css`
          height: 100%;
          position: relative;
          &:hover {
            > .general-schema-designer {
              display: block;
            }
          }
          &.nb-form-item:hover {
            > .general-schema-designer {
              background: var(--colorBgSettingsHover) !important;
              border: 0 !important;
              top: -5px !important;
              bottom: -5px !important;
              left: -5px !important;
              right: -5px !important;
            }
          }
          > .general-schema-designer {
            position: absolute;
            z-index: 999;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            display: none;
            border: 2px solid var(--colorBorderSettingsHover);
            pointer-events: none;
            > .general-schema-designer-icons {
              position: absolute;
              right: 2px;
              top: 2px;
              line-height: 16px;
              pointer-events: all;
              .ant-space-item {
                background-color: var(--colorSettings);
                color: #fff;
                line-height: 16px;
                width: 16px;
                padding-left: 1px;
                align-self: stretch;
              }
            }
          }
        `),children:[s.jsx(t,m({},o["x-toolbar-props"])),s.jsxs(N.Card,{role:"button","aria-label":"grid-card-item",className:K.css`
          height: 100%;
          border: 2px solid rgba(0, 0, 0, 0);
          overflow: hidden;
          position: relative;
          ${CSS.supports("mask-composite","exclude")?`&:hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: ${l.borderRadiusBlock}px;
            padding: 2px;
            background: ${l.xwColorPrimary};
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
          }`:`&:hover {
            border: 2px solid ${l.colorPrimary};
          }`}

          > .ant-card-body {
            padding: 0 !important;
            height: 100%;
          }
          .nb-action-bar {
            padding: 5px 0;
          }

          .ant-card:not(.ant-card-bordered) {
            box-shadow: none;
          }

          .ant-card-body {
            background: ${l.xwColorPrimaryBackgroud};
            padding-bottom: 0px;
            .ant-card {
              background: transparent;
              .ant-card-head {
                background: transparent;
              }
              .ant-card-body {
                background: transparent;
              }
            }
          }
        `,children:[s.jsxs("div",{className:mr,style:{background:l.xwColorPrimary},children:[s.jsx("div",{style:{marginRight:"6px",paddingTop:"2px"},children:s.jsx(pr,{})}),s.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[i&&s.jsx("div",{className:fr,children:n.title}),c&&s.jsx("div",{className:hr,children:a.title})]})]}),s.jsx("div",{className:ur,onClick:p=>{var u;const d=p.target;((u=d==null?void 0:d.tagName)==null?void 0:u.toLowerCase())!=="div"&&p.stopPropagation()},children:e.children})]})]})},Cr=e=>{const t=`{{t("Audit Card", { ns: "${S}" })}}`,o=r.useCompile(),n=C.useField(),{dn:a}=r.useDesignable(),i=C.useFieldSchema(),{t:c}=V.useTranslation(),l=d=>{var u,f;return typeof((u=n.componentProps)==null?void 0:u[d])=="undefined"?!0:(f=n.componentProps)==null?void 0:f[d]},p=d=>u=>{const f=i["x-component-props"]||{};f[d]=u,i["x-component-props"]=f,n.componentProps[d]=u,a.emit("patch",{schema:{"x-uid":i["x-uid"],"x-component-props":i["x-component-props"]}}),a.refresh()};return s.jsxs(r.GeneralSchemaDesigner,{draggable:!1,title:o(t),children:[s.jsx(r.SchemaSettingsSwitchItem,{title:c("Show workflow title",{ns:S}),checked:l("showWorkflowTitle"),onChange:p("showWorkflowTitle")}),s.jsx(r.SchemaSettingsSwitchItem,{title:c("Show node title",{ns:S}),checked:l("showNodeTitle"),onChange:p("showNodeTitle")})]})},xr=r.genStyleHook("nb-grid-card",e=>{const{componentCls:t}=e;return{[t]:{"& > .nb-block-item":{marginBottom:e.marginLG,"& > .nb-action-bar:has(:first-child:not(:empty))":{padding:`${e.marginLG}px ${e.marginLG}px 0 ${e.marginLG}px`,background:e.colorBgContainer},".ant-list-pagination":{padding:e.marginLG,background:e.colorBgContainer}},".ant-formily-item-feedback-layout-loose":{marginBottom:e.marginSM}}}}),qe=y.createContext({});qe.displayName="AuditCardBlockContext";const yr=e=>{var p;const{resource:t,service:o}=r.useBlockRequestContext(),n=C.useField(),{wrapSSR:a,componentCls:i,hashId:c}=xr(),l=y.useMemo(()=>_e.createForm({readPretty:!0}),[]);return y.useEffect(()=>{var d;o!=null&&o.loading||l.setValuesIn(n.address.concat("auditCardList").toString(),(d=o==null?void 0:o.data)==null?void 0:d.data)},[(p=o==null?void 0:o.data)==null?void 0:p.data,o==null?void 0:o.loading]),a(s.jsx(qe.Provider,{value:{service:o,resource:t,columnCount:e.columnCount},children:s.jsx(C.FormContext.Provider,{value:l,children:s.jsx(ue.FormLayout,{layout:"vertical",children:s.jsx("div",{className:`${i} ${c}`,children:e.children})})})}))},oo=e=>{const{params:t}=e,{filter:o,parseVariableLoading:n}=r.useParsedFilter({filterOption:t==null?void 0:t.filter}),a=y.useMemo(()=>w(m({},t),{filter:o}),[o,t]);return n?null:s.jsx(r.BlockProvider,w(m({name:"audit-card"},e),{params:a,children:s.jsx(yr,m({},e))}))},no=()=>y.useContext(qe),br=()=>({}),Sr=r.css`
  position: relative;
  width: 100%;
  &:hover {
    > .general-schema-designer {
      display: block;
    }
  }

  > .general-schema-designer {
    position: absolute;
    z-index: 999;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    display: none;
    background: var(--colorBgSettingsHover);
    border: 0;
    pointer-events: none;
    > .general-schema-designer-icons {
      position: absolute;
      right: 2px;
      top: 2px;
      line-height: 16px;
      pointer-events: all;
      .ant-space-item {
        background-color: var(--colorSettings);
        color: #fff;
        line-height: 16px;
        width: 16px;
        padding-left: 1px;
        align-self: stretch;
      }
    }
  }
`,vr=r.css`
  > div {
    height: 100%;

    ${!D.isMobile&&`.ant-card-body .ant-card-body {
      .ant-card-head,
      .ant-card-body {
        padding: 0;
      }
    }`}
    > .ant-spin-nested-loading {
      height: 100%;

      > .ant-spin-container {
        height: 100%;

        > .ant-formily-layout {
          height: 100%;
        }
      }
    }
  }

  > .ant-spin-nested-loading {
    height: 100%;

    > .ant-spin-container {
      height: 100%;

      > .ant-formily-layout {
        height: 100%;
      }
    }
  }
`,wr=r.css`
  display: flex;
  width: auto;
`,ro=e=>{const{token:t}=r.useToken(),{basePath:o,name:n,schema:a}=e,{ref:i,inView:c}=or({threshold:1,initialInView:!1,triggerOnce:!0});return s.jsx(N.Col,{ref:i,className:vr,style:{marginBottom:D.isMobile?t.margin:t.marginLG,marginLeft:D.isMobile?t.margin:t.marginLG},children:c||D.isMobile?s.jsx(C.RecursionField,{basePath:o,name:n,onlyRenderProperties:!0,schema:a}):s.jsx(N.Skeleton,{paragraph:{rows:4},active:!0})})},Pe=e=>{var F;const{token:t}=r.useToken(),{service:o}=no(),{run:n,params:a}=o,i=(F=o==null?void 0:o.data)==null?void 0:F.meta,c=r.useDesigner(),l=C.useFieldSchema(),p=C.useField(),[d]=y.useState(new Map),{asswipe:u}=e,f=y.useCallback(g=>(d.has(g)||d.set(g,new C.Schema({type:"object",properties:{[g]:m({},l.properties.item)}})),d.get(g)),[l.properties,d]),h=y.useCallback((g,b)=>{n(w(m({},a==null?void 0:a[0]),{page:g,pageSize:b}))},[n,a]);return s.jsx(r.SchemaComponentOptions,{scope:{useAuditCardItemProps:br},children:s.jsx(N.Spin,{spinning:o.loading,children:s.jsx(r.SortableItem,{className:r.cx("nb-card-list",Sr),style:{paddingTop:D.isMobile?t.padding:t.paddingLG,paddingBottom:D.isMobile?t.padding:t.paddingLG,paddingRight:D.isMobile?t.padding:t.paddingLG},children:u&&D.isMobile?s.jsx(r.XSwiper,{field:p,service:o,children:s.jsx(ro,{schema:f})}):s.jsxs(s.Fragment,{children:[s.jsx(Rt,{breakpointCols:ir,className:wr,children:p.value.map((g,b)=>s.jsx(ro,{basePath:p.address,name:b,schema:f(b)},g.id))}),!i||i.count<=i.pageSize?null:s.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:s.jsx(N.Pagination,{onChange:h,total:(i==null?void 0:i.count)||0,pageSize:(i==null?void 0:i.pageSize)||10,current:(i==null?void 0:i.page)||1,pageSizeOptions:eo})}),!(i!=null&&i.count)&&!(o!=null&&o.loading)&&s.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:s.jsx(r.Empty,{})}),s.jsx(c,{})]})})})})};Pe.Item=gr,Pe.Designer=Cr,Pe.Decorator=oo;const mt=r.css`
  margin: 10px 0 5px 0;
  text-align: center;
  cursor: pointer;
`,so=r.css`
  font-size: 16px;
  color: #9ca3af;
`,Fr=e=>Q(e,o=>{var n,a;return o["x-component"]==="CollectionField"&&(((n=o["x-data"])==null?void 0:n.showOnCover)===!0||((a=o.parent["x-data"])==null?void 0:a.showOnCover)===!0)}),ao="WorkflowComment",Ze="AuditCardFormCollapseController",Ar=[ao,Ze,"Grid","Iframe"],ft=y.createContext(null);ft.displayName="AuditCardFormContext";const Ir=e=>Q(e,o=>{var n,a,i;return["CollectionField","Markdown.Void","MarkdownVditor.Void","Action.Link"].includes(o["x-component"])?o.parent["x-component"]==="TableV2.Column"?((n=o.parent["x-data"])==null?void 0:n.showOnCover)!==!0:(((a=o["x-data"])==null?void 0:a.showOnCover)!==!0?o["x-use-decorator-props"]="useShowFieldOnCover":delete o["x-use-decorator-props"],((i=o["x-data"])==null?void 0:i.showOnCover)!==!0):o.parent&&!o.properties&&!Ar.includes(o["x-component"])?!0:!!(o.properties&&o.properties.todoStatus)}),Tr=e=>{const t=Q(e,n=>n["x-component"]===ao),o=t.length;if(o>0){const n=t[o-1],a=n.parent,c=Object.keys(a.properties).length;a.addProperty("controller",{type:"void","x-component":Ze,"x-component-props":{className:mt},"x-index":c+1,"x-use-component-props":"useAuditCardFormCollapseControllerProps"}),n["x-index"]=c+2}else e.addProperty("controller",{type:"void","x-component":Ze,"x-component-props":{className:mt},"x-index":Object.keys(e.properties).length+1,"x-use-component-props":"useAuditCardFormCollapseControllerProps"})},kr=e=>{Q(e,o=>o["x-component"]===Ze).forEach(o=>{o.parent.removeProperty(o.name)})},_r=r.withDynamicSchemaProps(e=>{const{getCollapsed:t,setCollapsed:o}=e,n=t();return s.jsx("div",{className:mt,onClick:()=>{o(!n)},children:n?s.jsx(ae.DownOutlined,{className:so}):s.jsx(ae.UpOutlined,{className:so})})}),io=e=>{const t=r.useSchemaComponentContext(),o=y.useRef(null),n=C.useFieldSchema(),{render:a}=r.useSchemaInitializerRender(n["x-initializer"]);C.useField();const c=Fr(n).length>0&&t.designable===!1,[l,p]=y.useState(c),d=y.useRef(l);d.current=l,c?Tr(n):kr(n);const u=F=>{p(F)},f=()=>({getCollapsed:()=>d.current,setCollapsed:u}),h=()=>{const{collapsed:F}=y.useContext(ft);return F?{className:r.css`
            position: absolute;
            z-index: -1;
            opacity: 0;
          `}:{}};return Ir(n),s.jsx("div",{ref:o,children:s.jsxs(ft.Provider,{value:{collapsed:l},children:[s.jsx(r.SchemaComponent,{components:{AuditCardFormCollapseController:_r},scope:{useAuditCardFormCollapseControllerProps:f,useShowFieldOnCover:h},schema:n}),a()]})})},co=r.createStyles(({css:e})=>({auditNodeAuditInfoWrapClass:e`
      margin-top: 5px;
      color: red;
    `,mobileModalMessageCss:e`
      .ant-modal-content {
        padding: 0;
        font-family: Inter;
      }

      .ant-modal-confirm-paragraph {
        width: 100%;
        max-width: 100%;
        padding: 30px 16px 22px 16px;

        box-shadow: 0px -0.5px 0px 0px #e5e6eb inset;

        .ant-modal-confirm-title {
          text-align: center;
          font-size: 15px;
          font-weight: 700;
          color: #1d2129;
        }

        .ant-modal-confirm-content {
          color: #4e5969;
          font-size: 14px;
          line-height: 22px;
        }
      }

      .ant-modal-confirm-btns {
        text-align: center;
        margin: 10px 0 14px 0;
      }
    `})),Or=100,Br=100,lo=28,Nr=95,Dr={100:0,90:10,80:20,70:40,60:60,50:100,40:140,30:220,20:380,10:850};let Ye=[];const ht={};function $r(){const e=y.useRef(),t=y.useRef(),{zoom:o}=x.useCanvasZoomContext();y.useLayoutEffect(()=>{const a=document.getElementById("svg-wrapper");e.current=a,t.current=a.parentElement},[]);const n=y.useCallback(J.debounce(()=>{const a=t.current.scrollTop;e.current.style.transform="translate("+(lo+pageXOffset)*-1+"px, "+(lo+Nr-a+pageYOffset+(Dr[o]||0))*-1+"px)",setTimeout(()=>{Ye.forEach(i=>{i.position()})},Br)},Or),[o]);return{fixPosition:n,addLine:(a,i)=>G(this,null,function*(){try{const{LeaderLine:c}=yield D.loadPackage("leader-line"),l=new c(c.mouseHoverAnchor({element:a,style:{backgroundColor:null,backgroundImage:"none",padding:0},hoverStyle:{backgroundColor:null},showEffectName:"none"}),i,{dash:!0,middleLabel:"Reject to",startPlug:"square",endPlug:"arrow3",size:2,path:"grid",startSocket:"left",endSocket:"left",hide:!0,color:"red"});n(),Ye.push(l);const p=document.querySelector("body>.leader-line:last-of-type");return ht[l._id]=p,e.current.appendChild(p),l}catch(c){D.captureException(c)}return null}),removeLine(a){a&&(document.body.appendChild(ht[a._id]),a.remove(),Ye=Ye.filter(i=>i!==a),delete ht[a._id])}}}const Pr=()=>{const e=C.useForm(),{t}=V.useTranslation(),{styles:o}=co(),{nodes:n}=x.useFlowContext(),a=e.getValuesIn("returnNodeId"),i=n.find(c=>c.id===a);return i?s.jsxs("div",{className:o.auditNodeAuditInfoWrapClass,children:[s.jsxs("span",{children:[" ",t("Reject to",{ns:S}),":"]}),s.jsx("span",{children:`#${i.id}_${i.title}`})]}):null};class Mr extends x.Instruction{constructor(){super(...arguments);le(this,"title",`{{t("Audit", { ns: "${S}" })}}`);le(this,"type","audit");le(this,"group","manual");le(this,"description",`{{t("Could be used for manually submitting data, and determine whether to continue or exit. Workflow will generate a todo item for assigned user when it reaches a audit node, and continue processing after user submits the form.", { ns: "${S}" })}}`);le(this,"icon",s.jsx(ae.SolutionOutlined,{}));le(this,"fieldset",{assignees:{type:"array",title:`{{t("Assignees", { ns: "${S}" })}}`,"x-decorator":"FormItem","x-component":"AssigneesSelect","x-component-props":{},required:!0,default:[]},nodeTag:{type:"string",title:`{{t("Node Tag", { ns: "${S}" })}}`,"x-decorator":"FormItem","x-component":"NodeTagSelect","x-component-props":{}},returnNodeId:{type:"number",title:`{{t("Reject to", { ns: "${S}" })}}`,"x-decorator":"FormItem","x-component":"RejectToSelect","x-component-props":{className:"auto-width"},"x-validator":"{{ auditReturnNodeIdValidator }}"},negotiationMode:{type:"number",title:`{{t("Negotiation", { ns: "${S}" })}}`,"x-decorator":"FormItem","x-component":"RadioWithTooltip","x-component-props":{options:[{label:`{{t("Any pass", { ns: "${S}" })}}`,value:Ge.OR,tooltip:`{{t("Anyone pass", { ns: "${S}" })}}`},{label:`{{t("Advanced any pass", { ns: "${S}" })}}`,value:Ge.ADVANCED_OR,tooltip:`{{t("Anyone pass, The remaining people can continue to approve", { ns: "${S}" })}}`}]},default:Ge.OR},cardSchema:{type:"void",title:`{{t("Approve Page", { ns: "${S}" })}}`,"x-decorator":"FormItem","x-decorator-props":{asterisk:!0},"x-component":"CardSchemaConfigButton",required:!0,properties:{cardSchema:{type:"object","x-component":"CardSchemaConfig",default:null}}},forms:{type:"object",default:{}}});le(this,"components",{AuditCard:Pe,AuditCardFormCollapse:io,CardSchemaConfig:Yt,CardSchemaConfigButton:Xt,AssigneesSelect:Pt,RejectToSelect:vn,NodeTagSelect:An,RadioWithTooltip:x.RadioWithTooltip});le(this,"view",{type:"void","x-component":Pr})}Component({data:o}){const n=y.useRef(),{nodes:a}=x.useFlowContext(),{zoom:i}=x.useCanvasZoomContext(),c=o.config.returnNodeId,{addLine:l,removeLine:p,fixPosition:d}=$r();return y.useLayoutEffect(()=>{const u=document.getElementById(`workflow-node-id-${o.id}`),f=document.getElementById(`workflow-node-id-${c}`);return u&&f&&G(this,null,function*(){try{n.current=yield l(u,f)}catch(h){console.error("Failed to create leader line:",h)}}),()=>{n.current&&(p(n.current),n.current=null)}},[o.id,c]),y.useEffect(()=>{const u=document.getElementById(`workflow-node-id-${c}`);n.current&&(u?d():(p(n.current),n.current=null))},[a.length,c]),y.useEffect(()=>{n.current&&d()},[i]),s.jsx(x.NodeDefaultView,{data:o})}useValidator(){const o=x.useNodeContext(),a=x.useAvailableUpstreams(o,i=>i.type==="audit").map(i=>({label:`#${i.id}_${i.title}`,value:i.id}));return{auditReturnNodeIdValidator:i=>!i||a.find(c=>c.value===i)?"":"invalid return node"}}useVariables({key:o,title:n,config:a},{types:i,fieldNames:c=x.defaultFieldNames}){var h,F;const l=r.useCompile(),{getCollectionFields:p}=r.useCollectionManager_deprecated(),d=Object.keys((h=a.forms)!=null?h:{});if(!d.length)return null;const u=d.map(g=>{var T;const b=a.forms[g],k=x.getCollectionFieldOptions({fields:(T=b.collection)==null?void 0:T.fields,collection:b.collection,types:i,compile:l,getCollectionFields:p}),_=l(b.title)||g;return k.length?{key:g,value:g,label:_,title:_,children:k}:null}).filter(Boolean),f={key:"_",value:"_",type:"operation",label:"operation",title:"operation",childs:(((F=a==null?void 0:a.forms[d[0]])==null?void 0:F.actions)||[]).filter(g=>g.status===x.JOB_STATUS.RESOLVED).map(g=>w(m({},g),{value:g.key,label:l(g.title),title:l(g.title)}))};return u.length?{[c.value]:o,[c.label]:n,[c.children]:[...u,f],type:this.type}:null}useInitializers(o){var c;const{getCollection:n}=r.useCollectionManager_deprecated(),a=Object.keys((c=o.config.forms)!=null?c:{}).filter(l=>!["apsGoNoticeForm"].includes(l));if(!a.length||o.config.mode)return null;const i=a.map(l=>{var u,f;const p=o.config.forms[l],{fields:d=[]}=n(p.collection);return d.length?{name:(u=p.title)!=null?u:l,type:"item",title:(f=p.title)!=null?f:l,Component:x.CollectionBlockInitializer,cardItemClassName:r.css`
                box-shadow: none !important;
                > .ant-card-body {
                  padding: 24px;
                }
              `,collection:p.collection,dataSource:`{{$jobsMapByNodeKey.${o.key}.${l}}}`}:null}).filter(Boolean);return i.length?{name:`#${o.id}`,key:"forms",type:"subMenu",title:o.title,children:i}:null}isAvailable({engine:o,workflow:n}){return!o.isWorkflowSync(n)}}const Er=(e,t,o)=>e!==x.JOB_STATUS.PULL_BACK&&o.status===x.JOB_STATUS.RESOLVED&&[x.EXECUTION_STATUS.RESOLVED,x.EXECUTION_STATUS.STARTED].includes(t.status),po=(e,t,o,n)=>Ut(e.status)?t.status===x.JOB_STATUS.PENDING||t.status===x.JOB_STATUS.RESOLVED&&o.status===x.JOB_STATUS.PENDING&&n.config.negotiationMode===Ge.ADVANCED_OR:!1,uo=y.createContext(null);uo.displayName="ManualActionStatusContext";function Xe({value:e,children:t}){const o=C.useField(),n=C.useFieldSchema(),a=n["x-decorator-props"].value,{node:i,userJob:c,execution:l,status:p}=x.useFlowContext(),d=Er(p,l,c.job),u=po(l,c.job,c,i);return y.useEffect(()=>{a===x.JOB_STATUS.PULL_BACK?o.visible=d:o.visible=u},[l,c,e,o,n.name]),s.jsx(uo.Provider,{value:e,children:t})}function Qe(e){var a;const{data:t}=r.useCurrentUserContext(),{userJob:o}=x.useFlowContext(),{userId:n}=o;return((a=t==null?void 0:t.data)==null?void 0:a.id)!==n?null:e.children}const jr=()=>s.jsxs("svg",{width:"156",height:"119",viewBox:"0 0 156 119",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[s.jsx("path",{opacity:"0.5",d:"M77.9297 118.703C120.969 118.703 155.859 103.75 155.859 85.3047C155.859 66.8592 120.969 51.9062 77.9297 51.9062C34.8903 51.9062 0 66.8592 0 85.3047C0 103.75 34.8903 118.703 77.9297 118.703Z",fill:"url(#paint0_linear_10_2224)"}),s.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M124.344 65.8676C127.709 66.8318 133.299 57.6781 137.739 43.2454C142.179 28.8128 142.477 19.3816 139.112 18.4174C135.747 17.4533 125.598 25.8169 121.713 39.3579C117.827 52.899 120.979 64.9034 124.344 65.8676Z",fill:"url(#paint1_linear_10_2224)"}),s.jsxs("g",{opacity:"0.8",children:[s.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M136.109 25.1609C130.945 33.6115 127.624 40.3959 126.144 45.5143C124.665 50.6327 124.065 57.4171 124.344 65.8677",fill:"url(#paint2_linear_10_2224)"}),s.jsx("path",{d:"M136.109 25.1609C130.945 33.6115 127.624 40.3959 126.144 45.5143C124.665 50.6327 124.065 57.4171 124.344 65.8677",stroke:"white",strokeWidth:"2"})]}),s.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M124.344 65.8676C122.356 64.5274 126.001 59.4664 132.81 51.7338C139.618 44.0013 143.363 42.661 145.352 44.0013C147.34 45.3415 146.239 52.9471 140.49 59.6001C134.741 66.2531 126.333 67.2078 124.344 65.8676Z",fill:"url(#paint3_linear_10_2224)"}),s.jsxs("g",{opacity:"0.8",children:[s.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M141.359 50.5674C139.098 54.0456 136.602 57.1932 133.871 60.0101C131.139 62.8269 128.218 64.7795 125.108 65.8677",fill:"url(#paint4_linear_10_2224)"}),s.jsx("path",{d:"M141.359 50.5674C139.098 54.0456 136.602 57.1932 133.871 60.0101C131.139 62.8269 128.218 64.7795 125.108 65.8677",stroke:"white",strokeWidth:"2"})]}),s.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M31.8018 76.502C30.2821 76.942 27.7577 72.7647 25.7525 66.1784C23.7473 59.592 23.613 55.2881 25.1327 54.8481C26.6524 54.4081 31.2354 58.2248 32.9903 64.4043C34.7451 70.5837 33.3215 76.0619 31.8018 76.502Z",fill:"url(#paint5_linear_10_2224)"}),s.jsx("path",{opacity:"0.8",d:"M26.4885 57.9255C28.8207 61.782 30.3208 64.878 30.9889 67.2138C31.657 69.5496 31.9279 72.6457 31.8018 76.5021",stroke:"white"}),s.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M31.8018 76.502C32.6998 75.8904 31.0535 73.5808 27.9787 70.0521C24.9039 66.5233 23.2126 65.9117 22.3146 66.5233C21.4166 67.1349 21.914 70.6057 24.5102 73.6418C27.1063 76.6779 30.9038 77.1136 31.8018 76.502Z",fill:"url(#paint6_linear_10_2224)"}),s.jsx("path",{opacity:"0.8",d:"M24.1178 69.5198C25.1386 71.1071 26.2659 72.5435 27.4996 73.8289C28.7333 75.1144 30.0523 76.0055 31.4568 76.5021",stroke:"white"}),s.jsx("path",{d:"M73.2021 51.134C69.9186 54.4175 69.9186 59.5507 73.2021 62.8342C76.4857 66.1178 81.6188 66.1178 84.9023 62.8342C88.1859 59.5507 88.1859 54.4175 84.9023 51.134C81.411 47.84 76.2778 47.84 73.2021 51.134ZM54.4098 33.0321C52.0349 35.1329 52.0624 38.7432 54.1462 41.1331C56.6725 44.0306 61.16 43.9516 64.3219 41.7652C73.3858 35.4975 84.935 35.5012 93.996 41.7762C97.1479 43.959 101.623 44.0375 104.143 41.1478C106.231 38.7532 106.246 35.1334 103.857 33.0392C89.2105 20.2003 68.9184 20.198 54.4098 33.0321ZM39.8595 16.224C37.5118 18.4683 37.5278 22.152 39.6659 24.5967C42.2505 27.5518 46.8347 27.5061 49.8032 24.9367C67.1048 9.96145 90.987 9.95855 108.291 24.928C111.266 27.5012 115.858 27.5471 118.447 24.5866C120.583 22.1452 120.607 18.4682 118.27 16.219C95.7981 -5.40801 62.487 -5.40635 39.8595 16.224Z",fill:"url(#paint7_linear_10_2224)"}),s.jsxs("defs",{children:[s.jsxs("linearGradient",{id:"paint0_linear_10_2224",x1:"77.9297",y1:"51.9062",x2:"77.9297",y2:"94.0401",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FF5C00",stopOpacity:"0.397332"}),s.jsx("stop",{offset:"0.645833",stopColor:"#FF5C00",stopOpacity:"0.0661698"}),s.jsx("stop",{offset:"1",stopColor:"#FF5C00",stopOpacity:"0"})]}),s.jsxs("linearGradient",{id:"paint1_linear_10_2224",x1:"135.253",y1:"18.7466",x2:"125.097",y2:"61.6861",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FFF5F1"}),s.jsx("stop",{offset:"1",stopColor:"#FFC6AD"})]}),s.jsxs("linearGradient",{id:"paint2_linear_10_2224",x1:"129.536",y1:"26.2916",x2:"131.476",y2:"62.38",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FFF5F1"}),s.jsx("stop",{offset:"1",stopColor:"#FFC6AD"})]}),s.jsxs("linearGradient",{id:"paint3_linear_10_2224",x1:"144.546",y1:"44.4591",x2:"128.855",y2:"65.8661",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FFF5F1"}),s.jsx("stop",{offset:"1",stopColor:"#FFC6AD"})]}),s.jsxs("linearGradient",{id:"paint4_linear_10_2224",x1:"132.331",y1:"50.9924",x2:"132.531",y2:"64.593",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FFF5F1"}),s.jsx("stop",{offset:"1",stopColor:"#FFC6AD"})]}),s.jsxs("linearGradient",{id:"paint5_linear_10_2224",x1:"26.85",y1:"55.0103",x2:"31.472",y2:"74.5907",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FFF5F1"}),s.jsx("stop",{offset:"1",stopColor:"#FFC6AD"})]}),s.jsxs("linearGradient",{id:"paint6_linear_10_2224",x1:"22.6477",y1:"66.7536",x2:"29.7821",y2:"76.4804",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FFF5F1"}),s.jsx("stop",{offset:"1",stopColor:"#FFC6AD"})]}),s.jsxs("linearGradient",{id:"paint7_linear_10_2224",x1:"74.2608",y1:"1.8138",x2:"74.9475",y2:"59.8615",gradientUnits:"userSpaceOnUse",children:[s.jsx("stop",{stopColor:"#FF6D2F"}),s.jsx("stop",{offset:"1",stopColor:"#FA9D75"})]})]})]}),zr=()=>s.jsx(r.Icon,{component:jr}),mo=()=>{var l;const e=C.useFieldSchema(),t=((l=e==null?void 0:e["x-component-props"])==null?void 0:l.needFilterFields)||[],o=t.length>0,{getCollectionFields:n,getInterface:a}=r.useCollectionManager_deprecated(),i=(p,d,u)=>{var k,_;if(o&&(p==="audits_jobs"&&!t.includes(d.name)||p!=="audits_jobs"&&!t.includes(`${p}.${d.name}`))||!d.interface)return;const f=a(d.interface);if(!(f!=null&&f.filterable))return;const{nested:h,children:F,operators:g}=f.filterable,b={name:d.name,type:d.type,target:d.target,title:((k=d==null?void 0:d.uiSchema)==null?void 0:k.title)||d.name,schema:d==null?void 0:d.uiSchema,interface:d.interface,operators:((_=g==null?void 0:g.filter)==null?void 0:_.call(g,T=>!(T!=null&&T.visible)||T.visible(d)))||[]};if(!(d.target&&u>2)){if(u>2)return b;if(F!=null&&F.length&&(b.children=F),h){const T=n(d.target),A=c(p,T,u+1).filter(Boolean);b.children=b.children||[],b.children.push(...A)}return b}},c=(p,d,u)=>{const f=[];return d.forEach(h=>{const F=i(p,h,u);F&&f.push(F)}),f};return(p,d)=>c(p,d,1)},fo=()=>{const{name:e}=r.useCollection_deprecated(),{getCollectionFields:t}=r.useCollectionManager_deprecated(),o=t(e),{service:n,props:a}=r.useBlockRequestContext(),{t:i}=V.useTranslation(),c=C.useField(),l=C.useFieldSchema(),p=r.useDataLoadingMode(),d=mo(),u=d(e,o),[f,h]=y.useState([]),F=J.get(l,"parent.parent.x-decorator-props.params.filter");r.useRequest({resource:"public",action:"getUserAuditJobDbFilters",params:{filter:F}},{onSuccess(_){const T=(_==null?void 0:_.data)||[],A=T.map(v=>({title:v.title,name:v.name,children:v.fields}));l["x-component-props"]||(l["x-component-props"]={}),l["x-component-props"]=w(m({},l["x-component-props"]),{extraCollections:A}),h(T)}});const g=a==null?void 0:a.params,b=f.map(_=>_.name);return{options:[...f.map(_=>{const T=d(_.name,_.fields);return T.length>0?{title:_.title,name:_.name,children:T}:void 0}).filter(Boolean),...u],onSubmit(_){var O,M,L;const T=g.filter;let A=r.removeNullCondition(_==null?void 0:_.filter);if(A=D.transformAuditTodoListFilterFormat(A,b),p==="manual"&&J.isEmpty(A))return n.mutate(void 0);const v=((M=(O=n.params)==null?void 0:O[1])==null?void 0:M.filters)||{};v.filterAction=A,n.run(w(m({},(L=n.params)==null?void 0:L[0]),{page:1,filter:r.mergeFilter([...Object.values(v),T])}),{filters:v});const I=(A==null?void 0:A.$and)||(A==null?void 0:A.$or);I!=null&&I.length?c.title=i("{{count}} filter items",{count:(I==null?void 0:I.length)||0}):c.title=i("Filter")},onReset(){var v,I,O;const _=g.filter,T=((I=(v=n.params)==null?void 0:v[1])==null?void 0:I.filters)||{};delete T.filterAction;const A=[w(m({},(O=n.params)==null?void 0:O[0]),{filter:r.mergeFilter([...Object.values(T),_]),page:1}),{filters:T}];if(c.title=i("Filter"),p==="manual")return n.params=A,n.mutate(void 0);n.run(...A)}}},Vr=()=>{const e=C.useFieldSchema(),{data:t}=r.useRequest({resource:"public",action:"getUserAuditJobDbFilters",params:{filter:J.get(e,"parent.parent.parent.x-decorator-props.params.filter")}});return e["x-extra-collections"]=(t==null?void 0:t.data)||[],{}},Lr=()=>{const e=C.useField(),t=C.useFieldSchema(),{getDataBlocks:o}=r.useFilterBlock();return e.data=e.data||{},{onClick(){return G(this,null,function*(){var i;const a=((i=t==null?void 0:t.parent)==null?void 0:i["x-extra-collections"])||[];e.data.loading=!0;try{yield Promise.all(o().map(c=>G(this,null,function*(){var f,h;if(!Lt(t,c.uid))return;const p=((f=c.service.params)==null?void 0:f[0])||{};let d=r.removeNullCondition(((h=t==null?void 0:t["x-component-props"])==null?void 0:h.filter)||{});d=D.transformAuditTodoListFilterFormat(d,a.map(F=>F.name));const u=r.mergeFilter([d,c.defaultFilter]);return c.dataLoadingMode==="manual"&&J.isEmpty(u)?c.clearData():c.doFilter(w(m({},p),{page:1,filter:u}))})))}catch(c){}e.data.loading=!1})}}};function We(){var p;const{form:e}=r.useFormBlockContext(),{node:t,userJob:o,execution:n}=x.useFlowContext(),a=r.useRecord(),{data:i}=r.useCurrentUserContext(),c=po(n,o.job,o,t);let l;return((p=i==null?void 0:i.data)==null?void 0:p.id)!==o.userId?l="disabled":c?l="editable":l=a?"readPretty":"disabled",y.useEffect(()=>{e==null||e.setPattern(l)},[l,e]),{form:e}}function de(){const{form:e}=r.useFormBlockContext();return{form:e}}const Ur=(e=100)=>new Promise(t=>{setTimeout(()=>{t(!0)},e)}),Gr=[x.JOB_STATUS.ABORTED,x.JOB_STATUS.REJECTED];function ye(e={onSuccess:()=>{}}){var H,Y,se,Ce,$,P;const{onSuccess:t}=e,{t:o}=V.useTranslation(),{styles:n}=co(),a=r.useCompile(),i=r.useAPIClient(),{setVisible:c}=r.useActionContext(),{values:l,validate:p,clearErrors:d}=C.useForm(),u=C.useFieldSchema(),{service:f}=no(),{userJob:h,execution:F}=x.useFlowContext(),{updateAssociationValues:g,collectionName:b}=r.useFormBlockContext(),{modal:k}=N.App.useApp(),{name:_}=u,T=u["x-decorator-props"].value,{name:A}=((H=u==null?void 0:u.parent)==null?void 0:H.parent)||{},{triggerWorkflows:v}=(Y=u==null?void 0:u["x-action-settings"])!=null?Y:{},{successTitle:I,successMessage:O}=(Ce=(se=u==null?void 0:u["x-action-settings"])==null?void 0:se.onSuccess)!=null?Ce:{},{failTitle:M,failMessage:L}=(P=($=u==null?void 0:u["x-action-settings"])==null?void 0:$.onFail)!=null?P:{},Z=D.DEVICE_TYPE==="pc",q={icon:null,width:"72%",centered:!0,okButtonProps:{type:"link",style:{padding:0,fontSize:18}}};return{run(){return G(this,null,function*(){var R;if((!Ut(F.status)||h.status)&&T!==x.JOB_STATUS.PULL_BACK)return;if(!Gr.includes(T)){const z=r.getSkipValidatePathRegex(l);yield d(),yield p(z)}const j=!!(v!=null&&v.length);!j&&i.silent();const X={filterByTk:h.id,updateAssociationValues:g,values:{result:{[A]:l,_}},triggerWorkflows:v!=null&&v.length?v.map(z=>[z.workflowKey,z.context].filter(Boolean).join("!")).join(","):void 0},ee=()=>G(this,null,function*(){if(c(!1),t==null||t(),yield Ur(),yield f.refresh(),Z){N.message.success(a(O||o("Operation succeeded")));return}k.success(w(m({},q),{title:a(I||o("Operation succeeded")),content:a(O),okText:o("Confirm"),className:n.mobileModalMessageCss}))}),oe=z=>{if(Z){N.message.error(a(L||`${z}`));return}const re=s.jsxs("div",{children:[s.jsx("p",{children:a(L||`${z}`)}),s.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center",marginTop:33},children:s.jsx(zr,{})})]});k.error(w(m({},q),{title:a(M||o("Operation failed")),content:re,okText:o("Confirm"),className:n.mobileModalMessageCss}))},Te=(z,re=[],ie=[])=>{const ke=re.map(({message:xe})=>xe).join(`
`);k.confirm({title:o("Confirm"),content:ke,okText:o("Continue to Submit"),cancelText:o("Back to Modify"),onOk:()=>G(this,null,function*(){try{yield i.resource("audits_jobs").submit(w(m({},z),{triggerWorkflowsFilter:ie.join(",")})),ee()}catch(xe){}})})};try{yield i.resource("audits_jobs").submit(X),ee()}catch(z){const{data:re={},messages:ie=[]}=((R=z==null?void 0:z.response)==null?void 0:R.data)||{},{needSecondaryConfirmation:ke,secondaryConfirmationWorkflows:xe=[]}=re;if(!j)return oe(z);ke&&Te(X,ie,xe)}finally{i.silence=!1}})}}}const Hr={title:`{{t("Task", { ns: "${S}" })}}`,name:"flow_nodes",fields:[{type:"bigInt",name:"id",interface:"m2o",uiSchema:{type:"number",title:"ID","x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"flow_nodes",params:{filter:{type:"manual"}}}}}},{type:"string",name:"title",interface:"input",uiSchema:{type:"string",title:'{{t("Title")}}',"x-component":"Input"}}]},Jr={title:`{{t("Workflow", { ns: "${S}" })}}`,name:"workflows",fields:[{type:"string",name:"title",interface:"input",uiSchema:{title:'{{t("Name")}}',type:"string","x-component":"Input",required:!0}}]},Kr={title:`{{t("Workflow todos", { ns: "${S}" })}}`,name:"audits_jobs",fields:[{type:"belongsTo",name:"user",target:"users",foreignKey:"userId",interface:"m2o",uiSchema:{type:"number",title:'{{t("User")}}',"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"nickname",value:"id"},service:{resource:"users"}}}},{type:"belongsTo",name:"node",target:"flow_nodes",foreignKey:"nodeId",interface:"m2o",isAssociation:!0,uiSchema:{type:"number",title:`{{t("Task", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"flow_nodes"}}}},{type:"belongsTo",name:"workflow",target:"workflows",foreignKey:"workflowId",interface:"m2o",uiSchema:{type:"number",title:`{{t("Workflow", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"workflows"}}}},{type:"integer",name:"status",interface:"select",uiSchema:{type:"number",title:`{{t("Status", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}},{name:"createdAt",type:"date",interface:"createdAt",uiSchema:{type:"datetime",title:'{{t("Created at")}}',"x-component":"DatePicker","x-component-props":{showTime:!0}}}]},qr=C.observer(()=>{var t,o,n;const e=C.useField();return(n=(t=e==null?void 0:e.value)==null?void 0:t.title)!=null?n:`#${(o=e.value)==null?void 0:o.id}`},{displayName:"NodeColumn"}),Zr=C.observer(()=>{var t,o,n;const e=C.useField();return(n=(t=e==null?void 0:e.value)==null?void 0:t.title)!=null?n:`#${(o=e.value)==null?void 0:o.id}`},{displayName:"WorkflowColumn"}),Yr=C.observer(()=>{var t,o,n;const e=C.useField();return(n=(t=e==null?void 0:e.value)==null?void 0:t.nickname)!=null?n:(o=e.value)==null?void 0:o.id},{displayName:"UserColumn"});function Xr(e){const t=r.useRecord(),o=Ve("Unprocessed");return t.execution.status&&!t.status?s.jsx(N.Tag,{children:o}):e.children}const gt=()=>s.jsx(r.SchemaComponent,{components:{NodeColumn:qr,WorkflowColumn:Zr,UserColumn:Yr,UserJobStatusColumn:Xr},schema:{type:"void",properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-designer":"Filter.Action.Designer","x-component":"Filter.Action","x-component-props":{icon:"FilterOutlined",useProps:"{{ useFilterActionProps }}"},"x-align":"left"},refresher:{type:"void",title:'{{ t("Refresh") }}',"x-action":"refresh","x-component":"Action","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:refresh","x-component-props":{icon:"ReloadOutlined",useProps:"{{ useRefreshActionProps }}"},"x-align":"right"}}},table:{type:"array","x-component":"TableV2","x-component-props":{rowKey:"id",useProps:"{{ useTableBlockProps }}"},properties:{actions:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:60},title:'{{t("Actions")}}',properties:{view:{type:"void","x-component":"Action.Link",title:'{{t("View")}}',properties:{drawer:{"x-component":"WorkflowAuditTodo.Drawer"}}}}},node:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:null},title:`{{t("Task node", { ns: "${S}" })}}`,properties:{node:{"x-component":"NodeColumn","x-read-pretty":!0}}},workflow:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:null},title:'{{t("Workflow", { ns: "workflow" })}}',properties:{workflow:{"x-component":"WorkflowColumn","x-read-pretty":!0}}},status:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:100},title:'{{t("Status", { ns: "workflow" })}}',properties:{status:{type:"number","x-decorator":"UserJobStatusColumn","x-component":"CollectionField","x-read-pretty":!0}}},user:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:140},title:`{{t("Assignee", { ns: "${S}" })}}`,properties:{user:{"x-component":"UserColumn","x-read-pretty":!0}}},createdAt:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:160},properties:{createdAt:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}}}}}}});function Qr(e){var f,h,F;const t=r.usePlugin(x),o=r.useAPIClient(),{id:n}=r.useRecord(),[a,i]=y.useState(null),[c,l]=y.useState(null);y.useEffect(()=>{var g,b;n&&((b=(g=o.resource("audits_jobs")).get)==null||b.call(g,{filterByTk:n,appends:["node","job","workflow","workflow.nodes","execution","execution.jobs"]}).then(({data:k})=>{var M;const L=(M=k==null?void 0:k.data)!=null?M:{},{status:_,node:T,workflow:Z={}}=L,q=Z,{nodes:A=[]}=q,v=ne(q,["nodes"]),H=L,{execution:I}=H,O=ne(H,["status","node","workflow","execution"]);x.linkNodes(A),l(T),i({node:T,userJob:O,workflow:v,nodes:A,execution:I,status:_})}))},[o,n]);const d=x.useAvailableUpstreams(a==null?void 0:a.nodes.find(g=>g.id===c.id)).reduce((g,{type:b})=>Object.assign(g,t.instructions.get(b).components),{}),u=!!((f=c==null?void 0:c.config)!=null&&f.cardSchema);return c&&a?s.jsx(x.FlowContext.Provider,{value:a,children:s.jsx(x.NodeContext.Provider,{value:c,children:s.jsx(r.SchemaComponent,{components:m(m({FormBlockProvider:Ne,DetailsBlockProvider:x.DetailsBlockProvider,ActionBarProvider:Qe,ManualActionStatusProvider:Xe},Array.from(W.getValues()).reduce((g,b)=>Object.assign(g,b.block.components),{})),d),scope:m({useSubmit:ye,useFormBlockProps:We,useDetailsProps:de,useDetailsBlockProps:de},Array.from(W.getValues()).reduce((g,b)=>Object.assign(g,b.block.scope),{})),schema:u?(h=c==null?void 0:c.config)==null?void 0:h.cardSchema:{type:"void",name:"tabs","x-component":"Tabs",properties:(F=c.config)==null?void 0:F.schema}})})}):s.jsx(N.Spin,{})}function Ct(){const e=r.useCompile(),{status:t,updatedAt:o}=r.useRecord(),n=x.JobStatusOptionsMap[t];return t?s.jsxs(N.Space,{children:[s.jsx("time",{className:r.css`
          margin-right: 0.5em;
        `,children:yn(o).format("YYYY-MM-DD HH:mm:ss")}),s.jsx(N.Tag,{icon:n.icon,color:n.color,children:e(n.label)})]}):null}function Wr(){var i;const e=y.useContext(r.SchemaComponentContext),{id:t,node:o,workflow:n,status:a}=r.useRecord();return s.jsx(r.SchemaComponentContext.Provider,{value:w(m({},e),{reset(){},designable:!1}),children:s.jsx(r.SchemaComponent,{components:{FooterStatus:Ct,FlowContextProvider:Qr},schema:{type:"void",name:`drawer-${t}-${a}`,"x-component":"Action.Drawer","x-component-props":{className:"nb-action-popup"},title:`${n.title} - ${(i=o.title)!=null?i:`#${o.id}`}`,properties:{tabs:{type:"void","x-component":"FlowContextProvider"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{content:{type:"void","x-component":"FooterStatus"}}}}}})})}function Rr({params:e={},children:t}){const o={collection:"audits_jobs",resource:"audits_jobs",action:"list",params:w(m({pageSize:20,sort:["-createdAt"]},e),{appends:["user","node","workflow","execution.status"],except:["node.config","workflow.config","workflow.options"]}),rowKey:"id",showIndex:!0,dragSort:!1};return s.jsx(r.ExtendCollectionsProvider,{collections:[Hr,Jr,Kr],children:s.jsx(r.TableBlockProvider,w(m({name:"workflow-todo"},o),{children:t}))})}gt.Drawer=Wr,gt.Decorator=Rr;const es=()=>{const e=r.useSchemaInitializerItem(),{insert:t}=r.useSchemaInitializer();return s.jsx(r.SchemaInitializerItem,w(m({icon:s.jsx(ae.TableOutlined,{})},e),{onClick:()=>{t({type:"void","x-decorator":"WorkflowAuditTodo.Decorator","x-decorator-props":{},"x-component":"CardItem","x-toolbar":"BlockSchemaToolbar","x-settings":"blockSettings:table",properties:{todos:{type:"void","x-component":"WorkflowAuditTodo"}}})}}))},xt=e=>{if(!e)return{};const{node:t}=e,o=r.usePlugin(x),n=r.usePlugin("@ashley/plugin-aps-go-notice")||{},i=x.useAvailableUpstreams(e==null?void 0:e.nodes.find(l=>l.id===t.id)).reduce((l,{type:p})=>Object.assign(l,o.instructions.get(p).components),{}),c=m({},n.scopes);return{extraComponents:i,extraScopes:c}},ho=()=>{var o,n;const e=y.useContext(r.SchemaComponentContext),t=C.useFieldSchema();return s.jsx(r.SchemaComponentContext.Provider,{value:w(m({},e),{designable:!1}),children:s.jsx(r.SchemaComponent,{components:{AuditCardFlowContextProvider:ns},scope:{useFilterActionProps:fo},schema:{type:"void",properties:{auditCardList:{type:"array","x-component":"AuditCard","x-component-props":{asswipe:(n=(o=t==null?void 0:t.parent)==null?void 0:o["x-component-props"])==null?void 0:n.asswipe,useProps:"{{ useAuditCardBlockProps }}"},properties:{item:{type:"object","x-component":"AuditCardFlowContextProvider"}}}}}})})},ts=e=>Q(e,o=>{var n;return o["x-component"]==="CollectionField"&&((n=o["x-component-props"])==null?void 0:n.mode)==="SubTable"}).length>0;function os(e){const{cardSchema:t,extraScopes:o,extraComponents:n}=e,[a,i]=y.useState(!1),l=ts(new C.Schema(t))&&!D.isMobile,p=y.useContext(r.SchemaComponentContext),d=m(m(w(m({},p.components),{FormBlockProvider:Ne,DetailsBlockProvider:x.DetailsBlockProvider,ActionBarProvider:Qe,ManualActionStatusProvider:Xe}),Array.from(W.getValues()).reduce((f,h)=>Object.assign(f,h.block.components),{})),n),u=m(w(m(m({},p.scope),o),{useSubmit:l?()=>{const{run:f}=ye({onSuccess:()=>{i(!1)}});return{run:f}}:ye,useFormBlockProps:We,useDetailsProps:de,useDetailsBlockProps:de}),Array.from(W.getValues()).reduce((f,h)=>Object.assign(f,h.block.scope),{}));return s.jsxs(r.SchemaComponentContext.Provider,{value:w(m({},p),{components:d,scope:u}),children:[l&&s.jsx(s.Fragment,{children:s.jsx(N.Drawer,{width:"100%",open:a,onClose:()=>{i(!1)},children:s.jsx(r.SchemaComponent,{components:w(m({},d),{AuditCardFormCollapse:f=>f.children}),scope:u,schema:t})})}),s.jsx("div",{onClick:()=>{l&&i(!0)},style:{zIndex:2,cursor:l?"pointer":"default"},children:s.jsx(r.SchemaComponent,{components:d,scope:u,schema:t})})]})}function ns(e){var F;const d=e.value,{node:t,workflow:u={}}=d,f=u,{nodes:o=[]}=f,n=ne(f,["nodes"]),h=d,{execution:a}=h,i=ne(h,["node","workflow","execution"]),c={node:t,userJob:i,workflow:n,nodes:o,execution:a},{extraComponents:l,extraScopes:p}=xt(c);return t&&c?s.jsx(x.FlowContext.Provider,{value:c,children:s.jsx(x.NodeContext.Provider,{value:t,children:s.jsx(os,{extraScopes:p,extraComponents:l,cardSchema:((F=t.config)==null?void 0:F.cardSchema)||{}})})}):s.jsx(N.Spin,{})}function rs({params:e={},children:t}){const o={collection:"audits_jobs",resource:"audits_jobs",action:"list",params:w(m({pageSize:10,sort:["-createdAt"]},e),{appends:["user","node","workflow","execution.status","node","job","workflow","workflow.nodes","execution","execution.jobs"],except:["workflow.options"]}),rowKey:"id",showIndex:!0,dragSort:!1},n=C.useField();return r.useControlShowBlock(e,n),s.jsx(r.ExtendCollectionsProvider,{collections:[Et,jt,wn,zt],children:s.jsx(oo,w(m({name:"audit-todo"},o),{children:t}))})}ho.Decorator=rs;var ss=Object.prototype;function as(e){var t=e&&e.constructor,o=typeof t=="function"&&t.prototype||ss;return e===o}var go=as;function is(e,t){return function(o){return e(t(o))}}var cs=is,ls=cs,ds=ls(Object.keys,Object),ps=ds,us=go,ms=ps,fs=Object.prototype,hs=fs.hasOwnProperty;function gs(e){if(!us(e))return ms(e);var t=[];for(var o in Object(e))hs.call(e,o)&&o!="constructor"&&t.push(o);return t}var Cs=gs,xs=typeof Ke=="object"&&Ke&&Ke.Object===Object&&Ke,Co=xs,ys=Co,bs=typeof self=="object"&&self&&self.Object===Object&&self,Ss=ys||bs||Function("return this")(),pe=Ss,vs=pe,ws=vs.Symbol,yt=ws,xo=yt,yo=Object.prototype,Fs=yo.hasOwnProperty,As=yo.toString,Me=xo?xo.toStringTag:void 0;function Is(e){var t=Fs.call(e,Me),o=e[Me];try{e[Me]=void 0;var n=!0}catch(i){}var a=As.call(e);return n&&(t?e[Me]=o:delete e[Me]),a}var Ts=Is,ks=Object.prototype,_s=ks.toString;function Os(e){return _s.call(e)}var Bs=Os,bo=yt,Ns=Ts,Ds=Bs,$s="[object Null]",Ps="[object Undefined]",So=bo?bo.toStringTag:void 0;function Ms(e){return e==null?e===void 0?Ps:$s:So&&So in Object(e)?Ns(e):Ds(e)}var Ee=Ms;function Es(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var bt=Es,js=Ee,zs=bt,Vs="[object AsyncFunction]",Ls="[object Function]",Us="[object GeneratorFunction]",Gs="[object Proxy]";function Hs(e){if(!zs(e))return!1;var t=js(e);return t==Ls||t==Us||t==Vs||t==Gs}var vo=Hs,Js=pe,Ks=Js["__core-js_shared__"],qs=Ks,St=qs,wo=function(){var e=/[^.]+$/.exec(St&&St.keys&&St.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function Zs(e){return!!wo&&wo in e}var Ys=Zs,Xs=Function.prototype,Qs=Xs.toString;function Ws(e){if(e!=null){try{return Qs.call(e)}catch(t){}try{return e+""}catch(t){}}return""}var Fo=Ws,Rs=vo,ea=Ys,ta=bt,oa=Fo,na=/[\\^$.*+?()[\]{}|]/g,ra=/^\[object .+?Constructor\]$/,sa=Function.prototype,aa=Object.prototype,ia=sa.toString,ca=aa.hasOwnProperty,la=RegExp("^"+ia.call(ca).replace(na,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function da(e){if(!ta(e)||ea(e))return!1;var t=Rs(e)?la:ra;return t.test(oa(e))}var pa=da;function ua(e,t){return e==null?void 0:e[t]}var ma=ua,fa=pa,ha=ma;function ga(e,t){var o=ha(e,t);return fa(o)?o:void 0}var he=ga,Ca=he,xa=pe,ya=Ca(xa,"DataView"),ba=ya,Sa=he,va=pe,wa=Sa(va,"Map"),Ao=wa,Fa=he,Aa=pe,Ia=Fa(Aa,"Promise"),Ta=Ia,ka=he,_a=pe,Oa=ka(_a,"Set"),Ba=Oa,Na=he,Da=pe,$a=Na(Da,"WeakMap"),Pa=$a,vt=ba,wt=Ao,Ft=Ta,At=Ba,It=Pa,Io=Ee,be=Fo,To="[object Map]",Ma="[object Object]",ko="[object Promise]",_o="[object Set]",Oo="[object WeakMap]",Bo="[object DataView]",Ea=be(vt),ja=be(wt),za=be(Ft),Va=be(At),La=be(It),ge=Io;(vt&&ge(new vt(new ArrayBuffer(1)))!=Bo||wt&&ge(new wt)!=To||Ft&&ge(Ft.resolve())!=ko||At&&ge(new At)!=_o||It&&ge(new It)!=Oo)&&(ge=function(e){var t=Io(e),o=t==Ma?e.constructor:void 0,n=o?be(o):"";if(n)switch(n){case Ea:return Bo;case ja:return To;case za:return ko;case Va:return _o;case La:return Oo}return t});var Ua=ge;function Ga(e){return e!=null&&typeof e=="object"}var Re=Ga,Ha=Ee,Ja=Re,Ka="[object Arguments]";function qa(e){return Ja(e)&&Ha(e)==Ka}var Za=qa,No=Za,Ya=Re,Do=Object.prototype,Xa=Do.hasOwnProperty,Qa=Do.propertyIsEnumerable,Wa=No(function(){return arguments}())?No:function(e){return Ya(e)&&Xa.call(e,"callee")&&!Qa.call(e,"callee")},Ra=Wa,ei=Array.isArray,et=ei,ti=9007199254740991;function oi(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=ti}var $o=oi,ni=vo,ri=$o;function si(e){return e!=null&&ri(e.length)&&!ni(e)}var ai=si,tt={exports:{}};function ii(){return!1}var ci=ii;tt.exports,function(e,t){var o=pe,n=ci,a=t&&!t.nodeType&&t,i=a&&!0&&e&&!e.nodeType&&e,c=i&&i.exports===a,l=c?o.Buffer:void 0,p=l?l.isBuffer:void 0,d=p||n;e.exports=d}(tt,tt.exports);var li=tt.exports,di=Ee,pi=$o,ui=Re,mi="[object Arguments]",fi="[object Array]",hi="[object Boolean]",gi="[object Date]",Ci="[object Error]",xi="[object Function]",yi="[object Map]",bi="[object Number]",Si="[object Object]",vi="[object RegExp]",wi="[object Set]",Fi="[object String]",Ai="[object WeakMap]",Ii="[object ArrayBuffer]",Ti="[object DataView]",ki="[object Float32Array]",_i="[object Float64Array]",Oi="[object Int8Array]",Bi="[object Int16Array]",Ni="[object Int32Array]",Di="[object Uint8Array]",$i="[object Uint8ClampedArray]",Pi="[object Uint16Array]",Mi="[object Uint32Array]",U={};U[ki]=U[_i]=U[Oi]=U[Bi]=U[Ni]=U[Di]=U[$i]=U[Pi]=U[Mi]=!0,U[mi]=U[fi]=U[Ii]=U[hi]=U[Ti]=U[gi]=U[Ci]=U[xi]=U[yi]=U[bi]=U[Si]=U[vi]=U[wi]=U[Fi]=U[Ai]=!1;function Ei(e){return ui(e)&&pi(e.length)&&!!U[di(e)]}var ji=Ei;function zi(e){return function(t){return e(t)}}var Vi=zi,ot={exports:{}};ot.exports,function(e,t){var o=Co,n=t&&!t.nodeType&&t,a=n&&!0&&e&&!e.nodeType&&e,i=a&&a.exports===n,c=i&&o.process,l=function(){try{var p=a&&a.require&&a.require("util").types;return p||c&&c.binding&&c.binding("util")}catch(d){}}();e.exports=l}(ot,ot.exports);var Li=ot.exports,Ui=ji,Gi=Vi,Po=Li,Mo=Po&&Po.isTypedArray,Hi=Mo?Gi(Mo):Ui,Ji=Hi,Ki=Cs,qi=Ua,Zi=Ra,Yi=et,Xi=ai,Qi=li,Wi=go,Ri=Ji,ec="[object Map]",tc="[object Set]",oc=Object.prototype,nc=oc.hasOwnProperty;function rc(e){if(e==null)return!0;if(Xi(e)&&(Yi(e)||typeof e=="string"||typeof e.splice=="function"||Qi(e)||Ri(e)||Zi(e)))return!e.length;var t=qi(e);if(t==ec||t==tc)return!e.size;if(Wi(e))return!Ki(e).length;for(var o in e)if(nc.call(e,o))return!1;return!0}var sc=rc;const Eo=ut(sc),Tt={title:`{{t("Message", { ns: "${S}" })}}`,name:"notifications",fields:[{name:"action",type:"string",interface:"input",disabled:!0,uiSchema:{type:"string",title:`{{t("Message title", { ns: "${S}" })}}`,"x-component":"Input",rawTitle:`{{t("Message title", { ns: "${S}" })}}`}},{name:"desc",type:"string",disabled:!0,interface:"input",uiSchema:{type:"string",title:`{{t("Message content", { ns: "${S}" })}}`,"x-component":"Variable.RichTextArea",rawTitle:`{{t("Message content", { ns: "${S}" })}}`}},{name:"id",type:"bigInt",interface:"integer",uiSchema:{type:"number",title:'{{t("ID")}}',"x-component":"InputNumber","x-read-pretty":!0,rawTitle:'{{t("ID")}}'}},{name:"type",type:"string",interface:"select",uiSchema:{type:"string",title:`{{t("Message type", { ns: "${S}" })}}`,"x-component":"Select",rawTitle:`{{t("Message type", { ns: "${S}" })}}`,enum:[{label:`{{t("Notification message", { ns: "${S}" })}}`,value:"msg"},{label:`{{t("Approval message", { ns: "${S}" })}}`,value:"todo"}]}},{name:"createdAt",type:"date",interface:"createdAt",uiSchema:{type:"string",title:'{{t("Created at")}}',"x-component":"DatePicker","x-component-props":{},rawTitle:'{{t("Created at")}}'}},{name:"is_read",type:"integer",interface:"select",uiSchema:{type:"integer",title:`{{t("Read status", { ns: "${S}" })}}`,"x-component":"Select",rawTitle:`{{t("Read status", { ns: "${S}" })}}`,enum:[{label:`{{t("Unread", { ns: "${S}" })}}`,value:"0",color:"default"},{label:`{{t("Read", { ns: "${S}" })}}`,value:"1",color:"green"}]}},{type:"belongsTo",name:"workflows",target:"workflows",foreignKey:"workflowId",interface:"m2o",treeChildren:!0,uiSchema:{type:"number",title:`{{t("Workflow", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{title:`{{t("Workflow", { ns: "${S}" })}}`,value:"id"},service:{resource:"workflows"}}}},{type:"belongsTo",name:"flowNodes",target:"flow_nodes",foreignKey:"nodeId",interface:"m2o",treeChildren:!0,uiSchema:{type:"number",title:`{{t("Node", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{title:`{{t("Node", { ns: "${S}" })}}`,value:"id"},service:{resource:"flow_nodes"}}}},{type:"belongsTo",name:"auditsJobs",target:"audits_jobs",foreignKey:"audits_job_id",interface:"m2o",treeChildren:!0,uiSchema:{type:"number",title:`{{t("Audit Node Job", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{title:`{{t("Audit Node Job", { ns: "${S}" })}}`,value:"id"},service:{resource:"auditsJobs"}}}},{type:"belongsTo",name:"jobs",target:"jobs",foreignKey:"job_id",interface:"m2o",treeChildren:!0,uiSchema:{type:"number",title:`{{t("Node Job", { ns: "${S}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{title:`{{t("Node Job", { ns: "${S}" })}}`,value:"id"},service:{resource:"jobs"}}}}]},jo={title:`{{t("Audit Node Job", { ns: "${S}" })}}`,name:"audits_jobs",fields:[{type:"integer",name:"status",interface:"select",uiSchema:{type:"number",title:`{{t("Job status", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}},{type:"string",name:"nodeTag",interface:"select",uiSchema:{type:"string",title:`{{t("Node Tag", { ns: "${S}" })}}`,"x-component":"Select",enum:Ue}}]},zo={title:`{{t("Node Job", { ns: "${S}" })}}`,name:"jobs",fields:[{type:"integer",name:"status",interface:"select",uiSchema:{type:"number",title:`{{t("Job status", { ns: "${S}" })}}`,"x-component":"Select",enum:x.JobStatusOptions}}]},ac={title:`{{t("Workflow", { ns: "${S}" })}}`,name:"workflows",fields:[{type:"string",name:"title",interface:"input",uiSchema:{type:"string",title:`{{t("Workflow title", { ns: "${S}" })}}`,"x-component":"Input"}}]},ic={title:`{{t("Workflow node", { ns: "${S}" })}}`,name:"flowNodes",fields:[{type:"string",name:"title",interface:"input",uiSchema:{type:"string",title:`{{t("Workflow node title", { ns: "${S}" })}}`,"x-component":"Input"}}]},cc={xs:1,md:2,lg:3,xxl:4},Vo={md:18,sm:5,xs:5},kt=y.createContext({});kt.displayName="MessageInformationBlockContext";const Lo=()=>y.useContext(kt),lc=e=>{var i;const{resource:t,service:o}=r.useBlockRequestContext(),n=C.useField(),a=y.useMemo(()=>_e.createForm({readPretty:!0}),[]);return y.useEffect(()=>{var c;o!=null&&o.loading||a.setValuesIn(n.address.concat("list").toString(),(c=o==null?void 0:o.data)==null?void 0:c.data)},[n.address,a,(i=o==null?void 0:o.data)==null?void 0:i.data,o==null?void 0:o.loading]),s.jsx(kt.Provider,{value:{service:o,resource:t},children:s.jsx(C.FormContext.Provider,{value:a,children:s.jsx(ue.FormLayout,{layout:"vertical",children:s.jsx("div",{className:K.cx(K.css`
              .ant-description-input {
                line-height: 34px;
              }
              .ant-formily-item-feedback-layout-loose {
                margin-bottom: 12px;
              }
            `),children:e.children})})})})},dc=r.withDynamicSchemaProps(e=>{const{params:t}=e,{filter:o}=r.useParsedFilter({filterOption:t==null?void 0:t.filter}),n=y.useMemo(()=>w(m({},t),{filter:o}),[o,t]);return Eo(o)&&!Eo(t==null?void 0:t.filter)?null:s.jsx(r.ExtendCollectionsProvider,{collections:[Tt,jo,zo,ac,ic],children:s.jsx(r.BlockProvider,w(m({},e),{params:n,children:s.jsx(lc,m({},e))}))})});var pc=he,uc=function(){try{var e=pc(Object,"defineProperty");return e({},"",{}),e}catch(t){}}(),mc=uc,Uo=mc;function fc(e,t,o){t=="__proto__"&&Uo?Uo(e,t,{configurable:!0,enumerable:!0,value:o,writable:!0}):e[t]=o}var hc=fc;function gc(e,t){return e===t||e!==e&&t!==t}var Go=gc,Cc=hc,xc=Go,yc=Object.prototype,bc=yc.hasOwnProperty;function Sc(e,t,o){var n=e[t];(!(bc.call(e,t)&&xc(n,o))||o===void 0&&!(t in e))&&Cc(e,t,o)}var vc=Sc,wc=Ee,Fc=Re,Ac="[object Symbol]";function Ic(e){return typeof e=="symbol"||Fc(e)&&wc(e)==Ac}var _t=Ic,Tc=et,kc=_t,_c=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Oc=/^\w*$/;function Bc(e,t){if(Tc(e))return!1;var o=typeof e;return o=="number"||o=="symbol"||o=="boolean"||e==null||kc(e)?!0:Oc.test(e)||!_c.test(e)||t!=null&&e in Object(t)}var Nc=Bc,Dc=he,$c=Dc(Object,"create"),nt=$c,Ho=nt;function Pc(){this.__data__=Ho?Ho(null):{},this.size=0}var Mc=Pc;function Ec(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var jc=Ec,zc=nt,Vc="__lodash_hash_undefined__",Lc=Object.prototype,Uc=Lc.hasOwnProperty;function Gc(e){var t=this.__data__;if(zc){var o=t[e];return o===Vc?void 0:o}return Uc.call(t,e)?t[e]:void 0}var Hc=Gc,Jc=nt,Kc=Object.prototype,qc=Kc.hasOwnProperty;function Zc(e){var t=this.__data__;return Jc?t[e]!==void 0:qc.call(t,e)}var Yc=Zc,Xc=nt,Qc="__lodash_hash_undefined__";function Wc(e,t){var o=this.__data__;return this.size+=this.has(e)?0:1,o[e]=Xc&&t===void 0?Qc:t,this}var Rc=Wc,el=Mc,tl=jc,ol=Hc,nl=Yc,rl=Rc;function Se(e){var t=-1,o=e==null?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}Se.prototype.clear=el,Se.prototype.delete=tl,Se.prototype.get=ol,Se.prototype.has=nl,Se.prototype.set=rl;var sl=Se;function al(){this.__data__=[],this.size=0}var il=al,cl=Go;function ll(e,t){for(var o=e.length;o--;)if(cl(e[o][0],t))return o;return-1}var rt=ll,dl=rt,pl=Array.prototype,ul=pl.splice;function ml(e){var t=this.__data__,o=dl(t,e);if(o<0)return!1;var n=t.length-1;return o==n?t.pop():ul.call(t,o,1),--this.size,!0}var fl=ml,hl=rt;function gl(e){var t=this.__data__,o=hl(t,e);return o<0?void 0:t[o][1]}var Cl=gl,xl=rt;function yl(e){return xl(this.__data__,e)>-1}var bl=yl,Sl=rt;function vl(e,t){var o=this.__data__,n=Sl(o,e);return n<0?(++this.size,o.push([e,t])):o[n][1]=t,this}var wl=vl,Fl=il,Al=fl,Il=Cl,Tl=bl,kl=wl;function ve(e){var t=-1,o=e==null?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}ve.prototype.clear=Fl,ve.prototype.delete=Al,ve.prototype.get=Il,ve.prototype.has=Tl,ve.prototype.set=kl;var _l=ve,Jo=sl,Ol=_l,Bl=Ao;function Nl(){this.size=0,this.__data__={hash:new Jo,map:new(Bl||Ol),string:new Jo}}var Dl=Nl;function $l(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}var Pl=$l,Ml=Pl;function El(e,t){var o=e.__data__;return Ml(t)?o[typeof t=="string"?"string":"hash"]:o.map}var st=El,jl=st;function zl(e){var t=jl(this,e).delete(e);return this.size-=t?1:0,t}var Vl=zl,Ll=st;function Ul(e){return Ll(this,e).get(e)}var Gl=Ul,Hl=st;function Jl(e){return Hl(this,e).has(e)}var Kl=Jl,ql=st;function Zl(e,t){var o=ql(this,e),n=o.size;return o.set(e,t),this.size+=o.size==n?0:1,this}var Yl=Zl,Xl=Dl,Ql=Vl,Wl=Gl,Rl=Kl,ed=Yl;function we(e){var t=-1,o=e==null?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}we.prototype.clear=Xl,we.prototype.delete=Ql,we.prototype.get=Wl,we.prototype.has=Rl,we.prototype.set=ed;var td=we,Ko=td,od="Expected a function";function Ot(e,t){if(typeof e!="function"||t!=null&&typeof t!="function")throw new TypeError(od);var o=function(){var n=arguments,a=t?t.apply(this,n):n[0],i=o.cache;if(i.has(a))return i.get(a);var c=e.apply(this,n);return o.cache=i.set(a,c)||i,c};return o.cache=new(Ot.Cache||Ko),o}Ot.Cache=Ko;var nd=Ot,rd=nd,sd=500;function ad(e){var t=rd(e,function(n){return o.size===sd&&o.clear(),n}),o=t.cache;return t}var id=ad,cd=id,ld=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,dd=/\\(\\)?/g,pd=cd(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(ld,function(o,n,a,i){t.push(a?i.replace(dd,"$1"):n||o)}),t}),ud=pd;function md(e,t){for(var o=-1,n=e==null?0:e.length,a=Array(n);++o<n;)a[o]=t(e[o],o,e);return a}var fd=md,qo=yt,hd=fd,gd=et,Cd=_t,xd=1/0,Zo=qo?qo.prototype:void 0,Yo=Zo?Zo.toString:void 0;function Xo(e){if(typeof e=="string")return e;if(gd(e))return hd(e,Xo)+"";if(Cd(e))return Yo?Yo.call(e):"";var t=e+"";return t=="0"&&1/e==-xd?"-0":t}var yd=Xo,bd=yd;function Sd(e){return e==null?"":bd(e)}var vd=Sd,wd=et,Fd=Nc,Ad=ud,Id=vd;function Td(e,t){return wd(e)?e:Fd(e,t)?[e]:Ad(Id(e))}var kd=Td,_d=9007199254740991,Od=/^(?:0|[1-9]\d*)$/;function Bd(e,t){var o=typeof e;return t=t==null?_d:t,!!t&&(o=="number"||o!="symbol"&&Od.test(e))&&e>-1&&e%1==0&&e<t}var Nd=Bd,Dd=_t,$d=1/0;function Pd(e){if(typeof e=="string"||Dd(e))return e;var t=e+"";return t=="0"&&1/e==-$d?"-0":t}var Md=Pd,Ed=vc,jd=kd,zd=Nd,Qo=bt,Vd=Md;function Ld(e,t,o,n){if(!Qo(e))return e;t=jd(t,e);for(var a=-1,i=t.length,c=i-1,l=e;l!=null&&++a<i;){var p=Vd(t[a]),d=o;if(p==="__proto__"||p==="constructor"||p==="prototype")return e;if(a!=c){var u=l[p];d=n?n(u,p,l):void 0,d===void 0&&(d=Qo(u)?u:zd(t[a+1])?[]:{})}Ed(l,p,d),l=l[p]}return e}var Ud=Ld,Gd=Ud;function Hd(e,t,o){return e==null?e:Gd(e,t,o)}var Jd=Hd;const Fe=ut(Jd),Kd=()=>{var h,F,g,b,k,_,T,A;const{name:e,title:t}=r.useCollection_deprecated(),o=r.useSchemaTemplate(),{t:n}=V.useTranslation(),a=C.useFieldSchema(),{form:i}=r.useFormBlockContext(),c=C.useField(),{dn:l}=r.useDesignable(),p=r.useSortFields(e),d=((F=(h=a==null?void 0:a["x-decorator-props"])==null?void 0:h.params)==null?void 0:F.sort)||[],u=((g=a==null?void 0:a["x-decorator-props"])==null?void 0:g.resource)||((b=a==null?void 0:a["x-decorator-props"])==null?void 0:b.association),f=d==null?void 0:d.map(v=>v.startsWith("-")?{field:v.substring(1),direction:"desc"}:{field:v,direction:"asc"});return s.jsxs(r.GeneralSchemaDesigner,{template:o,title:t||e,children:[s.jsx(r.SchemaSettingsBlockTitleItem,{}),s.jsx(r.SchemaSettingsDataScope,{collectionName:e,defaultFilter:((_=(k=a==null?void 0:a["x-decorator-props"])==null?void 0:k.params)==null?void 0:_.filter)||{},form:i,onSubmit:({filter:v})=>{v=r.removeNullCondition(v),Fe(a,"x-decorator-props.params.filter",v),c.decoratorProps.params=w(m({},a["x-decorator-props"].params),{page:1}),l.emit("patch",{schema:{"x-uid":a["x-uid"],"x-decorator-props":a["x-decorator-props"]}})}}),s.jsx(r.SchemaSettingsModalItem,{title:n("Set default sorting rules"),components:{ArrayItems:ue.ArrayItems},schema:{type:"object",title:n("Set default sorting rules"),properties:{sort:{type:"array",default:f,"x-component":"ArrayItems","x-decorator":"FormItem",items:{type:"object",properties:{space:{type:"void","x-component":"Space",properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},field:{type:"string",enum:p,"x-decorator":"FormItem","x-component":"Select","x-component-props":{style:{width:260}}},direction:{type:"string","x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{optionType:"button"},enum:[{label:n("ASC"),value:"asc"},{label:n("DESC"),value:"desc"}]},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:n("Add sort field"),"x-component":"ArrayItems.Addition"}}}}},onSubmit:({sort:v})=>{const I=v.map(O=>O.direction==="desc"?`-${O.field}`:O.field);Fe(a,"x-decorator-props.params.sort",I),c.decoratorProps.params=w(m({},a["x-decorator-props"].params),{page:1}),l.emit("patch",{schema:{"x-uid":a["x-uid"],"x-decorator-props":a["x-decorator-props"]}})}}),s.jsx(r.SetDataLoadingMode,{}),s.jsx(r.SchemaSettingsSelectItem,{title:n("Records per page"),value:((A=(T=c.decoratorProps)==null?void 0:T.params)==null?void 0:A.pageSize)||20,options:[{label:"10",value:10},{label:"20",value:20},{label:"50",value:50},{label:"80",value:80},{label:"100",value:100}],onChange:v=>{Fe(a,"x-decorator-props.params.pageSize",v),c.decoratorProps.params=w(m({},a["x-decorator-props"].params),{page:1}),l.emit("patch",{schema:{"x-uid":a["x-uid"],"x-decorator-props":a["x-decorator-props"]}})}}),s.jsx(r.SchemaSettingsTemplate,{componentName:"List",collectionName:e,resourceName:u}),s.jsx(r.SchemaSettingsDivider,{}),s.jsx(r.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})};function Wo(e){const F=e,{nodeId:t,execution:o,workflows:n,jobs:a}=F,i=ne(F,["nodeId","execution","workflows","jobs"]),c=n.nodes.filter(g=>g.id===t)[0],l={node:c,workflow:n,nodes:n.nodes,execution:o,status:a.status,userJob:w(m({},i),{job:a})};x.linkNodes(n.nodes);const p=y.useContext(r.SchemaComponentContext),{extraComponents:d,extraScopes:u}=xt(l),f=m(w(m(m({},p.components),d),{FormBlockProvider:Ne,DetailsBlockProvider:x.DetailsBlockProvider,ActionBarProvider:Qe,ManualActionStatusProvider:Xe}),Array.from(W.getValues()).reduce((g,b)=>Object.assign(g,b.block.components),{})),h=m(w(m(m({},p.scope),u),{useSubmit:ye,useFormBlockProps:We,useDetailsProps:de,useDetailsBlockProps:de}),Array.from(W.getValues()).reduce((g,b)=>Object.assign(g,b.block.scope),{}));return s.jsx(x.FlowContext.Provider,{value:l,children:s.jsx(x.NodeContext.Provider,{value:c,children:s.jsx(r.SchemaComponentContext.Provider,{value:w(m({},p),{components:f,scope:h,designable:!1}),children:s.jsx(r.SchemaComponent,{components:f,scope:h,schema:c.config.configure})})})})}function Ro(e){var h,F,g;const[t,o]=y.useState(null),[n,a]=y.useState(null),i=y.useContext(r.SchemaComponentContext),c=r.useRequest({resource:"audits_jobs",action:"get",params:{filterByTk:e.id,appends:["node","job","workflow","workflow.nodes","execution","execution.jobs"]}},{onSuccess(b){var O;const M=(O=b==null?void 0:b.data)!=null?O:{},{status:k,node:_,workflow:L={}}=M,Z=L,{nodes:T=[]}=Z,A=ne(Z,["nodes"]),q=M,{execution:v}=q,I=ne(q,["status","node","workflow","execution"]);x.linkNodes(T),a(_),o({node:_,userJob:I,workflow:A,nodes:T,execution:v,status:k})},refreshDeps:[e.id]}),{extraComponents:l,extraScopes:p}=xt(t),d=m(m(w(m({},i.components),{FormBlockProvider:Ne,DetailsBlockProvider:x.DetailsBlockProvider,ActionBarProvider:Qe,ManualActionStatusProvider:Xe}),Array.from(W.getValues()).reduce((b,k)=>Object.assign(b,k.block.components),{})),l),u=m(w(m(m({},i.scope),p),{useSubmit:()=>ye({onSuccess:()=>{var b;(b=e==null?void 0:e.handleRefresh)==null||b.call(e)}}),useFormBlockProps:We,useDetailsProps:de,useDetailsBlockProps:de}),Array.from(W.getValues()).reduce((b,k)=>Object.assign(b,k.block.scope),{})),f=!!((h=n==null?void 0:n.config)!=null&&h.cardSchema);return n&&t?s.jsx(qe.Provider,{value:{service:c},children:s.jsx(x.FlowContext.Provider,{value:t,children:s.jsx(x.NodeContext.Provider,{value:n,children:s.jsx(r.SchemaComponentContext.Provider,{value:w(m({},i),{components:d,scope:u,designable:!1}),children:s.jsx(r.SchemaComponent,{components:d,scope:u,schema:f?(F=n==null?void 0:n.config)==null?void 0:F.cardSchema:{type:"void",name:"tabs","x-component":"Tabs",properties:(g=n.config)==null?void 0:g.schema}})})})})}):s.jsx(N.Spin,{})}var te=(e=>(e.audit="todo",e.notify="msg",e))(te||{}),Ae=(e=>(e[e.read=1]="read",e[e.unread=0]="unread",e))(Ae||{});const qd=({color:e="#fff",width:t=16,height:o=16})=>s.jsx("svg",{width:t,height:o,viewBox:"0 0 22 22",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{d:"M5.7523 14.9195C6.10151 14.9195 6.36401 15.0062 6.62651 15.182C6.62651 15.182 11.8718 19.1969 11.8718 19.1078V1.91641L6.62651 5.93125C6.36401 6.10469 6.10151 6.19375 5.7523 6.19375H2.25308V14.9195H5.7523ZM13.6203 13.9586C15.1062 13.6094 16.2429 12.2125 16.2429 10.5555C16.2429 8.89844 15.1062 7.58828 13.6203 7.15234V13.9586ZM13.6203 5.40625C16.0695 5.84219 17.9914 7.9375 17.9914 10.5555C17.9914 13.1734 16.0671 15.2687 13.6203 15.7047V19.1078C13.6203 20.2422 12.8328 21.0273 11.8718 21.0273C11.6093 21.0273 11.4335 20.9406 11.1734 20.8539L5.7523 16.6633H2.25308C1.29214 16.6633 0.504639 15.9648 0.504639 14.9172V6.19141C0.504639 5.14375 1.29214 4.44531 2.25308 4.44531H5.74995L11.171 0.259375C11.4335 0.172656 11.6093 0.0859375 11.8695 0.0859375C12.8304 0.0859375 13.6179 0.871094 13.6179 2.00547V5.40625H13.6203ZM15.4554 3.1375C15.7179 2.70156 16.1539 2.52578 16.5921 2.70156C19.564 4.18516 21.4882 7.15234 21.4882 10.5555C21.4882 13.9586 19.6531 16.9258 16.5921 18.4094C16.5054 18.4961 16.3296 18.4961 16.2429 18.4961C15.8937 18.4961 15.6312 18.3227 15.4554 17.9734C15.2796 17.5375 15.4554 17.0125 15.8937 16.8391C18.2539 15.618 19.7398 13.2625 19.7398 10.5555C19.7398 7.85078 18.2539 5.49531 15.8937 4.27188C15.4554 4.09844 15.282 3.57344 15.4554 3.1375Z",fill:e})}),en=e=>s.jsx(r.Icon,{component:()=>s.jsx(qd,m({},e))}),Zd=({color:e="#fff",width:t=16,height:o=16})=>s.jsxs("svg",{width:t,height:o,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[s.jsx("path",{d:"M16.3336 10.1715C15.3352 10.1715 14.393 10.4105 13.5563 10.8348L13.0148 9.64414C12.6023 9.92305 12.143 10.134 11.6484 10.2629L12.293 11.6832C11.3133 12.534 10.6055 13.6895 10.3148 14.9996H7.07578L9.30234 10.2371C8.8125 10.0965 8.35547 9.87617 7.95 9.58789L5.42109 14.9996H1.5V22.4996H15.8438V22.4809C16.0055 22.4926 16.1695 22.4996 16.3336 22.4996C17.9813 22.4996 19.5281 21.8574 20.693 20.6949C21.8578 19.5301 22.5 17.9832 22.5 16.3355C22.5 12.9371 19.7344 10.1715 16.3336 10.1715ZM3 20.9996V16.4996H10.1742C10.2164 18.084 10.8516 19.5699 11.9766 20.6949C12.082 20.8004 12.1922 20.9035 12.3047 20.9996H3ZM16.3336 20.9996C13.7648 20.9996 11.6719 18.9066 11.6719 16.3355C11.6719 13.7645 13.7648 11.6715 16.3336 11.6715C18.907 11.6715 21 13.7645 21 16.3355C21 18.9066 18.907 20.9996 16.3336 20.9996Z",fill:e}),s.jsx("path",{d:"M14.9766 5.95313C14.9766 7.48828 14.2008 8.84297 13.0172 9.64219C12.6047 9.92109 12.1453 10.132 11.6508 10.2609C11.2898 10.3547 10.9125 10.4039 10.5234 10.4039C10.0992 10.4039 9.68906 10.3453 9.30234 10.2352C8.8125 10.0945 8.35547 9.87422 7.95 9.58594C6.81328 8.78203 6.07031 7.45313 6.07031 5.95313C6.07031 3.49219 8.0625 1.5 10.5234 1.5C12.9844 1.5 14.9766 3.49219 14.9766 5.95313Z",fill:e}),s.jsx("path",{d:"M16.5 16.5V13.5H15V18H19.5V16.5H16.5Z",fill:e})]}),tn=e=>s.jsx(r.Icon,{component:()=>s.jsx(Zd,m({},e))}),Yd=r.withDynamicSchemaProps(e=>{var v;const t=C.useField();r.useDesignable();const o=r.useCollectionParentRecordData(),n=r.useAPIClient(),{t:a}=V.useTranslation(),[i,c]=y.useState(),[l,p]=y.useState(!1),d=Lo(),u=((v=e==null?void 0:e.value)==null?void 0:v.type)||te.audit,{token:f}=r.useToken(),h=(M,...L)=>G(this,[M,...L],function*(I,O=Ae.read){try{yield n.request({method:"post",url:`/notifications:update?filterByTk=${I}`,data:{is_read:O}}),e.value.is_read=Ae.read}catch(Z){}}),F=()=>G(this,null,function*(){var M;const{is_read:I,id:O}=e.value;if(I!==Ae.read&&h(O),c(u===te.audit?e.value.auditsJobId:e.value.nodeId),u===te.notify){const{nodeId:L,workflowId:Z,workflows:q}=e.value;if(!(L&&Z)){g();return}const H=q.nodes.filter(se=>se.id===L)[0];let Y=(M=H==null?void 0:H.config)==null?void 0:M.configure;if(!Y){g();return}if(Y=D.findSchema(new C.Schema(Y),se=>se["x-initializer"]==="AddBlockButton_AuditCard"),!Object.values((Y==null?void 0:Y.properties)||{}).length){g();return}}p(!0)}),g=()=>{var I;(I=d==null?void 0:d.service)==null||I.refresh()},b=()=>{var I;(I=d==null?void 0:d.service)==null||I.refresh(),p(!1)},k=I=>u===te.audit?s.jsx(Ro,{id:I.jobId}):u===te.notify?s.jsx(Wo,m({},I)):null,_=t.value.type===te.audit,T=()=>_?s.jsx(tn,{}):s.jsx(en,{color:"#000"}),A=I=>{var O;if(I.type===te.notify){const{nodeId:M,workflowId:L,workflows:Z}=I;if(!(M&&L))return!1;const q=Z.nodes.filter(Y=>Y.id===M)[0];let H=(O=q==null?void 0:q.config)==null?void 0:O.configure;return!(!H||(H=D.findSchema(new C.Schema(H),Y=>Y["x-initializer"]==="AddBlockButton_AuditCard"),!Object.values((H==null?void 0:H.properties)||{}).length))}return I.type===te.audit};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:K.cx("message-information",{"message-information-clickable":A(t.value)},_?K.css`
                ${CSS.supports("mask-composite","exclude")?`&::before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  border-radius: 6px;
                  padding: 1px;
                  background: ${f.xwColorPrimary};
                  mask:
                    linear-gradient(#fff 0 0) content-box,
                    linear-gradient(#fff 0 0);
                  mask-composite: exclude;
                }`:`border: 1px solid ${f.colorPrimary}`}
              `:K.css`
                border: 1px solid #bcbed3;
              `),onClick:F,children:[s.jsxs("div",{className:K.cx("message-information-head",{"message-information-head-todo":_,"message-information-head-notification":!_}),children:[s.jsx(T,{}),s.jsx("div",{className:"message-information-head-title",children:e.value.action})]}),s.jsxs("div",{className:"message-information-body",children:[s.jsx(r.ReadPretty.Html,{className:"message-information-desc",value:e.value.desc}),s.jsx(r.RecordProvider,{record:t.value,parent:o,children:e.children})]})]}),s.jsx(N.Drawer,{title:a("msgviewInfo"),open:l,width:D.DEVICE_TYPE==="pc"?"60%":"100%",destroyOnClose:!0,footer:Ct,onClose:b,children:s.jsx(k,w(m({},e.value),{jobId:i}))})]})}),Xd=r.genStyleHook("nb-list",e=>{const{componentCls:t}=e;return{[t]:{width:"100%",marginBottom:0,"&:hover":{"> .general-schema-designer":{display:"block"}},"> .general-schema-designer":{position:"absolute",zIndex:999,top:"0",bottom:"0",left:"0",right:"0",display:"none",background:"var(--colorBgSettingsHover)",border:"0",pointerEvents:"none","> .general-schema-designer-icons":{position:"absolute",right:"2px",top:"2px",lineHeight:"16px",pointerEvents:"all",".ant-space-item":{backgroundColor:"var(--colorSettings)",color:"#fff",lineHeight:"16px",width:"16px",paddingLeft:"1px"}}},".message-information":{borderRadius:`${e.borderRadiusBlock}px`,position:"relative","&-clickable":{cursor:"pointer","&:hover::before":{padding:"2px"}},"&-head":{color:"#000",fontSize:"14px",fontWeight:600,minHeight:"42px",display:"flex",alignItems:"center",padding:"0 15px"},"&-head-todo":{background:e.xwColorPrimary,color:"#fff",borderTopLeftRadius:"6px",borderTopRightRadius:"6px"},"&-head-notification":{borderBottom:"1px solid #bcbed3"},"&-head-title":{marginLeft:"6px"},"&-body":{padding:"12px 15px"}}}}}),Qd=()=>{var d;const e=r.useDataBlockHeight(),t=C.useFieldSchema(),{token:o}=N.theme.useToken(),{designable:n}=r.useDesignable(),{heightProps:a}=r.useBlockHeightProps()||{},{title:i}=a||{};if(!e)return;const c=i?o.fontSizeLG*o.lineHeightLG+o.padding*2-1:0,p=Object.keys(((d=t.parent.properties.actionBar)==null?void 0:d.properties)||{}).length>0||n?o.controlHeight+2*o.marginLG:o.marginLG;return e-c-p-o.marginLG},Wd=e=>{var T,A,v,I;const{service:t}=Lo(),{run:o,params:n}=t,a=C.useFieldSchema(),i=r.useDesigner(),c=(T=t==null?void 0:t.data)==null?void 0:T.meta,l=C.useField(),[p]=y.useState(new Map),{wrapSSR:d,componentCls:u,hashId:f}=Xd(),h=Qd(),{token:F}=r.useToken(),g=((v=(A=a==null?void 0:a.parent)==null?void 0:A["x-decorator-props"])==null?void 0:v.columnCount)||cc,b=O=>{const M=["action","desc"];!O||typeof O!="object"||O.properties&&Object.keys(O.properties).forEach(L=>{M.includes(L)?O.properties[L]["x-hidden"]=!0:b(O.properties[L])})},k=y.useCallback(O=>{if(!p.has(O)){const M=m({},a.properties.item);b(M),p.set(O,new C.Schema({type:"object",properties:{[O]:M}}))}return p.get(O)},[a.properties,p]),_=y.useCallback((O,M)=>{o(w(m({},n==null?void 0:n[0]),{page:O,pageSize:M}))},[o,n]);return d(s.jsx(r.SchemaComponentOptions,{children:s.jsxs(r.SortableItem,{className:K.cx("nb-list",u,f,K.css`
            .nb-list-container {
              height: ${h?h+"px":"100%"};
              overflow-y: ${h?"auto":null};
              margin-left: -${F.marginLG}px;
              margin-right: -${F.marginLG}px;
              padding-left: ${F.marginLG}px;
              padding-right: ${F.marginLG}px;
            }
          `),children:[s.jsx("div",{className:"nb-list-container",children:s.jsx(N.List,w(m({},e),{pagination:!c||c.count<=c.pageSize?!1:{onChange:_,total:(c==null?void 0:c.count)||0,pageSize:(c==null?void 0:c.pageSize)||10,current:(c==null?void 0:c.page)||1},grid:w(m({},g),{sm:g.xs,xl:g.lg,gutter:[Vo,Vo]}),dataSource:((I=t==null?void 0:t.data)==null?void 0:I.data)||[],loading:t.loading,renderItem:(O,M)=>l.value[M]?s.jsx(N.List.Item,{children:s.jsx(C.RecursionField,{basePath:l.address,name:M,onlyRenderProperties:!0,schema:k(M)},M)}):null}))}),s.jsx(i,{})]})}))},at=r.withDynamicSchemaProps(Wd);at.Item=Yd,at.Designer=Kd,at.Decorator=dc;const on=e=>({type:"void","x-decorator":"AuditTodo.Decorator","x-decorator-props":e["x-decorator-props"],"x-component":"BlockItem","x-component-props":{},"x-settings":"blockSettings:auditTodo",properties:{actions:{type:"void","x-initializer":"auditTodo:configureActions","x-component":"ActionBar","x-component-props":{showTitle:!0},properties:{refresher:{type:"void",title:'{{ t("Refresh") }}',"x-action":"refresh","x-component":"Action","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:refresh","x-component-props":{icon:"ReloadOutlined",useProps:"{{ useRefreshActionProps }}"},"x-align":"right"}}},todos:{type:"void","x-component":"AuditTodo"}}}),nn=e=>({$and:[{nodeTag:{$eq:e}},{status:{$eq:x.JOB_STATUS.PENDING}},{job:{status:{$eq:0}}},{user:{id:{$eq:"{{$user.id}}"}}}]}),Rd=()=>{const{t:e}=Be(),{insert:t,setVisible:o}=r.useSchemaInitializer(),{getTemplatesByComponentName:n,getTemplateSchemaByMode:a}=r.useSchemaTemplateManager(),i=n(Mt),c=u=>G(this,null,function*(){const{item:f}=u;if(f.template){const h=yield a(f);t(h)}o(!1)}),l=r.useGetSchemaInitializerMenuItems(c),p="workflowAuditTodosBlock",d=[{key:p,label:e("Workflow Audit todos",{ns:S}),icon:s.jsx(r.Icon,{type:"CheckSquareOutlined"}),children:l([{label:e("Enter todos",{ns:S}),Component:"AuditEnterTodoBlockInitializer"},{label:e("Approval todos",{ns:S}),Component:"AuditApprovalTodoBlockInitializer"},{type:"divider"},{type:"subMenu",name:"copy",title:e("Duplicate template"),children:i.map(u=>{const f=u==null?void 0:u.name;return{type:"item",mode:"copy",name:u.collectionName,template:u,title:f||e("Untitled")}})},{type:"subMenu",name:"ref",title:e("Reference template"),children:i.map(u=>{const f=u==null?void 0:u.name;return{type:"item",mode:"reference",name:u.collectionName,template:u,title:f||e("Untitled")}})}],p)}];return s.jsx(r.SchemaInitializerMenu,{items:d})},ep=()=>{const e=r.useSchemaInitializerItem(),{insert:t}=r.useSchemaInitializer();return s.jsx(r.SchemaInitializerItem,w(m({},e),{onClick:()=>{t(on({"x-decorator-props":{params:{filter:nn(Le.ENTER),pageSize:12}}}))}}))},tp=()=>{const e=r.useSchemaInitializerItem(),{insert:t}=r.useSchemaInitializer();return s.jsx(r.SchemaInitializerItem,w(m({},e),{onClick:()=>{t(on({"x-decorator-props":{params:{filter:nn(Le.APPROVE),pageSize:12}}}))}}))},op=()=>({type:"void","x-decorator":"MessageInformation.Decorator","x-decorator-props":{collection:"notifications",resource:"notifications",action:"list",rowKey:"id",readPretty:!0,params:{pageSize:10,sort:["-createdAt"]}},"x-component":"CardItem","x-toolbar":"BlockSchemaToolbar","x-settings":"blockSettings:messageInformation",properties:{actionBar:{type:"void","x-initializer":"messageInformation:configureActions","x-component":"ActionBar","x-component-props":{style:{marginBottom:"var(--nb-spacing)"}}},list:{type:"array","x-component":"MessageInformation",properties:{item:{type:"object","x-component":"MessageInformation.Item","x-read-pretty":!0,properties:{grid:{type:"void","x-component":"Grid","x-initializer":"details:configureFields"}}}}}}}),np=()=>{const{t:e}=Be(),{insert:t,setVisible:o}=r.useSchemaInitializer(),{getTemplatesByComponentName:n,getTemplateSchemaByMode:a}=r.useSchemaTemplateManager(),i=n(Vt),c=u=>G(this,null,function*(){const{item:f}=u;if(f.template){const h=yield a(f);t(h)}o(!1)}),l=r.useGetSchemaInitializerMenuItems(c),p="messageInformationBlock",d=[{key:p,label:e("Message",{ns:S}),icon:s.jsx(r.Icon,{type:"NotificationOutlined"}),children:l([{label:e("Blank block",{ns:S}),Component:"MessageBlockComponent"},{type:"divider"},{type:"subMenu",name:"copy",title:e("Duplicate template",{ns:S}),children:i.map(u=>{const f=u==null?void 0:u.name;return{type:"item",mode:"copy",name:u.collectionName,template:u,title:f||e("Untitled")}})},{type:"subMenu",name:"ref",title:e("Reference template",{ns:S}),children:i.map(u=>{const f=u==null?void 0:u.name;return{type:"item",mode:"reference",name:u.collectionName,template:u,title:f||e("Untitled")}})}],p)}];return s.jsx(r.SchemaInitializerMenu,{items:d})},rp=()=>{const e=r.useSchemaInitializerItem(),{insert:t}=r.useSchemaInitializer();return s.jsx(r.SchemaInitializerItem,w(m({},e),{onClick:()=>{t(op())}}))},{TextArea:sp}=N.Input,ap=e=>{const{form:t}=r.useFormBlockContext(),{userJob:o}=x.useFlowContext(),{t:n}=V.useTranslation(),a=t.pattern?!!["readPretty","disabled"].includes(t.pattern):!1,i=J.get(o,"comment");return a?null:s.jsxs("div",{children:[s.jsx(N.Typography.Title,{level:5,children:n("Comments: ",{ns:S})}),s.jsx(sp,{onChange:c=>{t.setValuesIn("WORKFLOWCOMMENTS",c.target.value)},defaultValue:i,rows:4})]})},ip=e=>{const{insert:t}=r.useSchemaInitializer(),o=r.useSchemaInitializerItem();return s.jsx(r.SchemaInitializerItem,w(m({},o),{onClick:()=>{t({type:"void","x-settings":"workflowCommentBlockSchemaSettings","x-decorator":"BlockItem","x-decorator-props":{name:"workflowComment"},"x-component":"WorkflowComment","x-component-props":{}})}}))},cp=e=>s.jsx(r.SchemaComponentOptions,{components:{WorkflowComment:ap,WorkflowCommentBlockInitializer:ip},children:e.children}),lp=new r.SchemaSettings({name:"workflowCommentBlockSchemaSettings",items:[{name:"delete",type:"remove",useComponentProps(){return{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}}]}),dp=new r.SchemaSettings({name:"blockSettings:auditTodo",items:[{name:"SetBlockTitle",Component:r.SchemaSettingsBlockTitleItem},{name:"SetTheDataScope",Component:r.SchemaSettingsDataScope,useComponentProps(){var i,c;const{name:e}=r.useCollection_deprecated(),t=C.useFieldSchema(),{form:o}=r.useFormBlockContext(),n=C.useField(),{dn:a}=r.useDesignable();return{collectionName:e,defaultFilter:((c=(i=t==null?void 0:t["x-decorator-props"])==null?void 0:i.params)==null?void 0:c.filter)||{},form:o,onSubmit:({filter:l})=>{l=r.removeNullCondition(l),J.set(t,"x-decorator-props.params.filter",l),n.decoratorProps.params=m({},t["x-decorator-props"].params),a.emit("patch",{schema:{"x-uid":t["x-uid"],"x-decorator-props":t["x-decorator-props"]}})}}}},{name:"SetTheDataPower",Component:r.SchemaSettingsTablePower,useComponentProps(){var i,c;const{name:e}=r.useCollection_deprecated(),t=C.useFieldSchema(),{form:o}=r.useFormBlockContext(),n=C.useField(),{dn:a}=r.useDesignable();return{collectionName:e,defaultFilter:((c=(i=t==null?void 0:t["x-decorator-props"])==null?void 0:i.params)==null?void 0:c.power)||{},form:o,onSubmit:({power:l})=>{l=r.removeNullCondition(l),J.set(t,"x-decorator-props.params.power",l),n.decoratorProps.params=m({},t["x-decorator-props"].params),a.emit("patch",{schema:{"x-uid":t["x-uid"],"x-decorator-props":t["x-decorator-props"]}})}}}},{name:"SetDefaultSortingRules",type:"modal",useComponentProps(){var p,d;const{name:e}=r.useCollection_deprecated(),{t}=V.useTranslation(),o=C.useFieldSchema(),n=C.useField(),{dn:a}=r.useDesignable(),i=r.useSortFields(e),c=((d=(p=o==null?void 0:o["x-decorator-props"])==null?void 0:p.params)==null?void 0:d.sort)||[],l=c==null?void 0:c.map(u=>u.startsWith("-")?{field:u.substring(1),direction:"desc"}:{field:u,direction:"asc"});return{title:t("Set default sorting rules"),components:{ArrayItems:ue.ArrayItems},schema:{type:"object",title:t("Set default sorting rules"),properties:{sort:{type:"array",default:l,"x-component":"ArrayItems","x-decorator":"FormItem",items:{type:"object",properties:{space:{type:"void","x-component":"Space",properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},field:{type:"string",enum:i,required:!0,"x-decorator":"FormItem","x-component":"Select","x-component-props":{style:{width:260}}},direction:{type:"string","x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{optionType:"button"},enum:[{label:t("ASC"),value:"asc"},{label:t("DESC"),value:"desc"}]},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:t("Add sort field"),"x-component":"ArrayItems.Addition"}}}}},onSubmit:({sort:u})=>{const f=u.map(h=>h.direction==="desc"?`-${h.field}`:h.field);J.set(o,"x-decorator-props.params.sort",f),n.decoratorProps.params=m({},o["x-decorator-props"].params),a.emit("patch",{schema:{"x-uid":o["x-uid"],"x-decorator-props":o["x-decorator-props"]}})}}}},{name:"RecordsPerPage",type:"select",useComponentProps(){var a,i;const{t:e}=V.useTranslation(),t=C.useFieldSchema(),o=C.useField(),{dn:n}=r.useDesignable();return{title:e("Records per page"),value:((i=(a=o.decoratorProps)==null?void 0:a.params)==null?void 0:i.pageSize)||12,options:eo.map(c=>({value:c})),onChange:c=>{J.set(t,"x-decorator-props.params.pageSize",c),o.decoratorProps.params=w(m({},t["x-decorator-props"].params),{page:1}),n.emit("patch",{schema:{"x-uid":t["x-uid"],"x-decorator-props":t["x-decorator-props"]}})}}}},{name:"ConvertReferenceToDuplicate",Component:r.SchemaSettingsTemplate,useComponentProps(){var n;const{name:e}=r.useCollection_deprecated(),t=C.useFieldSchema(),o=(n=t==null?void 0:t["x-decorator-props"])==null?void 0:n.resource;return{componentName:Mt,collectionName:e,resourceName:o}}},{name:"divider",type:"divider"},{name:"editTheme",Component:r.SchemaSettingsThemeEditItem,useComponentProps(){const{t:e}=V.useTranslation();return{title:e("Block theme")}}},{name:"mobileAdaptation",Component:r.SchemaSettingsMobileAdaptation},{name:"divider2",type:"divider"},{name:"delete",type:"remove",useComponentProps(){return{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}}]}),pp=ze.createStyles(({token:e,css:t})=>({sticky:{position:"sticky",top:0,zIndex:2,backgroundColor:"#fff"},search:t`
    flex: 1;
    margin-right: 8px;
  `,searchWrapper:t`
    display: flex;
    alignitems: center;
  `})),up=ze.createStyles(({token:e,css:t})=>({itemWrapper:{borderRadius:"8px",border:"1px solid #E5E7EB",background:"#fff",marginBottom:"16px",overflow:"hidden"},title:{display:"flex",alignItems:"center",borderBottom:"1px solid #E5E7EB",height:"40px",paddingLeft:"15px"},bold:{marginLeft:"8px",fontWeight:600,fontSize:"14px",lineHeight:"15px"},desc:{margin:"12px 0",lineHeight:"20px",paddingLeft:"15px",color:"#6B7280",fontSize:"14px"},time:{paddingLeft:"15px",marginBottom:"12px",color:"#9CA3AF",fontSize:"12px"},section:t`
    padding: 0 16px 40px;
  `,empty:t`
    display: flex;
    justify-content: center;
    align-items: center;
  `})),mp=ze.createStyles(({token:e,css:t})=>({wrapper:t`
    border-top: 1px solid rgba(5, 5, 5, 0.06);
    display: flex;
    justify-content: center;
    background-color: #fff;
    align-items: center;
    height: 40px;
    position: fixed;
    bottom: 0;
    width: 50%;
    z-index: 2;

    .ant-pagination {
      .ant-pagination-options {
        display: none;
      }
    }
  `})),fp=ze.createStyles(({token:e,css:t})=>({header:t`
    display: flex;
    padding: 16px;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 2;
    background-color: #fff;
  `,search:t`
    flex: 1;
    margin-right: 10px;
  `}));function rn(e){const t=y.useCallback(()=>{const{name:n}=r.useCollection_deprecated();return{options:r.useFilterOptions(n),onSubmit(i){e.handleFilter(i)},onReset(i){e.handleFilter(i,!0)}}},[]),o={type:"void",name:me.uid(),properties:{filter:{type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-component":"Filter.Action","x-component-props":{icon:"FilterOutlined",useProps:"{{ useFilterActionProps }}"},default:e.defaultValue}}};return s.jsx(r.ExtendCollectionsProvider,{collections:[Tt,jo,zo],children:s.jsx(r.SanitizedCollectionProvider,{name:Tt.name,children:s.jsx(r.SchemaComponent,{schema:o,scope:{useFilterActionProps:t}})})})}function sn(e){const{styles:t}=mp(),[o,n]=y.useState(1);y.useEffect(()=>{n(1)},[e.resetBool]);function a(i){n(i),e.handleChangePage(i)}return s.jsx("div",{className:t.wrapper,style:{bottom:D.isMobile&&e.type==="index"?"88px":"0",width:D.isMobile?"100%":"50%"},children:s.jsx(N.Pagination,{pageSize:e.size,simple:!0,current:o,total:e.total,onChange:a})})}function it(e){return e.type==="todo"?s.jsx(tn,{}):e.type==="msg"?s.jsx(en,{color:"#000"}):e.type==="clear"?s.jsx(ae.DeleteOutlined,{style:{fontSize:"16px"}}):s.jsx(ae.InboxOutlined,{style:{fontSize:"16px"}})}function hp(){return s.jsx("div",{style:{display:"flex",justifyContent:"center",flexDirection:"column",alignItems:"center"},children:s.jsx(N.Empty,{description:s.jsx("span",{style:{marginTop:"10px",color:"#E6E6E6",fontSize:"16px"},children:"Oops, it's a bit empty in here..."})})})}function gp(e){const t=typeof e=="object"?e:new Date(e),o=t.getFullYear(),n=t.getMonth()+1>9?t.getMonth()+1:"0"+(t.getMonth()+1),a=t.getDate()>9?t.getDate():"0"+t.getDate(),i=t.getHours()>9?t.getHours():"0"+t.getHours(),c=t.getMinutes()>9?t.getMinutes():"0"+t.getMinutes(),l=t.getSeconds()>9?t.getSeconds():"0"+t.getSeconds();return`${o}-${n}-${a} ${i}:${c}:${l}`}function an(e){const{styles:t}=up(),{t:o}=V.useTranslation(),n=r.useAPIClient(),{token:a}=r.useToken(),[i,c]=y.useState(""),[l,p]=y.useState(!1),[d,u]=y.useState(""),[f,h]=y.useState("todo"),[F,g]=y.useState({}),b=()=>K.css`
    position: relative;
    cursor: pointer;

    .item_title {
      border-bottom: none;
      &::after {
        content: '';
        width: 100%;
        height: 1px;
        background: ${a.xwColorPrimary};
        position: absolute;
        top: 40px;
        left: 0;
      }
    }

    ${CSS.supports("mask-composite","exclude")?`
    border: none !important;
    &::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: ${a.borderRadiusBlock}px;
      padding: 1px;
      background: ${a.xwColorPrimary};
      mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      mask-composite: exclude;
    }

    &:hover::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: ${a.borderRadiusBlock}px;
      padding: 2px;
      background: ${a.xwColorPrimary};
      mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      mask-composite: exclude;
    }`:`
    border: 1px solid ${a.colorPrimary}!important`}
  `;function k(v){return G(this,null,function*(){var I;if(v.type==="todo"&&(c(v.auditsJobId),u(v.id),h("todo"),p(!0)),v.type==="msg"&&v.canOpenDrawerBool&&(h("msg"),g(v),p(!0)),String(v.is_read)!=="1")try{yield n.request({method:"post",url:`/notifications:update?${Bt({filterByTk:v.id})}`,data:{is_read:1}}),(I=e==null?void 0:e.handleClickItem)==null||I.call(e,v.id)}catch(O){D.captureException(O)}})}function _(){var v;(v=e==null?void 0:e.handleClickItem)==null||v.call(e,d)}const{data:T,loading:A}=e;return s.jsxs(s.Fragment,{children:[s.jsxs("section",{style:{minHeight:e.type==="index"?"calc(100% - 130px)":"calc(100% - 75px)"},className:`${t.section} ${T.length===0&&!A&&t.empty}`,children:[T.length>0&&!A&&T.map(v=>s.jsxs("div",{className:`${t.itemWrapper} ${v.canOpenDrawerBool&&b()}`,onClick:()=>k(v),children:[s.jsxs("div",{className:K.cx("item_title",t.title),style:{background:v.type==="todo"?a.xwColorPrimary:"#fff",color:v.type==="todo"?"#fff":"#111928"},children:[s.jsx(it,{type:v.type}),s.jsx("span",{className:t.bold,children:v.action})]}),s.jsx(r.ReadPretty.Html,{className:t.desc,value:v.desc}),s.jsx("div",{className:t.time,children:gp(v.createdAt)})]},v.id)),T.length===0&&!A&&s.jsx(hp,{}),A&&s.jsx(N.Skeleton,{active:!0,paragraph:{rows:4}})]}),s.jsx(N.Drawer,{title:o("msgviewInfo"),destroyOnClose:!0,width:D.isMobile?"100%":"50%",footer:Ct,onClose:()=>p(!1),open:l,children:f==="todo"?s.jsx(Ro,{id:i,handleRefresh:_}):s.jsx(Wo,m({},F))})]})}const{Search:Cp}=N.Input;function cn(e){const{styles:t}=fp(),o=r.useAPIClient(),[n,a]=y.useState({open:!1,keyword:"",filter:"",page:1,size:15,data:[],loading:!0,loadDataBool:!1,total:1,tabChangeBool:!1,defaultFilterValue:{$and:[]}});y.useEffect(()=>{if(!n.open){a(I=>w(m({},I),{defaultFilterValue:e.defaultFilter,keyword:"",filter:JSON.stringify(e.defaultFilter)}));return}const A={filter:n.filter,kw:n.keyword,sort:"-updated_at",pageSize:n.size,page:n.page};G(this,null,function*(){try{const{data:I}=yield o.request({method:"get",url:`/notifications:list?${Bt(A)}`});a(O=>{var M,L;return w(m({},O),{loading:!1,data:ln(I==null?void 0:I.data),total:(L=(M=I==null?void 0:I.meta)==null?void 0:M.count)!=null?L:1})})}catch(I){D.captureException(I)}})},[n.loadDataBool,n.open]);function i(A){a(v=>w(m({},v),{open:A}))}function c(A){a(v=>w(m({},v),{keyword:A,page:1,loading:!0,loadDataBool:!v.loadDataBool,tabChangeBool:!v.tabChangeBool}))}function l(A,v){let I="",O={$and:[]};A.filter?(I=JSON.stringify(v?e.defaultFilter:A.filter),O=v?e.defaultFilter:A.filter):I=JSON.stringify(e.defaultFilter),a(M=>w(m({},M),{filter:I,page:1,loading:!0,loadDataBool:!M.loadDataBool,tabChangeBool:!M.tabChangeBool,defaultFilterValue:O}))}function p(A){a(v=>w(m({},v),{loading:!0,loadDataBool:!v.loadDataBool,page:A}))}function d(A){const{value:v}=A.target;a(I=>w(m({},I),{keyword:v}))}function u(A){a(v=>w(m({},v),{data:v.data.map(I=>w(m({},I),{is_read:I.id===A?1:I.is_read}))}))}const{open:f,data:h,loading:F,total:g,tabChangeBool:b,keyword:k,defaultFilterValue:_,size:T}=n;return s.jsxs(s.Fragment,{children:[s.jsx(N.Button,{style:{marginLeft:"8px"},onClick:()=>i(!0),icon:s.jsx(it,{}),children:e.title}),s.jsxs(N.Drawer,{title:e.title,onClose:()=>i(!1),open:f,destroyOnClose:!0,width:D.isMobile?"100%":"50%",className:K.css`
          .ant-drawer-body {
            padding: 0px;
          }
        `,children:[s.jsxs("header",{className:t.header,children:[s.jsx("div",{className:t.search,children:s.jsx(Cp,{placeholder:"Search",value:k,allowClear:!0,onSearch:c,onInput:d})}),s.jsx("div",{children:s.jsx(rn,{handleFilter:l,defaultValue:_})})]}),s.jsx(an,{data:h,loading:F,type:"drawer",handleClickItem:u}),h.length>0&&s.jsx(sn,{total:g,size:T,handleChangePage:p,loading:F,resetBool:b})]})]})}const{Search:xp}=N.Input;function Bt(e){let t="";for(const o in e)t+=`${o}=${encodeURIComponent(e[o])}&`;return t.substring(0,t.length-1)}function ln(e){return e.map(t=>{var n,a;let o=!1;if(t.type==="todo"&&(o=!0),t.type==="msg"){const{nodeId:i,workflowId:c,workflows:l}=t;if(!(i&&c))o=!1;else{const p=(n=l==null?void 0:l.nodes)==null?void 0:n.filter(u=>u.id===i)[0];let d=(a=p==null?void 0:p.config)==null?void 0:a.configure;d?(d=D.findSchema(new C.Schema(d),u=>u["x-initializer"]==="AddBlockButton_AuditCard"),Object.values((d==null?void 0:d.properties)||{}).length?o=!0:o=!1):o=!1}}return w(m({},t),{canOpenDrawerBool:o})})}const Nt={$and:[{"auditsJobs.status":{$eq:x.JOB_STATUS.PENDING}},{"jobs.status":{$eq:x.JOB_STATUS.PENDING}},{type:{$eq:te.audit}}]},yp={$and:[{"auditsJobs.status":{$ne:x.JOB_STATUS.PENDING}},{"jobs.status":{$ne:x.JOB_STATUS.PENDING}},{type:{$eq:te.audit}}]},Dt={$and:[{is_read:{$eq:String(Ae.unread)}},{type:{$eq:te.notify}}]},bp={$and:[{is_read:{$eq:String(Ae.read)}},{type:{$eq:te.notify}}]},Ie={$or:[Nt,Dt]};function Sp(){const{t:e}=V.useTranslation(),{token:t}=r.useToken(),{styles:o}=pp(),n=r.useApp(),a=r.useAPIClient(),[i,c]=y.useState({open:!1,tabs:[{label:"All",value:"1",active:!0,filter:Ie},{label:"To-dos",value:"2",active:!1,filter:Nt},{label:"Unread",value:"3",active:!1,filter:Dt}],data:[],loading:!0,loadDataBool:!1,page:1,size:15,tabChangeBool:!1,keyword:"",total:1,filter:JSON.stringify(Ie),defaultFilterValue:Ie,mixCountData:[0,0,0],loadMinCountDataBool:!1}),[l,p]=y.useState(0),d=y.useMemo(()=>{var $;return($=i.tabs.filter(P=>P.active)[0])==null?void 0:$.value},[i.tabs]);y.useEffect(()=>{const $=()=>G(this,null,function*(){var j,X;const{data:E}=yield a.request({method:"get",url:"/notifications:num"});p((X=(j=E==null?void 0:E.data)==null?void 0:j.all)!=null?X:0)});$();const P=E=>{JSON.parse(E.data).type==="new_notification"&&$()};return n.ws.on("message",P),()=>{n.ws.off("message",P)}},[]),y.useEffect(()=>{if(!i.open&&!D.isMobile){c(E=>w(m({},E),{defaultFilterValue:Ie,keyword:"",filter:JSON.stringify(Ie),tabs:[{label:"All",value:"1",active:!0,filter:Ie},{label:"To-dos",value:"2",active:!1,filter:Nt},{label:"Unread",value:"3",active:!1,filter:Dt}]}));return}const $={filter:i.filter,kw:i.keyword,sort:"-created_at",pageSize:i.size,page:i.page};G(this,null,function*(){try{const{data:E}=yield a.request({method:"get",url:`/notifications:list?${Bt($)}`});c(j=>{var X,ee;return w(m({},j),{loading:!1,data:ln(E==null?void 0:E.data),total:(ee=(X=E==null?void 0:E.meta)==null?void 0:X.count)!=null?ee:1})})}catch(E){D.captureException(E)}})},[i.loadDataBool,i.open]),y.useEffect(()=>{if(!i.open&&!D.isMobile)return;G(this,null,function*(){var P,E;try{const{data:j}=yield a.request({method:"get",url:"/notifications:num"});c(X=>{var ee,oe,Te,R,z,re;return w(m({},X),{mixCountData:[(oe=(ee=j==null?void 0:j.data)==null?void 0:ee.all)!=null?oe:0,(R=(Te=j==null?void 0:j.data)==null?void 0:Te.todoCount)!=null?R:0,(re=(z=j==null?void 0:j.data)==null?void 0:z.unreadMsgCount)!=null?re:0]})}),p((E=(P=j==null?void 0:j.data)==null?void 0:P.all)!=null?E:0)}catch(j){D.captureException(j)}})},[i.loadMinCountDataBool,i.open]);function u($){c(P=>w(m({},P),{open:$}))}function f($){i.tabs[$].active||c(P=>w(m({},P),{tabs:P.tabs.map((E,j)=>w(m({},E),{active:String(j)===$})),loading:!0,loadDataBool:!P.loadDataBool,page:1,tabChangeBool:!P.tabChangeBool,filter:JSON.stringify(i.tabs[$].filter),keyword:"",defaultFilterValue:i.tabs[$].filter}))}function h($){c(P=>w(m({},P),{loading:!0,loadDataBool:!P.loadDataBool,page:$}))}function F($){c(P=>w(m({},P),{loading:!0,loadDataBool:!P.loadDataBool,page:1,keyword:$,tabChangeBool:!P.tabChangeBool}))}function g($,P){c(E=>{const j=E.tabs.filter(oe=>oe.active)[0].filter;let X="",ee={$and:[]};return $.filter?(X=JSON.stringify(P?j:$.filter),ee=P?j:$.filter):X=JSON.stringify(j),w(m({},E),{loading:!0,loadDataBool:!E.loadDataBool,page:1,filter:X,tabChangeBool:!E.tabChangeBool,defaultFilterValue:ee})})}function b(){return G(this,null,function*(){try{yield a.request({method:"get",url:`/notifications:readAllNotifications?filter=${i.filter}`}),c($=>w(m({},$),{loadMinCountDataBool:!$.loadMinCountDataBool,page:1,loading:!0,loadDataBool:!$.loadDataBool}))}catch($){D.captureException($)}})}function k($){const{value:P}=$.target;c(E=>w(m({},E),{keyword:P}))}function _(){return s.jsxs(s.Fragment,{children:[s.jsx("div",{className:o.search,children:s.jsx(xp,{placeholder:"Search",value:H,allowClear:!0,onSearch:F,onInput:k})}),s.jsx("div",{children:s.jsx(rn,{handleFilter:g,defaultValue:Y})})]})}function T(){return s.jsxs(s.Fragment,{children:[d==="2"&&s.jsx(cn,{title:"Done",defaultFilter:yp}),d==="3"&&s.jsx(cn,{title:"Read",defaultFilter:bp}),d==="3"&&(D.isMobile?s.jsx(N.Button,{style:{width:"40px",marginLeft:"8px"},onClick:b,icon:s.jsx(it,{type:"clear"})}):s.jsx(N.Tooltip,{title:e("Mark all as read"),children:s.jsx(N.Button,{style:{width:"40px",marginLeft:"8px"},onClick:b,icon:s.jsx(it,{type:"clear"})})}))]})}function A($){c(P=>w(m({},P),{data:P.data.map(E=>w(m({},E),{is_read:E.id===$?1:E.is_read})),loadMinCountDataBool:!P.loadMinCountDataBool,loadDataBool:!P.loadDataBool}))}function v(){return s.jsxs(s.Fragment,{children:[s.jsxs("header",{className:o.sticky,style:{padding:D.isMobile?"0px 16px 16px":"16px"},children:[s.jsx(N.Tabs,{onChange:f,type:"card",className:K.css`
              .ant-tabs-nav-wrap {
                .ant-tabs-nav-list {
                  .ant-tabs-tab {
                    border-radius: 8px;
                    border: none;
                  }
                }
              }
            `,items:O.map(($,P)=>({label:s.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:[s.jsx("span",{children:$.label}),se[P]>0&&s.jsx("span",{style:{backgroundColor:$.active?"#fff":"#cfd2d8",fontSize:"12px",display:"inline-flex",justifyContent:"center",alignItems:"center",borderRadius:"20px",color:"#4b5563",padding:"0 6px",marginLeft:"8px",minWidth:"20px",height:"20px"},children:se[P]})]}),key:P.toString()}))}),s.jsxs("div",{className:o.searchWrapper,children:[_(),T()]})]}),s.jsx(an,{data:M,loading:L,type:"index",handleClickItem:A}),M.length>0&&s.jsx(sn,{total:q,size:Ce,handleChangePage:h,loading:L,resetBool:Z,type:"index"})]})}const{open:I,tabs:O,data:M,loading:L,tabChangeBool:Z,total:q,keyword:H,defaultFilterValue:Y,mixCountData:se,size:Ce}=i;return D.isMobile?v():s.jsxs(s.Fragment,{children:[s.jsx(N.Tooltip,{title:e("Notification"),children:s.jsxs("div",{style:{display:"inline-block",position:"relative"},children:[s.jsx(N.Button,{"data-testid":"notification-manager-button",icon:s.jsx(ae.BellOutlined,{style:{color:t.colorTextHeaderMenu}}),title:e("Notification"),onClick:()=>u(!0)}),l>0&&s.jsx("div",{style:{background:"#f40",width:"5px",height:"5px",position:"absolute",top:"16px",right:"13px",borderRadius:"50%",pointerEvents:"none"}})]})}),s.jsx(N.Drawer,{title:e("Notification"),onClose:()=>u(!1),open:I,destroyOnClose:!0,width:"50%",className:K.css`
          .ant-drawer-body {
            padding: 0px;
          }
        `,children:v()})]})}const vp=new r.SchemaInitializer({name:"auditTodo:configureActions",title:"{{t('Configure actions')}}",icon:"SettingOutlined",items:[{type:"itemGroup",title:"{{t('Enable actions')}}",name:"enableActions",children:[{name:"search",title:"{{t('Search')}}",Component:"AuditTodoSearchActionInitializer",schema:{"x-align":"left"}},{name:"filter",title:"{{t('Filter')}}",Component:"AuditTodoFilterActionInitializer",schema:{"x-align":"left"}},{name:"filterGroup",title:'{{t("Filter group")}}',Component:"AuditTodoFilterGroupActionInitializer",schema:{"x-align":"left"}},{name:"refresh",title:"{{t('Refresh')}}",Component:"RefreshActionInitializer",schema:{"x-align":"right"}}]}]}),wp=()=>{const{designable:e,insertBeforeEnd:t}=r.useDesignable(),{t:o}=V.useTranslation(),n=()=>({run(){t({type:"void",title:o("Filter"),default:me.uid(),"x-component":"Radio.Button","x-use-component-props":"useTodoListFilterButtonActionProps","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:auditTodoFilterButton"})}}),a={type:"void",properties:{add:{type:"void","x-component":"Action","x-component-props":{icon:"PlusOutlined",style:{borderColor:"var(--colorSettings)",color:"var(--colorSettings)"},type:"dashed",useAction:"{{ useInsertRadioButton }}"},title:'{{ t("Add filter button") }}'}}};return e?s.jsx(r.SchemaComponent,{schema:a,scope:{useInsertRadioButton:n}}):null},Fp=new r.SchemaInitializer({name:"action:auditTodoFilterGroup:add",popover:!1,Component:wp}),Ap=e=>{const t={type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:auditTodoFilter","x-component":"Filter.Action","x-use-component-props":"useTodoListFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"};return s.jsx(r.ActionInitializer,w(m({},e),{schema:t}))},Ip=e=>{const{t}=V.useTranslation(),o={type:"void","x-decorator":"BlockItem","x-toolbar":"ActionSchemaToolbar","x-toolbar-props":{showBorder:!0},"x-settings":"actionSettings:filterGroup",properties:{[me.uid()]:{type:"void","x-component":"Radio.Custom","x-use-component-props":"useTodoListFilterGroupActionProps","x-initializer":"action:auditTodoFilterGroup:add",properties:{[me.uid()]:{type:"void",title:t("Filter"),default:me.uid(),"x-component":"Radio.Button","x-use-component-props":"useTodoListFilterButtonActionProps","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:auditTodoFilterButton","x-index":1}}}}};return s.jsx(r.ActionInitializer,w(m({},e),{schema:o}))},Tp=e=>{const t={type:"void",title:'{{ t("Search") }}',"x-action":"search","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:auditTodoSearch","x-component":"Input.SearchAction","x-use-component-props":"useTodoListFilterActionProps"};return s.jsx(r.ActionInitializer,w(m({},e),{schema:t}))},kp=new r.SchemaInitializer({name:"messageInformation:configureActions",title:"{{t('Configure actions')}}",icon:"SettingOutlined",style:{marginLeft:8},items:[{type:"itemGroup",name:"enableActions",title:"{{t('Enable actions')}}",children:[{name:"filter",title:"{{t('Filter')}}",Component:"FilterActionInitializer",schema:{"x-align":"left"}},{name:"filterGroup",title:'{{t("Filter group")}}',Component:"FilterGroupActionInitializer",schema:{"x-align":"left"}},{name:"refresh",title:"{{t('Refresh')}}",Component:"RefreshActionInitializer",schema:{"x-align":"right"}}]}]}),_p=e=>{var a;const{getCollectionFields:t,getInterface:o}=r.useCollectionManager_deprecated(),n=t(e);return(a=n==null?void 0:n.filter)==null?void 0:a.call(n,i=>{if(!i.interface)return!1;const c=o(i.interface);return!!(c!=null&&c.filterable)})},dn=e=>()=>{var u,f;const t=C.useFieldSchema(),{dn:o}=r.useDesignable(),{name:n}=r.useCollection_deprecated(),a=_p(n),i=r.useCompile(),{t:c}=V.useTranslation(),l=((u=t==null?void 0:t["x-component-props"])==null?void 0:u.needFilterFields)||[],p=((f=t==null?void 0:t["x-component-props"])==null?void 0:f.extraCollections)||[],d=(h,F)=>{var b;t["x-component-props"]=(t==null?void 0:t["x-component-props"])||{};const g=((b=t==null?void 0:t["x-component-props"])==null?void 0:b.needFilterFields)||[];if(F)g.push(h);else{const k=g.indexOf(h);g.splice(k,1)}t["x-component-props"].needFilterFields=g,o.emit("patch",{schema:{"x-uid":t["x-uid"],"x-component-props":m({},t["x-component-props"])}}),o.refresh()};return s.jsxs(r.SchemaSettingsItemGroup,{title:c(e==="filter"?"Filterable fields":"Searchable fields"),children:[p&&p.map(h=>s.jsx(r.SchemaSettingsSubMenu,{title:h.title,children:h.children.map(F=>{var k;const g=`${h.name}.${F.name}`,b=l.includes(g);return s.jsx(r.SchemaSettingsSwitchItem,{checked:b,itemKey:g,title:i((k=F==null?void 0:F.uiSchema)==null?void 0:k.title),onChange:_=>{d(g,_)}},g)})},h.name)),a.map(h=>{var g;const F=l.includes(h.name);return s.jsx(r.SchemaSettingsSwitchItem,{checked:F,title:i((g=h==null?void 0:h.uiSchema)==null?void 0:g.title),onChange:b=>{d(h.name,b)}},h.name)})]})},Op=dn("filter"),Bp=dn("search"),Np=new r.SchemaSettings({name:"actionSettings:auditTodoSearch",items:[{name:"SearchableFields",Component:Bp},{name:"divider",type:"divider"},{name:"delete",type:"remove",componentProps:{removeParentsIfNoChildren:!0,breakRemoveOn:e=>e["x-component"]==="Space"||e["x-component"]==="ActionBar"}}]}),Dp=new r.SchemaSettings({name:"actionSettings:auditTodoFilter",items:[{name:"FilterableFields",Component:Op},{name:"divider",type:"divider"},{name:"EditButton",type:"modal",useComponentProps(){var a;const e=C.useField(),t=C.useFieldSchema(),{dn:o}=r.useDesignable(),{t:n}=V.useTranslation();return{title:n("Edit button"),schema:{type:"object",title:n("Edit button"),properties:{title:{"x-decorator":"FormItem","x-component":"Input",title:n("Button title"),default:t.title,"x-component-props":{}},icon:{"x-decorator":"FormItem","x-component":"IconPicker",title:n("Button icon"),default:(a=t==null?void 0:t["x-component-props"])==null?void 0:a.icon,"x-component-props":{}}}},onSubmit:({title:i,icon:c})=>{t.title=i,e.title=i,e.componentProps.icon=c,t["x-component-props"]=t["x-component-props"]||{},t["x-component-props"].icon=c,o.emit("patch",{schema:{"x-uid":t["x-uid"],title:i,"x-component-props":m({},t["x-component-props"])}}),o.refresh()}}}},{name:"divider1",type:"divider"},{name:"delete",type:"remove",componentProps:{removeParentsIfNoChildren:!0,breakRemoveOn:e=>e["x-component"]==="Space"||e["x-component"]==="ActionBar"}}]}),$p=new r.SchemaSettings({name:"blockSettings:messageInformation",items:[{name:"EditBlockTitle",Component:r.SchemaSettingsBlockTitleItem},{name:"EditBlockLayout",Component:r.SchemaSettingsBlockLayoutItem},{name:"SetTheCountOfColumnsDisplayedInARow",Component:r.SetTheCountOfColumnsDisplayedInARow},{name:"SetTheDataScope",Component:r.SchemaSettingsDataScope,useComponentProps(){var i,c;const{name:e}=r.useCollection_deprecated(),t=C.useFieldSchema(),{form:o}=r.useFormBlockContext(),n=C.useField(),{dn:a}=r.useDesignable();return{collectionName:e,defaultFilter:((c=(i=t==null?void 0:t["x-decorator-props"])==null?void 0:i.params)==null?void 0:c.filter)||{},form:o,onSubmit:({filter:l})=>{l=r.removeNullCondition(l),Fe(t,"x-decorator-props.params.filter",l),n.decoratorProps.params=w(m({},t["x-decorator-props"].params),{page:1}),a.emit("patch",{schema:{"x-uid":t["x-uid"],"x-decorator-props":t["x-decorator-props"]}})}}}},{name:"SetDefaultSortingRules",type:"modal",useComponentProps(){var p,d;const{name:e}=r.useCollection_deprecated(),{t}=V.useTranslation(),o=C.useFieldSchema(),n=C.useField(),{dn:a}=r.useDesignable(),i=r.useSortFields(e),c=((d=(p=o==null?void 0:o["x-decorator-props"])==null?void 0:p.params)==null?void 0:d.sort)||[],l=c==null?void 0:c.map(u=>u.startsWith("-")?{field:u.substring(1),direction:"desc"}:{field:u,direction:"asc"});return{title:t("Set default sorting rules"),components:{ArrayItems:ue.ArrayItems},schema:{type:"object",title:t("Set default sorting rules"),properties:{sort:{type:"array",default:l,"x-component":"ArrayItems","x-decorator":"FormItem",items:{type:"object",properties:{space:{type:"void","x-component":"Space",properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},field:{type:"string",enum:i,"x-decorator":"FormItem","x-component":"Select","x-component-props":{style:{width:260}}},direction:{type:"string","x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{optionType:"button"},enum:[{label:t("ASC"),value:"asc"},{label:t("DESC"),value:"desc"}]},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:t("Add sort field"),"x-component":"ArrayItems.Addition"}}}}},onSubmit:({sort:u})=>{const f=u.map(h=>h.direction==="desc"?`-${h.field}`:h.field);Fe(o,"x-decorator-props.params.sort",f),n.decoratorProps.params=w(m({},o["x-decorator-props"].params),{page:1}),a.emit("patch",{schema:{"x-uid":o["x-uid"],"x-decorator-props":o["x-decorator-props"]}})}}}},r.setDataLoadingModeSettingsItem,{name:"RecordsPerPage",type:"select",useComponentProps(){var a,i;const{t:e}=V.useTranslation(),t=C.useFieldSchema(),o=C.useField(),{dn:n}=r.useDesignable();return{title:e("Records per page"),value:((i=(a=o.decoratorProps)==null?void 0:a.params)==null?void 0:i.pageSize)||20,options:[{label:"10",value:10},{label:"20",value:20},{label:"50",value:50},{label:"80",value:80},{label:"100",value:100}],onChange:c=>{Fe(t,"x-decorator-props.params.pageSize",c),o.decoratorProps.params=w(m({},t["x-decorator-props"].params),{page:1}),n.emit("patch",{schema:{"x-uid":t["x-uid"],"x-decorator-props":t["x-decorator-props"]}})}}}},{name:"ConvertReferenceToDuplicate",Component:r.SchemaSettingsTemplate,useComponentProps(){var n,a;const{name:e}=r.useCollection_deprecated(),t=C.useFieldSchema(),o=((n=t==null?void 0:t["x-decorator-props"])==null?void 0:n.resource)||((a=t==null?void 0:t["x-decorator-props"])==null?void 0:a.association);return{componentName:Vt,collectionName:e,resourceName:o}}},{name:"divider",type:"divider"},{name:"editTheme",Component:r.SchemaSettingsThemeEditItem,useComponentProps(){const{t:e}=V.useTranslation();return{title:e("Block theme")}}},{name:"divider2",type:"divider"},{name:"delete",type:"remove",useComponentProps(){return{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}}]}),Pp=new r.SchemaSettings({name:"actionSettings:auditTodoFilterButton",items:[{name:"editButton",type:"modal",useComponentProps(){var a;const e=C.useField(),t=C.useFieldSchema(),{dn:o}=r.useDesignable(),{t:n}=V.useTranslation();return{title:n("Edit button"),schema:{type:"object",title:n("Edit button"),properties:{title:{"x-decorator":"FormItem","x-component":"Input",title:n("Button title"),default:t.title,required:!0},icon:{"x-decorator":"FormItem","x-component":"IconPicker",title:n("Button icon"),default:(a=t==null?void 0:t["x-component-props"])==null?void 0:a.icon}}},onSubmit:({title:i,icon:c})=>{e.title=i,e.componentProps.icon=c,t.title=i,t["x-component-props"]=t["x-component-props"]||{},t["x-component-props"].icon=c,o.emit("patch",{schema:{title:i,"x-uid":t["x-uid"],"x-component-props":t["x-component-props"]}}),o.refresh()}}}},{name:"filterRules",type:"modal",useComponentProps(){var F,g;const e=C.useFieldSchema(),{dn:t}=r.useDesignable(),{t:o}=V.useTranslation(),{name:n}=r.useCollection_deprecated(),a=r.useFilterOptions(n),i=mo(),c=(((F=e==null?void 0:e.parent)==null?void 0:F["x-extra-collections"])||[]).map(b=>{const k=i(b.name,b.fields);return k.length>0?{title:b.title,name:b.name,children:k}:void 0}).filter(Boolean),l=r.useRecord(),p=r.useVariables(),d=r.useLocalVariables(),{form:u}=r.useFormBlockContext(),{getAllCollectionsInheritChain:f}=r.useCollectionManager_deprecated(),h=y.useCallback(b=>s.jsx(r.DatePickerProvider,{value:{utc:!1},children:s.jsx(r.VariableInput,w(m({},b),{form:u,record:l,shouldChange:r.getShouldChange({collectionField:b.collectionField,variables:p,localVariables:d,getAllCollectionsInheritChain:f})}))}),[u,f,d,l,p]);return{title:o("Filter rules"),schema:{type:"object",title:o("Filter rules"),properties:{filter:{type:"object",enum:[...c,...a],default:((g=e==null?void 0:e["x-component-props"])==null?void 0:g.filter)||{},"x-component":"Filter","x-component-props":{dynamicComponent:h}}}},onSubmit:({filter:b})=>{e["x-component-props"]=e["x-component-props"]||{},e["x-component-props"].filter=b,t.emit("patch",{schema:{"x-uid":e["x-uid"],"x-component-props":e["x-component-props"]}}),t.refresh()}}}},{name:"divider",type:"divider"},{name:"delete",type:"remove",useComponentProps(){const e=C.useFieldSchema(),{getDataBlocks:t}=r.useFilterBlock();return{confirm:{onOk:()=>{t().map(o=>{Lt(e,o.uid)&&o.clearFilter(o.uid)})}}}}}]}),pn=e=>{e==null||e.add("showOnCover",{type:"switch",useComponentProps(){var a;const t=C.useFieldSchema(),{patch:o}=r.useDesignable(),{t:n}=Be();return{checked:((a=t["x-data"])==null?void 0:a.showOnCover)||!1,title:n("Show on cover"),onChange(i){o({"x-data":{showOnCover:i}})}}},useVisible(){const t=C.useFieldSchema();return D.isInAuditCard(t)}})};class un extends r.Plugin{afterAdd(){return G(this,null,function*(){})}beforeLoad(){return G(this,null,function*(){})}load(){return G(this,null,function*(){this.addBasicAuditCollection(),this.app.addScopes({useTodoListFilterActionProps:fo,useTodoListFilterGroupActionProps:Vr,useTodoListFilterButtonActionProps:Lr}),this.addComponents(),this.app.pm.get("workflow").registerInstruction("audit",Mr),this.app.schemaSettingsManager.add(dp),this.app.schemaSettingsManager.add(lp),this.app.schemaSettingsManager.add($p),this.app.use(cp),this.app.schemaInitializerManager.add(Fp),this.app.schemaInitializerManager.add(Hn),this.app.schemaInitializerManager.add(Zn),this.app.schemaInitializerManager.add(zn),this.app.schemaInitializerManager.add(vp),this.app.schemaInitializerManager.add(kp),this.app.schemaSettingsManager.add(Np),this.app.schemaSettingsManager.add(Dp),this.app.schemaSettingsManager.add(Pp);const o=this.app.schemaSettingsManager.get("fieldSettings:FormItem");pn(o);const n=this.app.schemaSettingsManager.get("fieldSettings:TableColumn");pn(n);const a=this.app.schemaInitializerManager.get("FormItemInitializers");a==null||a.add("workflowComment",{title:'{{t("Workflow Comment")}}',Component:"WorkflowCommentBlockInitializer",useVisible(){const c=C.useFieldSchema();return D.isInAuditCard(c)}}),a==null||a.add("popup",{title:'{{t("Popup")}}',Component:"PopupActionInitializer",useComponentProps(){return{"x-component":"Action.Link"}},useVisible(){const c=C.useFieldSchema();return D.isInAuditCard(c)}});const i=this.app.schemaInitializerManager.get("BlockInitializers");i.add("otherBlocks.workflowAuditTodosBlock",{Component:"AuditTodoBlockInitializer"}),i.add("otherBlocks.messageInformationBlock",{Component:"MessageBlockInitializer"})})}addComponents(){this.app.addComponents({WorkflowAuditTodo:gt,WorkflowAuditTodoBlockInitializer:es,AuditTodo:ho,AuditTodoBlockInitializer:Rd,AuditEnterTodoBlockInitializer:ep,AuditApprovalTodoBlockInitializer:tp,AuditCard:Pe,AuditCardFormCollapse:io,AuditTodoFilterActionInitializer:Ap,AuditTodoFilterGroupActionInitializer:Ip,AuditTodoSearchActionInitializer:Tp,MessageInformation:at,MessageBlockComponent:rp,MessageBlockInitializer:np,NotificationDrawer:Sp})}addBasicAuditCollection(){const t=this.app.dataSourceManager.getDataSource("main"),o=t.collectionManager;t.addReloadCallback(()=>{o.addCollections([Et,zt,Fn,jt])})}}B.AssigneesSelect=Pt,B.CardSchemaConfig=Yt,B.CardSchemaConfigButton=Xt,B.NAMESPACE=S,B.PluginWorkflowAuditClient=un,B.default=un,B.useSubmit=ye,Object.defineProperties(B,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
