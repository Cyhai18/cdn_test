(function(e,n){typeof exports=="object"&&typeof module!="undefined"?n(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("react"),require("@ant-design/icons"),require("@nocobase/plugin-workflow/client"),require("react-i18next"),require("antd"),require("@formily/react"),require("@nocobase/utils/client")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","react","@ant-design/icons","@nocobase/plugin-workflow/client","react-i18next","antd","@formily/react","@nocobase/utils/client"],n):(e=typeof globalThis!="undefined"?globalThis:e||self,n(e["@ashley/plugin-workflow-api-manager"]={},e["@nocobase/client"],e.jsxRuntime,e.react,e["@ant-design/icons"],e["@nocobase/plugin-workflow"],e["react-i18next"],e.antd,e["@formily/react"],e["@nocobase/utils"]))})(this,function(e,n,t,C,q,A,P,y,m,v){"use strict";var K=Object.defineProperty,N=Object.defineProperties;var B=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var T=(e,n,t)=>n in e?K(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,x=(e,n)=>{for(var t in n||(n={}))G.call(n,t)&&T(e,t,n[t]);if(M)for(var t of M(n))H.call(n,t)&&T(e,t,n[t]);return e},g=(e,n)=>N(e,B(n));var h=(e,n,t)=>(T(e,typeof n!="symbol"?n+"":n,t),t);var k=(e,n,t)=>new Promise((C,q)=>{var A=m=>{try{y(t.next(m))}catch(v){q(v)}},P=m=>{try{y(t.throw(m))}catch(v){q(v)}},y=m=>m.done?C(m.value):Promise.resolve(m.value).then(A,P);y((t=t.apply(e,n)).next())});const b="@ashley/plugin-workflow-api-manager";function j(o,a={}){const{t:l}=E(a);return l(o)}function E(o){return P.useTranslation(b,o)}const S=o=>o.filter(a=>a.status).map(a=>({value:a.name,label:a.name,children:a.configurations.filter(l=>l.status).map(l=>({value:l.name,label:l.name,data:l}))}));function L(o,a,l){var p,s,d;const c=typeof a=="object"&&a instanceof Array?a:[];if(!c.length)return[];let i=[];for(const u of o)if(u.value===c[0]&&u.children.length>0)for(const f of u.children)f.value===c[1]&&(i=(d=(s=(p=f.data)==null?void 0:p.config)==null?void 0:s.externalParams)!=null?d:[]);const r=i.map(u=>g(x({},u),{value:"",description:u.desc}));for(const u of r)for(const f of l)u.key===f.key&&(u.value=f.value);return r}function O(o){const a=(c,i)=>{var p,s,d,u,f,w,I;const r=(s=(p=i==null?void 0:i[1])==null?void 0:p.data)!=null?s:{};o.handleApicallChange({apiCall:c,call_api:{id:r==null?void 0:r.id,name:r==null?void 0:r.name},form:(u=(d=r==null?void 0:r.config)==null?void 0:d.subSequentParams)!=null?u:[],input:(I=(w=(f=r==null?void 0:r.config)==null?void 0:f.externalParams)==null?void 0:w.map(V=>g(x({},V),{value:"",description:V.desc})))!=null?I:[]})},l=(c,i)=>i.some(r=>r.label.toLowerCase().indexOf(c.toLowerCase())>-1);return t.jsx(y.Cascader,{value:o.value,options:o.options,onChange:a,showSearch:{filter:l}})}function _({record:o,idx:a,data:l,onChange:c}){const i=A.useWorkflowVariableOptions(),{token:r}=n.useToken(),p=n.css`
    .ant-input-affix-wrapper,
    .ant-input {
      border-color: ${r.colorBorder} !important;

      &:hover,
      &:focus-within {
        border-color: ${r.xwColorPrimaryHighlight} !important;
        box-shadow: 0 0 0 2px ${r.controlOutline} !important;
      }
    }
  `;function s(d,u){const f=l.map((w,I)=>I===u?g(x({},w),{value:d}):w);c(f)}return t.jsx("div",{className:!o.required||o.value?p:null,children:t.jsx(n.Variable.Input,{value:o.value,onChange:d=>{s(d,a)},scope:i,children:t.jsx(y.Input,{onChange:d=>{const{value:u}=d.target;s(u!=null?u:"",a)},value:o.value,allowClear:!0})})})}function F({value:o,onChange:a}){const l=typeof o=="object"&&o instanceof Array?o:[],c=[{title:`${j("Key label")}`,dataIndex:"label",key:"label",render(i,r){return t.jsxs("div",{children:[r.required&&t.jsx("span",{style:{color:"#f40"},children:"*"}),i]})}},{title:`${j("Description")}`,dataIndex:"desc",key:"desc"},{title:`${j("Value")}`,dataIndex:"value",key:"value",render:(i,r,p)=>t.jsx(_,{data:l,idx:p,record:r,onChange:a})}];return t.jsx(y.Table,{columns:c,dataSource:l,pagination:!1})}function W(o){const a=m.useForm(),l=n.useAPIClient(),[c,i]=C.useState([]);C.useEffect(()=>{const p=()=>k(this,null,function*(){try{const{data:s}=yield l.request({url:"/externalApis:list?appends[]=configurations",method:"get",data:{}});if(s!=null&&s.data){i(S(s.data));const d=L(S(s.data),o.value,a.values.input);a.setValues(g(x({},a.values),{input:d}))}}catch(s){v.captureException(s)}});a!=null&&a.editable&&p()},[]);const r=({apiCall:p,input:s,form:d,call_api:u})=>{a.setValues({callApi:p,input:s,form:d,call_api:u})};return t.jsx(O,{value:o.value,options:c,handleApicallChange:r})}class D extends A.Instruction{constructor(){super(...arguments);h(this,"title",`{{t("API call", { ns: "${b}" })}}`);h(this,"type","api-manager");h(this,"group","extended");h(this,"description",`{{t("Call the API and retrieve the processed data for use in subsequent workflow nodes.", { ns: "${b}" })}}`);h(this,"icon",t.jsx(q.GlobalOutlined,{}));h(this,"fieldset",{callApi:{type:"array",required:!0,title:`{{t("Call API", { ns: "${b}" })}}`,"x-decorator":"FormItem","x-component":"Comp"},input:{type:"array",title:`{{t("Input Params", { ns: "${b}" })}}`,"x-decorator":"FormItem","x-component":"TableComp","x-reactions":{dependencies:["callApi"],fulfill:{state:{value:"{{$form.values.input}}"}}},"x-validator"(l){const c=[];for(const i of l)i.required&&!i.value&&c.push(i.label);if(c.length>0)return`Key label '${c.join(",")}' value is required`}},failOnEmpty:{type:"boolean",title:`{{t("Ignore failed request and continue workflow", { ns: "${b}" })}}`,"x-decorator":"FormItem","x-component":"Checkbox"}});h(this,"components",{TableComp:F,Comp:W})}useVariables({key:l,title:c,config:i},r){var s;const p=((s=i==null?void 0:i.form)==null?void 0:s.map(d=>({value:d.key,label:d.title})))||[];return{value:l,label:c,children:p}}}class $ extends n.Plugin{afterAdd(){return k(this,null,function*(){})}beforeLoad(){return k(this,null,function*(){})}load(){return k(this,null,function*(){this.app.pm.get("workflow").registerInstruction("api-manager",D)})}}e.PluginWorkflowApiManagerClient=$,e.default=$,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
