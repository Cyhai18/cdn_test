(function(e,o){typeof exports=="object"&&typeof module!="undefined"?o(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@ant-design/icons"),require("@nocobase/plugin-workflow/client"),require("react-i18next"),require("react"),require("@nocobase/utils/client"),require("antd"),require("@formily/antd-v5"),require("@formily/react"),require("@ashley/plugin-multi-app-manager/client")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@ant-design/icons","@nocobase/plugin-workflow/client","react-i18next","react","@nocobase/utils/client","antd","@formily/antd-v5","@formily/react","@ashley/plugin-multi-app-manager/client"],o):(e=typeof globalThis!="undefined"?globalThis:e||self,o(e["@ashley/plugin-workflow-sub-workflow"]={},e["@nocobase/client"],e.jsxRuntime,e["@ant-design/icons"],e["@nocobase/plugin-workflow"],e["react-i18next"],e.react,e["@nocobase/utils"],e.antd,e["@formily/antd-v5"],e["@formily/react"],e["@ashley/plugin-multi-app-manager"]))})(this,function(e,o,r,A,c,S,k,y,s,d,C,q){"use strict";var $=Object.defineProperty,H=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var v=(e,o,r)=>o in e?$(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,h=(e,o)=>{for(var r in o||(o={}))z.call(o,r)&&v(e,r,o[r]);if(I)for(var r of I(o))B.call(o,r)&&v(e,r,o[r]);return e},x=(e,o)=>H(e,J(o));var p=(e,o,r)=>(v(e,typeof o!="symbol"?o+"":o,r),r);var b=(e,o,r)=>new Promise((A,c)=>{var S=s=>{try{y(r.next(s))}catch(d){c(d)}},k=s=>{try{y(r.throw(s))}catch(d){c(d)}},y=s=>s.done?A(s.value):Promise.resolve(s.value).then(S,k);y((r=r.apply(e,o)).next())});const w="@ashley/plugin-workflow-sub-workflow";function g(n,t={}){return o.i18n.t(n,x(h({},t),{ns:w}))}function V(n){const{style:t,value:l,onChange:f}=n,{workflow:a}=c.useFlowContext(),i=o.useAPIClient(),O=(a==null?void 0:a.config.collection)||"*",L=["action"],[E,U]=k.useState([]),K=()=>b(this,null,function*(){try{const u=JSON.stringify({type:L,enabled:!0,"config.collection":O}),{data:T}=yield i.request({url:`/workflows:list?paginate=false&filter=${encodeURIComponent(u)}`});if(T.data.length>0){const _=T.data.map(m=>({label:m.title,value:m.key,workflowType:m.type=="action"?g("Approval event"):g("Post-action event"),workflowModel:m.sync==!1?g("Async"):g("Sync"),workflowTypeColor:"processing",workflowModelColor:"success"}));U(_)}}catch(u){y.captureException(u)}});return k.useEffect(()=>{K()},[]),r.jsx(s.Select,{style:t,onChange:f,value:l,options:E,optionRender:u=>r.jsxs(s.Space,{children:[u.data.label,r.jsxs(s.Flex,{gap:"4px 0",children:[r.jsx(s.Tag,{bordered:!1,color:u.data.workflowTypeColor,children:u.data.workflowType}),r.jsx(s.Tag,{bordered:!1,color:u.data.workflowModelColor,children:u.data.workflowModel})]})]})})}function F(n){return n.isForeignKey?n.target==="users":n.collectionName==="users"&&n.name==="id"}function M({multiple:n=!1,value:t=[],onChange:l}){const f=c.useWorkflowVariableOptions({types:[F]});return r.jsx(o.Variable.Input,{scope:f,value:t[0],onChange:a=>{l([a])},children:r.jsx(o.RemoteSelect,{multiple:n,fieldNames:{label:"nickname",value:"id"},service:{resource:"users",params:{appendsUserList:t}},manual:!1,value:t[0],onChange:a=>{l(a!=null?[a]:[])}})})}function j({multiple:n=!1,value:t=[],onChange:l}){const f=c.useWorkflowVariableOptions(),a=k.useContext(q.CurrentManageAppInfoContext);return r.jsx(o.Variable.Input,{scope:f,value:t[0],onChange:i=>{l([i])},children:r.jsx(o.RemoteSelect,{multiple:n,fieldNames:{label:"title",value:"name"},service:{resource:"roles",params:{filter:{"associatedApp.applicationsId":{$eq:a.currentManageAppInfo.id}}}},manual:!1,value:t[0],onChange:i=>{l(i!=null?[i]:[])}})})}function N(n){const{value:t,onChange:l}=n,{token:f}=o.useToken(),a=o.css`
    margin-bottom: 1.5em;
    padding: 1em;
    background-color: ${f.colorFillAlter};
  `;return r.jsxs("div",{className:a,children:[r.jsx(C.Field,{name:"userActed",title:g("User acted"),decorator:[d.FormItem,{layout:"vertical"}],component:[M,{value:t==null?void 0:t.userActed,onChange(i){l(x(h({},t),{userActed:i}))}}],required:!0}),r.jsx(C.Field,{name:"roleActed",title:g("Role of user acted"),decorator:[d.FormItem,{layout:"vertical"}],component:[j,{value:t==null?void 0:t.roleActed,onChange(i){l(x(h({},t),{roleActed:i}))}}],required:!0})]})}class P extends c.Instruction{constructor(){super(...arguments);p(this,"title",`{{t("Sub Workflow", { ns: "${w}" })}}`);p(this,"type","sub-workflow");p(this,"group","control");p(this,"description",`{{t("Trigger another workflow using the same collection.", { ns: "${w}" })}}`);p(this,"icon",r.jsx(A.ThunderboltOutlined,{}));p(this,"fieldset",{subWorkflow:{type:"string",required:!0,title:`{{t("Sub-Workflow", { ns: "${w}" })}}`,"x-decorator":"FormItem","x-component":"SubWorkflowSelect","x-component-props":{style:{width:"100%"}},default:"",description:`{{t("Only workflows with the same collection as the trigger and of the type 'post-action event' or 'approval event' can be selected.", { ns: "${w}" })}}`},input:{type:"object",title:`{{t("Trigger Variables", { ns: "${w}" })}}`,"x-decorator":"FormItem","x-component":"TriggerVariablesArray","x-component-props":{multiple:!1},"x-validator"(l){}}});p(this,"components",{WorkflowVariableInput:c.WorkflowVariableInput,WorkflowVariableTextArea:c.WorkflowVariableTextArea,SubWorkflowSelect:V,TriggerVariablesArray:N})}useVariables(l){return{value:l.key,label:l.title}}isAvailable({engine:l,workflow:f}){return!0}}class W extends o.Plugin{afterAdd(){return b(this,null,function*(){})}beforeLoad(){return b(this,null,function*(){})}load(){return b(this,null,function*(){this.app.pm.get("workflow").registerInstruction("sub-workflow",P)})}}e.PluginWorkflowSubWorkflowClient=W,e.default=W,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
