(function(m,n){typeof exports=="object"&&typeof module!="undefined"?n(exports,require("react/jsx-runtime"),require("react"),require("@nocobase/client"),require("@ant-design/icons"),require("@formily/shared"),require("react-i18next"),require("@formily/core"),require("@formily/react"),require("antd"),require("dayjs"),require("@formily/antd-v5"),require("lodash"),require("@nocobase/plugin-workflow/client")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","react","@nocobase/client","@ant-design/icons","@formily/shared","react-i18next","@formily/core","@formily/react","antd","dayjs","@formily/antd-v5","lodash","@nocobase/plugin-workflow/client"],n):(m=typeof globalThis!="undefined"?globalThis:m||self,n(m["@ashley/plugin-comment"]={},m.jsxRuntime,m.react,m["@nocobase/client"],m["@ant-design/icons"],m["@formily/shared"],m["react-i18next"],m["@formily/core"],m["@formily/react"],m.antd,m.dayjs,m["@formily/antd-v5"],m.lodash,m["@nocobase/plugin-workflow"]))})(this,function(m,n,d,t,B,T,b,I,l,y,G,_,M,Q){"use strict";var ve=Object.defineProperty,Pe=Object.defineProperties;var Be=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var ze=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var O=(m,n,d)=>n in m?ve(m,n,{enumerable:!0,configurable:!0,writable:!0,value:d}):m[n]=d,h=(m,n)=>{for(var d in n||(n={}))ze.call(n,d)&&O(m,d,n[d]);if(L)for(var d of L(n))Fe.call(n,d)&&O(m,d,n[d]);return m},f=(m,n)=>Pe(m,Be(n));var P=(m,n,d)=>new Promise((t,B)=>{var T=l=>{try{I(d.next(l))}catch(y){B(y)}},b=l=>{try{I(d.throw(l))}catch(y){B(y)}},I=l=>l.done?t(l.value):Promise.resolve(l.value).then(T,b);I((d=d.apply(m,n)).next())});const g="@ashley/plugin-comment";function w(e={}){return b.useTranslation(g,e)}const D=e=>{const{collectionName:o,association:r,dataSource:a}=e,s=r||o;if(!a)throw new Error("dataSource are required");return{type:"void","x-acl-action":`${s}:view`,"x-decorator":"Comment.Decorator","x-decorator-props":{collection:o,dataSource:a,association:r,action:"list",readPretty:!0,runWhenParamsChanged:!0,allowAddingComments:!0},"x-use-decorator-props":"useCommentBlockDecoratorProps","x-toolbar":"BlockSchemaToolbar","x-settings":"blockSettings:comment","x-component":"CardItem",properties:{list:{type:"array","x-component":"Comment.List",properties:{item:{type:"object","x-component":"Comment.Item","x-read-pretty":!0,properties:{actionBar:{type:"void","x-initializer":"comment:configureItemActions","x-component":"ActionBar","x-component-props":{layout:"one-column"},properties:{[T.uid()]:{type:"void",title:`{{ t("Reply", { ns: "${g}" }) }}`,"x-action":"create","x-decorator":"ACLActionProvider","x-component":"QuoteReplyCommentActionButton"}}}}}}},submit:{type:"void","x-acl-action":`${o}:create`,"x-decorator":"ACLCollectionProvider","x-decorator-props":{collection:o,dataSource:a},"x-component":"Comment.Submit",properties:{actionBar:{type:"void","x-initializer":"comment:configureActions","x-component":"ActionBar","x-component-props":{layout:"one-column"},properties:{comment:{type:"void",title:`{{ t("Comment", { ns: "${g}" }) }}`,"x-action":"create","x-action-settings":{triggerWorkflows:[]},"x-decorator":"ACLActionProvider","x-component":"Action","x-component-props":{type:"primary",htmlType:"submit"},"x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:createSubmit","x-use-component-props":"useCommentCreateActionProps"}}}}}}}},K=e=>{var o;return((o=e.collection)==null?void 0:o.getOptions().template)=="comment"},H=e=>e.getOptions().template==="comment",U=({onlyCurrentDataSource:e,showAssociationFields:o,hideSearch:r})=>{const{getCollection:a}=t.useCollectionManager_deprecated(),s=t.useSchemaInitializerItem(),{createAssociationGridCardBlock:i}=X(),{createCommentBlock:c}=J(),p=({associationField:u})=>{if(u){const x=u.target,S=a(x),k=(S==null?void 0:S.template)==="comment";return["hasMany","belongsToMany"].includes(u.type)&&k}return!1},C=({item:u,fromOthersInPopup:x})=>x?c({item:u}):i({item:u});return n.jsx(t.DataBlockInitializer,f(h({},s),{componentType:"comment",icon:n.jsx(B.CommentOutlined,{}),renderSubMenuIfNoChildren:!0,onlyCurrentDataSource:e,showAssociationFields:o,hideSearch:r,filterOtherRecordsCollection:H,filter:o?p:K,onCreateBlockSchema:o?C:c}))},J=()=>{const{insert:e}=t.useSchemaInitializer(),{getCollection:o}=t.useCollectionManager_deprecated();return{createCommentBlock:d.useCallback(({item:a},s)=>{const i=o(a.name,a.dataSource),c=D({collectionName:a.name,dataSource:a.dataSource,rowKey:i.filterTargetKey||"id"});s!=null&&s.filter&&(c["x-decorator-props"].params=f(h({},c["x-decorator-props"].params),{filter:s==null?void 0:s.filter})),e(c)},[o,e])}};function X(){const{insert:e}=t.useSchemaInitializer(),{getCollection:o}=t.useCollectionManager_deprecated();return{createAssociationGridCardBlock:d.useCallback(({item:a})=>{const s=a.associationField,i=o(s.target);e(D({rowKey:i.filterTargetKey,dataSource:i.dataSource,association:`${s.collectionName}.${s.name}`}))},[o,e])}}const $=d.createContext({});$.displayName="CommentBlockContext";const Y=e=>{var c;const{readPretty:o}=e,r=l.useField(),{resource:a,service:s}=t.useBlockRequestContext(),i=d.useMemo(()=>I.createForm({readPretty:o}),[o]);return d.useEffect(()=>{var p;s!=null&&s.loading||i.setValuesIn(r.address.concat("list").toString(),(p=s==null?void 0:s.data)==null?void 0:p.data)},[r.address,i,(c=s==null?void 0:s.data)==null?void 0:c.data,s==null?void 0:s.loading]),n.jsx(t.SchemaComponentOptions,{children:n.jsx($.Provider,{value:{form:i,field:r,service:s,resource:a,allowAddingComments:e.allowAddingComments},children:n.jsx(l.FormContext.Provider,{value:i,children:e.children})})})},Z=e=>{const{filter:o,parseVariableLoading:r}=t.useParsedFilter({filterOption:e==null?void 0:e.filter});return{params:f(h({},e),{filter:o}),parseVariableLoading:r}},R=t.withDynamicSchemaProps(e=>{const o=l.useField(),{params:r,parseVariableLoading:a}=Z(e.params);return t.useControlShowBlock(r,o),a?null:n.jsx(t.BlockProvider,f(h({name:"comment"},e),{params:h({},r),children:n.jsx(Y,h({},e))}))}),z=()=>d.useContext($),ee=e=>{const{association:o}=e;return{parentRecord:t.useParentRecordCommon(o),params:h({pageSize:20,appends:["createdBy"]},e.params)}},oe=e=>{var V;const{pagination:o}=e,r=l.useFieldSchema(),a=l.useField(),s=d.useRef(new Map),i=d.useRef(null),{service:c}=z(),{run:p,params:C}=c,u=(V=c==null?void 0:c.data)==null?void 0:V.meta,x=d.useCallback((A,F)=>{var E;(E=i.current)==null||E.scrollIntoView({behavior:"smooth",block:"start"}),p(f(h({},C==null?void 0:C[0]),{page:A,pageSize:F}))},[p,C]),S=!u||u.count<=u.pageSize?!1:f(h({},o),{onChange:x,total:(u==null?void 0:u.count)||0,pageSize:(u==null?void 0:u.pageSize)||10,current:(u==null?void 0:u.page)||1}),k=d.useCallback(A=>(s.current.has(A)||s.current.set(A,new l.Schema({type:"object",properties:{[A]:h({},r.properties.item)}})),s.current.get(A)),[]);return n.jsxs("div",{children:[n.jsx("div",{ref:i,children:a.value.map((A,F)=>n.jsx(l.RecursionField,{name:F,basePath:a.address,onlyRenderProperties:!0,schema:k(F)},A.id))}),n.jsx(y.Flex,{justify:"flex-end",children:S&&n.jsx(y.Pagination,h({},S))})]})};function te(e){const o=Date.now(),r=Math.floor((o-e)/1e3);if(r<60)return`{{t("just now", { ns: "${g}" })}}`;const a=Math.floor(r/60);if(a<60)return`{{t("minutesAgo", { ns: "${g}", count: ${a} })}}`;const s=Math.floor(a/60);if(s<24)return`{{t("hoursAgo", { ns: "${g}", count: ${s} })}}`;const i=Math.floor(s/24);if(i<7)return`{{t("daysAgo", { ns: "${g}", count: ${i} })}}`;const c=Math.floor(i/7);if(c<4)return`{{t("weeksAgo", { ns: "${g}", count: ${c} })}}`;const p=Math.floor(i/30);if(p<12)return`{{t("monthsAgo", { ns: "${g}", count: ${p} })}}`;const C=Math.floor(i/365);return`{{t("yearsAgo", { ns: "${g}", count: ${C} })}}`}const q=32,N=t.css({position:"absolute",top:q,left:16,width:2,height:"100%",backgroundColor:"#000",zIndex:0}),ne=t.css({position:"relative",marginBottom:q,"&:last-child":{marginBottom:16,[`& .${N}`]:{display:"none"}}}),re=t.css({position:"relative",backgroundColor:"#fff",zIndex:1,border:"1px solid black",borderRadius:6}),se=t.css({height:48,display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 16px",borderBottom:"1px solid black"}),ie=t.css({color:"#24292e"}),ae=t.css({marginRight:8,color:"#fff",padding:"2px 16px",borderRadius:6}),ce=t.css({padding:"16px"}),me=e=>{var c;const{token:o}=t.useScopeTheme(),r=l.useField(),s=t.useApp().getComponent("MarkdownVditor"),i=t.useCompile();return w(),n.jsx(t.CollectionRecordProvider,{record:r.value,children:n.jsxs("div",{className:ne,children:[n.jsx("div",{className:N,style:{backgroundColor:o.colorBorder}}),n.jsxs("div",{className:re,style:{borderColor:o.colorBorder},children:[n.jsxs("div",{className:se,style:{borderColor:o.colorBorder},children:[n.jsxs("div",{className:ie,children:[n.jsx("span",{className:ae,style:{background:o.xwColorPrimary},children:(c=r.value.createdBy)==null?void 0:c.nickname}),n.jsx("span",{children:i(te(G(r.value.createdAt).valueOf()))})]}),n.jsx("div",{children:e.children})]}),n.jsx("div",{className:ce,children:n.jsx(s,{value:r.value.content||""})})]})]})})},le=()=>{const e=l.useForm(),o=l.useField(),{service:r}=t.useBlockRequestContext(),a=o.address.slice(0,o.address.length-3).concat("content"),s=t.useCreateActionProps({customCollectValues:()=>P(this,null,function*(){return{content:e.getValuesIn(a)}})});return{onClick:()=>P(this,null,function*(){var i;yield s.onClick(),yield e.setValuesIn(a,""),yield(i=r.refresh)==null?void 0:i.call(r)})}},de=e=>{var p;const o=l.useField(),{t:r}=w(),{allowAddingComments:a}=z(),i=t.useCollection().getField("content"),c=(p=i==null?void 0:i.uiSchema)==null?void 0:p["x-component-props"];return a?n.jsx("div",{style:{marginTop:16},children:n.jsxs(t.CollectionRecordContext.Provider,{value:new t.CollectionRecord({isNew:!0}),children:[n.jsx(l.RecursionField,{name:"content",basePath:o.address,schema:{type:"string",name:"content","x-read-pretty":!1,"x-read-only":!1,"x-decorator":"FormItem","x-validator":C=>C!=null&&C.trim()?void 0:r("Please enter the content"),"x-component":"MarkdownVditor","x-component-props":c||{}}}),n.jsx("div",{style:{marginTop:16},children:e.children})]})}):null},v=()=>null;v.Decorator=R,v.List=oe,v.Item=me,v.Submit=de;const pe=new t.SchemaSettings({name:"blockSettings:comment",items:[{name:"title",Component:t.SchemaSettingsBlockTitleItem},{name:"Edit block layout",Component:t.SchemaSettingsBlockLayoutItem},{name:"SetTheDataScope",Component:t.SchemaSettingsDataScope,useComponentProps(){var i,c;const{name:e}=t.useCollection_deprecated(),o=l.useFieldSchema(),{form:r}=z(),a=l.useField(),{dn:s}=t.useDesignable();return{collectionName:e,defaultFilter:((c=(i=o==null?void 0:o["x-decorator-props"])==null?void 0:i.params)==null?void 0:c.filter)||{},form:r,onSubmit:({filter:p})=>{p=t.removeNullCondition(p),M.set(o,"x-decorator-props.params.filter",p),a.decoratorProps.params=h({},o["x-decorator-props"].params),s.emit("patch",{schema:{"x-uid":o["x-uid"],"x-decorator-props":o["x-decorator-props"]}})}}}},{name:"SetDefaultSortingRules",type:"modal",useComponentProps(){var C,u;const{name:e}=t.useCollection_deprecated(),{t:o}=b.useTranslation(),r=l.useFieldSchema(),a=l.useField(),{dn:s}=t.useDesignable(),i=t.useSortFields(e),c=((u=(C=r==null?void 0:r["x-decorator-props"])==null?void 0:C.params)==null?void 0:u.sort)||[],p=c==null?void 0:c.map(x=>x.startsWith("-")?{field:x.substring(1),direction:"desc"}:{field:x,direction:"asc"});return{title:o("Set default sorting rules"),components:{ArrayItems:_.ArrayItems},schema:{type:"object",title:o("Set default sorting rules"),properties:{sort:{type:"array",default:p,"x-component":"ArrayItems","x-decorator":"FormItem",items:{type:"object",properties:{space:{type:"void","x-component":"Space",properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},field:{type:"string",enum:i,required:!0,"x-decorator":"FormItem","x-component":"Select","x-component-props":{style:{width:260}}},direction:{type:"string","x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{optionType:"button"},enum:[{label:o("ASC"),value:"asc"},{label:o("DESC"),value:"desc"}]},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:o("Add sort field"),"x-component":"ArrayItems.Addition"}}}}},onSubmit:({sort:x})=>{const S=x.map(k=>k.direction==="desc"?`-${k.field}`:k.field);M.set(r,"x-decorator-props.params.sort",S),a.decoratorProps.params=h({},r["x-decorator-props"].params),s.emit("patch",{schema:{"x-uid":r["x-uid"],"x-decorator-props":r["x-decorator-props"]}})}}}},{name:"RecordsPerPage",type:"select",useComponentProps(){var i,c;const e=l.useField(),o=l.useFieldSchema(),{service:r}=z(),{t:a}=b.useTranslation(),{dn:s}=t.useDesignable();return{title:a("Records per page"),value:((c=(i=e.decoratorProps)==null?void 0:i.params)==null?void 0:c.pageSize)||20,options:[{label:"10",value:10},{label:"20",value:20},{label:"50",value:50},{label:"100",value:100},{label:"200",value:200}],onChange:p=>{var u;const C=e.decoratorProps.params||{};C.pageSize=p,e.decoratorProps.params=C,o["x-decorator-props"].params=C,r.run(f(h({},(u=r.params)==null?void 0:u[0]),{pageSize:p,page:1})),s.emit("patch",{schema:{"x-uid":o["x-uid"],"x-decorator-props":o["x-decorator-props"]}})}}}},{name:"divider2",type:"divider"},{name:"editTheme",Component:t.SchemaSettingsThemeEditItem,useComponentProps(){const{t:e}=b.useTranslation();return{title:e("Block theme")}}},{name:"divider3",type:"divider"},{name:"allowAddingComments",type:"switch",useComponentProps(){var s;const e=l.useFieldSchema(),o=l.useField(),{dn:r}=t.useDesignable(),{t:a}=w();return{title:a("Allow adding comments"),checked:((s=e==null?void 0:e["x-decorator-props"])==null?void 0:s.allowAddingComments)||!1,onChange:i=>{M.set(e,"x-decorator-props.allowAddingComments",i),o.decoratorProps.allowAddingComments=i,r.emit("patch",{schema:{"x-uid":e["x-uid"],"x-decorator-props":e["x-decorator-props"]}})}}}},{name:"remove",type:"remove",componentProps:{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}]}),ue=new t.SchemaInitializer({name:"comment:configureActions",title:'{{t("Configure actions")}}',icon:"SettingOutlined",items:[{type:"itemGroup",title:'{{t("Enable actions")}}',name:"enableActions",children:[{name:"submit",title:`{{ t("Comment", { ns: "${g}" }) }}`,Component:"CommentSubmitActionInitializer",schema:{"x-action-settings":{}}}]},{name:"divider",type:"divider"},{type:"subMenu",title:'{{t("Customize")}}',name:"customize",children:[{name:"saveRecord",title:'{{t("Save record")}}',Component:"CommentSaveRecordActionInitializer"},{name:"customRequest",title:'{{t("Custom request")}}',Component:"CustomRequestInitializer"},{name:"submitToWorkflow",title:'{{t("Submit to workflow", { ns: "workflow" })}}',Component:"CommentSubmitToWorkflowActionInitializer"}]}]}),Ce=new t.SchemaInitializer({name:"comment:configureItemActions",title:'{{t("Configure actions")}}',icon:"SettingOutlined",items:[{type:"itemGroup",title:'{{t("Enable actions")}}',name:"enableActions",children:[{name:"reply",title:`{{ t("Reply", { ns: "${g}" }) }}`,Component:"QuoteReplyCommentActionInitializer"},{name:"delete",title:`{{ t("Delete", { ns: "${g}" }) }}`,Component:"DeleteCommentActionInitializer"}]}]}),he=e=>{const o={title:`{{ t("Comment", { ns: "${g}" }) }}`,"x-action":"create","x-component":"Action","x-use-component-props":"useCommentCreateActionProps","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:createSubmit","x-component-props":{type:"primary",htmlType:"submit"},"x-action-settings":{triggerWorkflows:[]}};return n.jsx(t.ActionInitializer,f(h({},e),{schema:o}))},ge=()=>{const e={title:'{{ t("Save record") }}',"x-action":"customize:save","x-component":"Action","x-use-component-props":"useCommentCreateActionProps","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:saveRecord","x-designer-props":{modalTip:'{{ t("When the button is clicked, the following fields will be assigned and saved together with the fields in the form. If there are overlapping fields, the value here will overwrite the value in the form.") }}'},"x-action-settings":{assignedValues:{},skipValidator:!1,onSuccess:{manualClose:!0,redirecting:!1,successMessage:'{{t("Submitted successfully")}}'},triggerWorkflows:[]}},o=t.useSchemaInitializerItem();return n.jsx(t.BlockInitializer,f(h({},o),{schema:e,item:o}))},fe={padding:"0 4px"},xe=()=>{const e=t.useCollectionRecord(),o=l.useForm(),{t:r}=w(),a=()=>{var p;const i=o.query(/\.submit\.content$/).take().path.entire,c=((p=e.data)==null?void 0:p.content)||"";o.setValuesIn(i,c.split(`
`).map(C=>`> ${C}`).join(`
`))};return n.jsx(y.Button,{type:"link",style:fe,onClick:a,children:r("Reply")})},ye=e=>{const o={title:'{{ t("Edit") }}',"x-action":"update","x-decorator":"ACLActionProvider","x-component":"EditCommentActionButton"};return n.jsx(t.ActionInitializer,f(h({},e),{schema:o}))},Se=e=>{const o={title:'{{ t("Delete") }}',"x-action":"destroy","x-decorator":"ACLActionProvider","x-component":"Action.Link","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:delete","x-use-component-props":"useDestroyActionProps","x-component-props":{confirm:{content:'{{ t("Are you sure you want to delete this comment?") }}'}},"x-action-settings":{triggerWorkflows:[]}};return n.jsx(t.ActionInitializer,f(h({},e),{schema:o}))},Ae={padding:"0 4px"},ke=()=>{const{t:e}=w();return n.jsx(y.Button,{type:"link",style:Ae,children:e("Edit")})},be=e=>{const o={title:`{{ t("Reply", { ns: "${g}" }) }}`,"x-action":"create","x-decorator":"ACLActionProvider","x-component":"QuoteReplyCommentActionButton"};return n.jsx(t.ActionInitializer,f(h({},e),{schema:o}))},Ie=()=>{const e=l.useForm(),o=l.useField(),{service:r}=t.useBlockRequestContext(),a=Q.useTriggerWorkflowsActionProps({skipResetForm:!0}),s=o.address.slice(0,o.address.length-3).concat("content");return{onClick:()=>P(this,null,function*(){var i;yield a.onClick(),yield e.setValuesIn(s,""),yield(i=r.refresh)==null?void 0:i.call(r)})}},we=()=>{const e={title:'{{t("Submit to workflow", { ns: "workflow" })}}',"x-component":"Action","x-use-component-props":"useCommentTriggerWorkflowsActionProps","x-designer":"Action.Designer","x-action-settings":{skipValidator:!1,onSuccess:{manualClose:!0,redirecting:!1,successMessage:'{{t("Submitted successfully")}}'},triggerWorkflows:[]},"x-action":"customize:triggerWorkflows"},o=t.useSchemaInitializerItem();return n.jsx(t.BlockInitializer,f(h({},o),{schema:e,item:o}))},j=d.memo(e=>n.jsx(t.SchemaComponentOptions,{components:{CommentBlockInitializer:U,CommentSubmitActionInitializer:he,CommentSaveRecordActionInitializer:ge,CommentSubmitToWorkflowActionInitializer:we,EditCommentActionInitializer:ye,DeleteCommentActionInitializer:Se,QuoteReplyCommentActionInitializer:be,Comment:v,QuoteReplyCommentActionButton:xe,EditCommentActionButton:ke},scope:{useCommentCreateActionProps:le,useCommentBlockDecoratorProps:ee,useCommentTriggerWorkflowsActionProps:Ie},children:e.children}));j.displayName="CommentPluginProvider";class W extends t.Plugin{load(){return P(this,null,function*(){this.app.use(j),this.schemaSettingsManager.add(pe),this.schemaInitializerManager.add(ue),this.schemaInitializerManager.add(Ce),this.app.schemaInitializerManager.addItem("page:addBlock","dataBlocks.comment",{title:`{{ t("Comment", { ns: "${g}" }) }}`,Component:"CommentBlockInitializer"}),this.app.schemaInitializerManager.addItem("popup:common:addBlock","dataBlocks.comment",{title:`{{ t("Comment", { ns: "${g}" }) }}`,Component:"CommentBlockInitializer",useComponentProps(){return{hideSearch:!0,onlyCurrentDataSource:!0,showAssociationFields:!0}}})})}}m.PluginCommentClient=W,m.default=W,Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
