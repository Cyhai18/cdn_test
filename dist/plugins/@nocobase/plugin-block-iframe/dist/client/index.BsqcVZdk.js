(function(r,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@formily/react"),require("antd"),require("react"),require("react-i18next"),require("@formily/shared"),require("@nocobase/utils/client"),require("@nocobase/plugin-workflow/client"),require("lodash"),require("@ant-design/icons")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@formily/react","antd","react","react-i18next","@formily/shared","@nocobase/utils/client","@nocobase/plugin-workflow/client","lodash","@ant-design/icons"],t):(r=typeof globalThis!="undefined"?globalThis:r||self,t(r["@nocobase/plugin-block-iframe"]={},r["@nocobase/client"],r.jsxRuntime,r["@formily/react"],r.antd,r.react,r["react-i18next"],r["@formily/shared"],r["@nocobase/utils"],r["@nocobase/plugin-workflow"],r.lodash,r["@ant-design/icons"]))})(this,function(r,t,s,h,G,R,L,N,O,D,_,ne){"use strict";var be=Object.defineProperty,Ie=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var Z=(r,t,s)=>t in r?be(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s,C=(r,t)=>{for(var s in t||(t={}))ee.call(t,s)&&Z(r,s,t[s]);if(V)for(var s of V(t))te.call(t,s)&&Z(r,s,t[s]);return r},z=(r,t)=>Ie(r,xe(t));var re=(r,t)=>{var s={};for(var h in r)ee.call(r,h)&&t.indexOf(h)<0&&(s[h]=r[h]);if(r!=null&&V)for(var h of V(r))t.indexOf(h)<0&&te.call(r,h)&&(s[h]=r[h]);return s};var k=(r,t,s)=>new Promise((h,G)=>{var R=O=>{try{N(s.next(O))}catch(D){G(D)}},L=O=>{try{N(s.throw(O))}catch(D){G(D)}},N=O=>O.done?h(O.value):Promise.resolve(O.value).then(R,L);N((s=s.apply(r,t)).next())});function oe(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var W=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;function se(o){if(o==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(o)}function le(){try{if(!Object.assign)return!1;var o=new String("abc");if(o[5]="de",Object.getOwnPropertyNames(o)[0]==="5")return!1;for(var i={},e=0;e<10;e++)i["_"+String.fromCharCode(e)]=e;var f=Object.getOwnPropertyNames(i).map(function(I){return i[I]});if(f.join("")!=="0123456789")return!1;var a={};return"abcdefghijklmnopqrst".split("").forEach(function(I){a[I]=I}),Object.keys(Object.assign({},a)).join("")==="abcdefghijklmnopqrst"}catch(I){return!1}}var ce=le()?Object.assign:function(o,i){for(var e,f=se(o),a,I=1;I<arguments.length;I++){e=Object(arguments[I]);for(var S in e)ie.call(e,S)&&(f[S]=e[S]);if(W){a=W(e);for(var d=0;d<a.length;d++)ae.call(e,a[d])&&(f[a[d]]=e[a[d]])}}return f};const me=oe(ce),ue=({url:o,allowFullScreen:i,position:e,display:f,height:a,width:I,overflow:S,styles:d,onLoad:B,onMouseOver:q,onMouseOut:F,scrolling:g,id:y,frameBorder:m,ariaHidden:u,sandbox:p,allow:n,className:b,title:l,ariaLabel:j,ariaLabelledby:x,name:E,target:A,loading:H,importance:U,referrerpolicy:T,allowpaymentrequest:$,src:M,key:w})=>{const P=me({src:M||o,target:A||null,style:{position:e||null,display:f||"initial",overflow:S||null},scrolling:g||null,allowpaymentrequest:$||null,importance:U||null,sandbox:p&&[...p].join(" ")||null,loading:H||null,styles:d||null,name:E||null,className:b||null,allowFullScreen:"allowFullScreen",referrerpolicy:T||null,title:l||null,allow:n||null,id:y||null,"aria-labelledby":x||null,"aria-hidden":u||null,"aria-label":j||null,width:I||null,height:a||null,onLoad:B||null,onMouseOver:q||null,onMouseOut:F||null,key:w||"iframe"});let c=Object.create(null);for(let v of Object.keys(P))P[v]!=null&&(c[v]=P[v]);for(let v of Object.keys(c.style))c.style[v]==null&&delete c.style[v];if(c.styles)for(let v of Object.keys(c.styles))c.styles.hasOwnProperty(v)&&(c.style[v]=c.styles[v]),Object.keys(c.styles).pop()==v&&delete c.styles;if(i)if("allow"in c){const v=c.allow.replace("fullscreen","");c.allow=`fullscreen ${v.trim()}`.trim()}else c.allow="fullscreen";return m>=0&&(c.style.hasOwnProperty("border")||(c.style.border=m)),R.createElement("iframe",Object.assign({},c))},de=()=>{const o=h.useField(),i=h.useFieldSchema(),{t:e}=L.useTranslation(),{dn:f}=t.useDesignable(),a=t.useAPIClient(),{mode:I,url:S,htmlId:d,height:B="60vh"}=i["x-component-props"]||{},q=g=>k(this,null,function*(){var m,u,p,n,b;const y={values:{html:g}};if(d){const{data:l}=yield(u=(m=a.resource("iframeHtml")).update)==null?void 0:u.call(m,z(C({},y),{filterByTk:d}));return((p=l==null?void 0:l.data)==null?void 0:p[0])||{id:d}}else{const{data:l}=yield(b=(n=a.resource("iframeHtml")).create)==null?void 0:b.call(n,y);return l==null?void 0:l.data}}),F=p=>k(this,[p],function*({mode:g,url:y,html:m,height:u}){const n=i["x-component-props"]||{};if(n.mode=g,n.height=u,n.url=y,g==="html"){const b=yield q(m);n.htmlId=b.id}i["x-component-props"]=n,o.componentProps=C({},n),o.data={v:N.uid()},f.emit("patch",{schema:{"x-uid":i["x-uid"],"x-component-props":n}})});return s.jsxs(t.GeneralSchemaDesigner,{children:[s.jsx(t.SchemaSettingsModalItem,{title:e("Edit iframe"),asyncGetInitialValues:()=>k(this,null,function*(){var y,m,u;const g={mode:I,url:S,height:B};if(d){const{data:p}=yield(m=(y=a.resource("iframeHtml")).get)==null?void 0:m.call(y,{filterByTk:d});g.html=((u=p==null?void 0:p.data)==null?void 0:u.html)||""}return g}),schema:{type:"object",title:e("Edit iframe"),properties:{mode:{title:'{{t("Mode")}}',"x-component":"Radio.Group","x-decorator":"FormItem",required:!0,default:"url",enum:[{value:"url",label:e("URL")},{value:"html",label:e("html")}]},url:{title:e("URL"),type:"string","x-decorator":"FormItem","x-component":"Input",required:!0,"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "html"}}'}}}},html:{title:e("html"),type:"string","x-decorator":"FormItem","x-component":"Input.TextArea",required:!0,"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "url"}}'}}}},height:{title:e("Height"),type:"string","x-decorator":"FormItem","x-component":"Input",required:!0}}},onSubmit:F}),s.jsx(t.SchemaSettingsDivider,{}),s.jsx(t.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})};function J(o){return typeof o!="string"?!1:!isNaN(o)&&!isNaN(parseFloat(o))}const K=h.observer(o=>{const l=o,{url:i,htmlId:e,mode:f="url",height:a,html:I}=l,S=re(l,["url","htmlId","mode","height","html"]),{designable:d}=t.useDesignable(),B=h.useField(),{t:q}=L.useTranslation(),{parseURLAndParams:F}=t.useParseURLAndParams(),[g,y]=R.useState(""),{loading:m,data:u}=t.useRequest({url:`iframeHtml:getHtml/${e}`},{refreshDeps:[e,B.data],ready:f==="html"&&!!e}),p=h.useFieldSchema(),n=D.useFlowContext();function b(j,x){if(!j)return{paramArr:[],query:[]};const E=j.split("");let A=0,H=0,U=[],T=[],$=[];const M=[];for(const w in E)E[w]==="{"&&(A+=1,A===1&&U.push(Number(w))),A===2&&(A=0),E[w]==="}"&&(H+=1,H===2&&T.push(Number(w))),H===2&&(H=0);for(const w in T){const P=j.substring(U[w],T[w]+1);if(P.includes(x)){$.push(P);const c=P.replace(/{/g,"").replace(/}/g,"").replace(`${x}.`,"");M.push(c)}}return{paramArr:$,query:M}}return R.useEffect(()=>{k(this,null,function*(){var A,H,U,T;if(f==="html"){const M="data:text/html;charset=utf-8,"+encodeURIComponent(u);y(M);return}let x=i;if(O.isInAuditCard(p)){const $=b(i,"$context.data"),{paramArr:M,query:w}=$;for(const P in w){let c;const v=w[P].split("."),X=v.pop(),Y=v.join(".");Y?(c=_.get((H=(A=n==null?void 0:n.execution)==null?void 0:A.context)==null?void 0:H.data,Y),Array.isArray(c)?c=c.map(ye=>_.get(ye,X)).join(","):c=_.get(c,X)):c=_.get((T=(U=n==null?void 0:n.execution)==null?void 0:U.context)==null?void 0:T.data,w[P]),x=x==null?void 0:x.replace(M[P],c!=null?c:"")}}const E=yield F(x,[]);y(E)})},[u,f,i]),f==="url"&&!i||f==="html"&&!e?s.jsx(G.Card,{style:{marginBottom:24},children:q("Please fill in the iframe URL")}):m?s.jsx("div",{style:{height:J(a)?`${a}px`:a,marginBottom:"24px",border:0},children:s.jsx(G.Spin,{})}):!g||d&&(i!=null&&i.includes("$"))?s.jsx(G.Card,{style:{marginBottom:24},children:q("Find variables in iframe url, please view the results in non design mode.")}):s.jsx(ue,C({url:g,width:"100%",display:"block",position:"relative",styles:{height:J(a)?`${a}px`:a,marginBottom:"24px",border:0}},S))},{displayName:"Iframe"});K.Designer=de;const pe=()=>{const{insert:o}=t.useSchemaInitializer(),i=t.useSchemaInitializerItem();return h.useFieldSchema(),s.jsx(t.SchemaInitializerItem,z(C({},i),{icon:s.jsx(ne.FormOutlined,{}),onClick:()=>{o({type:"void","x-settings":"blockSettings:iframe","x-decorator":"BlockItem","x-decorator-props":{name:"iframe"},"x-component":"Iframe","x-component-props":{}})}}))},fe=o=>s.jsx(t.SchemaComponentOptions,{components:{Iframe:K,IframeBlockInitializer:pe},children:o.children}),he=new t.SchemaSettings({name:"iframeBlockSchemaSettings",items:[{name:"EditIframe",type:"modal",useComponentProps(){const o=h.useField(),i=h.useFieldSchema(),{t:e}=L.useTranslation(),{dn:f}=t.useDesignable(),a=t.useAPIClient(),{mode:I,url:S,htmlId:d,height:B="60vh"}=i["x-component-props"]||{},q=g=>k(this,null,function*(){var m,u,p,n,b;const y={values:{html:g}};if(d){const{data:l}=yield(u=(m=a.resource("iframeHtml")).update)==null?void 0:u.call(m,z(C({},y),{filterByTk:d}));return((p=l==null?void 0:l.data)==null?void 0:p[0])||{id:d}}else{const{data:l}=yield(b=(n=a.resource("iframeHtml")).create)==null?void 0:b.call(n,y);return l==null?void 0:l.data}}),F=p=>k(this,[p],function*({mode:g,url:y,html:m,height:u}){const n=i["x-component-props"]||{};if(n.mode=g,n.height=u,n.url=y,g==="html"){const b=yield q(m);n.htmlId=b.id}i["x-component-props"]=n,o.componentProps=C({},n),o.data={v:N.uid()},f.emit("patch",{schema:{"x-uid":i["x-uid"],"x-component-props":n}})});return{title:e("Edit iframe"),asyncGetInitialValues:()=>k(this,null,function*(){var y,m,u;const g={mode:I,url:S,height:B};if(d){const{data:p}=yield(m=(y=a.resource("iframeHtml")).get)==null?void 0:m.call(y,{filterByTk:d});g.html=((u=p==null?void 0:p.data)==null?void 0:u.html)||""}return g}),schema:{type:"object",title:e("Edit iframe"),properties:{mode:{title:'{{t("Mode")}}',"x-component":"Radio.Group","x-decorator":"FormItem",required:!0,default:"url",enum:[{value:"url",label:e("URL")},{value:"html",label:e("html")}]},url:{title:e("URL"),type:"string","x-decorator":"FormItem","x-component":"Input",required:!0,"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "html"}}'}}}},html:{title:e("html"),type:"string","x-decorator":"FormItem","x-component":"Input.TextArea",required:!0,"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "url"}}'}}}},height:{title:e("Height"),type:"string","x-decorator":"FormItem","x-component":"Input",required:!0}}},onSubmit:F}}},{name:"divider",type:"divider"},{name:"delete",type:"remove",useComponentProps(){return{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}}]}),ge=new t.SchemaSettings({name:"blockSettings:iframe",items:[{name:"EditIframe",type:"modal",useComponentProps(){const o=h.useField(),i=h.useFieldSchema(),{t:e}=L.useTranslation(),{dn:f}=t.useDesignable(),a=t.useAPIClient(),{mode:I,url:S,htmlId:d,height:B="60vh"}=i["x-component-props"]||{},q=m=>k(this,null,function*(){var p,n,b,l,j;const u={values:{html:m}};if(d){const{data:x}=yield(n=(p=a.resource("iframeHtml")).update)==null?void 0:n.call(p,z(C({},u),{filterByTk:d}));return((b=x==null?void 0:x.data)==null?void 0:b[0])||{id:d}}else{const{data:x}=yield(j=(l=a.resource("iframeHtml")).create)==null?void 0:j.call(l,u);return x==null?void 0:x.data}}),{urlSchema:F}=t.useURLAndHTMLSchema(),g=D.useWorkflowVariableOptions(),y=b=>k(this,[b],function*({mode:m,url:u,html:p,height:n}){const l=i["x-component-props"]||{};if(l.mode=m,l.height=n,l.url=u,m==="html"){const j=yield q(p);l.htmlId=j.id}i["x-component-props"]=l,o.componentProps=C({},l),o.data={v:N.uid()},f.emit("patch",{schema:{"x-uid":i["x-uid"],"x-component-props":l}})});return{title:e("Edit iframe"),asyncGetInitialValues:()=>k(this,null,function*(){var u,p,n;const m={mode:I,url:S,height:B};if(d){const{data:b}=yield(p=(u=a.resource("iframeHtml")).get)==null?void 0:p.call(u,{filterByTk:d});m.html=((n=b==null?void 0:b.data)==null?void 0:n.html)||""}return m}),schema:{type:"object",title:e("Edit iframe"),properties:{mode:{title:'{{t("Mode")}}',"x-component":"Radio.Group","x-decorator":"FormItem",required:!0,default:"url",enum:[{value:"url",label:e("URL")},{value:"html",label:e("html")}]},url:z(C({},F),{required:!0,description:null,workflowScope:O.isInAuditCard(i)?g.filter(m=>m.key==="$context"):!1}),html:{title:e("html"),type:"string","x-decorator":"FormItem","x-component":"Input.TextArea",required:!0,"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "url"}}'}}}},height:{title:e("Height"),type:"string","x-decorator":"FormItem","x-component":"Input",required:!0}}},onSubmit:y}}},{name:"divider",type:"divider"},{name:"delete",type:"remove",useComponentProps(){return{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}}]});class Q extends t.Plugin{load(){return k(this,null,function*(){this.app.schemaSettingsManager.add(he),this.app.schemaSettingsManager.add(ge),this.app.use(fe);const i=this.app.schemaInitializerManager.get("page:addBlock");i==null||i.add("otherBlocks.iframe",{title:'{{t("Iframe")}}',Component:"IframeBlockInitializer"});const e=this.app.schemaInitializerManager.get("popup:addNew:addBlock");e==null||e.add("otherBlocks.iframe",{title:'{{t("Iframe")}}',Component:"IframeBlockInitializer"});const f=this.app.schemaInitializerManager.get("popup:common:addBlock");f==null||f.add("otherBlocks.iframe",{title:'{{t("Iframe")}}',Component:"IframeBlockInitializer"});const a=this.app.schemaInitializerManager.get("RecordFormBlockInitializers");a==null||a.add("otherBlocks.iframe",{title:'{{t("Iframe")}}',Component:"IframeBlockInitializer"})})}}r.PluginBlockIframeClient=Q,r.default=Q,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
