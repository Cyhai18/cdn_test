(function(ye,N){typeof exports=="object"&&typeof module!="undefined"?N(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@formily/react"),require("ahooks"),require("antd"),require("dayjs"),require("react"),require("react-i18next"),require("@ant-design/icons"),require("@formily/shared"),require("@emotion/css"),require("@formily/antd-v5"),require("@formily/core"),require("lodash"),require("axios")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@formily/react","ahooks","antd","dayjs","react","react-i18next","@ant-design/icons","@formily/shared","@emotion/css","@formily/antd-v5","@formily/core","lodash","axios"],N):(ye=typeof globalThis!="undefined"?globalThis:ye||self,N(ye["@nocobase/plugin-api-keys"]={},ye["@nocobase/client"],ye.jsxRuntime,ye["@formily/react"],ye.ahooks,ye.antd,ye.dayjs,ye.react,ye["react-i18next"],ye["@ant-design/icons"],ye["@formily/shared"],ye["@emotion/css"],ye["@formily/antd-v5"],ye["@formily/core"],ye.lodash,ye.axios))})(this,function(ye,N,A,Ve,Mt,ie,Tt,te,st,ht,Nt,lt,Et,Hr,Rt,Br){"use strict";var Yu=Object.defineProperty,Ku=Object.defineProperties;var Ju=Object.getOwnPropertyDescriptors;var Lr=Object.getOwnPropertySymbols;var Wu=Object.prototype.hasOwnProperty,Ru=Object.prototype.propertyIsEnumerable;var Vr=(ye,N,A)=>N in ye?Yu(ye,N,{enumerable:!0,configurable:!0,writable:!0,value:A}):ye[N]=A,$e=(ye,N)=>{for(var A in N||(N={}))Wu.call(N,A)&&Vr(ye,A,N[A]);if(Lr)for(var A of Lr(N))Ru.call(N,A)&&Vr(ye,A,N[A]);return ye},Ze=(ye,N)=>Ku(ye,Ju(N));var R=(ye,N,A)=>new Promise((Ve,Mt)=>{var ie=st=>{try{te(A.next(st))}catch(ht){Mt(ht)}},Tt=st=>{try{te(A.throw(st))}catch(ht){Mt(ht)}},te=st=>st.done?Ve(st.value):Promise.resolve(st.value).then(ie,Tt);te((A=A.apply(ye,N)).next())});const ge="api-keys";function H(t,a={}){return N.i18n.t(t,$e({ns:ge},a))}function ir(){return st.useTranslation([ge,"client"],{nsMode:"fallback"})}const Gr=Tt().add(1,"days"),Yr=N.css`
  width: 100%;
  & > .ant-space-item {
    flex: 1;
  }
`,Kr=t=>{const{onChange:a}=t,[u,{toggle:h,setFalse:C}]=Mt.useBoolean(),O=P=>{if(P==="custom")return a("1d"),h();C(),a(P)},v=P=>{P=P.millisecond(0).second(0);const V=Tt().millisecond(0).second(0),G=`${P.diff(V,"d")}d`;a(G)};return A.jsxs(ie.Space,{className:Yr,children:[A.jsx(ie.Select,Ze($e({},t),{value:u?"custom":t.value,onChange:O})),u?A.jsx(ie.DatePicker,{disabledDate:P=>P.isSameOrBefore(),defaultValue:Gr,onChange:v,showToday:!1,allowClear:!1}):null]})},Jr=()=>{const{expiresIn:t,createdAt:a}=N.useRecord(),{t:u}=ir(),h=te.useMemo(()=>t==="never"?u("Never expires"):Tt(a).add((t==null?void 0:t.replace("d",""))||0,"days").format("YYYY-MM-DD HH:mm:ss"),[a,t]);return A.jsx(ie.Typography.Text,{children:h})},Wr=Ve.connect(Kr,Ve.mapProps({dataSource:"options"}),Ve.mapReadPretty(Jr)),yt=te.createContext({});yt.displayName="ExternalApiContext";const Rr=()=>A.jsx(N.SchemaComponent,{schema:{type:"void",properties:{newAPI:{type:"void",title:`${H("New")}${H("external API")}`,"x-component":"Action","x-component-props":{type:"text",icon:"PlusOutlined",style:{width:"100%",textAlign:"left"}},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{},title:`${H("New")}${H("external API")}`,properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},provider:{"x-component":"CollectionField","x-decorator":"FormItem"},description:{"x-component":"CollectionField","x-decorator":"FormItem"},status:{"x-component":"CollectionField","x-decorator":"FormItem",default:!0},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useCreateAction }}"}}}}}}}}}}});var bt=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function sr(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Zr=Array.isArray,Dt=Zr,Xr=typeof bt=="object"&&bt&&bt.Object===Object&&bt,Qr=Xr,en=Qr,tn=typeof self=="object"&&self&&self.Object===Object&&self,rn=en||tn||Function("return this")(),Zt=rn,nn=Zt,on=nn.Symbol,jt=on,ur=jt,cr=Object.prototype,an=cr.hasOwnProperty,sn=cr.toString,It=ur?ur.toStringTag:void 0;function un(t){var a=an.call(t,It),u=t[It];try{t[It]=void 0;var h=!0}catch(O){}var C=sn.call(t);return h&&(a?t[It]=u:delete t[It]),C}var cn=un,ln=Object.prototype,fn=ln.toString;function pn(t){return fn.call(t)}var dn=pn,lr=jt,hn=cn,yn=dn,mn="[object Null]",vn="[object Undefined]",fr=lr?lr.toStringTag:void 0;function gn(t){return t==null?t===void 0?vn:mn:fr&&fr in Object(t)?hn(t):yn(t)}var Xt=gn;function bn(t){return t!=null&&typeof t=="object"}var Qt=bn,xn=Xt,wn=Qt,An="[object Symbol]";function kn(t){return typeof t=="symbol"||wn(t)&&xn(t)==An}var er=kn,Cn=Dt,Sn=er,Pn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Tn=/^\w*$/;function En(t,a){if(Cn(t))return!1;var u=typeof t;return u=="number"||u=="symbol"||u=="boolean"||t==null||Sn(t)?!0:Tn.test(t)||!Pn.test(t)||a!=null&&t in Object(a)}var Dn=En;function In(t){var a=typeof t;return t!=null&&(a=="object"||a=="function")}var tr=In,On=Xt,Fn=tr,$n="[object AsyncFunction]",_n="[object Function]",Mn="[object GeneratorFunction]",Nn="[object Proxy]";function jn(t){if(!Fn(t))return!1;var a=On(t);return a==_n||a==Mn||a==$n||a==Nn}var qn=jn,Un=Zt,zn=Un["__core-js_shared__"],Ln=zn,rr=Ln,pr=function(){var t=/[^.]+$/.exec(rr&&rr.keys&&rr.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();function Vn(t){return!!pr&&pr in t}var Hn=Vn,Bn=Function.prototype,Gn=Bn.toString;function Yn(t){if(t!=null){try{return Gn.call(t)}catch(a){}try{return t+""}catch(a){}}return""}var Kn=Yn,Jn=qn,Wn=Hn,Rn=tr,Zn=Kn,Xn=/[\\^$.*+?()[\]{}|]/g,Qn=/^\[object .+?Constructor\]$/,eo=Function.prototype,to=Object.prototype,ro=eo.toString,no=to.hasOwnProperty,oo=RegExp("^"+ro.call(no).replace(Xn,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function ao(t){if(!Rn(t)||Wn(t))return!1;var a=Jn(t)?oo:Qn;return a.test(Zn(t))}var io=ao;function so(t,a){return t==null?void 0:t[a]}var uo=so,co=io,lo=uo;function fo(t,a){var u=lo(t,a);return co(u)?u:void 0}var nr=fo,po=nr,ho=po(Object,"create"),qt=ho,dr=qt;function yo(){this.__data__=dr?dr(null):{},this.size=0}var mo=yo;function vo(t){var a=this.has(t)&&delete this.__data__[t];return this.size-=a?1:0,a}var go=vo,bo=qt,xo="__lodash_hash_undefined__",wo=Object.prototype,Ao=wo.hasOwnProperty;function ko(t){var a=this.__data__;if(bo){var u=a[t];return u===xo?void 0:u}return Ao.call(a,t)?a[t]:void 0}var Co=ko,So=qt,Po=Object.prototype,To=Po.hasOwnProperty;function Eo(t){var a=this.__data__;return So?a[t]!==void 0:To.call(a,t)}var Do=Eo,Io=qt,Oo="__lodash_hash_undefined__";function Fo(t,a){var u=this.__data__;return this.size+=this.has(t)?0:1,u[t]=Io&&a===void 0?Oo:a,this}var $o=Fo,_o=mo,Mo=go,No=Co,jo=Do,qo=$o;function xt(t){var a=-1,u=t==null?0:t.length;for(this.clear();++a<u;){var h=t[a];this.set(h[0],h[1])}}xt.prototype.clear=_o,xt.prototype.delete=Mo,xt.prototype.get=No,xt.prototype.has=jo,xt.prototype.set=qo;var Uo=xt;function zo(){this.__data__=[],this.size=0}var Lo=zo;function Vo(t,a){return t===a||t!==t&&a!==a}var hr=Vo,Ho=hr;function Bo(t,a){for(var u=t.length;u--;)if(Ho(t[u][0],a))return u;return-1}var Ut=Bo,Go=Ut,Yo=Array.prototype,Ko=Yo.splice;function Jo(t){var a=this.__data__,u=Go(a,t);if(u<0)return!1;var h=a.length-1;return u==h?a.pop():Ko.call(a,u,1),--this.size,!0}var Wo=Jo,Ro=Ut;function Zo(t){var a=this.__data__,u=Ro(a,t);return u<0?void 0:a[u][1]}var Xo=Zo,Qo=Ut;function ea(t){return Qo(this.__data__,t)>-1}var ta=ea,ra=Ut;function na(t,a){var u=this.__data__,h=ra(u,t);return h<0?(++this.size,u.push([t,a])):u[h][1]=a,this}var oa=na,aa=Lo,ia=Wo,sa=Xo,ua=ta,ca=oa;function wt(t){var a=-1,u=t==null?0:t.length;for(this.clear();++a<u;){var h=t[a];this.set(h[0],h[1])}}wt.prototype.clear=aa,wt.prototype.delete=ia,wt.prototype.get=sa,wt.prototype.has=ua,wt.prototype.set=ca;var la=wt,fa=nr,pa=Zt,da=fa(pa,"Map"),ha=da,yr=Uo,ya=la,ma=ha;function va(){this.size=0,this.__data__={hash:new yr,map:new(ma||ya),string:new yr}}var ga=va;function ba(t){var a=typeof t;return a=="string"||a=="number"||a=="symbol"||a=="boolean"?t!=="__proto__":t===null}var xa=ba,wa=xa;function Aa(t,a){var u=t.__data__;return wa(a)?u[typeof a=="string"?"string":"hash"]:u.map}var zt=Aa,ka=zt;function Ca(t){var a=ka(this,t).delete(t);return this.size-=a?1:0,a}var Sa=Ca,Pa=zt;function Ta(t){return Pa(this,t).get(t)}var Ea=Ta,Da=zt;function Ia(t){return Da(this,t).has(t)}var Oa=Ia,Fa=zt;function $a(t,a){var u=Fa(this,t),h=u.size;return u.set(t,a),this.size+=u.size==h?0:1,this}var _a=$a,Ma=ga,Na=Sa,ja=Ea,qa=Oa,Ua=_a;function At(t){var a=-1,u=t==null?0:t.length;for(this.clear();++a<u;){var h=t[a];this.set(h[0],h[1])}}At.prototype.clear=Ma,At.prototype.delete=Na,At.prototype.get=ja,At.prototype.has=qa,At.prototype.set=Ua;var za=At,mr=za,La="Expected a function";function or(t,a){if(typeof t!="function"||a!=null&&typeof a!="function")throw new TypeError(La);var u=function(){var h=arguments,C=a?a.apply(this,h):h[0],O=u.cache;if(O.has(C))return O.get(C);var v=t.apply(this,h);return u.cache=O.set(C,v)||O,v};return u.cache=new(or.Cache||mr),u}or.Cache=mr;var Va=or,Ha=Va,Ba=500;function Ga(t){var a=Ha(t,function(h){return u.size===Ba&&u.clear(),h}),u=a.cache;return a}var Ya=Ga,Ka=Ya,Ja=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Wa=/\\(\\)?/g,Ra=Ka(function(t){var a=[];return t.charCodeAt(0)===46&&a.push(""),t.replace(Ja,function(u,h,C,O){a.push(C?O.replace(Wa,"$1"):h||u)}),a}),Za=Ra;function Xa(t,a){for(var u=-1,h=t==null?0:t.length,C=Array(h);++u<h;)C[u]=a(t[u],u,t);return C}var Qa=Xa,vr=jt,ei=Qa,ti=Dt,ri=er,ni=1/0,gr=vr?vr.prototype:void 0,br=gr?gr.toString:void 0;function xr(t){if(typeof t=="string")return t;if(ti(t))return ei(t,xr)+"";if(ri(t))return br?br.call(t):"";var a=t+"";return a=="0"&&1/t==-ni?"-0":a}var oi=xr,ai=oi;function ii(t){return t==null?"":ai(t)}var si=ii,ui=Dt,ci=Dn,li=Za,fi=si;function pi(t,a){return ui(t)?t:ci(t,a)?[t]:li(fi(t))}var Lt=pi,di=er,hi=1/0;function yi(t){if(typeof t=="string"||di(t))return t;var a=t+"";return a=="0"&&1/t==-hi?"-0":a}var ar=yi,mi=Lt,vi=ar;function gi(t,a){a=mi(a,t);for(var u=0,h=a.length;t!=null&&u<h;)t=t[vi(a[u++])];return u&&u==h?t:void 0}var bi=gi,xi=nr,wi=function(){try{var t=xi(Object,"defineProperty");return t({},"",{}),t}catch(a){}}(),wr=wi,Ar=wr;function Ai(t,a,u){a=="__proto__"&&Ar?Ar(t,a,{configurable:!0,enumerable:!0,value:u,writable:!0}):t[a]=u}var ki=Ai,Ci=ki,Si=hr,Pi=Object.prototype,Ti=Pi.hasOwnProperty;function Ei(t,a,u){var h=t[a];(!(Ti.call(t,a)&&Si(h,u))||u===void 0&&!(a in t))&&Ci(t,a,u)}var Di=Ei,Ii=9007199254740991,Oi=/^(?:0|[1-9]\d*)$/;function Fi(t,a){var u=typeof t;return a=a==null?Ii:a,!!a&&(u=="number"||u!="symbol"&&Oi.test(t))&&t>-1&&t%1==0&&t<a}var kr=Fi,$i=Di,_i=Lt,Mi=kr,Cr=tr,Ni=ar;function ji(t,a,u,h){if(!Cr(t))return t;a=_i(a,t);for(var C=-1,O=a.length,v=O-1,P=t;P!=null&&++C<O;){var V=Ni(a[C]),G=u;if(V==="__proto__"||V==="constructor"||V==="prototype")return t;if(C!=v){var ae=P[V];G=h?h(ae,V,P):void 0,G===void 0&&(G=Cr(ae)?ae:Mi(a[C+1])?[]:{})}$i(P,V,G),P=P[V]}return t}var qi=ji,Ui=bi,zi=qi,Li=Lt;function Vi(t,a,u){for(var h=-1,C=a.length,O={};++h<C;){var v=a[h],P=Ui(t,v);u(P,v)&&zi(O,Li(v,t),P)}return O}var Hi=Vi;function Bi(t,a){return t!=null&&a in Object(t)}var Gi=Bi,Yi=Xt,Ki=Qt,Ji="[object Arguments]";function Wi(t){return Ki(t)&&Yi(t)==Ji}var Ri=Wi,Sr=Ri,Zi=Qt,Pr=Object.prototype,Xi=Pr.hasOwnProperty,Qi=Pr.propertyIsEnumerable,es=Sr(function(){return arguments}())?Sr:function(t){return Zi(t)&&Xi.call(t,"callee")&&!Qi.call(t,"callee")},Tr=es,ts=9007199254740991;function rs(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=ts}var ns=rs,os=Lt,as=Tr,is=Dt,ss=kr,us=ns,cs=ar;function ls(t,a,u){a=os(a,t);for(var h=-1,C=a.length,O=!1;++h<C;){var v=cs(a[h]);if(!(O=t!=null&&u(t,v)))break;t=t[v]}return O||++h!=C?O:(C=t==null?0:t.length,!!C&&us(C)&&ss(v,C)&&(is(t)||as(t)))}var fs=ls,ps=Gi,ds=fs;function hs(t,a){return t!=null&&ds(t,a,ps)}var ys=hs,ms=Hi,vs=ys;function gs(t,a){return ms(t,a,function(u,h){return vs(t,h)})}var bs=gs;function xs(t,a){for(var u=-1,h=a.length,C=t.length;++u<h;)t[C+u]=a[u];return t}var ws=xs,Er=jt,As=Tr,ks=Dt,Dr=Er?Er.isConcatSpreadable:void 0;function Cs(t){return ks(t)||As(t)||!!(Dr&&t&&t[Dr])}var Ss=Cs,Ps=ws,Ts=Ss;function Ir(t,a,u,h,C){var O=-1,v=t.length;for(u||(u=Ts),C||(C=[]);++O<v;){var P=t[O];a>0&&u(P)?a>1?Ir(P,a-1,u,h,C):Ps(C,P):h||(C[C.length]=P)}return C}var Es=Ir,Ds=Es;function Is(t){var a=t==null?0:t.length;return a?Ds(t,1):[]}var Os=Is;function Fs(t,a,u){switch(u.length){case 0:return t.call(a);case 1:return t.call(a,u[0]);case 2:return t.call(a,u[0],u[1]);case 3:return t.call(a,u[0],u[1],u[2])}return t.apply(a,u)}var $s=Fs,_s=$s,Or=Math.max;function Ms(t,a,u){return a=Or(a===void 0?t.length-1:a,0),function(){for(var h=arguments,C=-1,O=Or(h.length-a,0),v=Array(O);++C<O;)v[C]=h[a+C];C=-1;for(var P=Array(a+1);++C<a;)P[C]=h[C];return P[a]=u(v),_s(t,this,P)}}var Ns=Ms;function js(t){return function(){return t}}var qs=js;function Us(t){return t}var zs=Us,Ls=qs,Fr=wr,Vs=zs,Hs=Fr?function(t,a){return Fr(t,"toString",{configurable:!0,enumerable:!1,value:Ls(a),writable:!0})}:Vs,Bs=Hs,Gs=800,Ys=16,Ks=Date.now;function Js(t){var a=0,u=0;return function(){var h=Ks(),C=Ys-(h-u);if(u=h,C>0){if(++a>=Gs)return arguments[0]}else a=0;return t.apply(void 0,arguments)}}var Ws=Js,Rs=Bs,Zs=Ws,Xs=Zs(Rs),Qs=Xs,eu=Os,tu=Ns,ru=Qs;function nu(t){return ru(tu(t,void 0,eu),t+"")}var ou=nu,au=bs,iu=ou,su=iu(function(t,a){return t==null?{}:au(t,a)}),uu=su;const cu=sr(uu),lu={type:"object",properties:{[Nt.uid()]:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:t=>{const a=N.useRecord(),u=N.useRequest(()=>Promise.resolve({data:cu(a,["name","provider","description","status"])}),Ze($e({},t),{manual:!0})),h=N.useActionContext();return te.useEffect(()=>{h.visible&&u.run()},[h.visible]),u}},title:`${H("Edit")}${H("external API")}`,properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},provider:{"x-component":"CollectionField","x-decorator":"FormItem"},description:{"x-component":"CollectionField","x-decorator":"FormItem"},status:{"x-component":"CollectionField","x-decorator":"FormItem"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useUpdateAction }}"}}}}}}}},fu=()=>{const t=Ve.useField(),a=Ve.useForm(),u=N.useActionContext(),{refresh:h}=N.useResourceActionContext(),{resource:C}=N.useResourceContext(),O=N.useRecord(),{setCurApi:v}=te.useContext(yt);return{run(){return R(this,null,function*(){yield a.submit();let{baseUrl:V,contentType:G,authenticationType:ae,headers:I}=a.values;const x={baseUrl:V,contentType:G,headers:I.reduce((k,j)=>(j.key&&j.value&&k.push({[j.key]:j.value}),k),[])};ae&&(x.authenticationType=ae),t.data=t.data||{},t.data.loading=!0;try{yield C.update({filterByTk:O.id,values:{config:x}}),u.setVisible(!1),a.reset(),h(),v(Ze($e({},O),{config:x}))}catch(k){}finally{t.data.loading=!1}})}}},pu=t=>{const a=te.useMemo(()=>t.value||{},[JSON.stringify(t.value||{})]);return A.jsx("section",{children:Object.keys(a).map((u,h)=>A.jsxs("div",{style:{display:"flex",paddingRight:24},children:[A.jsx(ie.Input,{value:u,style:{marginRight:6},disabled:!0}),A.jsx(ie.Input,{value:a[u],disabled:!0})]},u+h))})},du=()=>A.jsx(N.SchemaComponent,{components:{ArrayItems:Et.ArrayItems,HeaderReadPretty:pu},scope:{useUpdateAction:fu},schema:{type:"object",properties:{[Nt.uid()]:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:t=>{const a=N.useRecord(),{config:u={}}=a,h={"Content-Type":u==null?void 0:u.contentType},C=((u==null?void 0:u.headers)||[]).reduce((P,V)=>(Object.keys(V).forEach(G=>{P.push({key:G,value:V[G]})}),P),[]),O=N.useRequest(()=>Promise.resolve({data:Ze($e({},u),{headers:C,onlyReadHeaders:h})}),Ze($e({},t),{manual:!0})),v=N.useActionContext();return te.useEffect(()=>{v.visible&&O.run()},[v.visible]),O}},title:`${H("Configure")}${H("external API")}`,properties:{baseUrl:{type:"string",required:!0,title:"Base URL","x-decorator":"FormItem","x-decorator-props":{},"x-component":"Input","x-component-props":{},"x-validator":t=>t?/^(https?:\/\/)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(:\d+)?(\/[^\s]*)?[^\/]$/.test(t)?"":"Enter the correct format":""},contentType:{type:"string",required:!0,title:"Content-Type","x-decorator":"FormItem","x-decorator-props":{},"x-component":"Select","x-component-props":{},"x-reactions":[`{{(field) => {
                    field.query('.onlyReadHeaders').take(f => {
                      f.value = { 'Content-Type': field.value };
                    });
                  }}}`],enum:[{label:"application/json",value:"application/json"},{label:"application/x-www-form-urlencoded",value:"application/x-www-form-urlencoded"},{label:"application/xml",value:"application/xml"},{label:"text/plain",value:"text/plain"}],default:"application/json"},authenticationType:{type:"string",title:`{{ t('Authentication Type', { ns: '${ge}' }) }}`,"x-decorator":"FormItem","x-decorator-props":{},"x-component":"Select","x-component-props":{},enum:[{label:H("No Authentication Required"),value:""}],default:""},onlyReadHeaders:{type:"object","x-component":"HeaderReadPretty","x-decorator":"FormItem",title:"{{ t('Headers', { ns: 'workflow-request' }) }}"},headers:{type:"array","x-component":"ArrayItems",items:{type:"object",properties:{space:{type:"void","x-component":"div","x-component-props":{style:{display:"flex",alignItems:"center"},className:lt.css`
                          .nb-form-item {
                            flex: 1;
                            &:last-child {
                              flex: none;
                            }
                            &:first-child {
                              margin-right: 6px;
                            }
                          }
                        `},properties:{key:{type:"string","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:"Key"}},value:{type:"string","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:"Value"}},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:`{{ t('Add request header', { ns: '${ge}' }) }}`,"x-component":"ArrayItems.Addition"}}},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useUpdateAction }}"}}}}}}}}}),hu=({loadMore:t})=>{const[a,u]=te.useState(null),h=te.useRef(null),C=te.useCallback(O=>{O&&(h.current&&h.current.disconnect(),h.current=new IntersectionObserver(v=>{v.forEach(P=>{P.target===O.current&&P.isIntersecting&&(h.current&&h.current.unobserve(O.current),t())})}),O.current&&h.current&&h.current.observe(O.current))},[t]);return te.useEffect(()=>(C(a),()=>{h.current&&h.current.disconnect()}),[a,C]),{lastItem:a,setLastItem:u}},Vt=()=>{const{data:t,mutate:a}=N.useResourceActionContext(),[u,h]=te.useState([]),{curApi:C,setCurApi:O}=te.useContext(yt),v=te.useMemo(()=>C!=null&&C.id?[C.id+""]:[],[C]),[P,V]=te.useState(!1),[G,ae]=te.useState(null),[I,x]=te.useState("edit"),[k,j]=te.useState(!1),fe=N.useAPIClient(),be=te.useCallback(()=>R(this,null,function*(){const F=t==null?void 0:t.meta;if(!F||F.page>=F.totalPage)return;j(!0);const m=yield fe.resource("externalApis").list({page:F.page+1,pageSize:F.pageSize});a((m==null?void 0:m.data)||{}),j(!1)}),[t]),{lastItem:xe,setLastItem:Y}=hu({loadMore:be}),S=({key:F})=>{O(u.filter(m=>m.id===Number(F))[0]||{})};te.useEffect(()=>{var m,$;if(!((m=t==null?void 0:t.data)!=null&&m.length))return;const F=te.createRef();Y(F),C!=null&&C.id||O(((t==null?void 0:t.data)||[])[0]||{}),(($=t==null?void 0:t.meta)==null?void 0:$.page)>1?h(U=>U.concat((t==null?void 0:t.data)||[])):h((t==null?void 0:t.data)||[])},[t]);const W=te.useMemo(()=>u.map((F,m)=>({key:F.id,label:m===u.length-1?A.jsx("div",{ref:xe,children:A.jsx(Vt.Item,{item:F,onEdit:$=>{V(!0),ae(F),x($)}})}):A.jsx(Vt.Item,{item:F,onEdit:$=>{V(!0),ae(F),x($)}})})),[u]);return A.jsxs(A.Fragment,{children:[u.length?A.jsx(ie.Menu,{style:{border:"none",maxHeight:"65vh",overflowY:"auto"},items:[...W,...k?[{key:"loading",label:A.jsx(ie.Spin,{})}]:[]],selectedKeys:v,onSelect:S}):A.jsx(N.Empty,{}),A.jsx(N.ActionContextProvider,{value:{visible:P,setVisible:V},children:A.jsxs(N.RecordProvider,{record:G,collectionName:"externalApis",children:[I==="edit"&&A.jsx(N.SchemaComponent,{schema:lu}),I==="configure"&&A.jsx(du,{})]})})]})};Vt.Item=({item:t,onEdit:a})=>{const{refreshAsync:u}=N.useResourceActionContext(),h=N.useAPIClient(),{setCurApi:C}=te.useContext(yt),O=()=>{ie.Modal.confirm({title:`${H("Delete")}${H("external API")}`,content:H("Are you sure you want to delete it? After deletion, all associated API call configurations will be invalid."),onOk:()=>R(this,null,function*(){yield h.resource("externalApis").destroy({filterByTk:t.id}),ie.message.success("Deleted successfully"),C({}),u()})})},v=({key:P,domEvent:V})=>{switch(V.stopPropagation(),P){case"configure":a(P);break;case"edit":a(P);break;case"delete":O()}};return A.jsxs(ie.Row,{style:{flexFlow:"nowrap"},children:[A.jsx(ie.Tooltip,{title:A.jsxs("div",{children:[A.jsxs("p",{children:[A.jsxs("span",{children:[H("API name"),": "]}),A.jsx("span",{children:t.name})]}),A.jsxs("p",{children:[A.jsxs("span",{children:[H("API Provider"),": "]}),A.jsx("span",{children:t.provider})]}),A.jsxs("p",{children:[A.jsxs("span",{children:[H("Description"),": "]}),A.jsx("span",{children:t.description})]})]}),children:A.jsx(ie.Col,{flex:3,style:{paddingRight:8,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:A.jsx("span",{children:t.name})})}),A.jsxs(ie.Col,{children:[!t.status&&A.jsx(ie.Tag,{bordered:!1,children:H("Disabled",{ns:"client"})}),A.jsx(ie.Dropdown,{menu:{items:[{label:H("Configure",{ns:"client"}),key:"configure"},{label:H("Edit",{ns:"client"}),key:"edit"},{label:H("Delete",{ns:"client"}),key:"delete"}],onClick:v},children:A.jsx(ht.MoreOutlined,{})})]})]})};const mt=te.createContext({});mt.displayName="CallApiContext";const yu=()=>{const t=Ve.useForm(),{setTestVisible:a,setConfigDetail:u}=te.useContext(mt);return{run(){return R(this,null,function*(){a(!0),u(t.values)})}}},mu=()=>{const t=Ve.useField(),a=Ve.useForm(),u=N.useActionContext(),{refresh:h}=N.useResourceActionContext(),{resource:C,targetKey:O}=N.useResourceContext(),{[O]:v}=N.useRecord();return{run(){return R(this,null,function*(){yield a.submit();let{callPath:V,method:G,externalParams:ae,requestParams:I,requestBody:x,engine:k,expression:j,subSequentParams:fe,timeout:be=5e3,retryErrorCount:xe=5}=a.values;const Y={callPath:V,method:G,externalParams:ae.map(S=>Ze($e({},S),{required:!!(S!=null&&S.required)})),requestParams:I.reduce((S,W)=>(W.key&&W.value&&S.push({[W.key]:W.value}),S),[]),requestBody:x,engine:k,expression:j,subSequentParams:fe,timeout:be,retryErrorCount:xe};t.data=t.data||{},t.data.loading=!0;try{yield C.update({filterByTk:v,values:{config:Y}}),u.setVisible(!1),a.reset(),h()}catch(S){}finally{t.data.loading=!1}})}}},vu=()=>{const{setExternalParams:t}=te.useContext(mt);return{effects:()=>{Hr.onFormInputChange(u=>{const h=Rt.cloneDeep(u.values),{externalParams:C}=h;t(C)})}}},gu=()=>{const t=Ve.useField();return{onClick(){t.query(".key").take(a=>{a.value&&(a.disabled=!0)})}}},bu=t=>{const u=[{label:"JMESPath",value:"JMESPath",link:"https://jmespath.org/"},{label:"JSON Path Plus",value:"jsonpath-plus",link:"https://jsonpath-plus.github.io/JSONPath/docs/ts/"},{label:"JSONata",value:"jsonata.js",link:"https://jsonata.org/"}].filter(h=>h.value===t)[0];return A.jsxs(A.Fragment,{children:[A.jsx("span",{className:lt.css`
          &:after {
            content: ':';
          }
          & + a {
            margin-left: 0.25em;
          }
        `,children:H("Syntax references",{ns:"client"})}),A.jsx("a",{href:u.link,target:"_blank",children:u.label})]})},$r=()=>{const{externalParams:t}=te.useContext(mt);return{scope:[{label:H("External params"),value:"$params",children:t.map(u=>({value:u.key,label:u.label}))}]}},xu=t=>{var h;Ve.useField();const a=Ve.useForm();(((h=a.values)==null?void 0:h.externalParams)||[]).forEach((C,O)=>{var G;const v=a.fields[`drawer.request.panel.externalParams.${O}.space.remove`],P=JSON.stringify(((G=a.values)==null?void 0:G.requestBody)||{}).includes(`{{$params.${C.key}}}`),V=t.value===`{{$params.${C.key}}}`;v&&(v.visible=!(P||V))});const u=$r();return A.jsx(N.Variable.Input,$e($e({},t),u))},wu=t=>{var C;const a=Ve.useField(),u=Ve.useForm();(((C=u.values)==null?void 0:C.externalParams)||[]).forEach((O,v)=>{a.query(`externalParams[${v}].remove`).take(P=>{var ae;const V=JSON.stringify(t.value||{}).includes(`{{$params.${O.key}}}`),G=(((ae=u.values)==null?void 0:ae.requestParams)||[]).some(I=>I.value===`{{$params.${O.key}}}`);P.visible=!(V||G)})});const h=$r();return A.jsx(N.Variable.JSON,$e($e({},t),h))},Au=t=>{const{title:a,labels:u}=t;return A.jsxs("div",{className:lt.css`
        font-size: 15px;
        font-weight: 500;
        color: var(--xwColorFormItemLabel);
      `,children:[A.jsxs("div",{children:[a,": "]}),A.jsxs("div",{className:lt.css`
          display: flex;
          align-items: center;
          padding: 6px 0;
          .label-item {
            margin-right: 20px;
            &:last-child {
              flex: none;
              margin-right: 0;
            }
          }
        `,children:[u.map(h=>A.jsxs("span",{className:"label-item",style:{flex:(h==null?void 0:h.flex)||1},children:[(h==null?void 0:h.required)&&A.jsx("span",{style:{color:"#ff4d4f",marginInlineEnd:4},children:"*"}),A.jsx("span",{children:h.desc})]})),A.jsx("span",{style:{visibility:"hidden",width:24}})]})]})},ku=t=>{const a=Et.ArrayBase.useArray(),u=Et.ArrayBase.useIndex();return A.jsx(ht.DeleteOutlined,{style:{paddingLeft:10},onClick:h=>{h.stopPropagation(),a.field.remove(u),a.field.setInitialValue(a.field.value)}})},Cu={uid:Nt.uid,useTestRunAction:yu,useUpdateAction:mu,useFormDecoratorProps:vu,useCentainActionProps:gu,renderExpressionDescription:bu},Su={ArrayItems:Et.ArrayItems,FormCollapse:Et.FormCollapse,CallApiVariableInput:xu,CallApiVariableJSON:wu,FormItemLabel:Au,RemoveItem:ku},Pu={type:"void",title:'{{ t("Configure") }}',"x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void",title:H("API call configuration"),"x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:t=>{const{setExternalParams:a}=te.useContext(mt),u=N.useRecord(),{config:h={}}=u,C=((h==null?void 0:h.requestParams)||[]).reduce((P,V)=>(Object.keys(V).forEach(G=>{P.push({key:G,value:V[G]})}),P),[]),O=N.useRequest(()=>Promise.resolve({data:Ze($e({},h),{requestParams:C})}),Ze($e({},t),{manual:!0})),v=N.useActionContext();return te.useEffect(()=>{v.visible&&(((h==null?void 0:h.externalParams)||[]).length&&a(h.externalParams),O.run())},[v.visible]),O}},"x-use-decorator-props":"useFormDecoratorProps",properties:{callPath:{type:"string",required:!0,title:`{{ t('Call path', { ns: '${ge}' }) }}`,"x-decorator":"FormItem","x-component":"Input","x-validator":t=>t?/^\/([a-zA-Z0-9-_:\/]+(\/[a-zA-Z0-9-_:]+)*)?(\?[a-zA-Z0-9-_=&]*)?$/.test(t)?"":"Enter the correct format":""},method:{type:"string",required:!0,title:`{{ t('HTTP method', { ns: '${ge}' }) }}`,"x-decorator":"FormItem","x-component":"Select","x-component-props":{allowClear:!1},enum:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"PUT",value:"PUT"},{label:"PATCH",value:"PATCH"},{label:"DELETE",value:"DELETE"}],default:"POST"},request:{type:"void","x-decorator":"FormItem","x-component":"FormCollapse","x-component-props":{},properties:{panel:{type:"void","x-component":"FormCollapse.CollapsePanel","x-component-props":{header:H("Request"),key:"panel"},properties:{label1:{type:"void","x-component":"FormItemLabel","x-component-props":{title:`{{ t('External params', { ns: '${ge}' }) }}`,labels:[{desc:H("Key"),flex:3,required:!0},{desc:H("Display key label"),flex:3,required:!0},{desc:H("Description"),flex:3},{desc:H("Required"),flex:1}]}},externalParams:{type:"array","x-decorator":"FormItem","x-component":"ArrayItems",description:`{{ t('External parameters are submitted through forms and other components.', { ns: '${ge}' }) }}`,items:{type:"object",properties:{space:{type:"void","x-component":"div","x-component-props":{className:lt.css`
                            display: flex;
                            align-items: flex-start;
                            .nb-form-item {
                              flex: 3;
                              margin-right: 20px;
                              &:nth-child(4) {
                                flex: 1;
                              }
                              &:last-child {
                                flex: none;
                                margin-right: 0;
                              }
                            }
                          `},properties:{outerKey:{type:"void","x-component":"div","x-component-props":{className:lt.css`
                                display: flex;
                                flex: 3;
                                margin-right: 20px;
                                .nb-form-item {
                                  flex: 3 !important;
                                  margin-right: 10px;
                                }
                              `},properties:{key:{type:"string","x-decorator":"FormItem","x-component":"Input","x-reactions":[`{{(field) => {
                                    if (field.initialValue && !field.selfModified) field.disabled = true;
                                    field.query('.centain').take(f => {
                                      f.hidden = field.disabled;
                                    });
                                  }}}`],required:!0},centain:{type:"void","x-component":"Action","x-component-props":{style:{border:0,padding:"0 4px"},icon:"CheckOutlined"},"x-use-component-props":"useCentainActionProps"}}},label:{type:"string","x-decorator":"FormItem","x-component":"Input",required:!0},desc:{type:"string","x-decorator":"FormItem","x-component":"Input"},required:{type:"string","x-decorator":"FormItem","x-component":"Checkbox"},remove:{type:"void","x-decorator":"FormItem","x-component":"RemoveItem","x-reactions":[`{{(field) => {
                                field.query('.placeholder').take(f => {
                                  f.visible = !field.visible;
                                });
                              }}}`]},placeholder:{type:"void","x-decorator":"FormItem","x-component":"div","x-component-props":{style:{width:24}}}}}}},properties:{add:{type:"void",title:`{{ t('Add external param', { ns: '${ge}' }) }}`,"x-component":"ArrayItems.Addition"}}},label2:{type:"void","x-component":"FormItemLabel","x-component-props":{title:`{{ t('Request params', { ns: '${ge}' }) }}`,labels:[{desc:H("Key"),required:!0},{desc:H("Value"),required:!0}]}},requestParams:{type:"array","x-decorator":"FormItem","x-component":"ArrayItems",items:{type:"object",properties:{space:{type:"void","x-component":"div","x-component-props":{className:lt.css`
                            display: flex;
                            align-items: center;
                            .nb-form-item {
                              flex: 1;
                              margin-right: 20px;
                              &:last-child {
                                flex: none;
                                margin-right: 0;
                              }
                            }
                          `},properties:{key:{type:"string","x-decorator":"FormItem","x-component":"Input",required:!0},value:{type:"string","x-decorator":"FormItem","x-component":"CallApiVariableInput","x-component-props":{useTypedConstant:!0},required:!0},remove:{type:"void","x-decorator":"FormItem","x-component":"RemoveItem"}}}}},properties:{add:{type:"void",title:`{{ t('Add request param', { ns: '${ge}' }) }}`,"x-component":"ArrayItems.Addition"}}},requestBody:{type:"string",title:'{{ t("Request body") }}',"x-decorator":"FormItem","x-component":"CallApiVariableJSON","x-component-props":{changeOnSelect:!0,autoSize:{minRows:10}},description:`{{ t('Only support standard JSON data.', { ns: '${ge}' }) }}`}}}}},response:{type:"void","x-decorator":"FormItem","x-component":"FormCollapse","x-component-props":{},properties:{panel:{type:"void","x-component":"FormCollapse.CollapsePanel","x-component-props":{header:H("Response"),key:"panel"},properties:{engine:{type:"string",title:`{{ t('JSON query engine', { ns: '${ge}' }) }}`,"x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{options:[{label:"JMESPath",value:"JMESPath"},{label:"JSON Path Plus",value:"jsonpath-plus"},{label:"JSONata",value:"jsonata.js"}]},"x-disabled":!0,required:!0,default:"jsonata.js"},expression:{type:"string",title:`{{ t('Query expression', { ns: '${ge}' }) }}`,"x-decorator":"FormItem","x-component":"Input","x-reactions":{dependencies:["engine"],fulfill:{schema:{description:"{{ renderExpressionDescription($deps[0]) }}"}}},required:!0},label:{type:"void","x-component":"FormItemLabel","x-component-props":{title:`{{ t('Subsequent params', { ns: '${ge}' }) }}`,labels:[{desc:H("Property key"),required:!0},{desc:H("Display key label"),required:!0},{desc:H("Description")}]}},subSequentParams:{type:"array","x-decorator":"FormItem","x-component":"ArrayItems",description:`{{ t('Subsequent parameters are used for subsequent operations, such as form autofill in form-interface linkage.', { ns: '${ge}' }) }}`,items:{type:"object",properties:{space:{type:"void","x-component":"div","x-component-props":{className:lt.css`
                            display: flex;
                            align-items: center;
                            .nb-form-item {
                              flex: 1;
                              margin-right: 20px;
                              &:last-child {
                                flex: none;
                                margin-right: 0;
                              }
                            }
                          `},properties:{key:{type:"string","x-decorator":"FormItem","x-component":"Input",required:!0},title:{type:"string","x-decorator":"FormItem","x-component":"Input",required:!0},description:{type:"string","x-decorator":"FormItem","x-component":"Input"},remove:{type:"void","x-decorator":"FormItem","x-component":"RemoveItem"}}}}},properties:{add:{type:"void",title:`{{ t('Add subsequent param', { ns: '${ge}' }) }}`,"x-component":"ArrayItems.Addition"}}}}}}},timeout:{type:"number",title:`{{ t('Timeout config', { ns: '${ge}' }) }}`,"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{addonAfter:'{{ t("ms") }}',min:1e3,max:3e4,step:1e3,defaultValue:5e3,parser:t=>t.replace(/\D/g,""),style:{width:"100%"}}},retryErrorCount:{type:"number",title:`{{ t('Failed request retry count', { ns: '${ge}' }) }}`,"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{min:1,max:5,step:1,defaultValue:5,parser:t=>t.replace(/\D/g,"")},description:`{{ t('Only accepts integer values between 1 and 5. Leaving it blank will be considered as a failure and will not retry.', { ns: '${ge}' }) }}`},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{test:{title:`{{ t('Test run', { ns: '${ge}' }) }}`,"x-component":"Action","x-component-props":{style:{width:108,marginRight:"calc(100% - 268px - 24px)"},icon:"CaretRightOutlined",useAction:"{{ useTestRunAction }}"}},cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{style:{width:80},useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{style:{width:80},type:"primary",useAction:"{{ useUpdateAction }}"}}}}}}}};function Ht(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var _r={exports:{}};(function(t,a){(function(u){t.exports=u()})(function(){return function(){function u(h,C,O){function v(G,ae){if(!C[G]){if(!h[G]){var I=typeof Ht=="function"&&Ht;if(!ae&&I)return I(G,!0);if(P)return P(G,!0);var x=new Error("Cannot find module '"+G+"'");throw x.code="MODULE_NOT_FOUND",x}var k=C[G]={exports:{}};h[G][0].call(k.exports,function(j){var fe=h[G][1][j];return v(fe||j)},k,k.exports,u,h,C,O)}return C[G].exports}for(var P=typeof Ht=="function"&&Ht,V=0;V<O.length;V++)v(O[V]);return v}return u}()({1:[function(u,h,C){const O=u("./utils"),v=function(){const P=O.stringToArray,V=["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],G=["Zeroth","First","Second","Third","Fourth","Fifth","Sixth","Seventh","Eighth","Ninth","Tenth","Eleventh","Twelfth","Thirteenth","Fourteenth","Fifteenth","Sixteenth","Seventeenth","Eighteenth","Nineteenth"],ae=["Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety","Hundred"],I=["Thousand","Million","Billion","Trillion"];function x(d,b){var y=function(_,D,w){var M="";if(_<=19)M=(D?" and ":"")+(w?G[_]:V[_]);else if(_<100){const he=Math.floor(_/10),me=_%10;M=(D?" and ":"")+ae[he-2],me>0?M+="-"+y(me,!1,w):w&&(M=M.substring(0,M.length-1)+"ieth")}else if(_<1e3){const he=Math.floor(_/100),me=_%100;M=(D?", ":"")+V[he]+" Hundred",me>0?M+=y(me,!0,w):w&&(M+="th")}else{var Z=Math.floor(Math.log10(_)/3);Z>I.length&&(Z=I.length);const he=Math.pow(10,Z*3),me=Math.floor(_/he),J=_-me*he;M=(D?", ":"")+y(me,!1,!1)+" "+I[Z-1],J>0?M+=y(J,!0,w):w&&(M+="th")}return M},T=y(d,!1,b);return T}const k={};V.forEach(function(d,b){k[d.toLowerCase()]=b}),G.forEach(function(d,b){k[d.toLowerCase()]=b}),ae.forEach(function(d,b){const y=d.toLowerCase();k[y]=(b+2)*10,k[y.substring(0,d.length-1)+"ieth"]=k[y]}),k.hundredth=100,I.forEach(function(d,b){const y=d.toLowerCase(),T=Math.pow(10,(b+1)*3);k[y]=T,k[y+"th"]=T});function j(d){const y=d.split(/,\s|\sand\s|[\s\\-]/).map(D=>k[D]);let T=[0];return y.forEach(D=>{if(D<100){let w=T.pop();w>=1e3&&(T.push(w),w=0),T.push(w+D)}else T.push(T.pop()*D)}),T.reduce((D,w)=>D+w,0)}const fe=[[1e3,"m"],[900,"cm"],[500,"d"],[400,"cd"],[100,"c"],[90,"xc"],[50,"l"],[40,"xl"],[10,"x"],[9,"ix"],[5,"v"],[4,"iv"],[1,"i"]],be={M:1e3,D:500,C:100,L:50,X:10,V:5,I:1};function xe(d){for(var b=0;b<fe.length;b++){const y=fe[b];if(d>=y[0])return y[1]+xe(d-y[0])}return""}function Y(d){for(var b=0,y=1,T=d.length-1;T>=0;T--){const _=d[T],D=be[_];D<y?b-=D:(y=D,b+=D)}return b}function S(d,b){for(var y=[],T=b.charCodeAt(0);d>0;)y.unshift(String.fromCharCode((d-1)%26+T)),d=Math.floor((d-1)/26);return y.join("")}function W(d,b){for(var y=b.charCodeAt(0),T=0,_=0;_<d.length;_++)T+=(d.charCodeAt(d.length-_-1)-y+1)*Math.pow(26,_);return T}function F(d,b){if(typeof d=="undefined")return;d=Math.floor(d);const y=K(b);return U(d,y)}const m={DECIMAL:"decimal",LETTERS:"letters",ROMAN:"roman",WORDS:"words",SEQUENCE:"sequence"},$={UPPER:"upper",LOWER:"lower",TITLE:"title"};function U(d,b){let y;const T=d<0;switch(d=Math.abs(d),b.primary){case m.LETTERS:y=S(d,b.case===$.UPPER?"A":"a");break;case m.ROMAN:y=xe(d),b.case===$.UPPER&&(y=y.toUpperCase());break;case m.WORDS:y=x(d,b.ordinal),b.case===$.UPPER?y=y.toUpperCase():b.case===$.LOWER&&(y=y.toLowerCase());break;case m.DECIMAL:y=""+d;var _=b.mandatoryDigits-y.length;if(_>0){var D=new Array(_+1).join("0");y=D+y}if(b.zeroCode!==48&&(y=P(y).map(he=>String.fromCodePoint(he.codePointAt(0)+b.zeroCode-48)).join("")),b.regular){const he=Math.floor((y.length-1)/b.groupingSeparators.position);for(let me=he;me>0;me--){const J=y.length-me*b.groupingSeparators.position;y=y.substr(0,J)+b.groupingSeparators.character+y.substr(J)}}else b.groupingSeparators.reverse().forEach(he=>{const me=y.length-he.position;y=y.substr(0,me)+he.character+y.substr(me)});if(b.ordinal){var w={1:"st",2:"nd",3:"rd"},M=y[y.length-1],Z=w[M];(!Z||y.length>1&&y[y.length-2]==="1")&&(Z="th"),y=y+Z}break;case m.SEQUENCE:throw{code:"D3130",value:b.token}}return T&&(y="-"+y),y}const se=[48,1632,1776,1984,2406,2534,2662,2790,2918,3046,3174,3302,3430,3558,3664,3792,3872,4160,4240,6112,6160,6470,6608,6784,6800,6992,7088,7232,7248,42528,43216,43264,43472,43504,43600,44016,65296];function K(d){const b={type:"integer",primary:m.DECIMAL,case:$.LOWER,ordinal:!1};let y,T;const _=d.lastIndexOf(";");switch(_===-1?y=d:(y=d.substring(0,_),T=d.substring(_+1),T[0]==="o"&&(b.ordinal=!0)),y){case"A":b.case=$.UPPER;case"a":b.primary=m.LETTERS;break;case"I":b.case=$.UPPER;case"i":b.primary=m.ROMAN;break;case"W":b.case=$.UPPER,b.primary=m.WORDS;break;case"Ww":b.case=$.TITLE,b.primary=m.WORDS;break;case"w":b.primary=m.WORDS;break;default:{let D=null,w=0,M=0,Z=[],he=0;if(P(y).map(J=>J.codePointAt(0)).reverse().forEach(J=>{let ee=!1;for(let ke=0;ke<se.length;ke++){const B=se[ke];if(J>=B&&J<=B+9){if(ee=!0,w++,he++,D===null)D=B;else if(B!==D)throw{code:"D3131"};break}}ee||(J===35?(he++,M++):Z.push({position:he,character:String.fromCodePoint(J)}))}),w>0){b.primary=m.DECIMAL,b.zeroCode=D,b.mandatoryDigits=w,b.optionalDigits=M;const ee=function(ke){if(ke.length===0)return 0;const B=ke[0].character;for(let je=1;je<ke.length;je++)if(ke[je].character!==B)return 0;const ze=ke.map(je=>je.position),rt=function(je,Ye){return Ye===0?je:rt(Ye,je%Ye)},Ge=ze.reduce(rt);for(let je=1;je<=ze.length;je++)if(ze.indexOf(je*Ge)===-1)return 0;return Ge}(Z);ee>0?(b.regular=!0,b.groupingSeparators={position:ee,character:Z[0].character}):(b.regular=!1,b.groupingSeparators=Z)}else b.primary=m.SEQUENCE,b.token=y}}return b}const Q={Y:"1",M:"1",D:"1",d:"1",F:"n",W:"1",w:"1",X:"1",x:"1",H:"1",h:"1",P:"n",m:"01",s:"01",f:"1",Z:"01:01",z:"01:01",C:"n",E:"n"};function oe(d){var b=[];const y={type:"datetime",parts:b},T=function(ee,ke){if(ke>ee){let B=d.substring(ee,ke);B=B.split("]]").join("]"),b.push({type:"literal",value:B})}};for(var _=0,D=0;D<d.length;){if(d.charAt(D)==="["){if(d.charAt(D+1)==="["){T(_,D),b.push({type:"literal",value:"["}),D+=2,_=D;continue}if(T(_,D),_=D,D=d.indexOf("]",_),D===-1)throw{code:"D3135"};let ee=d.substring(_+1,D);ee=ee.split(/\s+/).join("");var w={type:"marker",component:ee.charAt(0)},M=ee.lastIndexOf(","),Z;if(M!==-1){const ke=ee.substring(M+1),B=ke.indexOf("-");let ze,rt;const Ge=function(Ye){if(!(typeof Ye=="undefined"||Ye==="*"))return parseInt(Ye)};B===-1?ze=ke:(ze=ke.substring(0,B),rt=ke.substring(B+1));const je={min:Ge(ze),max:Ge(rt)};w.width=je,Z=ee.substring(1,M)}else Z=ee.substring(1);if(Z.length===1)w.presentation1=Z;else if(Z.length>1){var he=Z.charAt(Z.length-1);"atco".indexOf(he)!==-1?(w.presentation2=he,he==="o"&&(w.ordinal=!0),w.presentation1=Z.substring(0,Z.length-1)):w.presentation1=Z}else w.presentation1=Q[w.component];if(typeof w.presentation1=="undefined")throw{code:"D3132",value:w.component};if(w.presentation1[0]==="n")w.names=$.LOWER;else if(w.presentation1[0]==="N")w.presentation1[1]==="n"?w.names=$.TITLE:w.names=$.UPPER;else if("YMDdFWwXxHhmsf".indexOf(w.component)!==-1){var me=w.presentation1;if(w.presentation2&&(me+=";"+w.presentation2),w.integerFormat=K(me),w.width&&w.width.min!==void 0&&w.integerFormat.mandatoryDigits<w.width.min&&(w.integerFormat.mandatoryDigits=w.width.min),"YMD".indexOf(w.component)!==-1)if(w.n=-1,w.width&&w.width.max!==void 0)w.n=w.width.max,w.integerFormat.mandatoryDigits=w.n;else{var J=w.integerFormat.mandatoryDigits+w.integerFormat.optionalDigits;J>=2&&(w.n=J)}}(w.component==="Z"||w.component==="z")&&(w.integerFormat=K(w.presentation1)),b.push(w),_=D+1}D++}return T(_,D),y}const pe=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],Se=["January","February","March","April","May","June","July","August","September","October","November","December"],Ne=1e3*60*60*24,we=function(d){const b=Date.UTC(d.year,d.month);var y=new Date(b).getUTCDay();return y===0&&(y=7),y>4?b+(8-y)*Ne:b-(y-1)*Ne},ce=function(d,b){return{year:d,month:b,nextMonth:function(){return b===11?ce(d+1,0):ce(d,b+1)},previousMonth:function(){return b===0?ce(d-1,11):ce(d,b-1)},nextYear:function(){return ce(d+1,b)},previousYear:function(){return ce(d-1,b)}}},Xe=function(d,b){return(b-d)/(Ne*7)+1},ne=(d,b)=>{let y;switch(b){case"Y":y=d.getUTCFullYear();break;case"M":y=d.getUTCMonth()+1;break;case"D":y=d.getUTCDate();break;case"d":{const T=Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()),_=Date.UTC(d.getUTCFullYear(),0);y=(T-_)/Ne+1;break}case"F":y=d.getUTCDay(),y===0&&(y=7);break;case"W":{const T=ce(d.getUTCFullYear(),0),_=we(T),D=Date.UTC(T.year,d.getUTCMonth(),d.getUTCDate());let w=Xe(_,D);if(w>52){const M=we(T.nextYear());D>=M&&(w=1)}else if(w<1){const M=we(T.previousYear());w=Xe(M,D)}y=Math.floor(w);break}case"w":{const T=ce(d.getUTCFullYear(),d.getUTCMonth()),_=we(T),D=Date.UTC(T.year,T.month,d.getUTCDate());let w=Xe(_,D);if(w>4){const M=we(T.nextMonth());D>=M&&(w=1)}else if(w<1){const M=we(T.previousMonth());w=Xe(M,D)}y=Math.floor(w);break}case"X":{const T=ce(d.getUTCFullYear(),0),_=we(T),D=we(T.nextYear()),w=d.getTime();w<_?y=T.year-1:w>=D?y=T.year+1:y=T.year;break}case"x":{const T=ce(d.getUTCFullYear(),d.getUTCMonth()),_=we(T),D=T.nextMonth(),w=we(D),M=d.getTime();M<_?y=T.previousMonth().month+1:M>=w?y=D.month+1:y=T.month+1;break}case"H":y=d.getUTCHours();break;case"h":y=d.getUTCHours(),y=y%12,y===0&&(y=12);break;case"P":y=d.getUTCHours()>=12?"pm":"am";break;case"m":y=d.getUTCMinutes();break;case"s":y=d.getUTCSeconds();break;case"f":y=d.getUTCMilliseconds();break;case"Z":case"z":break;case"C":y="ISO";break;case"E":y="ISO";break}return y};let _e=null;function tt(d,b,y){var T=0,_=0;if(typeof y!="undefined"){const me=parseInt(y);T=Math.floor(me/100),_=me%100}var D=function(me,J){var ee=ne(me,J.component);if("YMDdFWwXxHhms".indexOf(J.component)!==-1)if(J.component==="Y"&&J.n!==-1&&(ee=ee%Math.pow(10,J.n)),J.names){if(J.component==="M"||J.component==="x")ee=Se[ee-1];else if(J.component==="F")ee=pe[ee];else throw{code:"D3133",value:J.component};J.names===$.UPPER?ee=ee.toUpperCase():J.names===$.LOWER&&(ee=ee.toLowerCase()),J.width&&ee.length>J.width.max&&(ee=ee.substring(0,J.width.max))}else ee=U(ee,J.integerFormat);else if(J.component==="f")ee=U(ee,J.integerFormat);else if(J.component==="Z"||J.component==="z"){const ke=T*100+_;if(J.integerFormat.regular)ee=U(ke,J.integerFormat);else{const B=J.integerFormat.mandatoryDigits;if(B===1||B===2)ee=U(T,J.integerFormat),_!==0&&(ee+=":"+F(_,"00"));else if(B===3||B===4)ee=U(ke,J.integerFormat);else throw{code:"D3134",value:B}}ke>=0&&(ee="+"+ee),J.component==="z"&&(ee="GMT"+ee),ke===0&&J.presentation2==="t"&&(ee="Z")}else J.component==="P"&&J.names===$.UPPER&&(ee=ee.toUpperCase());return ee};let w;typeof b=="undefined"?(_e===null&&(_e=oe("[Y0001]-[M01]-[D01]T[H01]:[m01]:[s01].[f001][Z01:01t]")),w=_e):w=oe(b);const M=(60*T+_)*60*1e3,Z=new Date(d+M);let he="";return w.parts.forEach(function(me){me.type==="literal"?he+=me.value:he+=D(Z,me)}),he}function i(d){var b={};if(d.type==="datetime")b.type="datetime",b.parts=d.parts.map(function(y){var T={};if(y.type==="literal")T.regex=y.value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");else if(y.component==="Z"||y.component==="z"){let D;Array.isArray(y.integerFormat.groupingSeparators)||(D=y.integerFormat.groupingSeparators),T.regex="",y.component==="z"&&(T.regex="GMT"),T.regex+="[-+][0-9]+",D&&(T.regex+=D.character+"[0-9]+"),T.parse=function(w){y.component==="z"&&(w=w.substring(3));let M=0,Z=0;return D?(M=Number.parseInt(w.substring(0,w.indexOf(D.character))),Z=Number.parseInt(w.substring(w.indexOf(D.character)+1))):w.length-1<=2?M=Number.parseInt(w):(M=Number.parseInt(w.substring(0,3)),Z=Number.parseInt(w.substring(3))),M*60+Z}}else if(y.integerFormat)y.integerFormat.n=y.n,T=i(y.integerFormat);else{T.regex="[a-zA-Z]+";var _={};if(y.component==="M"||y.component==="x")Se.forEach(function(D,w){y.width&&y.width.max?_[D.substring(0,y.width.max)]=w+1:_[D]=w+1});else if(y.component==="F")pe.forEach(function(D,w){w>0&&(y.width&&y.width.max?_[D.substring(0,y.width.max)]=w:_[D]=w)});else if(y.component==="P")_={am:0,AM:0,pm:1,PM:1};else throw{code:"D3133",value:y.component};T.parse=function(D){return _[D]}}return T.component=y.component,T});else{b.type="integer";const y=d.case===$.UPPER;let T;switch(d.n&&d.n>0?d.optionalDigits===0?T=`{${d.n}}`:T=`{${d.n-d.optionalDigits},${d.n}}`:T="+",d.primary){case m.LETTERS:b.regex=y?"[A-Z]+":"[a-z]+",b.parse=function(_){return W(_,y?"A":"a")};break;case m.ROMAN:b.regex=y?"[MDCLXVI]+":"[mdclxvi]+",b.parse=function(_){return Y(y?_:_.toUpperCase())};break;case m.WORDS:b.regex="(?:"+Object.keys(k).concat("and","[\\-, ]").join("|")+")+",b.parse=function(_){return j(_.toLowerCase())};break;case m.DECIMAL:b.regex=`[0-9]${T}`,d.ordinal&&(b.regex+="(?:th|st|nd|rd)"),b.parse=function(_){let D=_;return d.ordinal&&(D=_.substring(0,_.length-2)),d.regular?D=D.split(",").join(""):d.groupingSeparators.forEach(w=>{D=D.split(w.character).join("")}),d.zeroCode!==48&&(D=D.split("").map(w=>String.fromCodePoint(w.codePointAt(0)-d.zeroCode+48)).join("")),parseInt(D)};break;case m.SEQUENCE:throw{code:"D3130",value:d.token}}}return b}function l(d,b){if(typeof d=="undefined")return;const y=K(b);return i(y).parse(d)}function z(d,b){const y=oe(b),T=i(y),_="^"+T.parts.map(Z=>"("+Z.regex+")").join("")+"$";var w=new RegExp(_,"i").exec(d);if(w!==null){const B={};for(let Pe=1;Pe<w.length;Pe++){const n=T.parts[Pe-1];n.parse&&(B[n.component]=n.parse(w[Pe]))}if(Object.getOwnPropertyNames(B).length===0)return;let ze=0;const rt=Pe=>{ze<<=1,ze+=Pe?1:0},Ge=Pe=>!(~Pe&ze)&&!!(Pe&ze);"YXMxWwdD".split("").forEach(Pe=>rt(B[Pe]));const Ye=!Ge(161)&&Ge(130),ut=Ge(84),ft=!ut&&Ge(72);ze=0,"PHhmsf".split("").forEach(Pe=>rt(B[Pe]));const pt=!Ge(23)&&Ge(47),Ot=(Ye?"YD":ut?"XxwF":ft?"XWF":"YMD")+(pt?"Phmsf":"Hmsf"),ot=this.environment.timestamp;let kt=!1,it=!1;if(Ot.split("").forEach(Pe=>{if(typeof B[Pe]=="undefined")kt?(B[Pe]="MDd".indexOf(Pe)!==-1?1:0,it=!0):B[Pe]=ne(ot,Pe);else if(kt=!0,it)throw{code:"D3136"}}),B.M>0?B.M-=1:B.M=0,Ye){const Pe=Date.UTC(B.Y,0),n=(B.d-1)*1e3*60*60*24,s=new Date(Pe+n);B.M=s.getUTCMonth(),B.D=s.getUTCDate()}if(ut)throw{code:"D3136"};if(ft)throw{code:"D3136"};pt&&(B.H=B.h===12?0:B.h,B.P===1&&(B.H+=12));var M=Date.UTC(B.Y,B.M,B.D,B.H,B.m,B.s,B.f);return(B.Z||B.z)&&(M-=(B.Z||B.z)*60*1e3),M}}var le=new RegExp("^\\d{4}(-[01]\\d)*(-[0-3]\\d)*(T[0-2]\\d:[0-5]\\d:[0-5]\\d)*(\\.\\d+)?([+-][0-2]\\d:?[0-5]\\d|Z)?$");function Ee(d,b){if(typeof d!="undefined")if(typeof b=="undefined"){if(!le.test(d))throw{stack:new Error().stack,code:"D3110",value:d};return Date.parse(d)}else return z.call(this,d,b)}function Ae(d,b,y){if(typeof d!="undefined")return tt.call(this,d,b,y)}return{formatInteger:F,parseInteger:l,fromMillis:Ae,toMillis:Ee}}();h.exports=v},{"./utils":6}],2:[function(u,h,C){(function(O){(function(){var v=u("./utils");const P=(()=>{var V=v.isNumeric,G=v.isArrayOfStrings,ae=v.isArrayOfNumbers,I=v.createSequence,x=v.isSequence,k=v.isFunction,j=v.isLambda,fe=v.isPromise,be=v.getFunctionArity,xe=v.isDeepEqual,Y=v.stringToArray;function S(e){if(typeof e!="undefined"){var r=0;return e.forEach(function(o){r+=o}),r}}function W(e){return typeof e=="undefined"?0:e.length}function F(e){if(!(typeof e=="undefined"||e.length===0))return Math.max.apply(Math,e)}function m(e){if(!(typeof e=="undefined"||e.length===0))return Math.min.apply(Math,e)}function $(e){if(!(typeof e=="undefined"||e.length===0)){var r=0;return e.forEach(function(o){r+=o}),r/e.length}}function U(e,r=!1){if(typeof e!="undefined"){var o;if(typeof e=="string")o=e;else if(k(e))o="";else{if(typeof e=="number"&&!isFinite(e))throw{code:"D3001",value:e,stack:new Error().stack};var p=r?2:0;Array.isArray(e)&&e.outerWrapper&&(e=e[0]),o=JSON.stringify(e,function(c,g){return typeof g!="undefined"&&g!==null&&g.toPrecision&&V(g)?Number(g.toPrecision(15)):g&&k(g)?"":g},p)}return o}}function se(e,r,o){if(typeof e!="undefined"){var p=Y(e),c=p.length;if(c+r<0&&(r=0),typeof o!="undefined"){if(o<=0)return"";var g=r>=0?r+o:c+r+o;return p.slice(r,g).join("")}return p.slice(r).join("")}}function K(e,r){if(typeof e!="undefined"){var o=e.indexOf(r);return o>-1?e.substr(0,o):e}}function Q(e,r){if(typeof e!="undefined"){var o=e.indexOf(r);return o>-1?e.substr(o+r.length):e}}function oe(e){if(typeof e!="undefined")return e.toLowerCase()}function pe(e){if(typeof e!="undefined")return e.toUpperCase()}function Se(e){if(typeof e!="undefined")return Y(e).length}function Ne(e){if(typeof e!="undefined"){var r=e.replace(/[ \t\n\r]+/gm," ");return r.charAt(0)===" "&&(r=r.substring(1)),r.charAt(r.length-1)===" "&&(r=r.substring(0,r.length-1)),r}}function we(e,r,o){if(typeof e!="undefined"){(typeof o=="undefined"||o.length===0)&&(o=" ");var p,c=Math.abs(r)-Se(e);if(c>0){var g=new Array(c+1).join(o);o.length>1&&(g=se(g,0,c)),r>0?p=e+g:p=g+e}else p=e;return p}}function ce(e,r){return R(this,null,function*(){var o=e.apply(this,[r]);if(fe(o)&&(o=yield o),o&&!(typeof o.start=="number"||o.end==="number"||Array.isArray(o.groups)||k(o.next)))throw{code:"T1010",stack:new Error().stack};return o})}function Xe(e,r){return R(this,null,function*(){if(typeof e!="undefined"){var o;if(typeof r=="string")o=e.indexOf(r)!==-1;else{var p=yield ce(r,e);o=typeof p!="undefined"}return o}})}function ne(e,r,o){return R(this,null,function*(){if(typeof e!="undefined"){if(o<0)throw{stack:new Error().stack,value:o,code:"D3040",index:3};var p=I();if(typeof o=="undefined"||o>0){var c=0,g=yield ce(r,e);if(typeof g!="undefined")for(;typeof g!="undefined"&&(typeof o=="undefined"||c<o);)p.push({match:g.match,index:g.start,groups:g.groups}),g=yield ce(g.next),c++}return p}})}function _e(e,r,o,p){return R(this,null,function*(){if(typeof e!="undefined"){var c=this;if(r==="")throw{code:"D3010",stack:new Error().stack,value:r,index:2};if(p<0)throw{code:"D3011",stack:new Error().stack,value:p,index:4};var g;typeof o=="string"?g=function(Ce){for(var Le="",ve=0,Fe=o.indexOf("$",ve);Fe!==-1&&ve<o.length;){Le+=o.substring(ve,Fe),ve=Fe+1;var nt=o.charAt(ve);if(nt==="$")Le+="$",ve++;else if(nt==="0")Le+=Ce.match,ve++;else{var He;if(Ce.groups.length===0?He=1:He=Math.floor(Math.log(Ce.groups.length)*Math.LOG10E)+1,Fe=parseInt(o.substring(ve,ve+He),10),He>1&&Fe>Ce.groups.length&&(Fe=parseInt(o.substring(ve,ve+He-1),10)),isNaN(Fe))Le+="$";else{if(Ce.groups.length>0){var Ct=Ce.groups[Fe-1];typeof Ct!="undefined"&&(Le+=Ct)}ve+=Fe.toString().length}}Fe=o.indexOf("$",ve)}return Le+=o.substring(ve),Le}:g=o;var E="",L=0;if(typeof p=="undefined"||p>0){var X=0;if(typeof r=="string"){for(var Te=e.indexOf(r,L);Te!==-1&&(typeof p=="undefined"||X<p);)E+=e.substring(L,Te),E+=o,L=Te+r.length,X++,Te=e.indexOf(r,L);E+=e.substring(L)}else{var de=yield ce(r,e);if(typeof de!="undefined"){for(;typeof de!="undefined"&&(typeof p=="undefined"||X<p);){E+=e.substring(L,de.start);var De=g.apply(c,[de]);if(fe(De)&&(De=yield De),typeof De=="string")E+=De;else throw{code:"D3012",stack:new Error().stack,value:De};L=de.start+de.match.length,X++,de=yield ce(de.next)}E+=e.substring(L)}else E=e}}else E=e;return E}})}function tt(e){if(typeof e!="undefined"){var r=typeof window!="undefined"?window.btoa:function(o){return new O.Buffer.from(o,"binary").toString("base64")};return r(e)}}function i(e){if(typeof e!="undefined"){var r=typeof window!="undefined"?window.atob:function(o){return new O.Buffer.from(o,"base64").toString("binary")};return r(e)}}function l(e){if(typeof e!="undefined"){var r;try{r=encodeURIComponent(e)}catch(o){throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrlComponent"}}return r}}function z(e){if(typeof e!="undefined"){var r;try{r=encodeURI(e)}catch(o){throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrl"}}return r}}function le(e){if(typeof e!="undefined"){var r;try{r=decodeURIComponent(e)}catch(o){throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrlComponent"}}return r}}function Ee(e){if(typeof e!="undefined"){var r;try{r=decodeURI(e)}catch(o){throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrl"}}return r}}function Ae(e,r,o){return R(this,null,function*(){if(typeof e!="undefined"){if(o<0)throw{code:"D3020",stack:new Error().stack,value:o,index:3};var p=[];if(typeof o=="undefined"||o>0)if(typeof r=="string")p=e.split(r,o);else{var c=0,g=yield ce(r,e);if(typeof g!="undefined"){for(var E=0;typeof g!="undefined"&&(typeof o=="undefined"||c<o);)p.push(e.substring(E,g.start)),E=g.end,g=yield ce(g.next),c++;(typeof o=="undefined"||c<o)&&p.push(e.substring(E))}else p.push(e)}return p}})}function d(e,r){if(typeof e!="undefined")return typeof r=="undefined"&&(r=""),e.join(r)}function b(e,r,o){if(typeof e!="undefined"){var p={"decimal-separator":".","grouping-separator":",","exponent-separator":"e",infinity:"Infinity","minus-sign":"-",NaN:"NaN",percent:"%","per-mille":"‰","zero-digit":"0",digit:"#","pattern-separator":";"},c=p;typeof o!="undefined"&&Object.keys(o).forEach(function(re){c[re]=o[re]});for(var g=[],E=c["zero-digit"].charCodeAt(0),L=E;L<E+10;L++)g.push(String.fromCharCode(L));var X=g.concat([c["decimal-separator"],c["exponent-separator"],c["grouping-separator"],c.digit,c["pattern-separator"]]),Te=r.split(c["pattern-separator"]);if(Te.length>2)throw{code:"D3080",stack:new Error().stack};var de=function(re){var Oe=function(){for(var qe,et=0;et<re.length;et++)if(qe=re.charAt(et),X.indexOf(qe)!==-1&&qe!==c["exponent-separator"])return re.substring(0,et)}(),Je=function(){for(var qe,et=re.length-1;et>=0;et--)if(qe=re.charAt(et),X.indexOf(qe)!==-1&&qe!==c["exponent-separator"])return re.substring(et+1)}(),Ie=re.substring(Oe.length,re.length-Je.length),We,dt,Re,gt,Qe=re.indexOf(c["exponent-separator"],Oe.length);Qe===-1||Qe>re.length-Je.length?(We=Ie,dt=void 0):(We=Ie.substring(0,Qe),dt=Ie.substring(Qe+1));var at=We.indexOf(c["decimal-separator"]);return at===-1?(Re=We,gt=Je):(Re=We.substring(0,at),gt=We.substring(at+1)),{prefix:Oe,suffix:Je,activePart:Ie,mantissaPart:We,exponentPart:dt,integerPart:Re,fractionalPart:gt,subpicture:re}},De=function(re){var Oe,Je,Ie=re.subpicture,We=Ie.indexOf(c["decimal-separator"]);We!==Ie.lastIndexOf(c["decimal-separator"])&&(Oe="D3081"),Ie.indexOf(c.percent)!==Ie.lastIndexOf(c.percent)&&(Oe="D3082"),Ie.indexOf(c["per-mille"])!==Ie.lastIndexOf(c["per-mille"])&&(Oe="D3083"),Ie.indexOf(c.percent)!==-1&&Ie.indexOf(c["per-mille"])!==-1&&(Oe="D3084");var dt=!1;for(Je=0;Je<re.mantissaPart.length;Je++){var Re=re.mantissaPart.charAt(Je);if(g.indexOf(Re)!==-1||Re===c.digit){dt=!0;break}}dt||(Oe="D3085");var gt=re.activePart.split("").map(function(qe){return X.indexOf(qe)===-1?"p":"a"}).join("");gt.indexOf("p")!==-1&&(Oe="D3086"),We!==-1?(Ie.charAt(We-1)===c["grouping-separator"]||Ie.charAt(We+1)===c["grouping-separator"])&&(Oe="D3087"):re.integerPart.charAt(re.integerPart.length-1)===c["grouping-separator"]&&(Oe="D3088"),Ie.indexOf(c["grouping-separator"]+c["grouping-separator"])!==-1&&(Oe="D3089");var Qe=re.integerPart.indexOf(c.digit);Qe!==-1&&re.integerPart.substring(0,Qe).split("").filter(function(qe){return g.indexOf(qe)>-1}).length>0&&(Oe="D3090"),Qe=re.fractionalPart.lastIndexOf(c.digit),Qe!==-1&&re.fractionalPart.substring(Qe).split("").filter(function(qe){return g.indexOf(qe)>-1}).length>0&&(Oe="D3091");var at=typeof re.exponentPart=="string";if(at&&re.exponentPart.length>0&&(Ie.indexOf(c.percent)!==-1||Ie.indexOf(c["per-mille"])!==-1)&&(Oe="D3092"),at&&(re.exponentPart.length===0||re.exponentPart.split("").filter(function(qe){return g.indexOf(qe)===-1}).length>0)&&(Oe="D3093"),Oe)throw{code:Oe,stack:new Error().stack}},Ce=function(re){var Oe=function(Be,Jt){for(var _t=[],ct=Be.indexOf(c["grouping-separator"]);ct!==-1;){var Wt=(Jt?Be.substring(0,ct):Be.substring(ct)).split("").filter(function(Pt){return g.indexOf(Pt)!==-1||Pt===c.digit}).length;_t.push(Wt),ct=re.integerPart.indexOf(c["grouping-separator"],ct+1)}return _t},Je=Oe(re.integerPart),Ie=function(Be){if(Be.length===0)return 0;for(var Jt=function(Wt,Pt){return Pt===0?Wt:Jt(Pt,Wt%Pt)},_t=Be.reduce(Jt),ct=1;ct<=Be.length;ct++)if(Be.indexOf(ct*_t)===-1)return 0;return _t},We=Ie(Je),dt=Oe(re.fractionalPart,!0),Re=re.integerPart.split("").filter(function(Be){return g.indexOf(Be)!==-1}).length,gt=Re,Qe=re.fractionalPart.split(""),at=Qe.filter(function(Be){return g.indexOf(Be)!==-1}).length,qe=Qe.filter(function(Be){return g.indexOf(Be)!==-1||Be===c.digit}).length,et=typeof re.exponentPart=="string";Re===0&&qe===0&&(et?(at=1,qe=1):Re=1),et&&Re===0&&re.integerPart.indexOf(c.digit)!==-1&&(Re=1),Re===0&&at===0&&(at=1);var zr=0;return et&&(zr=re.exponentPart.split("").filter(function(Be){return g.indexOf(Be)!==-1}).length),{integerPartGroupingPositions:Je,regularGrouping:We,minimumIntegerPartSize:Re,scalingFactor:gt,prefix:re.prefix,fractionalPartGroupingPositions:dt,minimumFactionalPartSize:at,maximumFactionalPartSize:qe,minimumExponentSize:zr,suffix:re.suffix,picture:re.subpicture}},Le=Te.map(de);Le.forEach(De);var ve=Le.map(Ce),Fe=c["minus-sign"],nt=c["zero-digit"],He=c["decimal-separator"],Ct=c["grouping-separator"];ve.length===1&&(ve.push(JSON.parse(JSON.stringify(ve[0]))),ve[1].prefix=Fe+ve[1].prefix);var Me;e>=0?Me=ve[0]:Me=ve[1];var Ft;Me.picture.indexOf(c.percent)!==-1?Ft=e*100:Me.picture.indexOf(c["per-mille"])!==-1?Ft=e*1e3:Ft=e;var vt,St;if(Me.minimumExponentSize===0)vt=Ft;else{var Vu=Math.pow(10,Me.scalingFactor),Hu=Math.pow(10,Me.scalingFactor-1);for(vt=Ft,St=0;vt<Hu;)vt*=10,St-=1;for(;vt>Vu;)vt/=10,St+=1}var Bu=M(vt,Me.maximumFactionalPartSize),qr=function(re,Oe){var Je=Math.abs(re).toFixed(Oe);return nt!=="0"&&(Je=Je.split("").map(function(Ie){return Ie>="0"&&Ie<="9"?g[Ie.charCodeAt(0)-48]:Ie}).join("")),Je},ue=qr(Bu,Me.maximumFactionalPartSize),Ke=ue.indexOf(".");for(Ke===-1?ue=ue+He:ue=ue.replace(".",He);ue.charAt(0)===nt;)ue=ue.substring(1);for(;ue.charAt(ue.length-1)===nt;)ue=ue.substring(0,ue.length-1);Ke=ue.indexOf(He);var $t=Me.minimumIntegerPartSize-Ke,Ur=Me.minimumFactionalPartSize-(ue.length-Ke-1);if(ue=($t>0?new Array($t+1).join(nt):"")+ue,ue=ue+(Ur>0?new Array(Ur+1).join(nt):""),Ke=ue.indexOf(He),Me.regularGrouping>0)for(var Gu=Math.floor((Ke-1)/Me.regularGrouping),Yt=1;Yt<=Gu;Yt++)ue=[ue.slice(0,Ke-Yt*Me.regularGrouping),Ct,ue.slice(Ke-Yt*Me.regularGrouping)].join("");else Me.integerPartGroupingPositions.forEach(function(re){ue=[ue.slice(0,Ke-re),Ct,ue.slice(Ke-re)].join(""),Ke++});if(Ke=ue.indexOf(He),Me.fractionalPartGroupingPositions.forEach(function(re){ue=[ue.slice(0,re+Ke+1),Ct,ue.slice(re+Ke+1)].join("")}),Ke=ue.indexOf(He),(Me.picture.indexOf(He)===-1||Ke===ue.length-1)&&(ue=ue.substring(0,ue.length-1)),typeof St!="undefined"){var Kt=qr(St,0);$t=Me.minimumExponentSize-Kt.length,$t>0&&(Kt=new Array($t+1).join(nt)+Kt),ue=ue+c["exponent-separator"]+(St<0?Fe:"")+Kt}return ue=Me.prefix+ue+Me.suffix,ue}}function y(e,r){if(typeof e!="undefined"){if(e=M(e),typeof r=="undefined"?r=10:r=M(r),r<2||r>36)throw{code:"D3100",stack:new Error().stack,value:r};var o=e.toString(r);return o}}function T(e){var r;if(typeof e!="undefined"){if(typeof e=="number")r=e;else if(typeof e=="string"&&/^-?[0-9]+(\.[0-9]+)?([Ee][-+]?[0-9]+)?$/.test(e)&&!isNaN(parseFloat(e))&&isFinite(e))r=parseFloat(e);else if(typeof e=="string"&&/^(0[xX][0-9A-Fa-f]+)|(0[oO][0-7]+)|(0[bB][0-1]+)$/.test(e))r=Number(e);else if(e===!0)r=1;else if(e===!1)r=0;else throw{code:"D3030",value:e,stack:new Error().stack,index:1};return r}}function _(e){var r;if(typeof e!="undefined")return r=Math.abs(e),r}function D(e){var r;if(typeof e!="undefined")return r=Math.floor(e),r}function w(e){var r;if(typeof e!="undefined")return r=Math.ceil(e),r}function M(e,r){var o;if(typeof e!="undefined"){if(r){var p=e.toString().split("e");e=+(p[0]+"e"+(p[1]?+p[1]+r:r))}o=Math.round(e);var c=o-e;return Math.abs(c)===.5&&Math.abs(o%2)===1&&(o=o-1),r&&(p=o.toString().split("e"),o=+(p[0]+"e"+(p[1]?+p[1]-r:-r))),Object.is(o,-0)&&(o=0),o}}function Z(e){var r;if(typeof e!="undefined"){if(e<0)throw{stack:new Error().stack,code:"D3060",index:1,value:e};return r=Math.sqrt(e),r}}function he(e,r){var o;if(typeof e!="undefined"){if(o=Math.pow(e,r),!isFinite(o))throw{stack:new Error().stack,code:"D3061",index:1,value:e,exp:r};return o}}function me(){return Math.random()}function J(e){if(typeof e!="undefined"){var r=!1;if(Array.isArray(e)){if(e.length===1)r=J(e[0]);else if(e.length>1){var o=e.filter(function(p){return J(p)});r=o.length>0}}else typeof e=="string"?e.length>0&&(r=!0):V(e)?e!==0&&(r=!0):e!==null&&typeof e=="object"?Object.keys(e).length>0&&(r=!0):typeof e=="boolean"&&e===!0&&(r=!0);return r}}function ee(e){if(typeof e!="undefined")return!J(e)}function ke(e,r,o,p){var c=[r],g=be(e);return g>=2&&c.push(o),g>=3&&c.push(p),c}function B(e,r){return R(this,null,function*(){if(typeof e!="undefined"){for(var o=I(),p=0;p<e.length;p++){var c=ke(r,e[p],p,e),g=yield r.apply(this,c);typeof g!="undefined"&&o.push(g)}return o}})}function ze(e,r){return R(this,null,function*(){if(typeof e!="undefined"){for(var o=I(),p=0;p<e.length;p++){var c=e[p],g=ke(r,c,p,e),E=yield r.apply(this,g);J(E)&&o.push(c)}return o}})}function rt(e,r){return R(this,null,function*(){if(typeof e!="undefined"){for(var o=!1,p,c=0;c<e.length;c++){var g=e[c],E=!0;if(typeof r!="undefined"){var L=ke(r,g,c,e),X=yield r.apply(this,L);E=J(X)}if(E)if(!o)p=g,o=!0;else throw{stack:new Error().stack,code:"D3138",index:c}}if(!o)throw{stack:new Error().stack,code:"D3139"};return p}})}function Ge(){for(var e=[],r=Array.prototype.slice.call(arguments),o=Math.min.apply(Math,r.map(function(g){return Array.isArray(g)?g.length:0})),p=0;p<o;p++){var c=r.map(g=>g[p]);e.push(c)}return e}function je(e,r,o){return R(this,null,function*(){if(typeof e!="undefined"){var p,c=be(r);if(c<2)throw{stack:new Error().stack,code:"D3050",index:1};var g;for(typeof o=="undefined"&&e.length>0?(p=e[0],g=1):(p=o,g=0);g<e.length;){var E=[p,e[g]];c>=3&&E.push(g),c>=4&&E.push(e),p=yield r.apply(this,E),g++}return p}})}function Ye(e){var r=I();if(Array.isArray(e)){var o={};e.forEach(function(p){var c=Ye(p);c.forEach(function(g){o[g]=!0})}),r=Ye(o)}else e!==null&&typeof e=="object"&&!k(e)&&Object.keys(e).forEach(p=>r.push(p));return r}function ut(e,r){var o;if(Array.isArray(e)){o=I();for(var p=0;p<e.length;p++){var c=ut(e[p],r);typeof c!="undefined"&&(Array.isArray(c)?c.forEach(g=>o.push(g)):o.push(c))}}else e!==null&&typeof e=="object"&&!k(e)&&(o=e[r]);return o}function ft(e,r){return typeof e=="undefined"?r:typeof r=="undefined"?e:(Array.isArray(e)||(e=I(e)),Array.isArray(r)||(r=[r]),e.concat(r))}function Bt(e){return typeof e!="undefined"}function pt(e){var r=I();if(Array.isArray(e))e.forEach(function(c){r=ft(r,pt(c))});else if(e!==null&&typeof e=="object"&&!j(e))for(var o in e){var p={};p[o]=e[o],r.push(p)}else r=e;return r}function q(e){if(typeof e!="undefined"){var r={};return e.forEach(function(o){for(var p in o)r[p]=o[p]}),r}}function Gt(e){if(typeof e!="undefined"){if(e.length<=1)return e;for(var r=e.length,o=new Array(r),p=0;p<r;p++)o[r-p-1]=e[p];return o}}function Ot(e,r){return R(this,null,function*(){var o=I();for(var p in e){var c=ke(r,e[p],p,e),g=yield r.apply(this,c);typeof g!="undefined"&&o.push(g)}return o})}function ot(e){throw{code:"D3137",stack:new Error().stack,message:e||"$error() function evaluated"}}function kt(e,r){if(!e)throw{code:"D3141",stack:new Error().stack,message:r||"$assert() statement failed"}}function it(e){if(e!==void 0)return e===null?"null":V(e)?"number":typeof e=="string"?"string":typeof e=="boolean"?"boolean":Array.isArray(e)?"array":k(e)?"function":"object"}function Pe(e,r){return R(this,null,function*(){if(typeof e!="undefined"){if(e.length<=1)return e;var o;if(typeof r=="undefined"){if(!ae(e)&&!G(e))throw{stack:new Error().stack,code:"D3070",index:1};o=function(E,L){return R(this,null,function*(){return E>L})}}else o=r;var p=function(E,L){return R(this,null,function*(){var X=function(de,De,Ce){return R(this,null,function*(){De.length===0?Array.prototype.push.apply(de,Ce):Ce.length===0?Array.prototype.push.apply(de,De):(yield o(De[0],Ce[0]))?(de.push(Ce[0]),yield X(de,De,Ce.slice(1))):(de.push(De[0]),yield X(de,De.slice(1),Ce))})},Te=[];return yield X(Te,E,L),Te})},c=function(E){return R(this,null,function*(){if(!Array.isArray(E)||E.length<=1)return E;var L=Math.floor(E.length/2),X=E.slice(0,L),Te=E.slice(L);return X=yield c(X),Te=yield c(Te),yield p(X,Te)})},g=yield c(e);return g}})}function n(e){if(typeof e!="undefined"){if(e.length<=1)return e;for(var r=new Array(e.length),o=0;o<e.length;o++){var p=Math.floor(Math.random()*(o+1));o!==p&&(r[o]=r[p]),r[p]=e[o]}return r}}function s(e){if(typeof e!="undefined"){if(!Array.isArray(e)||e.length<=1)return e;for(var r=x(e)?I():[],o=0;o<e.length;o++){for(var p=e[o],c=!1,g=0;g<r.length;g++)if(xe(p,r[g])){c=!0;break}c||r.push(p)}return r}}function f(e,r){return R(this,null,function*(){var o={};for(var p in e){var c=e[p],g=ke(r,c,p,e),E=yield r.apply(this,g);J(E)&&(o[p]=c)}return Object.keys(o).length===0&&(o=void 0),o})}return{sum:S,count:W,max:F,min:m,average:$,string:U,substring:se,substringBefore:K,substringAfter:Q,lowercase:oe,uppercase:pe,length:Se,trim:Ne,pad:we,match:ne,contains:Xe,replace:_e,split:Ae,join:d,formatNumber:b,formatBase:y,number:T,floor:D,ceil:w,round:M,abs:_,sqrt:Z,power:he,random:me,boolean:J,not:ee,map:B,zip:Ge,filter:ze,single:rt,foldLeft:je,sift:f,keys:Ye,lookup:ut,append:ft,exists:Bt,spread:pt,merge:q,reverse:Gt,each:Ot,error:ot,assert:kt,type:it,sort:Pe,shuffle:n,distinct:s,base64encode:tt,base64decode:i,encodeUrlComponent:l,encodeUrl:z,decodeUrlComponent:le,decodeUrl:Ee}})();h.exports=P}).call(this)}).call(this,typeof bt!="undefined"?bt:typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./utils":6}],3:[function(u,h,C){var O=u("./datetime"),v=u("./functions"),P=u("./utils"),V=u("./parser"),G=u("./signature"),ae=function(){var I=P.isNumeric,x=P.isArrayOfStrings,k=P.isArrayOfNumbers,j=P.createSequence,fe=P.isSequence,be=P.isFunction,xe=P.isLambda,Y=P.isIterable,S=P.isPromise,W=P.getFunctionArity,F=P.isDeepEqual,m=ot(null);function $(n,s,f){return R(this,null,function*(){var e,r=f.lookup(Symbol.for("jsonata.__evaluate_entry"));switch(r&&(yield r(n,s,f)),n.type){case"path":e=yield U(n,s,f);break;case"binary":e=yield Se(n,s,f);break;case"unary":e=yield Ne(n,s,f);break;case"name":e=we(n,s);break;case"string":case"number":case"value":e=ce(n);break;case"wildcard":e=Xe(n,s);break;case"descendant":e=_e(n,s);break;case"parent":e=f.lookup(n.slot.label);break;case"condition":e=yield D(n,s,f);break;case"block":e=yield w(n,s,f);break;case"bind":e=yield _(n,s,f);break;case"regex":e=M(n);break;case"function":e=yield ke(n,s,f);break;case"variable":e=Z(n,s,f);break;case"lambda":e=rt(n,s,f);break;case"partial":e=yield Ge(n,s,f);break;case"apply":e=yield ee(n,s,f);break;case"transform":e=me(n,s,f);break}if(Object.prototype.hasOwnProperty.call(n,"predicate"))for(var o=0;o<n.predicate.length;o++)e=yield pe(n.predicate[o].expr,e,f);n.type!=="path"&&Object.prototype.hasOwnProperty.call(n,"group")&&(e=yield b(n.group,e,f));var p=f.lookup(Symbol.for("jsonata.__evaluate_exit"));return p&&(yield p(n,s,f,e)),e&&fe(e)&&!e.tupleStream&&(n.keepArray&&(e.keepSingleton=!0),e.length===0?e=void 0:e.length===1&&(e=e.keepSingleton?e:e[0])),e})}function U(n,s,f){return R(this,null,function*(){var e;Array.isArray(s)&&n.steps[0].type!=="variable"?e=s:e=j(s);for(var r,o=!1,p=void 0,c=0;c<n.steps.length;c++){var g=n.steps[c];if(g.tuple&&(o=!0),c===0&&g.consarray?r=yield $(g,e,f):o?p=yield oe(g,e,p,f):r=yield K(g,e,f,c===n.steps.length-1),!o&&(typeof r=="undefined"||r.length===0))break;typeof g.focus=="undefined"&&(e=r)}if(o)if(n.tuple)r=p;else for(r=j(),c=0;c<p.length;c++)r.push(p[c]["@"]);return n.keepSingletonArray&&(Array.isArray(r)&&r.cons&&!r.sequence&&(r=j(r)),r.keepSingleton=!0),n.hasOwnProperty("group")&&(r=yield b(n.group,o?p:r,f)),r})}function se(n,s){var f=ot(n);for(const e in s)f.bind(e,s[e]);return f}function K(n,s,f,e){return R(this,null,function*(){var r;if(n.type==="sort")return r=yield he(n,s,f),n.stages&&(r=yield Q(n.stages,r,f)),r;r=j();for(var o=0;o<s.length;o++){var p=yield $(n,s[o],f);if(n.stages)for(var c=0;c<n.stages.length;c++)p=yield pe(n.stages[c].expr,p,f);typeof p!="undefined"&&r.push(p)}var g=j();return e&&r.length===1&&Array.isArray(r[0])&&!fe(r[0])?g=r[0]:r.forEach(function(E){!Array.isArray(E)||E.cons?g.push(E):E.forEach(L=>g.push(L))}),g})}function Q(n,s,f){return R(this,null,function*(){for(var e=s,r=0;r<n.length;r++){var o=n[r];switch(o.type){case"filter":e=yield pe(o.expr,e,f);break;case"index":for(var p=0;p<e.length;p++){var c=e[p];c[o.value]=p}break}}return e})}function oe(n,s,f,e){return R(this,null,function*(){var r;if(n.type==="sort"){if(f)r=yield he(n,f,e);else{var o=yield he(n,s,e);r=j(),r.tupleStream=!0;for(var p=0;p<o.length;p++){var c={"@":o[p]};c[n.index]=p,r.push(c)}}return n.stages&&(r=yield Q(n.stages,r,e)),r}r=j(),r.tupleStream=!0;var g=e;f===void 0&&(f=s.map(Te=>({"@":Te})));for(var E=0;E<f.length;E++){g=se(e,f[E]);var L=yield $(n,f[E]["@"],g);if(typeof L!="undefined"){Array.isArray(L)||(L=[L]);for(var X=0;X<L.length;X++)c={},Object.assign(c,f[E]),L.tupleStream?Object.assign(c,L[X]):(n.focus?(c[n.focus]=L[X],c["@"]=f[E]["@"]):c["@"]=L[X],n.index&&(c[n.index]=X),n.ancestor&&(c[n.ancestor.label]=f[E]["@"])),r.push(c)}}return n.stages&&(r=yield Q(n.stages,r,e)),r})}function pe(n,s,f){return R(this,null,function*(){var e=j();if(s&&s.tupleStream&&(e.tupleStream=!0),Array.isArray(s)||(s=j(s)),n.type==="number"){var r=Math.floor(n.value);r<0&&(r=s.length+r);var o=s[r];typeof o!="undefined"&&(Array.isArray(o)?e=o:e.push(o))}else for(r=0;r<s.length;r++){var o=s[r],p=o,c=f;s.tupleStream&&(p=o["@"],c=se(f,o));var g=yield $(n,p,c);I(g)&&(g=[g]),k(g)?g.forEach(function(L){var X=Math.floor(L);X<0&&(X=s.length+X),X===r&&e.push(o)}):v.boolean(g)&&e.push(o)}return e})}function Se(n,s,f){return R(this,null,function*(){var e,r=yield $(n.lhs,s,f),o=n.value,p=()=>R(this,null,function*(){return yield $(n.rhs,s,f)});if(o==="and"||o==="or")try{return yield Ee(r,p,o)}catch(g){throw g.position=n.position,g.token=o,g}var c=yield p();try{switch(o){case"+":case"-":case"*":case"/":case"%":e=i(r,c,o);break;case"=":case"!=":e=l(r,c,o);break;case"<":case"<=":case">":case">=":e=z(r,c,o);break;case"&":e=d(r,c);break;case"..":e=T(r,c);break;case"in":e=le(r,c);break}}catch(g){throw g.position=n.position,g.token=o,g}return e})}function Ne(n,s,f){return R(this,null,function*(){var e;switch(n.value){case"-":if(e=yield $(n.expression,s,f),typeof e=="undefined")e=void 0;else if(I(e))e=-e;else throw{code:"D1002",stack:new Error().stack,position:n.position,token:n.value,value:e};break;case"[":e=[];let p=yield Promise.all(n.expressions.map((c,g)=>R(this,null,function*(){return f.isParallelCall=g>0,[c,yield $(c,s,f)]})));for(let c of p){var[r,o]=c;typeof o!="undefined"&&(r.value==="["?e.push(o):e=v.append(e,o))}n.consarray&&Object.defineProperty(e,"cons",{enumerable:!1,configurable:!1,value:!0});break;case"{":e=yield b(n,s,f);break}return e})}function we(n,s,f){return v.lookup(s,n.value)}function ce(n){return n.value}function Xe(n,s){var f=j();return Array.isArray(s)&&s.outerWrapper&&s.length>0&&(s=s[0]),s!==null&&typeof s=="object"&&Object.keys(s).forEach(function(e){var r=s[e];Array.isArray(r)?(r=ne(r),f=v.append(f,r)):f.push(r)}),f}function ne(n,s){return typeof s=="undefined"&&(s=[]),Array.isArray(n)?n.forEach(function(f){ne(f,s)}):s.push(n),s}function _e(n,s){var f,e=j();return typeof s!="undefined"&&(tt(s,e),e.length===1?f=e[0]:f=e),f}function tt(n,s){Array.isArray(n)||s.push(n),Array.isArray(n)?n.forEach(function(f){tt(f,s)}):n!==null&&typeof n=="object"&&Object.keys(n).forEach(function(f){tt(n[f],s)})}function i(n,s,f){var e;if(typeof n!="undefined"&&!I(n))throw{code:"T2001",stack:new Error().stack,value:n};if(typeof s!="undefined"&&!I(s))throw{code:"T2002",stack:new Error().stack,value:s};if(typeof n=="undefined"||typeof s=="undefined")return e;switch(f){case"+":e=n+s;break;case"-":e=n-s;break;case"*":e=n*s;break;case"/":e=n/s;break;case"%":e=n%s;break}return e}function l(n,s,f){var e,r=typeof n,o=typeof s;if(r==="undefined"||o==="undefined")return!1;switch(f){case"=":e=F(n,s);break;case"!=":e=!F(n,s);break}return e}function z(n,s,f){var e,r=typeof n,o=typeof s,p=r==="undefined"||r==="string"||r==="number",c=o==="undefined"||o==="string"||o==="number";if(!p||!c)throw{code:"T2010",stack:new Error().stack,value:r==="string"||r==="number"?s:n};if(!(r==="undefined"||o==="undefined")){if(r!==o)throw{code:"T2009",stack:new Error().stack,value:n,value2:s};switch(f){case"<":e=n<s;break;case"<=":e=n<=s;break;case">":e=n>s;break;case">=":e=n>=s;break}return e}}function le(n,s){var f=!1;if(typeof n=="undefined"||typeof s=="undefined")return!1;Array.isArray(s)||(s=[s]);for(var e=0;e<s.length;e++)if(s[e]===n){f=!0;break}return f}function Ee(n,s,f){return R(this,null,function*(){var e,r=Ae(n);switch(f){case"and":e=r&&Ae(yield s());break;case"or":e=r||Ae(yield s());break}return e})}function Ae(n){var s=v.boolean(n);return typeof s=="undefined"?!1:s}function d(n,s){var f,e="",r="";return typeof n!="undefined"&&(e=v.string(n)),typeof s!="undefined"&&(r=v.string(s)),f=e.concat(r),f}function b(n,s,f){return R(this,null,function*(){var e={},r={},o=!!(s&&s.tupleStream);Array.isArray(s)||(s=j(s)),s.length===0&&s.push(void 0);for(var p=0;p<s.length;p++)for(var c=s[p],g=o?se(f,c):f,E=0;E<n.lhs.length;E++){var L=n.lhs[E],X=yield $(L[0],o?c["@"]:c,g);if(typeof X!="string"&&X!==void 0)throw{code:"T1003",stack:new Error().stack,position:n.position,value:X};if(X!==void 0){var Te={data:c,exprIndex:E};if(r.hasOwnProperty(X)){if(r[X].exprIndex!==E)throw{code:"D1009",stack:new Error().stack,position:n.position,value:X};r[X].data=v.append(r[X].data,c)}else r[X]=Te}}let de=yield Promise.all(Object.keys(r).map((Ce,Le)=>R(this,null,function*(){let ve=r[Ce];var Fe=ve.data,nt=f;if(o){var He=y(ve.data);Fe=He["@"],delete He["@"],nt=se(f,He)}return f.isParallelCall=Le>0,[Ce,yield $(n.lhs[ve.exprIndex][1],Fe,nt)]})));for(let Ce of de){var[X,De]=yield Ce;typeof De!="undefined"&&(e[X]=De)}return e})}function y(n){if(!Array.isArray(n))return n;var s={};Object.assign(s,n[0]);for(var f=1;f<n.length;f++)for(const e in n[f])s[e]=v.append(s[e],n[f][e]);return s}function T(n,s){var f;if(typeof n!="undefined"&&!Number.isInteger(n))throw{code:"T2003",stack:new Error().stack,value:n};if(typeof s!="undefined"&&!Number.isInteger(s))throw{code:"T2004",stack:new Error().stack,value:s};if(typeof n=="undefined"||typeof s=="undefined"||n>s)return f;var e=s-n+1;if(e>1e7)throw{code:"D2014",stack:new Error().stack,value:e};f=new Array(e);for(var r=n,o=0;r<=s;r++,o++)f[o]=r;return f.sequence=!0,f}function _(n,s,f){return R(this,null,function*(){var e=yield $(n.rhs,s,f);return f.bind(n.lhs.value,e),e})}function D(n,s,f){return R(this,null,function*(){var e,r=yield $(n.condition,s,f);return v.boolean(r)?e=yield $(n.then,s,f):typeof n.else!="undefined"&&(e=yield $(n.else,s,f)),e})}function w(n,s,f){return R(this,null,function*(){for(var e,r=ot(f),o=0;o<n.expressions.length;o++)e=yield $(n.expressions[o],s,r);return e})}function M(n){var s=new Pe.RegexEngine(n.value),f=function(e,r){var o;s.lastIndex=r||0;var p=s.exec(e);if(p!==null){if(o={match:p[0],start:p.index,end:p.index+p[0].length,groups:[]},p.length>1)for(var c=1;c<p.length;c++)o.groups.push(p[c]);o.next=function(){if(!(s.lastIndex>=e.length)){var g=f(e,s.lastIndex);if(g&&g.match==="")throw{code:"D1004",stack:new Error().stack,position:n.position,value:n.value.source};return g}}}return o};return f}function Z(n,s,f){var e;return n.value===""?e=s&&s.outerWrapper?s[0]:s:e=f.lookup(n.value),e}function he(n,s,f){return R(this,null,function*(){var e,r=s,o=!!s.tupleStream,p=function(g,E){return R(this,null,function*(){for(var L=0,X=0;L===0&&X<n.terms.length;X++){var Te=n.terms[X],de=g,De=f;o&&(de=g["@"],De=se(f,g));var Ce=yield $(Te.expression,de,De);de=E,De=f,o&&(de=E["@"],De=se(f,E));var Le=yield $(Te.expression,de,De),ve=typeof Ce,Fe=typeof Le;if(ve==="undefined"){L=Fe==="undefined"?0:1;continue}if(Fe==="undefined"){L=-1;continue}if(!(ve==="string"||ve==="number")||!(Fe==="string"||Fe==="number"))throw{code:"T2008",stack:new Error().stack,position:n.position,value:ve==="string"||ve==="number"?Le:Ce};if(ve!==Fe)throw{code:"T2007",stack:new Error().stack,position:n.position,value:Ce,value2:Le};Ce!==Le&&(Ce<Le?L=-1:L=1,Te.descending===!0&&(L=-L))}return L===1})},c={environment:f,input:s};return e=yield v.sort.apply(c,[r,p]),e})}function me(n,s,f){var e=function(r){return R(this,null,function*(){if(typeof r!="undefined"){var o=f.lookup("clone");if(!be(o))throw{code:"T2013",stack:new Error().stack,position:n.position};var p=yield B(o,[r],null,f),c=yield $(n.pattern,p,f);if(typeof c!="undefined"){Array.isArray(c)||(c=[c]);for(var g=0;g<c.length;g++){var E=c[g];if(E&&(E.isPrototypeOf(p)||E instanceof Object.constructor))throw{code:"D1010",stack:new Error().stack,position:n.position};var L=yield $(n.update,E,f),X=typeof L;if(X!=="undefined"){if(X!=="object"||L===null||Array.isArray(L))throw{code:"T2011",stack:new Error().stack,position:n.update.position,value:L};for(var Te in L)E[Te]=L[Te]}if(typeof n.delete!="undefined"){var de=yield $(n.delete,E,f);if(typeof de!="undefined"){var De=de;if(Array.isArray(de)||(de=[de]),!x(de))throw{code:"T2012",stack:new Error().stack,position:n.delete.position,value:De};for(var Ce=0;Ce<de.length;Ce++)typeof E=="object"&&E!==null&&delete E[de[Ce]]}}}}return p}})};return q(e,"<(oa):o>")}var J=V("function($f, $g) { function($x){ $g($f($x)) } }");function ee(n,s,f){return R(this,null,function*(){var e,r=yield $(n.lhs,s,f);if(n.rhs.type==="function")e=yield ke(n.rhs,s,f,{context:r});else{var o=yield $(n.rhs,s,f);if(!be(o))throw{code:"T2006",stack:new Error().stack,position:n.position,value:o};if(be(r)){var p=yield $(J,null,f);e=yield B(p,[r,o],null,f)}else e=yield B(o,[r],null,f)}return e})}function ke(n,s,f,e){return R(this,null,function*(){var r,o=yield $(n.procedure,s,f);if(typeof o=="undefined"&&n.procedure.type==="path"&&f.lookup(n.procedure.steps[0].value))throw{code:"T1005",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};var p=[];typeof e!="undefined"&&p.push(e.context);for(var c=0;c<n.arguments.length;c++){const E=yield $(n.arguments[c],s,f);if(be(E)){const L=function(...X){return R(this,null,function*(){return yield B(E,X,null,f)})};L.arity=W(E),p.push(L)}else p.push(E)}var g=n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value;try{typeof o=="object"&&(o.token=g,o.position=n.position),r=yield B(o,p,s,f)}catch(E){throw E.position||(E.position=n.position),E.token||(E.token=g),E}return r})}function B(n,s,f,e){return R(this,null,function*(){var r;for(r=yield ze(n,s,f,e);xe(r)&&r.thunk===!0;){var o=yield $(r.body.procedure,r.input,r.environment);r.body.procedure.type==="variable"&&(o.token=r.body.procedure.value),o.position=r.body.procedure.position;for(var p=[],c=0;c<r.body.arguments.length;c++)p.push(yield $(r.body.arguments[c],r.input,r.environment));r=yield ze(o,p,f,e)}return r})}function ze(n,s,f,e){return R(this,null,function*(){var r;try{var o=s;if(n&&(o=je(n.signature,s,f)),xe(n))r=yield Ye(n,o);else if(n&&n._jsonata_function===!0){var p={environment:e,input:f};r=n.implementation.apply(p,o),Y(r)&&(r=r.next().value),S(r)&&(r=yield r)}else if(typeof n=="function")r=n.apply(f,o),S(r)&&(r=yield r);else throw{code:"T1006",stack:new Error().stack}}catch(c){throw n&&(typeof c.token=="undefined"&&typeof n.token!="undefined"&&(c.token=n.token),c.position=n.position||c.position),c}return r})}function rt(n,s,f){var e={_jsonata_lambda:!0,input:s,environment:f,arguments:n.arguments,signature:n.signature,body:n.body};return n.thunk===!0&&(e.thunk=!0),e.apply=function(r,o){return R(this,null,function*(){return yield B(e,o,s,r?r.environment:f)})},e}function Ge(n,s,f){return R(this,null,function*(){for(var e,r=[],o=0;o<n.arguments.length;o++){var p=n.arguments[o];p.type==="operator"&&p.value==="?"?r.push(p):r.push(yield $(p,s,f))}var c=yield $(n.procedure,s,f);if(typeof c=="undefined"&&n.procedure.type==="path"&&f.lookup(n.procedure.steps[0].value))throw{code:"T1007",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};if(xe(c))e=ut(c,r);else if(c&&c._jsonata_function===!0)e=ft(c.implementation,r);else if(typeof c=="function")e=ft(c,r);else throw{code:"T1008",stack:new Error().stack,position:n.position,token:n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value};return e})}function je(n,s,f){if(typeof n=="undefined")return s;var e=n.validate(s,f);return e}function Ye(n,s){return R(this,null,function*(){var f,e=ot(n.environment);return n.arguments.forEach(function(r,o){e.bind(r.value,s[o])}),typeof n.body=="function"?f=yield Bt(n.body,e):f=yield $(n.body,n.input,e),f})}function ut(n,s){var f=ot(n.environment),e=[];n.arguments.forEach(function(o,p){var c=s[p];c&&c.type==="operator"&&c.value==="?"?e.push(o):f.bind(o.value,c)});var r={_jsonata_lambda:!0,input:n.input,environment:f,arguments:e,body:n.body};return r}function ft(n,s){var f=pt(n);f=f.map(function(p){return"$"+p.trim()});var e="function("+f.join(", ")+"){ _ }",r=V(e);r.body=n;var o=ut(r,s);return o}function Bt(n,s){return R(this,null,function*(){var f=pt(n),e=f.map(function(p){return s.lookup(p.trim())}),r={environment:s},o=n.apply(r,e);return S(o)&&(o=yield o),o})}function pt(n){var s=n.toString(),f=/\(([^)]*)\)/.exec(s)[1],e=f.split(",");return e}function q(n,s){var f={_jsonata_function:!0,implementation:n};return typeof s!="undefined"&&(f.signature=G(s)),f}function Gt(n,s){return R(this,null,function*(){if(typeof n!="undefined"){var f=this.input;typeof s!="undefined"&&(f=s,Array.isArray(f)&&!fe(f)&&(f=j(f),f.outerWrapper=!0));try{var e=V(n,!1)}catch(o){throw it(o),{stack:new Error().stack,code:"D3120",value:o.message,error:o}}try{var r=yield $(e,f,this.environment)}catch(o){throw it(o),{stack:new Error().stack,code:"D3121",value:o.message,error:o}}return r}})}function Ot(n){if(typeof n!="undefined")return JSON.parse(v.string(n))}function ot(n){var s={};const f={bind:function(r,o){s[r]=o},lookup:function(r){var o;return s.hasOwnProperty(r)?o=s[r]:n&&(o=n.lookup(r)),o},timestamp:n?n.timestamp:null,async:n?n.async:!1,isParallelCall:n?n.isParallelCall:!1,global:n?n.global:{ancestry:[null]}};if(n){var e=n.lookup(Symbol.for("jsonata.__createFrame_push"));e&&e(n,f)}return f}m.bind("sum",q(v.sum,"<a<n>:n>")),m.bind("count",q(v.count,"<a:n>")),m.bind("max",q(v.max,"<a<n>:n>")),m.bind("min",q(v.min,"<a<n>:n>")),m.bind("average",q(v.average,"<a<n>:n>")),m.bind("string",q(v.string,"<x-b?:s>")),m.bind("substring",q(v.substring,"<s-nn?:s>")),m.bind("substringBefore",q(v.substringBefore,"<s-s:s>")),m.bind("substringAfter",q(v.substringAfter,"<s-s:s>")),m.bind("lowercase",q(v.lowercase,"<s-:s>")),m.bind("uppercase",q(v.uppercase,"<s-:s>")),m.bind("length",q(v.length,"<s-:n>")),m.bind("trim",q(v.trim,"<s-:s>")),m.bind("pad",q(v.pad,"<s-ns?:s>")),m.bind("match",q(v.match,"<s-f<s:o>n?:a<o>>")),m.bind("contains",q(v.contains,"<s-(sf):b>")),m.bind("replace",q(v.replace,"<s-(sf)(sf)n?:s>")),m.bind("split",q(v.split,"<s-(sf)n?:a<s>>")),m.bind("join",q(v.join,"<a<s>s?:s>")),m.bind("formatNumber",q(v.formatNumber,"<n-so?:s>")),m.bind("formatBase",q(v.formatBase,"<n-n?:s>")),m.bind("formatInteger",q(O.formatInteger,"<n-s:s>")),m.bind("parseInteger",q(O.parseInteger,"<s-s:n>")),m.bind("number",q(v.number,"<(nsb)-:n>")),m.bind("floor",q(v.floor,"<n-:n>")),m.bind("ceil",q(v.ceil,"<n-:n>")),m.bind("round",q(v.round,"<n-n?:n>")),m.bind("abs",q(v.abs,"<n-:n>")),m.bind("sqrt",q(v.sqrt,"<n-:n>")),m.bind("power",q(v.power,"<n-n:n>")),m.bind("random",q(v.random,"<:n>")),m.bind("boolean",q(v.boolean,"<x-:b>")),m.bind("not",q(v.not,"<x-:b>")),m.bind("map",q(v.map,"<af>")),m.bind("zip",q(v.zip,"<a+>")),m.bind("filter",q(v.filter,"<af>")),m.bind("single",q(v.single,"<af?>")),m.bind("reduce",q(v.foldLeft,"<afj?:j>")),m.bind("sift",q(v.sift,"<o-f?:o>")),m.bind("keys",q(v.keys,"<x-:a<s>>")),m.bind("lookup",q(v.lookup,"<x-s:x>")),m.bind("append",q(v.append,"<xx:a>")),m.bind("exists",q(v.exists,"<x:b>")),m.bind("spread",q(v.spread,"<x-:a<o>>")),m.bind("merge",q(v.merge,"<a<o>:o>")),m.bind("reverse",q(v.reverse,"<a:a>")),m.bind("each",q(v.each,"<o-f:a>")),m.bind("error",q(v.error,"<s?:x>")),m.bind("assert",q(v.assert,"<bs?:x>")),m.bind("type",q(v.type,"<x:s>")),m.bind("sort",q(v.sort,"<af?:a>")),m.bind("shuffle",q(v.shuffle,"<a:a>")),m.bind("distinct",q(v.distinct,"<x:x>")),m.bind("base64encode",q(v.base64encode,"<s-:s>")),m.bind("base64decode",q(v.base64decode,"<s-:s>")),m.bind("encodeUrlComponent",q(v.encodeUrlComponent,"<s-:s>")),m.bind("encodeUrl",q(v.encodeUrl,"<s-:s>")),m.bind("decodeUrlComponent",q(v.decodeUrlComponent,"<s-:s>")),m.bind("decodeUrl",q(v.decodeUrl,"<s-:s>")),m.bind("eval",q(Gt,"<sx?:x>")),m.bind("toMillis",q(O.toMillis,"<s-s?:n>")),m.bind("fromMillis",q(O.fromMillis,"<n-s?s?:s>")),m.bind("clone",q(Ot,"<(oa)-:o>"));var kt={S0101:"String literal must be terminated by a matching quote",S0102:"Number out of range: {{token}}",S0103:"Unsupported escape sequence: \\{{token}}",S0104:"The escape sequence \\u must be followed by 4 hex digits",S0105:"Quoted property name must be terminated with a backquote (`)",S0106:"Comment has no closing tag",S0201:"Syntax error: {{token}}",S0202:"Expected {{value}}, got {{token}}",S0203:"Expected {{value}} before end of expression",S0204:"Unknown operator: {{token}}",S0205:"Unexpected token: {{token}}",S0206:"Unknown expression type: {{token}}",S0207:"Unexpected end of expression",S0208:"Parameter {{value}} of function definition must be a variable name (start with $)",S0209:"A predicate cannot follow a grouping expression in a step",S0210:"Each step can only have one grouping expression",S0211:"The symbol {{token}} cannot be used as a unary operator",S0212:"The left side of := must be a variable name (start with $)",S0213:"The literal value {{value}} cannot be used as a step within a path expression",S0214:"The right side of {{token}} must be a variable name (start with $)",S0215:"A context variable binding must precede any predicates on a step",S0216:"A context variable binding must precede the 'order-by' clause on a step",S0217:"The object representing the 'parent' cannot be derived from this expression",S0301:"Empty regular expressions are not allowed",S0302:"No terminating / in regular expression",S0402:"Choice groups containing parameterized types are not supported",S0401:"Type parameters can only be applied to functions and arrays",S0500:"Attempted to evaluate an expression containing syntax error(s)",T0410:"Argument {{index}} of function {{token}} does not match function signature",T0411:"Context value is not a compatible type with argument {{index}} of function {{token}}",T0412:"Argument {{index}} of function {{token}} must be an array of {{type}}",D1001:"Number out of range: {{value}}",D1002:"Cannot negate a non-numeric value: {{value}}",T1003:"Key in object structure must evaluate to a string; got: {{value}}",D1004:"Regular expression matches zero length string",T1005:"Attempted to invoke a non-function. Did you mean ${{{token}}}?",T1006:"Attempted to invoke a non-function",T1007:"Attempted to partially apply a non-function. Did you mean ${{{token}}}?",T1008:"Attempted to partially apply a non-function",D1009:"Multiple key definitions evaluate to same key: {{value}}",D1010:"Attempted to access the Javascript object prototype",T1010:"The matcher function argument passed to function {{token}} does not return the correct object structure",T2001:"The left side of the {{token}} operator must evaluate to a number",T2002:"The right side of the {{token}} operator must evaluate to a number",T2003:"The left side of the range operator (..) must evaluate to an integer",T2004:"The right side of the range operator (..) must evaluate to an integer",D2005:"The left side of := must be a variable name (start with $)",T2006:"The right side of the function application operator ~> must be a function",T2007:"Type mismatch when comparing values {{value}} and {{value2}} in order-by clause",T2008:"The expressions within an order-by clause must evaluate to numeric or string values",T2009:"The values {{value}} and {{value2}} either side of operator {{token}} must be of the same data type",T2010:"The expressions either side of operator {{token}} must evaluate to numeric or string values",T2011:"The insert/update clause of the transform expression must evaluate to an object: {{value}}",T2012:"The delete clause of the transform expression must evaluate to a string or array of strings: {{value}}",T2013:"The transform expression clones the input object using the $clone() function.  This has been overridden in the current scope by a non-function.",D2014:"The size of the sequence allocated by the range operator (..) must not exceed 1e6.  Attempted to allocate {{value}}.",D3001:"Attempting to invoke string function on Infinity or NaN",D3010:"Second argument of replace function cannot be an empty string",D3011:"Fourth argument of replace function must evaluate to a positive number",D3012:"Attempted to replace a matched string with a non-string value",D3020:"Third argument of split function must evaluate to a positive number",D3030:"Unable to cast value to a number: {{value}}",D3040:"Third argument of match function must evaluate to a positive number",D3050:"The second argument of reduce function must be a function with at least two arguments",D3060:"The sqrt function cannot be applied to a negative number: {{value}}",D3061:"The power function has resulted in a value that cannot be represented as a JSON number: base={{value}}, exponent={{exp}}",D3070:"The single argument form of the sort function can only be applied to an array of strings or an array of numbers.  Use the second argument to specify a comparison function",D3080:"The picture string must only contain a maximum of two sub-pictures",D3081:"The sub-picture must not contain more than one instance of the 'decimal-separator' character",D3082:"The sub-picture must not contain more than one instance of the 'percent' character",D3083:"The sub-picture must not contain more than one instance of the 'per-mille' character",D3084:"The sub-picture must not contain both a 'percent' and a 'per-mille' character",D3085:"The mantissa part of a sub-picture must contain at least one character that is either an 'optional digit character' or a member of the 'decimal digit family'",D3086:"The sub-picture must not contain a passive character that is preceded by an active character and that is followed by another active character",D3087:"The sub-picture must not contain a 'grouping-separator' character that appears adjacent to a 'decimal-separator' character",D3088:"The sub-picture must not contain a 'grouping-separator' at the end of the integer part",D3089:"The sub-picture must not contain two adjacent instances of the 'grouping-separator' character",D3090:"The integer part of the sub-picture must not contain a member of the 'decimal digit family' that is followed by an instance of the 'optional digit character'",D3091:"The fractional part of the sub-picture must not contain an instance of the 'optional digit character' that is followed by a member of the 'decimal digit family'",D3092:"A sub-picture that contains a 'percent' or 'per-mille' character must not contain a character treated as an 'exponent-separator'",D3093:"The exponent part of the sub-picture must comprise only of one or more characters that are members of the 'decimal digit family'",D3100:"The radix of the formatBase function must be between 2 and 36.  It was given {{value}}",D3110:"The argument of the toMillis function must be an ISO 8601 formatted timestamp. Given {{value}}",D3120:"Syntax error in expression passed to function eval: {{value}}",D3121:"Dynamic error evaluating the expression passed to function eval: {{value}}",D3130:"Formatting or parsing an integer as a sequence starting with {{value}} is not supported by this implementation",D3131:"In a decimal digit pattern, all digits must be from the same decimal group",D3132:"Unknown component specifier {{value}} in date/time picture string",D3133:"The 'name' modifier can only be applied to months and days in the date/time picture string, not {{value}}",D3134:"The timezone integer format specifier cannot have more than four digits",D3135:"No matching closing bracket ']' in date/time picture string",D3136:"The date/time picture string is missing specifiers required to parse the timestamp",D3137:"{{{message}}}",D3138:"The $single() function expected exactly 1 matching result.  Instead it matched more.",D3139:"The $single() function expected exactly 1 matching result.  Instead it matched 0.",D3140:"Malformed URL passed to ${{{functionName}}}(): {{value}}",D3141:"{{{message}}}"};function it(n){var s=kt[n.code];if(typeof s!="undefined"){var f=s.replace(/\{\{\{([^}]+)}}}/g,function(){return n[arguments[1]]});f=f.replace(/\{\{([^}]+)}}/g,function(){return JSON.stringify(n[arguments[1]])}),n.message=f}}function Pe(n,s){var f,e;try{f=V(n,s&&s.recover),e=f.errors,delete f.errors}catch(p){throw it(p),p}var r=ot(m),o=new Date;return r.bind("now",q(function(p,c){return O.fromMillis(o.getTime(),p,c)},"<s?s?:s>")),r.bind("millis",q(function(){return o.getTime()},"<:n>")),s&&s.RegexEngine?Pe.RegexEngine=s.RegexEngine:Pe.RegexEngine=RegExp,{evaluate:function(p,c,g){return R(this,null,function*(){if(typeof e!="undefined"){var E={code:"S0500",position:0};throw it(E),E}if(typeof c!="undefined"){var L;L=ot(r);for(var X in c)L.bind(X,c[X])}else L=r;L.bind("$",p),o=new Date,L.timestamp=o,Array.isArray(p)&&!fe(p)&&(p=j(p),p.outerWrapper=!0);var Te;try{return Te=yield $(f,p,L),typeof g=="function"&&g(null,Te),Te}catch(de){throw it(de),de}})},assign:function(p,c){r.bind(p,c)},registerFunction:function(p,c,g){var E=q(c,g);r.bind(p,E)},ast:function(){return f},errors:function(){return e}}}return Pe.parser=V,Pe}();h.exports=ae},{"./datetime":1,"./functions":2,"./parser":4,"./signature":5,"./utils":6}],4:[function(u,h,C){var O=u("./signature");const v=(()=>{var P={".":75,"[":80,"]":0,"{":70,"}":0,"(":80,")":0,",":0,"@":80,"#":80,";":80,":":80,"?":20,"+":50,"-":50,"*":60,"/":60,"%":60,"|":20,"=":40,"<":40,">":40,"^":40,"**":60,"..":20,":=":10,"!=":40,"<=":40,">=":40,"~>":40,and:30,or:25,in:40,"&":50,"!":0,"~":0},V={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},G=function(I){var x=0,k=I.length,j=function(xe,Y){var S={type:xe,value:Y,position:x};return S},fe=function(){for(var xe=x,Y=0,S,W,F=function($){if(I.charAt($)==="/"&&Y===0){for(var U=0;I.charAt($-(U+1))==="\\";)U++;if(U%2===0)return!0}return!1};x<k;){var m=I.charAt(x);if(F(x)){if(S=I.substring(xe,x),S==="")throw{code:"S0301",stack:new Error().stack,position:x};for(x++,m=I.charAt(x),xe=x;m==="i"||m==="m";)x++,m=I.charAt(x);return W=I.substring(xe,x)+"g",new RegExp(S,W)}(m==="("||m==="["||m==="{")&&I.charAt(x-1)!=="\\"&&Y++,(m===")"||m==="]"||m==="}")&&I.charAt(x-1)!=="\\"&&Y--,x++}throw{code:"S0302",stack:new Error().stack,position:x}},be=function(xe){if(x>=k)return null;for(var Y=I.charAt(x);x<k&&` 	
\r\v`.indexOf(Y)>-1;)x++,Y=I.charAt(x);if(Y==="/"&&I.charAt(x+1)==="*"){var S=x;for(x+=2,Y=I.charAt(x);!(Y==="*"&&I.charAt(x+1)==="/");)if(Y=I.charAt(++x),x>=k)throw{code:"S0106",stack:new Error().stack,position:S};return x+=2,Y=I.charAt(x),be(xe)}if(xe!==!0&&Y==="/")return x++,j("regex",fe());if(Y==="."&&I.charAt(x+1)===".")return x+=2,j("operator","..");if(Y===":"&&I.charAt(x+1)==="=")return x+=2,j("operator",":=");if(Y==="!"&&I.charAt(x+1)==="=")return x+=2,j("operator","!=");if(Y===">"&&I.charAt(x+1)==="=")return x+=2,j("operator",">=");if(Y==="<"&&I.charAt(x+1)==="=")return x+=2,j("operator","<=");if(Y==="*"&&I.charAt(x+1)==="*")return x+=2,j("operator","**");if(Y==="~"&&I.charAt(x+1)===">")return x+=2,j("operator","~>");if(Object.prototype.hasOwnProperty.call(P,Y))return x++,j("operator",Y);if(Y==='"'||Y==="'"){var W=Y;x++;for(var F="";x<k;){if(Y=I.charAt(x),Y==="\\")if(x++,Y=I.charAt(x),Object.prototype.hasOwnProperty.call(V,Y))F+=V[Y];else if(Y==="u"){var m=I.substr(x+1,4);if(/^[0-9a-fA-F]+$/.test(m)){var $=parseInt(m,16);F+=String.fromCharCode($),x+=4}else throw{code:"S0104",stack:new Error().stack,position:x}}else throw{code:"S0103",stack:new Error().stack,position:x,token:Y};else{if(Y===W)return x++,j("string",F);F+=Y}x++}throw{code:"S0101",stack:new Error().stack,position:x}}var U=/^-?(0|([1-9][0-9]*))(\.[0-9]+)?([Ee][-+]?[0-9]+)?/,se=U.exec(I.substring(x));if(se!==null){var K=parseFloat(se[0]);if(!isNaN(K)&&isFinite(K))return x+=se[0].length,j("number",K);throw{code:"S0102",stack:new Error().stack,position:x,token:se[0]}}var Q;if(Y==="`"){x++;var oe=I.indexOf("`",x);if(oe!==-1)return Q=I.substring(x,oe),x=oe+1,j("name",Q);throw x=k,{code:"S0105",stack:new Error().stack,position:x}}for(var pe=x,Se;;)if(Se=I.charAt(pe),pe===k||` 	
\r\v`.indexOf(Se)>-1||Object.prototype.hasOwnProperty.call(P,Se)){if(I.charAt(x)==="$")return Q=I.substring(x+1,pe),x=pe,j("variable",Q);switch(Q=I.substring(x,pe),x=pe,Q){case"or":case"in":case"and":return j("operator",Q);case"true":return j("value",!0);case"false":return j("value",!1);case"null":return j("value",null);default:return x===k&&Q===""?null:j("name",Q)}}else pe++};return be},ae=function(I,x){var k,j,fe={},be=[],xe=function(){var i=[];k.id!=="(end)"&&i.push({type:k.type,value:k.value,position:k.position});for(var l=j();l!==null;)i.push(l),l=j();return i},Y={nud:function(){var i={code:"S0211",token:this.value,position:this.position};if(x)return i.remaining=xe(),i.type="error",be.push(i),i;throw i.stack=new Error().stack,i}},S=function(i,l){var z=fe[i];return l=l||0,z?l>=z.lbp&&(z.lbp=l):(z=Object.create(Y),z.id=z.value=i,z.lbp=l,fe[i]=z),z},W=function(i){if(x){i.remaining=xe(),be.push(i);var l=fe["(error)"];return k=Object.create(l),k.error=i,k.type="(error)",k}else throw i.stack=new Error().stack,i},F=function(i,l){if(i&&k.id!==i){var z;k.id==="(end)"?z="S0203":z="S0202";var le={code:z,position:k.position,token:k.value,value:i};return W(le)}var Ee=j(l);if(Ee===null)return k=fe["(end)"],k.position=I.length,k;var Ae=Ee.value,d=Ee.type,b;switch(d){case"name":case"variable":b=fe["(name)"];break;case"operator":if(b=fe[Ae],!b)return W({code:"S0204",stack:new Error().stack,position:Ee.position,token:Ae});break;case"string":case"number":case"value":b=fe["(literal)"];break;case"regex":d="regex",b=fe["(regex)"];break;default:return W({code:"S0205",stack:new Error().stack,position:Ee.position,token:Ae})}return k=Object.create(b),k.value=Ae,k.type=d,k.position=Ee.position,k},m=function(i){var l,z=k;for(F(null,!0),l=z.nud();i<k.lbp;)z=k,F(),l=z.led(l);return l},$=function(i){var l=S(i,0);l.nud=function(){return this}},U=function(i,l,z){var le=l||P[i],Ee=S(i,le);return Ee.led=z||function(Ae){return this.lhs=Ae,this.rhs=m(le),this.type="binary",this},Ee},se=function(i,l,z){var le=S(i,l);return le.led=z,le},K=function(i,l){var z=S(i);return z.nud=l||function(){return this.expression=m(70),this.type="unary",this},z};$("(end)"),$("(name)"),$("(literal)"),$("(regex)"),S(":"),S(";"),S(","),S(")"),S("]"),S("}"),S(".."),U("."),U("+"),U("-"),U("*"),U("/"),U("%"),U("="),U("<"),U(">"),U("!="),U("<="),U(">="),U("&"),U("and"),U("or"),U("in"),$("and"),$("or"),$("in"),K("-"),U("~>"),se("(error)",10,function(i){return this.lhs=i,this.error=k.error,this.remaining=xe(),this.type="error",this}),K("*",function(){return this.type="wildcard",this}),K("**",function(){return this.type="descendant",this}),K("%",function(){return this.type="parent",this}),U("(",P["("],function(i){if(this.procedure=i,this.type="function",this.arguments=[],k.id!==")")for(;k.type==="operator"&&k.id==="?"?(this.type="partial",this.arguments.push(k),F("?")):this.arguments.push(m(0)),k.id===",";)F(",");if(F(")",!0),i.type==="name"&&(i.value==="function"||i.value==="λ")){if(this.arguments.forEach(function(Ae,d){if(Ae.type!=="variable")return W({code:"S0208",stack:new Error().stack,position:Ae.position,token:Ae.value,value:d+1})}),this.type="lambda",k.id==="<"){for(var l=k.position,z=1,le="<";z>0&&k.id!=="{"&&k.id!=="(end)";){var Ee=F();Ee.id===">"?z--:Ee.id==="<"&&z++,le+=Ee.value}F(">");try{this.signature=O(le)}catch(Ae){return Ae.position=l+Ae.offset,W(Ae)}}F("{"),this.body=m(0),F("}")}return this}),K("(",function(){for(var i=[];k.id!==")"&&(i.push(m(0)),k.id===";");)F(";");return F(")",!0),this.type="block",this.expressions=i,this}),K("[",function(){var i=[];if(k.id!=="]")for(;;){var l=m(0);if(k.id===".."){var z={type:"binary",value:"..",position:k.position,lhs:l};F(".."),z.rhs=m(0),l=z}if(i.push(l),k.id!==",")break;F(",")}return F("]",!0),this.expressions=i,this.type="unary",this}),U("[",P["["],function(i){if(k.id==="]"){for(var l=i;l&&l.type==="binary"&&l.value==="[";)l=l.lhs;return l.keepArray=!0,F("]"),i}else return this.lhs=i,this.rhs=m(P["]"]),this.type="binary",F("]",!0),this}),U("^",P["^"],function(i){F("(");for(var l=[];;){var z={descending:!1};if(k.id==="<"?F("<"):k.id===">"&&(z.descending=!0,F(">")),z.expression=m(0),l.push(z),k.id!==",")break;F(",")}return F(")"),this.lhs=i,this.rhs=l,this.type="binary",this});var Q=function(i){var l=[];if(k.id!=="}")for(;;){var z=m(0);F(":");var le=m(0);if(l.push([z,le]),k.id!==",")break;F(",")}return F("}",!0),typeof i=="undefined"?(this.lhs=l,this.type="unary"):(this.lhs=i,this.rhs=l,this.type="binary"),this};K("{",Q),U("{",P["{"],Q),se(":=",P[":="],function(i){return i.type!=="variable"?W({code:"S0212",stack:new Error().stack,position:i.position,token:i.value}):(this.lhs=i,this.rhs=m(P[":="]-1),this.type="binary",this)}),U("@",P["@"],function(i){return this.lhs=i,this.rhs=m(P["@"]),this.rhs.type!=="variable"?W({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"@"}):(this.type="binary",this)}),U("#",P["#"],function(i){return this.lhs=i,this.rhs=m(P["#"]),this.rhs.type!=="variable"?W({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"#"}):(this.type="binary",this)}),U("?",P["?"],function(i){return this.type="condition",this.condition=i,this.then=m(0),k.id===":"&&(F(":"),this.else=m(0)),this}),K("|",function(){return this.type="transform",this.pattern=m(0),F("|"),this.update=m(0),k.id===","&&(F(","),this.delete=m(0)),F("|"),this});var oe=function(i){var l;if(i.type==="function"&&!i.predicate){var z={type:"lambda",thunk:!0,arguments:[],position:i.position};z.body=i,l=z}else if(i.type==="condition")i.then=oe(i.then),typeof i.else!="undefined"&&(i.else=oe(i.else)),l=i;else if(i.type==="block"){var le=i.expressions.length;le>0&&(i.expressions[le-1]=oe(i.expressions[le-1])),l=i}else l=i;return l},pe=0,Se=0,Ne=[],we=function(i,l){switch(i.type){case"name":case"wildcard":l.level--,l.level===0&&(typeof i.ancestor=="undefined"||(Ne[l.index].slot.label=i.ancestor.label),i.ancestor=l,i.tuple=!0);break;case"parent":l.level++;break;case"block":i.expressions.length>0&&(i.tuple=!0,l=we(i.expressions[i.expressions.length-1],l));break;case"path":i.tuple=!0;var z=i.steps.length-1;for(l=we(i.steps[z--],l);l.level>0&&z>=0;)l=we(i.steps[z--],l);break;default:throw{code:"S0217",token:i.type,position:i.position}}return l},ce=function(i,l){if(typeof l.seekingParent!="undefined"||l.type==="parent"){var z=typeof l.seekingParent!="undefined"?l.seekingParent:[];l.type==="parent"&&z.push(l.slot),typeof i.seekingParent=="undefined"?i.seekingParent=z:Array.prototype.push.apply(i.seekingParent,z)}},Xe=function(i){var l=i.steps.length-1,z=i.steps[l],le=typeof z.seekingParent!="undefined"?z.seekingParent:[];z.type==="parent"&&le.push(z.slot);for(var Ee=0;Ee<le.length;Ee++){var Ae=le[Ee];for(l=i.steps.length-2;Ae.level>0;){if(l<0){typeof i.seekingParent=="undefined"?i.seekingParent=[Ae]:i.seekingParent.push(Ae);break}for(var d=i.steps[l--];l>=0&&d.focus&&i.steps[l].focus;)d=i.steps[l--];Ae=we(d,Ae)}}},ne=function(i){var l;switch(i.type){case"binary":switch(i.value){case".":var z=ne(i.lhs);z.type==="path"?l=z:l={type:"path",steps:[z]},z.type==="parent"&&(l.seekingParent=[z.slot]);var le=ne(i.rhs);le.type==="function"&&le.procedure.type==="path"&&le.procedure.steps.length===1&&le.procedure.steps[0].type==="name"&&l.steps[l.steps.length-1].type==="function"&&(l.steps[l.steps.length-1].nextFunction=le.procedure.steps[0].value),le.type==="path"?Array.prototype.push.apply(l.steps,le.steps):(typeof le.predicate!="undefined"&&(le.stages=le.predicate,delete le.predicate),l.steps.push(le)),l.steps.filter(function(M){if(M.type==="number"||M.type==="value")throw{code:"S0213",stack:new Error().stack,position:M.position,value:M.value};return M.type==="string"}).forEach(function(M){M.type="name"}),l.steps.filter(function(M){return M.keepArray===!0}).length>0&&(l.keepSingletonArray=!0);var Ee=l.steps[0];Ee.type==="unary"&&Ee.value==="["&&(Ee.consarray=!0);var Ae=l.steps[l.steps.length-1];Ae.type==="unary"&&Ae.value==="["&&(Ae.consarray=!0),Xe(l);break;case"[":l=ne(i.lhs);var d=l,b="predicate";if(l.type==="path"&&(d=l.steps[l.steps.length-1],b="stages"),typeof d.group!="undefined")throw{code:"S0209",stack:new Error().stack,position:i.position};typeof d[b]=="undefined"&&(d[b]=[]);var y=ne(i.rhs);typeof y.seekingParent!="undefined"&&(y.seekingParent.forEach(M=>{M.level===1?we(d,M):M.level--}),ce(d,y)),d[b].push({type:"filter",expr:y,position:i.position});break;case"{":if(l=ne(i.lhs),typeof l.group!="undefined")throw{code:"S0210",stack:new Error().stack,position:i.position};l.group={lhs:i.rhs.map(function(M){return[ne(M[0]),ne(M[1])]}),position:i.position};break;case"^":l=ne(i.lhs),l.type!=="path"&&(l={type:"path",steps:[l]});var T={type:"sort",position:i.position};T.terms=i.rhs.map(function(M){var Z=ne(M.expression);return ce(T,Z),{descending:M.descending,expression:Z}}),l.steps.push(T),Xe(l);break;case":=":l={type:"bind",value:i.value,position:i.position},l.lhs=ne(i.lhs),l.rhs=ne(i.rhs),ce(l,l.rhs);break;case"@":if(l=ne(i.lhs),d=l,l.type==="path"&&(d=l.steps[l.steps.length-1]),typeof d.stages!="undefined"||typeof d.predicate!="undefined")throw{code:"S0215",stack:new Error().stack,position:i.position};if(d.type==="sort")throw{code:"S0216",stack:new Error().stack,position:i.position};i.keepArray&&(d.keepArray=!0),d.focus=i.rhs.value,d.tuple=!0;break;case"#":l=ne(i.lhs),d=l,l.type==="path"?d=l.steps[l.steps.length-1]:(l={type:"path",steps:[l]},typeof d.predicate!="undefined"&&(d.stages=d.predicate,delete d.predicate)),typeof d.stages=="undefined"?d.index=i.rhs.value:d.stages.push({type:"index",value:i.rhs.value,position:i.position}),d.tuple=!0;break;case"~>":l={type:"apply",value:i.value,position:i.position},l.lhs=ne(i.lhs),l.rhs=ne(i.rhs),l.keepArray=l.lhs.keepArray||l.rhs.keepArray;break;default:l={type:i.type,value:i.value,position:i.position},l.lhs=ne(i.lhs),l.rhs=ne(i.rhs),ce(l,l.lhs),ce(l,l.rhs)}break;case"unary":l={type:i.type,value:i.value,position:i.position},i.value==="["?l.expressions=i.expressions.map(function(M){var Z=ne(M);return ce(l,Z),Z}):i.value==="{"?l.lhs=i.lhs.map(function(M){var Z=ne(M[0]);ce(l,Z);var he=ne(M[1]);return ce(l,he),[Z,he]}):(l.expression=ne(i.expression),i.value==="-"&&l.expression.type==="number"?(l=l.expression,l.value=-l.value):ce(l,l.expression));break;case"function":case"partial":l={type:i.type,name:i.name,value:i.value,position:i.position},l.arguments=i.arguments.map(function(M){var Z=ne(M);return ce(l,Z),Z}),l.procedure=ne(i.procedure);break;case"lambda":l={type:i.type,arguments:i.arguments,signature:i.signature,position:i.position};var _=ne(i.body);l.body=oe(_);break;case"condition":l={type:i.type,position:i.position},l.condition=ne(i.condition),ce(l,l.condition),l.then=ne(i.then),ce(l,l.then),typeof i.else!="undefined"&&(l.else=ne(i.else),ce(l,l.else));break;case"transform":l={type:i.type,position:i.position},l.pattern=ne(i.pattern),l.update=ne(i.update),typeof i.delete!="undefined"&&(l.delete=ne(i.delete));break;case"block":l={type:i.type,position:i.position},l.expressions=i.expressions.map(function(M){var Z=ne(M);return ce(l,Z),(Z.consarray||Z.type==="path"&&Z.steps[0].consarray)&&(l.consarray=!0),Z});break;case"name":l={type:"path",steps:[i]},i.keepArray&&(l.keepSingletonArray=!0);break;case"parent":l={type:"parent",slot:{label:"!"+pe++,level:1,index:Se++}},Ne.push(l);break;case"string":case"number":case"value":case"wildcard":case"descendant":case"variable":case"regex":l=i;break;case"operator":if(i.value==="and"||i.value==="or"||i.value==="in")i.type="name",l=ne(i);else if(i.value==="?")l=i;else throw{code:"S0201",stack:new Error().stack,position:i.position,token:i.value};break;case"error":l=i,i.lhs&&(l=ne(i.lhs));break;default:var D="S0206";i.id==="(end)"&&(D="S0207");var w={code:D,position:i.position,token:i.value};if(x)return be.push(w),{type:"error",error:w};throw w.stack=new Error().stack,w}return i.keepArray&&(l.keepArray=!0),l};j=G(I),F();var _e=m(0);if(k.id!=="(end)"){var tt={code:"S0201",position:k.position,token:k.value};W(tt)}if(_e=ne(_e),_e.type==="parent"||typeof _e.seekingParent!="undefined")throw{code:"S0217",token:_e.type,position:_e.position};return be.length>0&&(_e.errors=be),_e};return ae})();h.exports=v},{"./signature":5}],5:[function(u,h,C){var O=u("./utils");const v=(()=>{var P={a:"arrays",b:"booleans",f:"functions",n:"numbers",o:"objects",s:"strings"};function V(G){for(var ae=1,I=[],x={},k=x;ae<G.length;){var j=G.charAt(ae);if(j===":")break;var fe=function(){I.push(x),k=x,x={}},be=function(U,se,K,Q){for(var oe=1,pe=se;pe<U.length;)if(pe++,j=U.charAt(pe),j===Q){if(oe--,oe===0)break}else j===K&&oe++;return pe};switch(j){case"s":case"n":case"b":case"l":case"o":x.regex="["+j+"m]",x.type=j,fe();break;case"a":x.regex="[asnblfom]",x.type=j,x.array=!0,fe();break;case"f":x.regex="f",x.type=j,fe();break;case"j":x.regex="[asnblom]",x.type=j,fe();break;case"x":x.regex="[asnblfom]",x.type=j,fe();break;case"-":k.context=!0,k.contextRegex=new RegExp(k.regex),k.regex+="?";break;case"?":case"+":k.regex+=j;break;case"(":var xe=be(G,ae,"(",")"),Y=G.substring(ae+1,xe);if(Y.indexOf("<")===-1)x.regex="["+Y+"m]";else throw{code:"S0402",stack:new Error().stack,value:Y,offset:ae};x.type="("+Y+")",ae=xe,fe();break;case"<":if(k.type==="a"||k.type==="f"){var S=be(G,ae,"<",">");k.subtype=G.substring(ae+1,S),ae=S}else throw{code:"S0401",stack:new Error().stack,value:k.type,offset:ae};break}ae++}var W="^"+I.map(function(U){return"("+U.regex+")"}).join("")+"$",F=new RegExp(W),m=function(U){var se;if(O.isFunction(U))se="f";else{var K=typeof U;switch(K){case"string":se="s";break;case"number":se="n";break;case"boolean":se="b";break;case"object":U===null?se="l":Array.isArray(U)?se="a":se="o";break;case"undefined":default:se="m"}}return se},$=function(U,se){for(var K="^",Q=0,oe=0;oe<I.length;oe++){K+=I[oe].regex;var pe=se.match(K);if(pe===null)throw{code:"T0410",stack:new Error().stack,value:U[Q],index:Q+1};Q=pe[0].length}throw{code:"T0410",stack:new Error().stack,value:U[Q],index:Q+1}};return{definition:G,validate:function(U,se){var K="";U.forEach(function(Se){K+=m(Se)});var Q=F.exec(K);if(Q){var oe=[],pe=0;return I.forEach(function(Se,Ne){var we=U[pe],ce=Q[Ne+1];if(ce==="")if(Se.context&&Se.contextRegex){var Xe=m(se);if(Se.contextRegex.test(Xe))oe.push(se);else throw{code:"T0411",stack:new Error().stack,value:se,index:pe+1}}else oe.push(we),pe++;else ce.split("").forEach(function(ne){if(Se.type==="a"){if(ne==="m")we=void 0;else{we=U[pe];var _e=!0;if(typeof Se.subtype!="undefined"){if(ne!=="a"&&ce!==Se.subtype)_e=!1;else if(ne==="a"&&we.length>0){var tt=m(we[0]);if(tt!==Se.subtype.charAt(0))_e=!1;else{var i=we.filter(function(l){return m(l)!==tt});_e=i.length===0}}}if(!_e)throw{code:"T0412",stack:new Error().stack,value:we,index:pe+1,type:P[Se.subtype]};ne!=="a"&&(we=[we])}oe.push(we),pe++}else oe.push(we),pe++})}),oe}$(U,K)}}}return V})();h.exports=v},{"./utils":6}],6:[function(u,h,C){const O=(()=>{function v(S){var W=!1;if(typeof S=="number"&&(W=!isNaN(S),W&&!isFinite(S)))throw{code:"D1001",value:S,stack:new Error().stack};return W}function P(S){var W=!1;return Array.isArray(S)&&(W=S.filter(function(F){return typeof F!="string"}).length===0),W}function V(S){var W=!1;return Array.isArray(S)&&(W=S.filter(function(F){return!v(F)}).length===0),W}function G(){var S=[];return S.sequence=!0,arguments.length===1&&S.push(arguments[0]),S}function ae(S){return S.sequence===!0&&Array.isArray(S)}function I(S){return S&&(S._jsonata_function===!0||S._jsonata_lambda===!0)||typeof S=="function"}function x(S){var W=typeof S.arity=="number"?S.arity:typeof S.implementation=="function"?S.implementation.length:typeof S.length=="number"?S.length:S.arguments.length;return W}function k(S){return S&&S._jsonata_lambda===!0}var j=(typeof Symbol=="function"?Symbol:{}).iterator||"@@iterator";function fe(S){return typeof S=="object"&&S!==null&&j in S&&"next"in S&&typeof S.next=="function"}function be(S,W){if(S===W)return!0;if(typeof S=="object"&&typeof W=="object"&&S!==null&&W!==null){if(Array.isArray(S)&&Array.isArray(W)){if(S.length!==W.length)return!1;for(var F=0;F<S.length;F++)if(!be(S[F],W[F]))return!1;return!0}var m=Object.getOwnPropertyNames(S),$=Object.getOwnPropertyNames(W);if(m.length!==$.length)return!1;for(m=m.sort(),$=$.sort(),F=0;F<m.length;F++)if(m[F]!==$[F])return!1;for(F=0;F<m.length;F++){var U=m[F];if(!be(S[U],W[U]))return!1}return!0}return!1}function xe(S){return typeof S=="object"&&S!==null&&"then"in S&&typeof S.then=="function"}function Y(S){var W=[];for(let F of S)W.push(F);return W}return{isNumeric:v,isArrayOfStrings:P,isArrayOfNumbers:V,createSequence:G,isSequence:ae,isFunction:I,isLambda:k,isIterable:fe,getFunctionArity:x,isDeepEqual:be,stringToArray:Y,isPromise:xe}})();h.exports=O},{}]},{},[3])(3)})})(_r);var Tu=_r.exports;const Eu=sr(Tu),Mr=/\{\{\$params\.(.*?)\}\}/g,Nr=(t,a)=>{const u=JSON.stringify(t),h={};return[...u.matchAll(Mr)].forEach(C=>{var v;const O=C[1];h[O]=((v=a.filter(P=>P.key===O)[0])==null?void 0:v.value)||""}),JSON.parse(u.replace(Mr,(C,O)=>h[O]))},Du=()=>{const{testVisible:t,setTestVisible:a,configDetail:u}=te.useContext(mt),{curApi:h}=te.useContext(yt),{config:{headers:C,contentType:O,baseUrl:v}}=h;let{callPath:P,method:V,engine:G,expression:ae}=u;const[I,x]=te.useState([]),k=te.useMemo(()=>Nr((u==null?void 0:u.requestParams)||[],I),[JSON.stringify(I)]),j=te.useMemo(()=>Nr((u==null?void 0:u.requestBody)||{},I),[JSON.stringify(I)]),[fe,be]=te.useState([]),[xe,Y]=te.useState("{}"),[S,W]=te.useState(!1),[F,m]=te.useState("inputParams");te.useEffect(()=>{x(t?Rt.cloneDeep((u==null?void 0:u.externalParams)||[]):[]),be(t?Rt.cloneDeep((u==null?void 0:u.subSequentParams)||[]):[])},[t]);const $=[{label:H("Input params"),key:"inputParams",children:A.jsx(ie.Form.Item,{help:I.filter(K=>K.required&&!(K!=null&&K.value)).slice(0,1).map(K=>A.jsx("p",{style:{color:"#FF4D4F"},children:`${K.label} is required`},K.key)),children:A.jsx(ie.Table,{columns:[{title:H("Display key"),dataIndex:"label",key:"label",width:"200px",render:(K,Q)=>A.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[Q.required&&A.jsx("span",{style:{color:"#ff4d4f"},children:"*"}),K]})},{title:H("Description"),dataIndex:"desc",key:"desc"},{title:H("Value"),dataIndex:"value",key:"value",width:"300px",render:(K,Q,oe)=>A.jsx(ie.Input,{onChange:pe=>{x(Se=>{const Ne=[...Se];return Ne.splice(oe,1,Ze($e({},Ne[oe]),{value:pe.target.value})),Ne})}})}],dataSource:I,pagination:!1,size:"small"})})},{label:H("Headers",{ns:"workflow-request"}),key:"headers",children:A.jsx(ie.Table,{columns:[{title:H("Key"),dataIndex:"key",key:"key"},{title:H("Value"),dataIndex:"value",key:"value",width:"300px"}],dataSource:(C||[]).reduce((K,Q)=>(Object.keys(Q).forEach(oe=>{K.push({key:oe,value:Q[oe]})}),K),[]),pagination:!1,size:"small"})},{label:H("Request params"),key:"requestParams",children:A.jsx(ie.Table,{columns:[{title:H("Key"),dataIndex:"key",key:"key"},{title:H("Value"),dataIndex:"value",key:"value",width:"300px",render:K=>A.jsx(ie.Input,{value:K,disabled:!0})}],dataSource:k||[],pagination:!1,size:"small"})},{label:H("Body",{ns:"workflow-request"}),key:"body",children:A.jsx(N.Json,{value:j||{},disabled:!0,autoSize:{minRows:10}})}],U=[{label:H("Subsequent params"),key:"subsequentParams",children:A.jsx(ie.Table,{columns:[{title:H("Display key"),dataIndex:"title",key:"title",width:"200px"},{title:H("Description"),dataIndex:"description",key:"description"},{title:H("Value"),dataIndex:"value",key:"value",width:"300px",render:K=>A.jsx(ie.Input,{value:K,disabled:!0})}],dataSource:fe,pagination:!1,size:"small"})},{label:H("Response"),key:"Response",children:A.jsx(N.Json,{value:xe,disabled:!0,autoSize:{minRows:10}})}],se=()=>{if(I.some(Q=>Q.required&&!(Q!=null&&Q.value)))return;const K={url:v+P,method:V.toLowerCase(),headers:C.reduce((Q,oe)=>(Q=$e($e({},Q),oe),Q),{"Content-Type":O})};K.method==="get"?K.params=k.reduce((Q,oe)=>(Q[oe.key]=oe.value,Q),{}):K.data=j,W(!0),Br.request(K).then(Q=>R(this,null,function*(){if(Y(Q.data),G==="jsonata.js"){const oe=yield Eu(ae).evaluate(Q.data);be(pe=>{const Se=[...pe];return Se.forEach(Ne=>{Ne.value=(oe==null?void 0:oe[Ne.key])||""}),Se})}})).catch(Q=>{Y(Q.response.data)}).finally(()=>{W(!1)})};return A.jsxs(ie.Modal,{title:H("Test run"),destroyOnClose:!0,open:t,width:840,footer:null,onCancel:()=>a(!1),children:[A.jsx(ie.Alert,{style:{marginTop:24},showIcon:!0,type:"warning",message:H("Test run will do the actual API calling, please use with caution.")}),A.jsxs("div",{style:{display:"flex",marginTop:24},children:[A.jsx(ie.Input,{addonBefore:V,value:v+P,disabled:!0}),A.jsx(ie.Button,{style:{marginLeft:10},type:"primary",icon:A.jsx(ht.CaretRightOutlined,{}),loading:S,onClick:se,children:H("Run")})]}),A.jsx(ie.Tabs,{style:{marginTop:24},items:$,onChange:K=>m(K)}),A.jsx(ie.Tabs,{style:{marginTop:F==="inputParams"?0:24},items:U})]})},Iu=()=>{var h,C;const{collection:t}=N.useResourceContext(),a=N.useFilterFieldOptions(t.fields),u=N.useResourceActionContext();return N.useFilterFieldProps({options:a,params:((C=(h=u.state)==null?void 0:h.params)==null?void 0:C[0])||u.params,service:u})},Ou={type:"object",properties:{list:{type:"void",properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-component":"Filter.Action","x-component-props":{icon:"FilterOutlined"},"x-use-component-props":"useFilterActionProps","x-align":"left"},add:{type:"void",title:`${H("New")}${H("API call configuration")}`,"x-component":"Action","x-component-props":{type:"primary",icon:"PlusOutlined"},properties:{drawer:{type:"void",title:`${H("New")}${H("API call configuration")}`,"x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:t=>{const{curApi:a}=te.useContext(yt),u=N.useRequest(()=>Promise.resolve({data:{externalApiId:a.id}}),Ze($e({},t),{manual:!0})),h=N.useActionContext();return te.useEffect(()=>{h.visible&&u.run()},[h.visible]),u}},properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},description:{"x-component":"CollectionField","x-decorator":"FormItem"},status:{"x-component":"CollectionField","x-decorator":"FormItem",default:!0},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useCreateAction }}"}}}}}}}}}},table:{type:"void","x-component":"Table.Void","x-component-props":{rowKey:"id",useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{column1:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{description:{type:"text","x-component":"CollectionField","x-read-pretty":!0}}},column3:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{status:{type:"boolean","x-component":"CollectionField","x-read-pretty":!0}}},column4:{type:"void",title:'{{ t("Actions") }}',"x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{configure:Pu,edit:{type:"void",title:'{{ t("Edit") }}',"x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void",title:`${H("Edit")}${H("API call configuration")}`,"x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:t=>{const a=N.useRecord(),u=N.useRequest(()=>Promise.resolve({data:a}),Ze($e({},t),{manual:!0})),h=N.useActionContext();return te.useEffect(()=>{h.visible&&u.run()},[h.visible]),u}},properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},description:{"x-component":"CollectionField","x-decorator":"FormItem"},status:{"x-component":"CollectionField","x-decorator":"FormItem"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useUpdateAction }}"}}}}}}}},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action.Link","x-component-props":{confirm:{title:`${H("Delete")}${H("API call configuration")}`,content:`{{ t('Are you sure you want to delete it? After deletion, the API call configuration will be invalid.', { ns: '${ge}' }) }}`},useAction:"{{ cm.useDestroyAction }}"}}}}}}}}}}}},Fu=t=>{const{apiId:a}=t,{run:u,params:h}=N.useResourceActionContext(),[C,O]=te.useState([]),[v,P]=te.useState(!1),[V,G]=te.useState({});return te.useEffect(()=>{a&&u(Ze($e({},h==null?void 0:h[0]),{filter:{$and:[{externalApiId:{$eq:a}}]}}))},[a]),A.jsxs(mt.Provider,{value:{externalParams:C,setExternalParams:O,testVisible:v,setTestVisible:P,configDetail:V,setConfigDetail:G},children:[A.jsx(N.SchemaComponent,{schema:Ou,scope:Ze($e({},Cu),{useFilterActionProps:Iu}),components:$e({},Su)}),A.jsx(Du,{})]})},$u={name:"externalApis",filterTargetKey:"id",targetKey:"id",fields:[{type:"string",name:"name",interface:"input",uiSchema:{title:`{{ t('API name', { ns: '${ge}' }) }}`,type:"string","x-component":"Input",required:!0}},{type:"string",name:"provider",interface:"input",uiSchema:{title:`{{ t('API Provider', { ns: '${ge}' }) }}`,type:"string","x-component":"Input",required:!0}},{type:"text",name:"description",interface:"textarea",uiSchema:{title:`{{ t('Description', { ns: '${ge}' }) }}`,type:"string","x-component":"Input.TextArea"}},{type:"boolean",name:"status",interface:"select",uiSchema:{title:`{{ t('Status', { ns: '${ge}' }) }}`,type:"boolean","x-component":"Select",enum:[{label:'{{ t("Enabled") }}',value:!0},{label:'{{ t("Disabled") }}',value:!1}]}}]},_u={name:"externalApiConfigurations",filterTargetKey:"id",targetKey:"id",fields:[{type:"string",name:"name",interface:"input",uiSchema:{title:`{{ t('Configuration name', { ns: '${ge}' }) }}`,type:"string","x-component":"Input",required:!0}},{type:"text",name:"description",interface:"textarea",uiSchema:{title:`{{ t('Description', { ns: '${ge}' }) }}`,type:"string","x-component":"Input.TextArea"}},{type:"boolean",name:"status",interface:"select",uiSchema:{title:`{{ t('Status', { ns: '${ge}' }) }}`,type:"boolean","x-component":"Select",enum:[{label:'{{ t("Enabled") }}',value:!0,color:"green"},{label:'{{ t("Disabled") }}',value:!1}]}}]},Mu=()=>{const[t,a]=te.useState({}),{id:u}=t;return A.jsx(yt.Provider,{value:{curApi:t,setCurApi:a},children:A.jsx(ie.Card,{children:A.jsxs(ie.Row,{gutter:24,style:{flexWrap:"nowrap"},children:[A.jsx(ie.Col,{flex:"430px",style:{borderRight:"1px solid #eee",minWidth:"400px"},children:A.jsxs(N.ResourceActionProvider,{collection:$u,request:{resource:"externalApis",action:"list",params:{}},children:[A.jsx(Rr,{}),A.jsx(ie.Divider,{style:{margin:"12px 0"}}),A.jsx(Vt,{})]})}),A.jsx(ie.Col,{flex:"auto",children:u?A.jsx(N.ResourceActionProvider,{collection:_u,request:{resource:"externalApiConfigurations",action:"list",params:{pageSize:20,filter:{$and:[{externalApiId:{$eq:u}}]}}},children:A.jsx(Fu,{apiId:u})}):null})]})})})};function Ue(t){return`{{t('${t}', { ns: '${ge}', nsMode: 'fallback' })}}`}const Nu={dumpRules:{group:"user"},shared:!0,name:"apiKeys",sortable:"sort",createdBy:!0,updatedAt:!1,updatedBy:!1,logging:!0,fields:[{name:"id",type:"bigInt",autoIncrement:!0,primaryKey:!0,allowNull:!1,interface:"id"},{type:"string",name:"name",interface:"input",uiSchema:{type:"string",title:'{{t("name")}}',"x-component":"Input"}},{interface:"obo",type:"belongsTo",name:"role",target:"roles",foreignKey:"roleName",uiSchema:{type:"object",title:'{{t("Roles")}}',"x-component":"Select","x-component-props":{fieldNames:{label:"title",value:"name"},objectValue:!0,options:"{{ currentRoles }}"}}},{name:"expiresIn",type:"string",uiSchema:{type:"string",title:Ue("Expires"),"x-component":"ExpiresSelect",enum:[{label:Ue("1 Day"),value:"1d"},{label:Ue("7 Days"),value:"7d"},{label:Ue("30 Days"),value:"30d"},{label:Ue("90 Days"),value:"90d"},{label:Ue("Custom"),value:"custom"},{label:Ue("Never"),value:"never"}]}},{name:"token",type:"string",hidden:!0}]},{useModal:ju}=ie.Modal,qu=()=>{const t=Ve.useForm(),{setVisible:a}=N.useActionContext(),{resource:u,service:h}=N.useBlockRequestContext(),{t:C}=ir(),[O,v]=ju();return{run(){return R(this,null,function*(){var G,ae;yield t.submit();const V=yield u.create({values:t.values});O.success({title:C("API key created successfully"),onOk:()=>{t.reset(),a(!1)},content:A.jsxs(ie.Space,{direction:"vertical",children:[A.jsx(ie.Alert,{message:C("Make sure to copy your personal access key now as you will not be able to see this again."),type:"warning"}),A.jsx(ie.Typography.Text,{copyable:!0,children:(ae=(G=V.data)==null?void 0:G.data)==null?void 0:ae.token})]})}),h==null||h.refresh()})},element:v}},Uu=()=>{const t=N.useRecord(),{resource:a,service:u}=N.useBlockRequestContext();return{run(){return R(this,null,function*(){yield a.destroy({filterByTk:t.id}),u.refresh()})}}},zu={type:"object",properties:{tabs:{type:"void","x-component":"Tabs","x-component-props":{},properties:{external:{type:"void",title:`{{ t('External API manager', { ns: '${ge}' }) }}`,"x-component":"Tabs.TabPane",properties:{grid:{type:"void","x-component":"ExternalApi"}}},internal:{type:"void",title:`{{ t('Internal API keys', { ns: '${ge}' }) }}`,"x-component":"Tabs.TabPane",properties:{configuration:{type:"void","x-decorator":"TableBlockProvider","x-decorator-props":{collection:Nu,resource:"apiKeys",action:"list",params:{pageSize:20,appends:["role"],sort:["-createdAt"]},rowKey:"name",showIndex:!0},"x-component":"CardItem",properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:"var(--nb-spacing)"}},properties:{create:{type:"void","x-action":"create",title:Ue("Add API key"),"x-component":"Action","x-component-props":{icon:"PlusOutlined",openMode:"drawer",type:"primary"},properties:{drawer:{type:"void",title:Ue("Add API key"),"x-decorator":"Form","x-component":"Action.Modal","x-component-props":{maskClosable:!1,style:{maxWidth:"520px",width:"100%"}},properties:{name:{type:"string",title:Ue("Key name"),required:!0,"x-component":"CollectionField","x-decorator":"FormItem"},role:{type:"string",title:Ue("Role"),required:!0,"x-decorator-props":{tooltip:Ue("Allow only your own roles to be selected")},"x-collection-field":"apiKeys.role","x-component":"CollectionField","x-decorator":"FormItem"},expiresIn:{type:"string",title:Ue("Expiration"),required:!0,"x-component":"CollectionField","x-decorator":"FormItem",default:"30d"},footer:{type:"void","x-component":"Action.Modal.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:qu}}}}}}},"x-align":"right"}}},[Nt.uid()]:{type:"array","x-component":"TableV2","x-use-component-props":"useTableBlockProps","x-component-props":{rowKey:"id"},properties:{column1:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column",title:Ue("Key name"),properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column",title:Ue("Role"),properties:{role:{type:"object","x-collection-field":"apiKeys.role","x-component":"CollectionField","x-component-props":{enableLink:!1},"x-read-pretty":!0}}},column3:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column",title:Ue("Expiration"),properties:{expiresIn:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column4:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column",title:Ue("Created at"),properties:{createdAt:{type:"date","x-component":"DatePicker","x-component-props":{format:"YYYY-MM-DD HH:mm:ss"},"x-read-pretty":!0}}},actionColumn:{type:"void",title:'{{ t("Actions") }}',"x-action-column":"actions","x-decorator":"TableV2.Column.ActionBar","x-component":"TableV2.Column",properties:{columnActions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action.Link","x-component-props":{confirm:{title:Ue("Delete API key"),content:"{{t('Are you sure you want to delete it?')}}"},useAction:Uu}}}}}}}}}}}}}}}},Lu=()=>{const t=N.useCurrentRoles();return A.jsx(N.SchemaComponentOptions,{scope:{currentRoles:t},components:{ExpiresSelect:Wr,ExternalApi:Mu},children:A.jsx(Ve.RecursionField,{schema:zu})})};class jr extends N.Plugin{load(){return R(this,null,function*(){this.pluginSettingsManager.add("api-manager",{icon:"KeyOutlined",title:this.t("API manager"),Component:Lu,aclSnippet:"pm.api-keys.configuration"})})}}ye.PluginAPIKeysClient=jr,ye.default=jr,Object.defineProperties(ye,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
