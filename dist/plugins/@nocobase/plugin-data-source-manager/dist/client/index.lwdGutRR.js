(function(k,s){typeof exports=="object"&&typeof module!="undefined"?s(exports,require("react/jsx-runtime"),require("@nocobase/client"),require("react"),require("@formily/react"),require("antd"),require("react-i18next"),require("@ant-design/icons"),require("react-router-dom"),require("@formily/shared"),require("@formily/reactive"),require("@formily/core"),require("@formily/antd-v5"),require("lodash"),require("@nocobase/utils/client"),require("@dnd-kit/core"),require("@emotion/css"),require("antd-style")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@nocobase/client","react","@formily/react","antd","react-i18next","@ant-design/icons","react-router-dom","@formily/shared","@formily/reactive","@formily/core","@formily/antd-v5","lodash","@nocobase/utils/client","@dnd-kit/core","@emotion/css","antd-style"],s):(k=typeof globalThis!="undefined"?globalThis:k||self,s(k["@nocobase/plugin-data-source-manager"]={},k.jsxRuntime,k["@nocobase/client"],k.react,k["@formily/react"],k.antd,k["react-i18next"],k["@ant-design/icons"],k["react-router-dom"],k["@formily/shared"],k["@formily/reactive"],k["@formily/core"],k["@formily/antd-v5"],k.lodash,k["@nocobase/utils"],k["@dnd-kit/core"],k["@emotion/css"],k["antd-style"]))})(this,function(k,s,r,d,_,S,B,Z,q,V,Be,fe,se,X,Ae,Y,ge,Zo){"use strict";var Wf=Object.defineProperty,Qf=Object.defineProperties;var Yf=Object.getOwnPropertyDescriptors;var Ne=Object.getOwnPropertySymbols;var Qo=Object.prototype.hasOwnProperty,Yo=Object.prototype.propertyIsEnumerable;var dt=(k,s,r)=>s in k?Wf(k,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):k[s]=r,T=(k,s)=>{for(var r in s||(s={}))Qo.call(s,r)&&dt(k,r,s[r]);if(Ne)for(var r of Ne(s))Yo.call(s,r)&&dt(k,r,s[r]);return k},N=(k,s)=>Qf(k,Yf(s));var mt=(k,s)=>{var r={};for(var d in k)Qo.call(k,d)&&s.indexOf(d)<0&&(r[d]=k[d]);if(k!=null&&Ne)for(var d of Ne(k))s.indexOf(d)<0&&Yo.call(k,d)&&(r[d]=k[d]);return r};var Jo=(k,s,r)=>(dt(k,typeof s!="symbol"?s+"":s,r),r);var O=(k,s,r)=>new Promise((d,_)=>{var S=q=>{try{Z(r.next(q))}catch(V){_(V)}},B=q=>{try{Z(r.throw(q))}catch(V){_(V)}},Z=q=>q.done?d(q.value):Promise.resolve(q.value).then(S,B);Z((r=r.apply(k,s)).next())});const K="data-source-manager";function Xo(e,t={}){return r.i18n.t(e,N(T({},t),{ns:K}))}const Ro=e=>{const t=_.useForm(),o=r.useActionContext(),n=r.useAPIClient(),{t:i}=B.useTranslation(),a=_.useField();return a.data=a.data||{},{run(){return O(this,null,function*(){yield t.submit();try{a.data.loading=!0;const{data:l}=yield n.resource("databaseServers").create({values:T({},t.values)});a.data.loading=!1,o.setVisible(!1),yield t.reset(),e==null||e(l==null?void 0:l.data),S.message.success(i("Saved successfully"))}catch(l){a.data.loading=!1,console.log(l)}})}}},yt=()=>{const e=_.useForm(),t=r.useAPIClient(),{t:o}=B.useTranslation(),n=_.useField();return n.data=n.data||{},{run(){return O(this,null,function*(){yield e.submit();try{n.data.loading=!0,yield t.resource("dataSources").testConnection({values:T({},e.values)}),n.data.loading=!1,S.message.success(o("Connection successful",{ns:K}))}catch(a){n.data.loading=!1,console.log(a)}})}}},en=Object.freeze(Object.defineProperty({__proto__:null,useCreateDatabaseServer:Ro,useTestConnectionAction:yt},Symbol.toStringTag,{value:"Module"})),$e=d.createContext(null);$e.displayName="DataSourceContext";const tn=e=>{const[t,o]=d.useState(null);return s.jsx($e.Provider,{value:{dataSource:t,setDataSource:o},children:s.jsx(r.SchemaComponentOptions,{scope:en,components:{},children:e.children})})};class ft extends r.DataSource{getDataSource(){return O(this,null,function*(){return(yield this.app.apiClient.request({url:`dataSources:get/${this.key}`,params:{appends:["collections"]}})).data.data})}}const gt=[{value:"loading",label:`{{t("Loading",{ns:"${K}"})}}`,color:"orange"},{value:"loading-failed",label:`{{t("Failed",{ns:"${K}"})}}`,color:"red"},{value:"loaded",label:`{{t("Loaded",{ns:"${K}"})}}`,color:"green"},{value:"reloading",label:`{{t("Reloading",{ns:"${K}"})}}`,color:"orange"}],ht={name:"collections-"+V.uid(),fields:[{type:"string",name:"key",interface:"input",uiSchema:{title:`{{t("Data source name",{ ns: "${K}" })}}`,type:"string","x-component":"Input",required:!0}},{type:"string",name:"displayName",interface:"input",uiSchema:{title:`{{t("Data source display name",{ ns: "${K}" })}}`,type:"string","x-component":"Input",required:!0}},{type:"string",name:"type",interface:"select",uiSchema:{title:`{{t("Type", { ns: "${K}" })}}`,type:"string","x-component":"Select",enum:"{{types}}"}},{type:"string",name:"status",interface:"select",uiSchema:{title:`{{t("Status", { ns: "${K}" })}}`,type:"string","x-component":"Select",enum:gt}},{type:"boolean",name:"enabled",uiSchema:{type:"boolean",title:'{{t("Enabled")}}',"x-component":"Checkbox"}}]},on={type:"object",properties:{[V.uid()]:{type:"void","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:ht,resourceName:"dataSources",request:{resource:"dataSources",action:"list",params:{pageSize:50,appends:[]}}},"x-component":"CollectionProvider_deprecated","x-component-props":{collection:ht},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{refresh:{type:"void",title:'{{ t("Refresh") }}',"x-component":"Action","x-use-component-props":"useRefreshActionProps","x-component-props":{icon:"ReloadOutlined"}},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action","x-component-props":{icon:"DeleteOutlined",useAction:"{{ cm.useBulkDestroyAction }}",confirm:{title:"{{t('Delete')}}",content:"{{t('Are you sure you want to delete it?')}}"},actionCallback:"{{ dataSourceDeleteCallback }}"}},create:{type:"void",title:'{{t("Add new")}}',"x-component":"CreateDatabaseConnectAction","x-component-props":{type:"primary"}}}},table:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"key",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{key:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{key:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},displayName:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{displayName:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},type:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{type:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},status:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{status:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},enabled:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{enabled:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},actions:{type:"void",title:'{{t("Actions")}}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{},properties:{view:{type:"void",title:'{{t("View")}}',"x-component":"ViewDatabaseConnectionAction","x-component-props":{type:"primary"}},update:{type:"void",title:'{{t("Edit")}}',"x-component":"EditDatabaseConnectionAction","x-component-props":{type:"primary"},"x-reactions":["{{useIsAbleDelete($self)}}"]},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action.Link","x-component-props":{confirm:{title:'{{t("Delete")}}',content:'{{t("Are you sure you want to delete it?")}}'},useAction:"{{useDestroyAction}}"},"x-reactions":["{{useIsAbleDelete($self)}}"]}}}}}}}}}}},Ct=()=>{const e=r.useApp(),{name:t}=q.useParams(),o=r.useCompile(),n=r.useDataSourceManager(),{displayName:i}=n.getDataSource(t)||{},{dataSource:a}=d.useContext($e),c=d.useMemo(()=>a||n.getDataSource(t),[a,t]),l=d.useMemo(()=>{const p=c==null?void 0:c.status,u=gt.find(y=>y.value===p),m=[{title:s.jsx(q.Link,{to:e.pluginSettingsManager.getRoutePath(K),children:Xo("Data source manager")})}];return c&&m.push({title:s.jsxs(S.Space,{children:[s.jsx("span",{children:o(i)}),p&&s.jsx(S.Tag,{color:u==null?void 0:u.color,children:o(u==null?void 0:u.label)},p)]})}),m},[c]);return s.jsx(S.Breadcrumb,{separator:s.jsx(Z.RightOutlined,{}),items:l})},vt=e=>_.Schema.compile(e,{t:r.i18n.t}),nn={name:"database-"+V.uid(),filterTargetKey:"name",targetKey:"name",sortable:!0,fields:[{type:"integer",name:"title",interface:"input",uiSchema:{title:'{{ t("Collection display name") }}',type:"number","x-component":"Input",required:!0}},{type:"string",name:"name",interface:"input",uiSchema:{title:'{{ t("Collection name") }}',type:"string","x-component":"CollectionName",description:'{{t("Randomly generated and can be modified. Support letters, numbers and underscores, must start with an letter.")}}'}},{type:"hasMany",name:"fields",target:"fields",collectionName:"collections",sourceKey:"name",targetKey:"name",uiSchema:{}},{type:"hasMany",name:"inherits",interface:"select",uiSchema:{title:'{{ t("Inherits") }}',type:"string","x-component":"Select","x-component-props":{mode:"multiple"}}},{type:"string",name:"description",interface:"input",uiSchema:{title:'{{ t("Description") }}',type:"string","x-component":"Input"}}]},rn=e=>({type:"object",properties:{[V.uid()]:{type:"void","x-collection":"dataSources","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:nn,dragSort:!1,request:{url:`dataSources/${e}/collections:list`,params:{pageSize:50,sort:"sort",filter:{"hidden.$isFalsy":!0},appends:["category"]}}},properties:{tabs:{type:"void","x-component":"ConfigurationTabs"}}}}}),Ve={type:"object",properties:{[V.uid()]:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',default:{$and:[{title:{$includes:""}},{name:{$includes:""}}]},"x-action":"filter","x-component":"Filter.Action","x-use-component-props":"cm.useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"},refresh:{type:"void",title:'{{ t("Refresh") }}',"x-component":"Action","x-use-component-props":"useRefreshActionProps","x-component-props":{icon:"ReloadOutlined"}},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"DeleteCollection","x-component-props":{role:"button",isBulk:!0},"x-visible":!1},create:{type:"void",title:'{{ t("Create collection") }}',"x-component":"AddCollection","x-component-props":{type:"primary"},"x-visible":!1}}},[V.uid()]:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"name",rowSelection:{type:"checkbox"},useDataSource:"{{cm.useDataSourceFromRAC }}",useAction(){const e=r.useAPIClient(),{t}=B.useTranslation();return{move(n,i){return O(this,null,function*(){yield e.resource("dataSources").move({sourceId:n.key,targetId:i.key}),S.message.success(t("Saved successfully"),.2)})}}}},properties:{column1:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{title:{"x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column5:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{description:{"x-component":"CollectionField","x-read-pretty":!0,"x-component-props":{ellipsis:!0}}}},column6:{type:"void",title:'{{ t("Actions") }}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{view:{type:"void",title:'{{ t("Configure fields") }}',"x-component":"Action.Link","x-component-props":{},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-component-props":{destroyOnClose:!0,width:"70%"},"x-reactions":e=>{const t=e.path.segments[1],o=e.path.segments[0],n=e.form.getValuesIn(`${o}.${t}`);n&&(e.title=`${vt(n.title||n.name)} - ${vt('{{ t("Configure fields") }}')}`)},properties:{collectionFields:{type:"void","x-component":"CollectionFields"}}}}},update:{type:"void",title:'{{ t("Edit") }}',"x-component":"EditCollection","x-component-props":{role:"button","aria-label":'{{ "edit-button-" + $record.name }}',type:"primary"}},delete:{type:"void",title:'{{ t("Delete") }}',"x-visible":!1,"x-component":"DeleteCollection","x-component-props":{role:"button","aria-label":'{{ "delete-button-" + $record.name }}',type:"primary",className:"nb-action-link"}}}}}}}}}},an={name:"fields",fields:[{type:"string",name:"type",interface:"input",uiSchema:{title:'{{ t("Storage type") }}',type:"string","x-component":"Select",enum:[{label:"String",value:"string"}],required:!0}},{type:"string",name:"interface",interface:"input",uiSchema:{title:`{{t("Field interface", { ns: "${K}" })}}`,type:"string","x-component":"Select",enum:"{{interfaces}}"}},{type:"string",name:"title",interface:"input",uiSchema:{title:'{{ t("Field display name") }}',type:"string","x-component":"Input",required:!0}},{type:"string",name:"name",interface:"input",uiSchema:{title:'{{ t("Field name") }}',type:"string","x-component":"Input"}},{type:"string",name:"description",interface:"input",uiSchema:{title:'{{ t("Description") }}',type:"string","x-component":"Input.TextArea"}}]},sn={type:"object",properties:{[V.uid()]:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action","x-visible":!1,"x-component-props":{useAction:"{{ useBulkDestroyActionAndRefreshCM }}",confirm:{title:"{{t('Delete record')}}",content:"{{t('Are you sure you want to delete it?')}}"}}},syncfromDatabase:{type:"void",title:'{{ t("Sync from database") }}',"x-component":"SyncFieldsAction","x-component-props":{type:"primary"}},syncSQL:{type:"void",title:'{{ t("Sync from database") }}',"x-component":"SyncSQLFieldsAction","x-component-props":{type:"primary"}},create:{type:"void",title:'{{ t("Add new") }}',"x-component":"AddCollectionField","x-component-props":{type:"primary"}}}},[V.uid()]:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{pagination:!1,rowKey:"name",rowSelection:{type:"checkbox"},dragSort:!1,useDataSource:"{{ useDataSource }}"},properties:{column1:{type:"void",title:'{{ t("Field display name") }}',"x-component":"Table.Column",properties:{"uiSchema.title":{type:"string","x-component":"FieldTitleInput","x-component-props":{handleFieldChange:"{{enqueueChange}}"}}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{name:{"x-component":"CollectionField","x-read-pretty":!0}}},column3:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:'{{t("Field type")}}',properties:{type:{"x-component":"FieldType","x-component-props":{handleFieldChange:"{{enqueueChange}}"}}}},column4:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:`{{t("Field interface", { ns: "${K}" })}}`,properties:{interface:{"x-component":"CollectionFieldInterfaceSelect","x-component-props":{handleFieldChange:"{{enqueueChange}}"}}}},column5:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:'{{t("Title field")}}',properties:{titleField:{"x-component":"TitleField","x-use-component-props":"useTitleFieldProps","x-read-pretty":!1}}},column6:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:'{{ t("Description") }}',properties:{description:{"x-component":"CollectionField","x-read-pretty":!0,"x-component-props":{ellipsis:!0,style:{width:100}}}}},column7:{type:"void",title:'{{ t("Actions") }}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{update:{type:"void",title:'{{ t("Edit") }}',"x-component":"EditCollectionField","x-component-props":{role:"button","aria-label":'{{ "edit-button-" + $record.name }}',type:"primary"}},delete:{type:"void",title:'{{ t("Delete") }}',"x-disabled":"{{cm.useDeleteButtonDisabled()}}","x-component":"Action.Link","x-component-props":{confirm:{title:"{{t('Delete record')}}",content:"{{t('Are you sure you want to delete it?')}}"},useAction:"{{ useDestroyActionAndRefreshCM }}"},"x-reactions":[{dependencies:[".interface"],fulfill:{state:{visible:"{{ ['obo','oho','m2m','o2m','m2o'].includes($deps[0]) }}"}}}]}}}}}}}}},cn=r.withDynamicSchemaProps(e=>{const{t}=B.useTranslation(),{isTitleField:o}=r.useCollectionManager_deprecated(),[n,i]=d.useState(null),{setTitleField:a,filterByTk:c,dataSourceKey:l}=r.useProps(e),p=r.useRecord(),u=r.useAPIClient(),{refreshRM:m,titleField:y}=lt(),C=F=>O(this,null,function*(){i(p),yield u.request({url:`dataSources/${l}/collections:update?filterByTk=${c}`,method:"post",data:{titleField:F?p.name:"id"}}),S.message.success(t("Saved successfully")),m(),a(F?p.name:"id"),i(null)});return o(p)?s.jsx(S.Tooltip,{title:t("Default title for each record"),placement:"right",overlayInnerStyle:{textAlign:"center"},children:s.jsx(S.Switch,{"aria-label":`switch-title-field-${p==null?void 0:p.name}`,size:"small",loading:(p==null?void 0:p.name)===(n==null?void 0:n.name),checked:(p==null?void 0:p.name)===(y||"id"),onChange:C})}):null},{displayName:"TitleField"}),bt=(e,t)=>{const o=[];return e.forEach(n=>{const i=n.children.filter(a=>{var c;return(c=a==null?void 0:a.availableTypes)==null?void 0:c.includes(t)});o.push({label:n.label,key:n.key,children:i})}),o.filter(n=>t==="sort"?n.key==="advanced":n.children.length>0)},ln=(e,t)=>t==null?void 0:t.some(o=>{var n,i;return(i=(n=o.children)==null?void 0:n.some)==null?void 0:i.call(n,a=>a.name===e)}),un=_.observer(e=>{var F;const{value:t,handleFieldChange:o}=e,{data:n}=r.useCollectionRecord(),{getInterface:i}=r.useCollectionManager_deprecated(),a=r.useCompile(),c=r.useFieldInterfaceOptions(),l=bt(c,n.type),[p,u]=d.useState(t),[m,y]=d.useState(l),C=n.type;return d.useEffect(()=>{var A,v,b,f,g,h,$,D,P,j,I,E;if(m.length===1&&((v=(A=m[0])==null?void 0:A.children)==null?void 0:v.length)===1){const x=(g=(f=(b=m[0])==null?void 0:b.children)==null?void 0:f[0])==null?void 0:g.name;if(x!==p){const M=i(x);o({interface:x,uiSchema:T({title:(h=n==null?void 0:n.uiSchema)==null?void 0:h.title},($=M==null?void 0:M.default)==null?void 0:$.uiSchema)},n.name,!1),u(x)}}else if(p&&!ln(p,m)){const x=(j=(P=(D=m[0])==null?void 0:D.children)==null?void 0:P[0])==null?void 0:j.name,M=i(x);o({interface:x,uiSchema:T({title:(I=n==null?void 0:n.uiSchema)==null?void 0:I.title},(E=M==null?void 0:M.default)==null?void 0:E.uiSchema)},n.name,!1),u(x)}},[m]),d.useEffect(()=>{if(n!=null&&n.possibleTypes){const A=bt(c,C);y(A)}},[C]),["oho","obo","o2m","m2o","m2m"].includes(n.interface)?s.jsx(S.Tag,{children:a((F=c.find(A=>A.key==="relation").children.find(A=>A.name===t))==null?void 0:F.label)},t):s.jsx(S.Select,{"aria-label":`field-interface-${n==null?void 0:n.type}`,role:"button",value:p,style:{width:"100%"},popupMatchSelectWidth:!1,onChange:A=>{var b,f;const v=i(A);o({interface:A,uiSchema:T({title:(b=n==null?void 0:n.uiSchema)==null?void 0:b.title},(f=v==null?void 0:v.default)==null?void 0:f.uiSchema)},n.name),u(A)},children:m.map(A=>s.jsx(S.Select.OptGroup,{label:a(A.label),children:A.children.map(v=>s.jsx(S.Select.Option,{value:v.name,children:a(v.label)},v.name))},A.key))})},{displayName:"CollectionFieldInterfaceSelect"}),Te=["string","bigInt","integer","uuid","uid"],pn=_.observer(e=>{var u,m;const{name:t}=q.useParams(),{collectionName:o,sourceKey:n,name:i}=r.useRecord(),a=_.useField(),c=r.useCompile(),{getCollection:l}=r.useCollectionManager_deprecated(),p=(u=l(o||i,t).fields)==null?void 0:u.filter(y=>y.primaryKey||y.unique).map(y=>{var C;return{value:y.name,label:c(((C=y.uiSchema)==null?void 0:C.title)||y.title||y.name)}});return d.useEffect(()=>{var y;a.initialValue=((y=p==null?void 0:p[0])==null?void 0:y.value)||n},[]),s.jsx("div",{children:s.jsx(S.Select,{disabled:n,options:p,defaultValue:((m=p==null?void 0:p[0])==null?void 0:m.value)||n,onChange:e==null?void 0:e.onChange,showSearch:!0})})},{displayName:"SourceKey"}),xt=_.observer(e=>{const{disabled:t}=e,o=r.useAPIClient(),[n,i]=d.useState([]),{name:a}=q.useParams(),c=r.useRecord(),l=_.useField(),{collectionName:p,target:u,type:m,through:y,name:C}=c,F=c[l.props.name],{getCollection:A}=r.useCollectionManager_deprecated(),v=r.useCompile(),b=_.useForm(),[f,g]=d.useState(F);return d.useEffect(()=>{var D;l.initialValue=null;const h=["belongsTo"].includes(m)?p:["belongsToMany"].includes(m)?y:u,$=(D=A(h,a))==null?void 0:D.fields;if($){const P=$==null?void 0:$.filter(j=>Te.includes(j.type)).map(j=>{var I;return{value:j.name,label:v(((I=j.uiSchema)==null?void 0:I.title)||j.title||j.name)}});if(i(P),F){const j=P.find(I=>I.value===F);g((j==null?void 0:j.label)||F)}}},[m]),d.useEffect(()=>{g(F)},[F]),s.jsx("div",{children:s.jsx(S.Select,{disabled:t,value:f,options:n,showSearch:!0,onDropdownVisibleChange:h=>O(this,null,function*(){var I;const{target:$,type:D,through:P}=b.values,j=["belongsTo"].includes(D)?p||C:["belongsToMany"].includes(D)?P:$;if(j&&h){const{data:E}=yield o.request({url:`dataSourcesCollections/${a}.${j}/fields:list`,params:{paginate:!1,filter:{$or:[{"interface.$not":null},{"options.source.$notEmpty":!0}]},sort:["sort"]}});i((I=E.data)==null?void 0:I.filter(x=>Te.includes(x.type)).map(x=>{var M;return{value:x.name,label:v(((M=x.uiSchema)==null?void 0:M.title)||x.title||x.name)}}))}}),onChange:h=>{var $;($=e==null?void 0:e.onChange)==null||$.call(e,h),g(h)}})})},{displayName:"ForeignKey"}),dn=_.observer(e=>{const{value:t,disabled:o}=e,{targetKey:n,target:i,type:a}=r.useRecord(),{name:c}=q.useParams(),{getCollection:l}=r.useCollectionManager_deprecated(),p=r.useAPIClient(),[u,m]=d.useState([]),[y,C]=d.useState(t||n),F=_.useForm(),A=r.useCompile(),v=_.useField();return v.required=!0,d.useEffect(()=>{var b;i&&m((b=l(i,c).fields)==null?void 0:b.filter(f=>a!=="hasMany"?f.primaryKey||f.unique:Te.includes(f.type)).map(f=>{var g;return{value:f.name,label:A(((g=f==null?void 0:f.uiSchema)==null?void 0:g.title)||f.title||f.name)}}))},[]),s.jsx("div",{children:s.jsx(S.Select,{showSearch:!0,options:u,onDropdownVisibleChange:b=>O(this,null,function*(){var h;const{target:f,type:g}=F.values;if(f&&b){const{data:$}=yield p.request({url:`dataSourcesCollections/${c}.${f}/fields:list`,params:{paginate:!1,filter:{$or:[{"interface.$not":null},{"options.source.$notEmpty":!0}]},sort:["sort"]}});m((h=$.data)==null?void 0:h.filter(D=>g!=="hasMany"?D.primaryKey||D.unique:Te.includes(D.type)).map(D=>{var P;return{value:D.name,label:A(((P=D.uiSchema)==null?void 0:P.title)||D.title||D.name)}}))}}),onChange:b=>{var f;(f=e==null?void 0:e.onChange)==null||f.call(e,b),C(b)},value:y,disabled:o})})},{displayName:"TargetKey"}),mn=_.observer(()=>{const e=r.useCompile(),{targetCollection:t}=lt();return s.jsx("div",{children:s.jsx(S.Select,{disabled:!0,showSearch:!0,popupMatchSelectWidth:!1,value:t.name,options:[{value:t.name,label:e(t.title||t.name)}]})})},{displayName:"SourceCollection"}),yn=_.observer(e=>{const{disabled:t}=e,o=r.useCompile(),[n,i]=d.useState([]),{name:a}=q.useParams(),c=_.useField(),{getCollections:l}=r.useCollectionManager_deprecated(a),u=r.useRecord()[c.props.name],m=()=>l().filter(C=>!(C.autoCreate&&C.isThrough)).map(C=>({label:o(C.title||C.name),value:C.name}));return d.useEffect(()=>{const y=m();i(y)},[]),s.jsx("div",{children:s.jsx(S.Select,{disabled:t,showSearch:!0,popupMatchSelectWidth:!1,fieldNames:{label:"label",value:"value"},defaultValue:u,options:n,onChange:y=>{var C;(C=e==null?void 0:e.onChange)==null||C.call(e,y)}})})},{displayName:"ThroughCollection"}),fn=(e,t,o)=>{var a;if(!e)return;const n=X.cloneDeep(e.properties);n!=null&&n.foreignKey&&(n.foreignKey["x-component"]=xt),e.hasDefaultValue===!0&&(n.defaultValue=X.cloneDeep((a=e==null?void 0:e.default)==null?void 0:a.uiSchema),n.defaultValue.required=!1,n.defaultValue.title=o('{{ t("Default value") }}'),n.defaultValue["x-decorator"]="FormItem",n.defaultValue["x-reactions"]={dependencies:["uiSchema.x-component-props.gmt","uiSchema.x-component-props.showTime","uiSchema.x-component-props.dateFormat","uiSchema.x-component-props.timeFormat"],fulfill:{state:{componentProps:{gmt:"{{$deps[0]}}",showTime:"{{$deps[1]}}",dateFormat:"{{$deps[2]}}",timeFormat:"{{$deps[3]}}"}}}});const i=N(T({name:`f_${V.uid()}`},X.cloneDeep(e.default)),{interface:e.name});return i.reverseField&&(i.reverseField.name=`f_${V.uid()}`),{type:"object",properties:{[V.uid()]:{type:"void","x-component":"Action.Drawer","x-component-props":{getContainer:"{{ getContainer }}"},"x-decorator":"Form","x-decorator-props":{useValues(c){return r.useRequest(()=>Promise.resolve({data:i}),c)}},title:`${o(t.title||t.name)} - ${o('{{ t("Add field") }}')}`,properties:N(T({summary:{type:"void","x-component":"FieldSummary","x-component-props":{schemaKey:e.name}}},n),{description:{type:"string",title:'{{t("Description")}}',"x-decorator":"FormItem","x-component":"Input.TextArea"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{action1:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ useCancelAction }}"}},action2:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useCreateCollectionField }}"}}}}})}}}},gn=()=>{const e=_.useForm(),t=r.useActionContext(),{refresh:o}=r.useResourceActionContext(),n=_.useField(),i=r.useAPIClient(),a=r.useRecord(),{name:c}=q.useParams(),l=r.useDataSourceManager();return{run(){return O(this,null,function*(){yield e.submit(),n.data=n.data||{},n.data.loading=!0;const u=X.cloneDeep(e.values);u.autoCreateReverseField||delete u.reverseField,delete u.autoCreateReverseField;try{yield i.request({url:`dataSourcesCollections/${c}.${a.name}/fields:create`,method:"post",data:u}),t.setVisible(!1),l.getDataSource(c).reload(),yield e.reset(),n.data.loading=!1,o()}catch(m){n.data.loading=!1}})}}},hn=e=>{const t=r.useRecord();return s.jsx(Cn,T({item:t},e))},Cn=e=>{const{scope:t,getContainer:o,item:n,children:i,trigger:a,align:c,database:l}=e,{getInterface:p,getTemplate:u,collections:m}=r.useCollectionManager_deprecated(),[y,C]=d.useState(!1),[F,A]=d.useState(),[v,b]=d.useState({}),f=r.useCompile(),{t:g}=B.useTranslation(),{data:{database:h}}=r.useCurrentAppInfo(),$=x=>(h==null?void 0:h.dialect)===x,D=d.useMemo(()=>m.map(x=>({label:f(x.title),value:x.name})),[]),P=r.useFieldInterfaceOptions(),j=d.useCallback(()=>{const{availableFieldInterfaces:x}=u(n.template)||{},{exclude:M,include:w}=x||{},U=[];return P.forEach(z=>{var H;if(z.key==="relation"){let W=[];w!=null&&w.length?w.forEach(J=>{var Q;const ee=(Q=z==null?void 0:z.children)==null?void 0:Q.find(Ho=>[J,J.interface].includes(Ho.value));ee&&W.push(N(T({},ee),{targetScope:J==null?void 0:J.targetScope}))}):M!=null&&M.length?W=(H=z==null?void 0:z.children)==null?void 0:H.filter(J=>!M.includes(J.value)):W=z==null?void 0:z.children,W!=null&&W.length&&U.push(N(T({},z),{children:W}))}}),U},[u,n]),I=d.useMemo(()=>j().map(x=>{var M;return((M=x==null?void 0:x.children)==null?void 0:M.length)===0?null:n.template==="view"?{type:"group",label:f(x.label),title:f(x.label),key:x.label,children:x.children.filter(w=>["m2o"].includes(w.name)).map(w=>({label:f(w.title),title:f(w.title),key:w.name,dataTargetScope:w.targetScope}))}:{type:"group",label:f(x.label),title:f(x.label),key:x.label,children:x==null?void 0:x.children.filter(w=>!["o2o","subTable","linkTo"].includes(w.name)).map(w=>({label:f(w.title),title:f(w.title),key:w.name,dataTargetScope:w.targetScope}))}}).filter(x=>{var M;return(M=x==null?void 0:x.children)==null?void 0:M.length}),[j]),E=d.useMemo(()=>({style:{maxHeight:"60vh",overflow:"auto"},onClick:x=>{const M=x.item.props["data-targetScope"];M&&A(M);const w=fn(p(x.key),n,f);w&&(b(w),C(!0))},items:I}),[p,I,n]);return n.template!=="sql"&&s.jsx(r.RecordProvider,{record:n,children:s.jsxs(r.ActionContextProvider,{value:{visible:y,setVisible:C},children:[s.jsx(S.Dropdown,{getPopupContainer:o,trigger:a,align:c,menu:E,children:i||s.jsx(S.Button,{icon:s.jsx(Z.PlusOutlined,{}),type:"primary",children:g("Add field")})}),s.jsx(r.SchemaComponent,{schema:v,components:{ArrayTable:se.ArrayTable},scope:T({getContainer:o,useCancelAction:r.useCancelAction,createOnly:!0,isOverride:!1,override:!1,useCreateCollectionField:gn,record:n,showReverseFieldConfig:!1,targetScope:F,collections:D,isDialect:$,disabledJSONB:!1,createMainOnly:!0},t)})]})})},vn=_.observer(e=>{const{value:t,handleFieldChange:o}=e,n=r.useRecord(),[i,a]=d.useState(t),c=u=>{a(u)},l=d.useMemo(()=>X.debounce(u=>{o({uiSchema:N(T({},n==null?void 0:n.uiSchema),{title:u})},n.name)},1e3),[o,n]),p=u=>{const m=u.target.value;c(m),l(m)};return d.useEffect(()=>{a(t)},[t]),s.jsx(S.Input,{value:i,onChange:p,style:{minWidth:"100px"},"aria-label":"field-title-input"})},{displayName:"FieldTitleInput"}),bn=()=>{const{refresh:e}=r.useResourceActionContext(),{name:t}=q.useParams(),{name:o,collectionName:n}=r.useRecord(),i=r.useAPIClient();return{run(){return O(this,null,function*(){yield i.request({url:`dataSourcesCollections/${t}.${n}/fields:destroy?filterByTk=${o}`,method:"post"}),e()})}}},xn=()=>{const{state:e,setState:t,refresh:o}=r.useResourceActionContext(),{t:n}=B.useTranslation(),{name:i}=q.useParams(),a=r.useAPIClient(),{name:c}=r.useRecord();return{run(){return O(this,null,function*(){var p;if(!((p=e==null?void 0:e.selectedRowKeys)!=null&&p.length))return S.message.error(n("Please select the records you want to delete"));yield a.request({url:`dataSourcesCollections/${i}.${c}/fields:destroy`,method:"post",params:{filterByTk:(e==null?void 0:e.selectedRowKeys)||[]}}),t==null||t({selectedRowKeys:[]}),o()})}}},Sn=()=>{const{run:e}=xn();return{run(){return O(this,null,function*(){yield e()})}}},An=()=>{const{run:e}=bn();return{run(){return O(this,null,function*(){yield e()})}}};var Fe=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function we(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function $n(){this.__data__=[],this.size=0}var Tn=$n;function Fn(e,t){return e===t||e!==e&&t!==t}var St=Fn,wn=St;function _n(e,t){for(var o=e.length;o--;)if(wn(e[o][0],t))return o;return-1}var _e=_n,Pn=_e,Dn=Array.prototype,In=Dn.splice;function On(e){var t=this.__data__,o=Pn(t,e);if(o<0)return!1;var n=t.length-1;return o==n?t.pop():In.call(t,o,1),--this.size,!0}var Mn=On,kn=_e;function En(e){var t=this.__data__,o=kn(t,e);return o<0?void 0:t[o][1]}var jn=En,Kn=_e;function Nn(e){return Kn(this.__data__,e)>-1}var Bn=Nn,Vn=_e;function Ln(e,t){var o=this.__data__,n=Vn(o,e);return n<0?(++this.size,o.push([e,t])):o[n][1]=t,this}var qn=Ln,Gn=Tn,Un=Mn,zn=jn,Hn=Bn,Wn=qn;function ie(e){var t=-1,o=e==null?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}ie.prototype.clear=Gn,ie.prototype.delete=Un,ie.prototype.get=zn,ie.prototype.has=Hn,ie.prototype.set=Wn;var Pe=ie,Qn=Pe;function Yn(){this.__data__=new Qn,this.size=0}var Jn=Yn;function Zn(e){var t=this.__data__,o=t.delete(e);return this.size=t.size,o}var Xn=Zn;function Rn(e){return this.__data__.get(e)}var er=Rn;function tr(e){return this.__data__.has(e)}var or=tr,nr=typeof Fe=="object"&&Fe&&Fe.Object===Object&&Fe,At=nr,rr=At,ar=typeof self=="object"&&self&&self.Object===Object&&self,sr=rr||ar||Function("return this")(),R=sr,ir=R,cr=ir.Symbol,he=cr,$t=he,Tt=Object.prototype,lr=Tt.hasOwnProperty,ur=Tt.toString,Ce=$t?$t.toStringTag:void 0;function pr(e){var t=lr.call(e,Ce),o=e[Ce];try{e[Ce]=void 0;var n=!0}catch(a){}var i=ur.call(e);return n&&(t?e[Ce]=o:delete e[Ce]),i}var dr=pr,mr=Object.prototype,yr=mr.toString;function fr(e){return yr.call(e)}var gr=fr,Ft=he,hr=dr,Cr=gr,vr="[object Null]",br="[object Undefined]",wt=Ft?Ft.toStringTag:void 0;function xr(e){return e==null?e===void 0?br:vr:wt&&wt in Object(e)?hr(e):Cr(e)}var ce=xr;function Sr(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var le=Sr,Ar=ce,$r=le,Tr="[object AsyncFunction]",Fr="[object Function]",wr="[object GeneratorFunction]",_r="[object Proxy]";function Pr(e){if(!$r(e))return!1;var t=Ar(e);return t==Fr||t==wr||t==Tr||t==_r}var _t=Pr,Dr=R,Ir=Dr["__core-js_shared__"],Or=Ir,Le=Or,Pt=function(){var e=/[^.]+$/.exec(Le&&Le.keys&&Le.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function Mr(e){return!!Pt&&Pt in e}var kr=Mr,Er=Function.prototype,jr=Er.toString;function Kr(e){if(e!=null){try{return jr.call(e)}catch(t){}try{return e+""}catch(t){}}return""}var Dt=Kr,Nr=_t,Br=kr,Vr=le,Lr=Dt,qr=/[\\^$.*+?()[\]{}|]/g,Gr=/^\[object .+?Constructor\]$/,Ur=Function.prototype,zr=Object.prototype,Hr=Ur.toString,Wr=zr.hasOwnProperty,Qr=RegExp("^"+Hr.call(Wr).replace(qr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Yr(e){if(!Vr(e)||Br(e))return!1;var t=Nr(e)?Qr:Gr;return t.test(Lr(e))}var Jr=Yr;function Zr(e,t){return e==null?void 0:e[t]}var Xr=Zr,Rr=Jr,ea=Xr;function ta(e,t){var o=ea(e,t);return Rr(o)?o:void 0}var oe=ta,oa=oe,na=R,ra=oa(na,"Map"),qe=ra,aa=oe,sa=aa(Object,"create"),De=sa,It=De;function ia(){this.__data__=It?It(null):{},this.size=0}var ca=ia;function la(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var ua=la,pa=De,da="__lodash_hash_undefined__",ma=Object.prototype,ya=ma.hasOwnProperty;function fa(e){var t=this.__data__;if(pa){var o=t[e];return o===da?void 0:o}return ya.call(t,e)?t[e]:void 0}var ga=fa,ha=De,Ca=Object.prototype,va=Ca.hasOwnProperty;function ba(e){var t=this.__data__;return ha?t[e]!==void 0:va.call(t,e)}var xa=ba,Sa=De,Aa="__lodash_hash_undefined__";function $a(e,t){var o=this.__data__;return this.size+=this.has(e)?0:1,o[e]=Sa&&t===void 0?Aa:t,this}var Ta=$a,Fa=ca,wa=ua,_a=ga,Pa=xa,Da=Ta;function ue(e){var t=-1,o=e==null?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}ue.prototype.clear=Fa,ue.prototype.delete=wa,ue.prototype.get=_a,ue.prototype.has=Pa,ue.prototype.set=Da;var Ia=ue,Ot=Ia,Oa=Pe,Ma=qe;function ka(){this.size=0,this.__data__={hash:new Ot,map:new(Ma||Oa),string:new Ot}}var Ea=ka;function ja(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}var Ka=ja,Na=Ka;function Ba(e,t){var o=e.__data__;return Na(t)?o[typeof t=="string"?"string":"hash"]:o.map}var Ie=Ba,Va=Ie;function La(e){var t=Va(this,e).delete(e);return this.size-=t?1:0,t}var qa=La,Ga=Ie;function Ua(e){return Ga(this,e).get(e)}var za=Ua,Ha=Ie;function Wa(e){return Ha(this,e).has(e)}var Qa=Wa,Ya=Ie;function Ja(e,t){var o=Ya(this,e),n=o.size;return o.set(e,t),this.size+=o.size==n?0:1,this}var Za=Ja,Xa=Ea,Ra=qa,es=za,ts=Qa,os=Za;function pe(e){var t=-1,o=e==null?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}pe.prototype.clear=Xa,pe.prototype.delete=Ra,pe.prototype.get=es,pe.prototype.has=ts,pe.prototype.set=os;var Mt=pe,ns=Pe,rs=qe,as=Mt,ss=200;function is(e,t){var o=this.__data__;if(o instanceof ns){var n=o.__data__;if(!rs||n.length<ss-1)return n.push([e,t]),this.size=++o.size,this;o=this.__data__=new as(n)}return o.set(e,t),this.size=o.size,this}var cs=is,ls=Pe,us=Jn,ps=Xn,ds=er,ms=or,ys=cs;function de(e){var t=this.__data__=new ls(e);this.size=t.size}de.prototype.clear=us,de.prototype.delete=ps,de.prototype.get=ds,de.prototype.has=ms,de.prototype.set=ys;var fs=de;function gs(e,t){for(var o=-1,n=e==null?0:e.length;++o<n&&t(e[o],o,e)!==!1;);return e}var hs=gs,Cs=oe,vs=function(){try{var e=Cs(Object,"defineProperty");return e({},"",{}),e}catch(t){}}(),kt=vs,Et=kt;function bs(e,t,o){t=="__proto__"&&Et?Et(e,t,{configurable:!0,enumerable:!0,value:o,writable:!0}):e[t]=o}var jt=bs,xs=jt,Ss=St,As=Object.prototype,$s=As.hasOwnProperty;function Ts(e,t,o){var n=e[t];(!($s.call(e,t)&&Ss(n,o))||o===void 0&&!(t in e))&&xs(e,t,o)}var Ge=Ts,Fs=Ge,ws=jt;function _s(e,t,o,n){var i=!o;o||(o={});for(var a=-1,c=t.length;++a<c;){var l=t[a],p=n?n(o[l],e[l],l,o,e):void 0;p===void 0&&(p=e[l]),i?ws(o,l,p):Fs(o,l,p)}return o}var ve=_s;function Ps(e,t){for(var o=-1,n=Array(e);++o<e;)n[o]=t(o);return n}var Ds=Ps;function Is(e){return e!=null&&typeof e=="object"}var ne=Is,Os=ce,Ms=ne,ks="[object Arguments]";function Es(e){return Ms(e)&&Os(e)==ks}var js=Es,Kt=js,Ks=ne,Nt=Object.prototype,Ns=Nt.hasOwnProperty,Bs=Nt.propertyIsEnumerable,Vs=Kt(function(){return arguments}())?Kt:function(e){return Ks(e)&&Ns.call(e,"callee")&&!Bs.call(e,"callee")},Bt=Vs,Ls=Array.isArray,re=Ls,Oe={exports:{}};function qs(){return!1}var Gs=qs;Oe.exports,function(e,t){var o=R,n=Gs,i=t&&!t.nodeType&&t,a=i&&!0&&e&&!e.nodeType&&e,c=a&&a.exports===i,l=c?o.Buffer:void 0,p=l?l.isBuffer:void 0,u=p||n;e.exports=u}(Oe,Oe.exports);var Vt=Oe.exports,Us=9007199254740991,zs=/^(?:0|[1-9]\d*)$/;function Hs(e,t){var o=typeof e;return t=t==null?Us:t,!!t&&(o=="number"||o!="symbol"&&zs.test(e))&&e>-1&&e%1==0&&e<t}var Lt=Hs,Ws=9007199254740991;function Qs(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=Ws}var qt=Qs,Ys=ce,Js=qt,Zs=ne,Xs="[object Arguments]",Rs="[object Array]",ei="[object Boolean]",ti="[object Date]",oi="[object Error]",ni="[object Function]",ri="[object Map]",ai="[object Number]",si="[object Object]",ii="[object RegExp]",ci="[object Set]",li="[object String]",ui="[object WeakMap]",pi="[object ArrayBuffer]",di="[object DataView]",mi="[object Float32Array]",yi="[object Float64Array]",fi="[object Int8Array]",gi="[object Int16Array]",hi="[object Int32Array]",Ci="[object Uint8Array]",vi="[object Uint8ClampedArray]",bi="[object Uint16Array]",xi="[object Uint32Array]",G={};G[mi]=G[yi]=G[fi]=G[gi]=G[hi]=G[Ci]=G[vi]=G[bi]=G[xi]=!0,G[Xs]=G[Rs]=G[pi]=G[ei]=G[di]=G[ti]=G[oi]=G[ni]=G[ri]=G[ai]=G[si]=G[ii]=G[ci]=G[li]=G[ui]=!1;function Si(e){return Zs(e)&&Js(e.length)&&!!G[Ys(e)]}var Ai=Si;function $i(e){return function(t){return e(t)}}var Ue=$i,Me={exports:{}};Me.exports,function(e,t){var o=At,n=t&&!t.nodeType&&t,i=n&&!0&&e&&!e.nodeType&&e,a=i&&i.exports===n,c=a&&o.process,l=function(){try{var p=i&&i.require&&i.require("util").types;return p||c&&c.binding&&c.binding("util")}catch(u){}}();e.exports=l}(Me,Me.exports);var ze=Me.exports,Ti=Ai,Fi=Ue,Gt=ze,Ut=Gt&&Gt.isTypedArray,wi=Ut?Fi(Ut):Ti,_i=wi,Pi=Ds,Di=Bt,Ii=re,Oi=Vt,Mi=Lt,ki=_i,Ei=Object.prototype,ji=Ei.hasOwnProperty;function Ki(e,t){var o=Ii(e),n=!o&&Di(e),i=!o&&!n&&Oi(e),a=!o&&!n&&!i&&ki(e),c=o||n||i||a,l=c?Pi(e.length,String):[],p=l.length;for(var u in e)(t||ji.call(e,u))&&!(c&&(u=="length"||i&&(u=="offset"||u=="parent")||a&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||Mi(u,p)))&&l.push(u);return l}var zt=Ki,Ni=Object.prototype;function Bi(e){var t=e&&e.constructor,o=typeof t=="function"&&t.prototype||Ni;return e===o}var He=Bi;function Vi(e,t){return function(o){return e(t(o))}}var Ht=Vi,Li=Ht,qi=Li(Object.keys,Object),Gi=qi,Ui=He,zi=Gi,Hi=Object.prototype,Wi=Hi.hasOwnProperty;function Qi(e){if(!Ui(e))return zi(e);var t=[];for(var o in Object(e))Wi.call(e,o)&&o!="constructor"&&t.push(o);return t}var Yi=Qi,Ji=_t,Zi=qt;function Xi(e){return e!=null&&Zi(e.length)&&!Ji(e)}var Wt=Xi,Ri=zt,ec=Yi,tc=Wt;function oc(e){return tc(e)?Ri(e):ec(e)}var We=oc,nc=ve,rc=We;function ac(e,t){return e&&nc(t,rc(t),e)}var sc=ac;function ic(e){var t=[];if(e!=null)for(var o in Object(e))t.push(o);return t}var cc=ic,lc=le,uc=He,pc=cc,dc=Object.prototype,mc=dc.hasOwnProperty;function yc(e){if(!lc(e))return pc(e);var t=uc(e),o=[];for(var n in e)n=="constructor"&&(t||!mc.call(e,n))||o.push(n);return o}var fc=yc,gc=zt,hc=fc,Cc=Wt;function vc(e){return Cc(e)?gc(e,!0):hc(e)}var Qe=vc,bc=ve,xc=Qe;function Sc(e,t){return e&&bc(t,xc(t),e)}var Ac=Sc,ke={exports:{}};ke.exports,function(e,t){var o=R,n=t&&!t.nodeType&&t,i=n&&!0&&e&&!e.nodeType&&e,a=i&&i.exports===n,c=a?o.Buffer:void 0,l=c?c.allocUnsafe:void 0;function p(u,m){if(m)return u.slice();var y=u.length,C=l?l(y):new u.constructor(y);return u.copy(C),C}e.exports=p}(ke,ke.exports);var $c=ke.exports;function Tc(e,t){var o=-1,n=e.length;for(t||(t=Array(n));++o<n;)t[o]=e[o];return t}var Fc=Tc;function wc(e,t){for(var o=-1,n=e==null?0:e.length,i=0,a=[];++o<n;){var c=e[o];t(c,o,e)&&(a[i++]=c)}return a}var _c=wc;function Pc(){return[]}var Qt=Pc,Dc=_c,Ic=Qt,Oc=Object.prototype,Mc=Oc.propertyIsEnumerable,Yt=Object.getOwnPropertySymbols,kc=Yt?function(e){return e==null?[]:(e=Object(e),Dc(Yt(e),function(t){return Mc.call(e,t)}))}:Ic,Ye=kc,Ec=ve,jc=Ye;function Kc(e,t){return Ec(e,jc(e),t)}var Nc=Kc;function Bc(e,t){for(var o=-1,n=t.length,i=e.length;++o<n;)e[i+o]=t[o];return e}var Je=Bc,Vc=Ht,Lc=Vc(Object.getPrototypeOf,Object),Ze=Lc,qc=Je,Gc=Ze,Uc=Ye,zc=Qt,Hc=Object.getOwnPropertySymbols,Wc=Hc?function(e){for(var t=[];e;)qc(t,Uc(e)),e=Gc(e);return t}:zc,Jt=Wc,Qc=ve,Yc=Jt;function Jc(e,t){return Qc(e,Yc(e),t)}var Zc=Jc,Xc=Je,Rc=re;function el(e,t,o){var n=t(e);return Rc(e)?n:Xc(n,o(e))}var Zt=el,tl=Zt,ol=Ye,nl=We;function rl(e){return tl(e,nl,ol)}var al=rl,sl=Zt,il=Jt,cl=Qe;function ll(e){return sl(e,cl,il)}var Xt=ll,ul=oe,pl=R,dl=ul(pl,"DataView"),ml=dl,yl=oe,fl=R,gl=yl(fl,"Promise"),hl=gl,Cl=oe,vl=R,bl=Cl(vl,"Set"),xl=bl,Sl=oe,Al=R,$l=Sl(Al,"WeakMap"),Tl=$l,Xe=ml,Re=qe,et=hl,tt=xl,ot=Tl,Rt=ce,me=Dt,eo="[object Map]",Fl="[object Object]",to="[object Promise]",oo="[object Set]",no="[object WeakMap]",ro="[object DataView]",wl=me(Xe),_l=me(Re),Pl=me(et),Dl=me(tt),Il=me(ot),ae=Rt;(Xe&&ae(new Xe(new ArrayBuffer(1)))!=ro||Re&&ae(new Re)!=eo||et&&ae(et.resolve())!=to||tt&&ae(new tt)!=oo||ot&&ae(new ot)!=no)&&(ae=function(e){var t=Rt(e),o=t==Fl?e.constructor:void 0,n=o?me(o):"";if(n)switch(n){case wl:return ro;case _l:return eo;case Pl:return to;case Dl:return oo;case Il:return no}return t});var nt=ae,Ol=Object.prototype,Ml=Ol.hasOwnProperty;function kl(e){var t=e.length,o=new e.constructor(t);return t&&typeof e[0]=="string"&&Ml.call(e,"index")&&(o.index=e.index,o.input=e.input),o}var El=kl,jl=R,Kl=jl.Uint8Array,Nl=Kl,ao=Nl;function Bl(e){var t=new e.constructor(e.byteLength);return new ao(t).set(new ao(e)),t}var rt=Bl,Vl=rt;function Ll(e,t){var o=t?Vl(e.buffer):e.buffer;return new e.constructor(o,e.byteOffset,e.byteLength)}var ql=Ll,Gl=/\w*$/;function Ul(e){var t=new e.constructor(e.source,Gl.exec(e));return t.lastIndex=e.lastIndex,t}var zl=Ul,so=he,io=so?so.prototype:void 0,co=io?io.valueOf:void 0;function Hl(e){return co?Object(co.call(e)):{}}var Wl=Hl,Ql=rt;function Yl(e,t){var o=t?Ql(e.buffer):e.buffer;return new e.constructor(o,e.byteOffset,e.length)}var Jl=Yl,Zl=rt,Xl=ql,Rl=zl,eu=Wl,tu=Jl,ou="[object Boolean]",nu="[object Date]",ru="[object Map]",au="[object Number]",su="[object RegExp]",iu="[object Set]",cu="[object String]",lu="[object Symbol]",uu="[object ArrayBuffer]",pu="[object DataView]",du="[object Float32Array]",mu="[object Float64Array]",yu="[object Int8Array]",fu="[object Int16Array]",gu="[object Int32Array]",hu="[object Uint8Array]",Cu="[object Uint8ClampedArray]",vu="[object Uint16Array]",bu="[object Uint32Array]";function xu(e,t,o){var n=e.constructor;switch(t){case uu:return Zl(e);case ou:case nu:return new n(+e);case pu:return Xl(e,o);case du:case mu:case yu:case fu:case gu:case hu:case Cu:case vu:case bu:return tu(e,o);case ru:return new n;case au:case cu:return new n(e);case su:return Rl(e);case iu:return new n;case lu:return eu(e)}}var Su=xu,Au=le,lo=Object.create,$u=function(){function e(){}return function(t){if(!Au(t))return{};if(lo)return lo(t);e.prototype=t;var o=new e;return e.prototype=void 0,o}}(),Tu=$u,Fu=Tu,wu=Ze,_u=He;function Pu(e){return typeof e.constructor=="function"&&!_u(e)?Fu(wu(e)):{}}var Du=Pu,Iu=nt,Ou=ne,Mu="[object Map]";function ku(e){return Ou(e)&&Iu(e)==Mu}var Eu=ku,ju=Eu,Ku=Ue,uo=ze,po=uo&&uo.isMap,Nu=po?Ku(po):ju,Bu=Nu,Vu=nt,Lu=ne,qu="[object Set]";function Gu(e){return Lu(e)&&Vu(e)==qu}var Uu=Gu,zu=Uu,Hu=Ue,mo=ze,yo=mo&&mo.isSet,Wu=yo?Hu(yo):zu,Qu=Wu,Yu=fs,Ju=hs,Zu=Ge,Xu=sc,Ru=Ac,ep=$c,tp=Fc,op=Nc,np=Zc,rp=al,ap=Xt,sp=nt,ip=El,cp=Su,lp=Du,up=re,pp=Vt,dp=Bu,mp=le,yp=Qu,fp=We,gp=Qe,hp=1,Cp=2,vp=4,fo="[object Arguments]",bp="[object Array]",xp="[object Boolean]",Sp="[object Date]",Ap="[object Error]",go="[object Function]",$p="[object GeneratorFunction]",Tp="[object Map]",Fp="[object Number]",ho="[object Object]",wp="[object RegExp]",_p="[object Set]",Pp="[object String]",Dp="[object Symbol]",Ip="[object WeakMap]",Op="[object ArrayBuffer]",Mp="[object DataView]",kp="[object Float32Array]",Ep="[object Float64Array]",jp="[object Int8Array]",Kp="[object Int16Array]",Np="[object Int32Array]",Bp="[object Uint8Array]",Vp="[object Uint8ClampedArray]",Lp="[object Uint16Array]",qp="[object Uint32Array]",L={};L[fo]=L[bp]=L[Op]=L[Mp]=L[xp]=L[Sp]=L[kp]=L[Ep]=L[jp]=L[Kp]=L[Np]=L[Tp]=L[Fp]=L[ho]=L[wp]=L[_p]=L[Pp]=L[Dp]=L[Bp]=L[Vp]=L[Lp]=L[qp]=!0,L[Ap]=L[go]=L[Ip]=!1;function Ee(e,t,o,n,i,a){var c,l=t&hp,p=t&Cp,u=t&vp;if(o&&(c=i?o(e,n,i,a):o(e)),c!==void 0)return c;if(!mp(e))return e;var m=up(e);if(m){if(c=ip(e),!l)return tp(e,c)}else{var y=sp(e),C=y==go||y==$p;if(pp(e))return ep(e,l);if(y==ho||y==fo||C&&!i){if(c=p||C?{}:lp(e),!l)return p?np(e,Ru(c,e)):op(e,Xu(c,e))}else{if(!L[y])return i?e:{};c=cp(e,y,l)}}a||(a=new Yu);var F=a.get(e);if(F)return F;a.set(e,c),yp(e)?e.forEach(function(b){c.add(Ee(b,t,o,b,e,a))}):dp(e)&&e.forEach(function(b,f){c.set(f,Ee(b,t,o,f,e,a))});var A=u?p?ap:rp:p?gp:fp,v=m?void 0:A(e);return Ju(v||e,function(b,f){v&&(f=b,b=e[f]),Zu(c,f,Ee(b,t,o,f,e,a))}),c}var Co=Ee,Gp=Co,Up=1,zp=4;function Hp(e){return Gp(e,Up|zp)}var Wp=Hp;const te=we(Wp);function Qp(e,t){for(var o=-1,n=e==null?0:e.length,i=Array(n);++o<n;)i[o]=t(e[o],o,e);return i}var vo=Qp,Yp=ce,Jp=ne,Zp="[object Symbol]";function Xp(e){return typeof e=="symbol"||Jp(e)&&Yp(e)==Zp}var at=Xp,Rp=re,ed=at,td=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,od=/^\w*$/;function nd(e,t){if(Rp(e))return!1;var o=typeof e;return o=="number"||o=="symbol"||o=="boolean"||e==null||ed(e)?!0:od.test(e)||!td.test(e)||t!=null&&e in Object(t)}var rd=nd,bo=Mt,ad="Expected a function";function st(e,t){if(typeof e!="function"||t!=null&&typeof t!="function")throw new TypeError(ad);var o=function(){var n=arguments,i=t?t.apply(this,n):n[0],a=o.cache;if(a.has(i))return a.get(i);var c=e.apply(this,n);return o.cache=a.set(i,c)||a,c};return o.cache=new(st.Cache||bo),o}st.Cache=bo;var sd=st,id=sd,cd=500;function ld(e){var t=id(e,function(n){return o.size===cd&&o.clear(),n}),o=t.cache;return t}var ud=ld,pd=ud,dd=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,md=/\\(\\)?/g,yd=pd(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(dd,function(o,n,i,a){t.push(i?a.replace(md,"$1"):n||o)}),t}),fd=yd,xo=he,gd=vo,hd=re,Cd=at,vd=1/0,So=xo?xo.prototype:void 0,Ao=So?So.toString:void 0;function $o(e){if(typeof e=="string")return e;if(hd(e))return gd(e,$o)+"";if(Cd(e))return Ao?Ao.call(e):"";var t=e+"";return t=="0"&&1/e==-vd?"-0":t}var bd=$o,xd=bd;function Sd(e){return e==null?"":xd(e)}var Ad=Sd,$d=re,Td=rd,Fd=fd,wd=Ad;function _d(e,t){return $d(e)?e:Td(e,t)?[e]:Fd(wd(e))}var je=_d;function Pd(e){var t=e==null?0:e.length;return t?e[t-1]:void 0}var Dd=Pd,Id=at,Od=1/0;function Md(e){if(typeof e=="string"||Id(e))return e;var t=e+"";return t=="0"&&1/e==-Od?"-0":t}var it=Md,kd=je,Ed=it;function jd(e,t){t=kd(t,e);for(var o=0,n=t.length;e!=null&&o<n;)e=e[Ed(t[o++])];return o&&o==n?e:void 0}var Kd=jd;function Nd(e,t,o){var n=-1,i=e.length;t<0&&(t=-t>i?0:i+t),o=o>i?i:o,o<0&&(o+=i),i=t>o?0:o-t>>>0,t>>>=0;for(var a=Array(i);++n<i;)a[n]=e[n+t];return a}var Bd=Nd,Vd=Kd,Ld=Bd;function qd(e,t){return t.length<2?e:Vd(e,Ld(t,0,-1))}var Gd=qd,Ud=je,zd=Dd,Hd=Gd,Wd=it;function Qd(e,t){return t=Ud(t,e),e=Hd(e,t),e==null||delete e[Wd(zd(t))]}var Yd=Qd,Jd=ce,Zd=Ze,Xd=ne,Rd="[object Object]",em=Function.prototype,tm=Object.prototype,To=em.toString,om=tm.hasOwnProperty,nm=To.call(Object);function rm(e){if(!Xd(e)||Jd(e)!=Rd)return!1;var t=Zd(e);if(t===null)return!0;var o=om.call(t,"constructor")&&t.constructor;return typeof o=="function"&&o instanceof o&&To.call(o)==nm}var am=rm,sm=am;function im(e){return sm(e)?void 0:e}var cm=im,Fo=he,lm=Bt,um=re,wo=Fo?Fo.isConcatSpreadable:void 0;function pm(e){return um(e)||lm(e)||!!(wo&&e&&e[wo])}var dm=pm,mm=Je,ym=dm;function _o(e,t,o,n,i){var a=-1,c=e.length;for(o||(o=ym),i||(i=[]);++a<c;){var l=e[a];t>0&&o(l)?t>1?_o(l,t-1,o,n,i):mm(i,l):n||(i[i.length]=l)}return i}var fm=_o,gm=fm;function hm(e){var t=e==null?0:e.length;return t?gm(e,1):[]}var Cm=hm;function vm(e,t,o){switch(o.length){case 0:return e.call(t);case 1:return e.call(t,o[0]);case 2:return e.call(t,o[0],o[1]);case 3:return e.call(t,o[0],o[1],o[2])}return e.apply(t,o)}var bm=vm,xm=bm,Po=Math.max;function Sm(e,t,o){return t=Po(t===void 0?e.length-1:t,0),function(){for(var n=arguments,i=-1,a=Po(n.length-t,0),c=Array(a);++i<a;)c[i]=n[t+i];i=-1;for(var l=Array(t+1);++i<t;)l[i]=n[i];return l[t]=o(c),xm(e,this,l)}}var Am=Sm;function $m(e){return function(){return e}}var Tm=$m;function Fm(e){return e}var wm=Fm,_m=Tm,Do=kt,Pm=wm,Dm=Do?function(e,t){return Do(e,"toString",{configurable:!0,enumerable:!1,value:_m(t),writable:!0})}:Pm,Im=Dm,Om=800,Mm=16,km=Date.now;function Em(e){var t=0,o=0;return function(){var n=km(),i=Mm-(n-o);if(o=n,i>0){if(++t>=Om)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}var jm=Em,Km=Im,Nm=jm,Bm=Nm(Km),Vm=Bm,Lm=Cm,qm=Am,Gm=Vm;function Um(e){return Gm(qm(e,void 0,Lm),e+"")}var zm=Um,Hm=vo,Wm=Co,Qm=Yd,Ym=je,Jm=ve,Zm=cm,Xm=zm,Rm=Xt,ey=1,ty=2,oy=4,ny=Xm(function(e,t){var o={};if(e==null)return o;var n=!1;t=Hm(t,function(a){return a=Ym(a,e),n||(n=a.length>1),a}),Jm(e,Rm(e),o),n&&(o=Wm(o,ey|ty|oy,Zm));for(var i=t.length;i--;)Qm(o,t[i]);return o}),ry=ny;const Ke=we(ry);var ay=Ge,sy=je,iy=Lt,Io=le,cy=it;function ly(e,t,o,n){if(!Io(e))return e;t=sy(t,e);for(var i=-1,a=t.length,c=a-1,l=e;l!=null&&++i<a;){var p=cy(t[i]),u=o;if(p==="__proto__"||p==="constructor"||p==="prototype")return e;if(i!=c){var m=l[p];u=n?n(m,p,l):void 0,u===void 0&&(u=Io(m)?m:iy(t[i+1])?[]:{})}ay(l,p,u),l=l[p]}return e}var uy=ly,py=uy;function dy(e,t,o){return e==null?e:py(e,t,o)}var my=dy;const Oo=we(my),yy=({schema:e,record:t,parentRecord:o,compile:n,getContainer:i})=>{if(!e)return;const a=te(e.properties);return a!=null&&a.name&&(a.name["x-disabled"]=!0),e.hasDefaultValue===!0&&(a.defaultValue=te(e.default.uiSchema)||{},a.defaultValue.required=!1,a.defaultValue.title=n('{{ t("Default value") }}'),a.defaultValue["x-decorator"]="FormItem",a.defaultValue["x-reactions"]={dependencies:["uiSchema.x-component-props.gmt","uiSchema.x-component-props.showTime","uiSchema.x-component-props.dateFormat","uiSchema.x-component-props.timeFormat"],fulfill:{state:{componentProps:{gmt:"{{$deps[0]}}",showTime:"{{$deps[1]}}",dateFormat:"{{$deps[2]}}",timeFormat:"{{$deps[3]}}"}}}},a.defaultValue["x-disabled"]=!0),{type:"object",properties:{[V.uid()]:{type:"void","x-component":"Action.Drawer","x-component-props":{getContainer:"{{ getContainer }}"},"x-decorator":"Form","x-decorator-props":{useValues(c){return r.useRequest(()=>{var l;return Promise.resolve({data:N(T({},te(Ke(e.default,["uiSchema.rawTitle"]))),{autoFill:((l=e.default)==null?void 0:l.autoFill)!==!1})})},c)}},title:`${n((o==null?void 0:o.title)||(o==null?void 0:o.name))} - ${n('{{ t("Edit field") }}')}`,properties:N(T({summary:{type:"void","x-component":"FieldSummary","x-component-props":{schemaKey:e.name}}},a),{description:{type:"string",title:'{{t("Description")}}',"x-decorator":"FormItem","x-component":"Input.TextArea"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{action1:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ useCancelAction }}"}},action2:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useUpdateCollectionField }}"}}}}})}}}},fy=()=>{const e=_.useForm(),t=r.useAPIClient(),o=r.useActionContext(),{refresh:n}=r.useResourceActionContext(),{targetCollection:i}=lt(),{name:a}=q.useParams(),{name:c}=r.useRecord(),l=r.useDataSourceManager();return{run(){return O(this,null,function*(){yield e.submit();const u=te(e.values);u.autoCreateReverseField||delete u.reverseField,delete u.autoCreateReverseField,yield t.request({url:`dataSourcesCollections/${a}.${i.name}/fields:update?filterByTk=${c}`,method:"post",data:u}),o.setVisible(!1),l.getDataSource(a).reload(),yield e.reset(),n()})}}},gy=e=>{const t=r.useRecord(),o=r.useCollectionParentRecordData();return s.jsx(hy,T({item:t,parentItem:o},e))},hy=e=>{var I,E;const j=e,{scope:t,getContainer:o,item:n,parentItem:i,children:a}=j,c=mt(j,["scope","getContainer","item","parentItem","children"]),{getInterface:l,collections:p,getCollection:u}=r.useCollectionManager_deprecated(),{data:{database:m}}=r.useCurrentAppInfo(),[y,C]=d.useState(!1),[F,A]=d.useState({}),v=r.useAPIClient(),{t:b}=B.useTranslation(),f=r.useCompile(),{name:g}=q.useParams(),h=x=>(m==null?void 0:m.dialect)===x,$=(n==null?void 0:n.fields)||((E=(I=u(n.collectionName,g))==null?void 0:I.options)==null?void 0:E.fields),D=d.useMemo(()=>p.map(x=>({label:f(x.title),value:x.name})),[]),P=d.useMemo(()=>{var x,M;return(n==null?void 0:n.fields)||((M=(x=u(n.collectionName,g))==null?void 0:x.options)==null?void 0:M.fields.filter(w=>["string","bigInt","integer"].includes(w.type)).map(w=>{var U;return{value:w.name,label:f((U=w.uiSchema)==null?void 0:U.title)}}))},[n.name,$]);return s.jsx(r.RecordProvider,{record:n,parent:i,children:s.jsxs(r.ActionContextProvider,{value:{visible:y,setVisible:C},children:[s.jsx("a",N(T({},c),{onClick:()=>O(this,null,function*(){var z,H,W;const{data:x}=yield v.request({url:`dataSourcesCollections/${g}.${i.name}/fields:get?filterByTk=${n.name}`,params:{appends:["reverseField"]}}),M=l((z=x==null?void 0:x.data)==null?void 0:z.interface),w=te(x==null?void 0:x.data)||{};w!=null&&w.reverseField||(w.autoCreateReverseField=!1,w.reverseField=(H=M==null?void 0:M.default)==null?void 0:H.reverseField,Oo(w.reverseField,"name",`f_${V.uid()}`),Oo(w.reverseField,"uiSchema.title",(W=n.__parent)==null?void 0:W.title));const U=yy({schema:N(T({},M),{default:w}),record:n,parentRecord:i,compile:f,getContainer:o});A(U),C(!0)}),children:a||b("Edit")})),s.jsx(r.SchemaComponent,{schema:F,components:{ArrayTable:se.ArrayTable},scope:N(T({getContainer:o,useUpdateCollectionField:fy,useCancelAction:r.useCancelAction,showReverseFieldConfig:!1,collections:D,isDialect:h,scopeKeyOptions:P,disabledJSONB:!0},t),{createOnly:!1,createMainOnly:!1,editMainOnly:!0})})]})})},Cy=_.observer(e=>{const{value:t,handleFieldChange:o,onChange:n}=e,i=r.useRecord(),a=i;return a!=null&&a.possibleTypes?s.jsx(S.Select,{"aria-label":`field-type-${t}`,role:"button",defaultValue:t,popupMatchSelectWidth:!1,style:{width:"100%"},options:(a==null?void 0:a.possibleTypes.map(c=>({label:c,value:c})))||[],onChange:c=>{n==null||n(c),o(N(T({},a),{type:c}),i.name)}}):s.jsx(S.Tag,{children:t})},{displayName:"FieldType"}),vy=()=>{const{t:e}=B.useTranslation(),{unsupportedFields:t}=r.useRecord(),o=[{title:e("Field name"),dataIndex:"name",key:"name"},{title:e("Field database type",{ns:K}),dataIndex:"rawType",key:"rawType"}];return(t==null?void 0:t.length)>0&&s.jsxs(s.Fragment,{children:[s.jsx(S.Divider,{plain:!0,orientation:"left",orientationMargin:"0",children:s.jsx("h3",{children:e("Unknown field type",{ns:K})})}),s.jsx("div",{style:{marginBottom:"15px"},children:e("The following field types are not compatible and do not support output and display",{ns:K})}),s.jsx(S.Table,{columns:o,dataSource:t,pagination:!1})]})},ct=d.createContext({refreshRM:()=>{},titleField:null,targetCollection:null});ct.displayName="RemoteCollectionContext";const lt=()=>d.useContext(ct),Mo=()=>{const e=_.useField(),t=d.useMemo(()=>fe.createForm(),[]),o=r.useAttach(t.createArrayField(N(T({},e.props),{basePath:""}))),{t:n}=B.useTranslation(),{name:i}=q.useParams(),a=r.useAPIClient(),c=r.useCompile(),l=d.useContext(r.ResourceActionContext),p=r.useResourceContext(),{targetKey:u}=p||{},m=r.useRecord(),{[u]:y,titleField:C,name:F}=m,[A,v]=d.useState(C),b=x=>{const M=d.useContext(r.ResourceActionContext),w=_.useField();return d.useEffect(()=>{M.loading||(x==null||x.onSuccess(M.data),w.componentProps.dragSort=!!M.dragSort)},[M.loading]),M},f={association:{sourceKey:"name",targetKey:"name"},dragSort:!1,collection:an,request:{url:`dataSourcesCollections/${i}.${F}/fields:list`,params:{paginate:!1,filter:{$or:[{"interface.$not":null},{"options.source.$notEmpty":!0}]},sort:["sort"]}}},g=r.useDataSourceManager();let h=!1;const $=[],D=()=>O(this,null,function*(){if(h||$.length===0)return;h=!0;const{value:x,filterByTk:M,flag:w}=$.shift();try{yield j(x,M,w)}catch(U){Ae.captureException(U)}finally{h=!1,D()}}),P=(x,M,w)=>{$.push({value:x,filterByTk:M,flag:w}),D()},j=(x,M,w=!0)=>O(this,null,function*(){yield a.request({url:`dataSourcesCollections/${i}.${F}/fields:update?filterByTk=${M}`,method:"post",data:x}),g.getDataSource(i).reload(),w&&S.message.success(n("Saved successfully"))}),I=()=>({filterByTk:y,titleField:A,dataSourceKey:i,setTitleField:v}),E=(x,M,w)=>O(this,null,function*(){var J,ee;const{targetScope:U}=M,z=((J=x.props)==null?void 0:J.name)==="inherits",{data:H}=yield a.request({url:`dataSources/${i}/collections:list`,params:{paginate:!1,appends:["fields"],sort:["sort"]}});return((ee=H==null?void 0:H.data)==null?void 0:ee.filter(Q=>{var Wo;if(w!=null&&w.includes(Q.template)||Q.autoCreate&&Q.isThrough||z&&Q.template==="view")return!1;const zf=!(U!=null&&U.template)||U.template.includes(Q.template),Hf=!(U!=null&&U[(Wo=x.props)==null?void 0:Wo.name])||U[x.props.name].includes(Q.name);return zf&&Hf})).map(Q=>({label:c(Q.title||Q.name),value:Q.name}))});return s.jsxs(ct.Provider,{value:{refreshRM:()=>{l.refresh()},titleField:A,targetCollection:m},children:[s.jsx(r.ResourceActionProvider,N(T({},f),{children:s.jsx(_.FormContext.Provider,{value:t,children:s.jsx(_.FieldContext.Provider,{value:o,children:s.jsx(r.SchemaComponentOptions,{components:{TitleField:cn,CollectionFieldInterfaceSelect:un,AddCollectionField:hn,SourceCollection:mn,TargetKey:dn,SourceKey:pn,FieldTitleInput:vn,EditCollectionField:gy,Select:r.Select,FieldType:Cy,ForeignKey:xt,ThroughCollection:yn},inherit:!0,scope:{useDataSource:b,useTitleFieldProps:I,enqueueChange:P,useDestroyActionAndRefreshCM:An,useBulkDestroyActionAndRefreshCM:Sn,loadCollections:E},children:s.jsx(_.RecursionField,{schema:sn,onlyRenderProperties:!0})})})})})),s.jsx(vy,{})]})},by=(e,t,o,n)=>{if(!e)return;const i=te(e.configurableProperties)||{title:{"x-component":"CollectionField","x-decorator":"FormItem"},name:{"x-component":"CollectionField","x-decorator":"FormItem"}};return e.hasDefaultValue===!0&&(i.defaultValue=te(e.default.uiSchema),i.defaultValue.title=o('{{ t("Default value") }}'),i.defaultValue["x-decorator"]="FormItem"),{type:"object",properties:{[V.uid()]:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:"{{ useValuesFromRecord }}"},title:'{{ t("Edit collection") }}',properties:N(T({},Ke(i,"category","inherits","moreOptions")),{filterTargetKey:{title:`{{ t("Filter target key",{ ns: "${K}" }) }}`,type:"single",description:r.tval("Filter data based on the specific field, with the requirement that the field value must be unique.",{ns:K}),"x-decorator":"FormItem","x-component":"Select",enum:"{{filterTargetKeyOptions}}","x-visible":"{{!!isView}}"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{action1:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ useCancelAction }}"}},action2:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useUpdateCollectionActionAndRefreshCM }}"}}}}})}}}},xy=e=>{const t=r.useRecord(),o=r.useRequest(()=>{var i;return Promise.resolve({data:N(T({},Ke(te(t),["__parent","__collectionName"])),{category:(i=t==null?void 0:t.category)==null?void 0:i.map(a=>a.id)})})},N(T({},e),{manual:!0})),n=r.useActionContext();return d.useEffect(()=>{n.visible&&o.run()},[n.visible]),o},Sy=e=>{const{refreshCM:t}=r.useCollectionManager_deprecated(),o=_.useForm(),n=r.useActionContext(),{name:i}=q.useParams(),{refresh:a}=r.useResourceActionContext(),{resource:c,targetKey:l}=r.useResourceContext(),{[l]:p}=r.useRecord(),u=r.useAPIClient(),m=r.useDataSourceManager();return{run(){return O(this,null,function*(){yield o.submit(),yield u.request({url:`dataSources/${i}/collections:update?filterByTk=${p}`,method:"post",data:T({},Ke(o.values,["fields","autoGenId","createdAt","updatedAt","createdBy","updatedBy","sortable"]))}),yield m.getDataSource(i).reload(),n.setVisible(!1),yield o.reset(),a(),yield t()})}}},Ay=e=>{const t=r.useRecord();return s.jsx($y,T({item:t},e))},$y=e=>{var v;const A=e,{scope:t,getContainer:o,item:n,children:i}=A,a=mt(A,["scope","getContainer","item","children"]),{getTemplate:c}=r.useCollectionManager_deprecated(),[l,p]=d.useState(!1),[u,m]=d.useState({}),{t:y}=B.useTranslation(),C=r.useCompile(),F=(v=n.fields)==null?void 0:v.map(b=>{var f;return{label:(f=b.uiSchema)!=null&&f.title?C(b.uiSchema.title):b.name,value:b.name}});return s.jsx(r.RecordProvider,{record:n,children:s.jsxs(r.ActionContextProvider,{value:{visible:l,setVisible:p},children:[s.jsx("a",N(T({},a),{onClick:()=>O(this,null,function*(){const b=c(n.template),f=by(T({},b),n,C);m(f),p(!0)}),children:i||y("Edit")})),s.jsx(r.SchemaComponent,{schema:u,components:{ArrayTable:se.ArrayTable},scope:T({getContainer:o,useValuesFromRecord:xy,useUpdateCollectionActionAndRefreshCM:Sy,useCancelAction:r.useCancelAction,createOnly:!1,filterTargetKeyOptions:F,isView:n.view,createMainOnly:!0},t)})]})})},Ty=(e,t)=>(o,n)=>{o.loading=!0,e(o,n,t).then(Be.action.bound(i=>{o.dataSource=i,o.loading=!1})).catch(i=>console.log(i))},Fy=()=>{const[e,t]=d.useState([]);return[e,t]},wy=()=>{const e=r.useRecord(),t=_.useForm();return{run(){return O(this,null,function*(){var i,a,c;const n=(c=(a=(i=t.values)==null?void 0:i.children)==null?void 0:a.slice)==null?void 0:c.call(a);t.setValuesIn("children",n.filter(l=>l.name!==e.name))})}}},_y=()=>({run(){return O(this,null,function*(){})}}),Py=e=>`${e||""}${V.uid()}`,Dy=()=>{const{t:e}=B.useTranslation(),{interfaces:t}=r.useCollectionManager_deprecated(),{data:{database:o}}=r.useCurrentAppInfo(),n=r.useDataSourceManager(),i=d.useContext(r.SchemaComponentContext),{name:a}=q.useParams(),c=d.useContext(r.CollectionCategroriesContext),l=r.useAPIClient(),p=l.resource("dbViews"),u=r.useCompile(),m=()=>O(this,null,function*(){return c.data.map(v=>({label:u(v.name),value:v.id}))}),y=()=>O(this,null,function*(){return p.list().then(({data:v})=>{var b;return(b=v==null?void 0:v.data)==null?void 0:b.map(f=>{const g=f.schema;return{label:g?`${g}.${u(f.name)}`:f.name,value:g?`${g}_${f.name}`:f.name}})})}),C=()=>O(this,null,function*(){return l.resource("storages").list().then(({data:v})=>{var b;return(b=v==null?void 0:v.data)==null?void 0:b.map(f=>({label:e(u(f.title)),value:f.name}))})}),F=()=>{const v=d.useContext(r.ResourceActionContext),b=r.useAPIClient(),f=_.useField(),{name:g}=q.useParams();f.data=f.data||{};const{setDataSource:h,dataSource:$}=d.useContext($e);return{onClick(){return O(this,null,function*(){var P,j,I;f.data.loading=!0;try{const{data:E}=yield b.request({url:`dataSources:refresh?filterByTk=${g}&clientStatus=${($==null?void 0:$.status)||"loaded"}`,method:"post"});f.data.loading=!1,h(E==null?void 0:E.data),((P=E==null?void 0:E.data)==null?void 0:P.status)==="reloading"?S.message.warning(e("Data source synchronization in progress")):((j=E==null?void 0:E.data)==null?void 0:j.status)==="loaded"&&(S.message.success(e("Data source synchronization successful")),(I=v==null?void 0:v.refresh)==null||I.call(v)),yield n.getDataSource(g).reload()}catch(E){f.data.loading=!1}})}}},A=d.useMemo(()=>rn(a),[a]);return s.jsx(r.SchemaComponentContext.Provider,{value:N(T({},i),{designable:!1}),children:s.jsx(r.SchemaComponent,{schema:A,components:{EditCollection:Ay,AddSubFieldAction:r.AddSubFieldAction,EditSubFieldAction:r.EditSubFieldAction,FieldSummary:r.FieldSummary,TemplateSummay:r.TemplateSummary,CollectionFields:Mo},scope:{useRefreshActionProps:F,useDestroySubField:wy,useBulkDestroySubField:_y,useSelectedRowKeys:Fy,useAsyncDataSource:Ty,loadCategories:m,loadDBViews:y,loadStorages:C,useNewId:Py,useCancelAction:r.useCancelAction,interfaces:t,enableInherits:(o==null?void 0:o.dialect)==="postgres",isPG:(o==null?void 0:o.dialect)==="postgres"}})})};var ko={exports:{}};/*!
	Copyright (c) 2018 Jed Watson.
	Licensed under the MIT License (MIT), see
	http://jedwatson.github.io/classnames
*/(function(e){(function(){var t={}.hasOwnProperty;function o(){for(var n=[],i=0;i<arguments.length;i++){var a=arguments[i];if(a){var c=typeof a;if(c==="string"||c==="number")n.push(a);else if(Array.isArray(a)){if(a.length){var l=o.apply(null,a);l&&n.push(l)}}else if(c==="object"){if(a.toString!==Object.prototype.toString&&!a.toString.toString().includes("[native code]")){n.push(a.toString());continue}for(var p in a)t.call(a,p)&&a[p]&&n.push(p)}}}return n.join(" ")}e.exports?(o.default=o,e.exports=o):window.classNames=o})()})(ko);var Iy=ko.exports;const Oy=we(Iy);var My=function(e,t){var o;if("ConfigContext"in S.ConfigProvider){var n=d.useContext(S.ConfigProvider.ConfigContext).getPrefixCls;return n(e,t==null?void 0:t.prefixCls)}else{var i=(o=t==null?void 0:t.prefixCls)!==null&&o!==void 0?o:"ant-";return"".concat(i).concat(e!=null?e:"")}};const ky=e=>{const t=My("description-input",e),{data:{name:o,tableName:n}}=r.useCollectionRecord();return s.jsx("div",{className:Oy(t,e.className),style:e.style,children:o!==n?s.jsxs(s.Fragment,{children:[o," ",s.jsxs("span",{style:{color:"GrayText"},children:["(",n,")"]})]}):e.value})},Ey=Object.assign(_.connect(S.Input,_.mapProps((e,t)=>N(T({},e),{suffix:s.jsx("span",{children:t!=null&&t.loading||t!=null&&t.validating?s.jsx(Z.LoadingOutlined,{}):e.suffix})})),_.mapReadPretty(ky))),jy=({item:e})=>{const{t}=B.useTranslation(),o=r.useCompile();return s.jsxs(S.Space,{children:[s.jsx(S.Badge,{color:e.color}),t(o(e.name))]})},Ky=_.observer(e=>{const[t,o]=d.useState(null),{refresh:n}=d.useContext(r.CollectionCategroriesContext),{refresh:i}=r.useResourceActionContext(),a=r.useAPIClient(),c=m=>O(this,null,function*(){const{active:y,over:C}=m;setTimeout(()=>{o(null)}),C&&C.id!==y.id&&(yield a.resource("collectionCategories").move({sourceId:y.id,targetId:C.id}),yield n(),yield i())});function l(m){var y;o((y=m.active)==null?void 0:y.data.current)}const p=Y.useSensor(Y.MouseSensor,{activationConstraint:{distance:10}}),u=Y.useSensors(p);return s.jsxs(Y.DndContext,{sensors:u,onDragEnd:c,onDragStart:l,children:[e.children,s.jsx(Y.DragOverlay,{children:t?s.jsx("span",{style:{whiteSpace:"nowrap"},children:s.jsx(jy,{item:t})}):null})]})},{displayName:"DndProvider"}),Ny=()=>{const{t:e}=B.useTranslation(),{data:t}=d.useContext(r.CollectionCategroriesContext),o=r.useCompile();if(!t)return null;const n=t.sort((a,c)=>c.sort-a.sort).concat().map(a=>N(T({},a),{schema:Ve}));!n.find(a=>a.id==="all")&&n.unshift({name:'{{t("All collections")}}',id:"all",sort:0,closable:!1,schema:Ve});const i=()=>O(this,null,function*(){return t.map(a=>({label:e(o(a.name)),value:a.id}))});return s.jsx(Ky,{children:s.jsx(S.Card,{bordered:!1,children:s.jsx(r.SchemaComponentOptions,{components:{CollectionFields:Mo,CollectionName:Ey},inherit:!0,scope:{loadCategories:i},children:s.jsx(_.RecursionField,{schema:Ve,onlyRenderProperties:!0})})})})},By={type:"object",properties:{[V.uid()]:{"x-component":"ConfigurationTable"}}},Vy=()=>s.jsx(r.SchemaComponent,{schema:By,components:{CollectionCategroriesProvider:r.CollectionCategroriesProvider,ConfigurationTable:Dy,ConfigurationTabs:Ny,AddFieldAction:r.AddFieldAction,AddCollectionField:r.AddCollectionField,AddCollection:r.AddCollection,AddCollectionAction:r.AddCollectionAction,EditCollection:r.EditCollection,EditCollectionAction:r.EditCollectionAction,DeleteCollection:r.DeleteCollection,DeleteCollectionAction:r.DeleteCollectionAction,EditFieldAction:r.EditFieldAction,EditCollectionField:r.EditCollectionField,OverridingCollectionField:r.OverridingCollectionField,OverridingFieldAction:r.OverridingFieldAction,ViewCollectionField:r.ViewCollectionField,ViewFieldAction:r.ViewFieldAction,SyncFieldsAction:r.SyncFieldsAction,SyncFieldsActionCom:r.SyncFieldsActionCom,SyncSQLFieldsAction:r.SyncSQLFieldsAction}}),Ly=()=>{const[e,t]=d.useState({}),o=r.usePlugin(Se),n=r.useCompile(),[i,a]=d.useState(!1),{t:c}=B.useTranslation(),[l,p]=d.useState(null),u=r.useAPIClient(),m=y=>{const C=[...o.types.keys()].map(F=>{const A=o.types.get(F);return{value:A.name,label:n(A.label)}});y.dataSource=C};return s.jsx("div",{children:s.jsxs(r.ActionContext.Provider,{value:{visible:i,setVisible:a},children:[s.jsx(S.Dropdown,{menu:{onClick(y){if(y.key==="__empty__")return;const C=o.types.get(y.key);p(y.key),a(!0),t({type:"object",properties:{[V.uid()]:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{initialValue:{type:y.key}},title:n("{{t('Add new')}}")+" - "+n(C.label),properties:{body:{type:"void","x-component":C.DataSourceSettingsForm},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{testConnectiion:{title:`{{ t("Test Connection",{ ns: "${K}" }) }}`,"x-component":"Action","x-component-props":{useAction:"{{ useTestConnectionAction }}"}},cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useCreateAction }}",actionCallback:"{{ dataSourceCreateCallback }}"}}}}}}}})},items:[o.types.size?null:{key:"__empty__",style:{height:"100px"},label:s.jsx(r.Empty,{imageStyle:{height:36},description:s.jsxs(s.Fragment,{children:[c("No external data source plugin installed",{ns:K}),s.jsx("br",{})," ",s.jsx("a",{target:"_blank",href:u.auth.locale==="zh-CN"?"https://docs-cn.nocobase.com/handbook/data-source-manager":"https://docs.nocobase.com/handbook/data-source-manager",rel:"noreferrer",children:c("View documentation",{ns:K})})]})})}].filter(Boolean).concat([...o.types.keys()].map(y=>{const C=o.types.get(y);return{key:y,label:n(C==null?void 0:C.label)}}))},children:s.jsxs(S.Button,{type:"primary",icon:s.jsx(Z.PlusOutlined,{}),children:[c("Add new")," ",s.jsx(Z.DownOutlined,{})]})}),s.jsx(r.SchemaComponent,{scope:{createOnly:!1,useTestConnectionAction:yt,dialect:l,useDialectDataSource:m},schema:e})]})})},qy=()=>{const e=r.useRecord(),[t,o]=d.useState({}),n=r.usePlugin(Se),i=r.useCompile(),[a,c]=d.useState(!1),{t:l}=B.useTranslation(),p=r.useDataSourceManager(),u=()=>{const m=_.useField(),y=_.useForm(),C=r.useActionContext(),{refresh:F}=r.useResourceActionContext(),{resource:A}=r.useResourceContext(),{key:v}=r.useRecord();return{run(){return O(this,null,function*(){yield y.submit(),m.data=m.data||{},m.data.loading=!0;try{yield A.update({filterByTk:v,values:y.values}),C.setVisible(!1),p.getDataSource(v).setOptions(y.values),p.getDataSource(v).reload(),yield y.reset(),F()}catch(f){console.log(f)}finally{m.data.loading=!1}})}}};return s.jsx("div",{children:s.jsxs(r.ActionContext.Provider,{value:{visible:a,setVisible:c},children:[e.key!=="main"&&s.jsx("a",{onClick:()=>{c(!0);const m=n.types.get(e.type);o({type:"object",properties:{[V.uid()]:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{initialValue:e},title:i("{{t('Edit')}}")+" - "+i(e.displayName),properties:{body:{type:"void","x-component":m.DataSourceSettingsForm},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},testConnectiion:{title:`{{ t("Test Connection",{ ns: "${K}" }) }}`,"x-component":"Action","x-component-props":{useAction:"{{ useTestConnectionAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useUpdateAction }}"}}}}}}}})},children:l("Edit")}),s.jsx(r.SchemaComponent,{scope:{createOnly:!0,useUpdateAction:u},schema:t})]})})},Gy=e=>`/app/settings/data-source-manager/${e}/collections`,Uy=()=>{const e=r.useRecord(),t=q.useNavigate(),{t:o}=B.useTranslation();return s.jsx("div",{className:e.enabled?void 0:ge.css`
              .ant-btn-link {
                &:hover {
                  color: rgba(0, 0, 0, 0.25) !important;
                }
              }
            `,children:s.jsx(S.Button,{type:"link",style:{padding:"0px"},disabled:!e.enabled,onClick:()=>{t(Gy(e.key))},role:"button","aria-label":`${e==null?void 0:e.key}-Configure`,children:o("Configure")})})},zy=()=>{const{t:e}=B.useTranslation(),t=r.usePlugin(Se),o=[...t.types.keys()].map(m=>{const y=t.types.get(m);return{value:m,label:e(y==null?void 0:y.label)}}).concat([{value:"main",label:e("Main")}]),n=r.useDataSourceManager(),i=d.useRef([]);d.useEffect(()=>()=>{n.getDataSources().forEach(m=>{i.current.includes(m.key)&&m.reload()})},[i]);const a=d.useCallback(m=>{n.removeDataSources(m)},[n]),c=d.useCallback(m=>{n.addDataSource(ft,m),i.current=[...i.current,m.key]},[]),l=()=>{const m=r.useResourceActionContext();return{onClick(){return O(this,null,function*(){var F,A;const C=(F=m==null?void 0:m.data)==null?void 0:F.data.filter(v=>v.status!=="loaded");if(C!=null&&C.length){const v=n.getDataSources(),b=C.map(g=>g.key),f=v.filter(g=>b.includes(g.key));yield Promise.all(f.map(g=>g.reload()))}(A=m==null?void 0:m.refresh)==null||A.call(m)})}}},p=()=>{const{refresh:m}=r.useResourceActionContext(),{resource:y}=r.useResourceContext(),{key:C}=r.useRecord();return{run(){return O(this,null,function*(){yield y.destroy({filterByTk:C}),a([C]),m()})}}},u=m=>{const{key:y}=r.useRecord();m.visible=y!=="main"};return s.jsx(S.Card,{bordered:!1,children:s.jsx(r.SchemaComponent,{components:{CreateDatabaseConnectAction:Ly,EditDatabaseConnectionAction:qy,ViewDatabaseConnectionAction:Uy},scope:{useNewId:m=>`${m}${V.uid()}`,types:o,useRefreshActionProps:l,useDestroyAction:p,dataSourceDeleteCallback:a,dataSourceCreateCallback:c,useIsAbleDelete:u},schema:on})})},Hy={association:{sourceKey:"name",targetKey:"name"},collection:{name:"fields",fields:[{type:"string",name:"type",interface:"input",uiSchema:{title:'{{ t("Storage type") }}',type:"string","x-component":"Select",enum:[{label:"String",value:"string"}],required:!0}},{type:"string",name:"interface",interface:"input",uiSchema:{title:'{{ t("Field interface") }}',type:"string","x-component":"Select",enum:"{{interfaces}}"}},{type:"string",name:"title",interface:"input",uiSchema:{title:'{{ t("Field display name") }}',type:"string","x-component":"Input",required:!0}},{type:"string",name:"name",interface:"input",uiSchema:{title:'{{ t("Field name") }}',type:"string","x-component":"Input"}},{type:"string",name:"description",interface:"input",uiSchema:{title:'{{ t("Description") }}',type:"string","x-component":"Input.TextArea"}}]},request:{resource:"collections.fields",action:"list",params:{paginate:!1,filter:{$or:[{"interface.$not":null},{"options.source.$notEmpty":!0}]},sort:["sort"]}}},ut=d.createContext(null),Wy=e=>s.jsx(ut.Provider,{value:r.useResourceActionContext(),children:s.jsx(r.ResourceActionProvider,N(T({},Hy),{children:e.children}))}),Qy=ge.css`
  .ant-table {
    margin-left: -16px !important;
  }
`,Yy=ge.css`
  tr {
    display: flex;
  }
  td,
  th {
    flex: 2;
    width: 0;
    &:nth-child(5) {
      flex: 1.2;
    }
    &:last-child {
      flex: 1.8;
    }
  }
  .ant-table-selection-column,
  .ant-table-row-expand-icon-cell {
    flex-basis: 50px !important;
    min-width: 50px;
    flex: 0;
  }
`,Eo="Default title for each record",Jy=e=>{const t=r.useCompile(),{getInterface:o}=r.useCollectionManager_deprecated(),{t:n}=B.useTranslation(),{setState:i}=r.useResourceActionContext(),{targetKey:a}=e.collectionResource||{},c=r.useRecord(),[l,p]=d.useState(null),{refreshCM:u,isTitleField:m,getTemplate:y}=r.useCollectionManager_deprecated(),{[a]:C,titleField:F,template:A}=c,v=y(A),b=r.useAPIClient(),f=d.useContext(ut),{t:g}=B.useTranslation("@nocobase/plugin-data-source-manager"),{modal:h}=S.App.useApp(),$=[{dataIndex:["uiSchema","title"],title:n("Field display name"),render:D=>s.jsx("div",{style:{marginLeft:7},children:t(D)})},{dataIndex:"name",title:n("Field name")},{dataIndex:"interface",title:n("Field interface"),render:D=>{var P;return s.jsx(S.Tag,{children:t((P=o(D))==null?void 0:P.title)})}},{dataIndex:"titleField",title:n("Title field"),render:function(P,j){const I=E=>O(this,null,function*(){var x;p(j),yield b.request({url:`collections:update?filterByTk=${C}`,method:"post",data:{titleField:E?j.name:"id"}}),(x=f==null?void 0:f.refresh)==null||x.call(f),yield e.refreshAsync(),p(null),u(),S.message.success(n("Saved successfully"))});return m(j)?s.jsx(S.Tooltip,{title:n(Eo),placement:"right",overlayInnerStyle:{textAlign:"center"},children:s.jsx(S.Switch,{"aria-label":`switch-title-field-${j.name}`,size:"small",loading:j.name===(l==null?void 0:l.name),checked:j.name===(F||"id"),onChange:I})}):null}},{dataIndex:"description",title:n("Descriptio "),render:D=>s.jsx(r.Input.ReadPretty,{value:D,ellipsis:!0})},{dataIndex:"actions",title:n("Actions"),render:(D,P)=>{const j={confirm:{title:n("Delete record"),content:n("Are you sure you want to delete it?")},useAction:r.useDestroyActionAndRefreshCM,beforeConfirmLogic(){function I(w,U){return O(this,null,function*(){var z;try{const{data:H}=yield b.request({method:"get",url:`/public:checkFieldReference?collectionName=${w}&fieldName=${U}`});return((z=H==null?void 0:H.data)==null?void 0:z.length)>0?(h.error({title:g("Error"),okText:g("Got it"),width:550,content:s.jsxs(s.Fragment,{children:[s.jsx("div",{children:g("Cannot delete this field because it is referenced by the following workflow nodes")}),s.jsx("div",{style:{padding:"15px",height:"220px",overflow:"auto",backgroundColor:"#F5F5F5",marginTop:"15px"},children:H.data.map((W,J)=>s.jsxs("div",{style:{marginBottom:"15px"},children:[s.jsx("div",{style:{fontWeight:900},children:W.title}),W.effect_nodes.map(ee=>s.jsxs("div",{style:{paddingLeft:"10px"},children:[ee.title," ",ee.title!=="Trigger"&&ee.id]},ee.id))]},J))})]}),centered:!0}),!0):!1}catch(H){Ae.captureException(H)}})}if(e.record.key==="association")return I(P.collectionName,P.name);let E=!1,x="",M="";for(const w of e.association)if((w==null?void 0:w.foreignKey)===P.name||(w==null?void 0:w.otherKey)===P.name){E=!0,x=w.collectionName,M=w.name;break}return E?I(x,M):!1},disabled:r.isDeleteButtonDisabled(P)||(v==null?void 0:v.forbidDeletion),title:n("Delete")};return s.jsx(r.RecordProvider,{record:P,parent:c,children:s.jsxs(S.Space,{children:[s.jsx(r.EditCollectionField,{role:"button","aria-label":`edit-button-${P.name}`,type:"primary"}),s.jsx(r.Action.Link,T({},j))]})})}}];return s.jsx(S.Table,{rowKey:"name",columns:$,showHeader:!1,pagination:!1,dataSource:e.fields,rowSelection:{type:"checkbox",getCheckboxProps(D){return{"aria-label":`checkbox-${D.name}`}},onChange:D=>{i(P=>N(T({},P),{selectedRowKeys:D}))}},className:Qy})},Zy=e=>{const t=r.useCompile(),{getInterface:o}=r.useCollectionManager_deprecated(),{targetKey:n}=e.collectionResource||{},i=r.useRecord(),[a,c]=d.useState(null),{t:l}=B.useTranslation(),{refreshCM:p,isTitleField:u}=r.useCollectionManager_deprecated(),{[n]:m,titleField:y,name:C}=i,F=d.useContext(ut),A=r.useAPIClient(),v=[{dataIndex:["uiSchema","rawTitle"],title:l("Field display name"),render:b=>s.jsx("div",{style:{marginLeft:1},children:t(b)})},{dataIndex:"name",title:l("Field name")},{dataIndex:"interface",title:l("Field interface"),render:b=>{var f;return s.jsx(S.Tag,{children:t((f=o(b))==null?void 0:f.title)})}},{dataIndex:"titleField",title:l("Title field"),render(b,f){const g=h=>O(this,null,function*(){var $;c(f),yield A.request({url:`collections:update?filterByTk=${m}`,method:"post",data:{titleField:h?f.name:"id"}}),($=F==null?void 0:F.refresh)==null||$.call(F),yield e.refreshAsync(),c(null),p(),S.message.success(l("Saved successfully"))});return u(f)?s.jsx(S.Tooltip,{title:l(Eo),placement:"right",overlayInnerStyle:{textAlign:"center"},children:s.jsx(S.Switch,{size:"small",loading:f.name===(a==null?void 0:a.name),checked:f.name===(y||"id"),onChange:g})}):null}},{dataIndex:"actions",title:l("Actions"),render:function(f,g){const h={type:"primary",currentCollection:C},$={type:"primary"};return s.jsx(r.RecordProvider,{record:g,parent:i,children:s.jsxs(S.Space,{children:[s.jsx(r.OverridingCollectionField,T({},h)),s.jsx(r.ViewCollectionField,T({},$))]})})}}];return s.jsx(S.Table,{rowKey:"name",columns:v,showHeader:!1,pagination:!1,dataSource:e.fields.filter(b=>b.interface)})},Xy=()=>{const e=r.useCompile(),t=_.useField(),{name:o,template:n}=r.useRecord(),{data:{database:i}}=r.useCurrentAppInfo(),{getInterface:a,getInheritCollections:c,getCollection:l,getTemplate:p}=r.useCollectionManager_deprecated(),u=d.useMemo(()=>fe.createForm(),[]),m=r.useAttach(u.createArrayField(N(T({},t.props),{basePath:""}))),{t:y}=B.useTranslation(),C=r.useResourceContext(),{refreshAsync:F,data:A}=d.useContext(r.ResourceActionContext),v=p(n),b=c(o),f=[{dataIndex:"title",title:y("Field display name"),render:I=>s.jsx("div",{className:ge.css`
            font-weight: 500;
          `,children:I})},{dataIndex:"name",title:y("Field name")},{dataIndex:"interface",title:y("Field interface")},{dataIndex:"titleField",title:y("Title field")},{dataIndex:"description",title:y("Description")},{dataIndex:"actions",title:y("Actions")}],g=(A==null?void 0:A.data)||[],h={pf:[],association:[],general:[],system:[]};g.forEach(I=>{if(I.primaryKey||I.isForeignKey)h.pf.push(I);else if(I.interface){const E=a(I.interface);(E==null?void 0:E.group)==="systemInfo"?h.system.push(I):(E==null?void 0:E.group)==="relation"?h.association.push(I):h.general.push(I)}});const $=[{key:"pf",title:y("PK & FK fields"),fields:h.pf},{key:"association",title:y("Association fields"),fields:h.association},{key:"general",title:y("General fields"),fields:h.general},{key:"system",title:y("System fields"),fields:h.system}];$.push(...b.map(I=>{const E=l(I);if(E)return{key:I,title:`${y("Inherited fields")} - `+e(E==null?void 0:E.title),inherit:!0,fields:(E==null?void 0:E.fields)||[]}}).filter(Boolean));const D=d.useMemo(()=>({useAction:()=>r.useBulkDestroyActionAndRefreshCM(!0),title:y("Delete"),icon:"DeleteOutlined",disabled:v==null?void 0:v.forbidDeletion,confirm:{title:y("Delete record"),content:y("Are you sure you want to delete it?")}}),[y]),P={type:"primary",database:i},j={type:"primary"};return s.jsx(_.FormContext.Provider,{value:u,children:s.jsxs(_.FieldContext.Provider,{value:m,children:[s.jsxs(S.Space,{align:"end",className:ge.css`
            justify-content: flex-end;
            display: flex;
            margin-bottom: 16px;
          `,children:[s.jsx(r.Action,T({},D)),s.jsx(r.SyncFieldsAction,T({},j)),s.jsx(r.SyncSQLFieldsAction,{refreshCMList:F}),s.jsx(r.SchemaComponent,{schema:{type:"object",properties:T({},v.configureActions)}}),s.jsx(r.AddCollectionField,T({},P))]}),s.jsx(S.Table,{rowKey:"key",columns:f,dataSource:$.filter(I=>I.fields.length),pagination:!1,className:Yy,expandable:{defaultExpandAllRows:!0,defaultExpandedRowKeys:$.map(I=>I.key),expandedRowRender:I=>I.inherit?s.jsx(Zy,{fields:I.fields,collectionResource:C,refreshAsync:F}):s.jsx(Jy,{fields:I.fields,collectionResource:C,refreshAsync:F,association:$.filter(E=>E.key==="association")[0].fields,record:I})}})]})})},jo=()=>s.jsx(Wy,{children:s.jsx(Xy,{})}),Ko=e=>_.Schema.compile(e,{t:r.i18n.t}),Ry={type:"object",properties:{block1:{type:"void","x-collection":"collections","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:{name:"collections",filterTargetKey:"name",targetKey:"name",sortable:!0,fields:[{type:"integer",name:"title",interface:"input",uiSchema:{title:'{{ t("Collection display name") }}',type:"number","x-component":"Input",required:!0}},{type:"string",name:"name",interface:"input",uiSchema:{title:'{{ t("Collection name") }}',type:"string","x-component":"Input",description:'{{t("Randomly generated and can be modified. Support letters, numbers and underscores, must start with an letter.")}}'}},{type:"string",name:"template",interface:"input",uiSchema:{title:'{{ t("Collection Template") }}',type:"string","x-component":"Input"}},{type:"hasMany",name:"fields",target:"fields",collectionName:"collections",sourceKey:"name",targetKey:"name",uiSchema:{}},{type:"hasMany",name:"inherits",interface:"select",uiSchema:{title:'{{ t("Inherits") }}',type:"string","x-component":"Select","x-component-props":{mode:"multiple"}}},{type:"string",name:"description",interface:"input",uiSchema:{title:'{{ t("Description") }}',type:"string","x-component":"Input"}},{type:"string",name:"hidden",interface:"select",uiSchema:{title:'{{ t("Associated Collection") }}',enum:[{value:"1",label:'{{ t("Yes") }}',color:"green"},{value:"0",label:'{{ t("No") }}',color:"volcano"}],type:"string","x-component":"Select"}}]},dragSort:!0,request:{resource:"collections",action:"list",params:{pageSize:50,sort:"sort",appends:["category","associatedApp","associatedApp.applicationsRelationShip"]}}},properties:{tabs:{type:"void","x-component":"ConfigurationTabs"}}}}},No={type:"object",properties:{[V.uid()]:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',default:{$and:[{title:{$includes:""}},{name:{$includes:""}},{hidden:{$eq:"0"}}]},"x-action":"filter","x-component":"Filter.Action","x-use-component-props":"cm.useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"DeleteCollection","x-component-props":{role:"button",isBulk:!0}},create:{type:"void",title:'{{ t("Create collection") }}',"x-component":"AddCollection","x-component-props":{type:"primary"}}}},[V.uid()]:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"name",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}",useAction(){const e=r.useAPIClient(),{t}=B.useTranslation();return{move(n,i){return O(this,null,function*(){yield e.resource("collections").move({sourceId:n.key,targetId:i.key}),S.message.success(t("Saved successfully"),.2)})}}}},properties:{column1:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{title:{"x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column2_1:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:'{{t("Associated App")}}',properties:{associatedApp:{type:"string","x-component":r.CollectionAssociatedApp,"x-read-pretty":!0}}},column3:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:'{{t("Collection template")}}',properties:{template:{"x-component":r.CollectionTemplateTag,"x-read-pretty":!0}}},column4:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column","x-visible":"categoryVisible",title:'{{t("Collection category")}}',properties:{category:{"x-component":r.CollectionCategory,"x-read-pretty":!0}}},column5:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{description:{"x-component":"CollectionField","x-read-pretty":!0,"x-component-props":{ellipsis:!0}}}},column6:{type:"void",title:'{{ t("Actions") }}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{view:{type:"void",title:'{{ t("Configure fields") }}',"x-component":"Action.Link","x-component-props":{},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-component-props":{destroyOnClose:!0,width:"70%"},"x-reactions":e=>{const t=e.path.segments[1],o=e.path.segments[0],n=e.form.getValuesIn(`${o}.${t}`);n&&(e.title=`${Ko(n.title)} - ${Ko('{{ t("Configure fields") }}')}`)},properties:{collectionFieldSchema:{type:"void","x-component":"CollectionFields"}}}}},update:{type:"void",title:'{{ t("Edit") }}',"x-component":"EditCollection","x-component-props":{role:"button","aria-label":'{{ "edit-button-" + $record.name }}',type:"primary"}},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"DeleteCollection","x-component-props":{role:"button","aria-label":'{{ "delete-button-" + $record.name }}',type:"primary",className:"nb-action-link"}}}}}}}}}},ef={type:"object",properties:{form:{type:"void","x-decorator":"Form","x-component":"Action.Modal",title:'{{ t("Add category") }}',"x-component-props":{width:520,getContainer:"{{ getContainer }}"},properties:{name:{type:"string",title:'{{t("Category name")}}',required:!0,"x-disabled":"{{ !createOnly }}","x-decorator":"FormItem","x-component":"Input"},color:{type:"string",title:'{{t("Color")}}',required:!1,"x-decorator":"FormItem","x-component":"ColorSelect"},footer:{type:"void","x-component":"Action.Modal.Footer",properties:{action1:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ useCancelAction }}"}},action2:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useCreateCategry }}",style:{marginLeft:"8px"}}}}}}}}},tf={type:"object",properties:{form:{type:"void","x-decorator":"Form","x-decorator-props":{useValues:"{{ useValuesFromRecord }}"},"x-component":"Action.Modal",title:'{{ t("Edit category") }}',"x-component-props":{width:520,getContainer:"{{ getContainer }}"},properties:{name:{type:"string",title:'{{t("Category name")}}',required:!0,"x-disabled":"{{ !createOnly }}","x-decorator":"FormItem","x-component":"Input"},color:{type:"string",title:'{{t("Color")}}',required:!1,"x-decorator":"FormItem","x-component":"ColorSelect"},footer:{type:"void","x-component":"Action.Modal.Footer",properties:{action1:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ useCancelAction }}"}},action2:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useEditCategry }}",style:{marginLeft:"8px"}}}}}}}}},of=(e,t,o)=>(n,i)=>{n.loading=!0,e(n,i,t,o).then(Be.action.bound(a=>{n.dataSource=a,n.loading=!1})).catch(a=>{Ae.captureException(a)})},nf=(e,t={})=>{const{exclude:o,excludeTable:n,sucCallback:i}=t,a=r.useRecord();return(c,l)=>{c.loading=!0,e(c,l,o,n).then(Be.action.bound(p=>{c.dataSource=p,c.loading=!1,i==null||i(c,{record:a,data:p})})).catch(p=>{Ae.captureException(p)})}},rf=(e,t)=>{var a,c;const{record:o,data:n}=t,i=(c=(a=o.associatedApp)==null?void 0:a.applicationsRelationShip)==null?void 0:c.name;if(!e.value&&i&&Array.isArray(n)){const l=n.find(p=>p.value===i);l&&(e.defaultValue=l.value,e.value=l.value)}},af=()=>{const[e,t]=d.useState([]);return[e,t]},sf=()=>{const e=r.useRecord(),t=_.useForm();return{run(){return O(this,null,function*(){var i,a,c;const n=(c=(a=(i=t.values)==null?void 0:i.children)==null?void 0:a.slice)==null?void 0:c.call(a);t.setValuesIn("children",n.filter(l=>l.name!==e.name))})}}},cf=()=>({run(){return O(this,null,function*(){})}}),lf=()=>{const e=r.useRecord(),{getCollectionFields:t}=r.useCollectionManager_deprecated();return e.__parent&&e.__parent.interface==="subTable"?d.useContext(r.DataSourceContext_deprecated).dataSource:t(e.collectionName||e.name)},uf=e=>`${e||""}${V.uid()}`,pf=()=>{const{t:e}=B.useTranslation(),{interfaces:t,getCollections:o}=r.useCollectionManager_deprecated(),{data:{database:n}}=r.useCurrentAppInfo(),i=d.useContext(r.CollectionCategroriesContext),a=r.useAPIClient(),c=a.resource("dbViews"),l=r.useCompile();_.useForm();const p=(A,v,b,f)=>O(this,null,function*(){var D;const{targetScope:g}=v,h=((D=A.props)==null?void 0:D.name)==="inherits";return o().filter(P=>{var x;if(f!=null&&f.includes(P.name)||b!=null&&b.includes(P.template)||P.autoCreate&&P.isThrough||h&&P.template==="view")return!1;const I=!(g!=null&&g.template)||g.template.includes(P.template),E=!(g!=null&&g[(x=A.props)==null?void 0:x.name])||g[A.props.name].includes(P.name);return I&&E}).map(P=>({label:l(P.title),value:P.name}))}),u=()=>O(this,null,function*(){return i.data.map(A=>({label:l(A.name),value:A.id}))}),m=()=>O(this,null,function*(){return c.list().then(({data:A})=>{var v;return(v=A==null?void 0:A.data)==null?void 0:v.map(b=>{const f=b.schema;return{label:f?`${f}.${l(b.name)}`:b.name,value:f?`${f}_${b.name}`:b.name}})})}),y=A=>O(this,null,function*(){const{fields:v}=A.form.values;return Promise.resolve({data:v}).then(({data:b})=>b==null?void 0:b.map(f=>{var g;return{label:l((g=f.uiSchema)==null?void 0:g.title)||f.name,value:f.name}}))}),C=()=>O(this,null,function*(){return a.resource("storages").list({paginate:!1}).then(({data:A})=>{var v;return(v=A==null?void 0:A.data)==null?void 0:v.map(b=>({label:e(l(b.title)),value:b.name}))})}),F=d.useContext(r.SchemaComponentContext);return s.jsx(r.SchemaComponentContext.Provider,{value:N(T({},F),{designable:!1}),children:s.jsx(r.SchemaComponent,{schema:Ry,components:{AddSubFieldAction:r.AddSubFieldAction,EditSubFieldAction:r.EditSubFieldAction,FieldSummary:r.FieldSummary,TemplateSummay:r.TemplateSummary,CollectionFields:jo},scope:{loadFilterTargetKeys:y,useDestroySubField:sf,useBulkDestroySubField:cf,useSelectedRowKeys:af,useAsyncDataSource:of,useAsyncDataSourceWithCallback:nf,loadCollections:p,loadCategories:u,loadDBViews:m,loadStorages:C,setDefaultStorageByAssociatedApp:rf,useCurrentFields:lf,useNewId:uf,useCancelAction:r.useCancelAction,interfaces:t,enableInherits:(n==null?void 0:n.dialect)==="postgres",isPG:(n==null?void 0:n.dialect)==="postgres"}})})};function df(e){const{attributes:t,listeners:o,setNodeRef:n}=Y.useDraggable({id:e.id,data:e.data});return s.jsx("div",N(T(T({ref:n},o),t),{children:s.jsx("div",{children:e.children})}))}function mf(e){const{isOver:t,setNodeRef:o}=Y.useDroppable({id:e.id,data:e.data}),n=t?{color:"green"}:void 0;return s.jsx("div",{ref:o,style:n,children:e.children})}const yf=_.observer(({item:e})=>s.jsx(mf,{id:e.id.toString(),data:e,children:s.jsx("div",{children:s.jsx(df,{id:e.id.toString(),data:e,children:s.jsx(Bo,{item:e})})})}),{displayName:"TabTitle"}),Bo=({item:e})=>{const{t}=B.useTranslation(),o=r.useCompile();return s.jsxs(S.Space,{children:[s.jsx(S.Badge,{color:e.color}),t(o(e.name))]})},ff=_.observer(e=>{const[t,o]=d.useState(null),{refresh:n}=d.useContext(r.CollectionCategroriesContext),{refresh:i}=r.useResourceActionContext(),a=r.useAPIClient(),c=m=>O(this,null,function*(){const{active:y,over:C}=m;setTimeout(()=>{o(null)}),C&&C.id!==y.id&&(yield a.resource("collectionCategories").move({sourceId:y.id,targetId:C.id}),yield n(),yield i())});function l(m){var y;o((y=m.active)==null?void 0:y.data.current)}const p=Y.useSensor(Y.MouseSensor,{activationConstraint:{distance:10}}),u=Y.useSensors(p);return s.jsxs(Y.DndContext,{sensors:u,onDragEnd:c,onDragStart:l,children:[e.children,s.jsx(Y.DragOverlay,{children:t?s.jsx("span",{style:{whiteSpace:"nowrap"},children:s.jsx(Bo,{item:t})}):null})]})},{displayName:"DndProvider"}),gf=()=>{const{t:e}=B.useTranslation(),{data:t,refresh:o}=d.useContext(r.CollectionCategroriesContext),{refresh:n,run:i,defaultRequest:a,setState:c}=r.useResourceActionContext(),[l,p]=d.useState({tab:"all"}),[u,m]=d.useState(l.tab),y=r.useCompile(),C=r.useAPIClient(),{modal:F}=S.App.useApp(),A=d.useMemo(()=>{if(!t)return[];const h=t.sort(($,D)=>D.sort-$.sort).concat().map($=>N(T({},$),{schema:No}));return!h.find($=>$.id==="all")&&h.unshift({name:'{{t("All collections")}}',id:"all",sort:0,closable:!1,schema:No}),h},[t]);d.useEffect(()=>{l.tab!=="all"&&v(l.tab)},[]);const v=h=>{var $;if(p({tab:h}),m(V.uid()),h!=="all"){const P={$and:[($=a==null?void 0:a.params)==null?void 0:$.filter,{"category.id":h}]};i({filter:P}),c==null||c({category:[+h],params:[{filter:P}]})}else i(),c==null||c({category:[],params:[]})},b=h=>{F.confirm({title:y("{{t('Delete category')}}"),content:y("{{t('Are you sure you want to delete it?')}}"),onOk:()=>O(this,null,function*(){yield C.resource("collectionCategories").destroy({filter:{id:h}}),h===+l.tab&&p({tab:"all"}),yield o(),yield n()})})},f=()=>O(this,null,function*(){return t.map(h=>({label:e(y(h.name)),value:h.id}))}),g=X.memoize(h=>({items:[{key:"edit",label:s.jsx(r.SchemaComponent,{schema:{type:"void",properties:{[V.uid()]:{"x-component":"EditCategory","x-component-props":{item:h}}}}})},{key:"delete",label:y("{{t('Delete category')}}"),onClick:()=>b(h.id)}]}));return t?s.jsx(ff,{children:s.jsx(S.Tabs,{addIcon:s.jsx(r.SchemaComponent,{schema:{type:"void",properties:{addCategories:{type:"void",title:'{{ t("Add category") }}',"x-component":"AddCategory","x-component-props":{type:"primary"}}}}}),onChange:v,defaultActiveKey:l.tab||"all",type:"editable-card",destroyInactiveTabPane:!0,tabBarStyle:{marginBottom:"0px"},items:A.map(h=>({label:h.id!=="all"?s.jsx("div",{"data-no-dnd":"true",children:s.jsx(yf,{item:h})}):y(h.name),key:String(h.id),closable:h.closable,closeIcon:s.jsx(S.Dropdown,{menu:g(h),children:s.jsx(Z.MenuOutlined,{role:"button","aria-label":y(h.name),style:{padding:8,margin:"-8px"}})}),children:s.jsx(S.Card,{bordered:!1,children:s.jsx(r.SchemaComponentOptions,{components:{CollectionFields:jo},inherit:!0,scope:{loadCategories:f,categoryVisible:h.id==="all",categoryId:h.id},children:s.jsx(_.RecursionField,{name:u,schema:h.schema,onlyRenderProperties:!0})})})}))})}):null},hf=()=>{const e=_.useForm(),t=r.useActionContext(),{refresh:o}=d.useContext(r.CollectionCategroriesContext),n=r.useAPIClient();return{run(){return O(this,null,function*(){yield e.submit();const a=X.cloneDeep(e.values);yield n.resource("collectionCategories").create({values:T({},a)}),t.setVisible(!1),yield e.reset(),yield o()})}}},Cf=e=>s.jsx(Vo,T({},e)),Vo=e=>{const{scope:t,getContainer:o,children:n}=e,[i,a]=d.useState(!1),{t:c}=B.useTranslation();return s.jsxs(r.ActionContextProvider,{value:{visible:i,setVisible:a},children:[s.jsx("div",{onClick:()=>a(!0),title:c("Add category"),children:n||s.jsx(Z.PlusOutlined,{})}),s.jsx(r.SchemaComponent,{schema:ef,components:{CollectionCategory:r.CollectionCategory,CollectionTemplateTag:r.CollectionTemplateTag},scope:T({getContainer:o,useCancelAction:r.useCancelAction,createOnly:!0,useCreateCategry:hf},t)})]})},vf=()=>{const e=_.useForm(),t=r.useActionContext(),{refresh:o}=d.useContext(r.CollectionCategroriesContext),{refresh:n}=r.useResourceActionContext(),i=r.useAPIClient(),{id:a}=r.useRecord();return{run(){return O(this,null,function*(){yield e.submit();const l=X.cloneDeep(e.values);yield i.resource("collectionCategories").update({filter:{id:a},values:T({},l)}),t.setVisible(!1),yield e.reset(),yield o(),yield n()})}}},bf=e=>{const t=r.useRecord(),o=r.useRequest(()=>Promise.resolve({data:X.cloneDeep(t)}),N(T({},e),{manual:!0})),n=r.useActionContext();return d.useEffect(()=>{n.visible&&o.run()},[n.visible]),o},xf=e=>s.jsx(Lo,T({},e)),Lo=e=>{const{scope:t,getContainer:o,item:n,children:i}=e,[a,c]=d.useState(!1),l=r.useCompile();return s.jsx(r.RecordProvider,{record:n,children:s.jsxs(r.ActionContextProvider,{value:{visible:a,setVisible:c},children:[s.jsx(s.Fragment,{children:i||s.jsx("span",{onClick:()=>c(!0),children:l('{{ t("Edit category") }}')})}),s.jsx(r.SchemaComponent,{schema:tf,scope:T({getContainer:o,useCancelAction:r.useCancelAction,createOnly:!0,useEditCategry:vf,useValuesFromRecord:bf},t)})]})})};fe.registerValidateFormats({uid:/^[a-zA-Z][a-zA-Z0-9_-]*$/});const Sf={type:"object",properties:{[V.uid()]:{"x-component":"ConfigurationTable"}}},Af=()=>s.jsx(r.SchemaComponent,{schema:Sf,components:{CollectionCategroriesProvider:r.CollectionCategroriesProvider,ConfigurationTable:pf,ConfigurationTabs:gf,AddFieldAction:r.AddFieldAction,AddCollectionField:r.AddCollectionField,AddCollection:r.AddCollection,AddCollectionAction:r.AddCollectionAction,AddCategoryAction:Vo,AddCategory:Cf,EditCollection:r.EditCollection,EditCollectionAction:r.EditCollectionAction,DeleteCollection:r.DeleteCollection,DeleteCollectionAction:r.DeleteCollectionAction,EditFieldAction:r.EditFieldAction,EditCollectionField:r.EditCollectionField,OverridingCollectionField:r.OverridingCollectionField,OverridingFieldAction:r.OverridingFieldAction,ViewCollectionField:r.ViewCollectionField,ViewFieldAction:r.ViewFieldAction,EditCategory:xf,EditCategoryAction:Lo,SyncFieldsAction:r.SyncFieldsAction,SyncFieldsActionCom:r.SyncFieldsActionCom,SyncSQLFieldsAction:r.SyncSQLFieldsAction}}),be=d.createContext(null);be.displayName="PermissionContext";const $f=e=>{const t=r.useAPIClient(),o=r.useRecord(),{t:n}=B.useTranslation(),i=d.useContext(xe),{snippets:a}=i;a==null||a.forEach(p=>{i[p]=!0});const[c,l]=d.useState(i);return d.useEffect(()=>{l(i)},[i]),s.jsx(be.Provider,{value:{currentDataSource:o,currentRecord:c,update:(p,u)=>O(this,null,function*(){yield t.request({url:`dataSources/${o.key}/roles:update`,data:u.values,method:"post",params:{filterByTk:u.values.roleName}}),l(T(T({},c),u.values)),S.message.success(n("Saved successfully"))})},children:e.children})},Tf=e=>{const t=d.useContext(xe),o=r.useRecord();return s.jsx(r.RecordContext_deprecated.Provider,{value:T({},t),children:s.jsx(r.SchemaComponentOptions,{scope:{dataSourceKey:o.key},children:e.children})})},Ff=e=>{const t=r.useRecord(),{visible:o}=r.useActionContext(),{currentDataSource:n}=d.useContext(be),i=r.useRequest({resource:"roles.dataSourceResources",resourceOf:t.roleName,action:"get",params:{appends:["actions","actions.scope"],filterByTk:t.name,filter:{dataSourceKey:n.key,name:t.name}}},N(T({},e),{manual:!0}));return d.useEffect(()=>{if(!t.exists){e.onSuccess({data:{}});return}o&&i.run()},[o,t.exists]),i},wf=()=>{const e=_.useForm(),t=r.useAPIClient(),o=r.useRecord(),n=r.useActionContext(),{refresh:i}=r.useResourceActionContext(),{currentDataSource:a}=d.useContext(be);return{run(){return O(this,null,function*(){yield t.resource("roles.dataSourceResources",o.roleName)[o.exists?"update":"create"]({filterByTk:o.name,filter:{dataSourceKey:a.key,name:o.name},values:N(T({},e.values),{name:o.name,dataSourceKey:a.key})}),n.setVisible(!1),i()})}}},_f={type:"void","x-decorator":"RoleRecordProvider",properties:{block:{type:"void","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:{name:"dataSourcesCollections",targetKey:"name",filterTargetKey:"name",fields:[{type:"integer",name:"title",interface:"input",uiSchema:{title:'{{t("Collection display name")}}',type:"number","x-component":"Input",required:!0}},{type:"string",name:"name",interface:"input",uiSchema:{title:'{{t("Collection name")}}',type:"string","x-component":"Input"}},{type:"string",name:"type",interface:"input",uiSchema:{title:'{{t("Resource type")}}',type:"string","x-component":"Select",enum:[{label:'{{t("Collection")}}',value:"collection",color:"green"},{label:'{{t("Association")}}',value:"association",color:"blue"}]}},{type:"string",name:"usingConfig",interface:"input",uiSchema:{title:'{{t("Permission policy")}}',type:"string","x-component":"Select",enum:[{label:'{{t("Individual")}}',value:"resourceAction",color:"orange"},{label:'{{t("General")}}',value:"strategy",color:"default"}]}},{type:"hasMany",name:"fields",target:"fields",collectionName:"collections",sourceKey:"name",targetKey:"name",uiSchema:{}}]},association:{sourceKey:"name",targetKey:"name"},request:{resource:"roles.dataSourcesCollections",action:"list",params:{pageSize:20,filter:{hidden:{$isFalsy:!0},dataSourceKey:"{{dataSourceKey}}"},sort:["sort"],appends:["fields"]}}},properties:{[V.uid()]:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',default:{$and:[{title:{$includes:""}},{name:{$includes:""}}]},"x-action":"filter","x-component":"Filter.Action","x-use-component-props":"cm.useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"}}},table1:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"name",useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{column0:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{title:{type:"number","x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column3:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{usingConfig:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column4:{type:"void",title:'{{t("Actions")}}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{configure:{type:"void",title:'{{t("Configure")}}',"x-component":"Action.Link","x-component-props":{type:"primary",disabled:"{{ isReadOnly }}"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:Ff},title:'{{t("Configure permission")}}',properties:{usingActionsConfig:{title:'{{t("Permission policy")}}',"x-component":"Radio.Group","x-decorator":"FormItem",default:!1,enum:[{value:!1,label:'{{t("General")}}'},{value:!0,label:'{{t("Individual")}}'}],"x-reactions":{target:"actions",fulfill:{state:{hidden:"{{!$self.value}}"}}}},actions:{"x-component":"RolesResourcesActions","x-decorator":"FormItem"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:wf}}}}}}}}}}}}}}}}}},qo={name:"dataSources",filterTargetKey:"name",targetKey:"name",fields:[{type:"string",name:"displayName",interface:"input",uiSchema:{title:'{{t("Display name")}}',type:"number","x-component":"Input",required:!0}},{type:"string",name:"key",interface:"input",uiSchema:{title:'{{t("Name")}}',type:"number","x-component":"Input",required:!0}}]},Pf={type:"object",properties:{block1:{type:"void","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:qo,resourceName:"dataSources",request:{resource:"dataSources",action:"list",params:{pageSize:50,showAnonymous:!0,appends:[]}}},"x-component":"CollectionProvider_deprecated","x-component-props":{collection:qo},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{}},table:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"key",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{column1:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{displayName:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{key:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column4:{type:"void",title:'{{t("Actions")}}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{view:{type:"void",title:'{{t("Configure")}}',"x-component":"Action.Link","x-decorator":"ACLActionProvider","x-acl-action":"roles:update","x-component-props":{},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"PermissionProvider",title:'{{t("Configure permissions")}}',properties:{tabs1:{type:"void","x-component":"Tabs","x-component-props":{},properties:{tab1:{type:"void",title:'{{t("General action permissions")}}',"x-component":"Tabs.TabPane","x-component-props":{},properties:{role:{"x-component":"RoleConfigure"}}},tab2:{type:"void",title:'{{t("Action permissions")}}',"x-component":"Tabs.TabPane","x-component-props":{},properties:{roleCollectionsSchema:_f}}}}}}}}}}}}}}}}}},pt=d.createContext([]);pt.displayName="AvailableActionsContext";const Df=e=>{const{data:t,loading:o}=r.useRequest({resource:"availableActions",action:"list"});return o?s.jsx(S.Spin,{}):s.jsx(pt.Provider,{value:t==null?void 0:t.data,children:e.children})},Go=()=>d.useContext(pt),If=()=>{var a,c;const e=r.useRecord(),{appName:t}=q.useParams(),{useRolesManagerContext:o}=r.useApp().scopes,{role:n}=o(),i=((a=n==null?void 0:n.name)==null?void 0:a.endsWith("_owner"))||((c=n==null?void 0:n.name)==null?void 0:c.endsWith("_manager"));return s.jsx("div",{children:s.jsx(r.SchemaComponentContext.Provider,{value:{designable:!1},children:s.jsx(Df,{children:s.jsx(r.SchemaComponent,{schema:Pf,components:{SettingCenterPermissionProvider:r.SettingCenterPermissionProvider,PermissionProvider:$f},scope:{dataSourceKey:e.key,appName:t,isReadOnly:i}})})})})},Of=()=>{var l,p;const{update:e}=d.useContext(be),{t}=B.useTranslation(),{key:o}=r.useRecord(),n=r.useApp(),{useRolesManagerContext:i}=n.scopes,{role:a}=i(),c=((l=a==null?void 0:a.name)==null?void 0:l.endsWith("_owner"))||((p=a==null?void 0:a.name)==null?void 0:p.endsWith("_manager"));return s.jsx(r.SchemaComponent,{schema:{type:"void",name:"form","x-component":"Form","x-component-props":{useValues:u=>{const m=r.useAPIClient(),y=d.useContext(xe);return r.useRequest(()=>m.resource(`dataSources/${o}/roles`).get({filterByTk:y.name}).then(C=>{var A,v;const F=(A=C==null?void 0:C.data)==null?void 0:A.data;return(v=F.snippets)==null||v.forEach(b=>{F[b]=!0}),{data:F}}),u)},effects(){fe.onFieldChange("*",(u,m)=>O(this,null,function*(){m.modified&&(yield e(u,m))}))}},properties:{"strategy.actions":{description:t("All collections use general action permissions by default; permission configured individually will override the default one."),"x-component":"StrategyActions","x-component-props":{isReadOnly:c}}}}})},Mf=e=>{var o;if(!e)return{};const t={};return(o=e==null?void 0:e.forEach)==null||o.call(e,n=>{const[i,a]=n.split(":");t[i]=a||"all"}),t},Uo=e=>{const t=[];for(const o in e)if(Object.prototype.hasOwnProperty.call(e,o)){const n=e[o];n==="all"?t.push(o):t.push(`${o}:${n}`)}return t},kf=_.connect(e=>{const{onChange:t,isReadOnly:o}=e,n=Go(),i=r.useCompile(),{t:a}=B.useTranslation(),c=_.useField(),l=Mf(c.value);return s.jsx("div",{children:s.jsx(S.Table,{size:"small",pagination:!1,columns:[{dataIndex:"displayName",title:a("Action display name"),render:p=>i(p)},{dataIndex:"onNewRecord",title:a("Action type"),render:p=>p?s.jsx(S.Tag,{color:"green",children:a("Action on new records")}):s.jsx(S.Tag,{color:"geekblue",children:a("Action on existing records")})},{dataIndex:"enabled",title:a("Allow"),render:(p,u)=>s.jsx(S.Checkbox,{disabled:o,checked:p,onChange:m=>{p?delete l[u.name]:l[u.name]="all",t(Uo(l))}})},{dataIndex:"scope",title:a("Data scope"),render:(p,u)=>!u.onNewRecord&&s.jsx(S.Select,{disabled:o,"data-testid":"select-data-scope",popupMatchSelectWidth:!1,size:"small",value:p,options:[{label:a("All records"),value:"all"},{label:a("Own records"),value:"own"}],onChange:m=>{l[u.name]=m,t(Uo(l))}})}],dataSource:n==null?void 0:n.map(p=>{let u="all",m=!1;return l[p.name]&&(m=!0,u=l[p.name]),N(T({},p),{enabled:m,scope:u})})})})}),Ef=Zo.createStyles(({css:e})=>e`
    .ant-table-cell {
      > .ant-space-horizontal {
        .ant-space-item-split:has(+ .ant-space-item:empty) {
          display: none;
        }
      }
    }
  `),jf=(e="main")=>({name:`dataSources/${e}/rolesResourcesScopes`,fields:[{type:"string",name:"name",interface:"input",uiSchema:{title:'{{t("Scope name")}}',type:"string","x-component":"Input",required:!0}}]}),Kf=()=>{const{name:e}=d.useContext(ye),t=r.useFormBlockContext();return d.useEffect(()=>{t.form.setInitialValues({resourceName:e})},[e]),{form:t.form}},Nf=e=>{const t=jf(e);return{type:"object",properties:{scope:{"x-component":"RecordPicker","x-component-props":{size:"small",fieldNames:{label:"name",value:"id"},multiple:!1,association:{target:"rolesResourcesScopes"},onChange:"{{ onChange }}"},properties:{selector:{type:"void",title:'{{ t("Select record") }}',"x-component":"RecordPicker.Selector","x-component-props":{className:"nb-record-picker-selector"},properties:{tableBlock:{type:"void","x-decorator":"TableSelectorProvider","x-decorator-props":{collection:t,resource:`dataSources/${e}/rolesResourcesScopes`,action:"list",params:{pageSize:20},useParams(){return{filter:{$or:[{resourceName:d.useContext(ye).name},{resourceName:null}]}}},rowKey:"id"},"x-component":"BlockItem",properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{create:{type:"void",title:'{{ t("Add new") }}',"x-action":"create","x-component":"Action","x-component-props":{icon:"PlusOutlined",openMode:"drawer",type:"primary"},properties:{drawer:{type:"void",title:'{{ t("Add record") }}',"x-component":"Action.Container","x-component-props":{className:"nb-action-popup"},properties:{formBlock:{type:"void","x-decorator":"FormBlockProvider","x-decorator-props":{resource:`dataSources/${e}/rolesResourcesScopes`,collection:t},"x-component":"CardItem",properties:{form:{type:"void","x-component":"FormV2","x-use-component-props":Kf,properties:{name:{type:"string","x-component":"CollectionField","x-decorator":"FormItem"},scope:{type:"object",title:'{{t("Data scope")}}',name:"filter","x-decorator":"FormItem","x-component":"Filter","x-use-component-props":()=>{const o=d.useContext(ye);return{options:r.useFilterFieldOptions(o.fields)}},"x-component-props":{dynamicComponent:r.VariableInput}},actions:{type:"void","x-component":"ActionBar","x-component-props":{layout:"one-column",style:{marginTop:24}},properties:{create:{title:'{{ t("Submit") }}',"x-action":"submit","x-component":"Action","x-use-component-props":"useCreateActionProps","x-component-props":{type:"primary",htmlType:"submit"}}}}}}}}}}}}}},value:{type:"array","x-component":"TableV2.Selector","x-use-component-props":"useTableSelectorProps","x-component-props":{rowKey:"id",rowSelection:{type:"checkbox"}},properties:{column1:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column",properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},actions:{type:"void",title:'{{ t("Actions") }}',"x-action-column":"actions","x-component":"TableV2.Column",properties:{actions:{type:"void","x-decorator":"DndContext","x-component":"Space","x-component-props":{split:"|"},properties:{edit:{type:"void",title:'{{ t("Edit") }}',"x-action":"update","x-decorator":"ACLActionProvider","x-component":"Action.Link","x-component-props":{openMode:"drawer",icon:"EditOutlined"},properties:{drawer:{type:"void",title:'{{ t("Edit record") }}',"x-component":"Action.Container","x-component-props":{className:"nb-action-popup"},properties:{formBlock:{type:"void","x-decorator":"FormBlockProvider","x-decorator-props":{resource:`dataSources/${e}/rolesResourcesScopes`,collection:t,action:"get",useParams:"{{ useParamsFromRecord }}"},"x-component":"CardItem",properties:{form:{type:"void","x-component":"FormV2","x-use-component-props":"useFormBlockProps",properties:{name:{type:"string","x-component":"CollectionField","x-decorator":"FormItem"},scope:{type:"object",title:'{{t("Data scope")}}',name:"filter","x-decorator":"FormItem","x-component":"Filter","x-use-component-props":()=>{const o=d.useContext(ye);return{options:r.useFilterFieldOptions(o.fields)}},"x-component-props":{dynamicComponent:r.VariableInput}},actions:{type:"void","x-component":"ActionBar","x-component-props":{layout:"one-column",style:{marginTop:24}},properties:{update:{title:'{{ t("Submit") }}',"x-action":"submit","x-component":"Action","x-use-component-props":"useUpdateActionProps","x-component-props":{type:"primary",htmlType:"submit"}}}}}}}}}}}},destroy:{title:'{{ t("Delete") }}',"x-action":"destroy","x-decorator":"ACLActionProvider","x-component":"Action.Link","x-use-component-props":"useDestroyActionProps","x-component-props":{icon:"DeleteOutlined",confirm:{title:"{{t('Delete record')}}",content:"{{t('Are you sure you want to delete it?')}}"}}}}}}}}}}},footer:{"x-component":"Action.Container.Footer","x-component-props":{},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{},properties:{submit:{title:'{{ t("Submit") }}',"x-action":"submit","x-component":"Action","x-use-component-props":"usePickActionProps","x-component-props":{type:"primary",htmlType:"submit"}}}}}}}}}}}}},zo=d.createContext(null);zo.displayName="RolesResourcesScopesSelectedRowKeysContext";const Bf=e=>{const[t,o]=d.useState([]);return s.jsx(zo.Provider,{value:[t,o],children:e.children})},Vf=e=>{const t=d.useMemo(()=>fe.createForm({values:{scope:e.value}}),[]),{key:o}=r.useRecord(),n=Nf(o);return s.jsx(r.FormProvider,{form:t,children:s.jsx(r.SchemaComponent,{components:{RolesResourcesScopesSelectedRowKeysProvider:Bf},scope:{onChange(i){var a;(a=e==null?void 0:e.onChange)==null||a.call(e,i)}},schema:n})})},Lf=e=>{var o;const t={};return(o=e==null?void 0:e.forEach)==null||o.call(e,n=>{n.name&&(t[n.name]=n,t[n.name].scope=X.isEmpty(n.scope)?null:n.scope)}),t},ye=d.createContext({});ye.displayName="RoleResourceCollectionContext";const qf=_.connect(e=>{var b,f;const{styles:t}=Ef(),o=g=>{const h=g.map($=>N(T({},$),{scope:X.isEmpty($.scope)?null:$.scope}));e.onChange(h)},n=r.useRecord(),i=Go(),a=n.fields,c=r.useCompile(),{t:l}=B.useTranslation(),p=_.useField(),u=Lf(p.value||[]),m=(g,h)=>{var D;const $=u==null?void 0:u[g];return $?(D=$==null?void 0:$.fields)==null?void 0:D.includes(h):!1},y=i.filter(g=>g.allowConfigureFields),C=a==null?void 0:a.map(g=>{const h=T({},g);for(const $ of y)h[$.name]=m($.name,g.name);return h}),F=g=>{var h;u[g]?delete u[g]:u[g]={name:g,fields:(h=a==null?void 0:a.map)==null?void 0:h.call(a,$=>$.name)},o(Object.values(u))},A=(g,h)=>{u[g]?(u[g].scope=h,o(Object.values(u))):(F(g),u[g].scope=h,o(Object.values(u)))},v={};for(const g of y)v[g.name]=(a==null?void 0:a.length)===((f=(b=u==null?void 0:u[g.name])==null?void 0:b.fields)==null?void 0:f.length);return s.jsx("div",{children:s.jsx(ye.Provider,{value:n,children:s.jsxs(se.FormLayout,{layout:"vertical",children:[s.jsx(se.FormItem,{label:l("Action permission"),children:s.jsx(S.Table,{className:t,size:"small",pagination:!1,columns:[{dataIndex:"displayName",title:l("Action display name"),render:g=>c(g)},{dataIndex:"onNewRecord",title:l("Action type"),render:g=>g?s.jsx(S.Tag,{color:"green",children:l("Action on new records")}):s.jsx(S.Tag,{color:"geekblue",children:l("Action on existing records")})},{dataIndex:"enabled",title:l("Allow"),render:(g,h)=>s.jsx(S.Checkbox,{checked:g,onChange:()=>{F(h.name)}})},{dataIndex:"scope",title:l("Data scope"),render:(g,h)=>!h.onNewRecord&&s.jsx(Vf,{value:g,onChange:$=>{A(h.name,$)}})}],dataSource:i==null?void 0:i.map(g=>{let h=!1,$=null;return u[g.name]&&(h=!0,g.onNewRecord||($=u[g.name].scope)),N(T({},g),{enabled:h,scope:$})})})}),s.jsx(se.FormItem,{label:l("Field permission"),children:s.jsx(S.Table,{className:t,pagination:!1,dataSource:C,columns:[{dataIndex:["uiSchema","title"],title:l("Field display name"),render:(g,h)=>c(g)||h.name},...y.map(g=>{const h=v==null?void 0:v[g.name];return{dataIndex:g.name,title:s.jsxs(s.Fragment,{children:[s.jsx(S.Checkbox,{checked:h,onChange:()=>{var D;const $=u[g.name]||{name:g.name};h?$.fields=[]:$.fields=(D=a==null?void 0:a.map)==null?void 0:D.call(a,P=>P.name),u[g.name]=$,o(Object.values(u))}}),c(g.displayName)]}),render:($,D)=>s.jsx(S.Checkbox,{checked:$,onChange:()=>{const P=u[g.name]||{name:g.name},j=P.fields||[];if($){const I=j.indexOf(D.name);j.splice(I,1)}else j.push(D.name);P.fields=j,u[g.name]=P,o(Object.values(u))}})}})]})})]})})})}),Gf={type:"object",properties:{[V.uid()]:{"x-component":"DataSourceTable"}}},xe=d.createContext({});xe.displayName="CurrentRolesContext";const Uf=({role:e})=>s.jsx(S.Card,{"data-testid":"acl-pane-card",bordered:!1,children:s.jsx(xe.Provider,{value:e,children:s.jsx(r.SchemaComponent,{components:{MenuConfigure:r.MenuConfigure,RoleConfigure:Of,RolesResourcesActions:qf,DataSourceTable:If,StrategyActions:kf,SettingsCenterConfigure:r.SettingsCenterConfigure,SettingCenterProvider:r.SettingCenterProvider,ResourceActionProvider:r.ResourceActionProvider,RoleRecordProvider:Tf},schema:Gf})})});class Se extends r.Plugin{constructor(){super(...arguments);Jo(this,"types",new Map)}load(){return O(this,null,function*(){this.app.addComponents({DataSourcePermissionManager:Uf}),this.app.use(tn),this.app.pluginSettingsManager.add(K,{title:`{{t("Data sources", { ns: "${K}" })}}`,icon:"ClusterOutlined",showTabs:!1,aclSnippet:"pm.data-source-manager*"}),this.app.pluginSettingsManager.add(`${K}.list`,{title:`{{t("Data sources", { ns: "${K}" })}}`,Component:zy,sort:1,skipAclConfigure:!0,aclSnippet:"pm.data-source-manager"}),this.app.pluginSettingsManager.add(`${K}/:name`,{title:s.jsx(Ct,{}),icon:"ClusterOutlined",isTopLevel:!1,sort:100,skipAclConfigure:!0,aclSnippet:"pm.data-source-manager"}),this.app.pluginSettingsManager.add(`${K}/main`,{title:s.jsx(Ct,{}),icon:"ClusterOutlined",isTopLevel:!1,sort:100,skipAclConfigure:!0,aclSnippet:"pm.data-source-manager.data-source-main"}),this.app.pluginSettingsManager.add(`${K}/main.collections`,{title:`{{t("Collections", { ns: "${K}" })}}`,Component:Af,topLevelName:`${K}/main`,pluginKey:K,skipAclConfigure:!0,aclSnippet:"pm.data-source-manager.data-source-main"}),this.app.pluginSettingsManager.add(`${K}/:name.collections`,{title:`{{t("Collections", { ns: "${K}" })}}`,Component:Vy,topLevelName:`${K}/:name`,pluginKey:K,skipAclConfigure:!0,aclSnippet:"pm.data-source-manager.data-source-main"}),this.app.dataSourceManager.addDataSources(this.getThirdDataSource.bind(this),ft)})}setDataSources(){return O(this,null,function*(){var n;const o=yield this.app.apiClient.request({url:"dataSources:listEnabled",method:"GET",params:{paginate:!1}});return(n=o==null?void 0:o.data)==null?void 0:n.data})}getThirdDataSource(){return O(this,null,function*(){var n;const o=yield this.app.apiClient.request({url:"dataSources:listEnabled",method:"GET",params:{paginate:!1,appends:["collections"]}});return(n=o==null?void 0:o.data)==null?void 0:n.data})}registerType(o,n){this.types.set(o,n)}}k.PluginDataSourceManagerClient=Se,k.default=Se,Object.defineProperties(k,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
