(function(e,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react-i18next"),require("react/jsx-runtime"),require("react"),require("antd"),require("@ant-design/icons"),require("ahooks")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react-i18next","react/jsx-runtime","react","antd","@ant-design/icons","ahooks"],t):(e=typeof globalThis!="undefined"?globalThis:e||self,t(e["@nocobase/plugin-logger"]={},e["@nocobase/client"],e["react-i18next"],e.jsxRuntime,e.react,e.antd,e["@ant-design/icons"],e.ahooks))})(this,function(e,t,s,r,a,p,m,f){"use strict";var Y=Object.defineProperty,Z=Object.defineProperties;var R=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var V=(e,t,s)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,A=(e,t)=>{for(var s in t||(t={}))ee.call(t,s)&&V(e,s,t[s]);if(N)for(var s of N(t))te.call(t,s)&&V(e,s,t[s]);return e},L=(e,t)=>Z(e,R(t));var S=(e,t,s)=>new Promise((r,a)=>{var p=h=>{try{f(s.next(h))}catch(y){a(y)}},m=h=>{try{f(s.throw(h))}catch(y){a(y)}},f=h=>h.done?r(h.value):Promise.resolve(h.value).then(p,m);f((s=s.apply(e,t)).next())});const h="logger";function y(g){return t.i18n.t(g,{ns:h})}function E(){return s.useTranslation(h)}const{Paragraph:q,Text:b}=p.Typography,j=a.memo(()=>{const{t:g}=E();return r.jsxs(p.Typography,{children:[r.jsxs(q,{children:[r.jsx(b,{code:!0,children:"[app]/request_*.log"})," - ",g("API request and response logs")]}),r.jsxs(q,{children:[r.jsx(b,{code:!0,children:"[app]/system_*.log"})," -"," ",g("Application, database, plugins and other system logs, the error level logs will be sent to")," ",r.jsx(b,{code:!0,children:"[app]/system_error_*.log"})]}),r.jsxs(q,{children:[r.jsx(b,{code:!0,children:"[app]/sql_*.log"})," -"," ",g("SQL execution logs, printed by Sequelize when the db logging is enabled")]})]})});j.displayName="Tips";const v=a.memo(g=>{const{token:C}=p.theme.useToken(),{t:H}=E(),w=f.useMemoizedFn(H),_=t.useAPIClient(),[U,O]=a.useState(["0"]),[x,Q]=a.useState(""),[G,z]=a.useState(!0),[D,I]=a.useState([]),{data:K}=t.useRequest(()=>_.resource("logger").list().then(o=>{var d;return(d=o.data)==null?void 0:d.data})),P=a.useCallback((o,d)=>o.map((i,c)=>{const n=`${d}-${c}`;return typeof i=="string"?{title:i,key:n,icon:r.jsx(m.FileOutlined,{})}:{title:i.name,key:n,icon:r.jsx(m.FolderOutlined,{}),children:P(i.files,n)}}),[]),k=a.useMemo(()=>{const o=K||[];return[{title:w("All"),key:"0",children:P(o,"0")}]},[K,P,w]),J=o=>{O(o),z(!1)},W=o=>{const{value:d}=o.target,i=n=>n.reduce((l,u)=>{var T;return(T=u.title)!=null&&T.includes(d)&&l.push(u),u.children?[...l,...i(u.children)]:l},[]),c=i(k).map(n=>n.key);O(c),Q(d),z(!0),I([])},B=a.useMemo(()=>{if(!x)return k;const o=d=>{const i=[];for(const c of d){const n=c.title,l=n.indexOf(x),u=n.substring(0,l),T=n.substring(l+x.length),F=l>-1?r.jsxs("span",{children:[u,r.jsx("span",{style:{color:C.colorPrimary},children:x}),T]}):r.jsx("span",{children:n});if(l>-1)i.push(L(A({},c),{title:F}));else if(c.children){const $=o(c.children);$.length&&i.push(L(A({},c),{title:F,children:$}))}}return i};return o(k)},[x,k,C.colorPrimary]),X=()=>{const o=(i,c)=>i.reduce((n,l)=>{let u=l.title;return u=l.key==="0"?u:`${c}/${u}`,l.children?[...n,...o(l.children,l.key==="0"?"":u)]:(D.includes(l.key)&&l.key!=="0"&&n.push(u),n)},[]),d=o(k,"");d.length&&_.request({url:"logger:download",method:"post",responseType:"blob",data:{files:d}}).then(i=>{const c=window.URL.createObjectURL(new Blob([i.data],{type:"application/gzip"})),n=document.createElement("a");n.setAttribute("href",c),n.setAttribute("download","logs.tar.gz"),n.click(),n.remove()}).catch(i=>{console.log(i)})};return r.jsxs(p.Card,{style:{minHeight:"700px"},children:[r.jsx(p.Alert,{message:"",description:r.jsx(j,{}),type:"info",showIcon:!0}),r.jsx(p.Input.Search,{style:{marginTop:16,width:"450px"},placeholder:w("Search"),onChange:W}),r.jsx("div",{style:{maxHeight:"400px",width:"450px",overflow:"auto",border:"1px solid",marginTop:"6px",marginBottom:"10px",borderColor:C.colorBorder},children:B.length?r.jsx(p.Tree,{checkable:!0,showIcon:!0,showLine:!0,checkedKeys:D,expandedKeys:U,autoExpandParent:G,onExpand:J,onCheck:o=>I(o),treeData:B}):r.jsx(t.Empty,{})}),r.jsxs(p.Button,{type:"primary",onClick:X,children:[w("Download")," (.tar.gz)"]})]})});v.displayName="LogsDownloader";class M extends t.Plugin{afterAdd(){return S(this,null,function*(){})}beforeLoad(){return S(this,null,function*(){})}load(){return S(this,null,function*(){this.app.pluginSettingsManager.add("logger",{title:y("Logger"),icon:"FileTextOutlined",Component:v})})}}e.PluginLoggerClient=M,e.default=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
