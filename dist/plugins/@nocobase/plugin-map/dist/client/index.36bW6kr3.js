(function(z,s){typeof exports=="object"&&typeof module!="undefined"?s(exports,require("react/jsx-runtime"),require("@nocobase/client"),require("react"),require("@ant-design/icons"),require("@formily/react"),require("ahooks"),require("antd"),require("react-i18next"),require("react-router-dom"),require("@nocobase/utils/client"),require("lodash"),require("@formily/antd-v5"),require("@formily/shared")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@nocobase/client","react","@ant-design/icons","@formily/react","ahooks","antd","react-i18next","react-router-dom","@nocobase/utils/client","lodash","@formily/antd-v5","@formily/shared"],s):(z=typeof globalThis!="undefined"?globalThis:z||self,s(z["@nocobase/plugin-map"]={},z.jsxRuntime,z["@nocobase/client"],z.react,z["@ant-design/icons"],z["@formily/react"],z.ahooks,z.antd,z["react-i18next"],z["react-router-dom"],z["@nocobase/utils"],z.lodash,z["@formily/antd-v5"],z["@formily/shared"]))})(this,function(z,s,n,g,R,G,V,w,ne,le,We,ke,Ye,Je){"use strict";var Kt=Object.defineProperty,Ut=Object.defineProperties;var Nt=Object.getOwnPropertyDescriptors;var Ve=Object.getOwnPropertySymbols;var Gt=Object.prototype.hasOwnProperty,qt=Object.prototype.propertyIsEnumerable;var Pe=(z,s,n)=>s in z?Kt(z,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):z[s]=n,O=(z,s)=>{for(var n in s||(s={}))Gt.call(s,n)&&Pe(z,n,s[n]);if(Ve)for(var n of Ve(s))qt.call(s,n)&&Pe(z,n,s[n]);return z},Z=(z,s)=>Ut(z,Nt(s));var F=(z,s,n)=>(Pe(z,typeof s!="symbol"?s+"":s,n),n);var ye=(z,s,n)=>new Promise((g,R)=>{var G=ne=>{try{w(n.next(ne))}catch(le){R(le)}},V=ne=>{try{w(n.throw(ne))}catch(le){R(le)}},w=ne=>ne.done?g(ne.value):Promise.resolve(ne.value).then(G,V);w((n=n.apply(z,s)).next())});const fe="map";function Q(e){return`{{t('${e}', { ns: '${fe}', nsMode: 'fallback' })}}`}function J(){return ne.useTranslation([fe,"client"],{nsMode:"fallback"})}const Fe=[{label:Q("AMap"),value:"amap"},{label:Q("Google Maps"),value:"google"}],be="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAA/CAMAAAC7OkrPAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAEJQTFRFAAAA8Yti8Yti8Itj8Iti74tj8Itj8YtiKwADKwADKhw5Kh07KwADKwADKwADKwAD4odn1YBlKwADKwADKwADKwAD/5y7LQAAABZ0Uk5TAP/8/f/B/PYOHjY3CCozLP3XCSkvMhA05K4AAAC4SURBVHic7dXLDoIwEIXhwSsoLSrw/q8qbSAiMy3/oivj2czmS5omnVORdapVJJFKBSEL2mrrUurbpdXa5dTH5dXi9tTsGNtX0TFG1OT+7PdY2YdEGd0FuFmUwXWm5UAZbCTKYA3SUrXZQTHLHbUy2OlsMO0ultLsajLlbEWZMEUZ+ig5E6YKM2GqMBOmGKubW1D3ps6g1nnvA5uGa5Os85E9nmF2ebYkzeKhc9wre4V+GMeh317hDfXgCWigIGJbAAAAAElFTkSuQmCC",ue="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAA/CAYAAACM5Lr9AAAFkklEQVR42s3VaWxUVRjG8ddiEKPRxAQTCVSWLnZaWmjpTgulpYUBExP9Agou4IKAogUKAgItlNJCgUIXINFPfsFoDCjibkQRI0QIICAQWUpZugKtpcv0+DxyYqaTe2/vTLf58Etu7znnPf+0k44opQw5i5qsjIFs2APHoBZatFq+02vZeq94yyKs0dOjsAzOTCtuVtNKWtX0UpeaXqHU07tgt4ZnvuMa93Avz/CsniE2WIQV2iEaCDnQ8F/MTgZ4h2d4ljNgmZ4pFszDpmIRIuFP57YWDMcFu7uHMziLMyEKxJBl2MbbM6DZub2NQ3sUZ3K2vkMMGIdNKbi1ADqcZe1q2i7VKzibd8BCEE8GUQ3PQ4ez3KWcGNCbeAfv0neKm85hWRvqo+Hu1LJ2HuwTvAt3tkAciKbDIDO/7iE4l7X9rpqCA30pa3uLwt3nYRAIuIfV5mcWN6msnapf8G405IGQMGry+prB0DiloqPfwng3G3SLDltXnTt5S6PK3NnRr9jAFhDJyLsZAJcz8SGcjOr+xAa0XGGTpOfeSMrYUKcyKlx+gS1oSkbY9VXpm2+rjHKXX2ALm2TS2qq96duaVHp5u19gC5skbc3V05N23FWT8NIfsIVNkra6siGttE2llbX7h9JWhaZ6mfj+lfaJZW3Kn6DJJRNWXWqbgN+Y39jRqtDUKKkrL15PxfdjammrfyhpVmiqlNQVfx9KwX/cFJT6A7awSVLeu1CeUlinxu9o8QsphbUKTWUyfvn5Wcm511QSXvoDtrBJkpedewzaE/E58wdsYZMopSQ55+z+pKK6fo9KKqpXaDkAIgxLWnomK3H1JZVQ0tyv2ICW6XAvLHHJ6QD4K6GgRsVjQ3/g3WzQLffCKGHJqfHgisOXaNy2f/oU7+TdukGIUW5xJ0vic6+oWGzsS7yTd4NoncPiF594GC7FFlSrcVub+gTv4p36btE6h1Fc9nFn7IpzKmZrY5/gXbwTxI0O8xD77rGPYtZeVtE42Jt4B+8C8WAcNu6dPwZDzVh8PYzdcqdXcDbvgMdBPDHEOG7R0Xkxqy6oKAzpDZzNO0AMmIfFvH1kABwZk1epIotv9yjOxOyj+g4xYB4W/dbvlAAdozGsJ3Gmni0mzMPGLvyN6IMo/NojNt/qEZyFmR+CWLAIW3CYaDDUR+D/TTgGdwdncJaeKRbMw8bM/9XdosjlZ5VjU0O3cAZngXTBPCzqzV/cPQAXHeuqVBgu8IVj/TXFGXqWdME8LHLez55mRSw9qUI31fuEZzFjNogNFmFvHPQUACfC8IUbUlTvlbDcSsWzeobYYB42+vWfjDwbnn3c6zCewdnnQGwyD4t47UcjAXA2JO+qCi6ss4V7eUafFZuswn4wM8ex+LgKwqV2cC/OzAXxgnlY+KvfmxkIVaPyr6tRhbWWuId79RnxgnmYY+53VlaHLj2lRm6stRSSc0ph7xoQL1mEzfnWyhPQNrKgGgE1hrjGPTAExEvmYWGvfNOVPUErz6vhiDDCNez5GMQHVmFfd2Vq6MLD6smCGkNc4x4QH5iHPfXyV125H64NX1eFkOpO+I5reo/4wDws9KUDdhSPxFdNIGLc8R3XQHxkFfalHYnB8w6qYRuqO+E7roH4yDws5MX9dtwHlYF5lQi6qYjPfKfXxEcWYbO/sKtsBP50QxFFI/D/De8qQLrBPCwYizY9M2r+of/D+Mx3ID6zDJv1uaVwGfAIBDqGJsbhZ9eQ/BuK+OwYlhzPNe7hXh9Yhe0zwqBB4IAYouCZn1wIXH5GEZ/d1sjBMzzrBfOwoBf2GWFYBMS4C03JWRA087OaoBmf3uCz5zrP8Kx9lmF7jXiE2RbBs95ghB0MIo8/pS0OeJAzvOBLmKY//BAGURBN+jmMa3qPkLdh/wKOL8SpLbnYFgAAAABJRU5ErkJggg==",Oe=(e,o,t)=>{const r=o==null?void 0:o.reduce((a,i,l)=>l===o.length-1&&(t==="o2m"||t==="m2m")?a==null?void 0:a.map(m=>m[i]).filter(m=>m!=null):a==null?void 0:a[i],e);return t==="o2m"||t==="m2m"?r:[r]};var Ze=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Xe(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ee={exports:{}};(function(e,o){(function(t,r){e.exports=r()})(Ze,function(){function t(c){var b=[];return c.AMapUI&&b.push(r(c.AMapUI)),c.Loca&&b.push(a(c.Loca)),Promise.all(b)}function r(c){return new Promise(function(b,u){var d=[];if(c.plugins)for(var M=0;M<c.plugins.length;M+=1)l.AMapUI.plugins.indexOf(c.plugins[M])==-1&&d.push(c.plugins[M]);if(m.AMapUI===i.failed)u("前次请求 AMapUI 失败");else if(m.AMapUI===i.notload){m.AMapUI=i.loading,l.AMapUI.version=c.version||l.AMapUI.version,M=l.AMapUI.version;var D=document.body||document.head,K=document.createElement("script");K.type="text/javascript",K.src="https://webapi.amap.com/ui/"+M+"/main.js",K.onerror=function(I){m.AMapUI=i.failed,u("请求 AMapUI 失败")},K.onload=function(){if(m.AMapUI=i.loaded,d.length)window.AMapUI.loadUI(d,function(){for(var I=0,q=d.length;I<q;I++){var Y=d[I].split("/").slice(-1)[0];window.AMapUI[Y]=arguments[I]}for(b();v.AMapUI.length;)v.AMapUI.splice(0,1)[0]()});else for(b();v.AMapUI.length;)v.AMapUI.splice(0,1)[0]()},D.appendChild(K)}else m.AMapUI===i.loaded?c.version&&c.version!==l.AMapUI.version?u("不允许多个版本 AMapUI 混用"):d.length?window.AMapUI.loadUI(d,function(){for(var I=0,q=d.length;I<q;I++){var Y=d[I].split("/").slice(-1)[0];window.AMapUI[Y]=arguments[I]}b()}):b():c.version&&c.version!==l.AMapUI.version?u("不允许多个版本 AMapUI 混用"):v.AMapUI.push(function(I){I?u(I):d.length?window.AMapUI.loadUI(d,function(){for(var q=0,Y=d.length;q<Y;q++){var U=d[q].split("/").slice(-1)[0];window.AMapUI[U]=arguments[q]}b()}):b()})})}function a(c){return new Promise(function(b,u){if(m.Loca===i.failed)u("前次请求 Loca 失败");else if(m.Loca===i.notload){m.Loca=i.loading,l.Loca.version=c.version||l.Loca.version;var d=l.Loca.version,M=l.AMap.version.startsWith("2"),D=d.startsWith("2");if(M&&!D||!M&&D)u("JSAPI 与 Loca 版本不对应！！");else{M=l.key,D=document.body||document.head;var K=document.createElement("script");K.type="text/javascript",K.src="https://webapi.amap.com/loca?v="+d+"&key="+M,K.onerror=function(I){m.Loca=i.failed,u("请求 AMapUI 失败")},K.onload=function(){for(m.Loca=i.loaded,b();v.Loca.length;)v.Loca.splice(0,1)[0]()},D.appendChild(K)}}else m.Loca===i.loaded?c.version&&c.version!==l.Loca.version?u("不允许多个版本 Loca 混用"):b():c.version&&c.version!==l.Loca.version?u("不允许多个版本 Loca 混用"):v.Loca.push(function(I){I?u(I):u()})})}if(!window)throw Error("AMap JSAPI can only be used in Browser.");var i;(function(c){c.notload="notload",c.loading="loading",c.loaded="loaded",c.failed="failed"})(i||(i={}));var l={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},m={AMap:i.notload,AMapUI:i.notload,Loca:i.notload},v={AMap:[],AMapUI:[],Loca:[]},C=[],A=function(c){typeof c=="function"&&(m.AMap===i.loaded?c(window.AMap):C.push(c))};return{load:function(c){return new Promise(function(b,u){if(m.AMap==i.failed)u("");else if(m.AMap==i.notload){var d=c.key,M=c.version,D=c.plugins;d?(window.AMap&&location.host!=="lbs.amap.com"&&u("禁止多种API加载方式混用"),l.key=d,l.AMap.version=M||l.AMap.version,l.AMap.plugins=D||l.AMap.plugins,m.AMap=i.loading,M=document.body||document.head,window.___onAPILoaded=function(I){if(delete window.___onAPILoaded,I)m.AMap=i.failed,u(I);else for(m.AMap=i.loaded,t(c).then(function(){b(window.AMap)}).catch(u);C.length;)C.splice(0,1)[0]()},D=document.createElement("script"),D.type="text/javascript",D.src="https://webapi.amap.com/maps?callback=___onAPILoaded&v="+l.AMap.version+"&key="+d+"&plugin="+l.AMap.plugins.join(","),D.onerror=function(I){m.AMap=i.failed,u(I)},M.appendChild(D)):u("请填写key")}else if(m.AMap==i.loaded)if(c.key&&c.key!==l.key)u("多个不一致的 key");else if(c.version&&c.version!==l.AMap.version)u("不允许多个版本 JSAPI 混用");else{if(d=[],c.plugins)for(M=0;M<c.plugins.length;M+=1)l.AMap.plugins.indexOf(c.plugins[M])==-1&&d.push(c.plugins[M]);d.length?window.AMap.plugin(d,function(){t(c).then(function(){b(window.AMap)}).catch(u)}):t(c).then(function(){b(window.AMap)}).catch(u)}else if(c.key&&c.key!==l.key)u("多个不一致的 key");else if(c.version&&c.version!==l.AMap.version)u("不允许多个版本 JSAPI 混用");else{var K=[];if(c.plugins)for(M=0;M<c.plugins.length;M+=1)l.AMap.plugins.indexOf(c.plugins[M])==-1&&K.push(c.plugins[M]);A(function(){K.length?window.AMap.plugin(K,function(){t(c).then(function(){b(window.AMap)}).catch(u)}):t(c).then(function(){b(window.AMap)}).catch(u)})}})},reset:function(){delete window.AMap,delete window.AMapUI,delete window.Loca,l={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},m={AMap:i.notload,AMapUI:i.notload,Loca:i.notload},v={AMap:[],AMapUI:[],Loca:[]}}}})})(Ee);var He=Ee.exports;const Qe=Xe(He),Le="map-configuration",ve=e=>`NOCODE_PLUGIN_MAP_CONFIGURATION_${e}`,Ae=e=>{const o=g.useMemo(()=>{const r=sessionStorage.getItem(ve(e));return r&&JSON.parse(r)},[e]),{data:t}=n.useRequest({resource:Le,action:"get",params:{type:e}},{onSuccess(r){sessionStorage.setItem(ve(e),JSON.stringify(r==null?void 0:r.data))},refreshOnWindowFocus:!1,refreshDeps:[],manual:!!o});return o||(t==null?void 0:t.data)},$e=e=>{const{aMap:o,toCenter:t}=e,{t:r}=J(),a=g.useRef(),[i,l]=g.useState([]);g.useEffect(()=>{o==null||o.plugin("AMap.PlaceSearch",()=>{a.current=new o.PlaceSearch({city:"全国",pageSize:30})})},[o]);const{run:m}=V.useDebounceFn(C=>{a.current&&a.current.search(C||" ",(A,c)=>{if(A==="complete")l(c.poiList.pois.map(b=>Z(O({},b),{label:`${b.name}-${b.address}`,value:b.id})));else{if(A==="no_data"){l([]);return}w.message.error(r("Please configure the AMap securityCode or securityHost correctly"))}})},{wait:300}),v=C=>{const A=i.find(c=>c.value===C);A!=null&&A.location&&t(A.location)};return s.jsx("div",{className:n.css`
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        width: calc(100% - 20px);
      `,children:s.jsx(w.Select,{showSearch:!0,allowClear:!0,style:{background:"rgba(255, 255, 255, 0.8)"},placeholder:r("Enter keywords to search"),filterOption:!1,onSearch:m,onSelect:v,options:i,popupMatchSelectWidth:!1})})},Me={point:{mouseTool:"marker",propertyKey:"position",overlay:"Marker"},polygon:{mouseTool:"polygon",editor:"PolygonEditor",propertyKey:"path",overlay:"Polygon"},lineString:{mouseTool:"polyline",editor:"PolylineEditor",propertyKey:"path",overlay:"Polyline"},circle:{mouseTool:"circle",editor:"CircleEditor",transformOptions(e){return{center:e.slice(0,2),radius:e[2]}},overlay:"Circle"}},Ce=g.forwardRef((e,o)=>{const{accessKey:t,securityJsCode:r}=Ae(e.mapType)||{},{value:a,onChange:i,block:l=!1,readonly:m,disabled:v=l,zoom:C=13,overlayCommonOptions:A}=e,{t:c}=J(),b=G.useFieldSchema(),u=g.useRef(),d=g.useRef(),M=g.useRef(),[D,K]=g.useState([]),[I,q]=g.useState(""),{getField:Y}=n.useCollection_deprecated(),U=g.useMemo(()=>{if(e.type)return e.type;const f=Y(b==null?void 0:b.name);return f==null?void 0:f.interface},[e==null?void 0:e.type,b==null?void 0:b.name]),T=g.useRef(),B=g.useRef(null),ee=le.useNavigate(),H=g.useRef(`nocobase-map-${U||""}-${Date.now().toString(32)}`),{modal:te}=w.App.useApp(),[X]=g.useState(O({strokeWeight:5,strokeColor:"#4e9bff",fillColor:"#4e9bff",strokeOpacity:1},A)),se=V.useMemoizedFn(()=>{T.current&&T.current.remove()}),oe=V.useMemoizedFn(()=>{(!v||l)&&U!=="point"&&B.current&&(B.current.setTarget(T.current),B.current.open())}),P=V.useMemoizedFn((f,p=!1)=>{let h=null;if(U==="point"){const{lat:S,lng:N}=f.getPosition();h=[N,S]}else if(U==="polygon"||U==="lineString"){if(h=f.getPath().map(S=>[S.lng,S.lat]),h.length<2)return}else if(U==="circle"){const S=f.getCenter(),N=f.getRadius();h=[S.lng,S.lat,N]}p||(se(),T.current=f,oe()),i==null||i(h)}),W=V.useMemoizedFn((f=U)=>{const p=Me[f];if(p&&"editor"in p&&!B.current)return B.current=new u.current[p.editor](d.current,null,{createOptions:X,editOptions:X,controlPoint:Z(O({},X),{strokeWeight:3}),midControlPoint:Z(O({},X),{strokeWeight:2,fillColor:"#fff"})}),B.current.on("adjust",function({target:h}){P(h,!0)}),B.current.on("move",function({target:h}){P(h,!0)}),B.current}),E=V.useMemoizedFn((f=U)=>{var h;if(!M.current||(h=B.current)!=null&&h.getTarget())return;const p=Me[f];p&&M.current[p.mouseTool](O({},X))}),$=V.useMemoizedFn((f=U)=>{M.current||(M.current=new u.current.MouseTool(d.current),M.current.on("draw",function({obj:p}){P(p)}),E(f))}),x=(f,p)=>{d.current&&d.current.setZoomAndCenter(18,f,p)},L=()=>{const f=()=>{se(),B.current&&(B.current.setTarget(),B.current.close()),i==null||i(null)};te.confirm({title:c("Clear the canvas"),content:c("Are you sure to clear the canvas?"),okText:c("Confirm"),cancelText:c("Cancel"),getContainer:()=>document.getElementById(H.current),onOk(){f()}})},y=()=>{T.current&&d.current.setFitView([T.current])},k=g.useCallback((f=U,p=a,h)=>{const S=Me[f];if(!S)return;const N=O(O({},X),h);return"transformOptions"in S?Object.assign(N,S.transformOptions(p)):"propertyKey"in S&&(N[S.propertyKey]=p),new u.current[S.overlay](N)},[X]),_=(f=U,p=a,h)=>{if(!u.current)return;const S=k(f,p,h);return S.setMap(d.current),S};g.useEffect(()=>{if(!u.current||!a||!m&&T.current)return;const f=_();d.current.setFitView([f]),T.current=f,v||(W(),oe())},[a,D,U,X,v,m]),g.useEffect(()=>{var f,p,h;M.current&&(v?((f=M.current)==null||f.close(),(p=B.current)==null||p.close()):(E(),(h=B.current)==null||h.open()))},[v]),g.useEffect(()=>{!u.current||!U||v||($(),W())},[v,D,U]),g.useEffect(()=>{var p,h;if(!a&&(M.current||B.current)&&(se(),B.current&&(B.current.setTarget(),B.current.close()),i==null||i(null)),!M.current||!B.current)return;B.current.getTarget()?(h=(p=M.current).close)==null||h.call(p):E()},[U,a]),g.useEffect(()=>{if(!t||d.current)return;r&&(window._AMapSecurityConfig={[r.endsWith("_AMapService")?"serviceHOST":"securityJsCode"]:r});const f=window.define;return window.define=void 0,Qe.load({key:t,version:"2.0",plugins:["AMap.MouseTool","AMap.PolygonEditor","AMap.PolylineEditor","AMap.CircleEditor"]}).then(p=>(window.define=f,requestIdleCallback(()=>{d.current=new p.Map(H.current,{resizeEnable:!0,zoom:C}),u.current=p,q(""),K([])}))).catch(p=>{typeof p=="string"?p.includes("多个不一致的 key")?q(c("The AccessKey is incorrect, please check it")):q(p):(p==null?void 0:p.type)==="error"&&q("Something went wrong, please refresh the page and try again")}),()=>{var p;(p=d.current)==null||p.destroy(),u.current=null,d.current=null,M.current=null,B.current=null}},[t,U,r]),g.useImperativeHandle(o,()=>({setOverlay:_,getOverlay:k,createMouseTool:$,createEditor:W,executeMouseTool:E,aMap:u.current,map:d.current,overlay:T.current,mouseTool:()=>M.current,editor:()=>B.current,errMessage:I}));const j=n.useApp();return!t||I?s.jsx(w.Alert,{action:s.jsx(w.Button,{type:"primary",onClick:()=>ee(j.pluginSettingsManager.getRoutePath("map")),children:c("Go to the configuration page")}),message:I||c("Please configure the AccessKey and SecurityJsCode first"),type:"error"}):s.jsxs("div",{className:n.css`
        position: relative;
        height: 500px;
      `,id:H.current,style:e==null?void 0:e.style,children:[!u.current&&s.jsx("div",{className:n.css`
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
          `,children:s.jsx(w.Spin,{})}),v?null:s.jsxs(s.Fragment,{children:[s.jsx($e,{toCenter:x,aMap:u.current}),s.jsx("div",{className:n.css`
              position: absolute;
              bottom: 80px;
              right: 20px;
              z-index: 10;
            `,children:s.jsx(w.Button,{onClick:y,disabled:!T.current,type:"primary",shape:"round",size:"large",icon:s.jsx(R.SyncOutlined,{})})}),U!=="point"?s.jsx("div",{className:n.css`
                position: absolute;
                bottom: 20px;
                left: 10px;
                z-index: 2;
                pointer-events: none;
              `,children:s.jsx(w.Alert,{message:c("Click to select the starting point and double-click to end the drawing"),type:"info"})}):null,s.jsx("div",{className:n.css`
              position: absolute;
              bottom: 20px;
              right: 20px;
              z-index: 2;
            `,children:s.jsx(w.Button,{disabled:!a,style:{height:"40px"},onClick:L,type:"primary",danger:!0,children:c("Clear")})})]})]})});Ce.displayName="AMapComponent";const Re=e=>{var P,W,E,$;const{collectionField:o,fieldNames:t,dataSource:r,fixedBlock:a,zoom:i,setSelectedRecordKeys:l,lineSort:m}=n.useProps(e),{name:v,getPrimaryKey:C}=n.useCollection_deprecated(),{getCollectionJoinField:A}=n.useCollectionManager_deprecated(),c=C(),[b,u]=g.useState(!1),d=g.useRef(),M=(W=(P=d.current)==null?void 0:P.aMap)==null?void 0:W.GeometryUtil,[D,K]=g.useState(),[I,q]=g.useState(""),{t:Y}=J(),U=n.useCompile(),{isConnected:T,doFilter:B}=n.useFilterAPI(),[,ee]=g.useState(null),H=g.useRef(I);H.current=I;const te=(x,L)=>{const y=x.getExtData(),k=typeof L=="undefined"?y.selected:!L;y.selected=!k,"setIcon"in x&&x.setIcon(new d.current.aMap.Icon({imageSize:[19,32],image:k?ue:be})),x.setOptions(O({extData:y},k?{strokeColor:"#4e9bff",fillColor:"#4e9bff"}:{strokeColor:"#F18b62",fillColor:"#F18b62"}))},X=()=>{var x,L,y;d.current&&((x=d.current)==null||x.mouseTool().close(!0),(L=d.current)==null||L.editor().setTarget(null),(y=d.current)==null||y.editor().close())};g.useEffect(()=>{var x,L,y,k;if(I==="selection")return(x=d.current)!=null&&x.editor()?(k=d.current)==null||k.executeMouseTool("polygon"):((L=d.current)==null||L.createEditor("polygon"),(y=d.current)==null||y.createMouseTool("polygon")),()=>{X()}},[I]),g.useEffect(()=>{if(I)return()=>{var x;H.current||(x=d.current)==null||x.map.getAllOverlays().forEach(L=>{te(L,!1)})}},[I]);const se=V.useMemoizedFn(()=>{var _,j,f;const x=(_=d.current)==null?void 0:_.editor().getTarget(),L=(j=d.current)==null?void 0:j.map.getAllOverlays(),y=L==null?void 0:L.filter(p=>{if(!(p===x||p.getExtData().id===void 0))return"getPosition"in p?M.isPointInRing(p.getPosition(),x==null?void 0:x.getPath()):M.doesRingRingIntersect(p.getPath(),x==null?void 0:x.getPath())}),k=y==null?void 0:y.map(p=>(te(p,!0),p.getExtData().id));l(p=>k==null?void 0:k.concat(p)),x==null||x.remove(),(f=d.current)==null||f.editor().close()});g.useEffect(()=>{var _,j,f;if(!o||!d.current||!r)return;const x=Array.isArray(t==null?void 0:t.field)&&(t==null?void 0:t.field.length)>1?t==null?void 0:t.field.slice(0,-1):t==null?void 0:t.field,L=A([v,...x].flat().join(".")),y=r.map(p=>{var S;const h=(S=Oe(p,t==null?void 0:t.field,L==null?void 0:L.interface))==null?void 0:S.filter(Boolean);return h!=null&&h.length?h.map(N=>{var ie;return(ie=d.current)==null?void 0:ie.setOverlay(o.type,N,{strokeColor:"#4e9bff",fillColor:"#4e9bff",cursor:"pointer",label:{direction:"bottom",offset:[0,5],content:t!=null&&t.marker?U(p[t.marker]):void 0},extData:{id:p[c]}})}):[]}).flat().filter(Boolean);(j=(_=d.current)==null?void 0:_.map)==null||j.setFitView(y);const k=y.map(p=>{const h=S=>{const N=S.target,re=N.getExtData();if(!re)return;if(H.current){H.current==="click"&&(l(ae=>re.selected?ae.filter(Ie=>Ie!==re.id):[...ae,re.id]),te(N));return}const ie=r.find(ae=>re.id===ae[c]);if(T){ee(ae=>(ae&&ze(ae),ae===p?(ze(p),B(null),null):(tt(p),B(ie[c],Ie=>Ie.field||c,"$eq"),p)));return}ie&&K(ie)};return p.on("click",h),()=>p.off("click",h)});if(o.type==="point"&&(m!=null&&m.length)&&(y==null?void 0:y.length)>1){const p=y.map(S=>S.getPosition());y[0].setzIndex(13),y[y.length-1].setzIndex(13);const h=(S=!0)=>{var N,re;if((N=d.current)!=null&&N.map)return new AMap.Text({label:{direction:"top",offset:[0,0],content:Y(S?"Start point":"End point")},position:p[S?0:p.length-1],map:(re=d.current)==null?void 0:re.map})};y.push(...[(f=d.current)==null?void 0:f.setOverlay("lineString",p,{strokeColor:"#4e9bff",fillColor:"#4e9bff",strokeWeight:2,cursor:"pointer"}),h(),h(!1)].filter(Boolean))}return()=>{y.forEach(p=>{p.remove()}),k.forEach(p=>p())}},[r,b,t,v,c,o.type,T,m]),g.useEffect(()=>{setTimeout(()=>{l([])})},[r]);const oe=x=>{d.current=x,u(!!(x!=null&&x.map)&&!x.errMessage)};return s.jsxs("div",{className:n.css`
        position: relative;
        height: 100%;
      `,children:[s.jsx("div",{className:n.css`
          position: absolute;
          left: 10px;
          top: 10px;
          z-index: 999;
        `,children:b&&!((E=d.current)!=null&&E.errMessage)?s.jsxs(w.Space,{direction:"vertical",children:[s.jsx(w.Button,{style:{color:I?void 0:"#F18b62",borderColor:"currentcolor"},onClick:x=>{x.stopPropagation(),q("")},icon:s.jsx(R.EnvironmentOutlined,{})}),s.jsx(w.Button,{style:{color:I==="selection"?"#F18b62":void 0,borderColor:"currentcolor"},onClick:x=>{x.stopPropagation(),q("selection")},icon:s.jsx(R.ExpandOutlined,{})}),I==="selection"?s.jsx(w.Button,{type:"primary",icon:s.jsx(R.CheckOutlined,{}),title:Y("Confirm selection"),onClick:se}):null]}):null}),s.jsx(et,{record:D,setVisible:K}),s.jsx(Ce,Z(O({},($=o==null?void 0:o.uiSchema)==null?void 0:$["x-component-props"]),{ref:oe,style:{height:a?"100%":null},zoom:i,disabled:!0,block:!0,overlayCommonOptions:{strokeColor:"#F18b62",fillColor:"#F18b62"}}))]})},et=e=>{const{setVisible:o,record:t}=e;J(),n.useCollection();const r=n.useCollectionParentRecordData(),a=G.useFieldSchema(),i=g.useMemo(()=>a.reduceProperties((l,m)=>m.name==="drawer"?m:l,null),[a]);return i&&s.jsx(n.ActionContextProvider,{value:{visible:!!t,setVisible:o},children:s.jsx(n.RecordProvider,{record:t,parent:r,children:s.jsx(n.VariablePopupRecordProvider,{children:s.jsx(G.RecursionField,{schema:i,name:i.name})})})})};function ze(e){e.dom?e.dom.style.filter="none":e.setOptions&&e.setOptions({strokeColor:"#4e9bff",fillColor:"#4e9bff"})}function tt(e){e.dom?e.dom.style.filter="brightness(1.2) contrast(1.2) hue-rotate(180deg)":e.setOptions&&e.setOptions({strokeColor:"#F18b62",fillColor:"#F18b62"})}const De=({type:e,children:o})=>{const{t}=J(),[r,a]=V.useBoolean(!1),i=n.useAPIClient(),[l]=w.Form.useForm(),m=Ae(e);g.useEffect(()=>{m&&(l.setFieldsValue(m),a.toggle())},[m]);const v=g.useMemo(()=>i.resource(Le),[i]),C=A=>{v.set(Z(O({},A),{type:e})).then(c=>{sessionStorage.removeItem(ve(e)),a.toggle(),w.message.success(t("Saved successfully"))}).catch(c=>{w.message.success(t("Saved failed"))})};return s.jsxs(w.Form,{disabled:r,form:l,layout:"vertical",onFinish:C,children:[o,r?s.jsx(w.Button,{disabled:!1,onClick:a.toggle,children:t("Edit")}):s.jsx(w.Form.Item,{children:s.jsx(w.Button,{disabled:!1,type:"primary",htmlType:"submit",children:t("Save")})})]})},ot={amap:()=>{const{t:e}=J();return s.jsxs(De,{type:"amap",children:[s.jsx(w.Form.Item,{required:!0,name:"accessKey",label:e("Access key"),children:s.jsx(w.Input,{})}),s.jsx(w.Form.Item,{required:!0,name:"securityJsCode",label:e("securityJsCode or serviceHost"),children:s.jsx(w.Input,{})})]})},google:()=>{const{t:e}=J();return s.jsx(De,{type:"google",children:s.jsx(w.Form.Item,{required:!0,name:"accessKey",label:e("Api key"),children:s.jsx(w.Input,{})})})}},rt=Fe.map(e=>Z(O({},e),{component:ot[e.value]})),nt=()=>{const e=n.useCompile(),o=le.useLocation(),t=new URLSearchParams(o.search);return s.jsx(w.Card,{bordered:!0,children:s.jsx(w.Tabs,{type:"card",defaultActiveKey:t.get("tab"),children:rt.map(r=>s.jsx(w.Tabs.TabPane,{tab:e(r.label),children:s.jsx(r.component,{type:r.value})},r.value))})})};/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */function st(e,o,t,r){function a(i){return i instanceof t?i:new t(function(l){l(i)})}return new(t||(t=Promise))(function(i,l){function m(A){try{C(r.next(A))}catch(c){l(c)}}function v(A){try{C(r.throw(A))}catch(c){l(c)}}function C(A){A.done?i(A.value):a(A.value).then(m,v)}C((r=r.apply(e,o||[])).next())})}var it=function e(o,t){if(o===t)return!0;if(o&&t&&typeof o=="object"&&typeof t=="object"){if(o.constructor!==t.constructor)return!1;var r,a,i;if(Array.isArray(o)){if(r=o.length,r!=t.length)return!1;for(a=r;a--!==0;)if(!e(o[a],t[a]))return!1;return!0}if(o.constructor===RegExp)return o.source===t.source&&o.flags===t.flags;if(o.valueOf!==Object.prototype.valueOf)return o.valueOf()===t.valueOf();if(o.toString!==Object.prototype.toString)return o.toString()===t.toString();if(i=Object.keys(o),r=i.length,r!==Object.keys(t).length)return!1;for(a=r;a--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[a]))return!1;for(a=r;a--!==0;){var l=i[a];if(!e(o[l],t[l]))return!1}return!0}return o!==o&&t!==t};const Te="__googleMapsScriptId";var de;(function(e){e[e.INITIALIZED=0]="INITIALIZED",e[e.LOADING=1]="LOADING",e[e.SUCCESS=2]="SUCCESS",e[e.FAILURE=3]="FAILURE"})(de||(de={}));class ce{constructor({apiKey:o,authReferrerPolicy:t,channel:r,client:a,id:i=Te,language:l,libraries:m=[],mapIds:v,nonce:C,region:A,retries:c=3,url:b="https://maps.googleapis.com/maps/api/js",version:u}){if(this.callbacks=[],this.done=!1,this.loading=!1,this.errors=[],this.apiKey=o,this.authReferrerPolicy=t,this.channel=r,this.client=a,this.id=i||Te,this.language=l,this.libraries=m,this.mapIds=v,this.nonce=C,this.region=A,this.retries=c,this.url=b,this.version=u,ce.instance){if(!it(this.options,ce.instance.options))throw new Error(`Loader must not be called again with different options. ${JSON.stringify(this.options)} !== ${JSON.stringify(ce.instance.options)}`);return ce.instance}ce.instance=this}get options(){return{version:this.version,apiKey:this.apiKey,channel:this.channel,client:this.client,id:this.id,libraries:this.libraries,language:this.language,region:this.region,mapIds:this.mapIds,nonce:this.nonce,url:this.url,authReferrerPolicy:this.authReferrerPolicy}}get status(){return this.errors.length?de.FAILURE:this.done?de.SUCCESS:this.loading?de.LOADING:de.INITIALIZED}get failed(){return this.done&&!this.loading&&this.errors.length>=this.retries+1}createUrl(){let o=this.url;return o+="?callback=__googleMapsCallback",this.apiKey&&(o+=`&key=${this.apiKey}`),this.channel&&(o+=`&channel=${this.channel}`),this.client&&(o+=`&client=${this.client}`),this.libraries.length>0&&(o+=`&libraries=${this.libraries.join(",")}`),this.language&&(o+=`&language=${this.language}`),this.region&&(o+=`&region=${this.region}`),this.version&&(o+=`&v=${this.version}`),this.mapIds&&(o+=`&map_ids=${this.mapIds.join(",")}`),this.authReferrerPolicy&&(o+=`&auth_referrer_policy=${this.authReferrerPolicy}`),o}deleteScript(){const o=document.getElementById(this.id);o&&o.remove()}load(){return this.loadPromise()}loadPromise(){return new Promise((o,t)=>{this.loadCallback(r=>{r?t(r.error):o(window.google)})})}importLibrary(o){return this.execute(),google.maps.importLibrary(o)}loadCallback(o){this.callbacks.push(o),this.execute()}setScript(){var o,t;if(document.getElementById(this.id)){this.callback();return}const r={key:this.apiKey,channel:this.channel,client:this.client,libraries:this.libraries.length&&this.libraries,v:this.version,mapIds:this.mapIds,language:this.language,region:this.region,authReferrerPolicy:this.authReferrerPolicy};Object.keys(r).forEach(i=>!r[i]&&delete r[i]),!((t=(o=window==null?void 0:window.google)===null||o===void 0?void 0:o.maps)===null||t===void 0)&&t.importLibrary||(i=>{let l,m,v,C="The Google Maps JavaScript API",A="google",c="importLibrary",b="__ib__",u=document,d=window;d=d[A]||(d[A]={});const M=d.maps||(d.maps={}),D=new Set,K=new URLSearchParams,I=()=>l||(l=new Promise((q,Y)=>st(this,void 0,void 0,function*(){var U;yield m=u.createElement("script"),m.id=this.id,K.set("libraries",[...D]+"");for(v in i)K.set(v.replace(/[A-Z]/g,T=>"_"+T[0].toLowerCase()),i[v]);K.set("callback",A+".maps."+b),m.src=this.url+"?"+K,M[b]=q,m.onerror=()=>l=Y(Error(C+" could not load.")),m.nonce=this.nonce||((U=u.querySelector("script[nonce]"))===null||U===void 0?void 0:U.nonce)||"",u.head.append(m)})));M[c]?console.warn(C+" only loads once. Ignoring:",i):M[c]=(q,...Y)=>D.add(q)&&I().then(()=>M[c](q,...Y))})(r);const a=this.libraries.map(i=>this.importLibrary(i));a.length||a.push(this.importLibrary("core")),Promise.all(a).then(()=>this.callback(),i=>{const l=new ErrorEvent("error",{error:i});this.loadErrorCallback(l)})}reset(){this.deleteScript(),this.done=!1,this.loading=!1,this.errors=[],this.onerrorEvent=null}resetIfRetryingFailed(){this.failed&&this.reset()}loadErrorCallback(o){if(this.errors.push(o),this.errors.length<=this.retries){const t=this.errors.length*Math.pow(2,this.errors.length);console.error(`Failed to load Google Maps script, retrying in ${t} ms.`),setTimeout(()=>{this.deleteScript(),this.setScript()},t)}else this.onerrorEvent=o,this.callback()}callback(){this.done=!0,this.loading=!1,this.callbacks.forEach(o=>{o(this.onerrorEvent)}),this.callbacks=[]}execute(){if(this.resetIfRetryingFailed(),this.done)this.callback();else{if(window.google&&window.google.maps&&window.google.maps.version){console.warn("Google Maps already loaded outside @googlemaps/js-api-loader.This may result in undesirable behavior as options and script parameters may not match."),this.callback();return}this.loading||(this.loading=!0,this.setScript())}}}const at=e=>{const{toCenter:o,mapRef:t}=e,{t:r}=J(),a=g.useRef(),[i,l]=g.useState([]);g.useEffect(()=>{google.maps.importLibrary("places").then(C=>{a.current=new C.AutocompleteService}).catch(()=>{w.message.error("Please configure the Google API Key correctly")})},[t]);const{run:m}=V.useDebounceFn(C=>{a.current&&a.current.getPlacePredictions({input:C||" "},(A,c)=>{if(c===google.maps.places.PlacesServiceStatus.OK)l(A.map(b=>{const u=b.structured_formatting;return Z(O({},b),{label:`${u.main_text}${u.secondary_text?" "+u.secondary_text:""}`,value:b.place_id})}));else{l([]);return}})},{wait:300}),v=C=>{const A=i.find(b=>b.value===C);new google.maps.places.PlacesService(t.current).getDetails({placeId:A.place_id,fields:["geometry"]},(b,u)=>{u===google.maps.places.PlacesServiceStatus.OK&&o(b.geometry.location)})};return s.jsx("div",{className:n.css`
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        width: calc(100% - 20px);
      `,children:s.jsx(w.Select,{id:"google-map-search",showSearch:!0,allowClear:!0,style:{background:"rgba(255, 255, 255, 0.8)"},placeholder:r("Enter keywords to search"),filterOption:!1,onSearch:m,onSelect:v,options:i})})},pe=e=>({url:e,scaledSize:{width:19,height:32},labelOrigin:new google.maps.Point(19/2,42)}),lt=()=>new Promise(e=>{const o=()=>{e({lat:37.4224764,lng:-122.0842499})};navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{const{latitude:r,longitude:a}=t.coords;e({lat:r,lng:a})},()=>{o()}):o()}),ct=e=>e==="point"?"marker":e==="lineString"?"polyline":e,pt={point:{propertyKey:"position",overlay:"Marker"},polygon:{propertyKey:"paths",overlay:"Polygon"},lineString:{propertyKey:"path",overlay:"Polyline"},circle:{transformOptions(e){return{center:new google.maps.LatLng(e[1],e[0]),radius:e[2]}},overlay:"Circle"}},xe=g.forwardRef((e,o)=>{const{value:t,onChange:r,block:a=!1,readonly:i,disabled:l=a,zoom:m=13,overlayCommonOptions:v}=e,{accessKey:C}=Ae(e.mapType)||{},{t:A}=J(),{getField:c}=n.useCollection_deprecated(),b=G.useFieldSchema(),u=g.useRef(),d=g.useRef(),M=g.useRef(),[D,K]=g.useState([]),[I,q]=g.useState(""),Y=n.useAPIClient(),{modal:U}=w.App.useApp(),T=g.useMemo(()=>{if(e.type)return e.type;const f=c(b==null?void 0:b.name);return f==null?void 0:f.interface},[e==null?void 0:e.type,b==null?void 0:b.name]),B=g.useRef(ct(T)),[ee]=g.useState(O({strokeWeight:5,strokeColor:"#4e9bff",fillColor:"#4e9bff",strokeOpacity:1,editable:!l,draggable:!l},v)),H=le.useNavigate(),te=g.useRef(),X=g.useRef(new Set),se=V.useMemoizedFn(f=>{if(X.current.forEach(p=>{X.current.delete(p)}),"getPath"in f){const p=f.getPath();["insert_at","remove_at","set_at"].forEach(h=>{X.current.add(p.addListener(h,()=>{x(f,!0)}).remove)})}else f instanceof google.maps.Circle&&["center_changed","radius_changed"].forEach(p=>{X.current.add(f.addListener(p,()=>{x(f,!0)}).remove)})}),oe=V.useMemoizedFn(()=>{var f;M.current&&(M.current.unbindAll(),M.current.setMap(null)),T!=="point"&&((f=u.current)==null||f.setDrawingMode(null))}),P=V.useMemoizedFn(f=>{d.current&&(d.current.setCenter(f),d.current.setZoom(m))}),W=V.useMemoizedFn(f=>{oe(),se(f),M.current=f}),E=V.useMemoizedFn(f=>{const p=new google.maps.LatLngBounds;f.forEach(h=>{if(h instanceof google.maps.Marker)p.extend(h.getPosition());else if(h instanceof google.maps.Polyline||h instanceof google.maps.Polygon){const S=h.getPath();for(let N=0;N<S.getLength();N++)p.extend(S.getAt(N))}else h instanceof google.maps.Circle&&p.union(h.getBounds())}),d.current.setCenter(p.getCenter())}),$=()=>{M.current&&E([M.current])},x=V.useMemoizedFn((f,p=!1)=>{let h=null;if(T==="point"){const{lat:S,lng:N}=f.getPosition();h=[N(),S()]}else if(T==="polygon"||T==="lineString"){if(h=f.getPath().getArray().map(S=>[S.lng(),S.lat()]),h.length<2)return}else if(T==="circle"){const S=f.getCenter(),N=f.getRadius();h=[S.lng(),S.lat(),N]}p||W(f),r==null||r(h)}),L=V.useMemoizedFn((f=!1,p)=>{const h=Z(O(O({},ee),p),{map:d.current});return u.current=new google.maps.drawing.DrawingManager({drawingMode:B.current,drawingControl:!1,markerOptions:Z(O({},h),{icon:pe(ue)}),polygonOptions:h,polylineOptions:h,circleOptions:h,map:d.current}),f||u.current.addListener("overlaycomplete",S=>{const N=S.overlay;x(N)}),u.current}),y=V.useMemoizedFn((f=T,p=t,h)=>{const S=pt[f];if(!S)return;const N=O(Z(O({},ee),{icon:pe(ue)}),h);return"transformOptions"in S?Object.assign(N,S.transformOptions(p)):"propertyKey"in S&&(N[S.propertyKey]=Array.isArray(p[0])?p.map(ie=>new google.maps.LatLng(ie[1],ie[0])):new google.maps.LatLng(p[1],p[0])),new google.maps[S.overlay](N)}),k=V.useMemoizedFn((f=T,p=t,h)=>d.current?y(f,p,Z(O({},h),{map:d.current})):void 0);g.useEffect(()=>{var p,h;if(!t&&d.current&&(oe(),(h=(p=u==null?void 0:u.current)==null?void 0:p.setDrawingMode)==null||h.call(p,B.current),r==null||r(null)),!d.current||!t||!i&&M.current)return;const f=k();W(f),E([f])},[t,D,T,l,i,k,E,W]),g.useEffect(()=>{if(!C||d.current||!te.current)return;let f;try{f=new ce({apiKey:C,version:"weekly",language:Y.auth.getLocale()})}catch(p){q(A("Load google maps failed, Please check the Api key and refresh the page"));return}return console.error=(p,...h)=>{p!=null&&p.includes("InvalidKeyMapError")&&q(A("Load google maps failed, Please check the Api key and refresh the page")),We.captureException(p,...h)},Promise.all([f.importLibrary("drawing"),f.importLibrary("core"),f.importLibrary("geometry")]).then(p=>ye(this,null,function*(){const h=yield lt();d.current=new google.maps.Map(te.current,{zoom:m,center:h,mapTypeId:google.maps.MapTypeId.ROADMAP,zoomControl:!1,streetViewControl:!1,panControl:!1,mapTypeControl:!1,fullscreenControl:!1}),q(""),K([])})).catch(p=>{if(p instanceof Error){q(p.message);return}}),()=>{var p,h;(p=d.current)==null||p.unbindAll(),d.current=null,(h=u.current)==null||h.unbindAll()}},[C,Y.auth,T,m]),g.useEffect(()=>{!d.current||!T||l||u.current||L()},[L,l,D,T]),g.useImperativeHandle(o,()=>({setOverlay:k,getOverlay:y,setFitView:E,createDraw:L,map:d.current,overlay:M.current,drawingManager:u.current,errMessage:I}));const _=V.useMemoizedFn(()=>{const f=()=>{oe(),u.current.setDrawingMode(B.current),r==null||r(null)};U.confirm({title:A("Clear the canvas"),content:A("Are you sure to clear the canvas?"),okText:A("Confirm"),cancelText:A("Cancel"),getContainer:()=>te.current,onOk(){f()}})}),j=n.useApp();return!C||I?s.jsx(w.Alert,{action:s.jsx(w.Button,{type:"primary",onClick:()=>H(j.pluginSettingsManager.getRoutePath("map")+"?tab=google"),children:A("Go to the configuration page")}),message:I||A("Please configure the Api key first"),type:"error"}):s.jsxs("div",{className:n.css`
          position: relative;
          height: 500px;
        `,children:[!d.current&&s.jsx("div",{className:n.css`
              position: absolute;
              inset: 0;
              display: flex;
              align-items: center;
              justify-content: center;
            `,children:s.jsx(w.Spin,{})}),l?null:s.jsxs(s.Fragment,{children:[d.current&&s.jsx(at,{toCenter:P,mapRef:d}),s.jsx("div",{className:n.css`
                position: absolute;
                bottom: 80px;
                right: 20px;
                z-index: 10;
              `,children:s.jsx(w.Button,{onClick:$,disabled:!M.current,type:"primary",shape:"round",size:"large",icon:s.jsx(R.SyncOutlined,{})})}),T==="lineString"||T==="polygon"?s.jsx("div",{className:n.css`
                  position: absolute;
                  bottom: 20px;
                  left: 10px;
                  z-index: 2;
                  pointer-events: none;
                `,children:s.jsx(w.Alert,{message:A("Click to select the starting point and double-click to end the drawing"),type:"info"})}):null,s.jsx("div",{className:n.css`
                position: absolute;
                bottom: 20px;
                right: 20px;
                z-index: 2;
              `,children:s.jsx(w.Button,{disabled:!t,style:{height:"40px"},onClick:_,type:"primary",danger:!0,children:A("Clear")})})]}),s.jsx("div",{ref:te,className:n.css`
            width: 100%;
            height: 100%;
          `,style:e==null?void 0:e.style})]})});xe.displayName="GoogleMapsComponent";const me="google-maps-overlay-id",Be="google-maps-overlay-selected",ut=n.css`
  margin-top: 6px;
  padding: 2px 4px;
  background: #fff;
  border: 1px solid #0000f5;
`,dt=n.css`
  margin-top: -64px;
  padding: 2px 4px;
  background: #fff;
  border: 1px solid #0000f5;
`,ft=e=>{const{collectionField:o,fieldNames:t,dataSource:r,fixedBlock:a,zoom:i,setSelectedRecordKeys:l,lineSort:m}=n.useProps(e),{getPrimaryKey:v}=n.useCollection_deprecated(),C=v(),{marker:A="id"}=t,[c,b]=g.useState(!1),u=g.useRef(),[d,M]=g.useState(),[D,K]=g.useState(""),{t:I}=J(),q=n.useCompile(),{isConnected:Y,doFilter:U}=n.useFilterAPI(),[,T]=g.useState(null),B=g.useRef(D),ee=g.useRef(null),H=g.useRef([]);B.current=D;const{getCollectionJoinField:te}=n.useCollectionManager_deprecated(),X=(P,W)=>{const E=typeof W!="undefined"?!W:P.get(Be);P.set(Be,!E),P.setOptions(O({},E?{icon:pe(ue),strokeColor:"#4e9bff",fillColor:"#4e9bff"}:{icon:pe(be),strokeColor:"#F18b62",fillColor:"#F18b62"}))};g.useEffect(()=>{var W,E,$,x;if(D!=="selection")return;u.current&&!((W=u.current)!=null&&W.drawingManager)&&(u.current.drawingManager=(E=u.current)==null?void 0:E.createDraw(!0,{editable:!0,draggable:!0}));const P=new Set;return($=u.current)==null||$.drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON),(x=u.current)==null||x.drawingManager.addListener("overlaycomplete",L=>{var _;const y=L.overlay;(_=u.current)==null||_.drawingManager.setDrawingMode(null),ee.current=y;const k=y.getPath();["insert_at","remove_at","set_at"].forEach(j=>{P.add(k.addListener(j,()=>{}).remove)})}),()=>{var L,y,k,_;P.forEach(j=>{j()}),u.current&&((L=ee.current)==null||L.unbindAll(),(y=ee.current)==null||y.setMap(null),ee.current=null,(k=u.current)==null||k.drawingManager.setDrawingMode(null),(_=u.current)==null||_.drawingManager.unbindAll())}},[D]),g.useEffect(()=>{if(D)return()=>{B.current||H.current.forEach(P=>{X(P,!1)})}},[D]);const se=V.useMemoizedFn(()=>{var L;const P=ee.current,W=H.current,E=google.maps.geometry.poly,x=W.filter(y=>{if(!(y===P||y.get(me)===void 0))return y instanceof google.maps.Marker?E.containsLocation(y.getPosition(),P):y instanceof google.maps.Circle?E.containsLocation(y.getCenter(),P):y.getPath().getArray().some(k=>E.containsLocation(k,P))}).map(y=>(X(y,!0),y.get(me)));l(y=>x.concat(y)),P==null||P.unbindAll(),P==null||P.setMap(null),(L=u.current)==null||L.drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON)});g.useEffect(()=>{var x,L;if(!o||!(r!=null&&r.length)||!((x=u.current)!=null&&x.map))return;const P=Array.isArray(t==null?void 0:t.field)&&(t==null?void 0:t.field.length)>1?t==null?void 0:t.field.slice(0,-1):t==null?void 0:t.field,W=te([name,...P].flat().join(".")),E=r.map(y=>{const k=Oe(y,t==null?void 0:t.field,W==null?void 0:W.interface);return k!=null&&k.length?k==null?void 0:k.filter(Boolean).map(_=>{var f;if(!k)return;const j=(f=u.current)==null?void 0:f.setOverlay(o.type,_,{strokeColor:"#4e9bff",fillColor:"#4e9bff",cursor:"pointer",label:{className:ut,fontFamily:"inherit",fontSize:"13px",color:"#333",text:t!=null&&t.marker?q(y[A]):void 0}});return j==null||j.set(me,y[C]),j}):[]}).flat().filter(Boolean);H.current=E;const $=E.map(y=>{const k=_=>{const j=y,f=j.get(me);if(!f)return;const p=r==null?void 0:r.find(h=>f===h[C]);if(Y){T(h=>(h&&Ke(j),h===y?(Ke(j),U(null),null):(gt(j),U(p[C],S=>S.field||C,"$eq"),j)));return}p&&M(p)};return y.addListener("click",k),()=>y.unbindAll()});if(o.type==="point"&&(m!=null&&m.length)&&(E==null?void 0:E.length)>1){const y=E.map(_=>_.getPosition());E[0].setZIndex(138),E[E.length-1].setZIndex(138);const k=(_=!0)=>{var j;if((j=u.current)!=null&&j.map)return new google.maps.Marker({label:{className:dt,fontFamily:"inherit",fontSize:"13px",color:"#333",text:I(_?"Start point":"End point")},icon:pe(ue),position:_?y[0]:y[y.length-1],map:u.current.map})};E.push(...[u.current.setOverlay("lineString",y.map(_=>[_.lng(),_.lat()]),{strokeColor:"#4e9bff",fillColor:"#4e9bff",strokeWeight:2,cursor:"pointer"}),k(),k(!1)].filter(Boolean))}return(L=u.current)==null||L.setFitView(E),()=>{E.forEach(y=>{y.setMap(null),y.unbindAll()}),$.forEach(y=>y())}},[r,c,A,o.type,Y]),g.useEffect(()=>{setTimeout(()=>{l([])})},[r]);const oe=P=>{u.current=P,b(!!(P!=null&&P.map)&&!P.errMessage)};return s.jsxs("div",{className:n.css`
        position: relative;
        height: 100%;
      `,children:[c&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:n.css`
              position: absolute;
              left: 10px;
              top: 10px;
              z-index: 999;
            `,children:s.jsxs(w.Space,{direction:"vertical",children:[s.jsx(w.Button,{style:{color:D?void 0:"#F18b62",borderColor:"currentcolor"},onClick:P=>{P.stopPropagation(),K("")},icon:s.jsx(R.EnvironmentOutlined,{})}),s.jsx(w.Button,{style:{color:D==="selection"?"#F18b62":void 0,borderColor:"currentcolor"},onClick:P=>{P.stopPropagation(),K("selection")},icon:s.jsx(R.ExpandOutlined,{})}),D==="selection"?s.jsx(w.Button,{type:"primary",icon:s.jsx(R.CheckOutlined,{}),title:I("Confirm selection"),onClick:se}):null]})}),s.jsx(mt,{record:d,setVisible:M})]}),s.jsx(xe,Z(O({},e),{ref:oe,style:{height:a?"100%":null},zoom:i,disabled:!0,block:!0,overlayCommonOptions:{strokeColor:"#F18b62",fillColor:"#F18b62"}}))]})},mt=e=>{const{setVisible:o,record:t}=e;J(),n.useCollection();const r=n.useCollectionParentRecordData(),a=G.useFieldSchema(),i=g.useMemo(()=>a.reduceProperties((l,m)=>m.name==="drawer"?m:l,null),[a]);return i&&s.jsx(n.ActionContextProvider,{value:{visible:!!t,setVisible:o},children:s.jsx(n.RecordProvider,{record:t,parent:r,children:s.jsx(n.VariablePopupRecordProvider,{children:s.jsx(G.RecursionField,{schema:i,name:i.name})})})})};function Ke(e){if(e instanceof google.maps.Marker)return e.setIcon(pe(ue));e.setOptions({strokeColor:"#4e9bff",fillColor:"#4e9bff"})}function gt(e){if(e instanceof google.maps.Marker)return e.setIcon(pe(be));e.setOptions({strokeColor:"#F18b62",fillColor:"#F18b62"})}const ht=()=>{var c;const{getCollectionJoinField:e}=n.useCollectionManager_deprecated(),{getField:o}=n.useCollection_deprecated(),{form:t}=n.useFormBlockContext(),r=G.useField(),a=G.useFieldSchema(),{t:i}=J(),{dn:l,refresh:m}=n.useDesignable(),v=o(a.name)||e(a["x-collection-field"]),C=(c=v==null?void 0:v.uiSchema)==null?void 0:c.title;r.title===C||r.title,r.readPretty||r.required;let A="editable";return a["x-disabled"]===!0&&(A="readonly"),a["x-read-pretty"]===!0&&(A="read-pretty"),s.jsxs(n.GeneralSchemaDesigner,{children:[s.jsx(n.GeneralSchemaItems,{}),t&&!(t!=null&&t.readPretty)&&!n.isPatternDisabled(a)&&s.jsx(n.SchemaSettingsSelectItem,{title:i("Pattern"),options:[{label:i("Editable"),value:"editable"},{label:i("Readonly"),value:"readonly"},{label:i("Easy-reading"),value:"read-pretty"}],value:A,onChange:b=>{const u={"x-uid":a["x-uid"]};switch(b){case"readonly":{a["x-read-pretty"]=!1,a["x-disabled"]=!0,u["x-read-pretty"]=!1,u["x-disabled"]=!0,r.readPretty=!1,r.disabled=!0;break}case"read-pretty":{a["x-read-pretty"]=!0,a["x-disabled"]=!1,u["x-read-pretty"]=!0,u["x-disabled"]=!1,r.readPretty=!0;break}default:{a["x-read-pretty"]=!1,a["x-disabled"]=!1,u["x-read-pretty"]=!1,u["x-disabled"]=!1,r.readPretty=!1,r.disabled=!1;break}}l.emit("patch",{schema:u}),l.refresh()}},"pattern"),s.jsx(n.SchemaSettingsModalItem,{title:i("Set default zoom level"),schema:{type:"object",title:i("Set default zoom level"),properties:{zoom:{title:i("Zoom"),default:r.componentProps.zoom||13,description:i("The default zoom level of the map"),"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{precision:0}}}},onSubmit:({zoom:b})=>{b&&(ke.set(a,"x-component-props.zoom",b),Object.assign(r.componentProps,a["x-component-props"]),l.emit("patch",{schema:{"x-uid":a["x-uid"],"x-component-props":r.componentProps}})),l.refresh()}},"map-zoom"),s.jsx(n.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,confirm:{title:i("Delete field")},breakRemoveOn:{"x-component":"Grid"}},"remove")]})},yt={amap:Ce,google:xe},Se=g.forwardRef((e,o)=>{const{t}=J(),{mapType:r}=e,a=g.useMemo(()=>yt[r],[r]);return a?s.jsx(a,O({ref:o},e)):s.jsx("div",{children:t(`The ${r} cannot found`)})});Se.displayName="MapComponent";const bt=e=>{var m,v;const{value:o}=e,t=G.useFieldSchema(),{getField:r}=n.useCollection_deprecated(),a=r(t.name),i=e.mapType||((m=a==null?void 0:a.uiSchema["x-component-props"])==null?void 0:m.mapType),l=G.useForm();return n.useFieldTitle(),l.readPretty?s.jsx(Se,O({readonly:!0,mapType:i},e)):s.jsx("div",{children:s.jsx(n.EllipsisWithTooltip,{ellipsis:!0,children:(v=o==null?void 0:o.map)==null?void 0:v.call(o,C=>Array.isArray(C)?`(${C.join(",")})`:C).join(",")})})},Ue=G.connect(e=>s.jsx("div",{className:n.css`
        height: 100%;
        border: 1px solid transparent;
        .ant-formily-item-error & {
          border: 1px solid #ff4d4f;
        }
      `,children:s.jsx(Se,O({},e))}),G.mapReadPretty(bt));Ue.Designer=ht;const vt={amap:Re,google:ft},At=e=>{const{t:o}=J(),{mapType:t}=e,r=g.useMemo(()=>vt[t],[t]);return r?s.jsx(r,O({},e)):s.jsx("div",{children:o(`The ${t} cannot found`)})},Mt=n.withDynamicSchemaProps(e=>{var l;const{fieldNames:o}=n.useProps(e),{getCollectionJoinField:t}=n.useCollectionManager_deprecated(),{name:r}=n.useCollection_deprecated(),a=g.useMemo(()=>t([r,o==null?void 0:o.field].flat().join(".")),[r,o==null?void 0:o.field]),i=(l=a==null?void 0:a.uiSchema)==null?void 0:l["x-component-props"];return s.jsx(At,Z(O(O({},i),e),{collectionField:a}))}),Ct=()=>{const{name:e,title:o}=n.useCollection(),t=n.useSchemaTemplate();return s.jsx(n.GeneralSchemaDesigner,{schemaSettings:"blockSettings:map",template:t,title:o||e})},Ne=(e,o=[])=>(typeof e=="string"&&(e=[e]),e==null?void 0:e.reduce((t,r,a)=>{const i=t==null?void 0:t.find(l=>l.value===r);return a===e.length-1?i:i==null?void 0:i.children},o)),xt=e=>{const{collectionName:o,fieldNames:t,dataSource:r}=e;return{type:"void","x-acl-action":`${o}:list`,"x-decorator":"MapBlockProvider","x-decorator-props":{collection:o,dataSource:r,action:"list",fieldNames:t,params:{paginate:!1}},"x-toolbar":"BlockSchemaToolbar","x-settings":"blockSettings:map","x-component":"CardItem","x-filter-targets":[],properties:{actions:{type:"void","x-initializer":"map:configureActions","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}}},[Je.uid()]:{type:"void","x-component":"MapBlock","x-use-component-props":"useMapBlockProps",properties:{drawer:{type:"void","x-component":"Action.Drawer","x-component-props":{className:"nb-action-popup"},title:'{{ t("View record") }}',properties:{tabs:{type:"void","x-component":"Tabs","x-component-props":{},"x-initializer":"popup:addTab",properties:{tab1:{type:"void",title:'{{t("Details")}}',"x-component":"Tabs.TabPane","x-designer":"Tabs.Designer","x-component-props":{},properties:{grid:{type:"void","x-component":"Grid","x-initializer":"popup:common:addBlock"}}}}}}}}}}}},St=()=>{const e=n.useSchemaInitializerItem(),{insert:o}=n.useSchemaInitializer(),t=g.useContext(G.SchemaOptionsContext),{getCollectionFieldsOptions:r}=n.useCollectionManager_deprecated(),{t:a}=J(),{theme:i}=n.useGlobalTheme();return s.jsx(n.DataBlockInitializer,O({componentType:"Map",icon:s.jsx(R.TableOutlined,{}),onCreateBlockSchema:m=>ye(this,[m],function*({item:l}){const v=r(l.name,["point","lineString","polygon"],{association:["o2o","obo","oho","o2m","m2o","m2m"],dataSource:l.dataSource}),C=r(l.name,"string",{dataSource:l.dataSource}),A=yield n.FormDialog(a("Create map block"),()=>{var c;return s.jsx(n.SchemaComponentOptions,{scope:t.scope,components:O({},t.components),children:s.jsx(Ye.FormLayout,{layout:"vertical",children:s.jsx(n.SchemaComponent,{schema:{properties:{field:{title:a("Map field"),enum:v,required:!0,"x-component":"Cascader","x-decorator":"FormItem",default:v.length?[v[0].value,(c=v[0].children)==null?void 0:c[0].value].filter(b=>b!=null):[]},marker:{title:a("Marker field"),enum:C,"x-component":"Select","x-decorator":"FormItem","x-reactions":b=>{const u=b.form.values.field;if(!(u!=null&&u.length))return;const d=Ne(u,v);d&&(b.hidden=d.type!=="point")}}}}})})})},i).open({initialValues:{}});o(xt({collectionName:l.name,dataSource:l.dataSource,fieldNames:O({},A)}))}),title:a("Map block")},e))},we=g.createContext({});we.displayName="MapBlockContext";const wt=e=>{var v;const{fieldNames:o}=e,t=G.useFieldSchema(),r=G.useField(),{resource:a,service:i}=n.useBlockRequestContext(),[l,m]=g.useState([]);return s.jsx(n.FixedBlockWrapper,{children:s.jsx(n.SchemaComponentOptions,{scope:{selectedRecordKeys:l},children:s.jsx(we.Provider,{value:{field:r,service:i,resource:a,fieldNames:o,fixedBlock:(v=t==null?void 0:t["x-decorator-props"])==null?void 0:v.fixedBlock,selectedRecordKeys:l,setSelectedRecordKeys:m},children:e.children})})})},It=e=>{const{filter:o,parseVariableLoading:t}=n.useParsedFilter({filterOption:e==null?void 0:e.filter});return{params:Z(O({},e),{filter:o}),parseVariableLoading:t}},Pt=e=>{const o=G.useField(),{fieldNames:t}=e,{params:r,parseVariableLoading:a}=It(e.params);if(a)return null;const i=r.appends||[],{field:l}=t||{};return Array.isArray(l)&&l.length>1&&i.push(l[0]),s.jsx(n.BlockProvider,Z(O({name:"map"},e),{runWhenParamsChanged:!0,params:Z(O({},r),{appends:i,paginate:!1,sort:o.componentProps.lineSort}),children:s.jsx(wt,O({},e))}))},ge=()=>g.useContext(we),Ge=()=>{var o,t,r,a,i,l;const e=ge();return Z(O({},e),{dataSource:(t=(o=e==null?void 0:e.service)==null?void 0:o.data)==null?void 0:t.data,zoom:((a=(r=e==null?void 0:e.field)==null?void 0:r.componentProps)==null?void 0:a.zoom)||13,lineSort:(l=(i=e==null?void 0:e.field)==null?void 0:i.componentProps)==null?void 0:l.lineSort})},kt=e=>s.jsx(n.SchemaComponentOptions,{scope:{useMapBlockProps:Ge},components:{MapBlockInitializer:St,MapBlockDesigner:Ct,MapBlockProvider:Pt,MapBlock:Mt},children:e.children}),qe=new n.CompatibleSchemaInitializer({name:"MapActionInitializers",title:"{{t('Configure actions')}}",icon:"SettingOutlined",style:{marginLeft:8},items:[{type:"itemGroup",title:"{{t('Enable actions')}}",name:"enableActions",children:[{name:"filter",title:"{{t('Filter')}}",Component:"FilterActionInitializer",schema:{"x-align":"left"}},{name:"addNew",title:"{{t('Add new')}}",Component:"CreateActionInitializer",schema:{"x-align":"right","x-decorator":"ACLActionProvider","x-acl-action-props":{skipScopeCheck:!0}},useVisible(){return n.useCollection_deprecated().template!=="sql"}},{name:"refresh",title:"{{t('Refresh')}}",Component:"RefreshActionInitializer",schema:{"x-align":"right"}}]},{name:"divider",type:"divider",useVisible(){return n.useCollection_deprecated().template!=="sql"}},{type:"subMenu",title:'{{t("Customize")}}',name:"customize",children:[],useVisible(){return n.useCollection_deprecated().template!=="sql"}}]}),Ft=new n.CompatibleSchemaInitializer({name:"map:configureActions",title:"{{t('Configure actions')}}",icon:"SettingOutlined",style:{marginLeft:8},items:[{type:"itemGroup",title:"{{t('Enable actions')}}",name:"enableActions",children:[{name:"filter",title:"{{t('Filter')}}",Component:"FilterActionInitializer",schema:{"x-align":"left"}},{name:"addNew",title:"{{t('Add new')}}",Component:"CreateActionInitializer",schema:{"x-align":"right","x-decorator":"ACLActionProvider","x-acl-action-props":{skipScopeCheck:!0}},useVisible(){return n.useCollection_deprecated().template!=="sql"}},{name:"refresh",title:"{{t('Refresh')}}",Component:"RefreshActionInitializer",schema:{"x-align":"right"}}]},{name:"divider",type:"divider",useVisible(){return n.useCollection_deprecated().template!=="sql"}},{type:"subMenu",title:'{{t("Customize")}}',name:"customize",children:[],useVisible(){return n.useCollection_deprecated().template!=="sql"}}]},qe),Ot=new n.SchemaSettings({name:"blockSettings:map",items:[{name:"title",Component:n.SchemaSettingsBlockTitleItem},{name:"mapField",Component:n.SchemaSettingsCascaderItem,useComponentProps(){var C;const{getCollectionFieldsOptions:e}=n.useCollectionManager_deprecated(),{t:o}=J(),t=G.useFieldSchema(),r=((C=t==null?void 0:t["x-decorator-props"])==null?void 0:C.fieldNames)||{},a=G.useField(),{dn:i}=n.useDesignable(),{service:l}=ge(),{name:m}=n.useCollection(),v=e(m,["point","lineString","polygon"],{association:["o2o","obo","oho","o2m","m2o","m2m"]});return{title:o("Map field"),value:r.field,options:v,allowClear:!1,onChange:A=>{const c=a.decoratorProps.fieldNames||{};c.field=A,a.decoratorProps.fieldNames=c,t["x-decorator-props"].fieldNames=c,l.refresh(),i.emit("patch",{schema:{"x-uid":t["x-uid"],"x-decorator-props":a.decoratorProps}}),i.refresh()}}}},{name:"markerField",Component:n.SchemaSettingsSelectItem,useComponentProps(){var C;const{t:e}=J(),o=G.useFieldSchema(),t=((C=o==null?void 0:o["x-decorator-props"])==null?void 0:C.fieldNames)||{},{service:r}=ge(),a=G.useField(),{dn:i}=n.useDesignable(),{getCollectionFieldsOptions:l}=n.useCollectionManager_deprecated(),{name:m}=n.useCollection(),v=l(m,"string");return{title:e("Marker field"),value:t.marker,options:v,onChange:A=>{const c=a.decoratorProps.fieldNames||{};c.marker=A,a.decoratorProps.fieldNames=c,o["x-decorator-props"].fieldNames=c,r.refresh(),i.emit("patch",{schema:{"x-uid":o["x-uid"],"x-decorator-props":a.decoratorProps}}),i.refresh()}}},useVisible(){var l,m;const e=G.useFieldSchema(),{getCollectionFieldsOptions:o}=n.useCollectionManager_deprecated(),{name:t}=n.useCollection(),r=((l=e==null?void 0:e["x-decorator-props"])==null?void 0:l.fieldNames)||{},a=o(t,["point","lineString","polygon"],{association:["o2o","obo","oho","o2m","m2o","m2m"]});return((m=Ne(r.field,a))==null?void 0:m.type)==="point"}},{name:"setDefaultSortingRules",Component:n.SchemaSettingsDefaultSortingRules,useComponentProps(){const{t:e}=J();return{path:"x-component-props.lineSort",title:e("Concatenation order field")}}},n.setDataLoadingModeSettingsItem,{name:"defaultZoomLevel",Component:n.SchemaSettingsModalItem,useComponentProps(){var i;const{t:e}=J(),o=G.useFieldSchema(),t=G.useField(),{dn:r}=n.useDesignable(),a=((i=o==null?void 0:o["x-component-props"])==null?void 0:i.zoom)||13;return{title:e("The default zoom level of the map"),schema:{type:"object",title:e("Set default zoom level"),properties:{zoom:{title:e("Zoom"),default:a,"x-component":"InputNumber","x-decorator":"FormItem","x-component-props":{precision:0}}}},onSubmit:({zoom:l})=>{ke.set(o,"x-component-props.zoom",l),Object.assign(t.componentProps,o["x-component-props"]),r.emit("patch",{schema:{"x-uid":o["x-uid"],"x-component-props":t.componentProps}}),r.refresh()}}}},{name:"dataScope",Component:n.SchemaSettingsDataScope,useComponentProps(){var l,m;const{name:e}=n.useCollection(),o=G.useFieldSchema(),{form:t}=n.useFormBlockContext(),r=G.useField(),{service:a}=ge(),{dn:i}=n.useDesignable();return{collectionName:e,defaultFilter:((m=(l=o==null?void 0:o["x-decorator-props"])==null?void 0:l.params)==null?void 0:m.filter)||{},form:t,onSubmit:({filter:v})=>{var A,c;const C=r.decoratorProps.params||{};C.filter=v,r.decoratorProps.params=C,o["x-decorator-props"].params=C,(c=(A=a.params)==null?void 0:A[1])!=null&&c.filters,i.emit("patch",{schema:{"x-uid":o["x-uid"],"x-decorator-props":o["x-decorator-props"]}})}}}},{name:"ConnectDataBlocks",Component:n.SchemaSettingsConnectDataBlocks,useComponentProps(){const{t:e}=J();return{type:n.FilterBlockType.TABLE,emptyDescription:e("No blocks to connect")}}},{name:"divider",type:"divider"},{name:"template",Component:n.SchemaSettingsTemplate,useComponentProps(){var r,a;const{name:e}=n.useCollection(),o=G.useFieldSchema(),t=((r=o==null?void 0:o["x-decorator-props"])==null?void 0:r.resource)||((a=o==null?void 0:o["x-decorator-props"])==null?void 0:a.association);return{componentName:"Map",collectionName:e,resourceName:t}}},{name:"divider2",type:"divider"},{name:"remove",type:"remove",componentProps:{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}]}),{defaultProps:Et}=n.interfacesProperties;Array.isArray(n.interfacesProperties.type.enum)&&n.interfacesProperties.type.enum.push({label:"Point",value:"point"},{label:"LineString",value:"lineString"},{label:"Polygon",value:"polygon"},{label:"Circle",value:"circle"});class he extends n.CollectionFieldInterface{constructor(){super(...arguments);F(this,"properties",Z(O({},Et),{"uiSchema.x-component-props.mapType":{title:Q("Map type"),type:"string",required:!0,"x-decorator":"FormItem","x-component":"Select","x-component-props":{showSearch:!1,allowClear:!1},"x-disabled":"{{ isOverride || !createOnly }}",default:"amap",enum:Fe}}))}schemaInitialize(t,{block:r}){r==="Form"&&Object.assign(t,{"x-designer":"Map.Designer"})}}class Lt extends he{constructor(){super(...arguments);F(this,"name","circle");F(this,"type","object");F(this,"group","map");F(this,"order",3);F(this,"title",Q("Circle"));F(this,"availableTypes",["circle"]);F(this,"description",Q("Circle"));F(this,"sortable",!0);F(this,"default",{type:"circle",uiSchema:{type:"void","x-component":"Map","x-component-designer":"Map.Designer","x-component-props":{}}})}}class zt extends he{constructor(){super(...arguments);F(this,"name","lineString");F(this,"type","object");F(this,"group","map");F(this,"order",2);F(this,"title",Q("Line"));F(this,"description",Q("Line"));F(this,"availableTypes",["lineString"]);F(this,"sortable",!0);F(this,"default",{type:"lineString",uiSchema:{type:"void","x-component":"Map","x-component-designer":"Map.Designer","x-component-props":{}}})}}class Dt extends he{constructor(){super(...arguments);F(this,"name","point");F(this,"type","object");F(this,"group","map");F(this,"order",1);F(this,"title",Q("Point"));F(this,"description",Q("Point"));F(this,"availableTypes",["point"]);F(this,"sortable",!0);F(this,"default",{type:"point",uiSchema:{type:"void","x-component":"Map","x-component-designer":"Map.Designer","x-component-props":{}}})}}class Tt extends he{constructor(){super(...arguments);F(this,"name","polygon");F(this,"type","object");F(this,"group","map");F(this,"order",4);F(this,"title",Q("Polygon"));F(this,"description",Q("Polygon"));F(this,"availableTypes",["polygon"]);F(this,"sortable",!0);F(this,"default",{type:"polygon",uiSchema:{type:"void","x-component":"Map","x-component-designer":"Map.Designer","x-component-props":{}}})}}const Bt=[Dt,Tt,zt,Lt],_e=g.memo(e=>s.jsx(n.SchemaComponentOptions,{components:{Map:Ue},children:s.jsx(kt,{children:e.children})}));_e.displayName="MapProvider";class je extends n.Plugin{load(){return ye(this,null,function*(){this.app.use(_e),this.app.dataSourceManager.addFieldInterfaces(Bt),this.app.dataSourceManager.addFieldInterfaceGroups({map:{label:Q("Map-based geometry"),order:51}}),this.app.schemaInitializerManager.add(qe),this.app.schemaInitializerManager.add(Ft),this.schemaSettingsManager.add(Ot);const o=this.app.schemaInitializerManager.get("page:addBlock");o==null||o.add("dataBlocks.map",{title:Q("Map"),Component:"MapBlockInitializer"}),this.app.pluginSettingsManager.add(fe,{title:`{{t("Map Manager", { ns: "${fe}" })}}`,icon:"EnvironmentOutlined",Component:nt,aclSnippet:"pm.map.configuration"}),this.app.addScopes({useMapBlockProps:Ge})})}}z.PluginMapClient=je,z.default=je,Object.defineProperties(z,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
