(function(a,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("react"),require("@formily/shared"),require("antd"),require("@formily/react"),require("react-i18next"),require("@ant-design/icons"),require("@nocobase/utils/client"),require("@nocobase/plugin-acl/client")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","react","@formily/shared","antd","@formily/react","react-i18next","@ant-design/icons","@nocobase/utils/client","@nocobase/plugin-acl/client"],t):(a=typeof globalThis!="undefined"?globalThis:a||self,t(a["@nocobase/plugin-users"]={},a["@nocobase/client"],a.jsxRuntime,a.react,a["@formily/shared"],a.antd,a["@formily/react"],a["react-i18next"],a["@ant-design/icons"],a["@nocobase/utils"],a["@nocobase/plugin-acl"]))})(this,function(a,t,e,h,N,d,S,D,w,k,P){"use strict";var ye=Object.defineProperty,fe=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var Ce=Object.prototype.hasOwnProperty,Ae=Object.prototype.propertyIsEnumerable;var H=(a,t,e)=>t in a?ye(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,x=(a,t)=>{for(var e in t||(t={}))Ce.call(t,e)&&H(a,e,t[e]);if(G)for(var e of G(t))Ae.call(t,e)&&H(a,e,t[e]);return a},A=(a,t)=>fe(a,he(t));var F=(a,t,e)=>new Promise((h,N)=>{var d=w=>{try{D(e.next(w))}catch(k){N(k)}},S=w=>{try{D(e.throw(w))}catch(k){N(k)}},D=w=>w.done?h(w.value):Promise.resolve(w.value).then(d,S);D((e=e.apply(a,t)).next())});const $={name:"users",fields:[{name:"id",type:"bigInt",autoIncrement:!0,primaryKey:!0,allowNull:!1,uiSchema:{type:"number",title:'{{t("ID")}}',"x-component":"InputNumber","x-read-pretty":!0},interface:"id"},{interface:"input",type:"string",name:"nickname",uiSchema:{type:"string",title:'{{t("Nickname")}}',"x-component":"Input"}},{interface:"input",type:"string",name:"username",unique:!0,uiSchema:{type:"string",title:'{{t("Username")}}',"x-component":"Input","x-validator":{username:!0},required:!0}},{interface:"email",type:"string",name:"email",uiSchema:{type:"string",title:'{{t("Email")}}',"x-component":"Input","x-validator":"email",required:!0}},{interface:"phone",type:"string",name:"phone",uiSchema:{type:"string",title:'{{t("Phone")}}',"x-component":"Input","x-validator":"phone",required:!0}},{interface:"select",type:"string",name:"status",uiSchema:{type:"string",title:'{{t("Status")}}',"x-component":"Input",required:!0,enum:[{color:"green",label:"Enable",value:"1"},{color:"red",label:"Disable",value:"0"}]},defaultValue:"1"},{interface:"password",type:"password",name:"password",hidden:!0,uiSchema:{type:"string",title:'{{t("Password")}}',"x-component":"Password"}},{name:"keyExtend",target:"user_extend",type:"hasOne",interface:"oho",description:null,parentKey:null,onDelete:"SET NULL",foreignKey:"user_id",sourceKey:"id",uiSchema:{title:"Extend","x-component":"AssociationField","x-component-props":{multiple:!1}}}]},J={type:"object",properties:{block1:{type:"void","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:$,resourceName:"users",request:{resource:"users",action:"list",params:{pageSize:50,appends:[],filter:{}}}},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-component":"Filter.Action","x-use-component-props":"useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useBulkDestroyAction }}",confirm:{title:"{{t('Delete users')}}",content:"{{t('Are you sure you want to delete it?')}}"},icon:"DeleteOutlined"}},create:{type:"void",title:'{{t("Add new")}}',"x-component":"Action","x-component-props":{type:"primary",icon:"PlusOutlined"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form",title:'{{t("Add user")}}',properties:{nickname:{"x-component":"CollectionField","x-decorator":"FormItem"},username:{"x-component":"CollectionField","x-decorator":"FormItem"},email:{title:'{{t("Email")}}',"x-component":"Input","x-validator":"email","x-decorator":"FormItem",required:!1},phone:{title:'{{t("Phone")}}',"x-component":"Input","x-validator":"phone","x-decorator":"FormItem",required:!1},status:{title:'{{t("Status")}}',"x-component":"Select","x-decorator":"FormItem",required:!0,enum:[{color:"green",label:"Enable",value:"1"},{color:"red",label:"Disable",value:"0"}],default:"1"},password:{"x-component":"CollectionField","x-decorator":"FormItem",required:!0},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useCreateAction }}"}}}}}}}}}},table:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"id",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{column1:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{nickname:{type:"number","x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{username:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column3:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{email:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column4:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{status:{type:"string","x-component":"CollectionField","x-read-pretty":!0,"x-collection-field":"users.status"}}},column6:{type:"void",title:'{{t("Actions")}}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{update:{type:"void",title:'{{t("Edit profile")}}',"x-decorator":"ACLActionProvider","x-acl-action":"users:update","x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:s=>{const o=t.useRecord(),i=t.useRequest(()=>Promise.resolve({data:o}),A(x({},s),{manual:!0})),r=t.useActionContext();return h.useEffect(()=>{r.visible&&i.run()},[r.visible]),i}},title:'{{t("Edit profile")}}',properties:{nickname:{"x-component":"CollectionField","x-decorator":"FormItem"},username:{"x-component":"CollectionField","x-decorator":"FormItem"},email:{title:'{{t("Email")}}',"x-component":"Input","x-validator":"email","x-decorator":"FormItem",required:!1},phone:{title:'{{t("Phone")}}',"x-component":"Input","x-validator":"phone","x-decorator":"FormItem",required:!1},status:{title:'{{t("Status")}}',"x-component":"Select","x-decorator":"FormItem",required:!0,enum:[{color:"green",label:"Enable",value:"1"},{color:"red",label:"Disable",value:"0"}]},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useUpdateAction }}"}}}}}}}},roles:{type:"void",title:'{{t("Roles")}}',"x-decorator":"ACLActionProvider","x-acl-action":"users:update","x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form",title:'{{t("Roles")}}',properties:{layout:{type:"void","x-component":"DefinedRolesDrawer"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{Cancel:{title:'{{t("Close")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useCancelAction }}"}}}}}}}},changePassword:{type:"void",title:'{{t("Change password")}}',"x-decorator":"ACLActionProvider","x-acl-action":"users:update","x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form",title:'{{t("Change password")}}',properties:{password:{"x-component":"CollectionField","x-component-props":{component:"PasswordField"},"x-decorator":"FormItem",required:!0},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useUpdateAction }}"}}}}}}}},delete:{type:"void",title:'{{ t("Delete") }}',"x-acl-action":"users:destroy","x-action":"destroy","x-decorator":"ACLActionProvider","x-component":"Action.Link","x-component-props":{confirm:{title:"{{t('Delete')}}",content:"{{t('Are you sure you want to delete it?')}}"},useAction:"{{cm.useDestroyAction}}"}}}}}}}}}}}},Q=()=>({type:"void",properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{[N.uid()]:{type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-component":"Filter.Action","x-use-component-props":"useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"},actions:{type:"void","x-component":"Space",properties:{remove:{type:"void",title:'{{t("Remove")}}',"x-component":"Action","x-component-props":{icon:"MinusOutlined",confirm:{title:"{{t('Remove')}}",content:"{{t('Are you sure you want to remove these users?')}}"},style:{marginRight:8},useAction:"{{ useBulkRemoveUsers }}"}},create:{type:"void",title:'{{t("Add users")}}',"x-component":"Action","x-component-props":{type:"primary",icon:"PlusOutlined"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"FormV2",title:'{{t("Add users")}}',properties:{resource:{type:"void","x-decorator":"FormItem","x-component":"RoleUsersProvider",properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',default:{$and:[{username:{$includes:""}},{nickname:{$includes:""}}]},"x-action":"filter","x-component":"Filter.Action","x-use-component-props":"useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"}}},table:{type:"void","x-component":"Table.Void","x-component-props":{rowKey:"id",rowSelection:{type:"checkbox",onChange:"{{ handleSelectRoleUsers }}"},useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{username:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{username:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},nickname:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{nickname:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},phone:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{phone:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},status:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{status:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},email:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{email:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}}}}}},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useAddRoleUsers }}"}}}}}}}}}}}},table:{type:"void","x-component":"Table.Void","x-component-props":{rowKey:"id",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{username:{type:"void",title:'{{t("Username")}}',"x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{username:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},nickname:{type:"void",title:'{{t("Nickname")}}',"x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{nickname:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},actions:{type:"void",title:'{{t("Actions")}}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{remove:{type:"void",title:'{{ t("Remove") }}',"x-component":"Action.Link","x-component-props":{confirm:{title:"{{t('Remove user')}}",content:"{{t('Are you sure you want to remove it?')}}"},useAction:"{{ useRemoveUser }}"}}}}}}}}}});function I(){return D.useTranslation(["users","client"],{nsMode:"fallback"})}const W=()=>{const{t:s}=I();return(S.useField().value||[]).map(i=>e.jsx(d.Tag,{children:S.Schema.compile(i.title,{t:s})},i.name))},X=()=>{const{t:s}=I(),o=S.useField(),i=o.value?o.value.code:"";return e.jsx(d.Tag,{children:S.Schema.compile(i,{t:s})})},R=()=>{var r,l;const s=h.useContext(t.CollectionContext),o=t.useFilterFieldOptions(s.fields),i=t.useResourceActionContext();return t.useFilterFieldProps({options:o,params:((l=(r=i.state)==null?void 0:r.params)==null?void 0:l[0])||i.params,service:i})},Y=(s=10)=>{const o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i="abcdefghijklmnopqrstuvwxyz",r="0123456789",l="!#$%^&*-_+=",p=o+i+r+l,u=new Uint32Array(s);crypto.getRandomValues(u);let f="";f+=o.charAt(u[0]%o.length),f+=i.charAt(u[1]%i.length),f+=r.charAt(u[2]%r.length),f+=l.charAt(u[3]%l.length);for(let y=4;y<s;y++){const T=u[y]%p.length;f+=p.charAt(T)}return f=f[0]+f.slice(1).split("").sort(()=>Math.random()-.5).join(""),f},Z=()=>{const{t:s}=I(),o=S.useField(),[i,r]=h.useState(!1),l=t.useActionContext();return h.useEffect(()=>{l.visible||o.reset()},[o,l.visible]),e.jsxs(d.Row,{gutter:10,children:[e.jsx(d.Col,{span:18,children:e.jsx(t.Password,{checkStrength:!0,visibilityToggle:{visible:i,onVisibleChange:r},value:o.value,onChange:p=>o.setValue(p.target.value),autoComplete:"off"})}),e.jsx(d.Col,{span:4,children:e.jsx(d.Button,{onClick:()=>{o.setValue(Y()),r(!0)},children:s("Random password")})})]})},V={title:"Delete",content:"Are you sure you want to delete it?"},ee=t.css`
  height: 100%;
  overflow: auto;
  padding: 8px;
`,te=t.css`
  height: 100%;
  overflow: auto;
  padding-top: 12px;
`,oe=t.css`
  display: flex;
  width: 100%;
  height: 100%;
  justify-content: center;
  align-items: center;
`,ne=()=>e.jsx("div",{className:oe,children:e.jsx(t.Empty,{})}),re=s=>{let o=0;for(const i of s)for(const r in i)for(const l in i[r])i[r][l]&&(o+=1);return o};function se(s){const{token:o}=t.useToken(),i=t.useAPIClient(),{t:r}=D.useTranslation(),l=t.useCompile(),[p,u]=h.useState({open:!1,showMenu:!0,selectedAppName:"",appList:[],roleList:[],selectRoles:[]});h.useEffect(()=>{p.open&&f()},[p.open]);function f(){return F(this,null,function*(){try{const{data:n}=yield i.request({method:"get",url:"/applications:list?paginate=false&appends[]=referenceRoles"});u(C=>A(x({},C),{appList:n.data.map(m=>A(x({},m),{show:!0,referenceRoles:m.referenceRoles.filter(g=>!(l(g.title)==="Owner"||["root","guest"].includes(g.name))).map(g=>A(x({},g),{show:!0,title:l(g.title),isDisable:s.data.filter(v=>v.app===m.displayName?v.title===l(g.title):!1).length>0}))})),showMenu:n.data.length>0}))}catch(n){k.captureException(n)}})}function y(n){u(C=>A(x({},C),{open:n,selectRoles:[],selectedAppName:"",roleList:[]}))}function T(){return F(this,null,function*(){if(p.selectRoles.length)try{yield i.request({method:"post",url:`/users/${s.id}/roles:add`,data:p.selectRoles}),u(n=>A(x({},n),{open:!1})),s.handleRefresh()}catch(n){k.captureException(n)}})}function L(n){const C=p.appList.map(m=>{m.show=!1,n||(m.show=!0);const g=m.referenceRoles.map(v=>(v.show=!0,n?(v.title.toLowerCase().includes(n.toLowerCase())?(v.show=!0,m.show=!0):v.show=!1,x({},v)):(v.show=!0,x({},v))));return A(x({},m),{referenceRoles:g})});u(m=>A(x({},m),{appList:C,roleList:[],selectedAppName:""}))}function O(n,C){const{checked:m}=n.target;let g=[];m?g=[...p.selectRoles,C]:g=p.selectRoles.filter(v=>v!==C),u(v=>A(x({},v),{selectRoles:g}))}const q=()=>c.length?e.jsx(e.Fragment,{children:c.filter(n=>n.show).map(n=>e.jsx("div",{style:{marginBottom:24,padding:"0 8px"},children:e.jsx(d.Checkbox,{disabled:n.isDisable,checked:b.includes(n.name),style:{width:"50%"},onChange:C=>O(C,n.name),children:n.title})},n.name))}):e.jsx(ne,{}),{open:M,showMenu:E,selectedAppName:U,appList:B,roleList:c,selectRoles:b}=p;return e.jsxs(e.Fragment,{children:[e.jsx(d.Button,{onClick:()=>y(!0),type:"primary",icon:e.jsx(w.PlusOutlined,{}),children:r("Add role")}),e.jsxs(d.Modal,{title:r("Add role"),open:M,onCancel:()=>y(!1),onOk:T,width:750,destroyOnClose:!0,okText:r("Submit"),cancelText:r("Cancel"),children:[e.jsx(d.Input.Search,{allowClear:!0,placeholder:"Search",onSearch:L,style:{marginBottom:16}}),e.jsxs(d.Card,{className:t.css`
            border-color: ${o.colorBorder};
            border-radius: 6px;
            .ant-card-body {
              padding: 0;
              height: 30vh;
              overflow: hidden;
              align-items: center;
            }
          `,children:[E&&e.jsxs(d.Row,{style:{height:"100%"},children:[e.jsx(d.Col,{span:8,className:ee,style:{borderRight:`1px solid ${o.colorBorder}`},children:e.jsx(d.Menu,{className:t.css`
                    border-inline-end: none !important;
                  `,items:B.filter(n=>n.show).map(n=>A(x({},n),{label:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",height:"100%"},children:[e.jsx("span",{children:n.displayName}),U===n.key?e.jsx(w.DownOutlined,{}):e.jsx(w.RightOutlined,{})]},n.id)})),selectedKeys:[U],onSelect:n=>{const{key:C,item:m}=n;u(g=>A(x({},g),{selectedAppName:C,roleList:m==null?void 0:m.props.referenceRoles}))}})}),e.jsx(d.Col,{span:16,className:te,children:e.jsx(q,{})})]}),!E&&e.jsx(q,{})]})]})]})}const ie={$and:[{displayName:{$includes:""}},{title:{$includes:""}}]};function ce(s){const{t:o}=D.useTranslation(),i=h.useCallback(()=>{const l=S.useField();return{options:[{name:"displayName",title:"App name",operators:[{label:o("is"),value:"$eq"},{label:o("is not"),value:"$ne"},{label:o("includes"),value:"$includes"}],schema:{type:"string"}},{name:"title",title:"Role name",operators:[{label:o("is"),value:"$eq"},{label:o("is not"),value:"$ne"},{label:o("includes"),value:"$includes"}],schema:{type:"string"}}],onSubmit(p){s.handleFilter(p,!1);const u=re(p==null?void 0:p.filter.$and);u>0?l.title=o("{{count}} filter items",{count:u}):l.title=o("Filter")},onReset(p){s.handleFilter(p,!0)}}},[]),r={type:"void",properties:{filter:{type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-component":"Filter.Action","x-component-props":{icon:"FilterOutlined",useProps:"{{ useFilterActionProps }}"},default:ie}}};return e.jsx(t.SchemaComponent,{schema:r,scope:{useFilterActionProps:i}})}function ae(){const{modal:s}=d.App.useApp(),o=t.useAPIClient(),i=t.useCompile(),r=t.useRecord().id,l=[{"users.id":{$eq:r}}],{t:p}=D.useTranslation(),{token:u}=t.useToken(),[f,y]=h.useState({tableData:[],isLoading:!1,deleteIds:[],filter:[]});h.useEffect(()=>{T()},[f.isLoading]);function T(){return F(this,null,function*(){try{const{data:c}=yield o.request({method:"get",url:`/roles:list?filter={"$and":${JSON.stringify(f.filter.concat(l))}}&appends[]=associatedApp.applicationsRelationShip&paginate=false`});y(b=>A(x({},b),{tableData:c.data.map(n=>{var C,m;return A(x({},n),{app:n!=null&&n.associatedApp?(m=(C=n==null?void 0:n.associatedApp)==null?void 0:C.applicationsRelationShip)==null?void 0:m.displayName:null,key:n.name,title:i(n.title)})})}))}catch(c){k.captureException(c)}})}function L(c){y(b=>A(x({},b),{deleteIds:c}))}function O(c){return F(this,null,function*(){if(c.length)try{yield o.request({method:"post",url:`/users/${r}/roles:remove`,data:c}),y(b=>A(x({},b),{isLoading:!b.isLoading}))}catch(b){k.captureException(b)}})}const q=[{title:"App name",dataIndex:"app",key:"app"},{title:"Role name",dataIndex:"title",key:"title"},{title:"Action",key:"action",render:(c,b)=>{const n=b.name.includes("owner");return e.jsx("a",{style:{color:n?"#ccc":u.colorPrimary,cursor:n?"not-allowed":"pointer"},onClick:()=>F(this,null,function*(){if(n)return;(yield s.confirm(V))&&O([b.name])}),children:"Delete"})}}];function M(c,b){y(n=>{var C,m,g,v,K,_,j,z;return A(x({},n),{filter:b?[]:[{"associatedApp.applicationsRelationShip.displayName":(m=(C=c==null?void 0:c.filter.$and)==null?void 0:C[0])!=null&&m.displayName?(v=(g=c==null?void 0:c.filter.$and)==null?void 0:g[0])==null?void 0:v.displayName:{$includes:""}},{title:(_=(K=c==null?void 0:c.filter.$and)==null?void 0:K[1])!=null&&_.title?(z=(j=c==null?void 0:c.filter.$and)==null?void 0:j[1])==null?void 0:z.title:{$includes:""}}],isLoading:!n.isLoading})})}function E(){y(c=>A(x({},c),{isLoading:!c.isLoading}))}const{tableData:U,deleteIds:B}=f;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:t.css`
          margin-bottom: 24px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        `,children:[e.jsx(ce,{handleFilter:M}),e.jsxs(d.Space,{children:[e.jsx(d.Button,{onClick:()=>F(this,null,function*(){(yield s.confirm(V))&&O(B)}),icon:e.jsx(w.DeleteOutlined,{}),children:p("Delete")}),e.jsx(se,{id:r,handleRefresh:E,data:U})]})]}),e.jsx(d.Table,{rowSelection:{onChange:L},columns:q,dataSource:U,pagination:!1})]})}const le=()=>{const{t:s}=I(),o=t.useSchemaComponentContext();return e.jsx(t.SchemaComponentContext.Provider,{value:A(x({},o),{designable:!1}),children:e.jsx(d.Card,{children:e.jsx(t.SchemaComponent,{schema:J,scope:{t:s,useFilterActionProps:R},components:{UserRolesField:W,UserOfficeField:X,PasswordField:Z,DefinedRolesDrawer:ae}})})})},pe=()=>{const s=t.useAPIClient(),{role:o}=h.useContext(P.RolesManagerContext),i=t.useRecord(),{refresh:r}=t.useResourceActionContext();return{run(){return F(this,null,function*(){yield s.resource("roles.users",o==null?void 0:o.name).remove({values:[i.id]}),r()})}}},ue=()=>{const{t:s}=I(),{message:o}=d.App.useApp(),i=t.useAPIClient(),{state:r,setState:l,refresh:p}=t.useResourceActionContext(),{role:u}=h.useContext(P.RolesManagerContext);return{run(){return F(this,null,function*(){const y=r==null?void 0:r.selectedRowKeys;if(!(y!=null&&y.length)){o.warning(s("Please select users"));return}yield i.resource("roles.users",u==null?void 0:u.name).remove({values:y}),l==null||l({selectedRowKeys:[]}),p()})}}},de=s=>{const{role:o}=h.useContext(P.RolesManagerContext);return e.jsx(t.ResourceActionProvider,{collection:$,request:{resource:"users",action:"listExcludeRole",params:{roleName:o==null?void 0:o.name}},children:s.children})},me=()=>{const{t:s}=I(),{role:o}=h.useContext(P.RolesManagerContext),i=t.useRequest({resource:"roles.users",resourceOf:o==null?void 0:o.name,action:"list"},{ready:!!o});h.useEffect(()=>{i.run()},[o]);const r=h.useRef([]),l=(f,y)=>{r.current=y},p=()=>{const{role:f}=h.useContext(P.RolesManagerContext),y=t.useAPIClient(),{setVisible:T}=t.useActionContext(),{refresh:L}=t.useResourceActionContext();return{run(){return F(this,null,function*(){yield y.resource("roles.users",f==null?void 0:f.name).add({values:r.current.map(q=>q.id)}),r.current=[],T(!1),L()})}}},u=h.useMemo(()=>Q(),[o]);return e.jsx(t.ResourceActionContext.Provider,{value:x({},i),children:e.jsx(t.CollectionProvider_deprecated,{collection:$,children:e.jsx(t.SchemaComponent,{schema:u,components:{RoleUsersProvider:de},scope:{useBulkRemoveUsers:ue,useRemoveUser:pe,handleSelectRoleUsers:l,useAddRoleUsers:p,useFilterActionProps:R,t:s}})})})};class xe extends t.Plugin{load(){return F(this,null,function*(){this.app.pluginSettingsManager.add("users-permissions",{title:t.tval("Users",{ns:"users"}),icon:"TeamOutlined"}),this.app.pluginSettingsManager.add("users-permissions.users",{title:t.tval("Users"),icon:"UserOutlined",Component:le,aclSnippet:"pm.users"}),this.app.pm.get(P).rolesManager.add("users",{title:t.tval("Users"),Component:me})})}}a.default=xe,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
