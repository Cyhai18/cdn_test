(function(r,n){typeof exports=="object"&&typeof module!="undefined"?n(exports,require("@nocobase/client"),require("@formily/react"),require("react/jsx-runtime"),require("@formily/core"),require("@formily/reactive"),require("@nocobase/evaluators/client"),require("@nocobase/utils/client"),require("react"),require("lodash"),require("react-i18next")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","@formily/react","react/jsx-runtime","@formily/core","@formily/reactive","@nocobase/evaluators/client","@nocobase/utils/client","react","lodash","react-i18next"],n):(r=typeof globalThis!="undefined"?globalThis:r||self,n(r["@nocobase/plugin-field-formula"]={},r["@nocobase/client"],r["@formily/react"],r.jsxRuntime,r["@formily/core"],r["@formily/reactive"],r["@nocobase/evaluators"],r["@nocobase/utils"],r.react,r.lodash))})(this,function(r,n,a,l,P,j,F,g,d,h){"use strict";var xe=Object.defineProperty,Se=Object.defineProperties;var ye=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var V=(r,n,a)=>n in r?xe(r,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[n]=a,S=(r,n)=>{for(var a in n||(n={}))H.call(n,a)&&V(r,a,n[a]);if(w)for(var a of w(n))L.call(n,a)&&V(r,a,n[a]);return r},T=(r,n)=>Se(r,ye(n));var Q=(r,n)=>{var a={};for(var l in r)H.call(r,l)&&n.indexOf(l)<0&&(a[l]=r[l]);if(r!=null&&w)for(var l of w(r))n.indexOf(l)<0&&L.call(r,l)&&(a[l]=r[l]);return a};var m=(r,n,a)=>(V(r,typeof n!="symbol"?n+"":n,a),a);var W=(r,n,a)=>new Promise((l,P)=>{var j=d=>{try{g(a.next(d))}catch(h){P(h)}},F=d=>{try{g(a.throw(d))}catch(h){P(h)}},g=d=>d.done?l(d.value):Promise.resolve(d.value).then(j,F);g((a=a.apply(r,n)).next())});const X=e=>{var C;const{value:t="",supports:s=[],useCurrentFields:o,onChange:i}=e,p=n.useCompile(),{interfaces:u}=n.useCollectionManager_deprecated(),b=((C=o==null?void 0:o())!=null?C:[]).filter(f=>s.includes(f.interface)).map(f=>{var I,N;return{label:p(f.uiSchema.title),value:f.name,children:(N=(I=u[f.interface]).usePathOptions)==null?void 0:N.call(I,f)}});return l.jsx(n.Variable.TextArea,{value:t,onChange:i,scope:b})},Y={boolean:Boolean,integer:{boolean(e){return Number(e)},number(e){return e>=0?Math.floor(e):Math.ceil(e)},bigint(e){return Number(e)},string(e){const t=Number.parseInt(e,10);return Number.isNaN(t)||!Number.isFinite(t)?null:t},date(e){const t=e.valueOf();return Number.isNaN(t)?null:t}},bigInt:{boolean(e){return Number(e)},number(e){return Math.floor(e>=0?Math.floor(e):Math.ceil(e))},bigint(e){return Number(e)},string(e){const t=Number.parseInt(e,10);return Number.isNaN(t)||!Number.isFinite(t)?null:t},date(e){const t=e.valueOf();return Number.isNaN(t)?null:t}},double:{boolean(e){return Number(e)},number(e){return e},bigint(e){return Number(e)},string(e){const t=Number.parseFloat(e);return Number.isNaN(t)||!Number.isFinite(t)?null:t},date(e){const t=e.valueOf();return Number.isNaN(t)?null:t}},decimal:{boolean(e){return Number(e)},number(e){return e},bigint(e){return e},date(e){const t=e.valueOf();return Number.isNaN(t)?null:t}},string:{boolean(e){return e.toString()},number(e){return e.toString()},bigint(e){return e.toString()},string(e){return e},date(e){return e.toISOString()}},date:{boolean(e){return null},number(e){const t=new Date(e);return Number.isNaN(t.valueOf())?null:t},bigint(e){const t=new Date(Number(e));return Number.isNaN(t.valueOf())?null:t},string(e){const t=Date.parse(e);return Number.isNaN(t)?null:new Date(t)},date(e){return new Date(e)}}};function Z(e,t){if(e==null)return null;let s=typeof e;s=="object"&&e instanceof Date&&(s="date");const o=Y[t];if(!o)return null;if(typeof o=="function")return o(e);const i=o[s];return i?i(e):null}const ee={boolean:n.Checkbox,integer:n.InputNumber,bigInt:n.InputNumber,double:n.InputNumber,decimal:n.InputNumber,date:n.DatePicker,string:n.Input};function A(e){const t=a.useFieldSchema(),s=e||t,o=n.useCollection_deprecated(),{getCollection:i,getCollectionField:p}=n.useCollectionManager_deprecated(),u=s.name.split(".");let c=o;for(let b=0;b<u.length-1;b++){const C=c.getField(u[b]);c=i(C.target)}return p(`${c.name}.${u[u.length-1]}`)}function te(e,t,s){const o=e[t];return Array.isArray(o)?o[s]:o&&typeof o=="object"?o:e}function ne(e,t){const s=t.split(".");let o=0,i=e;for(;o<s.length;){const p=s[o],u=parseInt(s==null?void 0:s[o+1]);i=te(i,p,u),o=o+(u>=0?2:1)}return i}function re(e){const t=/{{([^}]+)}}/g,s=[];let o;for(;(o=t.exec(e))!==null;)s.push(o[1]);return[...new Set(s)]}const oe=e=>{var s;let t=e;for(;t;){if(t["x-component"]==="CollectionField"&&((s=t["x-component-props"])==null?void 0:s.mode)==="SubTable")return t;t=t.parent}return null};function ae(e,t){return h.isString(e)&&!isNaN(Date.parse(e))&&(e=new Date(e)),h.isString(t)&&!isNaN(Date.parse(t))&&(t=new Date(t)),h.isDate(e)&&h.isDate(t)?e.getTime()===t.getTime():h.isEqual(e,t)}function se(e){var G,_,J;const B=e,{value:t}=B,s=Q(B,["value"]),o=a.useFieldSchema(),{dataType:i,expression:p,engine:u="math.js"}=(G=A())!=null?G:{},[c,b]=d.useState(t),{evaluate:C}=F.evaluators.get(u),f=n.useFormBlockContext(),I=a.useField(),N=I.path.entire,D=N==null?void 0:N.replace(`.${o.name}`,""),fe=D.split(".")[0],be=parseInt((_=D.split("."))==null?void 0:_[1]);let O=!!o["x-read-pretty"];const $=N!==D;if($&&!isNaN(be)){const v=oe(o);v&&(O=O||!!v["x-read-pretty"])}d.useEffect(()=>{b(t)},[t]),a.useFormEffects(()=>{const v=re(p);if(!v.length)return;const he=$?`*(${v.map(K=>`${D}.${K}`).join(",")})`:`*(${v.join(",")})`;P.onFieldValueChange(he,(K,U)=>{var z;o.name.indexOf(".")>=0||!(f!=null&&f.form)||(z=f.form)!=null&&z.readPretty||o["x-decorator"]!=="FormItem"||U.setFieldState(fe,Fe=>{let x;const ge=j.toJS(ne(U.values,D));try{x=C(p,ge),x=x&&Z(x,i)}catch(Ce){x=null}x==null&&c==null&&b(x),b(x)})})}),d.useEffect(()=>{ae(I.value,c)||setTimeout(()=>{I.value=c})},[c]);let q=(J=ee[i])!=null?J:n.Input;return q=O?q.ReadPretty:q,l.jsx(q,T(S({},s),{value:i==="double"?g.toFixedByStep(c,e.step):c}))}const M=()=>null;M.Expression=X,M.Result=a.connect(se);const y="field-formula";function ie(e){const t=F.evaluators.get(e);return t!=null&&t.link?l.jsxs(l.Fragment,{children:[l.jsx("span",{className:n.css`
          &:after {
            content: ':';
          }
          & + a {
            margin-left: 0.25em;
          }
        `,children:n.i18n.t("Syntax references",{ns:y})}),l.jsx("a",{href:t.link,target:"_blank",rel:"noreferrer",children:t.label})]}):null}const le=[{dependencies:["dataType"],fulfill:{state:{display:'{{["double", "decimal"].includes($deps[0]) ? "visible" : "none"}}'}}}],k=[{dependencies:["dataType"],fulfill:{state:{display:'{{$deps[0] === "date" ? "visible" : "none"}}'}}}],{defaultProps:ue,dateTimeProps:E,operators:ce}=n.interfacesProperties,me={"uiSchema.x-component-props.dateFormat":T(S({},g.lodash.cloneDeep(E["uiSchema.x-component-props.dateFormat"])),{"x-reactions":k}),"uiSchema.x-component-props.showTime":T(S({},g.lodash.cloneDeep(E["uiSchema.x-component-props.showTime"])),{"x-reactions":[...E["uiSchema.x-component-props.showTime"]["x-reactions"],...k]}),"uiSchema.x-component-props.timeFormat":S({},g.lodash.cloneDeep(E["uiSchema.x-component-props.timeFormat"]))};class de extends n.CollectionFieldInterface{constructor(){super(...arguments);m(this,"name","formula");m(this,"type","object");m(this,"group","advanced");m(this,"order",1);m(this,"title",`{{t("Formula", { ns: "${y}" })}}`);m(this,"description",`{{t("Configure and store the results of calculations between multiple field values in the same record, supporting both Math.js and Excel formula functions.", { ns: "${y}" })}}`);m(this,"sortable",!0);m(this,"default",{type:"formula",uiSchema:{type:"string","x-component":"Formula.Result","x-component-props":{stringMode:!0,step:"1"},"x-read-pretty":!0}});m(this,"properties",T(S(T(S({},ue),{dataType:{type:"string",title:'{{t("Storage type")}}',"x-decorator":"FormItem","x-component":"Select","x-disabled":"{{ !createOnly }}",enum:[{value:"boolean",label:"Boolean"},{value:"integer",label:"Integer"},{value:"bigInt",label:"Big integer"},{value:"double",label:"Double"},{value:"string",label:"String"},{value:"date",label:"Datetime"}],required:!0,default:"double"},"uiSchema.x-component-props.step":{type:"string",title:'{{t("Precision")}}',"x-component":"Select","x-decorator":"FormItem",required:!0,default:"0",enum:[{value:"0",label:"1"},{value:"0.1",label:"1.0"},{value:"0.01",label:"1.00"},{value:"0.001",label:"1.000"},{value:"0.0001",label:"1.0000"},{value:"0.00001",label:"1.00000"},{value:"0.000001",label:"1.000000"}],"x-reactions":le}}),me),{engine:{type:"string",title:`{{t("Calculation engine", { ns: "${y}" })}}`,"x-decorator":"FormItem","x-component":"Radio.Group",enum:Array.from(F.evaluators.getEntities()).reduce((s,[o,i])=>s.concat(S({value:o},i)),[]),required:!0,default:"math.js"},expression:{type:"string",title:`{{t("Expression", { ns: "${y}" })}}`,required:!0,"x-component":"Formula.Expression","x-decorator":"FormItem","x-component-props":{supports:["checkbox","number","percent","integer","number","percent","input","textarea","email","phone","datetime","createdAt","updatedAt","radioGroup","checkboxGroup","select","multipleSelect","formula"],useCurrentFields:"{{ useCurrentFields }}"},"x-reactions":{dependencies:["engine"],fulfill:{schema:{description:"{{renderExpressionDescription($deps[0])}}"}}},"x-validator"(s,o,{form:i}){const{values:p}=i,{evaluate:u}=F.evaluators.get(p.engine),c=s.trim().replace(/{{\s*([^{}]+)\s*}}/g,"1");try{return u(c),""}catch(b){return n.i18n.t("Expression syntax error",{ns:y})}}},frontCalculationOnly:{type:"boolean",title:`{{t("Front Calculation Only", { ns: "${y}" })}}`,"x-content":"","x-decorator":"FormItem","x-component":"Checkbox"}}));m(this,"filterable",{operators:ce.number});m(this,"titleUsable",!0)}}const pe=new n.SchemaSettings({name:"fieldSettings:component:Formula.Result",items:[{name:"displayFormat",Component:n.SchemaSettingsNumberFormat,useComponentProps(){const e=a.useFieldSchema(),{fieldSchema:t}=n.useColumnSchema();return{fieldSchema:t||e}},useVisible(){const e=a.useFieldSchema(),{fieldSchema:t}=n.useColumnSchema(),s=t||e,{dataType:o}=A(s)||{},i=["integer","bigInt","double","decimal"].includes(o);return n.useIsFieldReadPretty()&&i}}]});class R extends n.Plugin{load(){return W(this,null,function*(){this.app.addComponents({Formula:M}),this.app.addScopes({renderExpressionDescription:ie}),this.app.dataSourceManager.addFieldInterfaces([de]),this.app.schemaSettingsManager.add(pe)})}}r.PluginFieldFormulaClient=R,r.default=R,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
