(function(e,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@formily/react"),require("antd"),require("react"),require("@ant-design/icons"),require("@nocobase/plugin-workflow/client"),require("react-i18next"),require("@nocobase/utils/client")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@formily/react","antd","react","@ant-design/icons","@nocobase/plugin-workflow/client","react-i18next","@nocobase/utils/client"],t):(e=typeof globalThis!="undefined"?globalThis:e||self,t(e["@nocobase/plugin-workflow-aggregate"]={},e["@nocobase/client"],e.jsxRuntime,e["@formily/react"],e.antd,e.react,e["@ant-design/icons"],e["@nocobase/plugin-workflow"],e["react-i18next"],e["@nocobase/utils"]))})(this,function(e,t,o,a,S,b,I,s,d,v){"use strict";var Y=Object.defineProperty,Z=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var A=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable;var $=(e,t,o)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,V=(e,t)=>{for(var o in t||(t={}))A.call(t,o)&&$(e,o,t[o]);if(q)for(var o of q(t))N.call(t,o)&&$(e,o,t[o]);return e},B=(e,t)=>Z(e,ee(t));var G=(e,t)=>{var o={};for(var a in e)A.call(e,a)&&t.indexOf(a)<0&&(o[a]=e[a]);if(e!=null&&q)for(var a of q(e))t.indexOf(a)<0&&N.call(e,a)&&(o[a]=e[a]);return o};var g=(e,t,o)=>($(e,typeof t!="symbol"?t+"":t,o),o);var h=(e,t,o)=>new Promise((a,S)=>{var b=d=>{try{s(o.next(d))}catch(v){S(v)}},I=d=>{try{s(o.throw(d))}catch(v){S(v)}},s=d=>d.done?a(d.value):Promise.resolve(d.value).then(b,I);s((o=o.apply(e,t)).next())});const c="workflow-aggregate";function K(i,r={}){const{t:n}=P(r);return n(i)}function P(i){return d.useTranslation(c,i)}function E(i){return["hasMany","belongsToMany"].includes(i.type)}function L(){const i=t.useCompile();return[s.nodesOptions,s.triggerOptions].map(r=>{var p;const n=(p=r.useOptions({types:[E],appends:null,depth:4}))==null?void 0:p.filter(Boolean);return{label:i(r.label),value:r.value,key:r.value,children:i(n),disabled:n&&!n.length}})}function R(p){var u=p,{value:i,onChange:r}=u,n=G(u,["value","onChange"]);const{setValuesIn:C}=a.useForm(),{getCollection:k}=t.useCollectionManager_deprecated(),M=L(),[F,j]=b.useState(M),{associatedKey:U="",name:Q}=i!=null?i:{};let w=[];const D=U.match(/^{{(.*)}}$/);D&&(w=[...D[1].trim().split(".").slice(0,-1),Q]);const X=y=>h(this,null,function*(){var f;const l=y[y.length-1];!((f=l.children)!=null&&f.length)&&!l.isLeaf&&l.loadChildren&&(yield l.loadChildren(l),j(m=>[...m]))});b.useEffect(()=>{h(this,null,function*(){var f;if(!w||F.length<=1)return;let l=null;for(let m=0;m<w.length;m++){const T=w[m];try{m===0?l=F.find(x=>x.value===T):(l.loadChildren&&!((f=l.children)!=null&&f.length)&&(yield l.loadChildren(l)),l=l.children.find(x=>x.value===T))}catch(x){v.captureException(x)}}j([...F])})},[i,F.length]);const H=b.useCallback((y,l)=>{if(!(y!=null&&y.length)){C("collection",null),r({});return}const{field:f}=l.pop();if(!f||!["hasMany","belongsToMany"].includes(f.type))return;const{collectionName:m,target:T,name:x,dataSourceKey:O}=f,J=k(m,O).fields.find(W=>W.primaryKey);C("collection",`${O}:${T}`),r({name:x,associatedKey:`{{${y.slice(0,-1).join(".")}.${J.name}}}`,associatedCollection:t.joinCollectionName(O,m)})},[r]);return o.jsx(S.Cascader,B(V({},n),{value:w,options:F,changeOnSelect:!0,onChange:H,loadData:X}))}class _ extends s.Instruction{constructor(){super(...arguments);g(this,"title",`{{t("Aggregate", { ns: "${c}" })}}`);g(this,"type","aggregate");g(this,"group","collection");g(this,"description",`{{t("Counting, summing, finding maximum, minimum, and average values for multiple records of a collection or associated data of a record.", { ns: "${c}" })}}`);g(this,"icon",o.jsx(I.BarChartOutlined,{}));g(this,"fieldset",{aggregator:{type:"string",title:`{{t("Aggregator function", { ns: "${c}" })}}`,"x-decorator":"FormItem","x-component":"Radio.Group",enum:[{label:"COUNT",value:"count"},{label:"SUM",value:"sum"},{label:"AVG",value:"avg"},{label:"MIN",value:"min"},{label:"MAX",value:"max"}],required:!0,default:"count"},associated:{type:"boolean",title:`{{t("Target type", { ns: "${c}" })}}`,"x-decorator":"FormItem","x-component":"Radio.Group",enum:[{label:`{{t("Data of collection", { ns: "${c}" })}}`,value:!1},{label:`{{t("Data of associated collection", { ns: "${c}" })}}`,value:!0}],required:!0,default:!1,"x-reactions":[{target:"collection",effects:["onFieldValueChange"],fulfill:{state:{value:null}}},{target:"association",effects:["onFieldValueChange"],fulfill:{state:{value:null}}}]},collectionField:{type:"void","x-decorator":"SchemaComponentContext.Provider","x-decorator-props":{value:{designable:!1}},"x-component":"Grid",properties:{row:{type:"void","x-component":"Grid.Row",properties:{target:{type:"void","x-component":"Grid.Col",properties:{collection:{type:"string",required:!0,"x-decorator":"FormItem","x-component":"DataSourceCollectionCascader",title:`{{t("Data of collection", { ns: "${c}" })}}`,"x-reactions":[{dependencies:["associated"],fulfill:{state:{display:'{{$deps[0] ? "hidden" : "visible"}}'}}},{target:"params.field",effects:["onFieldValueChange"],fulfill:{state:{value:null}}},{target:"params.filter",effects:["onFieldValueChange"],fulfill:{state:{value:null}}}]},association:{type:"object",title:`{{t("Data of associated collection", { ns: "${c}" })}}`,"x-decorator":"FormItem","x-component":"AssociatedConfig","x-component-props":{changeOnSelect:!0},"x-reactions":[{dependencies:["associated"],fulfill:{state:{visible:"{{!!$deps[0]}}"}}}],required:!0}}},field:{type:"void","x-component":"Grid.Col",properties:{"params.field":{type:"string",title:`{{t("Field to aggregate", { ns: "${c}" })}}`,"x-decorator":"FormItem","x-component":"FieldsSelect","x-component-props":{filter(n){return!n.hidden&&n.interface&&!["belongsTo","hasOne","hasMany","belongsToMany"].includes(n.type)}},required:!0,"x-reactions":[{dependencies:["collection"],fulfill:{state:{visible:"{{!!$deps[0]}}"}}}]}}}}}}},params:{type:"object",properties:{distinct:{type:"boolean",title:`{{t("Distinct", { ns: "${c}" })}}`,"x-decorator":"FormItem","x-component":"Checkbox","x-reactions":[{dependencies:["collection","aggregator"],fulfill:{state:{visible:'{{!!$deps[0] && ["count"].includes($deps[1])}}'}}}]},filter:{type:"object",title:'{{t("Filter")}}',"x-decorator":"FormItem","x-component":"Filter","x-use-component-props":()=>{const{values:n}=a.useForm(),[p,u]=t.parseCollectionName(n==null?void 0:n.collection);return{options:t.useCollectionFilterOptions(u,p),className:t.css`
                position: relative;
                width: 100%;
              `}},"x-component-props":{dynamicComponent:"FilterDynamicComponent"},"x-reactions":[{dependencies:["collection"],fulfill:{state:{visible:"{{!!$deps[0]}}"}}}]}}}});g(this,"scope",{useCollectionDataSource:t.useCollectionDataSource});g(this,"components",{SchemaComponentContext:t.SchemaComponentContext,FilterDynamicComponent:s.FilterDynamicComponent,FieldsSelect:s.FieldsSelect,ValueBlock:s.ValueBlock,AssociatedConfig:R})}useVariables({key:n,title:p},{types:u,fieldNames:C=s.defaultFieldNames}){return u&&!u.some(k=>k in s.BaseTypeSets||Object.values(s.BaseTypeSets).some(M=>M.has(k)))?null:{[C.value]:n,[C.label]:p}}useInitializers(n){var u;const p=K("Query result");return n.config.collection?{name:`#${n.id}`,type:"item",title:(u=n.title)!=null?u:`#${n.id}`,Component:s.ValueBlock.Initializer,node:n,resultTitle:p}:null}}class z extends t.Plugin{afterAdd(){return h(this,null,function*(){})}beforeLoad(){return h(this,null,function*(){})}load(){return h(this,null,function*(){this.app.pm.get("workflow").registerInstruction("aggregate",_)})}}e.default=z,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
