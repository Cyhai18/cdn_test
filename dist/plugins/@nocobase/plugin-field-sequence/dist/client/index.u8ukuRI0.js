(function(o,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@formily/antd-v5"),require("@formily/core"),require("@formily/react"),require("@nocobase/utils/client"),require("antd"),require("react"),require("react-i18next")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@formily/antd-v5","@formily/core","@formily/react","@nocobase/utils/client","antd","react","react-i18next"],e):(o=typeof globalThis!="undefined"?globalThis:o||self,e(o["@nocobase/plugin-field-sequence"]={},o["@nocobase/client"],o.jsxRuntime,o["@formily/antd-v5"],o["@formily/core"],o["@formily/react"],o["@nocobase/utils"],o.antd,o.react,o["react-i18next"]))})(this,function(o,e,t,u,S,y,I,d,m,v){"use strict";var w=Object.defineProperty,z=Object.defineProperties;var E=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var q=(o,e,t)=>e in o?w(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,h=(o,e)=>{for(var t in e||(e={}))B.call(e,t)&&q(o,t,e[t]);if(D)for(var t of D(e))_.call(e,t)&&q(o,t,e[t]);return o},F=(o,e)=>z(o,E(e));var l=(o,e,t)=>(q(o,typeof e!="symbol"?e+"":e,t),t);var M=(o,e,t)=>new Promise((u,S)=>{var y=m=>{try{d(t.next(m))}catch(v){S(v)}},I=m=>{try{d(t.throw(m))}catch(v){S(v)}},d=m=>m.done?u(m.value):Promise.resolve(m.value).then(y,I);d((t=t.apply(o,e)).next())});const s="field-sequence";function A(n,i={}){return e.i18n.t(n,F(h({},i),{ns:s}))}function j(n){const i=e.useCompile(),{setValuesIn:a}=y.useForm(),p=u.ArrayTable.useIndex();return y.useFormEffects(()=>{S.onFieldValueChange(`patterns.${p}.type`,r=>{const f=b[r.value];a(`patterns.${p}.options`,f.defaults?h({},f.defaults):{})})}),t.jsx(d.Select,F(h({popupMatchSelectWidth:!1},n),{children:Object.keys(b).map(r=>t.jsx(d.Select.Option,{value:r,children:i(b[r].title)},r))}))}function P(){const n=e.useCompile(),{values:i}=y.useForm(),a=u.ArrayTable.useIndex(),{type:p,options:r}=i.patterns[a],f=b[p];return t.jsx("div",{className:e.css`
        display: flex;
        gap: 1em;
        flex-wrap: wrap;
      `,children:Object.keys(r).filter(c=>typeof r[c]!="undefined"&&f.optionRenders[c]).map(c=>{const C=f.optionRenders[c],{title:x}=f.fieldset[c];return C?t.jsxs("dl",{className:e.css`
                margin: 0;
                padding: 0;
              `,children:[t.jsx("dt",{children:n(x)}),t.jsx("dd",{className:e.css`
                  margin-bottom: 0;
                `,children:t.jsx(C,{value:r[c]},c)})]},c):null})})}const b={string:{title:`{{t("Fixed text", { ns: "${s}" })}}`,optionRenders:{value(n={value:""}){return t.jsx("code",{children:n.value})}},fieldset:{value:{type:"string",title:`{{t("Text content", { ns: "${s}" })}}`,"x-decorator":"FormItem","x-component":"Input"}}},integer:{title:`{{t("Autoincrement", { ns: "${s}" })}}`,optionRenders:{digits:function({value:i}){return t.jsx("code",{children:i})},start:function({value:i}){return t.jsx("code",{children:i})},cycle:e.Cron.ReadPretty},fieldset:{digits:{type:"number",title:`{{t("Digits", { ns: "${s}" })}}`,"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{min:1,max:10},required:!0,default:1,"x-reactions":{target:"start",fulfill:{schema:{"x-component-props.max":"{{ 10 ** $self.value - 1 }}"}}}},start:{type:"number",title:`{{t("Start from", { ns: "${s}" })}}`,"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{min:0},required:!0,default:0},cycle:{type:"string",title:`{{t("Reset cycle", { ns: "${s}" })}}`,"x-decorator":"FormItem","x-component"({value:n,onChange:i}){const a=[{label:"No reset",value:0},{label:"Daily",value:1,cron:"0 0 * * *"},{label:"Every Monday",value:2,cron:"0 0 * * 1"},{label:"Monthly",value:3,cron:"0 0 1 * *"},{label:"Yearly",value:4,cron:"0 0 1 1 *"},{label:"Customize",value:5,cron:"* * * * *"}],p=typeof n=="undefined"?a[0]:a.find(r=>r.cron==n)||a[5];return t.jsxs("fieldset",{children:[t.jsx(d.Select,{value:p.value,onChange:r=>i(a[r].cron),children:a.map(r=>t.jsx(d.Select.Option,{value:r.value,children:A(r.label)},r.value))}),p.value===5?t.jsx(e.Cron,{value:n,onChange:i,clearButton:!1}):null]})},default:null}},defaults:{digits:4,start:1}},date:{title:`{{t("Date", { ns: "${s}" })}}`,optionRenders:{format(n={value:"YYYYMMDD"}){return t.jsx("code",{children:n.value})}},fieldset:{format:{type:"string",title:`{{t("Date format", { ns: "${s}" })}}`,description:`{{t('Supports all formats of the Day.js library, such as "YYYYMMDD", "YYYY-MM-DD", etc.', { ns: "${s}" })}}`,"x-decorator":"FormItem","x-component":"Input",default:"YYYYMMDD"}},defaults:{format:"YYYYMMDD"}}};function $(){const{t:n}=v.useTranslation(),i=e.useCompile(),a=m.useContext(y.SchemaOptionsContext),{values:p,setValuesIn:r}=y.useForm(),f=u.ArrayTable.useIndex(),{type:c,options:C}=p.patterns[f],x=b[c],{token:Y}=e.useToken();return x!=null&&x.fieldset?t.jsx(d.Button,{type:"link",onClick:()=>{u.FormDrawer({title:i(x.title),zIndex:Y.zIndexPopupBase+1e3},()=>t.jsx(u.FormLayout,{layout:"vertical",children:t.jsx(e.SchemaComponentOptions,{scope:a.scope,components:a.components,children:t.jsxs(e.ScopeThemeProvider,{themeConfigFromProps:{token:Y},children:[t.jsx(e.SchemaComponent,{schema:{type:"object","x-component":"fieldset",properties:x.fieldset}}),t.jsx(u.FormDrawer.Footer,{children:t.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:t.jsx(u.Submit,{onSubmit:g=>g,children:n("Submit")})})})]})})})).open({initialValues:C}).then(g=>{r(`patterns.${f}`,{type:c,options:h({},g)})}).catch(g=>{I.error(g)})},children:n("Configure")}):null}class O extends e.CollectionFieldInterface{constructor(){super(...arguments);l(this,"name","sequence");l(this,"type","object");l(this,"group","advanced");l(this,"order",3);l(this,"title",`{{t("Sequence", { ns: "${s}" })}}`);l(this,"description",`{{t("Automatically generate codes based on configured rules, supporting combinations of dates, numbers, and text.", { ns: "${s}" })}}`);l(this,"sortable",!0);l(this,"default",{type:"sequence",uiSchema:{type:"string","x-component":"Input","x-component-props":{}}});l(this,"availableTypes",["string"]);l(this,"hasDefaultValue",!1);l(this,"filterable",{operators:e.interfacesProperties.operators.string});l(this,"titleUsable",!0);l(this,"properties",F(h({},e.interfacesProperties.defaultProps),{unique:e.interfacesProperties.unique,patterns:{type:"array",title:`{{t("Sequence rules", { ns: "${s}" })}}`,required:!0,"x-decorator":"FormItem","x-component":"ArrayTable",items:{type:"object",properties:{sort:{type:"void","x-component":"ArrayTable.Column","x-component-props":{width:50,title:"",align:"center"},properties:{sort:{type:"void","x-component":"ArrayTable.SortHandle"}}},type:{type:"void","x-component":"ArrayTable.Column","x-component-props":{title:`{{t("Type", { ns: "${s}" })}}`},properties:{type:{type:"string",name:"type",required:!0,"x-decorator":"FormItem","x-component":j}}},options:{type:"void","x-component":"ArrayTable.Column","x-component-props":{title:`{{t("Rule content", { ns: "${s}" })}}`},properties:{options:{type:"object",name:"options","x-component":P}}},operations:{type:"void","x-component":"ArrayTable.Column","x-component-props":{title:`{{t("Operations", { ns: "${s}" })}}`,dataIndex:"operations",fixed:"right",className:e.css`
                > *:not(:last-child) {
                  margin-right: 0.5em;
                }
                button {
                  padding: 0;
                }
              `},properties:{config:{type:"void",properties:{options:{type:"object","x-component":$}}},remove:{type:"void","x-component":"ArrayTable.Remove"}}}}},properties:{add:{type:"void","x-component":"ArrayTable.Addition","x-component-props":{defaultValue:{type:"integer",options:h({},b.integer.defaults)}},title:`{{t("Add rule", { ns: "${s}" })}}`}}},inputable:{type:"boolean",title:`{{t("Inputable", { ns: "${s}" })}}`,"x-decorator":"FormItem","x-component":"Checkbox"},match:{type:"boolean",title:`{{t("Match rules", { ns: "${s}" })}}`,"x-decorator":"FormItem","x-component":"Checkbox","x-reactions":{dependencies:["inputable"],fulfill:{state:{value:"{{$deps[0] && $self.value}}",visible:"{{$deps[0] === true}}"}}}}}))}schemaInitialize(a,{block:p,field:r}){return p==="Form"&&Object.assign(a["x-component-props"],{disabled:!r.inputable}),a}}const N=n=>t.jsx(e.SchemaComponentOptions,{components:{RuleConfigForm:$},children:n.children});class T extends e.Plugin{load(){return M(this,null,function*(){this.app.use(N),this.app.dataSourceManager.addFieldInterfaces([O])})}}o.PluginFieldSequenceClient=T,o.default=T,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
