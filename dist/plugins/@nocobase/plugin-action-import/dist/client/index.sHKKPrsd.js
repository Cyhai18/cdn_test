(function(l,p){typeof exports=="object"&&typeof module!="undefined"?p(exports,require("react/jsx-runtime"),require("@formily/react"),require("@formily/shared"),require("@nocobase/client"),require("antd"),require("react-i18next"),require("@formily/antd-v5"),require("react"),require("react-dom"),require("@ant-design/icons"),require("@nocobase/utils/client"),require("lodash")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@formily/react","@formily/shared","@nocobase/client","antd","react-i18next","@formily/antd-v5","react","react-dom","@ant-design/icons","@nocobase/utils/client","lodash"],p):(l=typeof globalThis!="undefined"?globalThis:l||self,p(l["@nocobase/plugin-action-import"]={},l.jsxRuntime,l["@formily/react"],l["@formily/shared"],l["@nocobase/client"],l.antd,l["react-i18next"],l["@formily/antd-v5"],l.react,l["react-dom"],l["@ant-design/icons"],l["@nocobase/utils"],l.lodash))})(this,function(l,p,h,z,c,E,F,O,y,k,X,N,G){"use strict";var we=Object.defineProperty,Ce=Object.defineProperties;var Te=Object.getOwnPropertyDescriptors;var xe=Object.getOwnPropertySymbols;var Fe=Object.prototype.hasOwnProperty,Ee=Object.prototype.propertyIsEnumerable;var fe=(l,p,h)=>p in l?we(l,p,{enumerable:!0,configurable:!0,writable:!0,value:h}):l[p]=h,B=(l,p)=>{for(var h in p||(p={}))Fe.call(p,h)&&fe(l,h,p[h]);if(xe)for(var h of xe(p))Ee.call(p,h)&&fe(l,h,p[h]);return l},$=(l,p)=>Ce(l,Te(p));var H=(l,p,h)=>new Promise((z,c)=>{var E=y=>{try{O(h.next(y))}catch(k){c(k)}},F=y=>{try{O(h.throw(y))}catch(k){c(k)}},O=y=>y.done?z(y.value):Promise.resolve(y.value).then(E,F);O((h=h.apply(l,p)).next())});const A="action-import",he=["id","createdAt","createdBy","updatedAt","updatedBy"],W=t=>{const{getCollectionFields:e}=c.useCollectionManager_deprecated(),n=e(t),s=(r,i)=>{var f;if(!r.interface||he.includes(r.interface))return;const u={name:r.name,title:((f=r==null?void 0:r.uiSchema)==null?void 0:f.title)||r.name,schema:r==null?void 0:r.uiSchema};if(!r.target||i>=2)return u;if(r.target){const a=e(r.target),o=d(a,i+1).filter(Boolean);u.children=u.children||[],u.children.push(...o)}return u},d=(r,i)=>{const u=[];return r.forEach(f=>{const a=s(f,i);a&&u.push(a)}),u};return d(n,1)},ge="action-import";function ye(){return F.useTranslation([ge,"client"],{nsMode:"fallback"})}const J=(t,e,n)=>t.reduceProperties((s,d)=>{if(d[e]===n)return d;const r=J(d,e,n);return r||s}),ve=(t,e)=>e(t),K=(t,e,n=J,s=ve)=>{const d=h.useFieldSchema(),{remove:r}=c.useDesignable(),i=n(d,e,t);return{schema:i,exists:!!i,remove(){i&&s(i,r)}}},Ie=t=>({importColumns:t==null?void 0:t.filter(n=>!n.children).map(n=>({dataIndex:[n.name]})),explain:""}),Y=()=>{const{t}=ye();return p.jsx(E.Alert,{type:"warning",style:{marginBottom:"10px"},message:t("Import warning")})},Q=()=>{const t=c.useSchemaInitializerItem(),{insert:e}=c.useSchemaInitializer(),{exists:n,remove:s}=K("importXlsx","x-action",t.find,t.remove),{name:d}=c.useCollection_deprecated(),r=W(d),i={type:"void",title:'{{ t("Import") }}',"x-action":"importXlsx","x-action-settings":{importSettings:{importColumns:[],explain:""}},"x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:import","x-component":"Action","x-component-props":{icon:"CloudUploadOutlined",openMode:"popup"},properties:{modal:{type:"void",title:`{{ t("Import Data", {ns: "${A}" }) }}`,"x-component":"Action.Container","x-decorator":"Form","x-component-props":{width:"50%",className:c.css`
            .ant-formily-item-label {
              height: var(--controlHeightLG);
            }
          `},properties:{formLayout:{type:"void","x-component":"FormLayout",properties:{warning:{type:"void","x-component":"ImportWarning"},download:{type:"void",title:`{{ t("Step 1: Download template", {ns: "${A}" }) }}`,"x-component":"FormItem","x-acl-ignore":!0,properties:{tip:{type:"void","x-component":"Markdown.Void","x-editable":!1,"x-component-props":{style:{padding:"var(--paddingContentVerticalSM)",backgroundColor:"var(--colorInfoBg)",border:"1px solid var(--colorInfoBorder)",color:"var(--colorText)",marginBottom:"var(--marginSM)"},content:`{{ t("Download tip", {ns: "${A}" }) }}`}},downloadAction:{type:"void",title:`{{ t("Download template", {ns: "${A}" }) }}`,"x-component":"Action","x-component-props":{className:c.css`
                        margin-top: 5px;
                      `,useAction:"{{ useDownloadXlsxTemplateAction }}"}}}},upload:{type:"array",title:`{{ t("Step 2: Upload Excel", {ns: "${A}" }) }}`,"x-decorator":"FormItem","x-acl-ignore":!0,"x-component":"Upload.Dragger","x-validator":"{{ uploadValidator }}","x-component-props":{action:"",height:"150px",tipContent:`{{ t("Upload placeholder", {ns: "${A}" }) }}`,beforeUpload:"{{ beforeUploadHandler }}"}}}},footer:{"x-component":"Action.Container.Footer","x-component-props":{},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{},properties:{cancel:{type:"void",title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},startImport:{type:"void",title:`{{ t("Start import", {ns: "${A}" }) }}`,"x-component":"Action","x-component-props":{type:"primary",htmlType:"submit",useAction:"{{ useImportStartAction }}"},"x-reactions":{dependencies:["upload"],fulfill:{run:"validateUpload($form, $self, $deps)"}}}}}}}}}}};return p.jsx(c.SchemaInitializerSwitch,$(B({},t),{checked:n,title:t.title,onClick:()=>{var f;if(n)return s();i["x-action-settings"].importSettings=Ie(r);const u=z.merge(i||{},t.schema||{});(f=t==null?void 0:t.schemaInitialize)==null||f.call(t,u),e(u)}}))},Se=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/wps-office.xlsx"],R=()=>{const{t}=F.useTranslation(A),{name:e}=c.useCollection_deprecated(),n=W(e);return{importSettingsSchema:{type:"void","x-component":"Grid",properties:{explain:{type:"string",title:`{{ t("Import explain", {ns: "${A}"}) }}`,"x-decorator":"FormItem","x-component":"Input.TextArea"},importColumns:{type:"array","x-component":"ArrayItems","x-decorator":"FormItem",items:{type:"object",properties:{space:{type:"void","x-component":"Space","x-component-props":{className:c.css`
                    width: 100%;
                    & .ant-space-item:nth-child(2) {
                      flex: 1;
                    }
                  `},properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},dataIndex:{type:"array","x-decorator":"FormItem","x-component":c.Cascader,required:!0,enum:n,"x-component-props":{fieldNames:{label:"title",value:"name",children:"children"},changeOnSelect:!1}},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:`{{ t("Add importable field", {ns: "${A}"}) }}`,"x-component":"ArrayItems.Addition","x-component-props":{className:c.css`
                  border-color: var(--colorSettings);
                  color: var(--colorSettings);
                  &.ant-btn-dashed:hover {
                    border-color: var(--colorSettings);
                    color: var(--colorSettings);
                  }
                `}}}}}},beforeUploadHandler(){return!1},uploadValidator(s,d){var i;if(s.length>1)return{type:"error",message:t("Only one file is allowed to be uploaded")};const r=(i=s[0])!=null?i:{};return r.size>10*1024*1024?{type:"error",message:t("File size cannot exceed 10M")}:Se.includes(r.type)?"":{type:"error",message:t("Please upload the file of Excel")}},validateUpload(s,d,r){var u;const[i]=r;d.disabled=(i==null?void 0:i.length)===0,d.componentProps=$(B({},d.componentProps),{disabled:(i==null?void 0:i.length)===0||((u=s.errors)==null?void 0:u.length)>0})}}},Z=()=>{var u,f,a,o,g,m;const t=h.useField(),e=h.useFieldSchema(),{t:n}=F.useTranslation(),{dn:s}=c.useDesignable(),[d,r]=y.useState(),{importSettingsSchema:i}=R();return y.useEffect(()=>{r(i)},[t.address,(u=e==null?void 0:e["x-action-settings"])==null?void 0:u.importSettings]),p.jsxs(c.GeneralSchemaDesigner,{disableInitializer:!0,children:[p.jsx(c.SchemaSettingsModalItem,{title:n("Edit button"),schema:{type:"object",title:n("Edit button"),properties:{title:{"x-decorator":"FormItem","x-component":"Input",title:n("Button title"),default:e.title,"x-component-props":{}},icon:{"x-decorator":"FormItem","x-component":"IconPicker",title:n("Button icon"),default:(f=e==null?void 0:e["x-component-props"])==null?void 0:f.icon,"x-component-props":{}},type:{"x-decorator":"FormItem","x-component":"Radio.Group",title:n("Button background color"),default:(a=e==null?void 0:e["x-component-props"])!=null&&a.danger?"danger":((o=e==null?void 0:e["x-component-props"])==null?void 0:o.type)==="primary"?"primary":"default",enum:[{value:"default",label:'{{t("Default")}}'},{value:"primary",label:'{{t("Highlight")}}'},{value:"danger",label:'{{t("Secondary")}}'}]}}},onSubmit:({title:x,icon:v,type:I})=>{e.title=x,t.title=x,t.componentProps.icon=v,t.componentProps.danger=I==="danger",t.componentProps.type=I,e["x-component-props"]=e["x-component-props"]||{},e["x-component-props"].icon=v,e["x-component-props"].danger=I==="danger",e["x-component-props"].type=I,s.emit("patch",{schema:{"x-uid":e["x-uid"],title:x,"x-component-props":B({},e["x-component-props"])}}),s.refresh()}}),p.jsx(c.SchemaSettingsActionModalItem,{title:n("Importable fields"),schema:d,initialValues:B({},(m=(g=e==null?void 0:e["x-action-settings"])==null?void 0:g.importSettings)!=null?m:{}),components:{ArrayItems:O.ArrayItems},onSubmit:({importColumns:x,explain:v})=>{const I=x==null?void 0:x.filter(b=>{var C;return(C=b==null?void 0:b.dataIndex)==null?void 0:C.length}).map(b=>({dataIndex:b.dataIndex.map(C=>{var T;return(T=C.name)!=null?T:C}),title:b.title}));e["x-action-settings"].importSettings={importColumns:I,explain:v},s.emit("patch",{schema:{"x-uid":e["x-uid"],"x-action-settings":e["x-action-settings"]}}),s.refresh()}}),p.jsx(c.SchemaSettingsDivider,{}),p.jsx(c.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:x=>x["x-component"]==="Space"||x["x-component"].endsWith("ActionBar"),confirm:{title:n("Delete action")}})]})},V=y.createContext(null);V.displayName="ImportContext";const ee=()=>y.useContext(V);var L=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},te={exports:{}};(function(t,e){(function(n,s){s()})(L,function(){function n(a,o){return typeof o=="undefined"?o={autoBom:!1}:typeof o!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\uFEFF",a],{type:a.type}):a}function s(a,o,g){var m=new XMLHttpRequest;m.open("GET",a),m.responseType="blob",m.onload=function(){f(m.response,o,g)},m.onerror=function(){console.error("could not download file")},m.send()}function d(a){var o=new XMLHttpRequest;o.open("HEAD",a,!1);try{o.send()}catch(g){}return 200<=o.status&&299>=o.status}function r(a){try{a.dispatchEvent(new MouseEvent("click"))}catch(g){var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(o)}}var i=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof L=="object"&&L.global===L?L:void 0,u=i.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),f=i.saveAs||(typeof window!="object"||window!==i?function(){}:"download"in HTMLAnchorElement.prototype&&!u?function(a,o,g){var m=i.URL||i.webkitURL,x=document.createElement("a");o=o||a.name||"download",x.download=o,x.rel="noopener",typeof a=="string"?(x.href=a,x.origin===location.origin?r(x):d(x.href)?s(a,o,g):r(x,x.target="_blank")):(x.href=m.createObjectURL(a),setTimeout(function(){m.revokeObjectURL(x.href)},4e4),setTimeout(function(){r(x)},0))}:"msSaveOrOpenBlob"in navigator?function(a,o,g){if(o=o||a.name||"download",typeof a!="string")navigator.msSaveOrOpenBlob(n(a,g),o);else if(d(a))s(a,o,g);else{var m=document.createElement("a");m.href=a,m.target="_blank",setTimeout(function(){r(m)})}}:function(a,o,g,m){if(m=m||open("","_blank"),m&&(m.document.title=m.document.body.innerText="downloading..."),typeof a=="string")return s(a,o,g);var x=a.type==="application/octet-stream",v=/constructor/i.test(i.HTMLElement)||i.safari,I=/CriOS\/[\d]+/.test(navigator.userAgent);if((I||x&&v||u)&&typeof FileReader!="undefined"){var b=new FileReader;b.onloadend=function(){var S=b.result;S=I?S:S.replace(/^data:[^;]*;/,"data:attachment/file;"),m?m.location.href=S:location=S,m=null},b.readAsDataURL(a)}else{var C=i.URL||i.webkitURL,T=C.createObjectURL(a);m?m.location=T:location.href=T,m=null,setTimeout(function(){C.revokeObjectURL(T)},4e4)}});i.saveAs=f.saveAs=f,t.exports=f})})(te);var oe=te.exports;const j={IMPORTING:1,IMPORTED:2},be=t=>{const e=c.useAPIClient(),{t:n}=F.useTranslation(A),{importModalVisible:s,importStatus:d,importResult:r,setImportModalVisible:i}=ee(),{data:u,meta:f}=r!=null?r:{},a=()=>{i(!1)},o=()=>{const g=new Int8Array(u==null?void 0:u.data),m=new Blob([g],{type:"application/x-xls"});if(N.isInFlutter){N.definedUploadFileHandle(e,m,"fail.xlsx");return}oe.saveAs(m,"fail.xlsx")};return p.jsx(E.Modal,{title:n("Import Data"),width:"50%",styles:{body:{height:"calc(80vh - 200px)"}},open:s,footer:null,closable:d===j.IMPORTED,onCancel:a,children:p.jsxs("div",{className:c.css`
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100%;
        `,children:[d===j.IMPORTING&&p.jsx(E.Spin,{indicator:p.jsx(X.LoadingOutlined,{style:{fontSize:24},spin:!0}),tip:n("Excel data importing")}),d===j.IMPORTED&&p.jsxs(E.Space,{direction:"vertical",align:"center",children:[p.jsx(X.ExclamationCircleFilled,{style:{fontSize:72,color:"#1890ff"}}),p.jsx("p",{children:n("Import done, total success have {{successCount}} , total failure have {{failureCount}}",B({},f!=null?f:{}))}),p.jsxs(E.Space,{children:[(f==null?void 0:f.failureCount)>0&&p.jsx(E.Button,{onClick:o,children:n("To download the failure data")}),p.jsx(E.Button,{type:"primary",onClick:a,children:n("Done")})]})]})]})})},ne=t=>{let e=t;for(;e&&e["x-action"]!=="importXlsx";)e=e.parent;return{schema:e}},re=t=>!t||!Array.isArray(t)?[]:t,ae=()=>{const{service:t,resource:e}=c.useBlockRequestContext(),n=c.useAPIClient(),s=h.useFieldSchema(),d=c.useCompile(),{getCollectionJoinField:r,getCollectionField:i}=c.useCollectionManager_deprecated(),{name:u,title:f,getField:a}=c.useCollection_deprecated();F.useTranslation(A);const{schema:o}=ne(s);return{run(){return H(this,null,function*(){var C,T;const{importColumns:m,explain:x}=G.cloneDeep((T=(C=o==null?void 0:o["x-action-settings"])==null?void 0:C.importSettings)!=null?T:{}),v=re(m).map(S=>{var D,_;const M=i(`${u}.${S.dataIndex[0]}`);if(M){if(S.defaultTitle=d((D=M==null?void 0:M.uiSchema)==null?void 0:D.title)||M.name,S.dataIndex.length>1){const P=r(`${u}.${S.dataIndex.join(".")}`);if(!P)return;S.defaultTitle=S.defaultTitle+"/"+d((_=P==null?void 0:P.uiSchema)==null?void 0:_.title)||P.name}return M.interface==="chinaRegion"&&S.dataIndex.push("name"),S}}).filter(Boolean),{data:I}=yield e.downloadXlsxTemplate({values:{title:d(f),explain:x,columns:d(v)}},{method:"post",responseType:"blob"}),b=new Blob([I],{type:"application/x-xls"});if(N.isInFlutter){N.definedUploadFileHandle(n,b,`${d(f)}.xlsx`);return}oe.saveAs(b,`${d(f)}.xlsx`)})}}},ie=()=>{const{service:t,resource:e}=c.useBlockRequestContext(),n=c.useAPIClient(),s=h.useFieldSchema(),d=c.useCompile(),{getCollectionJoinField:r,getCollectionField:i}=c.useCollectionManager_deprecated(),{name:u,title:f,getField:a}=c.useCollection_deprecated();F.useTranslation(A);const{schema:o}=ne(s),g=h.useForm(),{setVisible:m,fieldSchema:x}=c.useActionContext(),{setImportModalVisible:v,setImportStatus:I,setImportResult:b}=ee();return{run(){return H(this,null,function*(){var P,le,de;const{importColumns:T,explain:S}=G.cloneDeep((le=(P=o==null?void 0:o["x-action-settings"])==null?void 0:P.importSettings)!=null?le:{}),M=re(T).map(w=>{var me,ue;const U=i(`${u}.${w.dataIndex[0]}`);if(U){if(w.defaultTitle=d((me=U==null?void 0:U.uiSchema)==null?void 0:me.title)||U.name,w.dataIndex.length>1){const q=r(`${u}.${w.dataIndex.join(".")}`);if(!q)return;w.defaultTitle=w.defaultTitle+"/"+d((ue=q==null?void 0:q.uiSchema)==null?void 0:ue.title)||q.name}return U.interface==="chinaRegion"&&w.dataIndex.push("name"),w}}).filter(Boolean),D=new FormData,_=g.values.upload.map(w=>w.originFileObj);D.append("file",_[0]),D.append("columns",JSON.stringify(M)),D.append("explain",S),m(!1),v(!0),I(j.IMPORTING);try{const{data:w}=yield n.axios.post(`${u}:importXlsx`,D,{timeout:6e5});b(w),g.reset(),yield(de=t==null?void 0:t.refresh)==null?void 0:de.call(t),I(j.IMPORTED)}catch(w){v(!1),m(!0)}})}}},se=t=>{const{uploadValidator:e,beforeUploadHandler:n,validateUpload:s}=R();return p.jsx(c.SchemaComponentOptions,{components:{ImportActionInitializer:Q,ImportDesigner:Z,ImportWarning:Y},scope:{uploadValidator:e,validateUpload:s,beforeUploadHandler:n,useDownloadXlsxTemplateAction:ae,useImportStartAction:ie},children:p.jsx(ce,{children:t.children})})},ce=t=>{const[e,n]=y.useState(!1),[s,d]=y.useState(j.IMPORTING),[r,i]=y.useState(null);return p.jsxs(V.Provider,{value:{importModalVisible:e,setImportModalVisible:n,importStatus:s,setImportStatus:d,importResult:r,setImportResult:i},children:[k.createPortal(p.jsx(be,{}),document.body),t.children]})},Ae=new c.SchemaSettings({name:"actionSettings:import",items:[{name:"editButton",Component:c.ButtonEditor,useComponentProps(){const{buttonEditorProps:t}=c.useSchemaToolbar();return t}},{name:"importableFields",type:"actionModal",useComponentProps(){var u,f,a;const t=h.useField(),e=h.useFieldSchema(),{t:n}=F.useTranslation(),{dn:s}=c.useDesignable(),[d,r]=y.useState(),{importSettingsSchema:i}=R();return y.useEffect(()=>{r(i)},[t.address,(u=e==null?void 0:e["x-action-settings"])==null?void 0:u.importSettings]),{title:n("Importable fields"),schema:d,initialValues:B({},(a=(f=e==null?void 0:e["x-action-settings"])==null?void 0:f.importSettings)!=null?a:{}),components:{ArrayItems:O.ArrayItems},onSubmit:({importColumns:o,explain:g})=>{const m=o==null?void 0:o.filter(x=>{var v;return(v=x==null?void 0:x.dataIndex)==null?void 0:v.length}).map(x=>({dataIndex:x.dataIndex.map(v=>{var I;return(I=v.name)!=null?I:v}),title:x.title}));e["x-action-settings"].importSettings={importColumns:m,explain:g},s.emit("patch",{schema:{"x-uid":e["x-uid"],"x-action-settings":e["x-action-settings"]}}),s.refresh()}}}},{name:"divider",type:"divider"},{name:"delete",type:"remove",useComponentProps(){const{t}=F.useTranslation();return{removeParentsIfNoChildren:!0,breakRemoveOn:e=>e["x-component"]==="Space"||e["x-component"].endsWith("ActionBar"),confirm:{title:t("Delete action")}}}}]});class pe extends c.Plugin{load(){return H(this,null,function*(){this.app.use(se);const e={title:"{{t('Import')}}",Component:"ImportActionInitializer",schema:{"x-align":"right","x-decorator":"ACLActionProvider","x-acl-action":"importXlsx","x-acl-action-props":{skipScopeCheck:!0}},useVisible(){const s=c.useCollection_deprecated();return(s.template!=="view"||(s==null?void 0:s.writableView))&&s.template!=="file"&&s.template!=="sql"}},n=this.app.schemaInitializerManager.get("table:configureActions");n==null||n.add("enableActions.import",e),this.app.schemaInitializerManager.addItem("gantt:configureActions","enableActions.import",e),this.app.schemaSettingsManager.add(Ae)})}}l.ImportActionInitializer=Q,l.ImportContextProvider=ce,l.ImportDesigner=Z,l.ImportPluginProvider=se,l.ImportWarning=Y,l.PluginActionImportClient=pe,l.default=pe,l.useCurrentSchema=K,l.useDownloadXlsxTemplateAction=ae,l.useImportStartAction=ie,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
