(function(n,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@ant-design/icons"),require("@nocobase/plugin-workflow/client"),require("react-i18next"),require("@formily/core"),require("@formily/react"),require("antd"),require("react")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@ant-design/icons","@nocobase/plugin-workflow/client","react-i18next","@formily/core","@formily/react","antd","react"],e):(n=typeof globalThis!="undefined"?globalThis:n||self,e(n["@nocobase/plugin-workflow-dynamic-calculation"]={},n["@nocobase/client"],n.jsxRuntime,n["@ant-design/icons"],n["@nocobase/plugin-workflow"],n["react-i18next"],n["@formily/core"],n["@formily/react"],n.antd,n.react))})(this,function(n,e,o,w,r,x,y,c,u,m){"use strict";var N=Object.defineProperty,z=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var U=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var I=(n,e,o)=>e in n?N(n,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[e]=o,b=(n,e)=>{for(var o in e||(e={}))U.call(e,o)&&I(n,o,e[o]);if(k)for(var o of k(e))G.call(e,o)&&I(n,o,e[o]);return n},V=(n,e)=>z(n,L(e));var i=(n,e,o)=>(I(n,typeof e!="symbol"?e+"":e,o),o);var h=(n,e,o)=>new Promise((w,r)=>{var x=u=>{try{c(o.next(u))}catch(m){r(m)}},y=u=>{try{c(o.throw(u))}catch(m){r(m)}},c=u=>u.done?w(u.value):Promise.resolve(u.value).then(x,y);c((o=o.apply(n,e)).next())});const p="workflow-dynamic-calculation";function T(s,a={}){const{t}=E(a);return t(s)}function E(s){return x.useTranslation(p,s)}function v(s){var t;return["belongsTo","hasOne"].includes(s.type)?((t=this.getCollection(s.collectionName))==null?void 0:t.template)==="expression"?!0:this.getCollectionFields(s.target).some(l=>l.interface==="expression"):!1}function q({value:s,onChange:a}){const{getCollectionFields:t,getCollection:l}=e.useCollectionManager_deprecated(),f=r.useWorkflowVariableOptions({types:[v.bind({getCollectionFields:t,getCollection:l})]});return o.jsx(e.Variable.Input,{value:s,onChange:a,scope:f})}class P extends r.Instruction{constructor(){super(...arguments);i(this,"title",`{{t("Dynamic Calculation", { ns: "${p}" })}}`);i(this,"type","dynamic-calculation");i(this,"group","calculation");i(this,"description",`{{t("Calculate an expression based on a calculation engine and obtain a value as the result. Variables in the upstream nodes can be used in the expression. The expression is dynamic one from an expression collections.", { ns: "${p}" })}}`);i(this,"icon",o.jsx(w.FunctionOutlined,{}));i(this,"fieldset",{expression:{type:"string",title:`{{t("Calculation expression", { ns: "${p}" })}}`,"x-decorator":"FormItem","x-component":"DynamicExpression",required:!0},scope:{type:"string",title:`{{t("Variable datasource", { ns: "${p}" })}}`,"x-decorator":"FormItem","x-component":"WorkflowVariableInput","x-component-props":{changeOnSelect:!0,variableOptions:{types:[{type:"reference",options:{collection:"*",entity:!0}}]}},"x-reactions":{dependencies:["expression"],fulfill:{state:{visible:"{{$deps[0]}}"}}}}});i(this,"components",{DynamicExpression:q,WorkflowVariableInput:r.WorkflowVariableInput,ValueBlock:r.ValueBlock})}useVariables({key:t,title:l},{types:f,fieldNames:d=r.defaultFieldNames}){return f&&!f.some(g=>g in r.BaseTypeSets||Object.values(r.BaseTypeSets).some(C=>C.has(g)))?null:{[d.value]:t,[d.label]:l}}useInitializers(t){var l;return{name:`#${t.id}`,type:"item",title:(l=t.title)!=null?l:`#${t.id}`,Component:r.ValueBlock.Initializer,node:t,resultTitle:T("Calculation result")}}}const M=c.observer(s=>{const{onChange:a}=s,t=c.useField(),l=c.useForm(),d=[...t.path.segments.slice(0,-1),"sourceCollection"].join("."),[g,C]=m.useState(l.getValuesIn(d)),B=e.useCompile(),{getCollectionFields:_}=e.useCollectionManager_deprecated();c.useFormEffects(()=>{y.onFormInitialValuesChange(F=>{C(F.getValuesIn(d))}),y.onFieldInputValueChange(d,F=>{C(F.value),a(null)})});const W=r.getCollectionFieldOptions({collection:g,compile:B,getCollectionFields:_});return o.jsx(e.Variable.TextArea,V(b({},s),{scope:W}))},{displayName:"InternalExpression"});function O(s){const{t:a}=x.useTranslation(),t=e.useRecord(),l=e.useCompile(),{getCollectionFields:f}=e.useCollectionManager_deprecated(),d=m.useMemo(()=>r.getCollectionFieldOptions({collection:t.sourceCollection,compile:l,getCollectionFields:f}),[t.sourceCollection,t.sourceCollection]);return s.value?o.jsx(e.Variable.TextArea,V(b({},s),{scope:d})):o.jsx(u.Tag,{children:a("Unconfigured",{ns:p})})}const S=c.connect(M,c.mapReadPretty(O)),{defaultProps:j}=e.interfacesProperties;class D extends e.CollectionFieldInterface{constructor(){super(...arguments);i(this,"name","expression");i(this,"type","string");i(this,"group","advanced");i(this,"order",1);i(this,"title",`{{t("Expression", { ns: "${p}" })}}`);i(this,"description",`{{t("Used to store expressions for use in workflows so that different expressions can be called for different data.", { ns: "${p}" })}}`);i(this,"sortable",!0);i(this,"default",{type:"text",uiSchema:{"x-component":"DynamicExpression"}});i(this,"properties",b({},j))}}class A extends e.Plugin{afterAdd(){return h(this,null,function*(){})}beforeLoad(){return h(this,null,function*(){})}load(){return h(this,null,function*(){this.app.dataSourceManager.addFieldInterfaces([D]),this.app.addComponents({DynamicExpression:S});const a=this.app.pm.get("workflow"),t=new P;a.instructions.register(t.type,t)})}}n.default=A,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
