(function(x,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@ant-design/icons"),require("@nocobase/plugin-workflow/client"),require("@formily/antd-v5"),require("@formily/core"),require("@formily/react"),require("antd"),require("react"),require("react-i18next"),require("@nocobase/utils/client"),require("lodash"),require("dayjs")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@ant-design/icons","@nocobase/plugin-workflow/client","@formily/antd-v5","@formily/core","@formily/react","antd","react","react-i18next","@nocobase/utils/client","lodash","dayjs"],e):(x=typeof globalThis!="undefined"?globalThis:x||self,e(x["@nocobase/plugin-workflow-manual"]={},x["@nocobase/client"],x.jsxRuntime,x["@ant-design/icons"],x["@nocobase/plugin-workflow"],x["@formily/antd-v5"],x["@formily/core"],x["@formily/react"],x.antd,x.react,x["react-i18next"],x["@nocobase/utils"],x.lodash,x.dayjs))})(this,function(x,e,n,I,f,J,_,b,y,C,L,z,K,ue){"use strict";var eo=Object.defineProperty,oo=Object.defineProperties;var to=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var H=(x,e,n)=>e in x?eo(x,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):x[e]=n,S=(x,e)=>{for(var n in e||(e={}))pe.call(e,n)&&H(x,n,e[n]);if(q)for(var n of q(e))de.call(e,n)&&H(x,n,e[n]);return x},w=(x,e)=>oo(x,to(e));var E=(x,e)=>{var n={};for(var I in x)pe.call(x,I)&&e.indexOf(I)<0&&(n[I]=x[I]);if(x!=null&&q)for(var I of q(x))e.indexOf(I)<0&&de.call(x,I)&&(n[I]=x[I]);return n};var N=(x,e,n)=>(H(x,typeof e!="symbol"?e+"":e,n),n);var U=(x,e,n)=>new Promise((I,f)=>{var J=y=>{try{b(n.next(y))}catch(C){f(C)}},_=y=>{try{b(n.throw(y))}catch(C){f(C)}},b=y=>y.done?I(y.value):Promise.resolve(y.value).then(J,_);b((n=n.apply(x,e)).next())});const g="workflow-manual";function M(o,r={}){const{t:s}=Y(r);return s(o)}function Y(o){return L.useTranslation(g,o)}function X(o){var D,T;const r=e.useRecord(),s=b.useFieldSchema(),t=b.useField(),i=C.useRef(null),a=o.dataSource||e.DEFAULT_DATA_SOURCE_KEY,{getAssociationAppends:l}=e.useAssociationNames(a),{appends:p,updateAssociationValues:d}=l(),[u]=Object.keys((D=s.toJSON().properties)!=null?D:{}),m=(T=r==null?void 0:r.result)==null?void 0:T[u];e.useDesignable();const c=C.useMemo(()=>_.createForm({initialValues:m}),[m]),h=C.useMemo(()=>S({appends:p},o.params),[p,o.params]),F=C.useMemo(()=>({loading:!1,data:{data:m}}),[m]),v=e.useAPIClient(),k=e.useDataSourceHeaders(a),A=v.resource(o.collection,void 0,k),O=e.useBlockRequestContext(),B=C.useMemo(()=>({params:h,form:c,field:t,service:F,updateAssociationValues:d,formBlockRef:i}),[t,c,h,F,d]);return!r.status||m?n.jsx(e.CollectionManagerProvider,{dataSource:a,children:n.jsx(e.CollectionProvider_deprecated,{collection:o.collection,children:n.jsx(e.RecordProvider,{record:m,parent:null,children:n.jsx(e.FormActiveFieldsProvider,{name:"form",children:n.jsx(e.BlockRequestContext_deprecated.Provider,{value:{block:"form",props:o,field:t,service:F,resource:A,__parent:O},children:n.jsxs(e.FormBlockContext.Provider,{value:B,children:[n.jsx(e.FormV2.Templates,{style:{marginBottom:18},form:c}),n.jsx("div",{ref:i,children:o.children})]})})})})})}):null}function me(o){return e.createFormBlockSchema(o)}function fe(s){var t=s,{schema:o}=t,r=E(t,["schema"]);const{getTemplateSchemaByMode:i}=e.useSchemaTemplateManager(),{insert:a}=e.useSchemaInitializer(),l=e.useRecordCollectionDataSourceItems("FormItem");function p(u){return U(this,arguments,function*({item:d}){var v;const m=d.template?yield i(d):null,c=me(w(S({actionInitializers:"workflowManual:form:configureActions",actions:{resolve:{type:"void",title:`{{t("Continue the process", { ns: "${g}" })}}`,"x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:f.JOB_STATUS.RESOLVED},"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useSubmit }}"},"x-designer":"ManualActionDesigner","x-designer-props":{}}}},o),{template:m}));delete c["x-acl-action-props"],delete c["x-acl-action"];const[h]=Object.keys(c.properties),F=((v=Object.entries(c.properties[h].properties).find(([k,A])=>A["x-component"]==="ActionBar"))==null?void 0:v[0])||"actions";c.properties[h].properties[F]["x-decorator"]="ActionBarProvider",c.properties[h].properties[F]["x-component-props"].style={marginTop:"1.5em",flexWrap:"wrap"},f.traverseSchema(c,k=>{k["x-uid"]&&delete k["x-uid"]}),a(c)})}return n.jsx(e.SchemaInitializerItem,w(S({},r),{onClick:p,items:l}))}function Z(){var r,s;const o=e.useSchemaInitializerItem();return n.jsx(e.CollectionProvider_deprecated,{dataSource:(r=o.schema)==null?void 0:r.dataSource,collection:(s=o.schema)==null?void 0:s.collection,children:n.jsx(fe,S({},o))})}function j(o,r,s=!1){const t=[];return o?r(o)&&(!s||!o.properties)?(t.push(o),t):(o.properties&&Object.keys(o.properties).forEach(i=>{t.push(...j(o.properties[i],r))}),t):t}function he(){const{name:o,title:r}=e.useCollection_deprecated();return n.jsxs(e.GeneralSchemaDesigner,{title:r||o,children:[n.jsx(e.SchemaSettingsBlockTitleItem,{}),n.jsx(e.SchemaSettingsLinkageRules,{collectionName:o}),n.jsx(e.SchemaSettingsDataTemplates,{collectionName:o}),n.jsx(e.SchemaSettingsDivider,{}),n.jsx(e.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})}const xe={title:`{{t("Create record form", { ns: "${g}" })}}`,config:{useInitializer({allCollections:o}){const r=C.useMemo(()=>o.map(({key:a,displayName:l,collections:p})=>({key:a,name:a,label:l,type:"subMenu",children:p.map(d=>({name:K.camelCase(`createRecordForm-child-${d.name}`),type:"item",title:d.title||d.tableName,schema:{collection:d.name,dataSource:a,title:`{{t("Create record", { ns: "${g}" })}}`,formType:"create","x-designer":"CreateFormDesigner"},Component:Z}))})),[o]),[s,t]=C.useState([]),i=e.useMenuSearch({data:r,openKeys:s});return{name:"createRecordForm",key:"createRecordForm",type:"subMenu",title:`{{t("Create record form", { ns: "${g}" })}}`,componentProps:{onOpenChange(a){t(a)}},children:i}},initializers:{},components:{CreateFormDesigner:he},parseFormOptions(o){const r={};return j(o,t=>t["x-decorator"]==="FormBlockProvider"&&t["x-decorator-props"].formType==="create").forEach(t=>{var p,d;const[i]=Object.keys(t.properties),a=t.properties[i],l=((p=Object.entries(a.properties).find(([u,m])=>m["x-component"]==="ActionBar"))==null?void 0:p[0])||"actions";r[i]={type:"create",title:((d=t["x-component-props"])==null?void 0:d.title)||i,actions:j(a.properties[l],u=>u["x-component"]==="Action").map(u=>{var m,c;return{status:u["x-decorator-props"].value,values:(c=(m=u["x-action-settings"])==null?void 0:m.assignedValues)==null?void 0:c.values,key:u.name}}),collection:t["x-decorator-props"].collection}}),r}},block:{scope:{},components:{}}};function W(o){var u,m,c,h;const[r,s]=C.useState((m=(u=o.collection)==null?void 0:u.fields)!=null?m:[]),t=e.useRecord(),i=b.useField(),a=b.useFieldSchema(),[l]=Object.keys((c=a.toJSON().properties)!=null?c:{}),p=(h=t==null?void 0:t.result)==null?void 0:h[l],d=C.useMemo(()=>_.createForm({initialValues:p}),[p]);return!t.status||p?n.jsx(e.CollectionProvider_deprecated,{collection:w(S({},o.collection),{fields:r}),children:n.jsx(e.RecordProvider,{record:p,parent:null,children:n.jsx(e.FormBlockContext.Provider,{value:{form:d,field:i,setCollectionFields:s},children:o.children})})}):null}function Ce(){const{insert:o}=e.useSchemaInitializer(),r=e.useSchemaInitializerItem();return n.jsx(e.SchemaInitializerItem,w(S({},r),{onClick:()=>{o({type:"void","x-decorator":"CustomFormBlockProvider","x-decorator-props":{collection:{name:z.uid(),fields:[]}},"x-component":"CardItem","x-component-props":{title:'{{t("Form")}}'},"x-designer":"SimpleDesigner","x-designer-props":{type:"customForm"},properties:{[z.uid()]:{type:"void","x-component":"FormV2","x-use-component-props":"useFormBlockProps",properties:{grid:{type:"void","x-component":"Grid","x-initializer":"workflowManual:customForm:configureFields"},actions:{type:"void","x-decorator":"ActionBarProvider","x-component":"ActionBar","x-component-props":{layout:"one-column",style:{marginTop:"1.5em",flexWrap:"wrap"}},"x-initializer":"workflowManual:form:configureActions",properties:{resolve:{type:"void",title:`{{t("Continue the process", { ns: "${g}" })}}`,"x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:f.JOB_STATUS.RESOLVED},"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useSubmit }}"},"x-designer":"ManualActionDesigner"}}}}}}})}}))}const R={basic:'{{t("Basic")}}',choices:'{{t("Choices")}}',media:'{{t("Media")}}',datetime:'{{t("Date & Time")}}',relation:'{{t("Relation")}}',advanced:'{{t("Advanced type")}}',systemInfo:'{{t("System info")}}',others:'{{t("Others")}}'};function ge(o){const r={};return Object.keys(o).forEach(s=>{const t=o[s],{group:i="others"}=t;r[i]=r[i]||{},K.set(r,[i,s],t)}),Object.keys(R).filter(s=>["basic","choices","datetime","media"].includes(s)).map(s=>({title:R[s],children:Object.keys(r[s]||{}).map(t=>{const i=r[s][t];return S({value:t,title:i.title,name:t},r[s][t])}).sort((t,i)=>t.order-i.order)}))}function ye(){const{interfaces:o}=e.useCollectionManager_deprecated();return ge(o).map(s=>({name:s.title,type:"itemGroup",title:s.title,children:s.children.map(t=>({name:t.name,type:"item",title:t.title,Component:Se,fieldInterface:t.name}))}))}const ee=C.createContext({}),oe=o=>{const[r,s]=C.useState(null),[t,i]=C.useState(),a=ye(),l=e.useCollection_deprecated(),{setCollectionFields:p}=C.useContext(e.FormBlockContext),d=C.useMemo(()=>_.createForm(),[r]);return n.jsxs(ee.Provider,{value:{onAddField(u){const m=K.pick(u,["name","group","title","default","validateSchema"]),{properties:O}=u,B=O,{unique:c,type:h,layout:F,autoIncrement:v}=B,k=E(B,["unique","type","layout","autoIncrement"]);m.properties=k;const A=K.cloneDeep(m);delete A.properties.name["x-disabled"],s(A)},setCallback:i},children:[n.jsx(e.SchemaInitializerItems,w(S({},o),{items:a})),n.jsx(e.ActionContextProvider,{value:{visible:!!r,setVisible(u){u||s(null)}},children:r?n.jsx(e.SchemaComponent,{schema:{type:"void",name:"drawer",title:'{{t("Configure field")}}',"x-decorator":"FormV2","x-decorator-props":{form:d},"x-component":"Action.Drawer",properties:w(S({},r.properties),{footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{type:"void",title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction(){const u=b.useForm();return{run(){return U(this,null,function*(){i(null),s(null),u.reset()})}}}}},submit:{type:"void",title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction(){const{values:u,query:m,reset:c}=b.useForm(),h=[M("Field name existed in form")];return{run(){return U(this,null,function*(){var B,D,T,$;const{default:v}=r,k=z.uid();if(v.name=(B=u.name)!=null?B:k,v.uiSchema.title=(T=(D=u.uiSchema)==null?void 0:D.title)!=null?T:k,v.interface=r.name,($=l.fields)==null?void 0:$.find(P=>P.name===v.name)){m("name").take().setFeedback({type:"error",messages:h});return}const O=z.merge(v,u);p([...l.fields,O]),t({name:v.name,type:v.uiSchema.type,"x-decorator":"FormItem","x-component":"CollectionField","x-component-props":{field:O},"x-collection-field":`${l.name}.${v.name}`,"x-toolbar":"FormItemSchemaToolbar","x-settings":"fieldSettings:FormItem"}),c(),i(null),s(null)})}}}}}}}})},components:{ArrayTable:J.ArrayTable}}):null})]})},te=new e.CompatibleSchemaInitializer({name:"AddCustomFormField",wrap:e.gridRowColWrap,insertPosition:"beforeEnd",title:"{{t('Configure fields')}}",ItemsComponent:oe}),be=new e.CompatibleSchemaInitializer({name:"workflowManual:customForm:configureFields",wrap:e.gridRowColWrap,insertPosition:"beforeEnd",title:"{{t('Configure fields')}}",ItemsComponent:oe},te);function Se(){const o=e.useSchemaInitializerItem(),{insert:r,setVisible:s}=e.useSchemaInitializer(),{onAddField:t,setCallback:i}=C.useContext(ee),{getInterface:a}=e.useCollectionManager_deprecated(),l=a(o.fieldInterface);return n.jsx(e.SchemaInitializerItem,S({onClick:()=>{i(()=>r),t(l),s(!1)}},o),o.fieldInterface)}const ne={title:`{{t("Custom form", { ns: "${g}" })}}`,config:{useInitializer(){return{name:"customForm",type:"item",title:`{{t("Custom form", { ns: "${g}" })}}`,Component:Ce}},initializers:{},components:{CustomFormBlockProvider:W},parseFormOptions(o){const r={};return j(o,t=>t["x-decorator"]==="CustomFormBlockProvider").forEach(t=>{var d,u;const[i]=Object.keys(t.properties),a=t.properties[i],l=j(a.properties.grid,m=>m["x-component"]==="CollectionField",!0);t["x-decorator-props"].collection.fields=l.map(m=>{var c,h;return(h=(c=m["x-component-props"])==null?void 0:c.field)!=null?h:m["x-interface-options"]});const p=((d=Object.entries(a.properties).find(([m,c])=>c["x-component"]==="ActionBar"))==null?void 0:d[0])||"actions";r[i]={type:"custom",title:((u=t["x-component-props"])==null?void 0:u.title)||i,actions:j(a.properties[p],m=>m["x-component"]==="Action").map(m=>{var c,h;return{status:m["x-decorator-props"].value,values:(h=(c=m["x-action-settings"])==null?void 0:c.assignedValues)==null?void 0:h.values,key:m.name}}),collection:t["x-decorator-props"].collection}}),r}},block:{scope:{},components:{CustomFormBlockProvider:W}}};function ve(){const{name:o,title:r}=e.useCollection_deprecated(),s=b.useFieldSchema(),{t}=L.useTranslation(),{dn:i}=e.useDesignable();return n.jsxs(e.GeneralSchemaDesigner,{title:r||o,children:[n.jsx(e.SchemaSettingsBlockTitleItem,{}),n.jsx(e.SchemaSettingsActionModalItem,{title:t("Filter settings",{ns:g}),schema:{name:"filter",type:"object",title:'{{t("Filter")}}',"x-component":"Filter","x-use-component-props":()=>{var l;return{options:e.useCollectionFilterOptions((l=s==null?void 0:s["x-decorator-props"])==null?void 0:l.collection)}},"x-component-props":{dynamicComponent:"FilterDynamicComponent"}},initialValues:s==null?void 0:s["x-decorator-props"],onSubmit:({filter:a})=>{s["x-decorator-props"].filter=a,i.emit("patch",{schema:{"x-decorator-props":s["x-decorator-props"]}}),i.refresh()}}),n.jsx(e.SchemaSettingsLinkageRules,{collectionName:o}),n.jsx(e.SchemaSettingsDivider,{}),n.jsx(e.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})}const Fe={title:`{{t("Update record form", { ns: "${g}" })}}`,config:{useInitializer({allCollections:o}){const r=C.useMemo(()=>o.map(({key:a,displayName:l,collections:p})=>({key:a,name:a,label:l,type:"subMenu",children:p.map(d=>({name:K.camelCase(`updateRecordForm-child-${d.name}`),type:"item",title:d.title||d.tableName,schema:{collection:d.name,dataSource:a,title:`{{t("Update record", { ns: "${g}" })}}`,formType:"update","x-designer":"UpdateFormDesigner"},Component:Z}))})),[o]),[s,t]=C.useState([]),i=e.useMenuSearch({data:r,openKeys:s});return{name:"updateRecordForm",key:"updateRecordForm",type:"subMenu",title:`{{t("Update record form", { ns: "${g}" })}}`,componentProps:{onOpenChange(a){t(a)}},children:i}},initializers:{},components:{FilterDynamicComponent:f.FilterDynamicComponent,UpdateFormDesigner:ve},parseFormOptions(o){const r={};return j(o,t=>t["x-decorator"]==="FormBlockProvider"&&t["x-decorator-props"].formType==="update").forEach(t=>{var p,d;const[i]=Object.keys(t.properties),a=t.properties[i],l=((p=Object.entries(a.properties).find(([u,m])=>m["x-component"]==="ActionBar"))==null?void 0:p[0])||"actions";r[i]=w(S({},t["x-decorator-props"]),{type:"update",title:((d=t["x-component-props"])==null?void 0:d.title)||i,actions:j(a.properties[l],u=>u["x-component"]==="Action").map(u=>{var m,c;return{status:u["x-decorator-props"].value,values:(c=(m=u["x-action-settings"])==null?void 0:m.assignedValues)==null?void 0:c.values,key:u.name}})})}),r}},block:{scope:{},components:{}},validate({filter:o}){return!o||!z.isValidFilter(o)?"Please check one of your update record form, and add at least one filter condition in form settings.":null}},V=new z.Registry;V.register("custom",ne),V.register("create",xe),V.register("update",Fe);function re(){const{workflow:o}=f.useFlowContext(),r=f.useTrigger();return r.useInitializers?r.useInitializers(o.config):null}ne.title,`${g}`;const se=new e.CompatibleSchemaInitializer({name:"AddBlockButton",wrap:e.gridRowColWrap,title:'{{t("Add block")}}',items:[{type:"itemGroup",name:"dataBlocks",title:'{{t("Data blocks")}}',hideIfNoChildren:!0,useChildren(){const o=e.usePlugin(f),r=f.useNodeContext(),s=f.useAvailableUpstreams(r),t=[re()].filter(Boolean),i=s.map(l=>{var d;const p=o.instructions.get(l.type);return(d=p==null?void 0:p.useInitializers)==null?void 0:d.call(p,l)}).filter(Boolean);return[...t,...i.length?[{name:"nodes",type:"subMenu",title:'{{t("Node result", { ns: "workflow" })}}',children:i}]:[]].filter(Boolean)}},{type:"itemGroup",name:"form",title:'{{t("Form")}}',useChildren(){const r=e.useDataSourceManager().getAllCollections();return Array.from(V.getValues()).map(s=>{const{useInitializer:t}=s.config;return t({allCollections:r})})}},{type:"itemGroup",name:"otherBlocks",title:'{{t("Other blocks")}}',children:[{name:"markdown",title:'{{t("Markdown")}}',Component:"MarkdownBlockInitializer"}]}]}),ke=new e.CompatibleSchemaInitializer({name:"workflowManual:popup:configureUserInterface:addBlock",wrap:e.gridRowColWrap,title:'{{t("Add block")}}',items:[{type:"itemGroup",name:"dataBlocks",title:'{{t("Data blocks")}}',hideIfNoChildren:!0,useChildren(){const o=e.usePlugin(f),r=f.useNodeContext(),s=f.useAvailableUpstreams(r),t=[re()].filter(Boolean),i=s.map(l=>{var d;const p=o.instructions.get(l.type);return(d=p==null?void 0:p.useInitializers)==null?void 0:d.call(p,l)}).filter(Boolean);return[...t,...i.length?[{name:"nodes",type:"subMenu",title:`{{t("Node result", { ns: "${g}" })}}`,children:i}]:[]].filter(Boolean)}},{type:"itemGroup",name:"form",title:'{{t("Form")}}',useChildren(){const r=e.useDataSourceManager().getAllCollections();return Array.from(V.getValues()).map(s=>{const{useInitializer:t}=s.config;return t({allCollections:r})})}},{type:"itemGroup",name:"otherBlocks",title:'{{t("Other blocks")}}',children:[{name:"markdown",title:'{{t("Markdown")}}',Component:"MarkdownBlockInitializer"}]}]},se);function we(){var O,B,D;const o=C.useContext(e.SchemaComponentContext),{t:r}=L.useTranslation(),{t:s}=Y(),t=b.useFieldSchema(),i=f.useWorkflowVariableOptions(),[a,l]=C.useState(!1),[p,d]=C.useState((D=(B=(O=t==null?void 0:t["x-action-settings"])==null?void 0:O.assignedValues)==null?void 0:B.schema)!=null?D:{type:"void","x-component":"Grid","x-initializer":"assignFieldValuesForm:configureFields",properties:{}}),[u,m]=C.useState(null),{components:c}=e.useSchemaOptionsContext();C.useEffect(()=>{m(new b.Schema({properties:{grid:p}}))},[p]);const h=C.useMemo(()=>{var $,P;const T=(P=($=t==null?void 0:t["x-action-settings"])==null?void 0:$.assignedValues)==null?void 0:P.values;return _.createForm({initialValues:z.lodash.cloneDeep(T),values:z.lodash.cloneDeep(T)})},[t]),F=e.useFormActiveFields(),v=r("Assign field values");function k(){l(!1)}function A(){t["x-action-settings"]||(t["x-action-settings"]={}),t["x-action-settings"].assignedValues||(t["x-action-settings"].assignedValues={}),t["x-action-settings"].assignedValues.schema=p,t["x-action-settings"].assignedValues.values=h.values,l(!1),setTimeout(()=>{var T;(T=o.refresh)==null||T.call(o)},300)}return n.jsxs(n.Fragment,{children:[n.jsx(e.SchemaSettingsItem,{title:v,onClick:()=>l(!0),children:v}),n.jsx(y.Modal,{width:"50%",title:v,open:a,onCancel:k,footer:n.jsxs(y.Space,{children:[n.jsx(y.Button,{onClick:k,children:s("Cancel")}),n.jsx(y.Button,{type:"primary",onClick:A,children:s("Submit")})]}),children:n.jsx(e.DefaultValueProvider,{isAllowToSetDefaultValue:()=>!1,children:n.jsx(e.VariableScopeProvider,{scope:i,children:n.jsx(e.FormActiveFieldsProvider,{name:"form",getActiveFieldsName:F==null?void 0:F.getActiveFieldsName,children:n.jsx(b.FormProvider,{form:h,children:n.jsxs(J.FormLayout,{layout:"vertical",children:[n.jsx(y.Alert,{message:s("Values preset in this form will override user submitted ones when continue or reject.")}),n.jsx("br",{}),a&&u&&n.jsx(e.SchemaComponentContext.Provider,{value:w(S({},o),{refresh(){d(z.lodash.get(u.toJSON(),"properties.grid"))}}),children:n.jsx(e.SchemaComponent,{schema:u,components:c})})]})})})})})})]})}function Ie(o){return n.jsxs(e.GeneralSchemaDesigner,w(S({},o),{disableInitializer:!0,children:[n.jsx(e.Action.Designer.ButtonEditor,{}),n.jsx(we,{}),n.jsx(e.SchemaSettingsDivider,{}),n.jsx(e.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"ActionBar"}})]}))}function ie(){const a=e.useSchemaInitializerItem(),{action:r,actionProps:s}=a,t=E(a,["action","actionProps"]),{insert:i}=e.useSchemaInitializer();return n.jsx(e.SchemaInitializerItem,w(S({},t),{onClick:()=>{i({type:"void",title:t.title,"x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:r},"x-component":"Action","x-component-props":w(S({},s),{useAction:"{{ useSubmit }}"}),"x-designer":"ManualActionDesigner","x-action-settings":{}})}}))}function G(){const o=e.useSchemaInitializerItem(),i=o,{action:r,actionProps:s}=i,t=E(i,["action","actionProps"]);return n.jsx(e.InitializerWithSwitch,w(S({},t),{item:o,schema:{type:"void",title:t.title,"x-decorator":"ManualActionStatusProvider","x-decorator-props":{value:r},"x-component":"Action","x-component-props":w(S({},s),{useAction:"{{ useSubmit }}"}),"x-designer":"Action.Designer","x-action":`${r}`},type:"x-action"}))}const ae=new e.CompatibleSchemaInitializer({name:"AddActionButton",title:'{{t("Configure actions")}}',items:[{name:"jobStatusResolved",title:`{{t("Continue the process", { ns: "${g}" })}}`,Component:ie,action:f.JOB_STATUS.RESOLVED,actionProps:{type:"primary"}},{name:"jobStatusRejected",title:`{{t("Terminate the process", { ns: "${g}" })}}`,Component:G,action:f.JOB_STATUS.REJECTED,actionProps:{danger:!0}},{name:"jobStatusPending",title:`{{t("Save temporarily", { ns: "${g}" })}}`,Component:G,action:f.JOB_STATUS.PENDING},{name:"jobStatusAborted",title:`{{t("Archive", { ns: "${g}" })}}`,Component:G,action:f.JOB_STATUS.ABORTED,actionProps:{danger:!0}}]}),Ae=new e.CompatibleSchemaInitializer({name:"workflowManual:form:configureActions",title:'{{t("Configure actions")}}',items:[{name:"jobStatusResolved",title:`{{t("Continue the process", { ns: "${g}" })}}`,Component:ie,action:f.JOB_STATUS.RESOLVED,actionProps:{type:"primary"}},{name:"jobStatusRejected",title:`{{t("Terminate the process", { ns: "${g}" })}}`,Component:G,action:f.JOB_STATUS.REJECTED,actionProps:{danger:!0}},{name:"jobStatusPending",title:`{{t("Save temporarily", { ns: "${g}" })}}`,Component:G,action:f.JOB_STATUS.PENDING}]},ae);function Be(){return{run(){}}}function Te({value:o,onChange:r}){const s=e.usePlugin(f),t=C.useContext(e.SchemaComponentContext),i=f.useNodeContext(),a=f.useAvailableUpstreams(i),l=b.useForm(),{workflow:p}=f.useFlowContext(),d={};a.forEach(c=>{const h=s.instructions.get(c.type);Object.assign(d,h.components)});const u=C.useMemo(()=>new b.Schema({properties:{drawer:{type:"void",title:`{{t("User interface", { ns: "${g}" })}}`,"x-decorator":"Form","x-component":"Action.Drawer","x-component-props":{className:e.css`
                .ant-drawer-body {
                  background: var(--nb-box-bg);
                }
              `},properties:{tabs:{type:"void","x-component":"Tabs","x-component-props":{},"x-initializer":"popup:addTab","x-initializer-props":{gridInitializer:"workflowManual:popup:configureUserInterface:addBlock"},properties:o!=null?o:{tab1:{type:"void",title:`{{t("Manual", { ns: "${g}" })}}`,"x-component":"Tabs.TabPane","x-designer":"Tabs.Designer",properties:{grid:{type:"void","x-component":"Grid","x-initializer":"workflowManual:popup:configureUserInterface:addBlock",properties:{}}}}}}}}}}),[]),m=C.useCallback(function(){const{tabs:h}=z.lodash.get(u.toJSON(),"properties.drawer.properties"),F=Array.from(V.getValues()).reduce((v,k)=>Object.assign(v,k.config.parseFormOptions(h)),{});l.setValuesIn("forms",F),r(h.properties)},[l,r,u]);return n.jsx(e.SchemaComponentContext.Provider,{value:w(S({},t),{designable:!p.executed,refresh:m}),children:n.jsx(e.SchemaComponent,{schema:u,components:w(S(S({},d),Array.from(V.getValues()).reduce((c,h)=>Object.assign(c,h.config.components),{})),{FormBlockProvider:X,DetailsBlockProvider:f.DetailsBlockProvider,ManualActionStatusProvider(c){return c.children},ActionBarProvider(c){return c.children},SimpleDesigner:f.SimpleDesigner,ManualActionDesigner:Ie}),scope:{useSubmit:Be,useDetailsBlockProps:e.useFormBlockContext}})})}function Me(o={}){for(const r of Object.values(o)){const s=V.get(r.type);if(typeof s.validate=="function"){const t=s.validate(r);if(t)return t}}}function Oe(o){const{workflow:r}=f.useFlowContext(),[s,t]=C.useState(!1),{values:i}=b.useForm(),{t:a}=Y(),l=C.useCallback(p=>{if(!p){const d=Me(i.forms);if(d){y.message.error({title:a("Validation failed"),content:a(d)});return}}t(p)},[i.forms]);return n.jsxs(n.Fragment,{children:[n.jsx(y.Button,{type:"primary",onClick:()=>t(!0),disabled:!1,children:a(r.executed?"View user interface":"Configure user interface")}),n.jsx(e.ActionContextProvider,{value:{visible:s,setVisible:l,formValueChanged:!1},children:o.children})]})}function De({value:o,onChange:r}){const s=n.jsx("fieldset",{children:n.jsx(J.FormLayout,{layout:"vertical",children:n.jsx(e.FormItem,{label:M("Negotiation"),children:n.jsxs(y.Radio.Group,{value:o,onChange:r,children:[n.jsx(y.Radio,{value:1,children:n.jsxs(y.Tooltip,{title:M("Everyone should pass"),placement:"bottom",children:[n.jsx("span",{children:M("All pass")}),n.jsx(I.QuestionCircleOutlined,{style:{color:"#999"}})]})}),n.jsx(y.Radio,{value:-1,children:n.jsxs(y.Tooltip,{title:M("Anyone pass"),placement:"bottom",children:[n.jsx("span",{children:M("Any pass")}),n.jsx(I.QuestionCircleOutlined,{style:{color:"#999"}})]})})]})})})});return n.jsxs("fieldset",{className:e.css`
        .ant-radio-group {
          .anticon {
            margin-left: 0.5em;
          }
        }
      `,children:[n.jsx(y.Form.Item,{children:n.jsxs(y.Radio.Group,{value:!!o,onChange:({target:{value:t}})=>{console.log(t),r(Number(t))},children:[n.jsx(y.Radio,{value:!0,children:n.jsxs(y.Tooltip,{title:M("Each user has own task"),placement:"bottom",children:[n.jsx("span",{children:M("Separately")}),n.jsx(I.QuestionCircleOutlined,{style:{color:"#999"}})]})}),n.jsx(y.Radio,{value:!1,children:n.jsxs(y.Tooltip,{title:M("Everyone shares one task"),placement:"bottom",children:[n.jsx("span",{children:M("Collaboratively")}),n.jsx(I.QuestionCircleOutlined,{style:{color:"#999"}})]})})]})}),o?s:null]})}function ze(o){return o.isForeignKey?o.target==="users":o.collectionName==="users"&&o.name==="id"}function Ve({multiple:o=!1,value:r=[],onChange:s}){const t=f.useWorkflowVariableOptions({types:[ze]});return n.jsx(e.Variable.Input,{scope:t,value:r[0],onChange:i=>{s([i])},children:n.jsx(e.RemoteSelect,{fieldNames:{label:"nickname",value:"id"},service:{resource:"users"},manual:!1,value:r[0],onChange:i=>{s(i!=null?[i]:[])}})})}class je extends f.Instruction{constructor(){super(...arguments);N(this,"title",`{{t("Manual", { ns: "${g}" })}}`);N(this,"type","manual");N(this,"group","manual");N(this,"description",`{{t("Could be used for manually submitting data, and determine whether to continue or exit. Workflow will generate a todo item for assigned user when it reaches a manual node, and continue processing after user submits the form.", { ns: "${g}" })}}`);N(this,"icon",n.jsx(I.SolutionOutlined,{}));N(this,"fieldset",{assignees:{type:"array",title:`{{t("Assignees", { ns: "${g}" })}}`,"x-decorator":"FormItem","x-component":"AssigneesSelect","x-component-props":{},required:!0,default:[]},mode:{type:"number",title:`{{t("Mode", { ns: "${g}" })}}`,"x-decorator":"FormItem","x-component":"ModeConfig",default:1,"x-reactions":{dependencies:["assignees"],fulfill:{state:{visible:"{{$deps[0].length > 1}}"}}}},schema:{type:"void",title:`{{t("User interface", { ns: "${g}" })}}`,"x-decorator":"FormItem","x-component":"SchemaConfigButton",properties:{schema:{type:"object","x-component":"SchemaConfig",default:null}}},forms:{type:"object",default:{}}});N(this,"components",{SchemaConfigButton:Oe,SchemaConfig:Te,ModeConfig:De,AssigneesSelect:Ve})}useVariables({key:s,title:t,config:i},{types:a,fieldNames:l=f.defaultFieldNames}){var c;const p=e.useCompile(),{getCollectionFields:d}=e.useCollectionManager_deprecated(),u=Object.keys((c=i.forms)!=null?c:{});if(!u.length)return null;const m=u.map(h=>{var A;const F=i.forms[h],v=f.getCollectionFieldOptions({fields:(A=F.collection)==null?void 0:A.fields,collection:F.collection,types:a,compile:p,getCollectionFields:d}),k=p(F.title)||h;return v.length?{key:h,value:h,label:k,title:k,children:v}:null}).filter(Boolean);return m.length?{[l.value]:s,[l.label]:t,[l.children]:m}:null}useInitializers(s){var l;const{getCollection:t}=e.useCollectionManager_deprecated(),i=Object.keys((l=s.config.forms)!=null?l:{});if(!i.length||s.config.mode)return null;const a=i.map(p=>{var m,c;const d=s.config.forms[p],{fields:u=[]}=t(d.collection);return u.length?{name:(m=d.title)!=null?m:p,type:"item",title:(c=d.title)!=null?c:p,Component:f.CollectionBlockInitializer,collection:d.collection,dataPath:`$jobsMapByNodeKey.${s.key}.${p}`}:null}).filter(Boolean);return a.length?{name:`#${s.id}`,key:"forms",type:"subMenu",title:s.title,children:a}:null}isAvailable({engine:s,workflow:t,upstream:i,branchIndex:a}){return!1}}const Pe={title:`{{t("Task", { ns: "${g}" })}}`,name:"flow_nodes",fields:[{type:"bigInt",name:"id",interface:"m2o",uiSchema:{type:"number",title:"ID","x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"flow_nodes",params:{filter:{type:"manual"}}}}}},{type:"string",name:"title",interface:"input",uiSchema:{type:"string",title:'{{t("Title")}}',"x-component":"Input"}}]},Ne={title:`{{t("Workflow", { ns: "${g}" })}}`,name:"workflows",fields:[{type:"string",name:"title",interface:"input",uiSchema:{title:'{{t("Name")}}',type:"string","x-component":"Input",required:!0}}]},$e={title:`{{t("Workflow todos", { ns: "${g}" })}}`,name:"users_jobs",fields:[{type:"belongsTo",name:"user",target:"users",foreignKey:"userId",interface:"m2o",uiSchema:{type:"number",title:'{{t("User")}}',"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"nickname",value:"id"},service:{resource:"users"}}}},{type:"belongsTo",name:"node",target:"flow_nodes",foreignKey:"nodeId",interface:"m2o",isAssociation:!0,uiSchema:{type:"number",title:`{{t("Task", { ns: "${g}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"flow_nodes"}}}},{type:"belongsTo",name:"workflow",target:"workflows",foreignKey:"workflowId",interface:"m2o",uiSchema:{type:"number",title:`{{t("Workflow", { ns: "${g}" })}}`,"x-component":"RemoteSelect","x-component-props":{fieldNames:{label:"title",value:"id"},service:{resource:"workflows"}}}},{type:"integer",name:"status",interface:"select",uiSchema:{type:"number",title:`{{t("Status", { ns: "${g}" })}}`,"x-component":"Select",enum:f.JobStatusOptions}},{name:"createdAt",type:"date",interface:"createdAt",uiSchema:{type:"datetime",title:'{{t("Created at")}}',"x-component":"DatePicker","x-component-props":{showTime:!0}}}]},Ee=b.observer(()=>{var r,s,t;const o=b.useField();return(t=(r=o==null?void 0:o.value)==null?void 0:r.title)!=null?t:`#${(s=o.value)==null?void 0:s.id}`},{displayName:"NodeColumn"}),Ue=b.observer(()=>{var r,s,t;const o=b.useField();return(t=(r=o==null?void 0:o.value)==null?void 0:r.title)!=null?t:`#${(s=o.value)==null?void 0:s.id}`},{displayName:"WorkflowColumn"}),_e=b.observer(()=>{var r,s,t;const o=b.useField();return(t=(r=o==null?void 0:o.value)==null?void 0:r.nickname)!=null?t:(s=o.value)==null?void 0:s.id},{displayName:"UserColumn"});function Je(o){const r=e.useRecord(),s=M("Unprocessed");return r.execution.status&&!r.status?n.jsx(y.Tag,{children:s}):o.children}const Q=()=>n.jsx(e.SchemaComponent,{components:{NodeColumn:Ee,WorkflowColumn:Ue,UserColumn:_e,UserJobStatusColumn:Je},schema:{type:"void",properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',"x-action":"filter","x-designer":"Filter.Action.Designer","x-component":"Filter.Action","x-use-component-props":"useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"},refresher:{type:"void",title:'{{ t("Refresh") }}',"x-action":"refresh","x-component":"Action","x-use-component-props":"useRefreshActionProps","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:refresh","x-component-props":{icon:"ReloadOutlined"},"x-align":"right"}}},table:{type:"array","x-component":"TableV2","x-use-component-props":"useTableBlockProps","x-component-props":{rowKey:"id"},properties:{actions:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:60},title:'{{t("Actions")}}',properties:{view:{type:"void","x-component":"Action.Link",title:'{{t("View")}}',properties:{drawer:{"x-component":"WorkflowTodo.Drawer"}}}}},node:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:null},title:`{{t("Task node", { ns: "${g}" })}}`,properties:{node:{"x-component":"NodeColumn","x-read-pretty":!0}}},workflow:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:null},title:'{{t("Workflow", { ns: "workflow" })}}',properties:{workflow:{"x-component":"WorkflowColumn","x-read-pretty":!0}}},status:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:100},title:'{{t("Status", { ns: "workflow" })}}',properties:{status:{type:"number","x-decorator":"UserJobStatusColumn","x-component":"CollectionField","x-read-pretty":!0}}},user:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:140},title:`{{t("Assignee", { ns: "${g}" })}}`,properties:{user:{"x-component":"UserColumn","x-read-pretty":!0}}},createdAt:{type:"void","x-decorator":"TableV2.Column.Decorator","x-component":"TableV2.Column","x-component-props":{width:160},properties:{createdAt:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}}}}}}});function Ke(o){var u;const{data:r}=e.useCurrentUserContext(),{userJob:s}=f.useFlowContext(),{status:t,result:i,userId:a}=s,l=b.useFieldSchema(),{name:p}=l.parent.toJSON();let{children:d}=o;return t?i[p]||(d=null):((u=r==null?void 0:r.data)==null?void 0:u.id)!==a&&(d=null),d}const ce=C.createContext(null);ce.displayName="ManualActionStatusContext";function Ge({value:o,children:r}){const{userJob:s,execution:t}=f.useFlowContext(),i=b.useField(),a=b.useFieldSchema();return C.useEffect(()=>{(t.status||s.status)&&(i.disabled=!0,i.visible=s.status===o&&s.result._===a.name)},[t,s,o,i,a.name]),n.jsx(ce.Provider,{value:o,children:r})}function qe(){const o=e.useAPIClient(),{setVisible:r}=e.useActionContext(),{values:s,submit:t}=b.useForm(),i=b.useFieldSchema(),{service:a}=e.useTableBlockContext(),{userJob:l,execution:p}=f.useFlowContext(),{name:d}=i,{name:u}=i.parent.parent;return{run(){return U(this,null,function*(){p.status||l.status||(yield t(),yield o.resource("users_jobs").submit({filterByTk:l.id,values:{result:{[u]:s,_:d}}}),r(!1),a.refresh())})}}}function Le(o){var m;const r=e.usePlugin(f),s=e.useAPIClient(),{id:t}=e.useRecord(),[i,a]=C.useState(null),[l,p]=C.useState(null);C.useEffect(()=>{var c,h;t&&((h=(c=s.resource("users_jobs")).get)==null||h.call(c,{filterByTk:t,appends:["node","job","workflow","workflow.nodes","execution","execution.jobs"]}).then(({data:F})=>{var D;const T=(D=F==null?void 0:F.data)!=null?D:{},{node:v,workflow:$={}}=T,P=$,{nodes:k=[]}=P,A=E(P,["nodes"]),le=T,{execution:O}=le,B=E(le,["node","workflow","execution"]);f.linkNodes(k),p(v),a({userJob:B,workflow:A,nodes:k,execution:O})}))},[s,t]);const u=f.useAvailableUpstreams(i==null?void 0:i.nodes.find(c=>c.id===l.id)).reduce((c,{type:h})=>Object.assign(c,r.instructions.get(h).components),{});return l&&i?n.jsx(f.FlowContext.Provider,{value:i,children:n.jsx(e.SchemaComponent,{components:S(S({FormBlockProvider:X,DetailsBlockProvider:f.DetailsBlockProvider,ActionBarProvider:Ke,ManualActionStatusProvider:Ge},Array.from(V.getValues()).reduce((c,h)=>Object.assign(c,h.block.components),{})),u),scope:S({useSubmit:qe,useFormBlockProps:Ye,useDetailsBlockProps:Qe},Array.from(V.getValues()).reduce((c,h)=>Object.assign(c,h.block.scope),{})),schema:{type:"void",name:"tabs","x-component":"Tabs",properties:(m=l.config)==null?void 0:m.schema}})}):n.jsx(y.Spin,{})}function Ye(){var l;const{userJob:o,execution:r}=f.useFlowContext(),s=e.useRecord(),{data:t}=e.useCurrentUserContext(),{form:i}=e.useFormBlockContext(),a=r.status||o.status?s?"readPretty":"disabled":((l=t==null?void 0:t.data)==null?void 0:l.id)!==o.userId?"disabled":"editable";return C.useEffect(()=>{i==null||i.setPattern(a)},[a,i]),{form:i}}function Qe(){const{form:o}=e.useFormBlockContext();return{form:o}}function He(){const o=e.useCompile(),{status:r,updatedAt:s}=e.useRecord(),t=f.JobStatusOptionsMap[r];return r?n.jsxs(y.Space,{children:[n.jsx("time",{className:e.css`
          margin-right: 0.5em;
        `,children:ue(s).format("YYYY-MM-DD HH:mm:ss")}),n.jsx(y.Tag,{icon:t.icon,color:t.color,children:o(t.label)})]}):null}function Xe(){var a;const o=C.useContext(e.SchemaComponentContext),{id:r,node:s,workflow:t,status:i}=e.useRecord();return n.jsx(e.SchemaComponentContext.Provider,{value:w(S({},o),{reset(){},designable:!1}),children:n.jsx(e.SchemaComponent,{components:{FooterStatus:He,FlowContextProvider:Le},schema:{type:"void",name:`drawer-${r}-${i}`,"x-component":"Action.Drawer","x-component-props":{className:"nb-action-popup"},title:`${t.title} - ${(a=s.title)!=null?a:`#${s.id}`}`,properties:{tabs:{type:"void","x-component":"FlowContextProvider"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{content:{type:"void","x-component":"FooterStatus"}}}}}})})}function Ze({params:o={},children:r}){const s={collection:"users_jobs",resource:"users_jobs",action:"list",params:w(S({pageSize:20,sort:["-createdAt"]},o),{appends:["user","node","workflow","execution.status"],except:["node.config","workflow.config","workflow.options"]}),rowKey:"id",showIndex:!0,dragSort:!1};return n.jsx(e.ExtendCollectionsProvider,{collections:[Pe,Ne,$e],children:n.jsx(e.TableBlockProvider,w(S({name:"workflow-todo"},s),{children:r}))})}Q.Drawer=Xe,Q.Decorator=Ze;const We=()=>{const o=e.useSchemaInitializerItem(),{insert:r}=e.useSchemaInitializer();return n.jsx(e.SchemaInitializerItem,w(S({icon:n.jsx(I.TableOutlined,{})},o),{onClick:()=>{r({type:"void","x-decorator":"WorkflowTodo.Decorator","x-decorator-props":{},"x-component":"CardItem","x-toolbar":"BlockSchemaToolbar","x-settings":"blockSettings:table",properties:{todos:{type:"void","x-component":"WorkflowTodo"}}})}}))};class Re extends e.Plugin{afterAdd(){return U(this,null,function*(){})}load(){return U(this,null,function*(){this.addComponents(),this.app.pm.get("workflow").registerInstruction("manual",je),this.app.schemaInitializerManager.add(se),this.app.schemaInitializerManager.add(ke),this.app.schemaInitializerManager.add(ae),this.app.schemaInitializerManager.add(Ae),this.app.schemaInitializerManager.add(te),this.app.schemaInitializerManager.add(be)})}addComponents(){this.app.addComponents({WorkflowTodo:Q,WorkflowTodoBlockInitializer:We})}}x.default=Re,Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
