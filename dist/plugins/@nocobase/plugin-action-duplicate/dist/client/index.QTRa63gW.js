(function(n,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@emotion/css"),require("@formily/react"),require("antd"),require("react"),require("react-i18next"),require("@nocobase/utils/client"),require("@formily/core"),require("lodash")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@emotion/css","@formily/react","antd","react","react-i18next","@nocobase/utils/client","@formily/core","lodash"],e):(n=typeof globalThis!="undefined"?globalThis:n||self,e(n["@nocobase/plugin-action-duplicate"]={},n["@nocobase/client"],n.jsxRuntime,n["@emotion/css"],n["@formily/react"],n.antd,n.react,n["react-i18next"],n["@nocobase/utils"],n["@formily/core"],n.lodash))})(this,function(n,e,i,d,p,T,y,M,b,I,re){"use strict";var be=Object.defineProperty,Ce=Object.defineProperties;var De=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var ae=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var ce=(n,e,i)=>e in n?be(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i,x=(n,e)=>{for(var i in e||(e={}))ae.call(e,i)&&ce(n,i,e[i]);if(j)for(var i of j(e))se.call(e,i)&&ce(n,i,e[i]);return n},g=(n,e)=>Ce(n,De(e));var le=(n,e)=>{var i={};for(var d in n)ae.call(n,d)&&e.indexOf(d)<0&&(i[d]=n[d]);if(n!=null&&j)for(var d of j(n))e.indexOf(d)<0&&se.call(n,d)&&(i[d]=n[d]);return i};var L=(n,e,i)=>new Promise((d,p)=>{var T=b=>{try{M(i.next(b))}catch(I){p(I)}},y=b=>{try{M(i.throw(b))}catch(I){p(I)}},M=b=>b.done?d(b.value):Promise.resolve(b.value).then(T,y);M((i=i.apply(n,e)).next())});const R=d.css`
  position: relative;
  &:hover {
    .general-schema-designer {
      display: block;
    }
  }
  .general-schema-designer {
    position: absolute;
    z-index: 999;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    display: none;
    background: var(--colorBgSettingsHover);
    border: 0;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    pointer-events: none;
    > .general-schema-designer-icons {
      position: absolute;
      right: 2px;
      top: 2px;
      line-height: 16px;
      pointer-events: all;
      .ant-space-item {
        background-color: var(--colorSettings);
        color: #fff;
        line-height: 16px;
        width: 16px;
        padding-left: 1px;
        align-self: stretch;
      }
    }
  }
`,K=p.observer(t=>{var te,oe,ne;const{children:c}=t,{message:s}=T.App.useApp(),o=p.useField(),u=p.useFieldSchema(),C=e.useAPIClient(),m=o.disabled||t.disabled,{designable:D}=e.useDesignable(),[w,v]=y.useState(!1),[h,z]=y.useState(!1),{service:A,__parent:_,block:V}=e.useBlockRequestContext(),{duplicateFields:k,duplicateMode:N="quickDulicate",duplicateCollection:B}=u["x-component-props"],l=e.useRecord(),f=e.useCollectionParentRecordData(),{id:a,__collection:r}=l,P=e.useActionContext(),{name:F}=e.useCollection_deprecated(),{getCollectionFields:he}=e.useCollectionManager_deprecated(),{t:q}=M.useTranslation(),xe=he(r||F),ge=e.useFormBlockContext(),W=e.useACLActionParamsContext(),{token:X}=e.useToken(),fe=y.useMemo(()=>{var S;return{opacity:D&&(((S=o==null?void 0:o.data)==null?void 0:S.hidden)||!W)&&.1,color:X.colorPrimary}},[D,(te=o==null?void 0:o.data)==null?void 0:te.hidden,X]),Y={key:"duplicate",dataId:a,default:!0,fields:(k==null?void 0:k.filter(S=>xe.find(O=>S.includes(O.name))))||[],collection:r||F},Z=u["x-component"]==="Action.Link",ye=()=>L(this,null,function*(){var S,O,ie;z(!0);try{const E=yield e.fetchTemplateData(C,Y,q);yield C.resource(r||F).create({values:x({},E)}),s.success(q("Saved successfully")),V==="form"?(O=(S=_==null?void 0:_.service)==null?void 0:S.refresh)==null||O.call(S):yield(ie=A==null?void 0:A.refresh)==null?void 0:ie.call(A),z(!1)}catch(E){z(!1),b.captureException(E)}}),ee=()=>{!m&&!h&&W&&((k==null?void 0:k.length)>0?N==="quickDulicate"?ye():v(!0):s.error(q("Please configure the duplicate fields")))};return i.jsx("div",{className:d.cx(R,{[d.css`
            .general-schema-designer {
              top: -10px;
              bottom: -10px;
              left: -10px;
              right: -10px;
            }
          `]:Z}),children:i.jsx(e.FormBlockContext.Provider,{value:g(x({},ge),{duplicateData:{display:!1,enabled:!0,defaultTemplate:Y}}),children:i.jsxs("div",{children:[Z?i.jsx("a",{className:"nb-action-link",role:t.role,"aria-label":t["aria-label"],disabled:m,style:x({opacity:D&&((oe=o==null?void 0:o.data)==null?void 0:oe.hidden)&&.1,cursor:h?"not-allowed":"pointer",position:"relative"},fe),onClick:ee,children:h?q("Duplicating"):c||q("Duplicate")}):i.jsx(T.Button,g(x({role:t.role,"aria-label":t["aria-label"],disabled:m,style:{opacity:D&&((ne=o==null?void 0:o.data)==null?void 0:ne.hidden)&&.1}},t),{onClick:ee,children:h?q("Duplicating"):c||q("Duplicate")})),i.jsx(e.CollectionProvider_deprecated,{name:B||F,children:i.jsx(e.RecordProvider,{record:g(x({},l),{__collection:B||r}),parent:f,children:i.jsx(e.ActionContextProvider,{value:g(x({},P),{visible:w,setVisible:v}),children:i.jsx(p.RecursionField,{schema:u,basePath:o.address,onlyRenderProperties:!0})})})})]})})})},{displayName:"DuplicateAction"}),$=p.connect(T.Tree,p.mapProps((t,c)=>{y.useEffect(()=>{c.value=t.defaultCheckedKeys||[]},[]);const[s,o]=y.useState(t.defaultCheckedKeys||[]),u=m=>{o(m),c.value=m};c.onCheck=u;const C=p.useForm();return g(x({},t),{checkedKeys:s,onCheck:u,treeData:t==null?void 0:t.treeData.map(m=>{var D;if(C.values.duplicateMode==="quickDulicate"){const w=(D=m==null?void 0:m.children)==null?void 0:D.map(v=>g(x({},v),{disabled:!1}));return g(x({},m),{disabled:!1,children:w})}return m})})})),G=(t,c)=>{for(let o=0;o<(t==null?void 0:t.length);o++){const s=t[o],{children:u}=s,C=le(s,["children"]);c.push(C.key),u&&G(u,c)}return c},H=t=>t.reduceProperties((s,o)=>o["x-decorator"]==="FormBlockProvider"?o:H(o),null);function pe(){var V,k,N,B;const{dn:t}=e.useDesignable(),{t:c}=M.useTranslation(),s=p.useField(),o=p.useFieldSchema(),{name:u}=e.useCollection_deprecated(),{collectionList:C,getEnableFieldTree:m,getOnLoadData:D,getOnCheck:w}=e.useCollectionState(u),v=re.cloneDeep(((V=o["x-component-props"])==null?void 0:V.duplicateFields)||[]),h=e.useRecord(),z=y.useCallback((l,f,a)=>{a.query("duplicateFields").take(r=>{r.componentProps.treeData=l,r.componentProps.defaultCheckedKeys=f,r.setInitialValue(f),r==null||r.onCheck(f),a.setValues(g(x({},a.values),{treeData:l}))})},[]),A=l=>({run(){return L(this,null,function*(){l.query("duplicateFields").take(a=>{var P;const r=G(a.componentProps.treeData,[]);a.componentProps.defaultCheckedKeys=r,a.setInitialValue(r),(P=a==null?void 0:a.onCheck)==null||P.call(a,r)})})}}),_=l=>({run(){return L(this,null,function*(){l.query("duplicateFields").take(a=>{a.componentProps.defaultCheckedKeys=[],a.setInitialValue([]),a==null||a.onCheck([])})})}});return i.jsx(e.SchemaSettingsModalItem,{title:c("Duplicate mode"),components:{Tree:$},scope:{getEnableFieldTree:m,collectionName:((k=o["x-component-props"])==null?void 0:k.duplicateCollection)||(h==null?void 0:h.__collection)||u,currentCollection:(h==null?void 0:h.__collection)||u,getOnLoadData:D,getOnCheck:w,treeData:(N=o["x-component-props"])==null?void 0:N.treeData,duplicateValues:v,onFieldInputValueChange:I.onFieldInputValueChange},schema:{type:"object",title:c("Duplicate mode"),properties:{duplicateMode:{"x-decorator":"FormItem","x-component":"Radio.Group",title:c("Duplicate mode"),default:((B=o["x-component-props"])==null?void 0:B.duplicateMode)||"quickDulicate",enum:[{value:"quickDulicate",label:'{{t("Direct duplicate")}}'},{value:"continueduplicate",label:'{{t("Copy into the form and continue to fill in")}}'}]},collection:{type:"string",title:'{{ t("Target collection") }}',required:!0,description:c("If collection inherits, choose inherited collections as templates"),default:"{{ collectionName }}","x-display":C.length>1?"visible":"hidden","x-decorator":"FormItem","x-component":"Select","x-component-props":{options:C},"x-reactions":[{dependencies:[".duplicateMode"],fulfill:{state:{disabled:'{{ $deps[0]==="quickDulicate" }}',value:'{{ $deps[0]==="quickDulicate"? currentCollection:collectionName }}'}}}]},syncFromForm:{type:"void",title:'{{ t("Sync from form fields") }}',"x-component":"Action.Link","x-component-props":{type:"primary",style:{float:"right",position:"relative",zIndex:1200},useAction:()=>{var f;const l=y.useMemo(()=>H(o),[o]);return e.useSyncFromForm(l,((f=o["x-component-props"])==null?void 0:f.duplicateCollection)||(h==null?void 0:h.__collection)||u,z)}},"x-reactions":[{dependencies:[".duplicateMode"],fulfill:{state:{visible:'{{ $deps[0]!=="quickDulicate" }}'}}}]},selectAll:{type:"void",title:'{{ t("Select all") }}',"x-component":"Action.Link","x-reactions":[{dependencies:[".duplicateMode"],fulfill:{state:{visible:'{{ $deps[0]==="quickDulicate"}}'}}}],"x-component-props":{type:"primary",style:{float:"right",position:"relative",zIndex:1200},useAction:()=>{const l=p.useForm();return A(l)}}},unselectAll:{type:"void",title:'{{ t("UnSelect all") }}',"x-component":"Action.Link","x-reactions":[{dependencies:[".duplicateMode",".duplicateFields"],fulfill:{state:{visible:`{{ $deps[0]==="quickDulicate"&&$form.getValuesIn('duplicateFields').length>0 }}`}}}],"x-component-props":{type:"primary",style:{float:"right",position:"relative",zIndex:1200,marginRight:"10px"},useAction:()=>{const l=p.useForm();return _(l)}}},duplicateFields:{type:"array",title:'{{ t("Data fields") }}',required:!0,description:c("Only the selected fields will be used as the initialization data for the form"),"x-decorator":"FormItem","x-component":$,"x-component-props":{defaultCheckedKeys:v,treeData:[],checkable:!0,checkStrictly:!0,selectable:!1,loadData:"{{ getOnLoadData($self) }}",onCheck:"{{ getOnCheck($self) }}",rootStyle:{padding:"8px 0",border:"1px solid #d9d9d9",borderRadius:"2px",maxHeight:"30vh",overflow:"auto",margin:"2px 0"}},"x-reactions":[{dependencies:[".collection",".duplicateMode"],fulfill:{state:{disabled:"{{ !$deps[0] }}",componentProps:{treeData:"{{ getEnableFieldTree($deps[0], $self,treeData) }}"}}}}]}}},onSubmit:({duplicateMode:l,collection:f,duplicateFields:a,treeData:r})=>{var F;const P=Array.isArray(a)?a:a.checked||[];s.componentProps.duplicateMode=l,s.componentProps.duplicateFields=P,o["x-component-props"]=o["x-component-props"]||{},o["x-component-props"].duplicateMode=l,o["x-component-props"].duplicateFields=P,o["x-component-props"].duplicateCollection=f,o["x-component-props"].treeData=r||((F=s.componentProps)==null?void 0:F.treeData),t.emit("patch",{schema:{"x-uid":o["x-uid"],"x-component-props":x({},o["x-component-props"])}}),t.refresh()}})}const U=[{name:"Customize",Component:t=>t.children,children:[{name:"editButton",Component:e.ActionDesigner.ButtonEditor,useComponentProps(){const{buttonEditorProps:t}=e.useSchemaToolbar();return t}},{name:"linkageRules",Component:e.SchemaSettingsLinkageRules,useComponentProps(){const{name:t}=e.useCollection_deprecated(),{linkageRulesProps:c}=e.useSchemaToolbar();return g(x({},c),{collectionName:t})}},{name:"duplicationMode",Component:pe,useVisible(){return p.useFieldSchema()["x-action"]==="duplicate"}},{name:"openMode",Component:e.SchemaSettingOpenModeSchemaItems,useComponentProps(){const t=p.useFieldSchema(),c=["create","update","view","customize:popup","duplicate","customize:create"].includes(t["x-action"]||"");return{openMode:c,openSize:c}}},{name:"remove",sort:100,Component:e.ActionDesigner.RemoveButton,useComponentProps(){const{removeButtonProps:t}=e.useSchemaToolbar();return t}}]}],de=new e.SchemaSettings({name:"ActionSettings:duplicate",items:U}),ue=new e.SchemaSettings({name:"actionSettings:duplicate",items:U}),Q=t=>{const c={type:"void","x-action":"duplicate","x-acl-action":"create",title:'{{ t("Duplicate") }}',"x-component":"Action.Link","x-decorator":"ACLActionProvider","x-component-props":{openMode:"drawer",component:"DuplicateAction"},properties:{drawer:{type:"void",title:'{{ t("Duplicate") }}',"x-component":"Action.Container","x-component-props":{className:"nb-action-popup",enablePageTabs:!0},"x-settings":"fieldSettings:Drawer",properties:{tabs:{type:"void","x-component":"Tabs","x-component-props":{},"x-initializer":"popup:addTab","x-index":1,properties:{tab1:{type:"void",title:'{{t("Duplicate")}}',"x-component":"Tabs.TabPane","x-designer":"Tabs.Designer","x-component-props":{},properties:{grid:{type:"void","x-component":"Grid","x-initializer":"popup:addNew:addBlock",properties:{}}}}}},grid:{type:"void","x-component":"Grid","x-initializer":"popup:addNew:addBlock","x-display":"hidden","x-index":2}}}}};return i.jsx(e.ActionInitializer,g(x({},t),{schema:c}))},me=t=>i.jsx(e.SchemaComponentOptions,{components:{DuplicateActionInitializer:Q,DuplicateAction:K},children:t.children});class J extends e.Plugin{load(){return L(this,null,function*(){this.app.use(me),this.app.addComponents({DuplicateActionInitializer:Q,DuplicateAction:K}),this.app.schemaSettingsManager.add(de),this.app.schemaSettingsManager.add(ue);const c={title:'{{t("Duplicate")}}',Component:"DuplicateActionInitializer",schema:{"x-component":"Action.Link","x-action":"duplicate","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:duplicate","x-decorator":"ACLActionProvider","x-component-props":{type:"primary"}},useVisible(){const s=e.useCollection_deprecated();return(s.template!=="view"||(s==null?void 0:s.writableView))&&s.template!=="file"&&s.template!=="sql"}};this.app.schemaInitializerManager.addItem("table:configureItemActions","actions.duplicate",c)})}}n.DuplicateAction=K,n.PluginActionDuplicateClient=J,n.actionDesignerCss=R,n.default=J,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
