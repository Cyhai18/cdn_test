(function(c,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("@nocobase/utils/client"),require("react/jsx-runtime"),require("react"),require("react-router-dom"),require("@formily/react"),require("antd"),require("react-i18next"),require("@emotion/css"),require("@formily/shared"),require("@ant-design/icons"),require("ahooks")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","@nocobase/utils/client","react/jsx-runtime","react","react-router-dom","@formily/react","antd","react-i18next","@emotion/css","@formily/shared","@ant-design/icons","ahooks"],e):(c=typeof globalThis!="undefined"?globalThis:c||self,e(c["@nocobase/plugin-auth"]={},c["@nocobase/client"],c["@nocobase/utils"],c.jsxRuntime,c.react,c["react-router-dom"],c["@formily/react"],c.antd,c["react-i18next"],c["@emotion/css"],c["@formily/shared"],c["@ant-design/icons"],c.ahooks))})(this,function(c,e,p,a,l,x,f,d,h,v,B,j,Z){"use strict";var Te=Object.defineProperty,we=Object.defineProperties;var Fe=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var Pe=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable;var L=(c,e,p)=>e in c?Te(c,e,{enumerable:!0,configurable:!0,writable:!0,value:p}):c[e]=p,C=(c,e)=>{for(var p in e||(e={}))Pe.call(e,p)&&L(c,p,e[p]);if(H)for(var p of H(e))Ie.call(e,p)&&L(c,p,e[p]);return c},b=(c,e)=>we(c,Fe(e));var Y=(c,e,p)=>(L(c,typeof e!="symbol"?e+"":e,p),p);var S=(c,e,p)=>new Promise((a,l)=>{var x=h=>{try{d(p.next(h))}catch(v){l(v)}},f=h=>{try{d(p.throw(h))}catch(v){l(v)}},d=h=>h.done?a(h.value):Promise.resolve(h.value).then(x,f);d((p=p.apply(c,e)).next())});const J="Email/Password",Q=t=>{const s=x.useLocation(),o=e.useAPIClient();return l.useEffect(()=>{const r=new URLSearchParams(s.search),n=r.get("authenticator"),i=r.get("token");i&&(o.auth.setToken(i),o.auth.setAuthenticator(n))}),a.jsx(a.Fragment,{children:t.children})},I="auth";function T(){return h.useTranslation([I,"client"],{nsMode:"fallback"})}const w=l.createContext([]);w.displayName="AuthenticatorsContext";const N=t=>l.useContext(w).find(o=>o.name===t);function X(t){const s=e.useApp(),o=e.useAPIClient(),{data:r=[],error:n,loading:i}=e.useRequest(()=>o.request({url:"/authenticators:publicList"}).then(m=>{var u;return((u=m==null?void 0:m.data)==null?void 0:u.data)||[]}));if(i)return s.renderComponent("AppSkeleton");if(n)throw n;return a.jsx(w.Provider,{value:r,children:a.jsx(x.Outlet,{})})}const R=()=>{var r;const s=e.usePlugin(A).authTypes.getEntities(),o={};for(const[n,i]of s)(r=i.components)!=null&&r.SignInForm&&(o[n]=i.components.SignInForm);return o},ee=v.css`
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  color: #1e1e1e;
  font-size: 15px;

  &::after {
    content: '';
    width: 42%;
    height: 1px;
    background: #d9d9d9;
    display: block;
  }

  &::before {
    content: '';
    width: 42%;
    height: 1px;
    background: #d9d9d9;
    display: block;
  }
`,te=(t=[])=>{var m;const o=e.usePlugin(A).authTypes.getEntities(),r={};for(const[u,g]of o)(m=g.components)!=null&&m.SignInButton&&(r[u]=g.components.SignInButton);const n=Object.keys(r),i=t.filter(u=>n.includes(u.authType)).map((u,g)=>l.createElement(r[u.authType],{key:g,authenticator:u}));return i.length>=1?a.jsxs("div",{style:{maxWidth:"327px",margin:"-40px auto 30px"},children:[a.jsx("div",{className:ee,children:"OR"}),i]}):i},oe=()=>{const{t}=T();e.useCurrentDocumentTitle("Signin"),e.useViewport();const s=R(),o=l.useContext(w),r=te(o);if(!o.length)return a.jsx("div",{style:{color:"#ccc"},children:t("No authentication methods available.")});const n=o.map(i=>{const m=s[i.authType];if(!m)return;const u=`${t("Sign-in")} (${t(i.authTypeTitle||i.authType)})`;return C({component:l.createElement(m,{authenticator:i}),tabTitle:i.title||u},i)}).filter(i=>i);return a.jsxs(d.Space,{direction:"vertical",className:v.css`
        display: flex;
      `,children:[n.length>1?a.jsx(d.Tabs,{items:n.map(i=>({label:i.tabTitle,key:i.name,children:i.component}))}):n.length?a.jsx("div",{children:n[0].component}):a.jsx(a.Fragment,{}),a.jsx(d.Space,{direction:"vertical",className:v.css`
          display: flex;
        `,children:r})]})},ne=l.createContext({});ne.displayName="SignupPageContext";const M=()=>{var r;const s=e.usePlugin(A).authTypes.getEntities(),o={};for(const[n,i]of s)(r=i.components)!=null&&r.SignUpForm&&(o[n]=i.components.SignUpForm);return o},se=()=>{e.useViewport(),e.useCurrentDocumentTitle("Signup");const t=M(),[s]=x.useSearchParams(),o=s.get("name"),r=N(o),{authType:n}=r||{};return t[n]?l.createElement(t[n],{authenticatorName:o}):a.jsx(x.Navigate,{to:"/not-found",replace:!0})},z="NOCODE_LOGIN_REMEMBER",k="NOCODE_LOGIN_ACCOUNT",O="NOCODE_LOGIN_PSWD";function re(){const t=x.useNavigate(),[s]=x.useSearchParams();return l.useCallback(()=>{const o=s.get("redirect");if(o){t(o,{replace:!0});return}t(p.isMobile?"/app/apps":"/app",{replace:!0})},[t,s])}const V=t=>{const s=f.useForm(),o=e.useAPIClient(),r=re(),{refreshAsync:n}=e.useCurrentUserContext(),i=f.useField(),m=f.useFieldSchema(),u=e.useCompile(),g=!!Number(localStorage.getItem(z)),y=g?p.retrieveAndDecrypt(k,"local"):"",U=g?p.retrieveAndDecrypt(O,"local"):"";return l.useEffect(()=>{s.setInitialValues({account:y,password:U,rememberMe:g})},[]),{run(){return S(this,null,function*(){try{i.setComponentProps(b(C({},i.componentProps),{loading:!0})),m.title=u('{{t("Logging in")}}'),yield s.submit();const{rememberMe:F,account:_,password:P}=s.values;localStorage.setItem(z,F?"1":"0"),yield o.auth.signIn(s.values,t),F?(p.encryptAndStore(k,_,"local"),p.encryptAndStore(O,P,"local")):(localStorage.removeItem(k),localStorage.removeItem(O)),yield n(),r()}catch(F){}finally{i.setComponentProps(b(C({},i.componentProps),{loading:!1})),m.title=u('{{t("Log in")}}')}})}}},ie={type:"object",name:"passwordForm","x-component":"FormV2",properties:{account:{type:"string","x-component":"Input","x-validator":`{{(value) => {
        if (!value) {
          return t("Please enter your username or email");
        }
        if (value.includes('@')) {
          if (!/^[\\w-]+(\\.[\\w-]+)*@[\\w-]+(\\.[\\w-]+)+$/.test(value)) {
            return t("Please enter a valid email");
          }
        } else {
          return /^[^@.<>"'/]{2,50}$/.test(value) || t("Please enter a valid username");
        }
      }}}`,"x-decorator":"FormItem","x-decorator-props":{label:'{{t("Username/Email")}}',className:e.css`
          font-size: 12px !important;

          .ant-formily-item-label {
            font-weight: 700;
            line-height: 12px;
            min-height: 15px;
          }
        `},"x-component-props":{placeholder:'{{t("Username/Email")}}',style:{height:40},size:"large"}},password:{type:"string","x-component":"Password",required:!0,"x-decorator":"FormItem","x-decorator-props":{label:'{{t("Password")}}',className:e.css`
          font-size: 12px !important;

          .ant-formily-item-label {
            font-weight: 700;
            line-height: 12px;
            min-height: 15px;
          }
          .ant-formily-item-asterisk {
            display: none;
          }
        `},"x-component-props":{placeholder:'{{t("Password")}}',style:{height:40},size:"large"}},extraActions:{type:"void","x-component":"div",properties:{rememberMe:{type:"boolean","x-decorator":"FormItem","x-decorator-props":{className:e.css`
              margin-top: 14px;
              .ant-formily-item-control .ant-formily-item-control-content-component {
                line-height: 12px !important;
                min-height: 15px !important;
              }

              .ant-checkbox-wrapper {
                font-size: 12px !important;
                line-height: 16px !important;
              }
            `},"x-component":"Checkbox","x-content":'{{t("Remember me")}}'}}},actions:{type:"void","x-component":"div",properties:{submit:{title:'{{t("Log in")}}',type:"void","x-component":"Action","x-component-props":{htmlType:"submit",block:!0,type:"primary",useAction:"{{ useBasicSignIn }}",style:{width:"100%",height:40,marginTop:10},size:"large",loading:!1}}}}}},ae="xwork.ashgso.com",ce=location.host===ae,$=e.css`
  font-weight: 900;
  font-size: 30px;
  margin-bottom: 24px;
  user-select: none;
`,pe=t=>{var P,K,W;const{t:s}=T(),o=t.authenticator,{authType:r,name:n,options:i}=o,u=!!M()[r]&&(i==null?void 0:i.allowSignUp),g=`/signup?name=${n}`,{data:y}=e.useSystemSettings(),U=e.useScopeTheme(),q=l.useRef(null);Z.useLongPress(()=>{ce||p.callFlutter("platform")},q,{delay:1e3});const F=!!((P=y==null?void 0:y.data)!=null&&P.loginTitle),_=()=>V(n);return a.jsxs("div",{style:{position:"relative",padding:"119px 0 40px 0"},children:[a.jsx("div",{style:{position:"absolute",top:0,zIndex:-1,height:"100vh",width:" 100%",background:`linear-gradient(180.04deg, ${U.token.colorPrimary} 0.04%, #FFFFFF 36.53%)`}}),a.jsxs("div",{style:{maxWidth:327,margin:"0 auto"},children:[F?a.jsxs("h1",{ref:q,unselectable:"on",className:$,children:["Hi, ðŸ‘‹",a.jsx("br",{}),(K=y==null?void 0:y.data)==null?void 0:K.loginTitle]}):a.jsx("h1",{ref:q,unselectable:"on",className:$,children:(W=y==null?void 0:y.data)==null?void 0:W.title}),a.jsx(d.ConfigProvider,{theme:{components:{Button:{}}},children:a.jsx(e.SchemaComponent,{schema:ie,scope:{useBasicSignIn:_,allowSignUp:u,signUpLink:g,t:s}})})]})]})},ue=t=>{const s=x.useNavigate(),o=f.useForm(),r=e.useAPIClient(),{t:n}=h.useTranslation();return{run(){return S(this,null,function*(){var m;yield o.submit(),yield r.auth.signUp(o.values,t==null?void 0:t.authenticator),d.message.success(((m=t==null?void 0:t.message)==null?void 0:m.success)||n("Sign up successfully, and automatically jump to the sign in page")),setTimeout(()=>{s("/signin")},2e3)})}}},le={type:"object",name:B.uid(),"x-component":"FormV2",properties:{username:{type:"string",required:!0,"x-component":"Input","x-validator":{username:!0},"x-decorator":"FormItem","x-component-props":{placeholder:'{{t("Username")}}',style:{}}},password:{type:"string",required:!0,"x-component":"Password","x-decorator":"FormItem","x-component-props":{placeholder:'{{t("Password")}}',checkStrength:!0,style:{}},"x-reactions":[{dependencies:[".confirm_password"],fulfill:{state:{selfErrors:'{{$deps[0] && $self.value && $self.value !== $deps[0] ? t("Password mismatch") : ""}}'}}}]},confirm_password:{type:"string",required:!0,"x-component":"Password","x-decorator":"FormItem","x-component-props":{placeholder:'{{t("Confirm password")}}',style:{}},"x-reactions":[{dependencies:[".password"],fulfill:{state:{selfErrors:'{{$deps[0] && $self.value && $self.value !== $deps[0] ? t("Password mismatch") : ""}}'}}}]},actions:{type:"void","x-component":"div",properties:{submit:{title:'{{t("Sign up")}}',type:"void","x-component":"Action","x-component-props":{block:!0,type:"primary",htmlType:"submit",useAction:"{{ useBasicSignUp }}",style:{width:"100%"}}}}},link:{type:"void","x-component":"div",properties:{link:{type:"void","x-component":"Link","x-component-props":{to:"/signin"},"x-content":'{{t("Log in with an existing account")}}'}}}}},me=({authenticatorName:t})=>{const{t:s}=T(),o=()=>ue({authenticator:t}),r=N(t),{options:n}=r;return n!=null&&n.allowSignUp?a.jsx(e.SchemaComponent,{schema:le,scope:{useBasicSignUp:o,t:s}}):a.jsx(x.Navigate,{to:"/not-found",replace:!0})},de=()=>{const{t}=T();return a.jsx(e.SchemaComponent,{scope:{t},components:{Alert:d.Alert},schema:{type:"object",properties:{public:{type:"object",properties:{allowSignUp:{"x-decorator":"FormItem",type:"boolean",title:'{{t("Allow to sign up")}}',"x-component":"Checkbox","x-component-props":{defaultChecked:!0}}}},notice:{type:"void","x-component":"Alert","x-component-props":{showIcon:!0,message:'{{t("The authentication allows users to sign in via username or email.")}}'}}}}})},D=l.createContext({type:""});D.displayName="AuthTypeContext";const E=l.createContext({types:[]});E.displayName="AuthTypesContext";const he=()=>{const{types:t}=l.useContext(E);return t},G={name:"authenticators",sortable:!0,fields:[{interface:"input",type:"string",name:"name",uiSchema:{type:"string",title:'{{t("Auth UID")}}',"x-component":"Input","x-validator":t=>/^[a-zA-Z0-9_-]+$/.test(t)?"":e.i18n.t("a-z, A-Z, 0-9, _, -"),required:!0}},{interface:"input",type:"string",name:"authType",uiSchema:{type:"string",title:'{{t("Auth Type")}}',"x-component":"Select",dataSource:"{{ types }}",required:!0}},{interface:"input",type:"string",name:"title",uiSchema:{type:"string",title:'{{t("Title")}}',"x-component":"Input"}},{interface:"textarea",type:"string",name:"description",uiSchema:{type:"string",title:'{{t("Description")}}',"x-component":"Input"}},{type:"boolean",name:"enabled",uiSchema:{type:"boolean",title:'{{t("Enabled")}}',"x-component":"Checkbox"}}]},ye={type:"object",properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues(t){const s=e.useActionContext(),{type:o}=l.useContext(D);return e.useRequest(()=>Promise.resolve({data:{name:`s_${B.uid()}`,authType:o}}),b(C({},t),{refreshDeps:[s.visible]}))}},title:'{{t("Add new")}}',properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},authType:{"x-component":"CollectionField","x-decorator":"FormItem","x-component-props":{options:"{{ types }}"}},title:{"x-component":"CollectionField","x-decorator":"FormItem"},description:{"x-component":"CollectionField","x-decorator":"FormItem"},enabled:{"x-component":"CollectionField","x-decorator":"FormItem"},options:{type:"object","x-component":"Options"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useCreateAction }}"}}}}}}}},xe={type:"void",name:"authenticators","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:G,resourceName:"authenticators",dragSort:!0,request:{resource:"authenticators",action:"list",params:{pageSize:50,sort:"sort",appends:[]}}},"x-component":"CollectionProvider_deprecated","x-component-props":{collection:G},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{delete:{type:"void",title:'{{t("Delete")}}',"x-component":"Action","x-component-props":{icon:"DeleteOutlined",useAction:"{{ cm.useBulkDestroyAction }}",confirm:{title:"{{t('Delete')}}",content:"{{t('Are you sure you want to delete it?')}}"}}},create:{type:"void",title:'{{t("Add new")}}',"x-component":"AddNew","x-component-props":{type:"primary"}}}},table:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"id",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}",useAction(){const t=e.useAPIClient(),{t:s}=h.useTranslation();return{move(r,n){return S(this,null,function*(){yield t.resource("authenticators").move({sourceId:r.id,targetId:n.id}),d.message.success(s("Saved successfully"),.2)})}}}},properties:{name:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},authType:{title:'{{t("Auth Type")}}',type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{authType:{type:"string","x-component":"Select","x-read-pretty":!0,enum:"{{ types }}"}}},title:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{title:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},description:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{description:{type:"boolean","x-component":"CollectionField","x-read-pretty":!0}}},enabled:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{enabled:{type:"boolean","x-component":"CollectionField","x-read-pretty":!0}}},actions:{type:"void",title:'{{t("Actions")}}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{update:{type:"void",title:'{{t("Configure")}}',"x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:"{{ cm.useValuesFromRecord }}"},title:'{{t("Configure")}}',properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},authType:{"x-component":"CollectionField","x-decorator":"FormItem","x-component-props":{options:"{{ types }}"}},title:{"x-component":"CollectionField","x-decorator":"FormItem"},description:{"x-component":"CollectionField","x-decorator":"FormItem"},enabled:{"x-component":"CollectionField","x-decorator":"FormItem"},options:{type:"object","x-component":"Options"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useUpdateAction }}"}}}}}}}},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action.Link","x-component-props":{confirm:{title:"{{t('Delete record')}}",content:"{{t('Are you sure you want to delete it?')}}"},useAction:"{{cm.useDestroyAction}}"},"x-disabled":"{{ useCanNotDelete() }}"}}}}}}}}},ge=t=>{const s=e.useRecord(),o=e.useRequest(()=>Promise.resolve({data:C({},s.options)}),b(C({},t),{manual:!0})),{run:r}=o,n=e.useActionContext();return l.useEffect(()=>{n.visible&&r()},[n.visible,r]),o},fe=t=>{var r;const o=e.usePlugin(A).authTypes.get(t);return(r=o==null?void 0:o.components)==null?void 0:r.AdminSettingsForm},Ce=f.observer(()=>{const t=f.useForm(),s=e.useRecord(),o=fe(t.values.authType||s.authType);return o?a.jsx(o,{}):null},{displayName:"Options"}),ve=()=>{const{setVisible:t}=e.useActionContext();return{run(){return S(this,null,function*(){t(!1)})}}},Ae=()=>{const{t}=h.useTranslation(),[s,o]=l.useState(!1),[r,n]=l.useState(""),i=he(),m=i.map(u=>b(C({},u),{onClick:()=>{o(!0),n(u.value)}}));return a.jsx(e.ActionContextProvider,{value:{visible:s,setVisible:o},children:a.jsxs(D.Provider,{value:{type:r},children:[a.jsx(d.Dropdown,{menu:{items:m},children:a.jsxs(d.Button,{icon:a.jsx(j.PlusOutlined,{}),type:"primary",children:[t("Add new")," ",a.jsx(j.DownOutlined,{})]})}),a.jsx(e.SchemaComponent,{scope:{useCloseAction:ve,types:i,setType:n},schema:ye})]})})},be=()=>(e.useAsyncData(),!1),Se=()=>{const{t}=T(),[s,o]=l.useState([]),r=e.useAPIClient();return e.useRequest(()=>r.resource("authenticators").listTypes().then(n=>{var m;return(((m=n==null?void 0:n.data)==null?void 0:m.data)||[]).map(u=>({key:u.name,label:t(u.title||u.name),value:u.name}))}),{onSuccess:n=>{o(n)}}),a.jsx(d.Card,{bordered:!1,children:a.jsx(E.Provider,{value:{types:s},children:a.jsx(e.SchemaComponent,{schema:xe,components:{AddNew:Ae,Options:Ce},scope:{types:s,useValuesFromOptions:ge,useCanNotDelete:be,t}})})})};class A extends e.Plugin{constructor(){super(...arguments);Y(this,"authTypes",new p.Registry)}registerType(o,r){this.authTypes.register(o,r)}load(){return S(this,null,function*(){this.app.pluginSettingsManager.add(I,{icon:"LoginOutlined",title:`{{t("Authentication", { ns: "${I}" })}}`,Component:Se,aclSnippet:"pm.auth.authenticators"}),this.router.add("auth",{Component:"AuthLayout"}),this.router.add("auth.signin",{path:"/signin",Component:"SignInPage"}),this.router.add("auth.signup",{path:"/signup",Component:"SignUpPage"}),this.app.addComponents({AuthLayout:X,SignInPage:oe,SignUpPage:se}),this.app.providers.unshift([Q,{}]),this.registerType(J,{components:{SignInForm:pe,SignUpForm:me,AdminSettingsForm:de}})})}}c.AuthenticatorsContext=w,c.PluginAuthClient=A,c.default=A,c.useAuthenticator=N,c.useSignIn=V,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
