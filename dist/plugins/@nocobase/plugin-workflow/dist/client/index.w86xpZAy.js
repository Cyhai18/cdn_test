(function(w,r){typeof exports=="object"&&typeof module!="undefined"?r(exports,require("react/jsx-runtime"),require("react"),require("@nocobase/client"),require("@nocobase/utils/client"),require("react-router-dom"),require("antd"),require("react-i18next"),require("@ant-design/icons"),require("@formily/core"),require("@formily/react"),require("@formily/shared"),require("lodash"),require("antd-style"),require("dayjs"),require("@nocobase/evaluators/client"),require("@formily/antd-v5")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","react","@nocobase/client","@nocobase/utils/client","react-router-dom","antd","react-i18next","@ant-design/icons","@formily/core","@formily/react","@formily/shared","lodash","antd-style","dayjs","@nocobase/evaluators/client","@formily/antd-v5"],r):(w=typeof globalThis!="undefined"?globalThis:w||self,r(w["@nocobase/plugin-workflow"]={},w.jsxRuntime,w.react,w["@nocobase/client"],w["@nocobase/utils"],w["react-router-dom"],w.antd,w["react-i18next"],w["@ant-design/icons"],w["@formily/core"],w["@formily/react"],w["@formily/shared"],w.lodash,w["antd-style"],w.dayjs,w["@nocobase/evaluators"],w["@formily/antd-v5"]))})(this,function(w,r,p,a,z,ue,b,ee,P,ge,Y,yt,Oe,sn,an,Le,ln){"use strict";var qr=Object.defineProperty,Jr=Object.defineProperties;var Zr=Object.getOwnPropertyDescriptors;var ht=Object.getOwnPropertySymbols;var on=Object.prototype.hasOwnProperty,nn=Object.prototype.propertyIsEnumerable;var Wt=(w,r,p)=>r in w?qr(w,r,{enumerable:!0,configurable:!0,writable:!0,value:p}):w[r]=p,k=(w,r)=>{for(var p in r||(r={}))on.call(r,p)&&Wt(w,p,r[p]);if(ht)for(var p of ht(r))nn.call(r,p)&&Wt(w,p,r[p]);return w},D=(w,r)=>Jr(w,Zr(r));var rn=w=>typeof w=="symbol"?w:w+"",R=(w,r)=>{var p={};for(var a in w)on.call(w,a)&&r.indexOf(a)<0&&(p[a]=w[a]);if(w!=null&&ht)for(var a of ht(w))r.indexOf(a)<0&&nn.call(w,a)&&(p[a]=w[a]);return p};var S=(w,r,p)=>(Wt(w,typeof r!="symbol"?r+"":r,p),p);var q=(w,r,p)=>new Promise((a,z)=>{var ue=P=>{try{ee(p.next(P))}catch(ge){z(ge)}},b=P=>{try{ee(p.throw(P))}catch(ge){z(ge)}},ee=P=>P.done?a(P.value):Promise.resolve(P.value).then(ue,b);ee((p=p.apply(w,r)).next())});const gt=p.createContext({});function cn(){return p.useContext(gt)}const je=p.createContext({});function X(){return p.useContext(je)}const f="workflow";function A(e,t={}){return a.i18n.t(e,D(k({},t),{ns:f}))}function bt(){return ee.useTranslation(f)}function xt(e){const t=new Map;e.forEach(o=>t.set(o.id,o));for(const o of t.values())o.upstreamId&&(o.upstream=t.get(o.upstreamId)),o.downstreamId&&(o.downstream=t.get(o.downstreamId))}function vt(e,t){t(e),e.properties&&Object.keys(e.properties).forEach(o=>{vt(e.properties[o],t)})}function ke(e){return`/app/settings/workflow/workflows/${e}`}function Ke(e){return`/app/settings/workflow/executions/${e}`}const zt="TRANSACTION_HISTORY_ITEM_NAME",_t="CHARTS_ITEM_NAME",Ht="EMAIL_ITEM_NAME";function un(n){var s=n,{collection:e,dataPath:t}=s,o=R(s,["collection","dataPath"]);const{insert:l}=a.useSchemaInitializer(),{t:i}=ee.useTranslation(),{getTemplateSchemaByMode:c}=a.useSchemaTemplateManager(),{getCollection:d}=a.useCollectionManager_deprecated(),u=a.usePlugin("@ashley/plugin-aps-go-notice"),m=a.usePlugin("@ashley/plugin-todo-status-block");let h=a.useRecordCollectionDataSourceItems("FormItem");const C=o.name==="triggerData"?[{type:"item",name:_t,icon:"LineChartOutlined",title:i("Chart")}]:[];h.length===0?h=[{key:"FormItem_table_blank",type:"item",name:e.name,title:i("Blank block")},...C]:h=[...h,...C],m&&o.name==="triggerData"&&h.push({type:"item",name:zt,title:i("Transaction History",{ns:"todo-status-block"})}),u&&u.isInitializerItemVisible(e)&&h.push({type:"item",name:Ht,title:i("Aps go notice email")});let y;if(typeof e=="string"){const[v,T]=a.parseCollectionName(e);y=d(T,v)}else y=e;const g=v=>({type:"void",name:"charts","x-decorator":"DetailsBlockProvider","x-decorator-props":{collection:e,dataSource:`{{${t}}}`},"x-component":"CardItem","x-component-props":{title:v.title,className:o.cardItemClassName},"x-designer":"ChartV2BlockDesigner",properties:{chart:{type:"void","x-component":"Grid","x-decorator":"ChartV2Block","x-initializer":"charts:addBlock"}}}),O=v=>q(this,null,function*(){const T=v.template?yield c(v):null;return{type:"void",name:yt.uid(),title:y.title,"x-decorator":"DetailsBlockProvider","x-decorator-props":{collection:e,dataPath:t},"x-component":"CardItem","x-component-props":{title:o.title,className:o.cardItemClassName},"x-designer":"SimpleDesigner",properties:{grid:{type:"void","x-component":"FormV2","x-use-component-props":"useDetailsBlockProps","x-read-pretty":!0,properties:{grid:T||{type:"void","x-component":"Grid","x-initializer":"details:configureFields",properties:{}}}}}}}),x={[_t]:g,[zt]:v=>m==null?void 0:m.createTransactionHistoryBlockSchema(v,{collection:e,dataPath:t,props:o}),[Ht]:v=>u==null?void 0:u.createApsGoNoticeEmailBlockSchema(v,{collection:e,dataPath:t,props:o})};function M(T){return q(this,arguments,function*({item:v}){const I=yield x[v.name]?x[v.name](v):O(v);vt(I,N=>{N["x-uid"]&&delete N["x-uid"]}),l(I)})}return r.jsx(a.SchemaInitializerItem,D(k({},o),{onClick:M,items:h}))}function We(e){var i;const t=a.useSchemaInitializerItem(),o=(i=e==null?void 0:e.collection)!=null?i:t.collection;let n,s;if(typeof o=="string"){const c=a.parseCollectionName(o);n=c[0],s=c[1]}else s=o;const l=a.useCollectionRecordData()||{};return r.jsx(a.CollectionProvider_deprecated,{dataSource:n,collection:s,children:r.jsx(un,D(k(k({},t),e),{recordData:l}))})}function dn(e){const{execution:t,nodes:o}=X(),n=p.useMemo(()=>o.reduce((i,c)=>Object.assign(i,{[c.id]:c.key}),{}),[o]),s=p.useMemo(()=>{var i;return{$context:t==null?void 0:t.context,$jobsMapByNodeKey:((i=t==null?void 0:t.jobs)!=null?i:[]).reduce((c,d)=>Object.assign(c,{[n[d.nodeId]]:d.result}),{})}},[t==null?void 0:t.context,t==null?void 0:t.jobs,n]);return p.useMemo(()=>Oe.get(s,e),[s,e])}function pn(e){var o;const t=/\{\{(.*)\}\}/g;return(o=e==null?void 0:e.replace)==null?void 0:o.call(e,t,(n,s)=>s)}function fn(e){const{collection:t,dataPath:o,dataSource:n,children:s,action:l}=e,i=Y.useField(),c=p.useRef(null),{getAssociationAppends:d}=a.useAssociationNames(),{appends:u,updateAssociationValues:m}=d(),h=a.useRecord(),C=dn(o||pn(n))||h;let y,g;if(typeof t=="string"){const I=a.parseCollectionName(t);y=I[0],g=I[1]}else g=t;const O=p.useMemo(()=>ge.createForm({values:C,readPretty:!0}),[C]),x={appends:u},M={loading:!1,data:{data:C}},v=a.useBlockRequestContext();p.useEffect(()=>{l==="get"&&!C&&O.setValues((v==null?void 0:v.service.data.data)||{})},[]);const T=a.useRequest({},{manual:!0});return r.jsx(a.CollectionProvider_deprecated,{dataSource:y,collection:g,children:r.jsx("div",{ref:c,children:r.jsx(a.RecordProvider,{record:C,parent:null,children:r.jsx(a.BlockRequestContext.Provider,{value:D(k({},T),{loading:!0}),children:r.jsx(a.FormBlockContext.Provider,{value:{params:x,form:O,field:i,service:M,updateAssociationValues:m,formBlockRef:c,collection:t},children:s})})})})})}function mn(){return!0}const wt=Y.observer(e=>{const u=e,{filter:t=mn}=u,o=R(u,["filter"]),n=a.useCompile(),{getCollectionFields:s}=a.useCollectionManager_deprecated(),{values:l}=Y.useForm(),[i,c]=a.parseCollectionName(l==null?void 0:l.collection),d=s(c,i);return r.jsx(b.Select,D(k({popupMatchSelectWidth:!1},o),{options:d.filter(t).map(m=>{var h;return{label:n((h=m.uiSchema)==null?void 0:h.title),value:m.name}})}))},{displayName:"FieldsSelect"}),hn=a.createStyles(({css:e,token:t})=>({container:e`
      margin-bottom: 1.5em;
      padding: 1em;
      background-color: ${t.colorFillAlter};

      > *:last-child {
        margin-bottom: 0;
      }

      dl {
        display: flex;
        align-items: baseline;

        dt {
          color: ${t.colorText};
          &:after {
            content: ':';
            margin-right: 0.5em;
          }
        }
      }

      p {
        color: ${t.colorTextDescription};
      }
    `}));function Yt(e){const{label:t,icon:o,title:n,description:s}=e,{styles:l}=hn();return r.jsxs("div",{className:a.cx(l.container,e.className),children:[r.jsxs("dl",{children:[r.jsx("dt",{children:t}),r.jsx("dd",{children:r.jsx(b.Tag,{icon:o,style:{background:"none"},children:n})})]}),s?r.jsx("p",{children:s}):null]})}function yn(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Gt={exports:{}};/*!
	Copyright (c) 2018 Jed Watson.
	Licensed under the MIT License (MIT), see
	http://jedwatson.github.io/classnames
*/(function(e){(function(){var t={}.hasOwnProperty;function o(){for(var n=[],s=0;s<arguments.length;s++){var l=arguments[s];if(l){var i=typeof l;if(i==="string"||i==="number")n.push(l);else if(Array.isArray(l)){if(l.length){var c=o.apply(null,l);c&&n.push(c)}}else if(i==="object"){if(l.toString!==Object.prototype.toString&&!l.toString.toString().includes("[native code]")){n.push(l.toString());continue}for(var d in l)t.call(l,d)&&l[d]&&n.push(d)}}}return n.join(" ")}e.exports?(o.default=o,e.exports=o):window.classNames=o})()})(Gt);var gn=Gt.exports;const bn=yn(gn),xn=a.createStyles(({css:e,token:t})=>({statusButtonClass:e`
    border: none;
    .ant-tag {
      width: 100%;
      height: 100%;
      padding: 0;
      margin-right: 0;
      border-radius: 50%;
      text-align: center;
    }
  `,noStatusButtonClass:e`
    border-width: 2px;
  `}));function ze(e){var n;const{styles:t}=xn();let o=null;if(typeof e.status!="undefined"&&((n=e.statusMap)!=null&&n[e.status])){const{icon:s,color:l}=e.statusMap[e.status];o=r.jsx(b.Tag,{color:l,children:s})}return r.jsx(b.Button,D(k({},Oe.omit(e,["statusMap"])),{shape:"circle",size:"small",className:bn(o?t.statusButtonClass:t.noStatusButtonClass,e.className),children:o}))}const pe={QUEUEING:null,STARTED:0,RESOLVED:1,FAILED:-1,ERROR:-2,ABORTED:-3,CANCELED:-4,REJECTED:-5,RETRY_NEEDED:-6,PULL_BACK:-7},qe=[{value:pe.QUEUEING,label:`{{t("Queueing", { ns: "${f}" })}}`,color:"blue",icon:r.jsx(P.HourglassOutlined,{}),description:`{{t("Triggered but still waiting in queue to execute.", { ns: "${f}" })}}`},{value:pe.STARTED,label:`{{t("On going", { ns: "${f}" })}}`,color:"gold",icon:r.jsx(P.LoadingOutlined,{}),description:`{{t("Started and executing, maybe waiting for an async callback (manual, delay etc.).", { ns: "${f}" })}}`},{value:pe.RESOLVED,label:`{{t("Resolved", { ns: "${f}" })}}`,color:"green",icon:r.jsx(P.CheckOutlined,{}),description:`{{t("Successfully finished.", { ns: "${f}" })}}`},{value:pe.FAILED,label:`{{t("Failed", { ns: "${f}" })}}`,color:"red",icon:r.jsx(P.ExclamationOutlined,{}),description:`{{t("Failed to satisfy node configurations.", { ns: "${f}" })}}`},{value:pe.ERROR,label:`{{t("Error", { ns: "${f}" })}}`,color:"red",icon:r.jsx(P.CloseOutlined,{}),description:`{{t("Some node meets error.", { ns: "${f}" })}}`},{value:pe.ABORTED,label:`{{t("Aborted", { ns: "${f}" })}}`,color:"red",icon:r.jsx(P.MinusOutlined,{rotate:90}),description:`{{t("Running of some node was aborted by program flow.", { ns: "${f}" })}}`},{value:pe.CANCELED,label:`{{t("Canceled", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.MinusOutlined,{rotate:45}),description:`{{t("Manually canceled whole execution when waiting.", { ns: "${f}" })}}`},{value:pe.REJECTED,label:`{{t("Rejected", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.MinusOutlined,{}),description:`{{t("Rejected from a manual node.", { ns: "${f}" })}}`},{value:pe.RETRY_NEEDED,label:`{{t("Retry needed", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.RedoOutlined,{}),description:`{{t("General failed but should do another try.", { ns: "${f}" })}}`},{value:pe.PULL_BACK,label:`{{t("Pull Back", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.MinusOutlined,{}),description:`{{t("Pull Back from a manual node.", { ns: "${f}" })}}`}],Je=qe.reduce((e,t)=>Object.assign(e,{[t.value]:t}),{});var Ie=(e=>(e[e.PENDING=0]="PENDING",e[e.RESOLVED=1]="RESOLVED",e[e.FAILED=-1]="FAILED",e[e.ERROR=-2]="ERROR",e[e.ABORTED=-3]="ABORTED",e[e.CANCELED=-4]="CANCELED",e[e.REJECTED=-5]="REJECTED",e[e.RETRY_NEEDED=-6]="RETRY_NEEDED",e[e.PULL_BACK=-7]="PULL_BACK",e))(Ie||{});const Ct=[{value:0,label:`{{t("Pending", { ns: "${f}" })}}`,color:"gold",icon:r.jsx(P.ClockCircleOutlined,{})},{value:1,label:`{{t("Resolved", { ns: "${f}" })}}`,color:"green",icon:r.jsx(P.CheckOutlined,{})},{value:-1,label:`{{t("Failed", { ns: "${f}" })}}`,color:"red",icon:r.jsx(P.ExclamationOutlined,{})},{value:-2,label:`{{t("Error", { ns: "${f}" })}}`,color:"red",icon:r.jsx(P.CloseOutlined,{})},{value:-3,label:`{{t("Aborted", { ns: "${f}" })}}`,color:"red",icon:r.jsx(P.MinusOutlined,{rotate:90})},{value:-4,label:`{{t("Canceled", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.MinusOutlined,{rotate:45})},{value:-5,label:`{{t("Rejected", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.MinusOutlined,{})},{value:-6,label:`{{t("Retry needed", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.RedoOutlined,{})},{value:-7,label:`{{t("Pull Back", { ns: "${f}" })}}`,color:"volcano",icon:r.jsx(P.RedoOutlined,{})}],Ze=Ct.reduce((e,t)=>Object.assign(e,{[t.value]:t}),{}),kt=(e,t)=>({getAriaLabel:p.useCallback(n=>["add-button",e==null?void 0:e.type,e==null?void 0:e.title,t!=null?String(t):"",n].filter(Boolean).join("-"),[t,e==null?void 0:e.title,e==null?void 0:e.type])}),ie=a.createStyles(({css:e,token:t})=>({workflowPageClass:e`
      flex-grow: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;

      .workflow-toolbar {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        position: relative;
        padding: 8px 28px;
        background: transparent;
        height: 56px;

        header {
          display: flex;
          align-items: center;
        }

        aside {
          display: flex;
          align-items: center;
          gap: 0.5em;
          background: ${t.colorBgContainer};
          border-radius: 8px;
          padding: 2px 12px;
          height: 44px;
        }

        .workflow-versions {
          label {
            margin-right: 0.5em;
          }
        }
      }

      .workflow-canvas-wrapper {
        flex-grow: 1;
        overflow: hidden;
        position: relative;
      }

      .workflow-canvas-zoomer {
        display: flex;
        align-items: center;
        position: absolute;
        top: 2em;
        right: 2em;
        height: 10em;
        padding: 1em 0;
        border-radius: 0.5em;
        background: ${t.colorBgContainer};
      }

      .workflow-canvas {
        overflow: auto;
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2em;

        > .ant-alert {
          margin-bottom: 2em;
          font-size: 85%;
        }
      }
    `,dropdownClass:e`
      .ant-dropdown-menu-item {
        justify-content: flex-end;
        .ant-dropdown-menu-title-content {
          display: flex;
          align-items: baseline;
          justify-content: flex-end;
          text-align: right;

          time {
            width: 14em;
            font-size: 80%;
          }
        }
      }
    `,workflowVersionDropdownClass:e`
      .ant-dropdown-menu-item {
        .ant-dropdown-menu-title-content {
          strong {
            font-weight: normal;
          }

          > .enabled {
            strong {
              font-weight: bold;
            }
          }

          > .unexecuted {
            strong {
              font-style: italic;
            }
          }
        }
      }
    `,executionsDropdownRowClass:e`
      .ant-dropdown-menu-item {
        .id {
          flex-grow: 1;
          text-align: right;
        }
      }
    `,branchBlockClass:e`
      display: flex;
      position: relative;
      margin: 2em auto auto auto;

      :before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: calc(50% - 0.5px);
        width: 1px;
        background-color: ${t.colorBgLayout};
      }
    `,branchClass:e`
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 20em;
      padding: 0 2em;

      .workflow-node-list {
        flex-grow: 1;
      }

      .workflow-branch-lines {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 1px;
        background-color: ${t.colorBorder};
      }

      :before,
      :after {
        content: '';
        position: absolute;
        height: 1px;
        background-color: ${t.colorBorder};
      }

      :before {
        top: 0;
      }

      :after {
        bottom: 0;
      }

      :not(:first-child):not(:last-child) {
        :before,
        :after {
          left: 0;
          width: 100%;
        }
      }

      :last-child:not(:first-child) {
        :before,
        :after {
          right: 50%;
          width: 50%;
        }
      }

      :first-child:not(:last-child) {
        :before,
        :after {
          left: 50%;
          width: 50%;
        }
      }

      .end-sign {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 0;
        height: 6em;
        border-left: 1px dashed ${t.colorBgLayout};

        .anticon {
          font-size: 1.5em;
          line-height: 100%;
        }
      }
    `,nodeBlockClass:e`
      flex-grow: 1;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    `,nodeClass:e`
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    `,nodeCardClass:e`
      position: relative;
      width: 20em;
      background: ${t.colorBgContainer};
      padding: 1em;
      box-shadow: ${t.boxShadowTertiary};
      border-radius: ${t.borderRadiusLG}px;
      cursor: pointer;
      transition: box-shadow 0.3s ease;

      &:hover {
        box-shadow: ${t.boxShadow};

        .workflow-node-remove-button {
          display: block;
        }
      }

      &.configuring {
        box-shadow: ${t.boxShadow};
      }

      .workflow-node-remove-button {
        display: none;
        position: absolute;
        right: 0.5em;
        top: 0.5em;
        color: ${t.colorText};

        &[disabled] {
          display: none;
        }

        &:hover {
          color: ${t.colorErrorHover};
        }
      }

      .ant-input {
        font-weight: bold;

        &:not(:focus) {
          transition: background-color 0.3s ease, border-color 0.3s ease;
          border-color: ${t.colorBorderBg};
          background-color: ${t.colorBgContainerDisabled};

          &:not(:disabled):hover {
            border-color: ${t.colorPrimaryBorderHover};
          }

          &:disabled:hover {
            border-color: ${t.colorBorderBg};
          }
        }
      }

      .workflow-node-config-button {
        padding: 0;
      }

      &:hover {
        box-shadow: 0 0.25em 0.5em rgba(0, 0, 0, 0.25);

        .workflow-node-remove-button {
          display: block;
        }
      }
    `,nodeJobButtonClass:e`
      display: flex;
      position: absolute;
      top: calc(1em - 1px);
      right: 1em;
      justify-content: center;
      align-items: center;
      color: ${t.colorTextLightSolid};
    `,nodeHeaderClass:e`
      position: relative;
    `,nodeMetaClass:e`
      margin-bottom: 0.5em;

      .workflow-node-id {
        color: ${t.colorTextDescription};

        &:before {
          content: '#';
        }
      }
    `,nodeTitleClass:e`
      display: flex;
      align-items: center;
      font-weight: normal;
      .workflow-node-id {
        color: ${t.colorTextDescription};
      }
    `,nodeSubtreeClass:e`
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      margin: auto;
    `,nodeJobResultClass:e`
      padding: 1em;
      background-color: ${t.colorBgContainer};
    `,addButtonClass:e`
      flex-shrink: 0;
      padding: 2em 0;

      > .ant-btn {
        &:disabled {
          visibility: hidden;
        }
      }
    `,conditionClass:e`
      position: relative;
      overflow: visible;

      > span {
        position: absolute;
        top: calc(1.5em - 1px);
        line-height: 1em;
        color: ${t.colorTextSecondary};
        background-color: ${t.colorBgLayout};
        padding: 1px;
      }
    `,loopLineClass:e`
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 2em;
      height: 6em;
    `,terminalClass:e`
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      width: 4em;
      height: 4em;
      border-radius: 50%;
      background-color: ${t.colorText};
      color: ${t.colorBgContainer};
    `}));class ve{constructor(){S(this,"title");S(this,"type");S(this,"group");S(this,"description");S(this,"icon");S(this,"options");S(this,"fieldset");S(this,"presetFieldset");S(this,"branching");S(this,"view");S(this,"scope");S(this,"components");S(this,"end");S(this,"testable")}createDefaultConfig(){return{}}}function vn(){const e=Y.useForm(),t=a.useAPIClient(),o=a.useActionContext(),{refresh:n}=a.useResourceActionContext(),s=Ee(),{workflow:l}=X();return{run(){return q(this,null,function*(){var c,d;if(l.executed){b.message.error(A("Node in executed workflow cannot be modified"));return}yield e.submit(),yield(d=(c=t.resource("flow_nodes")).update)==null?void 0:d.call(c,{filterByTk:s.id,values:{config:e.values}}),o.setFormValueChanged(!1),o.setVisible(!1),n()})}}}const St=p.createContext({});function Ee(){return p.useContext(St)}function Ut(e,t){const o=[];if(!e)return[];for(let n=e.upstream;n;n=n.upstream)(typeof t!="function"||t(n))&&o.push(n);return o}function Kt(e){const t=[];if(!e)return[];for(let o=e;o;o=o.upstream)o.upstream&&o.branchIndex!=null&&t.push(o.upstream);return t}function qt({data:e}){const{styles:t}=ie(),{getAriaLabel:o}=kt(e),n=a.usePlugin(de),{Component:s=At,end:l}=n.instructions.get(e.type);return r.jsx(St.Provider,{value:e,children:r.jsxs("div",{className:a.cx(t.nodeBlockClass),children:[r.jsx(s,{data:e}),!l||typeof l=="function"&&!l(e)?r.jsx(lo,{"aria-label":o(),upstream:e}):r.jsx("div",{className:"end-sign",children:r.jsx(P.CloseOutlined,{})})]})})}function Jt(){var u;const{t:e}=ee.useTranslation(),t=a.useAPIClient(),{workflow:o,nodes:n,refresh:s}=(u=X())!=null?u:{},l=Ee(),{modal:i}=b.App.useApp();if(!o)return null;const c=t.resource("flow_nodes");function d(){return q(this,null,function*(){function m(){return q(this,null,function*(){var g;yield(g=c.destroy)==null?void 0:g.call(c,{filterByTk:l.id}),s()})}const h=n.filter(g=>g===l?!1:z.parse(g.config).parameters.filter(({key:M})=>M.startsWith(`$jobsMapByNodeKey.${l.key}.`)||M===`$jobsMapByNodeKey.${l.key}`).length);if(h.length){i.error({title:A("Can not delete"),content:A("The result of this node has been referenced by other nodes ({{nodes}}), please remove the usage before deleting.",{nodes:h.map(g=>`#${g.id}`).join(", ")})});return}const y=!n.find(g=>g.upstream===l&&g.branchIndex!=null)?e("Are you sure you want to delete it?"):A("This node contains branches, deleting will also be preformed to them, are you sure?");i.confirm({title:e("Delete"),content:y,onOk:m})})}return o.executed?null:r.jsx(b.Button,{type:"text",shape:"circle",icon:r.jsx(P.DeleteOutlined,{}),onClick:d,className:"workflow-node-remove-button"})}function Zt(){var l;const{execution:e,setViewJob:t}=X(),{jobs:o}=(l=Ee())!=null?l:{},{styles:n}=ie();if(!e)return null;if(!o.length)return r.jsx(ze,{className:n.nodeJobButtonClass,disabled:!0});function s({key:i}){const c=o.find(d=>d.id==i);t(c)}return o.length>1?r.jsx(b.Dropdown,{menu:{items:o.map(i=>({key:i.id,label:r.jsxs(r.Fragment,{children:[r.jsx(ze,{statusMap:Ze,status:i.status}),r.jsx("time",{children:z.str2moment(i.updatedAt).format("YYYY-MM-DD HH:mm:ss")})]})})),onClick:s,className:n.dropdownClass},children:r.jsx(ze,{statusMap:Ze,status:o[o.length-1].status,className:n.nodeJobButtonClass})}):r.jsx(ze,{statusMap:Ze,status:o[0].status,onClick:()=>t(o[0]),className:n.nodeJobButtonClass})}function wn(){return{form:Y.useForm()}}function At(e){var E,V,j;const{data:t,children:o}=e,n=a.useCompile(),s=a.useAPIClient(),{workflow:l,refresh:i}=(E=X())!=null?E:{},{styles:c}=ie(),u=a.usePlugin(de).instructions.get(t.type),m=((V=u.useValidator)==null?void 0:V.call(u))||{},h=l.executed?'{{t("View")}}':'{{t("Configure")}}',C=n(u.title),[y,g]=p.useState((j=t.title)!=null?j:C),[O,x]=p.useState(!1),[M,v]=p.useState(!1),T=p.useMemo(()=>{const L=Oe.cloneDeep(t.config);return ge.createForm({initialValues:L,disabled:l.executed})},[t,l]),I=p.useCallback(L=>{x(L),L||T.reset()},[T]),N=p.useCallback(function(L){return q(this,null,function*(){var Z,B;const _=L||C;g(_),_!==t.title&&(yield(B=(Z=s.resource("flow_nodes")).update)==null?void 0:B.call(Z,{filterByTk:t.id,values:{title:_}}),i())})},[t]),F=p.useCallback(function(L){if(L.target===L.currentTarget){x(!0);return}const _=new Set(["workflow-node-meta","workflow-node-config-button","ant-input-disabled"]);for(let Z=L.target;Z&&Z!==L.currentTarget&&Z!==document.documentElement;Z=Z.parentNode)if(Array.from(Z.classList).some(B=>_.has(B))){x(!0),L.stopPropagation();return}},[]);return r.jsxs("div",{className:a.cx(c.nodeClass,`workflow-node-type-${t.type}`),id:`workflow-node-id-${t.id}`,children:[r.jsxs("div",{role:"button","aria-label":`${C}-${y}`,className:a.cx(c.nodeCardClass,{configuring:O}),onClick:F,children:[r.jsxs("div",{className:a.cx(c.nodeMetaClass,"workflow-node-meta"),children:[r.jsx(b.Tag,{icon:u.icon,children:C}),r.jsx("span",{className:"workflow-node-id",children:t.id})]}),r.jsx(b.Input.TextArea,{disabled:l.executed,value:y,onChange:L=>g(L.target.value),onBlur:L=>N(L.target.value),autoSize:!0}),r.jsx(Jt,{}),r.jsx(Zt,{}),r.jsx(a.ActionContextProvider,{value:{visible:O,setVisible:I,formValueChanged:M,setFormValueChanged:v},children:r.jsx(a.FormProvider,{form:T,children:r.jsx(a.SchemaComponent,{distributed:!1,scope:D(k(k({},u.scope),m),{data:t,useFormProviderProps:wn}),components:u.components,schema:{type:"void",properties:D(k({},u.view?{view:u.view}:{}),{button:{type:"void","x-content":h,"x-component":b.Button,"x-component-props":{type:"link",className:"workflow-node-config-button"}},[t.id]:{type:"void",title:r.jsxs("div",{className:a.css`
                          display: flex;
                          justify-content: space-between;

                          strong {
                            font-weight: bold;
                          }

                          .ant-tag {
                            margin-inline-end: 0;
                          }

                          code {
                            font-weight: normal;
                          }
                        `,children:[r.jsx("strong",{children:t.title}),r.jsx(b.Tooltip,{title:A("Variable key of node"),children:r.jsx(b.Tag,{children:r.jsx("code",{children:t.key})})})]}),"x-decorator":"FormV2","x-use-decorator-props":"useFormProviderProps","x-component":"Action.Drawer",properties:D(k({},u.description?{description:{type:"void","x-component":Yt,"x-component-props":{label:A("Node type"),title:u.title,icon:u.icon,description:u.description}}}:{}),{fieldset:{type:"void","x-component":"fieldset","x-component-props":{className:a.css`
                            .ant-input,
                            .ant-select,
                            .ant-cascader-picker,
                            .ant-picker,
                            .ant-input-number,
                            .ant-input-affix-wrapper {
                              &.auto-width {
                                width: auto;
                                min-width: 6em;
                              }
                            }
                          `},properties:u.fieldset},actions:l.executed?null:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:vn}}}}})}})}})})})]}),o]})}const Se={label:"label",value:"value",children:"children"},Qt={label:`{{t("Node result", { ns: "${f}" })}}`,value:"$jobsMapByNodeKey",useOptions(e){const{instructions:t}=a.usePlugin(de),o=Ee(),n=Ut(o),s=[];return n.forEach(l=>{var d;const i=t.get(l.type),c=(d=i.useVariables)==null?void 0:d.call(i,l,e);c&&s.push(c)}),s}},Xt={label:`{{t("Trigger variables", { ns: "${f}" })}}`,value:"$context",useOptions(e){var s,l;const{triggers:t}=a.usePlugin(de),{workflow:o}=X(),n=t.get(o==null?void 0:o.type);return(l=(s=n==null?void 0:n.useVariables)==null?void 0:s.call(n,o.config,e))!=null?l:null}},Rt={label:`{{t("Scope variables", { ns: "${f}" })}}`,value:"$scopes",useOptions(e){const{fieldNames:t=Se,current:o}=e,{instructions:n}=a.usePlugin(de),s=Ee(),l=o!=null?o:s,i=Kt(l),c=[];return i.forEach(d=>{var h,C;const u=n.get(d.type),m=(h=u.useScopeVariables)==null?void 0:h.call(u,d,e);m&&c.push({key:d.key,[t.value]:d.key,[t.label]:(C=d.title)!=null?C:`#${d.id}`,[t.children]:m})}),c}},eo={label:`{{t("System variables", { ns: "${f}" })}}`,value:"$system",useOptions({types:e,fieldNames:t=Se}){return[...!e||e.includes("date")?[{key:"now",[t.label]:A("System time"),[t.value]:"now"}]:[]]}},to={label:`{{t("Date variables", { ns: "${f}" })}}`,value:"$nDate",useOptions({types:e,fieldNames:t=Se}){return[...!e||e.includes("date")?[{key:"now",[t.value]:"now",[t.label]:A("Now")},{key:"yesterday",[t.value]:"yesterday",[t.label]:A("Yesterday")},{key:"today",[t.value]:"today",[t.label]:A("Today")},{key:"tomorrow",[t.value]:"tomorrow",[t.label]:A("Tomorrow")},{key:"lastIsoWeek",[t.value]:"lastIsoWeek",[t.label]:A("Last week")},{key:"thisIsoWeek",[t.value]:"thisIsoWeek",[t.label]:A("This week")},{key:"nextIsoWeek",[t.value]:"nextIsoWeek",[t.label]:A("Next week")},{key:"lastMonth",[t.value]:"lastMonth",[t.label]:A("Last month")},{key:"thisMonth",[t.value]:"thisMonth",[t.label]:A("This month")},{key:"nextMonth",[t.value]:"nextMonth",[t.label]:A("Next month")},{key:"lastQuarter",[t.value]:"lastQuarter",[t.label]:A("Last quarter")},{key:"thisQuarter",[t.value]:"thisQuarter",[t.label]:A("This quarter")},{key:"nextQuarter",[t.value]:"nextQuarter",[t.label]:A("Next quarter")},{key:"lastYear",[t.value]:"lastYear",[t.label]:A("Last year")},{key:"thisYear",[t.value]:"thisYear",[t.label]:A("This year")},{key:"nextYear",[t.value]:"nextYear",[t.label]:A("Next year")},{key:"last7Days",[t.value]:"last7Days",[t.label]:A("Last 7 days")},{key:"next7Days",[t.value]:"next7Days",[t.label]:A("Next 7 days")},{key:"last30Days",[t.value]:"last30Days",[t.label]:A("Last 30 days")},{key:"next30Days",[t.value]:"next30Days",[t.label]:A("Next 30 days")},{key:"last90Days",[t.value]:"last90Days",[t.label]:A("Last 90 days")},{key:"next90Days",[t.value]:"next90Days",[t.label]:A("Next 90 days")}]:[]]}},oo={label:`{{t("Env variables", { ns: "${f}" })}}`,value:"$nEnv",useOptions({types:e,fieldNames:t=Se}){return[...!e||e.includes("env")?[{key:"DB_TABLE_PREFIX",[t.label]:"DB_TABLE_PREFIX",[t.value]:"DB_TABLE_PREFIX"},{key:"X_WORK_DOMAIN",[t.label]:"X_WORK_DOMAIN",[t.value]:"X_WORK_DOMAIN"}]:[]]}},Qe={boolean:new Set(["checkbox"]),number:new Set(["integer","number","percent"]),string:new Set(["input","password","email","phone","select","radioGroup","text","markdown","richText","expression","time"]),date:new Set(["date","createdAt","updatedAt"])};function no(e,t){var o,n,s,l,i,c;return typeof t=="string"?(o=Qe[t])==null?void 0:o.has(e.interface):typeof t=="object"&&t.type==="reference"?Tt(e)?((n=t.options)==null?void 0:n.entity)&&(e.collectionName===((s=t.options)==null?void 0:s.collection)||((l=t.options)==null?void 0:l.collection)==="*"):e.isForeignKey?e.collectionName===((i=t.options)==null?void 0:i.collection)&&e.name==="id"||e.target===((c=t.options)==null?void 0:c.collection):!1:typeof t=="function"?t(e):!1}function Tt(e){return["belongsTo","hasOne","hasMany","belongsToMany"].includes(e.type)}function Ot(e,t){if(t==null)return null;const o=`${e.name}.`;return t.filter(n=>n.startsWith(o)).map(n=>n.replace(o,""))}function It({fields:e,types:t,appends:o,depth:n=1,compile:s,getCollectionFields:l}){return e.filter(i=>{const c=t!=null&&t.length?t.some(d=>no(i,d)):!0;if(Tt(i)){if(o===null)return n?c||It({fields:Et(i.target,{compile:s,getCollectionFields:l}),types:t,depth:n-1,appends:o,compile:s,getCollectionFields:l}):!1;const d=Ot(i,o),u=o.includes(i.name);return c?u:((d==null?void 0:d.length)||u)&&It({fields:Et(i.target,{compile:s,getCollectionFields:l}),types:t,appends:d,compile:s,getCollectionFields:l}).length}else return c})}function Fe(e,t){var l,i;const o=a.useCompile(),n=(i=(l=e.useOptions)==null?void 0:l.call(e,t))==null?void 0:i.filter(Boolean),{fieldNames:s}=t;return{[s.label]:o(e.label),[s.value]:e.value,key:e[s.value],[s.children]:n,disabled:!n||!n.length}}function he(e={}){var s;const t=Object.assign({},Se,(s=e.fieldNames)!=null?s:{}),o=Object.assign(e,{fieldNames:t});return[Fe(Rt,o),Fe(Qt,o),Fe(Xt,o),Fe(eo,o),Fe(to,o),Fe(oo,o)]}function Et(e,{compile:t,getCollectionFields:o}){var u,m,h,C;const[n,s]=a.parseCollectionName(e),l=o(s,n),i=[],c=[];l.forEach(y=>{if(y.isForeignKey&&!y.primaryKey)i.push(y);else{const g=l.find(O=>O.name===y.foreignKey);g&&i.push(g),c.push(y)}});const d=Oe.uniqBy(i,"name");for(let y=c.length-1;y>=0;y--){const g=c[y];if(g.type==="belongsTo"){const O=d.findIndex(x=>x.name===g.foreignKey);if(O>-1){const x=d[O];c.splice(y,0,D(k(k({},g),x),{uiSchema:D(k({},g.uiSchema),{title:(u=x.uiSchema)!=null&&u.title?t((m=x.uiSchema)==null?void 0:m.title):x.name})})),d.splice(O,1)}else c.splice(y,0,D(k({},g),{name:g.foreignKey,type:"bigInt",isForeignKey:!0,interface:g.interface,uiSchema:D(k({},g.uiSchema),{title:(h=g.uiSchema)!=null&&h.title?`${t((C=g.uiSchema)==null?void 0:C.title)} ID`:g.name})}))}else g.type==="context"&&g.collectionName==="users"&&c.splice(y,1)}return c.push(...d),Oe.uniqBy(c,"name").filter(y=>y.interface&&!y.hidden)}function Cn(e){const t=Ot(e.field,e.appends),o=De(k({collection:`${e.field.dataSourceKey&&e.field.dataSourceKey!=="main"?`${e.field.dataSourceKey}:`:""}${e.field.target}`,types:e.types,appends:t,depth:e.depth-1},this));e.loadChildren=null,o.length?e.children=o:(e.isLeaf=!0,!e.types||e.types.some(s=>no(e.field,s))||(e.disabled=!0))}function De(e){const{fields:t,collection:o,types:n,appends:s=[],depth:l=1,compile:i,getCollectionFields:c,fieldNames:d=Se}=e,u=t!=null?t:Et(o,{compile:i,getCollectionFields:c}),m=Cn.bind({compile:i,getCollectionFields:c,fieldNames:d});return It({fields:u,types:n,depth:l,appends:s,compile:i,getCollectionFields:c}).map(C=>{var x;const y=i(((x=C.uiSchema)==null?void 0:x.title)||C.name),g=Ot(C,s),O=!Tt(C)||g&&!g.length&&!s.includes(C.name)||!1;return{[d.label]:y,key:C.name,[d.value]:C.name,isLeaf:O,loadChildren:O?null:m,field:C,depth:l,appends:s,types:n}})}function ro(o){var n=o,{variableOptions:e}=n,t=R(n,["variableOptions"]);const s=he(e);return r.jsx(a.Variable.Input,k({scope:s},t))}function Ft(o){var n=o,{variableOptions:e}=n,t=R(n,["variableOptions"]);const s=he(e);return r.jsx(a.Variable.TextArea,k({scope:s},t))}function kn(o){var n=o,{variableOptions:e}=n,t=R(n,["variableOptions"]);const s=he(e);return r.jsx(a.Variable.RawTextArea,k({scope:s},t))}function Sn(o){var n=o,{variableOptions:e}=n,t=R(n,["variableOptions"]);const s=he(e);return r.jsx(a.Variable.JSON,k({scope:s},t))}function An(o){var n=o,{variableOptions:e}=n,t=R(n,["variableOptions"]);const s=he(e);return r.jsx(a.Variable.RichTextArea,k({scope:s},t))}function Xe({value:e,onChange:t,renderSchemaComponent:o}){const n=he();return r.jsx(a.Variable.Input,{value:e,onChange:t,scope:n,children:o()})}function Me(e){const l=e,{options:t=[],direction:o}=l,n=R(l,["options","direction"]),s=a.useCompile();return r.jsx(b.Radio.Group,D(k({},n),{children:r.jsx(b.Space,{direction:o,children:t.map(i=>r.jsxs(b.Radio,{value:i.value,children:[r.jsx("span",{className:a.css`
                & + .anticon {
                  margin-left: 0.25em;
                }
              `,children:s(i.label)}),i.tooltip&&r.jsx(b.Tooltip,{title:s(i.tooltip),children:r.jsx(P.QuestionCircleOutlined,{style:{color:"#666"}})})]},i.value))})}))}function Tn(e){const l=e,{options:t=[],direction:o}=l,n=R(l,["options","direction"]),s=a.useCompile();return r.jsx(b.Checkbox.Group,D(k({},n),{children:r.jsx(b.Space,{direction:o,children:t.map(i=>r.jsxs(b.Checkbox,{value:i.value,children:[r.jsx("span",{className:a.css`
                & + .anticon {
                  margin-left: 0.25em;
                }
              `,children:s(i.label)}),i.tooltip&&r.jsx(b.Tooltip,{title:s(i.tooltip),children:r.jsx(P.QuestionCircleOutlined,{style:{color:"#666"}})})]},i.value))})}))}function so(){const e=Y.useFieldSchema(),t=a.useCompile();return r.jsxs(a.GeneralSchemaDesigner,{title:t(e.title),children:[r.jsx(a.SchemaSettingsBlockTitleItem,{}),r.jsx(a.SchemaSettingsDivider,{}),r.jsx(a.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}})]})}const Ne=()=>null;function On(){const l=a.useSchemaInitializerItem(),{node:t,resultTitle:o}=l,n=R(l,["node","resultTitle"]),{insert:s}=a.useSchemaInitializer();return r.jsx(a.SchemaInitializerItem,D(k({},n),{onClick:()=>{var i;s({type:"void",name:t.id,title:t.title,"x-component":"CardItem","x-component-props":{title:(i=t.title)!=null?i:`#${t.id}`},"x-designer":"ValueBlock.Designer",properties:{result:{type:"void",title:o,"x-component":"ValueBlock.Result","x-component-props":{dataSource:`{{$jobsMapByNodeKey.${t.key}}}`}}}})}}))}function In({dataSource:e}){var s;const t=Y.useFieldSchema(),{execution:o}=X();if(!o)return t.title;const n=z.parse(e)({$jobsMapByNodeKey:((s=o.jobs)!=null?s:[]).reduce((l,i)=>Object.assign(l,{[i.nodeKey]:i.result}),{})});return r.jsx("pre",{className:a.css`
        margin: 0;
      `,children:JSON.stringify(n,null,2)})}Ne.Initializer=On,Ne.Result=In,Ne.Designer=so;function En(e){const{getCollectionFields:t}=a.useCollectionManager_deprecated(),{path:o}=Y.useField(),n=o.segments[o.segments.length-1],{values:s}=Y.useForm(),[l,i]=a.parseCollectionName(s==null?void 0:s.collection),c=t(i,l),{type:d}=c.find(h=>h.name===n),u=Array.isArray(e.value)?e.value.join(","):e.value;function m(h){const C=h.target.value.trim();e.onChange(["belongsTo","hasOne"].includes(d)?C:C.split(/[,\s]+/))}return r.jsx(b.Input,D(k({},e),{value:u,onChange:m}))}const Dt=Y.observer(({value:e,disabled:t,onChange:o,filter:n})=>{const{token:s}=a.useToken(),{t:l}=ee.useTranslation(),i=a.useCompile(),c=Y.useForm(),{getCollectionFields:d}=a.useCollectionManager_deprecated(),u=he(),{values:m}=c,[h,C]=a.parseCollectionName(m==null?void 0:m.collection),y=d(C,h).filter(v=>v.uiSchema),g=n?y.filter(n.bind(m)):y,O=p.useMemo(()=>g.filter(v=>!e||!(v.name in e)),[g,e]),x=t||c.disabled,M=p.useMemo(()=>({onClick:({key:v})=>{o(D(k({},e),{[v]:null}))},style:{maxHeight:300,overflowY:"auto"},items:O.map(v=>{var T,I;return{key:v.name,label:i((I=(T=v.uiSchema)==null?void 0:T.title)!=null?I:v.name)}})}),[o,O,e]);return r.jsx("fieldset",{className:a.css`
          margin-top: 0.5em;

          > .ant-formily-item {
            flex-direction: column;

            > .ant-formily-item-label {
              line-height: 32px;
            }
          }
        `,children:g.length?r.jsxs(a.CollectionProvider_deprecated,{name:C,dataSource:h,children:[g.filter(v=>e&&v.name in e).map(v=>{var I,N;const T=["belongsTo","hasOne","hasMany","belongsToMany"].includes(v.type)?En:a.CollectionField;return r.jsxs(b.Form.Item,{label:i((N=(I=v.uiSchema)==null?void 0:I.title)!=null?N:v.name),labelAlign:"left",className:a.css`
                      .ant-form-item-control-input-content {
                        display: flex;
                      }
                    `,children:[r.jsx(a.Variable.Input,{scope:u,value:e[v.name],changeOnSelect:!0,onChange:F=>{o(D(k({},e),{[v.name]:F}))},children:r.jsx(a.SchemaComponent,{schema:{type:"void",properties:{[v.name]:{"x-component":T,"x-validator"(){return""}}}}})}),x?null:r.jsx(b.Button,{"aria-label":"icon-close",type:"link",icon:r.jsx(P.CloseCircleOutlined,{}),onClick:()=>{var V;const j=e,{[V=v.name]:F}=j,E=R(j,[rn(V)]);o(E)}})]},v.name)}),O.length?r.jsx(b.Dropdown,{menu:M,children:r.jsx(b.Button,{icon:r.jsx(P.PlusOutlined,{}),children:l("Add field")})}):null]}):r.jsx("p",{style:{color:s.colorText},children:A("Please select collection first")})})},{displayName:"CollectionFieldSet"}),Fn=a.createStyles(({token:e,css:t})=>({container:t`
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: 400px;

    .ant-tree .ant-tree-node-content-wrapper.ant-tree-node-selected {
      background-color: ${e.xwColorPrimaryHighlight};
      color: #fff;
    }

    .ant-tree-node-content-wrapper {
      margin-top: 4px;
    }

    .ant-tree-treenode {
      padding-bottom: 0;
    }

    .ant-tree-switcher-noop {
      position: relative;

      &:has(~ .ant-tree-node-content-wrapper span > div[data-branch-child-node]) {
        &::after {
          content: '';
          position: absolute;
          left: 50%;
          top: 0;
          height: 100%;
          width: 1px;
          background-color: #f0f0f0;
          transform-origin: center top;
        }
      }
    }
  `,searchInput:t`
    margin-bottom: ${e.marginSM}px;

    .ant-input {
      font-size: ${e.fontSize}px;
      border-radius: ${e.borderRadius}px;
    }
  `,nodeContainer:t`
    display: flex;
    align-items: center;
    padding: 4px 0;
  `,nodeTag:t`
    background-color: #f8f9fa;
    border: 1px solid #e5e6eb;
    padding: 1px 10px;
    font-weight: 500;
    margin: 0;
    margin-right: 8px;
  `,nodeTitle:t`
    font-weight: 500;
    display: flex;
    align-items: center;

    p {
      font-size: 14px;
      margin: 0;
      padding: 0;
      // white-space: nowrap;
      max-width: 100%;
      display: inline-block;
    }
  `,highlightText:t`
    background-color: ${e.xwColorPrimaryLight};
    padding: 0;
  `}));var Q=(e=>(e.Condition="condition",e.Parallel="parallel",e.Branch="branch",e.Yes="yes",e.No="no",e.Loop="loop",e))(Q||{});const Mt=["yes","no","branch"],ao=e=>e.reduce((t,o)=>(t.push(o),o.children&&t.push(...ao(o.children)),t),[]),Nt=e=>e.reduce((t,o)=>(t.push(o.key),o.children&&t.push(...Nt(o.children)),t),[]),Dn=e=>{const t=[],o=new Set,n=s=>{!s||o.has(s.id)||(o.add(s.id),s.upstream&&(t.push(s.upstream),n(s.upstream)))};return n(e),t};function $t(e,t){const o=new Map,n=new Map,s=new Set,l=new Map,i={yes:-1,no:-2,branch:x=>-3-x},c=x=>{if(s.has(x.id))return null;s.add(x.id);const M=D(k({},x),{title:x.title||`Node ${x.id}`,disabled:t==null?void 0:t.includes(x.type),selectable:!(t!=null&&t.includes(x.type))}),v=n.get(x.id)||[];if(x.type===Q.Parallel){const I=v.reduce((N,F)=>{var V;const E=(V=F.branchIndex)!=null?V:0;return N[E]=N[E]||[],N[E].push(F),N},{});return M.children=Object.entries(I).map(([N,F])=>{const E=parseInt(N),V=`branch-${E}`,j={title:`Branch ${E+1}`,key:V,type:Q.Branch,id:i.branch(E),selectable:!(t!=null&&t.includes(Q.Branch)),disabled:t==null?void 0:t.includes(Q.Branch),children:[]},L=d(F);return L.length&&(j.children=L.map(_=>D(k({},_),{isBranchChild:!0}))),j}),M}if(x.type===Q.Condition){const I=v.filter(F=>F.branchIndex===1),N=v.filter(F=>F.branchIndex===0);if(M.children=[],I.length){const F={title:A("Yes"),key:`yes-${x.key}`,type:Q.Yes,id:i.yes,selectable:!(t!=null&&t.includes(Q.Yes)),disabled:t==null?void 0:t.includes(Q.Yes),children:[]},E=d(I);E.length&&(F.children=E.map(V=>D(k({},V),{isBranchChild:!0})),console.log("children",v),M.children.push(F))}if(N.length){const F={title:A("No"),type:Q.No,key:`no-${x.key}`,id:i.no,selectable:!(t!=null&&t.includes(Q.No)),disabled:t==null?void 0:t.includes(Q.No),children:[]},E=d(N);E.length&&(F.children=E.map(V=>D(k({},V),{isBranchChild:!0})),M.children.push(F))}return M}if(x.type===Q.Loop){const I=v.filter(()=>x.type===Q.Loop);return M.children=I.map(N=>c(N)).filter(Boolean),M}const T=v.filter(I=>I.branchIndex==null);return M.children=T.map(I=>c(I)).filter(Boolean),M},d=x=>{if(!x.length)return[];const M=[],v=new Set,T=I=>{var N;return D(k({},I),{isBranchChild:!0,children:(N=I.children)==null?void 0:N.map(T)})};for(const I of x){if(v.has(I.id))continue;let N=I;const F=N.branchIndex;for(;N&&!v.has(N.id);){if(v.add(N.id),[Q.Condition,Q.Parallel].includes(N.type)){const V=c(N);V&&M.push(T(V));break}else{const V=D(k({},N),{isBranchChild:!0}),j=n.get(N.id)||[];j.length&&(V.children=j.map(L=>c(L)).filter(Boolean).map(T)),M.push(V)}const E=l.get(N.id);if(E&&!v.has(E.id)&&(E.branchIndex===null||E.branchIndex===F))N=E;else break}}return M.map(T)},u=x=>x!=null&&x.upstream?m.includes(x.upstream.id)||u(x.upstream):!1;e.forEach(x=>{if(o.set(x.id,x),x.upstreamId&&x.branchIndex!==null){const M=n.get(x.upstreamId)||[];M.push(x),n.set(x.upstreamId,M)}x.downstreamId&&l.set(x.id,o.get(x.downstreamId)||e.find(M=>M.id===x.downstreamId))});const m=Array.from(n.values()).flat().map(({id:x})=>x),h=e.find(x=>!x.upstreamId),y=h?(x=>{const M=[];let v=x;const T=new Set;for(;v&&!T.has(v.id);)T.add(v.id),M.push(v.id),v=o.get(v.downstreamId);return M})(h):[],g=(x,M)=>{const v=y.indexOf(x.id),T=y.indexOf(M.id);return v===-1&&T===-1?0:v===-1?1:T===-1?-1:v-T};return e.filter(x=>x.branchIndex===null&&!m.includes(x.id)&&!u(x)).sort(g).map(x=>c(x)).filter(Boolean)}const Pt=c=>{var d=c,{nodes:e,disabledKeys:t,disabledNodes:o,enableSearch:n=!0,searchValue:s,onSearch:l}=d,i=R(d,["nodes","disabledKeys","disabledNodes","enableSearch","searchValue","onSearch"]);const{styles:u}=Fn(),[m,h]=p.useState(""),C=a.usePlugin(de),y=a.useCompile(),g=s!=null?s:m;p.useEffect(()=>{s&&h(s)},[s]);const O=T=>{h(T),l==null||l(T)},x=p.useMemo(()=>{if(!g)return $t(e,o);const T=new Map(e.map(E=>[E.id,E])),I=new Set;e.forEach(E=>{var V;(V=E==null?void 0:E.title)!=null&&V.includes(g)&&I.add(E.id)});const N=(E,V)=>{const j=new Set;let L=E;for(;L;){const _=T.get(L);if(!_||(j.add(L),L=V==="up"?_.upstreamId:_.downstreamId,j.has(L)))break}return j},F=new Set;return I.forEach(E=>{const V=N(E,"up"),j=N(E,"down");[E,...V,...j].forEach(L=>F.add(L))}),$t(e.filter(E=>F.has(E.id)),o)},[e,g]),M=p.useMemo(()=>{const T=I=>I.map(N=>D(k({},N),{disabled:(t||[]).includes(N.key)||N.disabled,children:N.children?T(N.children):void 0}));return T(x)},[x,t]),v=T=>{const I=C.instructions.get(T.type),N=T.title||"",F=N.indexOf(g);return r.jsxs("div",{className:u.nodeContainer,"data-branch-child-node":T.isBranchChild,children:[Mt.includes(T.type)&&r.jsx(P.BranchesOutlined,{style:{marginRight:4,fontSize:20}}),T.type&&r.jsx(b.Tag,{className:u.nodeTag,style:{marginLeft:T.isBranchChild?12:0},children:y(I==null?void 0:I.title)||A(T.type)}),!Mt.includes(T.type)&&r.jsx("div",{className:u.nodeTitle,children:F>-1?r.jsxs("p",{children:[N.substring(0,F),r.jsx("span",{className:u.highlightText,children:N.substr(F,g.length)}),N.substring(F+g.length)]}):r.jsx("p",{children:N})})]})};return r.jsxs("div",{className:u.container,children:[!M.length&&r.jsx(a.Empty,{}),n&&r.jsx("div",{children:r.jsx(b.Input.Search,{placeholder:A("Search"),value:g,onChange:T=>O(T.target.value),className:u.searchInput,allowClear:!0,"aria-label":"Search workflow nodes"})}),r.jsx("div",{children:r.jsx(b.Tree,k({showLine:!1,defaultExpandAll:!0,treeData:M,titleRender:v,virtual:!1,blockNode:!0},i))})]})};function lo(e){var y;const{upstream:t,branchIndex:o=null}=e,n=a.usePlugin(de),s=a.useCompile(),{workflow:l}=(y=X())!=null?y:{},i=Array.from(n.instructions.getValues()),{styles:c}=ie(),{onCreate:d,creating:u}=Re(),m=n.useInstructionGroupOptions(),h=p.useMemo(()=>m.map(g=>{const O=i.filter(x=>x.group===g.key&&(x.isAvailable?x.isAvailable({engine:n,workflow:l,upstream:t,branchIndex:o}):!0));return D(k({},g),{type:"group",children:O.map(x=>({role:"button","aria-label":x.type,key:x.type,label:s(x.title),icon:x.icon}))})}).filter(g=>g.children.length),[o,s,n,m,i,t,l]),C=p.useCallback(O=>q(this,[O],function*({keyPath:g}){const[x]=g;d({type:x,upstream:t,branchIndex:o})}),[o,d,t]);return l?r.jsx("div",{className:a.cx(c.addButtonClass,"workflow-add-node-button"),children:r.jsx(b.Dropdown,{menu:{items:h,onClick:C},disabled:l.executed,overlayClassName:a.css`
          .ant-dropdown-menu-root {
            max-height: 30em;
            overflow-y: auto;
          }
          .ant-dropdown-menu-item-group-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
          }
        `,children:r.jsx(b.Button,{"aria-label":e["aria-label"]||"add-button",shape:"circle",icon:r.jsx(P.PlusOutlined,{}),loading:(u==null?void 0:u.upstreamId)==(t==null?void 0:t.id)&&(u==null?void 0:u.branchIndex)===o,size:"small"})})}):null}function Mn(){const e=Y.useForm(),t=a.useAPIClient(),{workflow:o,refresh:n}=X(),{presetting:s,setPresetting:l,setCreating:i}=Re(),c=a.useActionContext();return{run(){return q(this,null,function*(){if(s){yield e.submit(),i(s.data);try{const{data:{data:u}}=yield t.resource("workflows.nodes",o.id).create({values:D(k({},s.data),{config:k(k({},s.data.config),e.values.config)})});typeof e.values.downstreamBranchIndex=="number"&&u.downstreamId&&(yield t.resource("flow_nodes").update({filterByTk:u.downstreamId,values:{branchIndex:e.values.downstreamBranchIndex,upstream:{id:u.id,downstreamId:null}},updateAssociationValues:["upstream"]})),c.setVisible(!1),l(null),n()}catch(u){console.error(u)}finally{i(null)}}})}}}const io=p.createContext(null);function Re(){return p.useContext(io)}const Nn=[{label:`{{t('After end of branches', { ns: "${f}" })}}`,value:!1},{label:`{{t('Inside of branch', { ns: "${f}" })}}`,value:0}],$n=Y.observer(e=>{var i,c;const{presetting:t}=Re(),{nodes:o}=X(),{values:n}=Y.useForm(),s=p.useMemo(()=>{var C;if(!(t!=null&&t.instruction))return[];const{instruction:d,data:u}=t;if(!(u.upstreamId?o.find(y=>y.upstreamId===u.upstreamId&&y.branchIndex===u.branchIndex):o.find(y=>y.upstreamId===null)))return[];const h=typeof d.branching=="function"?d.branching((C=n.config)!=null?C:{}):d.branching;return h?h===!0?Nn:h:[]},[t,o,n.config]);if(!s.length)return null;const{data:l}=t;return r.jsx(a.SchemaComponent,{components:{RadioWithTooltip:Me},schema:{name:`${(i=l.type)!=null?i:"unknown"}-${(c=l.upstreamId)!=null?c:"root"}-${l.branchIndex}`,type:"void",properties:{downstreamBranchIndex:{type:"number",title:A("Move all downstream nodes to",{ns:f}),"x-decorator":"FormItem","x-component":"RadioWithTooltip","x-component-props":{options:s,direction:"vertical"},default:!1,required:!0}}}})});function Pn(){const{presetting:e}=Re();return e!=null&&e.instruction.presetFieldset?r.jsx(a.SchemaComponent,{schema:{type:"void",properties:{config:{type:"object",properties:e.instruction.presetFieldset}}}}):null}function Bn(e){var M;const t=a.useAPIClient(),o=a.useCompile(),n=a.usePlugin(de),[s,l]=p.useState(null),[i,c]=p.useState(null),[d,u]=p.useState(!1),{workflow:m,nodes:h,refresh:C}=(M=X())!=null?M:{},y=p.useMemo(()=>ge.createForm(),[]),g=p.useCallback(v=>{v||(y.reset(),y.clearFormGraph("*"),c(null))},[y]),O=p.useCallback(v=>q(this,null,function*(){l(v);try{yield t.resource("workflows.nodes",m.id).create({values:v}),C()}catch(T){console.error(T)}finally{l(null)}}),[t,C,m.id]),x=p.useCallback(({type:v,upstream:T,branchIndex:I})=>{var V,j,L;const N=n.instructions.get(v);if(!N){console.error(`Instruction "${v}" not found`);return}const F={key:z.uid(),type:v,upstreamId:(V=T==null?void 0:T.id)!=null?V:null,branchIndex:I,title:o(N.title),config:(L=(j=N.createDefaultConfig)==null?void 0:j.call(N))!=null?L:{}},E=T!=null&&T.id?h.find(_=>_.upstreamId===F.upstreamId&&_.branchIndex===F.branchIndex):h.find(_=>_.upstreamId===null);if(N.presetFieldset||(typeof N.branching=="function"?N.branching(F.config):N.branching)&&E){c({data:F,instruction:N});return}O(F)},[o,O,n.instructions]);return r.jsxs(io.Provider,{value:{presetting:i,setPresetting:c,onCreate:x,creating:s,setCreating:l},children:[e.children,r.jsx(a.ActionContextProvider,{value:{visible:!!i,setVisible:g,formValueChanged:d,setFormValueChanged:u,openSize:"small"},children:r.jsx(a.SchemaComponent,{components:{DownstreamBranchIndex:$n,PresetFieldset:Pn},scope:{useCancelAction:a.useCancelAction,useAddNodeSubmitAction:Mn},schema:{name:"modal",type:"void","x-decorator":"FormV2","x-decorator-props":{form:y},"x-component":"Action.Modal",title:`{{ t("Add node", { ns: "${f}" }) }}`,properties:{config:{type:"void","x-component":"PresetFieldset"},downstreamBranchIndex:{type:"void","x-component":"DownstreamBranchIndex"},footer:{"x-component":"Action.Modal.Footer",properties:{actions:{type:"void","x-component":"ActionBar",properties:{cancel:{type:"void",title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ useCancelAction }}"}},submit:{type:"void",title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",htmlType:"submit",useAction:"{{ useAddNodeSubmitAction }}"}}}}}}}}})})]})}function et({from:e=null,entry:t=null,branchIndex:o=null,controller:n=null,className:s,end:l}){const{styles:i}=ie(),{getAriaLabel:c}=kt(e,o),d=[];for(let u=t;u;u=u.downstream)d.push(u);return r.jsxs("div",{className:a.cx("workflow-branch",i.branchClass,s),children:[r.jsx("div",{className:"workflow-branch-lines"}),n,r.jsx(lo,{"aria-label":c(),upstream:e,branchIndex:o}),r.jsx("div",{className:"workflow-node-list",children:d.map(u=>r.jsx(qt,{data:u},u.id))}),l?r.jsx("div",{className:"end-sign",children:r.jsx(P.CloseOutlined,{})}):null]})}function Vn(){var l;const e=Y.useForm(),t=a.useAPIClient(),{workflow:o}=(l=X())!=null?l:{},n=a.useActionContext(),{refresh:s}=a.useResourceActionContext();return{run(){return q(this,null,function*(){if(o.executed){b.message.error(A("Trigger in executed workflow cannot be modified"));return}yield e.submit(),yield t.resource("workflows").update({filterByTk:o.id,values:{config:e.values}}),n.setFormValueChanged(!1),n.setVisible(!1),s()})}}}class Bt{constructor(){S(this,"sync");S(this,"title");S(this,"description");S(this,"fieldset");S(this,"view");S(this,"scope");S(this,"components");S(this,"initializers");S(this,"isActionTriggerable")}}function Ln(){const e=a.useCompile(),{workflow:t,execution:o}=X(),{styles:n}=ie(),s=Vt();return o?r.jsx(a.SchemaComponent,{schema:{type:"void",name:"execution","x-component":"Action","x-component-props":{title:r.jsx(P.InfoOutlined,{}),shape:"circle",size:"small",className:n.nodeJobButtonClass,type:"primary"},properties:{[o.id]:{type:"void","x-decorator":"Form","x-decorator-props":{initialValue:o},"x-component":"Action.Modal",title:r.jsxs("div",{className:a.cx(n.nodeTitleClass),children:[r.jsx(b.Tag,{children:e(s.title)}),r.jsx("strong",{children:t.title}),r.jsxs("span",{className:"workflow-node-id",children:["#",o.id]})]}),properties:{createdAt:{type:"string",title:`{{t("Triggered at", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"DatePicker","x-component-props":{showTime:!0},"x-read-pretty":!0},context:{type:"object",title:`{{t("Trigger variables", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"Input.JSON","x-component-props":{className:a.css`
                    padding: 1em;
                    background-color: #eee;
                  `},"x-read-pretty":!0}}}}}}):null}function jn(){return{form:Y.useForm()}}const Wn=()=>{const e=a.useAPIClient(),{workflow:t,refresh:o}=X(),[n,s]=p.useState(""),[l,i]=p.useState(!1),[c,d]=p.useState(!1),{styles:u}=ie(),m=a.useCompile(),h=Vt(),C=m(h.title),{fieldset:y,scope:g,components:O}=h,x=t.executed?'{{t("View")}}':'{{t("Configure")}}',M=A("Trigger");p.useEffect(()=>{var F,E;t&&s((E=(F=t.triggerTitle)!=null?F:t.title)!=null?E:C)},[t]);const v=p.useMemo(()=>{const F=Oe.cloneDeep(t.config);return ge.createForm({initialValues:F,disabled:t.executed})},[t]),T=p.useCallback(F=>{i(F),F||v.reset()},[v]),I=p.useCallback(function(F){return q(this,null,function*(){const E=F||C;s(E),E!==t.triggerTitle&&(yield e.resource("workflows").update({filterByTk:t.id,values:{triggerTitle:E}}),o())})},[t]),N=p.useCallback(function(F){var V;if(F.target===F.currentTarget){i(!0);return}const E=new Set(["workflow-node-meta","workflow-node-config-button","ant-input-disabled"]);for(let j=F.target;j&&j!==F.currentTarget;j=j.parentNode)if(Array.from((V=j.classList)!=null?V:[]).some(L=>E.has(L))){i(!0),F.stopPropagation();return}},[]);return r.jsxs("div",{role:"button","aria-label":`${M}-${n}`,className:a.cx(u.nodeCardClass),onClick:N,children:[r.jsx("div",{className:a.cx(u.nodeMetaClass,"workflow-node-meta"),children:r.jsxs(b.Tag,{color:"gold",children:[r.jsx(P.ThunderboltOutlined,{}),r.jsx("span",{className:"type",children:m(h.title)})]})}),r.jsx("div",{children:r.jsx(b.Input.TextArea,{value:n,onChange:F=>s(F.target.value),onBlur:F=>I(F.target.value),autoSize:!0,disabled:t.executed})}),r.jsx(Ln,{}),r.jsx(a.ActionContextProvider,{value:{visible:l,setVisible:T,formValueChanged:c,setFormValueChanged:d},children:r.jsx(a.FormProvider,{form:v,children:r.jsx(a.SchemaComponent,{scope:D(k({},g),{useFormProviderProps:jn}),components:O,schema:{name:`workflow-trigger-${t.id}`,type:"void",properties:{config:{type:"void","x-content":x,"x-component":b.Button,"x-component-props":{type:"link",className:"workflow-node-config-button"}},drawer:{type:"void",title:M,"x-component":"Action.Drawer","x-decorator":"FormV2","x-use-decorator-props":"useFormProviderProps",properties:D(k({},h.description?{description:{type:"void","x-component":Yt,"x-component-props":{label:A("Trigger type"),title:h.title,icon:r.jsx(P.ThunderboltOutlined,{}),description:h.description}}}:{}),{fieldset:{type:"void","x-component":"fieldset","x-component-props":{className:a.css`
                          .ant-select.auto-width {
                            width: auto;
                            min-width: 6em;
                          }
                        `},properties:y},actions:k({},t.executed?{}:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:Vn}}}})})}}}})})})]})};function Vt(){const e=a.usePlugin(de),{workflow:t}=X();return e.triggers.get(t.type)}function co({entry:e}){const{styles:t}=ie(),{workflow:o}=X(),[n,s]=p.useState(100);return r.jsxs("div",{className:"workflow-canvas-wrapper",children:[r.jsx(Bn,{children:r.jsxs("div",{className:"workflow-canvas",style:{zoom:n/100},children:[r.jsx("div",{id:"svg-wrapper",style:{position:"relative",alignSelf:"flex-start"}}),r.jsx("div",{className:a.cx(t.branchBlockClass,a.css`
                margin-top: 0 !important;
              `),children:r.jsxs("div",{className:t.branchClass,children:[o!=null&&o.executed?r.jsx(b.Alert,{type:"warning",message:A("Executed workflow cannot be modified. Could be copied to a new version to modify."),showIcon:!0,className:a.css`
                    margin-bottom: 1em;
                  `}):null,r.jsx(Wn,{}),r.jsx("div",{className:a.cx(t.branchBlockClass,a.css`
                    margin-top: 0 !important;
                  `),children:r.jsx(gt.Provider,{value:{zoom:n},children:r.jsx(et,{entry:e})})}),r.jsx("div",{className:t.terminalClass,children:A("End")})]})})]})}),r.jsx("div",{className:"workflow-canvas-zoomer",children:r.jsx(b.Slider,{vertical:!0,reverse:!0,defaultValue:100,step:10,min:10,value:n,onChange:s})})]})}function zn(e,t=[]){const o=new Map;e.forEach(n=>{n.jobs=[],o.set(n.id,n)}),t.forEach(n=>{const s=o.get(n.nodeId);s.jobs.push(n),n.node={id:s.id,key:s.key,title:s.title,type:s.type}}),e.forEach(n=>{n.jobs=n.jobs.sort((s,l)=>s.id-l.id)})}function _n(){const{instructions:e}=a.usePlugin(de),t=a.useCompile(),{viewJob:o,setViewJob:n}=X(),{styles:s}=ie(),{node:l={}}=o!=null?o:{},i=e.get(l.type);return r.jsx(a.ActionContextProvider,{value:{visible:!!o,setVisible:n},children:r.jsx(a.SchemaComponent,{schema:{type:"void",properties:{[`${o==null?void 0:o.id}-${o==null?void 0:o.updatedAt}-modal`]:{type:"void","x-decorator":"Form","x-decorator-props":{initialValue:o},"x-component":"Action.Modal",title:r.jsxs("div",{className:s.nodeTitleClass,children:[r.jsx(b.Tag,{children:t(i==null?void 0:i.title)}),r.jsx("strong",{children:l.title}),r.jsxs("span",{className:"workflow-node-id",children:["#",l.id]})]}),properties:{status:{type:"number",title:`{{t("Status", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"Select",enum:Ct,"x-read-pretty":!0},updatedAt:{type:"string",title:`{{t("Executed at", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"DatePicker","x-component-props":{showTime:!0},"x-read-pretty":!0},result:{type:"object",title:`{{t("Node result", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"Input.JSON","x-component-props":{className:s.nodeJobResultClass},"x-read-pretty":!0}}}}}})})}function Hn(){const{execution:e}=X(),t=a.useAPIClient(),o=ue.useNavigate(),{styles:n}=ie(),[s,l]=p.useState([]),[i,c]=p.useState([]),d=p.useContext(z.isMultiAppPageContext);p.useEffect(()=>{e&&t.resource("executions").list({filter:{key:e.key,id:{$lt:e.id}},sort:"-createdAt",pageSize:10,fields:["id","status","createdAt"]}).then(({data:m})=>{l(m.data)}).catch(()=>{})},[e]),p.useEffect(()=>{e&&t.resource("executions").list({filter:{key:e.key,id:{$gt:e.id}},sort:"createdAt",pageSize:10,fields:["id","status","createdAt"]}).then(({data:m})=>{c(m.data.reverse())}).catch(()=>{})},[e]);const u=p.useCallback(({key:m})=>{m!=e.id&&o(d!=null&&d.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowExecutionsPath(m,d==null?void 0:d.APPNAME):Ke(m))},[e]);return e?r.jsx(b.Dropdown,{menu:{onClick:u,defaultSelectedKeys:[`${e.id}`],className:a.cx(n.dropdownClass,n.executionsDropdownRowClass),items:[...i,e,...s].map(m=>({key:m.id,label:r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"id",children:`#${m.id}`}),r.jsx("time",{children:z.str2moment(m.createdAt).format("YYYY-MM-DD HH:mm:ss")})]}),icon:r.jsx("span",{children:r.jsx(ze,{statusMap:Je,status:m.status})})}))},children:r.jsxs(b.Space,{children:[r.jsx("strong",{children:`#${e.id}`}),r.jsx(P.DownOutlined,{})]})}):null}function Yn(){var T;const{t:e}=ee.useTranslation(),t=a.useCompile(),{data:o,loading:n,refresh:s}=a.useResourceActionContext(),{setTitle:l}=a.useDocumentTitle(),[i,c]=p.useState(null),d=a.useApp(),u=a.useAPIClient(),m=p.useContext(z.isMultiAppPageContext);p.useEffect(()=>{var V;const{workflow:E}=(V=o==null?void 0:o.data)!=null?V:{};l==null||l(`${E!=null&&E.title?`${E.title} - `:""}${A("Execution history")}`)},[o==null?void 0:o.data]);const h=p.useCallback(()=>{b.Modal.confirm({title:A("Cancel the execution"),icon:r.jsx(P.ExclamationCircleFilled,{}),content:A("Are you sure you want to cancel the execution?"),onOk:()=>{u.resource("executions").cancel({filterByTk:o==null?void 0:o.data.id}).then(()=>{b.message.success(e("Operation succeeded")),s()}).catch(E=>{z.captureException(E.data.error)})}})},[o==null?void 0:o.data]);if(!(o!=null&&o.data))return n?r.jsx(b.Spin,{}):r.jsx(b.Result,{status:"404",title:"Not found"});const I=(T=o==null?void 0:o.data)!=null?T:{},{jobs:C=[],workflow:N={}}=I,F=N,{nodes:y=[],revisions:g=[]}=F,O=R(F,["nodes","revisions"]),x=R(I,["jobs","workflow"]);xt(y),zn(y,C);const M=y.find(E=>!E.upstream),v=Je[x.status];return r.jsxs(je.Provider,{value:{workflow:O.type?O:null,nodes:y,execution:x,viewJob:i,setViewJob:c},children:[r.jsx("div",{className:"workflow-toolbar",children:r.jsx("aside",{children:r.jsxs(b.Space,{size:24,children:[r.jsx(b.Breadcrumb,{items:[{title:r.jsx(ue.Link,{to:m!=null&&m.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowListPath(m==null?void 0:m.APPNAME):d.pluginSettingsManager.getRoutePath("workflow"),children:A("Workflow")})},{title:r.jsx(b.Tooltip,{title:`Key: ${O.key}`,children:r.jsx(ue.Link,{to:m!=null&&m.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowDetailPath(O.id,m==null?void 0:m.APPNAME):ke(O.id),children:O.title})})},{title:r.jsx(Hn,{})}]}),r.jsx(b.Tag,{color:v.color,children:t(v.label)}),x.status?null:r.jsx(b.Tooltip,{title:A("Cancel the execution"),children:r.jsx(b.Button,{type:"link",danger:!0,onClick:h,shape:"circle",size:"small",icon:r.jsx(P.StopOutlined,{})})}),r.jsx("time",{children:z.str2moment(x.updatedAt).format("YYYY-MM-DD HH:mm:ss")})]})})}),r.jsx(co,{entry:M}),r.jsx(_n,{})]})}const uo=()=>{const e=ue.useParams(),{styles:t}=ie();return r.jsx("div",{className:a.cx(t.workflowPageClass),children:r.jsx(a.SchemaComponent,{schema:{type:"void",properties:{[`execution_${e.id}`]:{type:"void","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:{name:"executions",fields:[]},resourceName:"executions",request:{resource:"executions",action:"get",params:{filter:{id:e.id},appends:["jobs","workflow","workflow.nodes"]}}},"x-component":"ExecutionCanvas","x-component-props":{}}}},components:{ExecutionCanvas:Yn}})})},po=()=>{const{t:e}=ee.useTranslation(),{id:t}=a.useRecord(),{setVisible:o}=a.useActionContext(),n=p.useContext(z.isMultiAppPageContext);return r.jsx(ue.Link,{to:n!=null&&n.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowExecutionsPath(t,n==null?void 0:n.APPNAME):Ke(t),onClick:()=>o(!1),children:e("View")})},fo={name:"execution-executions",fields:[{interface:"id",type:"bigInt",name:"id",uiSchema:{type:"number",title:'{{t("ID")}}',"x-component":"Input","x-component-props":{},"x-read-pretty":!0}},{interface:"createdAt",type:"datetime",name:"createdAt",uiSchema:{type:"datetime",title:`{{t("Triggered at", { ns: "${f}" })}}`,"x-component":"DatePicker","x-component-props":{},"x-read-pretty":!0}},{interface:"m2o",type:"belongsTo",name:"workflowId",uiSchema:{type:"number",title:`{{t("Version", { ns: "${f}" })}}`,"x-component"({value:e}){const{setVisible:t}=a.useActionContext(),o=p.useContext(z.isMultiAppPageContext);return r.jsx(ue.Link,{to:o!=null&&o.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowDetailPath(e,o==null?void 0:o.APPNAME):ke(e),onClick:()=>t(!1),children:`#${e}`})}}},{type:"number",name:"status",interface:"select",uiSchema:{title:`{{t("Status", { ns: "${f}" })}}`,type:"string","x-component":"Select","x-decorator":"FormItem",enum:qe}}]},mo={type:"void",name:"executionHistoryDrawer",title:`{{t("Execution history", { ns: "${f}" })}}`,"x-component":"Action.Drawer",properties:{content:{type:"void","x-decorator":"ExecutionResourceProvider","x-decorator-props":{collection:fo,resourceName:"executions",request:{resource:"executions",action:"list",params:{appends:["workflow.id","workflow.title"],pageSize:20,sort:["-createdAt"],filter:{}}}},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',default:{$and:[{id:{$eq:""}}]},"x-action":"filter","x-component":"Filter.Action","x-use-component-props":()=>{var o,n;const e=a.useFilterFieldOptions(fo.fields),t=a.useResourceActionContext();return a.useFilterFieldProps({options:e,params:((n=(o=t.state)==null?void 0:o.params)==null?void 0:n[0])||t.params,service:t})},"x-component-props":{icon:"FilterOutlined"},"x-align":"left"},refresher:{type:"void",title:'{{ t("Refresh") }}',"x-component":"Action","x-use-component-props":"useRefreshActionProps","x-component-props":{icon:"ReloadOutlined"}},clear:{type:"void",title:'{{t("Clear")}}',"x-component":"Action","x-component-props":{useAction(){const{t:e}=ee.useTranslation(),{refresh:t,defaultRequest:o}=a.useResourceActionContext(),{resource:n}=a.useResourceContext(),{setVisible:s}=a.useActionContext();return{run(){return q(this,null,function*(){var i;yield n.destroy({filter:(i=o.params)==null?void 0:i.filter}),b.message.success(e("Operation succeeded")),t(),s(!1)})}}},confirm:{title:`{{t("Clear all executions", { ns: "${f}" })}}`,content:`{{t("Clear executions will not reset executed count, and started executions will not be deleted, are you sure you want to delete them all?", { ns: "${f}" })}}`}}}}},table:{type:"void","x-component":"Table.Void","x-component-props":{rowKey:"id",useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{id:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{id:{type:"number","x-component":"CollectionField","x-read-pretty":!0}}},createdAt:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{createdAt:{type:"datetime","x-component":"CollectionField","x-component-props":{showTime:!0},"x-read-pretty":!0}}},workflowId:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{workflowId:{type:"number","x-component":"CollectionField","x-read-pretty":!0}}},status:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:`{{t("Status", { ns: "${f}" })}}`,properties:{status:{type:"number","x-decorator":"ExecutionStatusColumn","x-component":"CollectionField","x-read-pretty":!0}}},actions:{type:"void",title:'{{ t("Actions") }}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{link:{type:"void","x-component":"ExecutionLink"}}}}}}}}}}};function ho(e){var l;const o=a.useCompile()(e.label),n=p.useCallback(i=>{i.preventDefault(),i.stopPropagation()},[]),{color:s}=(l=Je[e.value])!=null?l:{};return r.jsx(b.Tag,{color:s,onMouseDown:n,closable:e.closable,onClose:e.onClose,children:o})}function Gn(e){const t=a.useCompile();return r.jsxs(r.Fragment,{children:[r.jsx(ho,k({},e)),e.description?r.jsx("span",{children:t(e.description)}):null]})}function Un(t){var e=R(t,[]);const o=e.multiple?"multiple":null;return r.jsx(b.Select,D(k({role:"button","data-testid":`select-${o||"single"}`},e),{mode:o,optionLabelProp:"label",tagRender:ho,children:qe.filter(n=>!!n.value&&n.value!==pe.ABORTED).map(n=>r.jsx(b.Select.Option,D(k({},n),{children:r.jsx(Gn,k({},n))}),n.value))}))}function yo(e){const{t}=ee.useTranslation(),{refresh:o}=a.useResourceActionContext(),{resource:n}=a.useResourceContext(),s=a.useRecord(),l=p.useCallback(()=>{b.Modal.confirm({title:A("Cancel the execution"),icon:r.jsx(P.ExclamationCircleFilled,{}),content:A("Are you sure you want to cancel the execution?"),onOk:()=>{n.cancel({filterByTk:s.id}).then(()=>{b.message.success(t("Operation succeeded")),o()}).catch(i=>{z.captureException(i.data.error)})}})},[s]);return r.jsxs("div",{className:a.css`
        display: flex;
      `,children:[e.children,s.status?null:r.jsx(b.Tooltip,{title:A("Cancel the execution"),children:r.jsx(b.Button,{type:"link",danger:!0,onClick:l,shape:"circle",size:"small",icon:r.jsx(P.StopOutlined,{})})})]})}function go(){const e=a.useResourceActionContext();return{onClick(){return q(this,null,function*(){var o;(o=e==null?void 0:e.refresh)==null||o.call(e)})}}}const Kn=sn.createStyles(({token:e,css:t})=>({container:t`
    display: flex;
    align-items: flex-start;
    width: 100%;
    max-height: 500px;
    overflow: hidden;
  `,panel:t`
    flex: 1;
    height: 500px;
    border: 1px solid ${e.colorBorder};
    border-radius: 8px;
    padding: 12px 24px;
    box-sizing: border-box;
    background-color: #fff;
    overflow: auto;
  `,panelTitle:t`
    color: #000;
    font-size: 16px;
    margin-bottom: 12px;
  `,moveIndicator:t`
    color: #000;
    flex-shrink: 0;
    width: 68px;
    height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
  `,disabledNode:t`
    color: ${e.colorTextDisabled};
    cursor: not-allowed;
    .ant-tag {
      background-color: ${e.colorFillAlter} !important;
      border-color: ${e.colorBorder} !important;
      color: ${e.colorTextDisabled} !important;
    }
  `})),qn=e=>{const{nodes:t,visible:o,onCancel:n}=e,{styles:s}=Kn(),[l]=b.Form.useForm(),[i,c]=p.useState([]),[d,u]=p.useState([]),[m,h]=p.useState(null),[C,y]=p.useState(null),g=p.useMemo(()=>{const T=[Q.Branch,Q.Loop,Q.Yes,Q.No];return C&&T.includes(C.type)},[C]),O=()=>{l.resetFields(),c([]),u([]),y(null)},x=(T,{node:I})=>{h(I),u([]),y(null);const N=Nt(I.children||[]),F=Array.from(new Set([I.key,...N]));c(F),l.resetFields()},M=(T,{node:I})=>{u(T),y(I),l.resetFields()},v=()=>q(this,null,function*(){if(yield l.validateFields(),i.length===0){b.message.error(A("Please select source nodes"));return}if(d.length===0){b.message.error(A("Please select target nodes"));return}});return p.useEffect(()=>{o&&O()},[o]),r.jsxs(b.Modal,{title:A("Move Nodes"),open:o,onCancel:n,maskClosable:!1,keyboard:!1,destroyOnClose:!0,footer:[r.jsx(b.Button,{onClick:n,children:A("dialog cancel")},"cancel"),r.jsx(b.Button,{type:"primary",onClick:v,children:A("Apply")},"apply")],width:"80%",children:[r.jsx(b.Alert,{type:"warning",message:A("Moving nodes warning"),showIcon:!0,style:{marginBottom:16}}),r.jsxs("div",{className:s.container,children:[r.jsxs("div",{className:s.panel,children:[r.jsx("h4",{className:s.panelTitle,children:A("Source node")}),r.jsx(Pt,{nodes:t,disabledNodes:[Q.Yes,Q.No,Q.Branch],selectedKeys:i,multiple:!0,onSelect:x})]}),r.jsx("div",{className:s.moveIndicator,children:r.jsx("p",{children:A("Move to")})}),r.jsxs("div",{className:s.panel,children:[r.jsx("h4",{className:s.panelTitle,children:A("Target node")}),r.jsx(Pt,{nodes:t,selectedKeys:d,disabledKeys:i,multiple:!1,onSelect:M})]})]}),r.jsx(b.Form,{form:l,style:{marginTop:16},children:r.jsx(b.Form.Item,{label:A("Position"),name:"position",rules:[{required:!0,message:A("Please select position")}],children:r.jsxs(b.Radio.Group,{children:[r.jsx(b.Radio,{value:"before",children:A("Before target node")},"before"),r.jsx(b.Radio,{value:"after",children:A("After target node")},"after"),g&&r.jsx(b.Radio,{value:"inside",children:A("Inside target node")},"inside")]})})})]})};function Jn(n){var s=n,{request:e,filter:t={}}=s,o=R(s,["request","filter"]);var c;const{workflow:l}=X(),i=D(k({},o),{request:D(k({},e),{params:D(k({},e==null?void 0:e.params),{filter:D(k({},(c=e==null?void 0:e.params)==null?void 0:c.filter),{key:l.key})})})});return r.jsx(a.ResourceActionProvider,k({},i))}function Zn(){var J;const e=ue.useNavigate(),{t}=ee.useTranslation(),o=a.useApp(),{data:n,refresh:s,loading:l}=a.useResourceActionContext(),{resource:i}=a.useResourceContext(),{setTitle:c}=a.useDocumentTitle(),[d,u]=p.useState(!1),{styles:m}=ie(),{modal:h,message:C}=b.App.useApp(),y=p.useContext(z.isMultiAppPageContext),[g,O]=p.useState({isEffectAll:!1,dialogVisible:!1,isNewVersion:!0}),[x,M]=p.useState(!1);if(p.useEffect(()=>{var W;const{title:$}=(W=n==null?void 0:n.data)!=null?W:{};c==null||c(`${A("Workflow")}${$?`: ${$}`:""}`)},[n==null?void 0:n.data]),p.useEffect(()=>{var W,oe,te;if(!n)return;const $=((W=n==null?void 0:n.data)==null?void 0:W.id)>=((te=(oe=n==null?void 0:n.data)==null?void 0:oe.revisions)==null?void 0:te.filter(se=>se.current)[0].id);O(se=>D(k({},se),{isNewVersion:$}))},[n==null?void 0:n.data]),!(n!=null&&n.data))return l?r.jsx(b.Spin,{}):r.jsx(b.Result,{status:"404",title:"Not found",extra:r.jsx(b.Button,{onClick:()=>e(-1),children:A("Go back")})});const U=(J=n==null?void 0:n.data)!=null?J:{},{nodes:v=[],revisions:T=[]}=U,I=R(U,["nodes","revisions"]);xt(v);const N=v.find($=>!$.upstream);function F({key:$}){$!=I.id&&e(y!=null&&y.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowDetailPath($,y==null?void 0:y.APPNAME):ke($))}function E($){return q(this,null,function*(){if(!$){yield i.update({filterByTk:I.id,values:{enabled:$}}),s();return}O(W=>D(k({},W),{dialogVisible:!0,isEffectAll:!1}))})}const V=$=>{const W=y!=null&&y.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowDetailPath($,y==null?void 0:y.APPNAME):ke($);e(W)},j=()=>q(this,null,function*(){const{data:{data:$}}=yield i.revision({filterByTk:I.id,filter:{key:I.key}});return $});function L(){return q(this,null,function*(){var we;const W=((we=(yield i.get({filterByTk:I.id,appends:["revisions.id","revisions.createdAt","revisions.executed"]})).data)==null?void 0:we.data)||{},oe=W.executed,se=(W.revisions||[]).reduce((ye,Ve)=>Ve?new Date(ye.createdAt)>new Date(Ve.createdAt)?ye:Ve:ye);if(I.id===se.id)if(oe){const ye=yield j();V(ye.id),C.success(A("A new version has been created."))}else C.warning(A("The latest version is already here."));else if(se.executed){const ye=yield j();V(ye.id),C.success(A("A new version has been created."))}else V(se.id),C.success(A("Switched to the latest version."))})}function _(){return q(this,null,function*(){const $=I.current?A("Delete a main version will cause all other revisions to be deleted too."):"";h.confirm({title:t("Are you sure you want to delete it?"),content:$,onOk(){return q(this,null,function*(){var oe;if(yield i.destroy({filterByTk:I.id}),C.success(t("Operation succeeded")),I.current){const te=y!=null&&y.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowListPath(y==null?void 0:y.APPNAME):o.pluginSettingsManager.getRoutePath("workflow");e(te);return}else{const te=(oe=T.find(Be=>Be.current))==null?void 0:oe.id,se=y!=null&&y.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowDetailPath(te,y==null?void 0:y.APPNAME):ke(te);e(se)}})}})})}function Z(W){return q(this,arguments,function*({key:$}){switch($){case"history":u(!0);return;case"revision":return L();case"delete":return _()}})}function B($){O(W=>D(k({},W),{isEffectAll:$.target.value}))}function H(){return q(this,null,function*(){yield i.update({filterByTk:I.id,values:{enabled:!0,effectAll:g.isEffectAll}}),s(),O($=>D(k({},$),{dialogVisible:!1}))})}function G(){O($=>D(k({},$),{dialogVisible:!1}))}const ae=()=>r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{position:"fixed",background:"rgba(0, 0, 0, 0)",zIndex:9,width:"100%",height:"100%",left:0,top:0},onClick:G}),r.jsxs("div",{style:{position:"absolute",top:"40px",background:"#fff",padding:"24px",borderRadius:"6px",zIndex:10,width:"430px",transform:"translate(-80%, 0)"},children:[r.jsx(b.Radio.Group,{onChange:B,value:g.isEffectAll,children:r.jsxs(b.Space,{direction:"vertical",children:[r.jsx(b.Radio,{value:!1,children:A("dialog Effective false")}),r.jsx(b.Radio,{value:!0,children:A("dialog Effective true")})]})}),r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"24px"},children:[r.jsx(b.Button,{style:{width:"30%",marginRight:"20px"},onClick:G,children:A("dialog cancel")}),r.jsx(b.Button,{style:{width:"70%"},type:"primary",onClick:H,children:A("dialog confirm")})]})]})]});return r.jsxs(je.Provider,{value:{workflow:I,nodes:v,refresh:s},children:[r.jsx("div",{className:"workflow-toolbar",children:r.jsxs("aside",{children:[r.jsx(b.Space,{size:24,children:r.jsx(b.Breadcrumb,{items:[{title:r.jsx(ue.Link,{to:y!=null&&y.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowListPath(y==null?void 0:y.APPNAME):o.pluginSettingsManager.getRoutePath("workflow"),children:A("Workflow")})},{title:r.jsx(b.Tooltip,{title:`Key: ${I.key}`,children:r.jsx("strong",{children:I.title})})}]})}),r.jsx("div",{className:"workflow-versions",children:r.jsx(b.Dropdown,{trigger:["click"],menu:{onClick:F,defaultSelectedKeys:[`${I.id}`],className:a.cx(m.dropdownClass,m.workflowVersionDropdownClass),items:T.sort(($,W)=>W.id-$.id).map(($,W)=>({role:"button","aria-label":`version-${W}`,key:`${$.id}`,icon:$.current?r.jsx(P.RightOutlined,{}):null,className:a.cx({executed:$.executed,unexecuted:!$.executed,enabled:$.enabled}),label:r.jsxs(r.Fragment,{children:[r.jsx("strong",{children:`#${$.id}`}),r.jsx("time",{children:z.str2moment($.createdAt).format("YYYY-MM-DD HH:mm:ss")})]})}))},children:r.jsxs(b.Button,{type:"text","aria-label":"version",children:[r.jsx("label",{children:A("Version")}),r.jsx("span",{children:I!=null&&I.id?`#${I.id}`:null}),r.jsx(P.DownOutlined,{})]})})}),g.isNewVersion&&r.jsxs("div",{style:{position:"relative"},children:[r.jsx(b.Switch,{checked:I.enabled,onChange:E,checkedChildren:A("On"),unCheckedChildren:A("Off")}),g.dialogVisible&&r.jsx(ae,{})]}),r.jsx(b.Dropdown,{menu:{items:[{role:"button","aria-label":"history",key:"history",label:A("Execution history"),disabled:!I.allExecuted},{role:"button","aria-label":"revision",key:"revision",label:A("Copy to new version")},{role:"button","aria-label":"delete",key:"delete",label:t("Delete")}],onClick:Z},children:r.jsx(b.Button,{"aria-label":"more",type:"text",icon:r.jsx(P.EllipsisOutlined,{})})}),r.jsx(a.ActionContextProvider,{value:{visible:d,setVisible:u},children:r.jsx(a.SchemaComponent,{schema:mo,components:{ExecutionResourceProvider:Jn,ExecutionLink:po,ExecutionStatusColumn:yo},scope:{useRefreshActionProps:go}})})]})}),r.jsx(co,{entry:N}),r.jsx(qn,{nodes:v,visible:x,onCancel:()=>M(!1)})]})}const bo=e=>{const t=ue.useParams(),{styles:o}=ie();return r.jsx("div",{className:a.cx(o.workflowPageClass),children:r.jsx(a.SchemaComponent,{schema:{type:"void",properties:{[`provider_${t.id}`]:{type:"void","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:{name:"workflows",fields:[]},resourceName:"workflows",request:{resource:"workflows",action:"get",params:{filter:{id:t.id},appends:["nodes","revisions.id","revisions.createdAt","revisions.current","revisions.executed","revisions.enabled"]}}},"x-component":"WorkflowCanvas"}}},components:{WorkflowCanvas:Zn}})})},Qn=n=>{var s=n,{request:e,filter:t={}}=s,o=R(s,["request","filter"]);var c;const l=a.useRecord(),i=D(k({},o),{request:D(k({},e),{params:D(k({},e==null?void 0:e.params),{filter:D(k({},(c=e==null?void 0:e.params)==null?void 0:c.filter),{key:l.key})})})});return r.jsx(a.ResourceActionProvider,k({},i))},Xn=()=>{const{t:e}=ee.useTranslation(),{id:t}=a.useRecord(),{setVisible:o}=a.useActionContext(),{getAriaLabel:n}=a.useGetAriaLabelOfAction("Configure"),{token:s}=a.useToken(),l=p.useContext(z.isMultiAppPageContext);return r.jsx(ue.Link,{"aria-label":n(),to:l!=null&&l.MULTIAPPLICATIONPORT?z.getMultiApplicationWorkflowDetailPath(t,l==null?void 0:l.APPNAME):ke(t),style:{color:s.colorPrimary},onClick:()=>o(!1),children:e("Configure")})};function Rn(n){var s=n,{component:e="div",children:t}=s,o=R(s,["component","children"]);const[l,i]=p.useState(!1),c=Y.useFieldSchema();return r.jsxs(a.ActionContextProvider,{value:{visible:l,setVisible:i,fieldSchema:c},children:[p.createElement(e,D(k({},o),{onClick(){i(!0)}}),t),r.jsx(a.SchemaComponent,{schema:c,onlyRenderProperties:!0})]})}function er({data:e}){const{label:t,color:o,options:n}=e,s=a.useCompile();return r.jsxs(b.Space,{direction:"vertical",children:[r.jsx(b.Tag,{color:o,children:s(t)}),r.jsx(b.Typography.Text,{type:"secondary",style:{whiteSpace:"normal"},children:s(n.description)})]})}const xo={name:"workflows",fields:[{type:"string",name:"title",interface:"input",uiSchema:{title:'{{t("Name")}}',type:"string","x-component":"Input",required:!0}},{type:"string",name:"type",interface:"select",uiSchema:{title:`{{t("Trigger type", { ns: "${f}" })}}`,type:"string","x-decorator":"FormItem","x-component":"Select",enum:"{{useTriggersOptions()}}","x-component-props":{optionRender:er,popupMatchSelectWidth:!0,listHeight:300},required:!0}},{type:"string",name:"description",interface:"textarea",uiSchema:{title:'{{t("Description")}}',type:"string","x-component":"Input.TextArea"}},{type:"boolean",name:"enabled",interface:"radioGroup",uiSchema:{title:`{{t("Status", { ns: "${f}" })}}`,type:"string",enum:[{label:`{{t("On", { ns: "${f}" })}}`,value:!0,color:"#52c41a"},{label:`{{t("Off", { ns: "${f}" })}}`,value:!1}],"x-component":"Radio.Group","x-decorator":"FormItem",default:!1}},{type:"number",name:"allExecuted",interface:"integer",uiSchema:{title:`{{t("Executed", { ns: "${f}" })}}`,type:"number","x-component":"InputNumber","x-decorator":"FormItem"}},{type:"object",name:"options"}]},be={title:{"x-component":"CollectionField","x-decorator":"FormItem"},type:{"x-component":"CollectionField","x-decorator":"FormItem"},sync:{type:"boolean",title:`{{ t("Execute mode", { ns: "${f}" }) }}`,description:`{{ t("Execute workflow asynchronously or synchronously based on trigger type, and could not be changed after created.", { ns: "${f}" }) }}`,"x-decorator":"FormItem","x-component":"SyncOptionSelect","x-component-props":{options:[{label:`{{ t("Asynchronously", { ns: "${f}" }) }}`,value:!1,tooltip:`{{ t("Will be executed in the background as a queued task.", { ns: "${f}" }) }}`},{label:`{{ t("Synchronously", { ns: "${f}" }) }}`,value:!0,tooltip:`{{ t("For user actions that require immediate feedback. Can not use asynchronous nodes in such mode, and it is not recommended to perform time-consuming operations under synchronous mode.", { ns: "${f}" }) }}`}]}},enabled:{"x-component":"CollectionField","x-decorator":"FormItem"},description:{"x-component":"CollectionField","x-decorator":"FormItem"},options:{type:"object","x-component":"fieldset",properties:{deleteExecutionOnStatus:{type:"array",title:`{{ t("Auto delete history when execution is on end status", { ns: "${f}" }) }}`,"x-decorator":"FormItem","x-component":"ExecutionStatusSelect","x-component-props":{multiple:!0}}}}},tr=e=>({type:"void",name:yt.uid(),properties:{provider:{type:"void","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:xo,resourceName:"workflows",request:{resource:"workflows",action:"list",params:{filter:k({current:!0},e),sort:["-createdAt"],except:["config"]}}},"x-component":"CollectionProvider_deprecated","x-component-props":{collection:xo},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',default:{$and:[{title:{$includes:""}}]},"x-action":"filter","x-component":"Filter.Action","x-use-component-props":"cm.useFilterActionProps","x-component-props":{icon:"FilterOutlined"},"x-align":"left"},refresher:{type:"void",title:'{{ t("Refresh") }}',"x-component":"Action","x-use-component-props":"useRefreshActionProps","x-component-props":{icon:"ReloadOutlined"}},sync:{type:"void",title:`{{t("Sync", { ns: "${f}" })}}`,"x-decorator":"Tooltip","x-decorator-props":{title:`{{ t("Sync enabled status of all workflows from database", { ns: "${f}" }) }}`},"x-component":"Action","x-component-props":{icon:"SyncOutlined",useAction(){const{t}=ee.useTranslation(),{resource:o}=a.useResourceContext(),n=a.useResourceActionContext();return{run(){return q(this,null,function*(){yield o.sync(),yield n==null?void 0:n.refresh(),b.message.success(t("Operation succeeded"))})}}}},"x-reactions":["{{useWorkflowSyncAction}}"]},delete:{type:"void",title:'{{t("Delete")}}',"x-component":"Action","x-component-props":{icon:"DeleteOutlined",useAction:"{{ cm.useBulkDestroyAction }}",confirm:{title:"{{t('Delete record')}}",content:"{{t('Are you sure you want to delete it?')}}"}}},create:{type:"void",title:'{{t("Add new")}}',"x-component":"Action","x-component-props":{type:"primary",icon:"PlusOutlined"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{initialValue:{current:!0}},title:'{{t("Add new")}}',properties:{title:be.title,type:be.type,sync:be.sync,description:be.description,options:be.options,footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useCreateAction }}"}}}}}}}}}},table:{type:"void","x-component":"Table.Void","x-component-props":{rowKey:"id",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{title:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{title:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},type:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{type:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},enabled:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{enabled:{type:"boolean","x-component":"CollectionField","x-read-pretty":!0,default:!1}}},allExecuted:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{allExecuted:{type:"number","x-decorator":"OpenDrawer","x-decorator-props":{component:function(o){const n=a.useRecord(),{token:s}=a.useToken();return p.createElement("a",k({"aria-label":`executed-${n.title}`,style:{color:s.colorPrimary}},o))}},"x-component":"CollectionField","x-read-pretty":!0,properties:{drawer:mo}}}},actions:{type:"void",title:'{{ t("Actions") }}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{configure:{type:"void","x-component":"WorkflowLink"},update:{type:"void",title:'{{ t("Edit") }}',"x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:"{{ cm.useValuesFromRecord }}"},title:'{{ t("Edit") }}',properties:{title:be.title,enabled:be.enabled,sync:be.sync,description:be.description,options:be.options,footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{ t("Submit") }}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ cm.useUpdateAction }}"}}}}}}}},revision:{type:"void",title:`{{t("Duplicate", { ns: "${f}" })}}`,"x-component":"Action.Link","x-component-props":{openSize:"small"},properties:{modal:{type:"void",title:`{{t("Duplicate to new workflow", { ns: "${f}" })}}`,"x-decorator":"FormV2","x-component":"Action.Modal",properties:{title:{type:"string",title:'{{t("Title")}}',"x-decorator":"FormItem","x-component":"Input"},footer:{type:"void","x-component":"Action.Modal.Footer",properties:{submit:{type:"void",title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction(){const{t}=ee.useTranslation(),{refresh:o}=a.useResourceActionContext(),{resource:n,targetKey:s}=a.useResourceContext(),{setVisible:l}=a.useActionContext(),{[s]:i}=a.useRecord(),{values:c}=Y.useForm();return{run(){return q(this,null,function*(){yield n.revision({filterByTk:i,values:c}),b.message.success(t("Operation succeeded")),o(),l(!1)})}}}}},cancel:{type:"void",title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}}}}}}}},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action.Link","x-component-props":{confirm:{title:"{{t('Delete record')}}",content:"{{t('Are you sure you want to delete it?')}}"},useAction:"{{ cm.useDestroyActionAndRefreshCM }}"}}}}}}}}}}}});function or(e){const t=Y.useField(),o=a.useRecord(),n=a.usePlugin(de);return Y.useFormEffects(s=>{ge.onFieldChange("type",l=>{let i=o.id||!l.value;if(l.value){const c=n.triggers.get(l.value);c.sync!=null?(i=!0,t.setValue(c.sync)):t.setInitialValue(!1)}t.setPattern(i?"disabled":"editable")})}),p.useEffect(()=>{if(o.id){t.setPattern("disabled");const s=n.triggers.get(o.type);s.sync!=null?t.setValue(s.sync):t.setInitialValue(!1)}},[o.id,t,n.triggers]),r.jsx(Me,k({},e))}function nr(e){const t=a.useApp();e.visible=!!(a.usePlugin("multi-app-share-collection")||t.name!=="main")}function rr(){const e=p.useContext(a.SchemaComponentContext),{useTriggersOptions:t}=a.usePlugin(de),o=p.useContext(z.isMultiAppPageContext),n=tr(o!=null&&o.MULTIAPPLICATIONPORT?{associatedApp:{applicationsRelationShip:{name:{$eq:o==null?void 0:o.APPNAME}}}}:{});return r.jsx(b.Card,{bordered:!1,children:r.jsx(a.SchemaComponentContext.Provider,{value:D(k({},e),{designable:!1}),children:r.jsx(a.SchemaComponent,{schema:n,components:{WorkflowLink:Xn,ExecutionResourceProvider:Qn,ExecutionLink:po,OpenDrawer:Rn,ExecutionStatusSelect:Un,SyncOptionSelect:or,ExecutionStatusColumn:yo,Tooltip:b.Tooltip},scope:{useTriggersOptions:t,useWorkflowSyncAction:nr,useRefreshActionProps:go}})})})}const fe={type:"string",title:'{{t("Collection")}}',required:!0,"x-reactions":[],"x-decorator":"FormItem","x-component":"DataSourceCollectionCascader"},vo={type:"object",title:'{{t("Fields values")}}',description:`{{t("Unassigned fields will be set to default values, and those without default values will be set to null.", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-decorator-props":{labelAlign:"left",className:a.css`
      flex-direction: column;
    `},"x-component":"CollectionFieldset"},tt={type:"object",title:'{{t("Filter")}}',"x-decorator":"FormItem","x-component":"Filter","x-use-component-props":()=>{const{values:e}=Y.useForm(),[t,o]=a.parseCollectionName(e==null?void 0:e.collection);return{options:a.useCollectionFilterOptions(o,t).map(l=>l.interface==="attachment"?D(k({},l),{children:[...l.children,{name:"url",title:'{{t("URL")}}',operators:[{label:'{{t("is")}}',value:"$eq"},{label:'{{t("contains")}}',selected:!0,value:"$includes"},{label:'{{t("does not contain")}}',value:"$notIncludes"},{label:'{{t("is not")}}',value:"$ne"},{label:'{{t("is empty")}}',value:"$empty",noValue:!0},{label:'{{t("is not empty")}}',value:"$notEmpty",noValue:!0}],schema:{type:"string","x-component":"Input"}}]}):l),className:a.css`
        position: relative;
        width: 100%;
      `}},"x-component-props":{dynamicComponent:"FilterDynamicComponent"}},sr={type:"array",title:'{{t("Sort")}}',"x-decorator":"FormItem","x-component":"ArrayItems",items:{type:"object",properties:{space:{type:"void","x-component":"Space",properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},field:{type:"string",enum:"{{useSortableFields()}}",required:!0,"x-decorator":"FormItem","x-component":"Select","x-component-props":{style:{width:260}}},direction:{type:"string","x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{optionType:"button"},enum:[{label:'{{t("ASC")}}',value:"asc"},{label:'{{t("DESC")}}',value:"desc"}]},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:'{{t("Add sort field")}}',"x-component":"ArrayItems.Addition"}}},ar={type:"void",title:'{{t("Pagination")}}',"x-decorator":"SchemaComponentContext.Provider","x-decorator-props":{value:{designable:!1}},"x-component":"Grid",properties:{row:{type:"void","x-component":"Grid.Row",properties:{page:{type:"void","x-component":"Grid.Col",properties:{page:{type:"number",title:'{{t("Page number")}}',"x-decorator":"FormItem","x-component":"WorkflowVariableInput","x-component-props":{useTypedConstant:["number","null"]},default:1}}},pageSize:{type:"void","x-component":"Grid.Col",properties:{pageSize:{type:"number",title:'{{t("Page size")}}',"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{min:1,max:100},default:20}}}}}}},_e={type:"array",title:`{{t("Preload associations", { ns: "${f}" })}}`,description:`{{t("Please select the associated fields that need to be accessed in subsequent nodes. With more than two levels of to-many associations may cause performance issue, please use with caution.", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"AppendsTreeSelect","x-component-props":{title:"Preload associations",multiple:!0,useCollection(){const{values:e}=Y.useForm();return e==null?void 0:e.collection}},"x-reactions":[{dependencies:["collection"],fulfill:{state:{visible:"{{!!$deps[0]}}"}}}]};function lr(e={}){var G;const{skipResetForm:t=!1}=e,o=a.useAPIClient(),n=Y.useForm(),{field:s,__parent:l}=a.useBlockRequestContext(),{setVisible:i}=a.useActionContext(),c=ue.useNavigate(),d=Y.useFieldSchema(),u=Y.useField(),m=a.useCompile(),{modal:h}=b.App.useApp(),C=a.useCollectValuesToSubmit(),{t:y}=ee.useTranslation(),g=u.componentProps.filterKeys||[],{onSuccess:O={},skipValidator:x,triggerWorkflows:M}=(G=d==null?void 0:d["x-action-settings"])!=null?G:{},{successTitle:v,refreshBlockIds:T,refreshWaitingTime:I,redirecting:N,redirectTo:F,keepActionContainer:E=!1}=O,V=O.successMessage||y("Operation succeeded"),j=z.DEVICE_TYPE==="pc",{getDataBlocks:L}=a.useFilterBlock(),_=L(),Z=()=>{N&&F&&(z.isURL(F)?window.location.href=F:c(F))},B=J=>q(this,null,function*(){var U,$;if(I&&(yield z.delay(I)),u.data.loading=!1,u.data.data=J,($=(U=l==null?void 0:l.service)==null?void 0:U.refresh)==null||$.call(U),!E&&(i==null||i(!1)),a.refreshBlockByIds(_,T),j){b.message.success(m(V)),t||(yield n.reset()),Z();return}h.success(D(k({},a.baseModalConfig),{title:m(v),content:m(V),className:a.mobileModalMessageCss,okText:y("Confirm"),onOk:()=>q(this,null,function*(){t||(yield n.reset()),Z()})}))}),H=(J,U=[],$=[])=>{const W=U.map(({message:oe})=>oe).join(`
`);h.confirm({title:y("Confirm"),content:W,okText:y("Continue to Submit"),cancelText:y("Back to Modify"),onOk:()=>q(this,null,function*(){try{const oe=yield o.resource("workflows").trigger(D(k({},J),{triggerWorkflowsFilter:$.join(",")}));B(oe)}catch(oe){u.data.loading=!1}})})};return{onClick(){return q(this,null,function*(){var $;x||(yield n.submit());const J=yield C();u.data=s.data||{},u.data.loading=!0;const U={values:J,filterKeys:g,triggerWorkflows:M!=null&&M.length?M.map(W=>[W.workflowKey,W.context].filter(Boolean).join("!")).join(","):void 0};try{const W=yield o.resource("workflows").trigger(U);B(W)}catch(W){const{data:oe={},messages:te=[]}=(($=W==null?void 0:W.response)==null?void 0:$.data)||{},{needSecondaryConfirmation:se,secondaryConfirmationWorkflows:Be=[]}=oe;se&&H(U,te,Be),u.data.loading=!1}})}}}function ir(){var g;const e=a.useCompile(),t=a.useAPIClient(),o=a.useRecord(),n=Y.useField(),s=Y.useFieldSchema(),{field:l,__parent:i}=a.useBlockRequestContext(),{setVisible:c,setSubmitted:d}=a.useActionContext(),{modal:u}=b.App.useApp(),m=ue.useNavigate(),{onSuccess:h,triggerWorkflows:C}=(g=s==null?void 0:s["x-action-settings"])!=null?g:{},{keepActionContainer:y=!1}=h;return{onClick(x,M){return q(this,null,function*(){n.data=l.data||{},n.data.loading=!0;try{if(yield t.resource("workflows").trigger({values:o,triggerWorkflows:C!=null&&C.length?C.map(v=>[v.workflowKey,v.context].filter(Boolean).join("!")).join(","):void 0}),M&&M(),!y&&(c==null||c(!1)),d==null||d(!0),!(h!=null&&h.successMessage))return;if(h!=null&&h.manualClose){let v;u.success({title:e(h==null?void 0:h.successMessage),onOk(){return q(this,null,function*(){h!=null&&h.redirecting&&(h!=null&&h.redirectTo)&&(z.isURL(h.redirectTo)?window.location.href=h.redirectTo:m(h.redirectTo))})}})}else b.message.success(e(h==null?void 0:h.successMessage))}catch(v){z.captureException(v)}finally{n.data.loading=!1}})}}}function cr(){const{workflow:e}=X();return!!(e!=null&&e.executed)}function wo(){const{workflow:e}=X();return!!(e!=null&&e.allExecuted)}const $e={CREATED:1,UPDATED:2,SAVED:3,DELETED:4},ur=[{label:`{{t("After record added", { ns: "${f}" })}}`,value:$e.CREATED},{label:`{{t("After record updated", { ns: "${f}" })}}`,value:$e.UPDATED},{label:`{{t("After record added or updated", { ns: "${f}" })}}`,value:$e.SAVED},{label:`{{t("After record deleted", { ns: "${f}" })}}`,value:$e.DELETED}];class dr extends Bt{constructor(){super(...arguments);S(this,"title",`{{t("Collection event", { ns: "${f}" })}}`);S(this,"description",`{{t('Triggered when data changes in the collection, such as after adding, updating, or deleting a record. Unlike "Post-action event", Collection event listens for data changes rather than HTTP requests. Unless you understand the exact meaning, it is recommended to use "Post-action event".', { ns: "${f}" })}}`);S(this,"fieldset",{collection:D(k({},fe),{"x-disabled":"{{ useWorkflowAnyExecuted() }}","x-component-props":{dataSourceFilter(o){return o.options.key==="main"||o.options.isDBInstance}},"x-reactions":[...fe["x-reactions"],{target:"changed",effects:["onFieldValueChange"],fulfill:{state:{value:[]}}},{target:"condition",effects:["onFieldValueChange"],fulfill:{state:{value:null}}},{target:"appends",effects:["onFieldValueChange"],fulfill:{state:{value:[]}}}]}),mode:{type:"number",title:`{{t("Trigger on", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"Select","x-component-props":{popupMatchSelectWidth:!1,placeholder:`{{t("Trigger on", { ns: "${f}" })}}`,className:"auto-width"},enum:ur,required:!0,"x-reactions":[{dependencies:["collection"],fulfill:{state:{visible:"{{!!$deps[0]}}"}}}]},changed:{type:"array",title:`{{t("Changed fields", { ns: "${f}" })}}`,description:`{{t("Triggered only if one of the selected fields changes. If unselected, it means that it will be triggered when any field changes. When record is added or deleted, any field is considered to have been changed.", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"FieldsSelect","x-component-props":{mode:"multiple",placeholder:'{{t("Select field")}}',filter(o){return!o.hidden&&(o.uiSchema?!o.uiSchema["x-read-pretty"]:!0)&&!["linkTo","hasOne","hasMany","belongsToMany"].includes(o.type)}},"x-reactions":[{dependencies:["collection","mode"],fulfill:{state:{visible:`{{!!$deps[0] && ($deps[1] & ${$e.UPDATED})}}`}}}]},condition:D(k({},tt),{title:`{{t("Only triggers when match conditions", { ns: "${f}" })}}`,"x-component-props":{},"x-reactions":[{dependencies:["collection"],fulfill:{state:{visible:"{{!!$deps[0]}}"}}}]}),appends:D(k({},_e),{"x-reactions":[..._e["x-reactions"],{dependencies:["mode"],fulfill:{state:{visible:`{{!($deps[0] & ${$e.DELETED})}}`}}}]})});S(this,"scope",{useCollectionDataSource:a.useCollectionDataSource,useWorkflowAnyExecuted:wo});S(this,"components",{FieldsSelect:wt})}useVariables(o,n){var d;const s=a.useCompile(),{getCollectionFields:l}=a.useCollectionManager_deprecated(),i=[{collectionName:o.collection,name:"data",type:"hasOne",target:o.collection,uiSchema:{title:A("Trigger data")}}];return De(D(k({appends:["data",...((d=o.appends)==null?void 0:d.map(u=>`data.${u}`))||[]]},n),{fields:i,compile:s,getCollectionFields:l}))}useInitializers(o){return o.collection?{name:"triggerData",type:"item",key:"triggerData",title:`{{t("Trigger data", { ns: "${f}" })}}`,Component:We,collection:o.collection,dataPath:"$context.data"}:null}}const Ae={STATIC:0,DATE_FIELD:1};function pr(e){return!e.hidden&&(e.uiSchema?e.type==="date":!1)}function Co({value:e,onChange:t}){const o=e!=null?e:{},{t:n}=ee.useTranslation(),[s,l]=p.useState(o.offset?o.offset/Math.abs(o.offset):0);return r.jsxs("fieldset",{className:a.css`
        display: flex;
        gap: 0.5em;
      `,children:[r.jsx(wt,{value:o.field,onChange:i=>t(D(k({},o),{field:i})),filter:pr,placeholder:n("Select field"),className:"auto-width"}),o.field?r.jsx(b.Select,{value:s,onChange:i=>{l(i),t(D(k({},o),{offset:Math.abs(o.offset)*i}))},options:[{value:0,label:A("Exactly at")},{value:-1,label:n("Before")},{value:1,label:n("After")}],className:"auto-width"}):null,s?r.jsxs(r.Fragment,{children:[r.jsx(b.InputNumber,{value:Math.abs(o.offset),onChange:i=>t(D(k({},o),{offset:(i!=null?i:0)*s}))}),r.jsx(b.Select,{value:o.unit||864e5,onChange:i=>t(D(k({},o),{unit:i})),options:[{value:864e5,label:A("Days")},{value:36e5,label:A("Hours")},{value:6e4,label:A("Minutes")},{value:1e3,label:A("Seconds")}],className:"auto-width"})]}):null]})}function fr({value:e,onChange:t}){const{t:o}=bt(),n=e!=null?typeof e=="object"&&!(e instanceof Date)?"field":"date":null;return r.jsxs("fieldset",{className:a.css`
        display: flex;
        gap: 0.5em;
      `,children:[r.jsxs(b.Select,{value:n,onChange:s=>{t(s?s==="field"?{}:new Date:null)},className:"auto-width",children:[r.jsx(b.Select.Option,{value:null,children:o("No end")}),r.jsx(b.Select.Option,{value:"field",children:o("By field")}),r.jsx(b.Select.Option,{value:"date",children:o("By custom date")})]}),n==="field"?r.jsx(Co,{value:e,onChange:t}):null,n==="date"?r.jsx(b.DatePicker,{showTime:!0,value:an(e),onChange:s=>{t(s?s.toDate():null)}}):null]})}var ce=function(){return ce=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var s in t=arguments[o])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},ce.apply(this,arguments)};function ko(e,t){var o={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function"){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(o[n[s]]=e[n[s]])}return o}function ot(e,t,o){if(o||arguments.length===2)for(var n,s=0,l=t.length;s<l;s++)!n&&s in t||(n||(n=Array.prototype.slice.call(t,0,s)),n[s]=t[s]);return e.concat(n||Array.prototype.slice.call(t))}var mr=[{name:"@yearly",value:"0 0 1 1 *"},{name:"@annually",value:"0 0 1 1 *"},{name:"@monthly",value:"0 0 1 * *"},{name:"@weekly",value:"0 0 * * 0"},{name:"@daily",value:"0 0 * * *"},{name:"@midnight",value:"0 0 * * *"},{name:"@hourly",value:"0 * * * *"}],Te=[{type:"minutes",min:0,max:59,total:60},{type:"hours",min:0,max:23,total:24},{type:"month-days",min:1,max:31,total:31},{type:"months",min:1,max:12,total:12,alt:["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"]},{type:"week-days",min:0,max:6,total:7,alt:["SUN","MON","TUE","WED","THU","FRI","SAT"]}],K={everyText:"every",emptyMonths:"every month",emptyMonthDays:"every day of the month",emptyMonthDaysShort:"day of the month",emptyWeekDays:"every day of the week",emptyWeekDaysShort:"day of the week",emptyHours:"every hour",emptyMinutes:"every minute",emptyMinutesForHourPeriod:"every",yearOption:"year",monthOption:"month",weekOption:"week",dayOption:"day",hourOption:"hour",minuteOption:"minute",rebootOption:"reboot",prefixPeriod:"Every",prefixMonths:"in",prefixMonthDays:"on",prefixWeekDays:"on",prefixWeekDaysForMonthAndYearPeriod:"and",prefixHours:"at",prefixMinutes:":",prefixMinutesForHourPeriod:"at",suffixMinutesForHourPeriod:"minute(s)",errorInvalidCron:"Invalid cron expression",clearButtonText:"Clear",weekDays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],altWeekDays:["SUN","MON","TUE","WED","THU","FRI","SAT"],altMonths:["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"]};function So(e,t){for(var o=[],n=e;n<=t;n++)o.push(n);return o}function nt(e){return e.sort(function(t,o){return t-o}),e}function Ao(e){var t=[];return e.forEach(function(o){t.indexOf(o)<0&&t.push(o)}),t}function me(e){return Object.entries(e).filter(function(t){var o=t[0],n=t[1];return o&&n}).map(function(t){return t[0]}).join(" ")}function To(e,t){e&&e({type:"invalid_cron",description:t.errorInvalidCron||K.errorInvalidCron})}function rt(e){var t=parseInt(e,10),o=Number(e);return t===o?o:NaN}function Oo(e,t,o,n,s,l,i,c,d,u,m,h,C,y){o&&o(void 0),t(!1);var g=!1;if(!e){if(n==="always"||l&&n==="for-default-value")return;g=!0}if(!g){if(c&&(c===!0||c.includes(e))){if(e==="@reboot")return void y("reboot");var O=mr.find(function(v){return v.name===e});O&&(e=O.value)}try{var x=function(v){if(typeof v!="string")throw new Error("Invalid cron string");var T=v.replace(/\s+/g," ").trim().split(" ");if(T.length===5)return T.map(function(I,N){return function(F,E){if(F==="*"||F==="*/1")return[];var V=nt(Ao(Do(function(L,_,Z){if(Z){L=L.toUpperCase();for(var B=0;B<Z.length;B++)L=L.replace(Z[B],"".concat(B+_))}return L}(F,E.min,E.alt).split(",").map(function(L){var _,Z=L.split("/");if(Z.length>2)throw new Error('Invalid value "'.concat(F,' for "').concat(E.type,'"'));var B=Z[0],H=Z[1];_=B==="*"?So(E.min,E.max):function(J,U,$){var W=J.split("-");if(W.length===1){var oe=rt(W[0]);if(isNaN(oe))throw new Error('Invalid value "'.concat(U,'" for ').concat($.type));return[oe]}if(W.length===2){var te=rt(W[0]),se=rt(W[1]);if(isNaN(te)||isNaN(se))throw new Error('Invalid value "'.concat(U,'" for ').concat($.type));if(se<te)throw new Error('Max range is less than min range in "'.concat(J,'" for ').concat($.type));return So(te,se)}throw new Error('Invalid value "'.concat(J,'" for ').concat($.type))}(B,F,E);var G=function(J,U){if(J!==void 0){var $=rt(J);if(isNaN($)||$<1)throw new Error('Invalid interval step value "'.concat(J,'" for ').concat(U.type));return $}}(H,E),ae=function(J,U){if(U){var $=J[0];J=J.filter(function(W){return W%U==$%U||W===$})}return J}(_,G);return ae}).flat(),E))),j=Mo(V,E);if(j!==void 0)throw new Error('Value "'.concat(j,'" out of range for ').concat(E.type));return V.length===E.total?[]:V}(I,Te[N])});throw new Error("Invalid cron string format")}(e),M=function(v){return v[3].length>0?"year":v[2].length>0?"month":v[4].length>0?"week":v[1].length>0?"day":v[0].length>0?"hour":"minute"}(x);y(M),d(x[0]),u(x[1]),m(x[2]),h(x[3]),C(x[4])}catch(v){g=!0}}g&&(s.current=e,t(!0),To(o,i))}function Io(e,t,o,n,s,l,i){if(e==="reboot")return"@reboot";var c=function(d,u){return d.map(function(m,h){var C=Te[h];return Eo(Fo(m,C),C,u)})}([e!=="minute"&&l?l:[],e!=="minute"&&e!=="hour"&&s?s:[],e!=="year"&&e!=="month"||!o?[]:o,e==="year"&&t?t:[],e!=="year"&&e!=="month"&&e!=="week"||!n?[]:n],i);return c.join(" ")}function Eo(e,t,o,n,s){var l="";if(function(c,d){return c.length===d.max-d.min+1}(e,t)||e.length===0)l="*";else{var i=function(c){if(c.length>2){var d=c[1]-c[0];if(d>1)return d}}(e);l=i&&function(c,d){for(var u=1;u<c.length;u++){var m=c[u-1];if(c[u]-m!==d)return!1}return!0}(e,i)?function(c,d,u){var m=No(c),h=$o(c),C=c.length===(h-m)/u+1;return!!(m===d.min&&h+u>d.max&&C)}(e,t,i)?"*/".concat(i):"".concat(Pe(No(e),t,o,n,s),"-").concat(Pe($o(e),t,o,n,s),"/").concat(i):function(c){var d=[],u=null;return c.forEach(function(m,h,C){m!==C[h+1]-1?u!==null?(d.push([u,m]),u=null):d.push(m):u===null&&(u=m)}),d}(e).map(function(c){return Array.isArray(c)?"".concat(Pe(c[0],t,o,n,s),"-").concat(Pe(c[1],t,o,n,s)):Pe(c,t,o,n,s)}).join(",")}return l}function Pe(e,t,o,n,s){var l=e.toString(),i=t.type,c=t.alt,d=t.min,u=n&&(n===!0||n.includes(i)),m=s==="24-hour-clock"&&(i==="hours"||i==="minutes");if(o&&i==="week-days"||o&&i==="months"?l=c[e-d]:e<10&&(u||m)&&(l=l.padStart(2,"0")),i==="hours"&&s==="12-hour-clock"){var h=e>=12?"PM":"AM",C=e%12||12;C<10&&u&&(C=C.toString().padStart(2,"0")),l="".concat(C).concat(h)}return l}function Fo(e,t){var o=nt(Ao(Do(e,t)));if(o.length===0)return o;var n=Mo(o,t);if(n!==void 0)throw new Error('Value "'.concat(n,'" out of range for ').concat(t.type));return o}function Do(e,t){return t.type==="week-days"&&(e=e.map(function(o){return o===7?0:o})),e}function Mo(e,t){var o=e[0],n=e[e.length-1];return o<t.min?o:n>t.max?n:void 0}function No(e){return e[0]}function $o(e){return e[e.length-1]}function He(e){var t=e.value,o=e.grid,n=o===void 0||o,s=e.optionsList,l=e.setValue,i=e.locale,c=e.className,d=e.humanizeLabels,u=e.disabled,m=e.readOnly,h=e.leadingZero,C=e.clockFormat,y=e.period,g=e.unit,O=e.periodicityOnDoubleClick,x=e.mode,M=ko(e,["value","grid","optionsList","setValue","locale","className","humanizeLabels","disabled","readOnly","leadingZero","clockFormat","period","unit","periodicityOnDoubleClick","mode"]),v=p.useMemo(function(){if(t&&Array.isArray(t))return t.map(function(B){return B.toString()})},[t]),T=p.useMemo(function(){return s?s.map(function(B,H){return{value:(g.min===0?H:H+1).toString(),label:B}}):ot([],Array(g.total),!0).map(function(B,H){var G=g.min===0?H:H+1;return{value:G.toString(),label:Pe(G,g,d,h,C)}})},[s,h,d,C]),I=JSON.stringify(i),N=p.useCallback(function(B){var H=B.value;if(!t||t[0]!==Number(H))return r.jsx(r.Fragment,{});var G=Eo(Fo(t,g),g,d,h,C),ae=G.match(/^\*\/([0-9]+),?/)||[];return r.jsx("div",{children:ae[1]?"".concat(i.everyText||K.everyText," ").concat(ae[1]):G})},[t,I,d,h,C]),F=p.useCallback(function(B){var H=Array.isArray(B)?nt(B):[B],G=H;t&&(G=x==="single"?[]:ot([],t,!0),H.forEach(function(ae){var J=Number(ae);G=t.some(function(U){return U===J})?G.filter(function(U){return U!==J}):nt(ot(ot([],G,!0),[J],!1))})),G.length===g.total?l([]):l(G)},[l,t]),E=p.useCallback(function(B){if(B!==0&&B!==1){for(var H=g.total+g.min,G=[],ae=g.min;ae<H;ae++)ae%B==0&&G.push(ae);var J=t&&G&&t.length===G.length&&t.every(function($,W){return $===G[W]}),U=G.length===T.length;l(U||J?[]:G)}else l([])},[t,T,l]),V=p.useRef([]),j=p.useCallback(function(B){if(!m){var H=V.current;H.push({time:new Date().getTime(),value:Number(B)});var G=window.setTimeout(function(){O&&H.length>1&&H[H.length-1].time-H[H.length-2].time<300?H[H.length-1].value===H[H.length-2].value?E(Number(B)):F([H[H.length-2].value,H[H.length-1].value]):F(Number(B)),V.current=[]},300);return function(){window.clearTimeout(G)}}},[V,F,E,m,O]),L=p.useCallback(function(){m||l([])},[l,m]),_=p.useMemo(function(){var B;return me(((B={"react-js-cron-select":!0,"react-js-cron-custom-select":!0})["".concat(c,"-select")]=!!c,B))},[c]),Z=p.useMemo(function(){var B;return me(((B={"react-js-cron-select-dropdown":!0})["react-js-cron-select-dropdown-".concat(g.type)]=!0,B["react-js-cron-custom-select-dropdown"]=!0,B["react-js-cron-custom-select-dropdown-".concat(g.type)]=!0,B["react-js-cron-custom-select-dropdown-minutes-large"]=g.type==="minutes"&&y!=="hour"&&y!=="day",B["react-js-cron-custom-select-dropdown-minutes-medium"]=g.type==="minutes"&&(y==="day"||y==="hour"),B["react-js-cron-custom-select-dropdown-hours-twelve-hour-clock"]=g.type==="hours"&&C==="12-hour-clock",B["react-js-cron-custom-select-dropdown-grid"]=!!n,B["".concat(c,"-select-dropdown")]=!!c,B["".concat(c,"-select-dropdown-").concat(g.type)]=!!c,B))},[c,n,C,y]);return r.jsx(b.Select,ce({mode:x!=="single"||O?"multiple":void 0,allowClear:!m,virtual:!1,open:!m&&void 0,value:v,onClear:L,tagRender:N,className:_,popupClassName:Z,options:T,showSearch:!1,showArrow:!m,menuItemSelectedIcon:null,dropdownMatchSelectWidth:!1,onSelect:j,onDeselect:j,disabled:u,dropdownAlign:g.type!=="minutes"&&g.type!=="hours"||y==="day"||y==="hour"?void 0:{points:["tr","br"]},"data-testid":"custom-select-".concat(g.type)},M))}function hr(e){var t=e.value,o=e.setValue,n=e.locale,s=e.className,l=e.disabled,i=e.readOnly,c=e.leadingZero,d=e.clockFormat,u=e.period,m=e.periodicityOnDoubleClick,h=e.mode,C=p.useMemo(function(){var y;return me(((y={"react-js-cron-field":!0,"react-js-cron-hours":!0})["".concat(s,"-field")]=!!s,y["".concat(s,"-hours")]=!!s,y))},[s]);return r.jsxs("div",ce({className:C},{children:[n.prefixHours!==""&&r.jsx("span",{children:n.prefixHours||K.prefixHours}),r.jsx(He,{placeholder:n.emptyHours||K.emptyHours,value:t,unit:Te[1],setValue:o,locale:n,className:s,disabled:l,readOnly:i,leadingZero:c,clockFormat:d,period:u,periodicityOnDoubleClick:m,mode:h})]}))}function yr(e){var t=e.value,o=e.setValue,n=e.locale,s=e.className,l=e.disabled,i=e.readOnly,c=e.leadingZero,d=e.clockFormat,u=e.period,m=e.periodicityOnDoubleClick,h=e.mode,C=p.useMemo(function(){var y;return me(((y={"react-js-cron-field":!0,"react-js-cron-minutes":!0})["".concat(s,"-field")]=!!s,y["".concat(s,"-minutes")]=!!s,y))},[s]);return r.jsxs("div",ce({className:C},{children:[u==="hour"?n.prefixMinutesForHourPeriod!==""&&r.jsx("span",{children:n.prefixMinutesForHourPeriod||K.prefixMinutesForHourPeriod}):n.prefixMinutes!==""&&r.jsx("span",{children:n.prefixMinutes||K.prefixMinutes}),r.jsx(He,{placeholder:u==="hour"?n.emptyMinutesForHourPeriod||K.emptyMinutesForHourPeriod:n.emptyMinutes||K.emptyMinutes,value:t,unit:Te[0],setValue:o,locale:n,className:s,disabled:l,readOnly:i,leadingZero:c,clockFormat:d,period:u,periodicityOnDoubleClick:m,mode:h}),u==="hour"&&n.suffixMinutesForHourPeriod!==""&&r.jsx("span",{children:n.suffixMinutesForHourPeriod||K.suffixMinutesForHourPeriod})]}))}function gr(e){var t=e.value,o=e.setValue,n=e.locale,s=e.className,l=e.weekDays,i=e.disabled,c=e.readOnly,d=e.leadingZero,u=e.period,m=e.periodicityOnDoubleClick,h=e.mode,C=!l||l.length===0,y=p.useMemo(function(){var x;return me(((x={"react-js-cron-field":!0,"react-js-cron-month-days":!0,"react-js-cron-month-days-placeholder":!C})["".concat(s,"-field")]=!!s,x["".concat(s,"-month-days")]=!!s,x))},[s,C]),g=JSON.stringify(n),O=p.useMemo(function(){return C?n.emptyMonthDays||K.emptyMonthDays:n.emptyMonthDaysShort||K.emptyMonthDaysShort},[C,g]);return!c||t&&t.length>0||(!t||t.length===0)&&(!l||l.length===0)?r.jsxs("div",ce({className:y},{children:[n.prefixMonthDays!==""&&r.jsx("span",{children:n.prefixMonthDays||K.prefixMonthDays}),r.jsx(He,{placeholder:O,value:t,setValue:o,unit:Te[2],locale:n,className:s,disabled:i,readOnly:c,leadingZero:d,period:u,periodicityOnDoubleClick:m,mode:h})]})):null}function br(e){var t=e.value,o=e.setValue,n=e.locale,s=e.className,l=e.humanizeLabels,i=e.disabled,c=e.readOnly,d=e.period,u=e.periodicityOnDoubleClick,m=e.mode,h=n.months||K.months,C=p.useMemo(function(){var y;return me(((y={"react-js-cron-field":!0,"react-js-cron-months":!0})["".concat(s,"-field")]=!!s,y["".concat(s,"-months")]=!!s,y))},[s]);return r.jsxs("div",ce({className:C},{children:[n.prefixMonths!==""&&r.jsx("span",{children:n.prefixMonths||K.prefixMonths}),r.jsx(He,{placeholder:n.emptyMonths||K.emptyMonths,optionsList:h,grid:!1,value:t,unit:ce(ce({},Te[3]),{alt:n.altMonths||K.altMonths}),setValue:o,locale:n,className:s,humanizeLabels:l,disabled:i,readOnly:c,period:d,periodicityOnDoubleClick:u,mode:m})]}))}function xr(e){var t=e.value,o=e.setValue,n=e.locale,s=e.className,l=e.disabled,i=e.readOnly,c=e.shortcuts,d=e.allowedPeriods,u=[];d.includes("year")&&u.push({value:"year",label:n.yearOption||K.yearOption}),d.includes("month")&&u.push({value:"month",label:n.monthOption||K.monthOption}),d.includes("week")&&u.push({value:"week",label:n.weekOption||K.weekOption}),d.includes("day")&&u.push({value:"day",label:n.dayOption||K.dayOption}),d.includes("hour")&&u.push({value:"hour",label:n.hourOption||K.hourOption}),d.includes("minute")&&u.push({value:"minute",label:n.minuteOption||K.minuteOption}),d.includes("reboot")&&c&&(c===!0||c.includes("@reboot"))&&u.push({value:"reboot",label:n.rebootOption||K.rebootOption});var m=p.useCallback(function(g){i||o(g)},[o,i]),h=p.useMemo(function(){var g;return me(((g={"react-js-cron-field":!0,"react-js-cron-period":!0})["".concat(s,"-field")]=!!s,g["".concat(s,"-period")]=!!s,g))},[s]),C=p.useMemo(function(){var g;return me(((g={"react-js-cron-select":!0,"react-js-cron-select-no-prefix":n.prefixPeriod===""})["".concat(s,"-select")]=!!s,g))},[s,n.prefixPeriod]),y=p.useMemo(function(){var g;return me(((g={"react-js-cron-select-dropdown":!0,"react-js-cron-select-dropdown-period":!0})["".concat(s,"-select-dropdown")]=!!s,g["".concat(s,"-select-dropdown-period")]=!!s,g))},[s]);return r.jsxs("div",ce({className:h},{children:[n.prefixPeriod!==""&&r.jsx("span",{children:n.prefixPeriod||K.prefixPeriod}),r.jsx(b.Select,{defaultValue:t,value:t,onChange:m,options:u,className:C,popupClassName:y,disabled:l,showArrow:!i,open:!i&&void 0,"data-testid":"select-period"},JSON.stringify(n))]}))}function vr(e){var t=e.value,o=e.setValue,n=e.locale,s=e.className,l=e.humanizeLabels,i=e.monthDays,c=e.disabled,d=e.readOnly,u=e.period,m=e.periodicityOnDoubleClick,h=e.mode,C=n.weekDays||K.weekDays,y=u==="week"||!i||i.length===0,g=p.useMemo(function(){var T;return me(((T={"react-js-cron-field":!0,"react-js-cron-week-days":!0,"react-js-cron-week-days-placeholder":!y})["".concat(s,"-field")]=!!s,T["".concat(s,"-week-days")]=!!s,T))},[s,y]),O=JSON.stringify(n),x=p.useMemo(function(){return y?n.emptyWeekDays||K.emptyWeekDays:n.emptyWeekDaysShort||K.emptyWeekDaysShort},[y,O]),M=u==="week"||!d||t&&t.length>0||(!t||t.length===0)&&(!i||i.length===0),v=!d||i&&i.length>0||(!i||i.length===0)&&(!t||t.length===0);return M?r.jsxs("div",ce({className:g},{children:[n.prefixWeekDays!==""&&(u==="week"||!v)&&r.jsx("span",{children:n.prefixWeekDays||K.prefixWeekDays}),n.prefixWeekDaysForMonthAndYearPeriod!==""&&u!=="week"&&v&&r.jsx("span",{children:n.prefixWeekDaysForMonthAndYearPeriod||K.prefixWeekDaysForMonthAndYearPeriod}),r.jsx(He,{placeholder:x,optionsList:C,grid:!1,value:t,unit:ce(ce({},Te[4]),{alt:n.altWeekDays||K.altWeekDays}),setValue:o,locale:n,className:s,humanizeLabels:l,disabled:c,readOnly:d,period:u,periodicityOnDoubleClick:m,mode:h})]})):null}function wr(e){var t=e.clearButton,o=t===void 0||t,n=e.clearButtonProps,s=n===void 0?{}:n,l=e.clearButtonAction,i=l===void 0?"fill-with-every":l,c=e.locale,d=c===void 0?K:c,u=e.value,m=u===void 0?"":u,h=e.setValue,C=e.displayError,y=C===void 0||C,g=e.onError,O=e.className,x=e.defaultPeriod,M=x===void 0?"day":x,v=e.allowEmpty,T=v===void 0?"for-default-value":v,I=e.humanizeLabels,N=I===void 0||I,F=e.humanizeValue,E=F!==void 0&&F,V=e.disabled,j=V!==void 0&&V,L=e.readOnly,_=L!==void 0&&L,Z=e.leadingZero,B=Z!==void 0&&Z,H=e.shortcuts,G=H===void 0?["@yearly","@annually","@monthly","@weekly","@daily","@midnight","@hourly"]:H,ae=e.clockFormat,J=e.periodicityOnDoubleClick,U=J===void 0||J,$=e.mode,W=$===void 0?"multiple":$,oe=e.allowedDropdowns,te=oe===void 0?["period","months","month-days","week-days","hours","minutes"]:oe,se=e.allowedPeriods,Be=se===void 0?["year","month","week","day","hour","minute","reboot"]:se,we=p.useRef(m),ye=p.useRef(M),Ve=p.useState(),Ce=Ve[0],st=Ve[1],Ho=p.useState(),Ye=Ho[0],at=Ho[1],Yo=p.useState(),lt=Yo[0],it=Yo[1],Go=p.useState(),Ge=Go[0],ct=Go[1],Uo=p.useState(),ut=Uo[0],dt=Uo[1],Ko=p.useState(),pt=Ko[0],ft=Ko[1],qo=p.useState(!1),Lt=qo[0],Ue=qo[1],Jo=p.useState(!1),mt=Jo[0],Zo=Jo[1],Gr=function(ne){var xe=p.useRef(ne);return p.useEffect(function(){xe.current=ne},[ne]),xe.current}(mt),Qo=JSON.stringify(d);p.useEffect(function(){Oo(m,Ue,g,T,we,!0,d,G,ft,dt,at,it,ct,st)},[]),p.useEffect(function(){m!==we.current&&Oo(m,Ue,g,T,we,!1,d,G,ft,dt,at,it,ct,st)},[m,we,Qo,T,G]),p.useEffect(function(){if(!(Ce||pt||lt||Ye||Ge||ut)||mt||Gr)mt&&Zo(!1);else{var ne=Ce||ye.current,xe=Io(ne,lt,Ye,Ge,ut,pt,E);h(xe,{selectedPeriod:ne}),we.current=xe,g&&g(void 0),Ue(!1)}},[Ce,Ye,lt,Ge,ut,pt,E,mt]);var Xo=p.useCallback(function(){at(void 0),it(void 0),ct(void 0),dt(void 0),ft(void 0);var ne="",xe=Ce!=="reboot"&&Ce?Ce:ye.current;xe!==Ce&&st(xe),i==="fill-with-every"&&(ne=Io(xe,void 0,void 0,void 0,void 0,void 0)),h(ne,{selectedPeriod:xe}),we.current=ne,Zo(!0),T==="never"&&i==="empty"?(Ue(!0),To(g,d)):(g&&g(void 0),Ue(!1))},[Ce,h,g,i]),Ur=p.useMemo(function(){var ne;return me(((ne={"react-js-cron":!0,"react-js-cron-error":Lt&&y,"react-js-cron-disabled":j,"react-js-cron-read-only":_})["".concat(O)]=!!O,ne["".concat(O,"-error")]=Lt&&y&&!!O,ne["".concat(O,"-disabled")]=j&&!!O,ne["".concat(O,"-read-only")]=_&&!!O,ne))},[O,Lt,y,j,_]),jt=s.className,Ro=ko(s,["className"]),en=p.useMemo(function(){var ne;return me(((ne={"react-js-cron-clear-button":!0})["".concat(O,"-clear-button")]=!!O,ne["".concat(jt)]=!!jt,ne))},[O,jt]),Kr=JSON.stringify(Ro),tn=p.useMemo(function(){return o&&!_?r.jsx(b.Button,ce({className:en,danger:!0,type:"primary",disabled:j},Ro,{onClick:Xo},{children:d.clearButtonText||K.clearButtonText})):null},[o,_,Qo,en,j,Kr,Xo]),le=Ce||ye.current;return r.jsxs("div",ce({className:Ur},{children:[te.includes("period")&&r.jsx(xr,{value:le,setValue:st,locale:d,className:O,disabled:j,readOnly:_,shortcuts:G,allowedPeriods:Be}),le==="reboot"?tn:r.jsxs(r.Fragment,{children:[le==="year"&&te.includes("months")&&r.jsx(br,{value:lt,setValue:it,locale:d,className:O,humanizeLabels:N,disabled:j,readOnly:_,period:le,periodicityOnDoubleClick:U,mode:W}),(le==="year"||le==="month")&&te.includes("month-days")&&r.jsx(gr,{value:Ye,setValue:at,locale:d,className:O,weekDays:Ge,disabled:j,readOnly:_,leadingZero:B,period:le,periodicityOnDoubleClick:U,mode:W}),(le==="year"||le==="month"||le==="week")&&te.includes("week-days")&&r.jsx(vr,{value:Ge,setValue:ct,locale:d,className:O,humanizeLabels:N,monthDays:Ye,disabled:j,readOnly:_,period:le,periodicityOnDoubleClick:U,mode:W}),r.jsxs("div",{children:[le!=="minute"&&le!=="hour"&&te.includes("hours")&&r.jsx(hr,{value:ut,setValue:dt,locale:d,className:O,disabled:j,readOnly:_,leadingZero:B,clockFormat:ae,period:le,periodicityOnDoubleClick:U,mode:W}),le!=="minute"&&te.includes("minutes")&&r.jsx(yr,{value:pt,setValue:ft,locale:d,period:le,className:O,disabled:j,readOnly:_,leadingZero:B,clockFormat:ae,periodicityOnDoubleClick:U,mode:W}),tn]})]})]}))}const Cr={"zh-CN":{everyText:"",emptyMonths:"",emptyMonthDays:"()",emptyMonthDaysShort:"",emptyWeekDays:"()",emptyWeekDaysShort:"()",emptyHours:"",emptyMinutes:"",emptyMinutesForHourPeriod:"",yearOption:"",monthOption:"",weekOption:"",dayOption:"",hourOption:"",minuteOption:"",rebootOption:"",prefixPeriod:"",prefixMonths:"",prefixMonthDays:"",prefixWeekDays:"",prefixWeekDaysForMonthAndYearPeriod:"",prefixHours:"",prefixMinutes:":",prefixMinutesForHourPeriod:"",suffixMinutesForHourPeriod:"",errorInvalidCron:" cron ",clearButtonText:"",weekDays:["","","","","","",""],months:["","","","","","","","","","","",""],altWeekDays:["","","","","","",""],altMonths:["","","","","","","","","","","",""]}},Po=[{value:"none",text:"No repeat"},{value:6e4,text:"By minute",unitText:"Minutes"},{value:36e5,text:"By hour",unitText:"Hours"},{value:864e5,text:"By day",unitText:"Days"},{value:6048e5,text:"By week",unitText:"Weeks"},{value:"cron",text:"Advanced"}];function Bo(e){return Po.filter(o=>typeof o.value=="number").reverse().find(o=>!(e%o.value))}function kr(e){let t;switch(typeof e){case"number":return t=Bo(e),t?t.value:"none";case"string":return"cron"}return"none"}function Sr({value:e,onChange:t}){const{t:o}=bt(),n=Bo(e);return r.jsx(b.InputNumber,{value:e/n.value,onChange:s=>t(s*n.value),min:1,addonBefore:o("Every"),addonAfter:o(n.unitText),className:"auto-width"})}function Ar({value:e=null,onChange:t}){const{t:o}=bt(),n=kr(e);function s(i){if(i==="none"){t(null);return}if(i==="cron"){t("0 * * * * *");return}t(i)}const l=Cr[localStorage.getItem("NOCODE_LOCALE")||"en-US"];return r.jsxs("fieldset",{className:a.css`
        display: flex;
        flex-direction: ${n==="cron"?"column":"row"};
        align-items: flex-start;
        gap: 0.5em;

        .react-js-cron {
          width: 100%;
          padding: 0.5em 0.5em 0 0.5em;
          border: 1px dashed #ccc;

          .react-js-cron-field {
            margin-bottom: 0.5em;

            > span {
              margin: 0 0.5em 0 0;
            }

            > .react-js-cron-select {
              margin: 0 0.5em 0 0;
            }
          }

          .react-js-cron-week-days {
            > span {
              min-width: 2em;
            }
          }
        }
      `,children:[r.jsx(b.Select,{value:n,onChange:s,className:"auto-width",children:Po.map(i=>r.jsx(b.Select.Option,{value:i.value,children:o(i.text)},i.value))}),typeof n=="number"?r.jsx(Sr,{value:e,onChange:t}):null,n==="cron"?r.jsx(wr,{value:e.trim().split(/\s+/).slice(1).join(" "),setValue:i=>t(`0 ${i}`),clearButton:!1,locale:l}):null]})}const Tr={[Ae.STATIC]:{startsOn:{type:"datetime",title:`{{t("Starts on", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"DatePicker","x-component-props":{showTime:!0},required:!0},repeat:{type:"string",title:`{{t("Repeat mode", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"RepeatField","x-reactions":[{target:"endsOn",fulfill:{state:{visible:"{{!!$self.value}}"}}},{target:"limit",fulfill:{state:{visible:"{{!!$self.value}}"}}}]},endsOn:{type:"datetime",title:`{{t("Ends on", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"DatePicker","x-component-props":{showTime:!0}},limit:{type:"number",title:`{{t("Repeat limit", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{placeholder:`{{t("No limit", { ns: "${f}" })}}`,min:0}}},[Ae.DATE_FIELD]:{collection:D(k({},fe),{"x-component-props":{dataSourceFilter(e){return e.options.key==="main"||e.options.isDBInstance}},"x-reactions":[...fe["x-reactions"],{target:"startsOn",effects:["onFieldValueChange"],fulfill:{state:{visible:"{{!!$self.value}}",value:"{{Object.create({})}}"}}}]}),startsOn:{type:"object",title:`{{t("Starts on", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"OnField","x-reactions":[{target:"repeat",fulfill:{state:{visible:"{{!!$self.value}}"}}}],required:!0},repeat:{type:"string",title:`{{t("Repeat mode", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"RepeatField","x-reactions":[{target:"endsOn",fulfill:{state:{visible:"{{!!$self.value}}"}}},{target:"limit",fulfill:{state:{visible:"{{!!$self.value}}"}}}]},endsOn:{type:"object",title:`{{t("Ends on", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"EndsByField"},limit:{type:"number",title:`{{t("Repeat limit", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"InputNumber","x-component-props":{placeholder:`{{t("No limit", { ns: "${f}" })}}`,min:0}},appends:D(k({},_e),{"x-reactions":[{dependencies:["mode","collection"],fulfill:{state:{visible:`{{$deps[0] === ${Ae.DATE_FIELD} && $deps[1]}}`}}}]})}},Or=[{value:Ae.STATIC,label:`{{t("Based on certain date", { ns: "${f}" })}}`},{value:Ae.DATE_FIELD,label:`{{t("Based on date field of collection", { ns: "${f}" })}}`}],Ir=()=>{const{values:e={},clearFormGraph:t}=Y.useForm(),[o,n]=p.useState(e.mode);return Y.useFormEffects(()=>{ge.onFieldValueChange("mode",s=>{n(s.value),t("collection"),t("startsOn"),t("repeat"),t("endsOn"),t("limit")})}),r.jsxs(r.Fragment,{children:[r.jsx(a.SchemaComponent,{schema:{type:"number",title:`{{t("Trigger mode", { ns: "${f}" })}}`,name:"mode","x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{options:Or},required:!0,default:Ae.STATIC}}),r.jsx(a.SchemaComponent,{schema:{type:"void",properties:{[`mode-${o}`]:{type:"void","x-component":"fieldset","x-component-props":{className:a.css`
                    .ant-input-number {
                      width: auto;
                      min-width: 6em;
                    }

                    .ant-picker {
                      width: auto;
                    }
                  `},properties:Tr[o]}}},components:{OnField:Co,RepeatField:Ar,EndsByField:fr}})]})};class Er extends Bt{constructor(){super(...arguments);S(this,"sync",!1);S(this,"title",`{{t("Schedule event", { ns: "${f}" })}}`);S(this,"description",`{{t("Triggered according to preset time conditions. Suitable for one-time or periodic tasks, such as sending notifications and cleaning data on a schedule.", { ns: "${f}" })}}`);S(this,"fieldset",{config:{type:"void","x-component":"ScheduleConfig","x-component-props":{}}});S(this,"scope",{useCollectionDataSource:a.useCollectionDataSource});S(this,"components",{ScheduleConfig:Ir})}useVariables(o,n){var c;const s=a.useCompile(),{getCollectionFields:l}=a.useCollectionManager_deprecated(),i=[];if((!(n!=null&&n.types)||n.types.includes("date"))&&i.push({key:"date",value:"date",label:A("Trigger time")}),o.mode===Ae.DATE_FIELD){const[d]=De(D(k({appends:["data",...((c=o.appends)==null?void 0:c.map(u=>`data.${u}`))||[]]},n),{fields:[{collectionName:o.collection,name:"data",type:"hasOne",target:o.collection,uiSchema:{title:A("Trigger data")}}],compile:s,getCollectionFields:l}));d&&i.push(d)}return i}useInitializers(o){return o.collection?{name:"triggerData",type:"item",title:`{{t("Trigger data", { ns: "${f}" })}}`,Component:We,collection:o.collection,dataPath:"$context.data"}:null}}const Vo=e=>{const t=Le.evaluators.get(e);return t&&t.link?r.jsxs(r.Fragment,{children:[r.jsx("span",{className:a.css`
          &:after {
            content: ':';
          }
          & + a {
            margin-left: 0.25em;
          }
        `,children:a.i18n.t("Syntax references")}),r.jsx("a",{href:t.link,target:"_blank",rel:"noreferrer",children:t.label})]}):null};class Fr extends ve{constructor(){super(...arguments);S(this,"title",`{{t("Calculation", { ns: "${f}" })}}`);S(this,"type","calculation");S(this,"group","calculation");S(this,"description",`{{t("Calculate an expression based on a calculation engine and obtain a value as the result. Variables in the upstream nodes can be used in the expression.", { ns: "${f}" })}}`);S(this,"icon",r.jsx(P.CalculatorOutlined,{}));S(this,"fieldset",{engine:{type:"string",title:`{{t("Calculation engine", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"RadioWithTooltip","x-component-props":{options:Le.getOptions()},required:!0,default:"math.js"},expression:{type:"string",title:`{{t("Calculation expression", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"WorkflowVariableTextArea","x-component-props":{changeOnSelect:!0},"x-validator"(o,n,{form:s}){const{values:l}=s,{evaluate:i}=Le.evaluators.get(l.engine),c=o.trim().replace(/{{([^{}]+)}}/g," 1 "),d=o.trim().replace(/{{([^{}]+)}}/g," [1] ");let u=!0,m=!0;try{i(c)}catch(h){u=!1}try{i(d)}catch(h){m=!1}return u||m?"":A("Expression syntax error")},"x-reactions":[{dependencies:["engine"],fulfill:{schema:{description:"{{renderEngineReference($deps[0])}}"}}}],required:!0}});S(this,"scope",{renderEngineReference:Vo});S(this,"components",{WorkflowVariableTextArea:Ft,RadioWithTooltip:Me,ValueBlock:Ne})}useVariables({key:o,title:n},{types:s,fieldNames:l=Se}){return s&&!s.some(i=>i in Qe||Object.values(Qe).some(c=>c.has(i)))?null:{[l.value]:o,[l.label]:n}}useInitializers(o){var n,s;return{name:(n=o.title)!=null?n:`#${o.id}`,type:"item",title:(s=o.title)!=null?s:`#${o.id}`,Component:Ne.Initializer,node:o,resultTitle:A("Calculation result")}}}const re=new z.Registry;re.register("equal",{name:"=",type:"boolean",group:"boolean"}),re.register("notEqual",{name:"",type:"boolean",group:"boolean"}),re.register("gt",{name:">",type:"boolean",group:"boolean"}),re.register("gte",{name:"",type:"boolean",group:"boolean"}),re.register("lt",{name:"<",type:"boolean",group:"boolean"}),re.register("lte",{name:"",type:"boolean",group:"boolean"}),re.register("add",{name:"+",type:"number",group:"number"}),re.register("minus",{name:"-",type:"number",group:"number"}),re.register("multiple",{name:"*",type:"number",group:"number"}),re.register("divide",{name:"/",type:"number",group:"number"}),re.register("mod",{name:"%",type:"number",group:"number"}),re.register("includes",{name:'{{t("contains")}}',type:"boolean",group:"string"}),re.register("notIncludes",{name:'{{t("does not contain")}}',type:"boolean",group:"string"}),re.register("startsWith",{name:'{{t("starts with")}}',type:"boolean",group:"string"}),re.register("notStartsWith",{name:'{{t("not starts with")}}',type:"boolean",group:"string"}),re.register("endsWith",{name:'{{t("ends with")}}',type:"boolean",group:"string"}),re.register("notEndsWith",{name:'{{t("not ends with")}}',type:"boolean",group:"string"}),re.register("concat",{name:`{{t("concat", { ns: "${f}" })}}`,type:"string",group:"string"});const Dr=[{value:"boolean",title:'{{t("Comparision")}}'},{value:"number",title:`{{t("Arithmetic calculation", { ns: "${f}" })}}`},{value:"string",title:`{{t("String operation", { ns: "${f}" })}}`},{value:"date",title:`{{t("Date", { ns: "${f}" })}}`}];function Lo(e){return Array.from(re.getEntities()).filter(([t,o])=>o.group===e)}function Mr({calculator:e,operands:t=[],onChange:o}){const n=a.useCompile(),s=p.useContext(Wo),l=s(),i=s(),c=p.useCallback(h=>o({calculator:e,operands:[h,t[1]]}),[e,o,t]),d=p.useCallback(h=>o({calculator:e,operands:[t[0],h]}),[e,o,t]),u=p.useCallback(h=>o({operands:t,calculator:h}),[o,t]),m=p.useMemo(()=>{var g,O,x;const h=(g=(t[0]+"").match(/\$jobsMapByNodeKey\.([^.]+)\._/))==null?void 0:g[1];if(!h)return[];const y=(((O=l.filter(M=>M.key==="$jobsMapByNodeKey")[0])==null?void 0:O.children)||[]).find(M=>M.value===h&&["audit"].includes(M==null?void 0:M.type));return((x=((y==null?void 0:y.children)||[]).filter(M=>(M==null?void 0:M.type)==="operation")[0])==null?void 0:x.childs)||[]},[t[0],l]);return r.jsxs("fieldset",{className:a.css`
        display: flex;
        gap: 0.5em;
        align-items: center;
        flex-wrap: wrap;
      `,children:[r.jsx(a.Variable.Input,{changeOnSelect:!0,value:t[0],onChange:c,scope:l,useTypedConstant:!0}),r.jsx(b.Select,{role:"button","aria-label":"select-operator-calc",value:e,onChange:u,placeholder:A("Operator"),popupMatchSelectWidth:!1,className:"auto-width",children:Dr.filter(h=>!!Lo(h.value).length).map(h=>r.jsx(b.Select.OptGroup,{label:n(h.title),children:Lo(h.value).map(([C,{name:y}])=>r.jsx(b.Select.Option,{value:C,children:n(y)},C))},h.value))}),m.length?r.jsx(b.Select,{value:m.some(h=>h.value===t[1])?t[1]:void 0,onChange:h=>o({calculator:e,operands:[t[0],h]}),options:m,style:{width:"auto",minWidth:"10em"}}):r.jsx(a.Variable.Input,{changeOnSelect:!0,value:t[1],onChange:d,scope:i,useTypedConstant:!0})]})}function Nr({value:e,onChange:t,onRemove:o}){if(!e)return null;const{calculator:n,operands:s=[]}=e;return r.jsxs("div",{className:a.css`
        display: flex;
        position: relative;
        margin: 0.5em 0;
      `,children:[e.group?r.jsx(jo,{value:e.group,onChange:l=>t(D(k({},e),{group:l}))}):r.jsx(Mr,{operands:s,calculator:n,onChange:t}),r.jsx(b.Button,{"aria-label":"icon-close",onClick:o,type:"link",icon:r.jsx(P.CloseCircleOutlined,{})})]})}function jo({value:e,onChange:t}){const{t:o}=ee.useTranslation(),{type:n="and",calculations:s=[]}=e,l=p.useCallback(()=>{t(D(k({},e),{calculations:[...s,{not:!1,calculator:"equal"}]}))},[e,s,t]),i=p.useCallback(()=>{t(D(k({},e),{calculations:[...s,{not:!1,group:{type:"and",calculations:[]}}]}))},[e,s,t]),c=p.useCallback(u=>{s.splice(u,1),t(D(k({},e),{calculations:[...s]}))},[e,s,t]),d=p.useCallback((u,m)=>{s.splice(u,1,m),t(D(k({},e),{calculations:[...s]}))},[e,s,t]);return r.jsxs("div",{className:a.cx("node-type-condition-group",a.css`
          position: relative;
          width: 100%;
          .node-type-condition-group {
            padding: 0.5em 1em;
            border: 1px dashed #ddd;
          }
          + button {
            position: absolute;
            right: 0;
          }
        `),children:[r.jsx("div",{className:a.css`
          display: flex;
          align-items: center;
          gap: 0.5em;
          .ant-select {
            width: auto;
            min-width: 6em;
          }
        `,children:r.jsxs(ee.Trans,{children:["Meet ",r.jsxs(b.Select,{role:"button","data-testid":"filter-select-all-or-any",value:n,onChange:u=>t(D(k({},e),{type:u})),children:[r.jsx(b.Select.Option,{value:"and",children:"All"}),r.jsx(b.Select.Option,{value:"or",children:"Any"})]})," conditions in the group"]})}),r.jsx("div",{className:"calculation-items",children:s.map((u,m)=>r.jsx(Nr,{value:u,onChange:d.bind(this,m),onRemove:()=>c(m)},`${u.calculator}_${m}`))}),r.jsxs("div",{className:a.css`
          button {
            padding: 0;
            &:not(:last-child) {
              margin-right: 1em;
            }
          }
        `,children:[r.jsx(b.Button,{type:"link",onClick:l,children:o("Add condition")}),r.jsx(b.Button,{type:"link",onClick:i,children:o("Add condition group")})]})]})}const Wo=p.createContext(he);function $r({value:e,onChange:t,useVariableHook:o=he}){const n=e&&Object.keys(e).length?e:{group:{type:"and",calculations:[]}};return r.jsx(Wo.Provider,{value:o,children:r.jsx(jo,{value:n.group,onChange:s=>t(D(k({},n),{group:s}))})})}const zo={DEFAULT:null,ON_TRUE:1,ON_FALSE:0};class Pr extends ve{constructor(){super(...arguments);S(this,"title",`{{t("Condition", { ns: "${f}" })}}`);S(this,"type","condition");S(this,"group","control");S(this,"description",`{{t('Based on boolean result of the calculation to determine whether to "continue" or "exit" the process, or continue on different branches of "yes" and "no".', { ns: "${f}" })}}`);S(this,"icon",r.jsx(P.QuestionCircleOutlined,{style:{}}));S(this,"fieldset",{rejectOnFalse:{type:"boolean",title:`{{t("Mode", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{disabled:!0},enum:[{value:!0,label:`{{t('Continue when "Yes"', { ns: "${f}" })}}`},{value:!1,label:`{{t('Branch into "Yes" and "No"', { ns: "${f}" })}}`}]},engine:{type:"string",title:`{{t("Calculation engine", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"RadioWithTooltip","x-component-props":{options:[["basic",{label:`{{t("Basic", { ns: "${f}" })}}`}],...Array.from(Le.evaluators.getEntities()).filter(([o])=>["math.js","formula.js"].includes(o))].reduce((o,[n,s])=>o.concat(k({value:n},s)),[])},required:!0,default:"basic"},calculation:{type:"object",title:`{{t("Condition", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"CalculationConfig","x-reactions":{dependencies:["engine"],fulfill:{state:{visible:'{{$deps[0] === "basic"}}'}}},required:!0},expression:{type:"string",title:`{{t("Condition expression", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"WorkflowVariableTextArea","x-component-props":{changeOnSelect:!0},"x-validator"(o,n,{form:s}){const{values:l}=s,{evaluate:i}=Le.evaluators.get(l.engine),c=o.trim().replace(/{{([^{}]+)}}/g,' "1" ');try{return i(c),""}catch(d){return A("Expression syntax error")}},"x-reactions":{dependencies:["engine"],fulfill:{state:{visible:'{{$deps[0] !== "basic"}}'},schema:{description:"{{renderEngineReference($deps[0])}}"}}},required:!0}});S(this,"presetFieldset",{rejectOnFalse:{type:"boolean",title:`{{t("Mode", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"Radio.Group",enum:[{label:`{{t('Continue when "Yes"', { ns: "${f}" })}}`,value:!0},{label:`{{t('Branch into "Yes" and "No"', { ns: "${f}" })}}`,value:!1}],default:!0}});S(this,"branching",({rejectOnFalse:o=!0}={})=>o?!1:[{label:`{{t('After end of branches', { ns: "${f}" })}}`,value:!1},{label:`{{t('Inside of "Yes" branch', { ns: "${f}" })}}`,value:zo.ON_TRUE},{label:`{{t('Inside of "No" branch', { ns: "${f}" })}}`,value:zo.ON_FALSE}]);S(this,"scope",{renderEngineReference:Vo,useWorkflowVariableOptions:he});S(this,"components",{CalculationConfig:$r,WorkflowVariableTextArea:Ft,RadioWithTooltip:Me})}Component({data:o}){const{t:n}=ee.useTranslation(),{nodes:s}=X(),{styles:l}=ie(),{id:i,config:{rejectOnFalse:c}}=o,d=s.find(m=>m.upstreamId===i&&m.branchIndex===1),u=s.find(m=>m.upstreamId===i&&m.branchIndex===0);return r.jsx(At,{data:o,children:c?null:r.jsxs("div",{className:l.nodeSubtreeClass,children:[r.jsxs("div",{className:l.branchBlockClass,children:[r.jsx(et,{from:o,entry:u,branchIndex:0}),r.jsx(et,{from:o,entry:d,branchIndex:1})]}),r.jsxs("div",{className:l.conditionClass,children:[r.jsx("span",{style:{right:"4em"},children:n("No")}),r.jsx("span",{style:{left:"4em"},children:n("Yes")})]})]})})}}class Br extends ve{constructor(){super(...arguments);S(this,"title",`{{t("End process", { ns: "${f}" })}}`);S(this,"type","end");S(this,"group","control");S(this,"description",`{{t("End the process immediately, with set status.", { ns: "${f}" })}}`);S(this,"icon",r.jsx(P.StopOutlined,{}));S(this,"fieldset",{endStatus:{type:"number",title:`{{t("End status", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"Radio.Group",enum:[{label:`{{t("Succeeded", { ns: "${f}" })}}`,value:Ie.RESOLVED},{label:`{{t("Failed", { ns: "${f}" })}}`,value:Ie.FAILED},{label:`{{t("Secondary Confirmation", { ns: "${f}" })}}`,value:Ie.RETRY_NEEDED}],required:!0,default:Ie.RESOLVED}});S(this,"end",!0)}}class Vr extends ve{constructor(){super(...arguments);S(this,"title",`{{t("Query record", { ns: "${f}" })}}`);S(this,"type","query");S(this,"group","collection");S(this,"description",`{{t("Query records from a collection. You can use variables from upstream nodes as query conditions.", { ns: "${f}" })}}`);S(this,"icon",r.jsx(P.FileSearchOutlined,{}));S(this,"fieldset",{collection:D(k({},fe),{"x-reactions":[...fe["x-reactions"],{target:"params",effects:["onFieldValueChange"],fulfill:{state:{visible:"{{!!$self.value}}",value:"{{Object.create({})}}"}}}]}),multiple:{type:"boolean","x-decorator":"FormItem","x-component":"Checkbox","x-content":`{{t("Allow multiple records as result", { ns: "${f}" })}}`,description:`{{t("If checked, when there are multiple records in the query result, an array will be returned as the result, which can be operated on one by one using a loop node. Otherwise, only one record will be returned.", { ns: "${f}" })}}`},params:{type:"object","x-component":"fieldset",properties:{filter:tt,sort:sr,pagination:ar,appends:_e},"x-reactions":[{dependencies:["collection"],fulfill:{state:{visible:"{{$deps[0] != null}}"}}}]},failOnEmpty:{type:"boolean","x-decorator":"FormItem","x-component":"Checkbox","x-content":`{{t("Exit when query result is null", { ns: "${f}" })}}`}});S(this,"scope",{useCollectionDataSource:a.useCollectionDataSource,useSortableFields(){const o=a.useCompile(),n=a.useCollectionManager(),s=a.useDataSourceManager(),{values:l}=Y.useForm();return n.getCollectionFields(l.collection).filter(c=>{var u;if(!c.interface)return!1;const d=(u=s==null?void 0:s.collectionFieldInterfaceManager)==null?void 0:u.getFieldInterface(c.interface);return!!(d!=null&&d.sortable)}).map(c=>{var d,u;return{value:c.name,label:(d=c==null?void 0:c.uiSchema)!=null&&d.title?o((u=c==null?void 0:c.uiSchema)==null?void 0:u.title):c.name}})}});S(this,"components",{ArrayItems:ln.ArrayItems,FilterDynamicComponent:Xe,SchemaComponentContext:a.SchemaComponentContext,WorkflowVariableInput:ro})}useVariables({key:o,title:n,config:s},l){var u,m;const i=a.useCompile(),{getCollectionFields:c}=a.useCollectionManager_deprecated(),[d]=De(D(k({appends:[o,...((m=(u=s.params)==null?void 0:u.appends)==null?void 0:m.map(h=>`${o}.${h}`))||[]]},l),{fields:[{collectionName:s.collection,name:o,type:"hasOne",target:s.collection,uiSchema:{title:n}}],compile:i,getCollectionFields:c}));return d}useInitializers(o){var n,s;return!o.config.collection||o.config.multiple?null:{name:(n=o.title)!=null?n:`#${o.id}`,type:"item",title:(s=o.title)!=null?s:`#${o.id}`,Component:We,collection:o.config.collection,dataPath:`$jobsMapByNodeKey.${o.key}`}}}class Lr extends ve{constructor(){super(...arguments);S(this,"title",`{{t("Create record", { ns: "${f}" })}}`);S(this,"type","create");S(this,"group","collection");S(this,"description",`{{t("Add new record to a collection. You can use variables from upstream nodes to assign values to fields.", { ns: "${f}" })}}`);S(this,"icon",r.jsx(P.FileAddOutlined,{}));S(this,"fieldset",{collection:D(k({},fe),{"x-reactions":[...fe["x-reactions"],{target:"params",effects:["onFieldValueChange"],fulfill:{state:{visible:"{{!!$self.value}}",value:"{{Object.create({})}}"}}}]}),params:{type:"object",properties:{values:vo,appends:_e}}});S(this,"scope",{useCollectionDataSource:a.useCollectionDataSource});S(this,"components",{CollectionFieldset:Dt})}useVariables({key:o,title:n,config:s},l){var u,m;const i=a.useCompile(),{getCollectionFields:c}=a.useCollectionManager_deprecated(),[d]=De(D(k({appends:[o,...((m=(u=s.params)==null?void 0:u.appends)==null?void 0:m.map(h=>`${o}.${h}`))||[]]},l),{fields:[{collectionName:s.collection,name:o,type:"hasOne",target:s.collection,uiSchema:{title:n}}],compile:i,getCollectionFields:c}));return d}useInitializers(o){var n,s;return o.config.collection?{name:(n=o.title)!=null?n:`#${o.id}`,type:"item",title:(s=o.title)!=null?s:`#${o.id}`,Component:We,collection:o.config.collection,dataPath:`$jobsMapByNodeKey.${o.key}`}:null}}function _o(o){var n=o,{onChange:e}=n,t=R(n,["onChange"]);const{getCollectionFields:s}=a.useCollectionManager_deprecated(),l=Y.useForm(),{collection:i}=l.values,c=s(i),d=Y.useField();function u({target:m}){const h=d.query(".values").take();if(!h)return;const C=c.reduce((y,g)=>(g.name in h.value&&(m.value||!["hasOne","hasMany","belongsToMany"].includes(g.type))&&(y[g.name]=h.value[g.name]),y),{});l.setValuesIn("params.values",C),e(m.value)}return r.jsx(Me,D(k({},t),{onChange:u}))}class jr extends ve{constructor(){super(...arguments);S(this,"title",`{{t("Update record", { ns: "${f}" })}}`);S(this,"type","update");S(this,"group","collection");S(this,"description",`{{t("Update records of a collection. You can use variables from upstream nodes as query conditions and field values.", { ns: "${f}" })}}`);S(this,"icon",r.jsx(P.EditOutlined,{}));S(this,"fieldset",{collection:D(k({},fe),{"x-reactions":[...fe["x-reactions"],{target:"params",fulfill:{state:{visible:"{{!!$self.value}}"}}},{target:"params.filter",effects:["onFieldValueChange"],fulfill:{state:{value:"{{Object.create({})}}"}}},{target:"params.values",effects:["onFieldValueChange"],fulfill:{state:{value:"{{Object.create({})}}"}}}]}),params:{type:"object",properties:{individualHooks:{type:"boolean",title:`{{t("Update mode", { ns: "${f}" })}}`,"x-decorator":"FormItem","x-component":"IndividualHooksRadioWithTooltip","x-component-props":{options:[{label:`{{t("Update in a batch", { ns: "${f}" })}}`,value:!1,tooltip:`{{t("Update all eligible data at one time, which has better performance when the amount of data is large. But the updated data will not trigger other workflows, and will not record audit logs.", { ns: "${f}" })}}`},{label:`{{t("Update one by one", { ns: "${f}" })}}`,value:!0,tooltip:`{{t("The updated data can trigger other workflows, and the audit log will also be recorded. But it is usually only applicable to several or dozens of pieces of data, otherwise there will be performance problems.", { ns: "${f}" })}}`}]},default:!1},filter:D(k({},tt),{title:`{{t("Only update records matching conditions", { ns: "${f}" })}}`,"x-validator"(o){return z.isValidFilter(o)?"":A("Please add at least one condition")}}),values:D(k({},vo),{"x-component-props":{filter(o){var n;return((n=this.params)==null?void 0:n.individualHooks)||!["hasOne","hasMany","belongsToMany"].includes(o.type)}}})}}});S(this,"scope",{useCollectionDataSource:a.useCollectionDataSource});S(this,"components",{FilterDynamicComponent:Xe,CollectionFieldset:Dt,IndividualHooksRadioWithTooltip:_o})}}class Wr extends ve{constructor(){super(...arguments);S(this,"title",'{{t("Delete record")}}');S(this,"type","destroy");S(this,"group","collection");S(this,"description",`{{t("Delete records of a collection. Could use variables in workflow context as filter. All records match the filter will be deleted.", { ns: "${f}" })}}`);S(this,"icon",r.jsx(P.DeleteOutlined,{}));S(this,"fieldset",{collection:D(k({},fe),{"x-reactions":[...fe["x-reactions"],{target:"params",fulfill:{state:{visible:"{{!!$self.value}}"}}},{target:"params",effects:["onFieldValueChange"],fulfill:{state:{value:"{{Object.create({})}}"}}}]}),params:{type:"object",properties:{filter:D(k({},tt),{"x-validator"(o){return z.isValidFilter(o)?"":A("Please add at least one condition")}})}}});S(this,"scope",{useCollectionDataSource:a.useCollectionDataSource});S(this,"components",{FilterDynamicComponent:Xe})}}const zr=e=>{const{collectionName:t}=e,[o,n]=p.useState([]),s=a.useAPIClient(),l=i=>q(this,null,function*(){const{data:c}=yield s.request({method:"GET",url:"/public:getFieldEnumValues",params:{collection:i,field:"workflowCurrentStep"}});Array.isArray(c==null?void 0:c.data)&&n(c.data.map(d=>({label:d,value:d})))});return p.useEffect(()=>{t&&l(t)},[t]),t?r.jsx(b.Select,k({options:o},e)):r.jsx(b.Input,k({},e))},_r=Y.connect(zr,Y.mapReadPretty(a.Input.ReadPretty)),Hr=new a.SchemaSettings({name:"actionSettings:submitToWorkflow",items:[{name:"editButton",Component:a.ButtonEditor,useComponentProps(){const{buttonEditorProps:e}=a.useSchemaToolbar();return e}},{name:"secondConfirmation",Component:a.SecondConFirm},{name:"assignFieldValues",Component:a.AssignedFieldValues},{name:"skipRequiredValidation",Component:a.SkipValidation},{name:"afterSuccessfulSubmission",Component:a.AfterSuccess,useVisible(){var t;const e=Y.useFieldSchema();return yt.isValid((t=e==null?void 0:e["x-action-settings"])==null?void 0:t.onSuccess)}},{name:"bindWorkflow",Component:a.WorkflowConfig},{name:"delete",sort:100,Component:a.RemoveButton,useComponentProps(){const{removeButtonProps:e}=a.useSchemaToolbar();return e}}]});function Yr({children:e,workflow:t,execution:o,nodes:n}){const s=a.usePlugin(de),l=s.triggers.get(t.type).components,i=n.reduce((c,{type:d})=>Object.assign(c,s.instructions.get(d).components),{});return r.jsx(je.Provider,{value:{workflow:t,nodes:n,execution:o},children:r.jsx(a.SchemaComponentOptions,{components:k(k({},l),i),children:e})})}class de extends a.Plugin{constructor(){super(...arguments);S(this,"triggers",new z.Registry);S(this,"instructions",new z.Registry);S(this,"instructionGroups",new z.Registry);S(this,"useTriggersOptions",()=>{const o=a.useCompile();return Array.from(this.triggers.getEntities()).map(i=>{var[n,c]=i,d=c,{title:s}=d,l=R(d,["title"]);return{value:n,label:o(s),color:"gold",options:l}}).sort((n,s)=>n.label.localeCompare(s.label))});S(this,"useInstructionGroupOptions",()=>{const o=a.useCompile();return Array.from(this.instructionGroups.getEntities()).map(([n,{label:s}])=>({key:n,label:o(s)}))})}isWorkflowSync(o){var n;return(n=this.triggers.get(o.type).sync)!=null?n:o.sync}registerTrigger(o,n){if(typeof n=="function")this.triggers.register(o,new n);else if(n)this.triggers.register(o,n);else throw new TypeError("invalid trigger type to register")}registerInstruction(o,n){if(typeof n=="function")this.instructions.register(o,new n);else if(n instanceof ve)this.instructions.register(o,n);else throw new TypeError("invalid instruction type to register")}registerInstructionGroup(o,n){this.instructionGroups.register(o,n)}load(){return q(this,null,function*(){this.app.router.add("app.workflow.workflows.id",{path:ke(":id"),element:r.jsx(bo,{})}),this.app.router.add("app.workflow.executions.id",{path:Ke(":id"),element:r.jsx(uo,{})}),this.app.addComponents({WorkflowPage:bo,ExecutionPage:uo,WorkflowCurrentStepSelect:_r,WorkflowPane:rr}),this.app.schemaSettingsManager.add(Hr),this.registerInstructionGroup("control",{key:"control",label:`{{t("Control", { ns: "${f}" })}}`}),this.registerInstructionGroup("calculation",{key:"calculation",label:`{{t("Calculation", { ns: "${f}" })}}`}),this.registerInstructionGroup("collection",{key:"collection",label:`{{t("Collection operations", { ns: "${f}" })}}`}),this.registerInstructionGroup("manual",{key:"manual",label:`{{t("Manual", { ns: "${f}" })}}`}),this.registerInstructionGroup("notification",{key:"notification",label:`{{t("Notification", { ns: "${f}" })}}`}),this.registerInstructionGroup("extended",{key:"extended",label:`{{t("Extended types", { ns: "${f}" })}}`}),this.registerTrigger("collection",dr),this.registerTrigger("schedule",Er),this.registerInstruction("calculation",Fr),this.registerInstruction("condition",Pr),this.registerInstruction("end",Br),this.registerInstruction("query",Vr),this.registerInstruction("create",Lr),this.registerInstruction("update",jr),this.registerInstruction("destroy",Wr)})}}w.BaseTypeSets=Qe,w.Branch=et,w.BranchNodeType=Q,w.CanvasZoomContext=gt,w.CheckboxGroupWithTooltip=Tn,w.CollectionBlockInitializer=We,w.CollectionFieldSet=Dt,w.DetailsBlockProvider=fn,w.EXECUTION_STATUS=pe,w.ExecutionContextProvider=Yr,w.ExecutionStatusOptions=qe,w.ExecutionStatusOptionsMap=Je,w.FieldsSelect=wt,w.FilterDynamicComponent=Xe,w.FlowContext=je,w.IndividualHooksRadioWithTooltip=_o,w.Instruction=ve,w.JOB_STATUS=Ie,w.JobButton=Zt,w.JobStatusOptions=Ct,w.JobStatusOptionsMap=Ze,w.Node=qt,w.NodeContext=St,w.NodeDefaultView=At,w.RadioWithTooltip=Me,w.RemoveButton=Jt,w.SimpleDesigner=so,w.Trigger=Bt,w.VIRTUAL_NODE_TYPES=Mt,w.ValueBlock=Ne,w.WorkflowNodeTree=Pt,w.WorkflowVariableInput=ro,w.WorkflowVariableJSON=Sn,w.WorkflowVariableRawTextArea=kn,w.WorkflowVariableRichTextArea=An,w.WorkflowVariableTextArea=Ft,w.buildWorkflowTree=$t,w.dateOptions=to,w.default=de,w.defaultFieldNames=Se,w.envOptions=oo,w.flattenNodes=ao,w.getCollectionFieldOptions=De,w.getTreeChildrenKeys=Nt,w.getUpstreamNodes=Dn,w.getWorkflowDetailPath=ke,w.getWorkflowExecutionsPath=Ke,w.linkNodes=xt,w.nodesOptions=Qt,w.scopeOptions=Rt,w.systemOptions=eo,w.traverseSchema=vt,w.triggerOptions=Xt,w.useAvailableUpstreams=Ut,w.useCanvasZoomContext=cn,w.useFlowContext=X,w.useGetAriaLabelOfAddButton=kt,w.useNodeContext=Ee,w.useRecordTriggerWorkflowsActionProps=ir,w.useStyles=ie,w.useTrigger=Vt,w.useTriggerWorkflowsActionProps=lr,w.useUpstreamScopes=Kt,w.useWorkflowAnyExecuted=wo,w.useWorkflowExecuted=cr,w.useWorkflowVariableOptions=he,Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
