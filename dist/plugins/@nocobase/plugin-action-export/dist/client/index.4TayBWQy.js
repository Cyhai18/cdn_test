(function(a,l){typeof exports=="object"&&typeof module!="undefined"?l(exports,require("react/jsx-runtime"),require("@formily/react"),require("@formily/shared"),require("@nocobase/client"),require("@formily/antd-v5"),require("react"),require("react-i18next"),require("lodash"),require("antd"),require("@nocobase/utils/client")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@formily/react","@formily/shared","@nocobase/client","@formily/antd-v5","react","react-i18next","lodash","antd","@nocobase/utils/client"],l):(a=typeof globalThis!="undefined"?globalThis:a||self,l(a["@nocobase/plugin-action-export"]={},a.jsxRuntime,a["@formily/react"],a["@formily/shared"],a["@nocobase/client"],a["@formily/antd-v5"],a.react,a["react-i18next"],a.lodash,a.antd,a["@nocobase/utils"]))})(this,function(a,l,x,k,c,M,w,E,y,j,L){"use strict";var se=Object.defineProperty,ie=Object.defineProperties;var ce=Object.getOwnPropertyDescriptors;var Q=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var Z=(a,l,x)=>l in a?se(a,l,{enumerable:!0,configurable:!0,writable:!0,value:x}):a[l]=x,O=(a,l)=>{for(var x in l||(l={}))pe.call(l,x)&&Z(a,x,l[x]);if(Q)for(var x of Q(l))le.call(l,x)&&Z(a,x,l[x]);return a},$=(a,l)=>ie(a,ce(l));var D=(a,l,x)=>new Promise((k,c)=>{var M=y=>{try{E(x.next(y))}catch(j){c(j)}},w=y=>{try{E(x.throw(y))}catch(j){c(j)}},E=y=>y.done?k(y.value):Promise.resolve(y.value).then(M,w);E((x=x.apply(a,l)).next())});const B=o=>{const{getCollectionFields:e}=c.useCollectionManager_deprecated(),s=e(o),u=(i,p)=>{var h;if(!i.interface)return;const m={name:i.name,title:((h=i==null?void 0:i.uiSchema)==null?void 0:h.title)||i.name,schema:i==null?void 0:i.uiSchema};if(!i.target||p>=3)return m;if(i.target){const t=e(i.target),n=f(t,p+1).filter(Boolean);m.children=m.children||[],m.children.push(...n)}return m},f=(i,p)=>{const m=[];return i.forEach(h=>{const t=u(h,p);t&&m.push(t)}),m};return f(s,1)},R=(o,e,s)=>o.reduceProperties((u,f)=>{if(f[e]===s)return f;const i=R(f,e,s);return i||u}),ee=(o,e)=>e(o),q=(o,e,s=R,u=ee)=>{const f=x.useFieldSchema(),{remove:i}=c.useDesignable(),p=s(f,e,o);return{schema:p,exists:!!p,remove(){p&&u(p,i)}}},te=o=>o==null?void 0:o.filter(s=>!s.children).map(s=>({dataIndex:[s.name]})),_=()=>{const o=c.useSchemaInitializerItem(),{insert:e}=c.useSchemaInitializer(),{exists:s,remove:u}=q("export","x-action",o.find,o.remove),{name:f}=c.useCollection_deprecated(),i=B(f),p={type:"void",title:'{{ t("Export") }}',"x-action":"export","x-action-settings":{exportSettings:[]},"x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:export","x-decorator":"ACLActionProvider","x-component":"Action","x-use-component-props":"useExportAction","x-component-props":{icon:"clouddownloadoutlined"}};return l.jsx(c.SchemaInitializerSwitch,$(O({},o),{checked:s,title:o.title,onClick:()=>{var h;if(s)return u();p["x-action-settings"].exportSettings=te(i);const m=k.merge(p||{},o.schema||{});(h=o==null?void 0:o.schemaInitialize)==null||h.call(o,m),e(m)}}))},z=()=>{const{name:o}=c.useCollection_deprecated(),e=B(o);return{schema:{type:"void","x-component":"Grid",properties:{exportSettings:{type:"array","x-component":"ArrayItems","x-decorator":"FormItem",items:{type:"object",properties:{space:{type:"void","x-component":"Space","x-component-props":{className:c.css`
                    width: 100%;
                    & .ant-space-item:nth-child(2),
                    & .ant-space-item:nth-child(3) {
                      flex: 1;
                    }
                  `},properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},dataIndex:{type:"array","x-decorator":"FormItem","x-component":c.Cascader,required:!0,enum:e,"x-component-props":{fieldNames:{label:"title",value:"name",children:"children"},changeOnSelect:!1}},title:{type:"string","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:'{{ t("Custom column title") }}'}},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:'{{ t("Add exportable field") }}',"x-component":"ArrayItems.Addition","x-component-props":{className:c.css`
                  border-color: var(--colorSettings);
                  color: var(--colorSettings);
                  &.ant-btn-dashed:hover {
                    border-color: var(--colorSettings);
                    color: var(--colorSettings);
                  }
                `}}}}}}}},oe="action-export";function U(){return E.useTranslation([oe,"client"],{nsMode:"fallback"})}const H=()=>{var m,h,t,n,g;const o=x.useField(),e=x.useFieldSchema(),{t:s}=U(),{dn:u}=c.useDesignable(),[f,i]=w.useState(),{schema:p}=z();return w.useEffect(()=>{i(p)},[o.address,(m=e==null?void 0:e["x-action-settings"])==null?void 0:m.exportSettings]),l.jsxs(c.GeneralSchemaDesigner,{disableInitializer:!0,children:[l.jsx(c.SchemaSettingsModalItem,{title:s("Edit button"),schema:{type:"object",title:s("Edit button"),properties:{title:{"x-decorator":"FormItem","x-component":"Input",title:s("Button title"),default:e.title,"x-component-props":{}},icon:{"x-decorator":"FormItem","x-component":"IconPicker",title:s("Button icon"),default:(h=e==null?void 0:e["x-component-props"])==null?void 0:h.icon,"x-component-props":{}},type:{"x-decorator":"FormItem","x-component":"Radio.Group",title:s("Button background color"),default:(t=e==null?void 0:e["x-component-props"])!=null&&t.danger?"danger":((n=e==null?void 0:e["x-component-props"])==null?void 0:n.type)==="primary"?"primary":"default",enum:[{value:"default",label:'{{t("Default")}}'},{value:"primary",label:'{{t("Highlight")}}'},{value:"danger",label:'{{t("Secondary")}}'}]}}},onSubmit:({title:r,icon:d,type:v})=>{e.title=r,o.title=r,o.componentProps.icon=d,o.componentProps.danger=v==="danger",o.componentProps.type=v,e["x-component-props"]=e["x-component-props"]||{},e["x-component-props"].icon=d,e["x-component-props"].danger=v==="danger",e["x-component-props"].type=v,u.emit("patch",{schema:{"x-uid":e["x-uid"],title:r,"x-component-props":O({},e["x-component-props"])}}),u.refresh()}}),l.jsx(c.SchemaSettingsActionModalItem,{title:s("Exportable fields"),schema:f,initialValues:{exportSettings:(g=e==null?void 0:e["x-action-settings"])==null?void 0:g.exportSettings},scope:{t:s},components:{ArrayItems:M.ArrayItems},onSubmit:({exportSettings:r})=>{e["x-action-settings"].exportSettings=r==null?void 0:r.filter(d=>{var v;return(v=d==null?void 0:d.dataIndex)==null?void 0:v.length}).map(d=>({dataIndex:d.dataIndex.map(v=>{var S;return(S=v.name)!=null?S:v}),title:d.title})),u.emit("patch",{schema:{"x-uid":e["x-uid"],"x-action-settings":e["x-action-settings"]}}),u.refresh()}}),l.jsx(c.SchemaSettingsDivider,{}),l.jsx(c.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:r=>r["x-component"]==="Space"||r["x-component"].endsWith("ActionBar"),confirm:{title:s("Delete action")}})]})},N=o=>l.jsx(c.SchemaComponentOptions,{components:{ExportActionInitializer:_,ExportDesigner:H},scope:{useExportAction:W},children:o.children});var P=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},G={exports:{}};(function(o,e){(function(s,u){u()})(P,function(){function s(t,n){return typeof n=="undefined"?n={autoBom:!1}:typeof n!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),n={autoBom:!n}),n.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\uFEFF",t],{type:t.type}):t}function u(t,n,g){var r=new XMLHttpRequest;r.open("GET",t),r.responseType="blob",r.onload=function(){h(r.response,n,g)},r.onerror=function(){console.error("could not download file")},r.send()}function f(t){var n=new XMLHttpRequest;n.open("HEAD",t,!1);try{n.send()}catch(g){}return 200<=n.status&&299>=n.status}function i(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(g){var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(n)}}var p=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof P=="object"&&P.global===P?P:void 0,m=p.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),h=p.saveAs||(typeof window!="object"||window!==p?function(){}:"download"in HTMLAnchorElement.prototype&&!m?function(t,n,g){var r=p.URL||p.webkitURL,d=document.createElement("a");n=n||t.name||"download",d.download=n,d.rel="noopener",typeof t=="string"?(d.href=t,d.origin===location.origin?i(d):f(d.href)?u(t,n,g):i(d,d.target="_blank")):(d.href=r.createObjectURL(t),setTimeout(function(){r.revokeObjectURL(d.href)},4e4),setTimeout(function(){i(d)},0))}:"msSaveOrOpenBlob"in navigator?function(t,n,g){if(n=n||t.name||"download",typeof t!="string")navigator.msSaveOrOpenBlob(s(t,g),n);else if(f(t))u(t,n,g);else{var r=document.createElement("a");r.href=t,r.target="_blank",setTimeout(function(){i(r)})}}:function(t,n,g,r){if(r=r||open("","_blank"),r&&(r.document.title=r.document.body.innerText="downloading..."),typeof t=="string")return u(t,n,g);var d=t.type==="application/octet-stream",v=/constructor/i.test(p.HTMLElement)||p.safari,S=/CriOS\/[\d]+/.test(navigator.userAgent);if((S||d&&v||m)&&typeof FileReader!="undefined"){var I=new FileReader;I.onloadend=function(){var A=I.result;A=S?A:A.replace(/^data:[^;]*;/,"data:attachment/file;"),r?r.location.href=A:location=A,r=null},I.readAsDataURL(t)}else{var T=p.URL||p.webkitURL,F=T.createObjectURL(t);r?r.location=F:location.href=F,r=null,setTimeout(function(){T.revokeObjectURL(F)},4e4)}});p.saveAs=h.saveAs=h,o.exports=h})})(G);var ne=G.exports;const W=()=>{const{service:o,resource:e}=c.useBlockRequestContext(),s=c.useAPIClient(),u=x.useFieldSchema(),f=c.useCompile(),{getCollectionJoinField:i}=c.useCollectionManager_deprecated(),{name:p,title:m,getField:h}=c.useCollection_deprecated(),{t}=U(),{modal:n}=j.App.useApp();return{onClick(){return D(this,null,function*(){var I,T,F,A,X;if(!(yield n.confirm({title:t("Export"),content:t("Export warning"),okText:t("Start export")})))return;const{exportSettings:d}=y.cloneDeep((I=u==null?void 0:u["x-action-settings"])!=null?I:{});d.forEach(C=>{var K,V;const{uiSchema:b,interface:ae}=(K=i(`${p}.${C.dataIndex.join(".")}`))!=null?K:{};C.enum=(V=b==null?void 0:b.enum)==null?void 0:V.map(Y=>({value:Y.value,label:Y.label})),!C.enum&&(b==null?void 0:b.type)==="boolean"&&(C.enum=[{value:!0,label:t("Yes")},{value:!1,label:t("No")}]),C.defaultTitle=b==null?void 0:b.title,ae==="chinaRegion"&&C.dataIndex.push("name")});const{data:v}=yield e.export({title:f(m),appends:(F=(T=o.params[0])==null?void 0:T.appends)==null?void 0:F.join(),filter:JSON.stringify((A=o.params[0])==null?void 0:A.filter),sort:(X=o.params[0])==null?void 0:X.sort},{method:"post",data:{columns:f(d)},responseType:"blob"}),S=new Blob([v],{type:"application/x-xls"});if(L.isInFlutter){L.definedUploadFileHandle(s,S,`${f(m)}.xlsx`);return}ne.saveAs(S,`${f(m)}.xlsx`)})}}},re=new c.SchemaSettings({name:"actionSettings:export",items:[{name:"editButton",Component:c.ButtonEditor,useComponentProps(){const{buttonEditorProps:o}=c.useSchemaToolbar();return o}},{name:"exportableFields",type:"actionModal",useComponentProps(){var m,h;const o=x.useField(),e=x.useFieldSchema(),{t:s}=E.useTranslation(),{dn:u}=c.useDesignable(),[f,i]=w.useState(),{schema:p}=z();return w.useEffect(()=>{i(p)},[o.address,(m=e==null?void 0:e["x-action-settings"])==null?void 0:m.exportSettings]),{title:s("Exportable fields"),schema:f,initialValues:{exportSettings:(h=e==null?void 0:e["x-action-settings"])==null?void 0:h.exportSettings},components:{ArrayItems:M.ArrayItems},onSubmit:({exportSettings:t})=>{e["x-action-settings"].exportSettings=t==null?void 0:t.filter(n=>{var g;return(g=n==null?void 0:n.dataIndex)==null?void 0:g.length}).map(n=>({dataIndex:n.dataIndex.map(g=>{var r;return(r=g.name)!=null?r:g}),title:n.title})),u.emit("patch",{schema:{"x-uid":e["x-uid"],"x-action-settings":e["x-action-settings"]}}),u.refresh()}}}},{name:"divider",type:"divider"},{name:"delete",type:"remove",useComponentProps(){const{t:o}=E.useTranslation();return{removeParentsIfNoChildren:!0,breakRemoveOn:e=>e["x-component"]==="Space"||e["x-component"].endsWith("ActionBar"),confirm:{title:o("Delete action")}}}}]});class J extends c.Plugin{load(){return D(this,null,function*(){this.app.use(N);const e={title:"{{t('Export')}}",Component:"ExportActionInitializer",schema:{"x-align":"right","x-decorator":"ACLActionProvider","x-acl-action-props":{skipScopeCheck:!0}}},s=this.app.schemaInitializerManager.get("table:configureActions");s==null||s.add("enableActions.export",e),this.app.schemaInitializerManager.addItem("gantt:configureActions","enableActions.export",e),this.app.schemaSettingsManager.add(re)})}}a.ExportActionInitializer=_,a.ExportDesigner=H,a.ExportPluginProvider=N,a.PluginActionExportClient=J,a.default=J,a.useCurrentSchema=q,a.useExportAction=W,a.useFields=B,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
