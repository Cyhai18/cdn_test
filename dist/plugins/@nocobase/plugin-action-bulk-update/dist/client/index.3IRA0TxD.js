(function(s,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@formily/react"),require("@formily/shared"),require("react-i18next"),require("@nocobase/utils/client"),require("antd"),require("react")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@formily/react","@formily/shared","react-i18next","@nocobase/utils/client","antd","react"],e):(s=typeof globalThis!="undefined"?globalThis:s||self,e(s["@nocobase/plugin-action-bulk-update"]={},s["@nocobase/client"],s.jsxRuntime,s["@formily/react"],s["@formily/shared"],s["react-i18next"],s["@nocobase/utils"],s.antd,s.react))})(this,function(s,e,n,c,A,h,k,l,u){"use strict";var ie=Object.defineProperty,ne=Object.defineProperties;var re=Object.getOwnPropertyDescriptors;var $=Object.getOwnPropertySymbols;var ce=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable;var H=(s,e,n)=>e in s?ie(s,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[e]=n,v=(s,e)=>{for(var n in e||(e={}))ce.call(e,n)&&H(s,n,e[n]);if($)for(var n of $(e))ue.call(e,n)&&H(s,n,e[n]);return s},P=(s,e)=>ne(s,re(e));var m=(s,e,n)=>new Promise((c,A)=>{var h=u=>{try{l(n.next(u))}catch(x){A(x)}},k=u=>{try{l(n.throw(u))}catch(x){A(x)}},l=u=>u.done?c(u.value):Promise.resolve(u.value).then(h,k);l((n=n.apply(s,e)).next())});function x(){var d;const{dn:i}=e.useDesignable(),{t:o}=h.useTranslation(),a=c.useFieldSchema();return n.jsx(e.SchemaSettingsSelectItem,{title:o("Data will be updated"),options:[{label:o("Selected"),value:"selected"},{label:o("All"),value:"all"}],value:(d=a==null?void 0:a["x-action-settings"])==null?void 0:d.updateMode,onChange:p=>{a["x-action-settings"].updateMode=p,i.emit("patch",{schema:{"x-uid":a["x-uid"],"x-action-settings":a["x-action-settings"]}}),i.refresh()}})}function J(){var d;const{dn:i}=e.useDesignable(),{t:o}=h.useTranslation(),a=c.useFieldSchema();return n.jsx(e.SchemaSettingsModalItem,{title:o("After successful submission"),initialValues:(d=a==null?void 0:a["x-action-settings"])==null?void 0:d.onSuccess,schema:{type:"object",title:o("After successful submission"),properties:{successMessage:{title:o("Popup message"),"x-decorator":"FormItem","x-component":"Input.TextArea","x-component-props":{}},manualClose:{title:o("Popup close method"),enum:[{label:o("Automatic close"),value:!1},{label:o("Manually close"),value:!0}],"x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{}},redirecting:{title:o("Then"),enum:[{label:o("Stay on current page"),value:!1},{label:o("Redirect to"),value:!0}],"x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{},"x-reactions":{target:"redirectTo",fulfill:{state:{visible:"{{!!$self.value}}"}}}},redirectTo:{title:o("Link"),"x-decorator":"FormItem","x-component":"Input","x-component-props":{}}}},onSubmit:p=>{a["x-action-settings"].onSuccess=p,i.emit("patch",{schema:{"x-uid":a["x-uid"],"x-action-settings":a["x-action-settings"]}})}})}const V=[{name:"editButton",Component:e.ActionDesigner.ButtonEditor,useComponentProps(){const{buttonEditorProps:i}=e.useSchemaToolbar();return i}},{name:"updateMode",Component:x,useVisible(){const i=c.useFieldSchema();return["customize:bulkUpdate","customize:bulkEdit"].includes(i["x-action"])}},{name:"assignFieldValues",Component:e.AssignedFieldValues},{name:"afterSuccess",Component:J,useVisible(){var o;const i=c.useFieldSchema();return A.isValid((o=i==null?void 0:i["x-action-settings"])==null?void 0:o.onSuccess)}},{name:"refreshDataBlockRequest",Component:e.RefreshDataBlockRequest,useComponentProps(){return{isPopupAction:!1}}},{name:"remove",sort:100,Component:e.ActionDesigner.RemoveButton,useComponentProps(){const{removeButtonProps:i}=e.useSchemaToolbar();return i}}],Q=new e.SchemaSettings({name:"ActionSettings:customize:bulkUpdate",items:V}),W=new e.SchemaSettings({name:"actionSettings:bulkUpdate",items:V}),X=()=>{const i=e.useSchemaInitializerItem(),o={type:"void",title:'{{ t("Bulk update") }}',"x-component":"Action","x-use-component-props":"useCustomizeBulkUpdateActionProps","x-align":"right","x-acl-action":"update","x-decorator":"ACLActionProvider","x-acl-action-props":{skipScopeCheck:!0},"x-action":"customize:bulkUpdate","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:bulkUpdate","x-action-settings":{assignedValues:{},updateMode:"selected",onSuccess:{manualClose:!0,redirecting:!1,successMessage:'{{t("Updated successfully")}}'}},"x-component-props":{icon:"EditOutlined"}};return n.jsx(e.BlockInitializer,P(v({},i),{schema:o,item:i}))},Y=()=>{const i=e.useSchemaInitializerItem();return n.jsx(e.BlockInitializer,P(v({},i),{item:i}))},Z="bulk-update";function ee(){return h.useTranslation(Z,{nsMode:"fallback"})}const F=()=>{const{field:i,resource:o,__parent:a,service:d}=e.useBlockRequestContext(),p=u.useContext(c.SchemaExpressionScopeContext),y=c.useFieldSchema(),B=e.useTableBlockContext(),{rowKey:te}=B,q=e.useNavigateNoUpdate(),R=e.useCompile(),{t:U}=ee(),b=c.useField(),{modal:D}=l.App.useApp(),I=e.useVariables(),{name:le,getField:se}=e.useCollection_deprecated(),oe=e.useLocalVariables();return{onClick(de,S){return m(this,null,function*(){var L,O,N,G,K;const{assignedValues:j={},onSuccess:t,updateMode:E}=(L=y==null?void 0:y["x-action-settings"])!=null?L:{};b.data=i.data||{},b.data.loading=!0;const M=(K=(G=(N=(O=B.field)==null?void 0:O.data)==null?void 0:N.selectedRowKeys)!=null?G:p==null?void 0:p.selectedRecordKeys)!=null?K:{},z={},ae=Object.keys(j).map(f=>m(this,null,function*(){const r=j[f],T=se(f);if(e.isVariable(r)){const C=yield I==null?void 0:I.parseVariable(r,oe).then(({value:g})=>g);C&&(z[f]=e.transformVariableValue(C,{targetCollectionField:T}))}else r!=null&&r!==""&&(z[f]=r)}));yield Promise.all(ae),D.confirm({title:U("Bulk update",{ns:"client"}),content:E==="selected"?U("Update selected data?",{ns:"client"}):U("Update all data?",{ns:"client"}),onOk(){return m(this,null,function*(){var T,C,g,_;const{filter:f}=(C=(T=d.params)==null?void 0:T[0])!=null?C:{},r={values:v({},z),filter:f,forceUpdate:!1};if(E==="selected"){if(!(M!=null&&M.length)){l.message.error(U("Please select the records to be updated")),b.data.loading=!1;return}r.filter={$and:[{[te||"id"]:{$in:M}}]}}r.filter||(r.forceUpdate=!0);try{yield o.update(r)}catch(pe){}finally{b.data.loading=!1}S&&(S==null||S()),o instanceof e.TableFieldResource||(_=(g=a==null?void 0:a.service)==null?void 0:g.refresh)==null||_.call(g),t!=null&&t.successMessage&&(t!=null&&t.manualClose?D.success({title:R(t==null?void 0:t.successMessage),onOk:()=>m(this,null,function*(){t!=null&&t.redirecting&&(t!=null&&t.redirectTo)&&(k.isURL(t.redirectTo)?window.location.href=t.redirectTo:q(t.redirectTo))})}):(l.message.success(R(t==null?void 0:t.successMessage)),t!=null&&t.redirecting&&(t!=null&&t.redirectTo)&&(k.isURL(t.redirectTo)?window.location.href=t.redirectTo:q(t.redirectTo))))})},onCancel(){return m(this,null,function*(){b.data.loading=!1})}})})}}};class w extends e.Plugin{load(){return m(this,null,function*(){this.app.addComponents({CustomizeActionInitializer:Y}),this.app.addScopes({useCustomizeBulkUpdateActionProps:F}),this.app.addScopes({useCustomizeBulkUpdateActionProps:F}),this.app.schemaSettingsManager.add(Q),this.app.schemaSettingsManager.add(W);const o={title:'{{t("Bulk update")}}',Component:X,name:"bulkUpdate",useVisible(){const a=e.useCollection_deprecated();return(a.template!=="view"||(a==null?void 0:a.writableView))&&a.template!=="file"&&a.template!=="sql"}};this.app.schemaInitializerManager.addItem("table:configureActions","customize.bulkUpdate",o),this.app.schemaInitializerManager.addItem("gantt:configureActions","customize.bulkUpdate",o),this.app.schemaInitializerManager.addItem("map:configureActions","customize.bulkUpdate",o)})}}s.PluginActionBulkUpdateClient=w,s.default=w,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
