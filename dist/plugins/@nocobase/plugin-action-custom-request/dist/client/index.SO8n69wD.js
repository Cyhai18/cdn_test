(function(t,n){typeof exports=="object"&&typeof module!="undefined"?n(exports,require("react/jsx-runtime"),require("@nocobase/client"),require("@formily/react"),require("@nocobase/utils/client"),require("antd"),require("react-router-dom"),require("react"),require("react-i18next"),require("@formily/antd-v5"),require("@formily/shared")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@nocobase/client","@formily/react","@nocobase/utils/client","antd","react-router-dom","react","react-i18next","@formily/antd-v5","@formily/shared"],n):(t=typeof globalThis!="undefined"?globalThis:t||self,n(t["@nocobase/plugin-action-custom-request"]={},t.jsxRuntime,t["@nocobase/client"],t["@formily/react"],t["@nocobase/utils"],t.antd,t["react-router-dom"],t.react,t["react-i18next"],t["@formily/antd-v5"],t["@formily/shared"]))})(this,function(t,n,e,l,A,F,D,T,S,O,V){"use strict";var he=Object.defineProperty,ye=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var U=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var Z=(t,n,e)=>n in t?he(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e,q=(t,n)=>{for(var e in n||(n={}))$.call(n,e)&&Z(t,e,n[e]);if(U)for(var e of U(n))ee.call(n,e)&&Z(t,e,n[e]);return t},I=(t,n)=>ye(t,xe(n));var te=(t,n)=>{var e={};for(var l in t)$.call(t,l)&&n.indexOf(l)<0&&(e[l]=t[l]);if(t!=null&&U)for(var l of U(t))n.indexOf(l)<0&&ee.call(t,l)&&(e[l]=t[l]);return e};var b=(t,n,e)=>new Promise((l,A)=>{var F=S=>{try{T(e.next(S))}catch(O){A(O)}},D=S=>{try{T(e.throw(S))}catch(O){A(O)}},T=S=>S.done?l(S.value):Promise.resolve(S.value).then(F,D);T((e=e.apply(t,n)).next())});const P="customRequests:listByCurrentRole";var E=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},K={exports:{}};(function(a,p){(function(i,c){c()})(E,function(){function i(o,r){return typeof r=="undefined"?r={autoBom:!1}:typeof r!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),r={autoBom:!r}),r.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(o.type)?new Blob(["\uFEFF",o],{type:o.type}):o}function c(o,r,y){var m=new XMLHttpRequest;m.open("GET",o),m.responseType="blob",m.onload=function(){v(m.response,r,y)},m.onerror=function(){console.error("could not download file")},m.send()}function d(o){var r=new XMLHttpRequest;r.open("HEAD",o,!1);try{r.send()}catch(y){}return 200<=r.status&&299>=r.status}function f(o){try{o.dispatchEvent(new MouseEvent("click"))}catch(y){var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),o.dispatchEvent(r)}}var u=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof E=="object"&&E.global===E?E:void 0,x=u.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),v=u.saveAs||(typeof window!="object"||window!==u?function(){}:"download"in HTMLAnchorElement.prototype&&!x?function(o,r,y){var m=u.URL||u.webkitURL,C=document.createElement("a");r=r||o.name||"download",C.download=r,C.rel="noopener",typeof o=="string"?(C.href=o,C.origin===location.origin?f(C):d(C.href)?c(o,r,y):f(C,C.target="_blank")):(C.href=m.createObjectURL(o),setTimeout(function(){m.revokeObjectURL(C.href)},4e4),setTimeout(function(){f(C)},0))}:"msSaveOrOpenBlob"in navigator?function(o,r,y){if(r=r||o.name||"download",typeof o!="string")navigator.msSaveOrOpenBlob(i(o,y),r);else if(d(o))c(o,r,y);else{var m=document.createElement("a");m.href=o,m.target="_blank",setTimeout(function(){f(m)})}}:function(o,r,y,m){if(m=m||open("","_blank"),m&&(m.document.title=m.document.body.innerText="downloading..."),typeof o=="string")return c(o,r,y);var C=o.type==="application/octet-stream",w=/constructor/i.test(u.HTMLElement)||u.safari,j=/CriOS\/[\d]+/.test(navigator.userAgent);if((j||C&&w||x)&&typeof FileReader!="undefined"){var s=new FileReader;s.onloadend=function(){var R=s.result;R=j?R:R.replace(/^data:[^;]*;/,"data:attachment/file;"),m?m.location.href=R:location=R,m=null},s.readAsDataURL(o)}else{var k=u.URL||u.webkitURL,g=k.createObjectURL(o);m?m.location=g:location.href=g,m=null,setTimeout(function(){k.revokeObjectURL(g)},4e4)}});u.saveAs=v.saveAs=v,a.exports=v})})(K);var oe=K.exports;const se=()=>{const a=e.useAPIClient(),p=D.useNavigate(),i=l.useFieldSchema(),c=e.useCompile(),d=l.useForm(),f=e.useRecord(),u=l.useFieldSchema(),x=l.useField(),{setVisible:v}=e.useActionContext(),{modal:o,message:r}=F.App.useApp(),y=e.useDataSourceKey();return{onClick(C,w){return b(this,null,function*(){var Y,Q;const{skipValidator:j,onSuccess:s={}}=(Y=i==null?void 0:i["x-action-settings"])!=null?Y:{},{keepActionContainer:k=!1}=s,g=i==null?void 0:i["x-action"];j!==!0&&g==="customize:form:request"&&(yield d.submit());let R=q({},f);g==="customize:form:request"&&(R=d.values),(Q=x.data)!=null||(x.data={}),x.data.loading=!0;try{const M=yield a.request({url:`/customRequests:send/${u["x-uid"]}`,method:"POST",data:{currentRecord:{dataSourceKey:y,data:R}},responseType:u["x-response-type"]==="stream"?"blob":"json"});if(M.headers["content-disposition"]){const fe=/attachment;\s*filename="([^"]+)"/,_=M.headers["content-disposition"].match(fe);if(_[1]){if(A.isInFlutter){A.definedUploadFileHandle(a,M.data,_[1]);return}oe.saveAs(M.data,_[1])}}if(x.data.loading=!1,w&&(w==null||w()),g==="customize:form:request"&&!k&&(v==null||v(!1)),!(s!=null&&s.successMessage))return;s!=null&&s.manualClose?o.success({title:c(s==null?void 0:s.successMessage),onOk:()=>b(this,null,function*(){s!=null&&s.redirecting&&(s!=null&&s.redirectTo)&&(A.isURL(s.redirectTo)?window.location.href=s.redirectTo:p(s.redirectTo))})}):(r.success(c(s==null?void 0:s.successMessage)),s!=null&&s.redirecting&&(s!=null&&s.redirectTo)&&(A.isURL(s.redirectTo)?window.location.href=s.redirectTo:p(s.redirectTo)))}finally{x.data.loading=!1}})}}},B=()=>{const p=`customRequests:get/${l.useFieldSchema()["x-uid"]}`;return e.useRequest({url:p,params:{appends:["roles"]}},{manual:!0,cacheKey:p})},H="action-custom-request";function h(a){return`{{t('${a}', { ns: '${H}', nsMode: 'fallback' })}}`}function N(){return S.useTranslation(H,{nsMode:"fallback"})}const ne=()=>{const a=e.useCollection_deprecated(),{t:p}=N(),i=e.useCollectionFilterOptions(a),c=e.useCollectionFilterOptions("users",e.DEFAULT_DATA_SOURCE_KEY),d=e.useCompile(),[f,u]=T.useMemo(()=>[d(i),d(c)],[i,c]);return T.useMemo(()=>[{name:"currentRecord",title:p("Current record",{ns:"client"}),children:[...f]},{name:"currentUser",title:p("Current user",{ns:"client"}),children:u},{name:"currentTime",title:p("Current time",{ns:"client"}),children:null}],[f,u])},L=()=>e.useAPIClient().resource("customRequests"),G={type:"object",properties:{method:{type:"string",required:!0,title:h("HTTP method"),"x-decorator-props":{tooltip:h("When the HTTP method is Post, Put or Patch, and this custom request inside the form, the request body will be automatically filled in with the form data")},"x-decorator":"FormItem","x-component":"Select","x-component-props":{showSearch:!1,allowClear:!1,className:"auto-width"},enum:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"PUT",value:"PUT"},{label:"PATCH",value:"PATCH"},{label:"DELETE",value:"DELETE"}],default:"POST"},url:{type:"string",required:!0,title:h("URL"),"x-decorator":"FormItem","x-component":"Variable.RawTextArea","x-component-props":{scope:"{{useCustomRequestVariableOptions}}",autoSize:!0,fieldNames:{value:"name",label:"title"},placeholder:"https://www.nocobase.com"}},headers:{type:"array","x-component":"ArrayItems","x-decorator":"FormItem",title:h("Headers"),description:h('"Content-Type" only support "application/json", and no need to specify'),items:{type:"object",properties:{space:{type:"void","x-component":"Space",properties:{name:{type:"string","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:h("Name")}},value:{type:"string","x-decorator":"FormItem","x-component":"Variable.Input","x-component-props":{scope:"{{useCustomRequestVariableOptions}}",fieldNames:{value:"name",label:"title"},useTypedConstant:!0}},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:h("Add request header"),"x-component":"ArrayItems.Addition"}}},params:{type:"array","x-component":"ArrayItems","x-decorator":"FormItem",title:h("Parameters"),items:{type:"object",properties:{space:{type:"void","x-component":"Space",properties:{name:{type:"string","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:h("Name")}},value:{type:"string","x-decorator":"FormItem","x-component":"Variable.Input","x-component-props":{scope:"{{useCustomRequestVariableOptions}}",fieldNames:{value:"name",label:"title"},useTypedConstant:!0}},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:h("Add parameter"),"x-component":"ArrayItems.Addition"}}},data:{type:"string",title:h("Body"),"x-decorator":"FormItem","x-decorator-props":{},"x-component":"Variable.JSON","x-component-props":{scope:"{{useCustomRequestVariableOptions}}",fieldNames:{value:"name",label:"title"},changeOnSelect:!0,autoSize:{minRows:10},placeholder:h("Input request data")},description:h("Only support standard JSON data")},timeout:{type:"number",title:h("Timeout config"),"x-decorator":"FormItem","x-decorator-props":{},"x-component":"InputNumber","x-component-props":{addonAfter:h("ms"),min:1,step:1e3,defaultValue:5e3}},responseType:{type:"string",title:h("Response type"),"x-decorator":"FormItem","x-decorator-props":{},"x-component":"Select",default:"json",enum:[{value:"json",label:"JSON"},{value:"stream",label:"Stream"}]}}},re={type:"object",properties:{roles:{type:"array",title:h("Roles"),"x-decorator":"FormItem","x-decorator-props":{tooltip:h("If not set, all roles can see this action")},"x-component":"RemoteSelect","x-component-props":{multiple:!0,objectValue:!0,dataSource:e.DEFAULT_DATA_SOURCE_KEY,service:{resource:"roles"},manual:!1,fieldNames:{label:"title",value:"name"}}}}};function J(){var o;const{t:a}=N(),{name:p}=e.useCollection_deprecated(),i=e.useDataSourceKey(),c=l.useFieldSchema(),d=L(),{message:f}=F.App.useApp(),{data:u,refresh:x}=B(),{dn:v}=e.useDesignable();return n.jsx(n.Fragment,{children:n.jsx(e.SchemaSettingsActionModalItem,{title:a("Request settings"),components:{ArrayItems:O.ArrayItems},beforeOpen:()=>!u&&x(),scope:{useCustomRequestVariableOptions:ne},schema:G,initialValues:q({},(o=u==null?void 0:u.data)==null?void 0:o.options),onSubmit:r=>b(this,null,function*(){const y=te(r,[]);return c["x-response-type"]=y.responseType,yield d.updateOrCreate({values:{key:c["x-uid"],options:I(q({},y),{collectionName:p,dataSourceKey:i})},filterKeys:["key"]}),v.emit("patch",{schema:{"x-response-type":y.responseType,"x-uid":c["x-uid"]}}),x(),f.success(a("Saved successfully"))})})})}function W(){var x;const{t:a}=N(),p=l.useFieldSchema(),i=L(),{message:c}=F.App.useApp(),{data:d,refresh:f}=B(),{refresh:u}=e.useRequest({url:P},{manual:!0,cacheKey:P});return n.jsx(n.Fragment,{children:n.jsx(e.SchemaSettingsActionModalItem,{title:a("Access control"),schema:re,initialValues:{roles:(x=d==null?void 0:d.data)==null?void 0:x.roles},beforeOpen:()=>!d&&f(),onSubmit:o=>b(this,[o],function*({roles:v}){return yield i.updateOrCreate({values:{key:p["x-uid"],roles:v},filterKeys:["key"]}),f(),u(),c.success(a("Saved successfully"))})})})}const ae=new e.SchemaSettings({name:"CustomRequestActionSettings",items:[I(q({},e.actionSettingsItems[0]),{children:[...e.actionSettingsItems[0].children,{name:"request settings",Component:J},{name:"accessControl",Component:W}]})]}),ie=()=>{const a=L(),p=l.useFieldSchema();return n.jsx(e.Action.Designer,{linkageAction:!0,schemaSettings:"CustomRequestActionSettings",buttonEditorProps:{isLink:p["x-action"]==="customize:table:request"},linkageRulesProps:{type:"button"},removeButtonProps:{onConfirmOk(){return a.destroy({filterByTk:p["x-uid"]})}}})},ue=a=>{var f;const i=e.useAPIClient().auth.role==="root",c=l.useFieldSchema(),{data:d}=e.useRequest({url:P},{manual:i,cacheKey:P});return!i&&!((f=d==null?void 0:d.data)!=null&&f.includes(c==null?void 0:c["x-uid"]))?null:a.children},ce={"customize:table:request":e.Action.Link},z=a=>{const i=l.useFieldSchema()["x-action"],c=ce[i]||e.Action;return n.jsx(c,I(q({},a),{useProps:se}))};z.Designer=ie,z.Decorator=ue;const me=()=>({title:'{{ t("Custom request") }}',"x-component":"CustomRequestAction","x-action":"customize:form:request","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:customRequest","x-decorator":"CustomRequestAction.Decorator","x-uid":V.uid(),"x-action-settings":{onSuccess:{manualClose:!1,redirecting:!1,successMessage:'{{t("Request success")}}'}}}),le=a=>{const p=L(),i=e.useSchemaInitializerItem(),{insert:c}=e.useSchemaInitializer(),d=me();return n.jsx(e.SchemaInitializerItem,I(q({},i),{onClick:()=>b(this,null,function*(){var u;const f=V.merge(d||{},i.schema||{});(u=i==null?void 0:i.schemaInitialize)==null||u.call(i,f),c(f),yield p.create({values:{key:f["x-uid"]}})})}))},pe=new e.SchemaSettings({name:"actionSettings:customRequest",items:[{name:"editButton",Component:e.ButtonEditor,useComponentProps(){return{isLink:l.useFieldSchema()["x-action"]==="customize:table:request"}}},{name:"linkageRules",Component:e.SchemaSettingsLinkageRules,useComponentProps(){const{name:a}=e.useCollection(),{linkageRulesProps:p}=e.useSchemaToolbar();return I(q({},p),{collectionName:a,type:"button"})}},{name:"secondConFirm",Component:e.SecondConFirm},{name:"afterSuccessfulSubmission",Component:e.AfterSuccess},{name:"request settings",Component:J},{name:"accessControl",Component:W},{name:"refreshDataBlockRequest",Component:e.RefreshDataBlockRequest,useComponentProps(){return{isPopupAction:!1}}},{name:"delete",sort:100,Component:e.RemoveButton,useComponentProps(){const{removeButtonProps:a}=e.useSchemaToolbar();return a}}]}),de=a=>n.jsx(e.SchemaComponentOptions,{scope:{CustomRequestConfigurationFieldsSchema:G},components:{CustomRequestAction:z,CustomRequestInitializer:le},children:a.children});class X extends e.Plugin{load(){return b(this,null,function*(){this.app.use(de),this.app.schemaSettingsManager.add(pe),this.app.schemaSettingsManager.add(ae)})}}t.PluginActionCustomRequestClient=X,t.default=X,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
