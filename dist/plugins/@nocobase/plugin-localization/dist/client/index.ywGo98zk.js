(function(n,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("@nocobase/client"),require("react/jsx-runtime"),require("@ant-design/icons"),require("@formily/core"),require("@formily/react"),require("ahooks"),require("antd"),require("react"),require("react-i18next")):typeof define=="function"&&define.amd?define(["exports","@nocobase/client","react/jsx-runtime","@ant-design/icons","@formily/core","@formily/react","ahooks","antd","react","react-i18next"],e):(n=typeof globalThis!="undefined"?globalThis:n||self,e(n["@nocobase/plugin-localization"]={},n["@nocobase/client"],n.jsxRuntime,n["@ant-design/icons"],n["@formily/core"],n["@formily/react"],n.ahooks,n.antd,n.react,n["react-i18next"]))})(this,function(n,e,t,T,g,d,v,r,c,h){"use strict";var _=Object.defineProperty,H=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var L=(n,e,t)=>e in n?_(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,C=(n,e)=>{for(var t in e||(e={}))Q.call(e,t)&&L(n,t,e[t]);if(P)for(var t of P(e))W.call(e,t)&&L(n,t,e[t]);return n},S=(n,e)=>H(n,J(e));var x=(n,e,t)=>new Promise((T,g)=>{var d=c=>{try{r(t.next(c))}catch(h){g(h)}},v=c=>{try{r(t.throw(c))}catch(h){g(h)}},r=c=>c.done?T(c.value):Promise.resolve(c.value).then(d,v);r((t=t.apply(n,e)).next())});const b="localization",f=()=>h.useTranslation([b,"client"],{nsMode:"fallback"}),w={name:"localization",fields:[{interface:"input",type:"string",name:"text",uiSchema:{type:"string",title:'{{t("Text")}}',"x-component":"Input.TextArea",required:!0}},{interface:"input",type:"string",name:"translation",uiSchema:{type:"string",title:'{{t("Translation")}}',"x-component":"Input.TextArea"}},{interface:"select",type:"string",name:"moduleTitle",uiSchema:{type:"string",title:'{{t("Module")}}',"x-component":"Select",enum:[{value:"Menu",label:'{{t("Menu")}}'},{value:"Collections & Fields",label:'{{t("Collections & Fields", {ns:"localization"})}}'}]}}]},I={type:"void",name:"localization","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:w,resourceName:"localizationTexts",request:{resource:"localizationTexts",action:"list",params:{pageSize:50}}},"x-component":"CollectionProvider_deprecated","x-component-props":{collection:w},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{currentLang:{type:"void","x-align":"left","x-component":"CurrentLang"},filter:{type:"void",title:'{{t("Filter")}}',"x-align":"left","x-component":"Filter"},deleteTranslation:{type:"void",title:'{{t("Delete translation")}}',"x-component":"Action","x-component-props":{icon:"DeleteOutlined",useAction:"{{ useBulkDestroyTranslationAction }}",confirm:{title:"{{t('Delete translation')}}",content:"{{t('Are you sure you want to delete it?')}}"}}},sync:{type:"void",title:'{{t("Sync")}}',"x-component":"Sync"},publish:{type:"void",title:'{{t("Publish")}}',"x-component":"Action","x-component-props":{icon:"UploadOutlined",type:"primary",useAction:"{{ usePublishAction }}"}}}},table:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"translationId",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}"},properties:{text:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{text:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},translation:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{translation:{type:"string","x-component":"CollectionField","x-component-props":{component:"TranslationField"},"x-read-pretty":!0}}},moduleTitle:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{moduleTitle:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},actions:{type:"void",title:'{{t("Actions")}}',"x-component":"Table.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{update:{type:"void",title:'{{t("Edit")}}',"x-component":"Action.Link","x-component-props":{type:"primary"},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-decorator":"Form","x-decorator-props":{useValues:"{{ cm.useValuesFromRecord }}"},title:'{{t("Edit")}}',properties:{moduleTitle:{"x-component":"CollectionField","x-decorator":"FormItem","x-read-pretty":!0},text:{"x-component":"CollectionField","x-decorator":"FormItem","x-read-pretty":!0},translation:{"x-component":"CollectionField","x-decorator":"FormItem",required:!0},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:"{{ useUpdateTranslationAction }}"}}}}}}}},deleteTranslation:{type:"void",title:'{{ t("Delete translation") }}',"x-component":"Action.Link","x-component-props":{confirm:{title:"{{t('Delete translation')}}",content:"{{t('Are you sure you want to delete it?')}}"},useAction:"{{useDestroyTranslationAction}}"},"x-visible":"{{useHasTranslation()}}"}}}}}}}}},{Text:D}=r.Typography,M=()=>{const o=d.useField(),a=d.useForm(),i=e.useActionContext(),{refresh:s}=e.useResourceActionContext(),{targetKey:u}=e.useResourceContext(),{[u]:l}=e.useRecord(),p=e.useAPIClient(),m=p.auth.getLocale();return{run(){return x(this,null,function*(){yield a.submit(),o.data=o.data||{},o.data.loading=!0;try{yield p.resource("localizationTranslations").updateOrCreate({filterKeys:["textId","locale"],values:{textId:l,locale:m,translation:a.values.translation}}),i.setVisible(!1),yield a.reset(),s()}catch(A){console.log(A)}finally{o.data.loading=!1}})}}},q=()=>{const{refresh:o}=e.useResourceActionContext(),a=e.useAPIClient(),{translationId:i}=e.useRecord();return{run(){return x(this,null,function*(){yield a.resource("localizationTranslations").destroy({filterByTk:i}),o()})}}},B=()=>{const{state:o,setState:a,refresh:i}=e.useResourceActionContext(),s=e.useAPIClient(),{t:u}=f();return{run(){return x(this,null,function*(){var p;if(!((p=o==null?void 0:o.selectedRowKeys)!=null&&p.length))return r.message.error(u("Please select the records you want to delete"));yield s.resource("localizationTranslations").destroy({filterByTk:o==null?void 0:o.selectedRowKeys}),a==null||a({selectedRowKeys:[]}),i()})}}},K=()=>{const o=e.useAPIClient();return{run(){return x(this,null,function*(){yield o.resource("localization").publish(),window.location.reload()})}}},O=()=>{const{t:o}=f(),{refresh:a}=e.useResourceActionContext(),i=e.useAPIClient(),[s,u]=c.useState(!1),l=["local","menu","db"],[p,m]=c.useState(l),[E,A]=c.useState(!1),[G,z]=c.useState(!0),N=y=>{m(y),A(!!y.length&&y.length<l.length),z(y.length===l.length)},U=y=>{m(y.target.checked?l:[]),A(!1),z(y.target.checked)};return t.jsx(e.StablePopover,{placement:"bottomRight",content:t.jsxs(t.Fragment,{children:[t.jsx(r.Checkbox,{indeterminate:E,onChange:U,checked:G,children:o("All")}),t.jsx(r.Divider,{style:{margin:"5px 0"}}),t.jsx(r.Checkbox.Group,{onChange:N,value:p,children:t.jsxs(r.Col,{children:[t.jsx(r.Row,{children:t.jsx(r.Checkbox,{value:"local",children:o("System & Plugins")})}),t.jsx(r.Row,{children:t.jsx(r.Checkbox,{value:"db",children:o("Collections & Fields")})}),t.jsx(r.Row,{children:t.jsx(r.Checkbox,{value:"menu",children:o("Menu")})})]})})]}),children:t.jsx(r.Button,{icon:t.jsx(T.SyncOutlined,{}),loading:s,onClick:()=>x(this,null,function*(){if(!p.length)return r.message.error(o("Please select the resources you want to synchronize"));u(!0),yield i.resource("localization").sync({values:{types:p}}),u(!1),a()}),children:o("Sync")})})},F=()=>{var s;const{t:o}=f(),a=v.useMemoizedFn(o),{data:i}=e.useResourceActionContext();return c.useMemo(()=>{var u,l;return((l=(u=i==null?void 0:i.meta)==null?void 0:u.modules)==null?void 0:l.map(p=>({value:p.value,label:a(p.label)})))||[]},[(s=i==null?void 0:i.meta)==null?void 0:s.modules,a])},V=()=>{const{t:o}=f(),{run:a}=e.useResourceActionContext(),i=F(),s=c.useMemo(()=>g.createForm({initialValues:{hasTranslation:!0}}),[]),u=l=>{a(C({},l||s.values))};return c.useEffect(()=>{const l=s.query("module").take();l.dataSource=i},[s,i]),t.jsx(e.FormProvider,{form:s,children:t.jsxs("div",{style:{display:"flex"},children:[t.jsx(d.Field,{name:"module",dataSource:i,component:[e.Select,{allowClear:!0,placeholder:o("Module"),onChange:l=>u(S(C({},s.values),{module:l}))}]}),t.jsx(d.Field,{name:"keyword",component:[r.Input.Search,{placeholder:o("Keyword"),allowClear:!0,style:{marginLeft:"8px",width:"fit-content"},onSearch:l=>u(S(C({},s.values),{keyword:l}))}]}),t.jsx(d.Field,{name:"hasTranslation",dataSource:[{label:o("All"),value:!0},{label:o("No translation"),value:!1}],component:[e.Radio.Group,{defaultValue:!0,style:{marginLeft:"8px",width:"fit-content"},optionType:"button",onChange:()=>u()}]})]})})},j=()=>{var p;const{t:o}=f(),i=e.useAPIClient().auth.getLocale(),s=((p=e.locale[i])==null?void 0:p.label)||i,u=()=>t.jsxs(r.Typography,{children:[t.jsx(D,{strong:!0,children:o("Current language")}),t.jsx(r.Tag,{style:{marginLeft:"10px"},children:s})]}),l=m=>m.value!==void 0?t.jsx(e.Input.TextArea,C({},m)):t.jsx("div",{});return t.jsx(r.Card,{bordered:!1,children:t.jsx(e.SchemaComponent,{schema:I,components:{TranslationField:l,CurrentLang:u,Sync:O,Filter:V},scope:{t:o,useDestroyTranslationAction:q,useBulkDestroyTranslationAction:B,useUpdateTranslationAction:M,usePublishAction:K,useModules:F}})})};class k extends e.Plugin{load(){return x(this,null,function*(){this.app.pluginSettingsManager.add(b,{title:`{{t("Localization", { ns: "${b}" })}}`,icon:"GlobalOutlined",Component:j,aclSnippet:"pm.localization.localization"})})}}n.PluginLocalizationClient=k,n.default=k,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
